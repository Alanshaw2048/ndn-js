/*
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
  MIT
 <a href="https://github.com/bitcoinjs/bitcoinjs-lib/blob/master/LICENSE">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
*/
(function(oa,w){"object"===typeof exports?module.exports.printStackTrace=w():"function"===typeof define&&define.amd?define(w):oa.printStackTrace=w()})(this,function(){function oa(w){w=w||{guess:!0};var K=w.e||null,U=!!w.guess,V=w.mode||null;w=new oa.implementation;K=w.run(K,V);return U?w.guessAnonymousFunctions(K):K}oa.implementation=function(){};oa.implementation.prototype={run:function(w,K){w=w||this.createException();K=K||this.mode(w);return"other"===K?this.other(arguments.callee):this[K](w)},
createException:function(){try{this.undef()}catch(w){return w}},mode:function(w){return"undefined"!==typeof window&&-1<window.navigator.userAgent.indexOf("PhantomJS")?"phantomjs":w.arguments&&w.stack?"chrome":w.stack&&w.sourceURL?"safari":w.stack&&w.number?"ie":w.stack&&w.fileName?"firefox":w.message&&w["opera#sourceloc"]?!w.stacktrace||-1<w.message.indexOf("\n")&&w.message.split("\n").length>w.stacktrace.split("\n").length?"opera9":"opera10a":w.message&&w.stack&&w.stacktrace?0>w.stacktrace.indexOf("called from line")?
"opera10b":"opera11":w.stack&&!w.fileName?"chrome":"other"},instrumentFunction:function(w,K,U){w=w||window;var V=w[K];w[K]=function(){U.call(this,oa().slice(4));return w[K]._instrumented.apply(this,arguments)};w[K]._instrumented=V},deinstrumentFunction:function(w,K){w[K].constructor===Function&&w[K]._instrumented&&w[K]._instrumented.constructor===Function&&(w[K]=w[K]._instrumented)},chrome:function(w){return(w.stack+"\n").replace(/^[\s\S]+?\s+at\s+/," at ").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,
"{anonymous}() ($1)$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}() ($1)").replace(/^(.+) \((.+)\)$/gm,"$1@$2").split("\n").slice(0,-1)},safari:function(w){return w.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(w){return w.stack.replace(/^\s*at\s+(.*)$/gm,"$1").replace(/^Anonymous function\s+/gm,"{anonymous}() ").replace(/^(.+)\s+\((.+)\)$/gm,"$1@$2").split("\n").slice(1)},firefox:function(w){return w.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^(?:\((\S*)\))?@/gm,"{anonymous}($1)@").split("\n")},opera11:function(w){var K=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;w=w.stacktrace.split("\n");for(var U=[],V=0,Y=w.length;V<Y;V+=2){var L=K.exec(w[V]);if(L){var C=L[4]+":"+L[1]+":"+L[2],L=L[3]||"global code",L=L.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");U.push(L+"@"+C+" -- "+w[V+1].replace(/^\s+/,""))}}return U},opera10b:function(w){var K=/^(.*)@(.+):(\d+)$/;w=w.stacktrace.split("\n");
for(var U=[],V=0,Y=w.length;V<Y;V++){var L=K.exec(w[V]);L&&U.push((L[1]?L[1]+"()":"global code")+"@"+L[2]+":"+L[3])}return U},opera10a:function(w){var K=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;w=w.stacktrace.split("\n");for(var U=[],V=0,Y=w.length;V<Y;V+=2){var L=K.exec(w[V]);L&&U.push((L[3]||"{anonymous}")+"()@"+L[2]+":"+L[1]+" -- "+w[V+1].replace(/^\s+/,""))}return U},opera9:function(w){var K=/Line (\d+).*script (?:in )?(\S+)/i;w=w.message.split("\n");for(var U=[],V=2,Y=w.length;V<
Y;V+=2){var L=K.exec(w[V]);L&&U.push("{anonymous}()@"+L[2]+":"+L[1]+" -- "+w[V+1].replace(/^\s+/,""))}return U},phantomjs:function(w){var K=/(\S+) \((\S+)\)/i;w=w.stack.split("\n");for(var U=[],V=1,Y=w.length;V<Y;V++){w[V]=w[V].replace(/^\s+at\s+/gm,"");var L=K.exec(w[V]);L?U.push(L[1]+"()@"+L[2]):U.push("{anonymous}()@"+w[V])}return U},other:function(w){for(var K=/function(?:\s+([\w$]+))?\s*\(/,U=[],V,Y,L=Array.prototype.slice;w&&10>U.length;){V=K.test(w.toString())?RegExp.$1||"{anonymous}":"{anonymous}";
try{Y=L.call(w.arguments||[])}catch(C){Y=["Cannot access arguments: "+C]}U[U.length]=V+"("+this.stringifyArguments(Y)+")";try{w=w.caller}catch(oa){U[U.length]="Cannot access caller: "+oa;break}}return U},stringifyArguments:function(w){for(var K=[],U=Array.prototype.slice,V=0;V<w.length;++V){var Y=w[V];void 0===Y?K[V]="undefined":null===Y?K[V]="null":Y.constructor&&(K[V]=Y.constructor===Array?3>Y.length?"["+this.stringifyArguments(Y)+"]":"["+this.stringifyArguments(U.call(Y,0,1))+"..."+this.stringifyArguments(U.call(Y,
-1))+"]":Y.constructor===Object?"#object":Y.constructor===Function?"#function":Y.constructor===String?'"'+Y+'"':Y.constructor===Number?Y:"?")}return K.join(",")},sourceCache:{},ajax:function(w){var K=this.createXMLHTTPObject();if(K)try{return K.open("GET",w,!1),K.send(null),K.responseText}catch(U){}return""},createXMLHTTPObject:function(){for(var w,K=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},
function(){return new ActiveXObject("Microsoft.XMLHTTP")}],U=0;U<K.length;U++)try{return w=K[U](),this.createXMLHTTPObject=K[U],w}catch(V){}},isSameDomain:function(w){return"undefined"!==typeof location&&-1!==w.indexOf(location.hostname)},getSource:function(w){w in this.sourceCache||(this.sourceCache[w]=this.ajax(w).split("\n"));return this.sourceCache[w]},guessAnonymousFunctions:function(w){for(var K=0;K<w.length;++K){var U=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,V=w[K],Y=/\{anonymous\}\(.*\)@(.*)/.exec(V);
if(Y){var L=U.exec(Y[1]);L&&(U=L[1],Y=L[2],L=L[3]||0,U&&this.isSameDomain(U)&&Y&&(U=this.guessAnonymousFunction(U,Y,L),w[K]=V.replace("{anonymous}",U)))}}return w},guessAnonymousFunction:function(w,K,U){var V;try{V=this.findFunctionName(this.getSource(w),K)}catch(Y){V="getSource failed with url: "+w+", exception: "+Y.toString()}return V},findFunctionName:function(w,K){for(var U=/function\s+([^(]*?)\s*\(([^)]*)\)/,V=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/,Y=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/,
L="",C,oa=Math.min(K,20),sd,Kb=0;Kb<oa;++Kb)if(C=w[K-Kb-1],sd=C.indexOf("//"),0<=sd&&(C=C.substr(0,sd)),C)if(L=C+L,(C=V.exec(L))&&C[1]||(C=U.exec(L))&&C[1]||(C=Y.exec(L))&&C[1])return C[1];return"(?)"}};return oa});
(function(oa){function w(e){var k="",h,d=0,r,n;for(h=0;h<e.length&&e.charAt(h)!=Fd;++h)n=Yb.indexOf(e.charAt(h)),0>n||(0==d?(k+=Zb.charAt(n>>2),r=n&3,d=1):1==d?(k+=Zb.charAt(r<<2|n>>4),r=n&15,d=2):2==d?(k+=Zb.charAt(r),k+=Zb.charAt(n>>2),r=n&3,d=3):(k+=Zb.charAt(r<<2|n>>4),k+=Zb.charAt(n&15),d=0));1==d&&(k+=Zb.charAt(r<<2));return k}function K(){this.j=this.i=0;this.S=[]}function U(){var e=(new Date).getTime();Db[Ra++]^=e&255;Db[Ra++]^=e>>8&255;Db[Ra++]^=e>>16&255;Db[Ra++]^=e>>24&255;Ra>=Gd&&(Ra-=
Gd)}function V(){}function Y(e,k){return new B(e,k)}function L(e,k,h){for(var d="",r=0;d.length<k;)d+=h(String.fromCharCode.apply(String,e.concat([(r&4278190080)>>24,(r&16711680)>>16,(r&65280)>>8,r&255]))),r+=1;return d}function C(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}function Sd(e,k,h){for(var d="",r=0;d.length<k;)d+=h(e+String.fromCharCode.apply(String,[(r&4278190080)>>24,(r&16711680)>>16,(r&65280)>>8,r&255])),r+=1;return d}function sd(e){var k=[],h=I.getStartPosOfV_AtObj(e,
0),d=I.getPosOfNextSibling_AtObj(e,h),r=I.getPosOfNextSibling_AtObj(e,d),n=I.getPosOfNextSibling_AtObj(e,r),a=I.getPosOfNextSibling_AtObj(e,n),b=I.getPosOfNextSibling_AtObj(e,a),c=I.getPosOfNextSibling_AtObj(e,b),g=I.getPosOfNextSibling_AtObj(e,c),f=I.getPosOfNextSibling_AtObj(e,g);k.push(h,d,r,n,a,b,c,g,f);h=I.getHexOfV_AtObj(e,k[0]);d=I.getHexOfV_AtObj(e,k[1]);r=I.getHexOfV_AtObj(e,k[2]);n=I.getHexOfV_AtObj(e,k[3]);a=I.getHexOfV_AtObj(e,k[4]);b=I.getHexOfV_AtObj(e,k[5]);c=I.getHexOfV_AtObj(e,k[6]);
g=I.getHexOfV_AtObj(e,k[7]);e=I.getHexOfV_AtObj(e,k[8]);k=[];k.push(h,d,r,n,a,b,c,g,e);return k}function Kb(e,k){for(var h="",d=k/4-e.length,r=0;r<d;r++)h+="0";return h+e}function Td(e,k){var h=N.crypto.Util.hashString(e,k);return this.signWithMessageHash(h,k)}function se(e){return Td.call(this,e,"sha1")}function te(e){return Td.call(this,e,"sha256")}function ue(e,k,h){for(var d="",r=0;d.length<k;)d+=hextorstr(h(rstrtohex(e+String.fromCharCode.apply(String,[(r&4278190080)>>24,(r&16711680)>>16,(r&
65280)>>8,r&255])))),r+=1;return d}function ve(e,k,h){e=rstrtohex(e);e=N.crypto.Util.hashHex(e,k);void 0===h&&(h=-1);return this.signWithMessageHashPSS(e,k,h)}function ce(e){for(var k in N.crypto.Util.DIGESTINFOHEAD){var h=N.crypto.Util.DIGESTINFOHEAD[k],d=h.length;if(e.substring(0,d)==h)return[k,e.substring(d)]}return[]}function td(e,k){var h=Y(e,16);var d=this.n.toString(16),r=this.e.toString(16),n=new C;n.setPublic(d,r);h=n.doPublic(h).toString(16).replace(/^1f+00/,"");d=ce(h);0==d.length?h=!1:
(h=d[1],d=N.crypto.Util.hashString(k,d[0]),h=h==d);return h}function Hd(e,k){k=k.replace(Ud,"");k=k.replace(/[ \n]+/g,"");var h=Y(k,16);if(h.bitLength()>this.n.bitLength())return 0;var h=this.doPublic(h).toString(16).replace(/^1f+00/,""),d=ce(h);if(0==d.length)return!1;h=d[1];d=N.crypto.Util.hashString(e,d[0]);return h==d}function de(e,k,h,d){e=rstrtohex(e);e=N.crypto.Util.hashHex(e,h);void 0===d&&(d=-1);return this.verifyWithMessageHashPSS(e,k,h,d)}function ga(){this.hex=this.subjectPublicKeyRSA_hE=
this.subjectPublicKeyRSA_hN=this.subjectPublicKeyRSA=null;this.getSerialNumberHex=function(){return I.getDecendantHexVByNthList(this.hex,0,[0,1])};this.getIssuerHex=function(){return I.getDecendantHexTLVByNthList(this.hex,0,[0,3])};this.getIssuerString=function(){return ga.hex2dn(I.getDecendantHexTLVByNthList(this.hex,0,[0,3]))};this.getSubjectHex=function(){return I.getDecendantHexTLVByNthList(this.hex,0,[0,5])};this.getSubjectString=function(){return ga.hex2dn(I.getDecendantHexTLVByNthList(this.hex,
0,[0,5]))};this.getNotBefore=function(){var e=I.getDecendantHexVByNthList(this.hex,0,[0,4,0]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.getNotAfter=function(){var e=I.getDecendantHexVByNthList(this.hex,0,[0,4,1]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.readCertPEM=function(e){e=ga.pemToHex(e);var k=ga.getPublicKeyHexArrayFromCertHex(e),h=new C;h.setPublic(k[0],k[1]);this.subjectPublicKeyRSA=h;this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=
k[1];this.hex=e};this.readCertPEMWithoutRSAInit=function(e){e=ga.pemToHex(e);var k=ga.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(k[0],k[1]);this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=k[1];this.hex=e}}function ka(){return new B(null)}function Ob(e,k,h,d,r,n){for(;0<=--n;){var a=k*this[e++]+h[d]+r;r=Math.floor(a/67108864);h[d++]=a&67108863}return r}function we(e,k,h,d,r,n){var a=k&32767;for(k>>=15;0<=--n;){var b=this[e]&32767,c=this[e++]>>15,g=k*b+c*a,b=
a*b+((g&32767)<<15)+h[d]+(r&1073741823);r=(b>>>30)+(g>>>15)+k*c+(r>>>30);h[d++]=b&1073741823}return r}function ee(e,k,h,d,r,n){var a=k&16383;for(k>>=14;0<=--n;){var b=this[e]&16383,c=this[e++]>>14,g=k*b+c*a,b=a*b+((g&16383)<<14)+h[d]+r;r=(b>>28)+(g>>14)+k*c;h[d++]=b&268435455}return r}function $c(e,k){var h=xe[e.charCodeAt(k)];return null==h?-1:h}function Jc(e){var k=ka();k.fromInt(e);return k}function Id(e){var k=1,h;0!=(h=e>>>16)&&(e=h,k+=16);0!=(h=e>>8)&&(e=h,k+=8);0!=(h=e>>4)&&(e=h,k+=4);0!=(h=
e>>2)&&(e=h,k+=2);0!=e>>1&&(k+=1);return k}function yc(e){this.m=e}function Sa(e){this.m=e;this.mp=e.invDigit();this.mpl=this.mp&32767;this.mph=this.mp>>15;this.um=(1<<e.DB-15)-1;this.mt2=2*e.t}function Le(e,k){return e&k}function Vd(e,k){return e|k}function Wd(e,k){return e^k}function ad(e,k){return e&~k}function bd(){}function Jd(e){return e}function Kc(e){this.r2=ka();this.q3=ka();B.ONE.dlShiftTo(2*e.t,this.r2);this.mu=this.r2.divide(e);this.m=e}function f(e,k,h){if(!(this instanceof f))return new f(e,
k,h);var d=typeof e;if("base64"===k&&"string"===d)for(e=f.stringtrim(e);0!==e.length%4;)e+="=";var r;if("number"===d)r=f.coerce(e);else if("string"===d)r=f.byteLength(e,k);else if("object"===d)r=f.coerce(e.length);else throw Error("First argument needs to be a number, array or string.");var n;f._useTypedArrays?n=f._augment(new Uint8Array(r)):(n=this,n.length=r,n._isBuffer=!0);if(f._useTypedArrays&&"number"===typeof e.byteLength)n._set(e);else if(f.isArrayish(e))if(f.isBuffer(e))for(k=0;k<r;k++)n[k]=
e.readUInt8(k);else for(k=0;k<r;k++)n[k]=(e[k]%256+256)%256;else if("string"===d)n.write(e,0,k);else if("number"===d&&!f._useTypedArrays&&!h)for(k=0;k<r;k++)n[k]=0;return n}function T(e){if(e)return e.__proto__=T.prototype,e}function wa(e){if(e)return e.__proto__=wa.prototype,e}function Pb(e){if(e)return e.__proto__=Pb.prototype,e}function x(e){if(e)return e.__proto__=x.prototype,e}function Lc(e){x.call(this,e)}function F(e){x.call(this,e)}function fc(e){if(e)return e.__proto__=fc.prototype,e}var a=
a||{},s=a;s.printStackTrace=oa.printStackTrace;var Hb=function(){var e=!1;if("undefined"!==typeof crypto&&crypto&&crypto.subtle){var k={name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:{name:"SHA-256"},publicExponent:new Uint8Array([1,0,1])},h;crypto.subtle.generateKey(k,!0,["sign","verify"]).then(function(d){h=d;return crypto.subtle.sign(k,d.privateKey,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.verify(k,h.publicKey,d,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.exportKey("pkcs8",
h.privateKey)}).then(function(d){return crypto.subtle.importKey("pkcs8",d,k,!0,["sign"])}).then(function(d){return crypto.subtle.exportKey("spki",h.publicKey)}).then(function(d){return crypto.subtle.importKey("spki",d,k,!0,["verify"])}).then(function(d){d=new Uint8Array([1,2,3,4,5]);return crypto.subtle.digest({name:"SHA-256"},d.buffer)}).then(function(d){e=!0},function(d){console.log("DetectSubtleCrypto encountered error, not using crypto.subtle: ",d)})}return function(){return e}}();s.UseSubtleCrypto=
Hb;var $b=$b||function(e,k){var h={},d=h.lib={},r=d.Base=function(){function d(){}return{extend:function(e){d.prototype=this;var h=new d;e&&h.mixIn(e);h.hasOwnProperty("init")||(h.init=function(){h.$super.init.apply(this,arguments)});h.init.prototype=h;h.$super=this;return h},create:function(){var d=this.extend();d.init.apply(d,arguments);return d},init:function(){},mixIn:function(d){for(var e in d)d.hasOwnProperty(e)&&(this[e]=d[e]);d.hasOwnProperty("toString")&&(this.toString=d.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),
n=d.WordArray=r.extend({init:function(d,e){d=this.words=d||[];this.sigBytes=e!=k?e:4*d.length},toString:function(d){return(d||b).stringify(this)},concat:function(d){var e=this.words,h=d.words,k=this.sigBytes;d=d.sigBytes;this.clamp();if(k%4)for(var r=0;r<d;r++)e[k+r>>>2]|=(h[r>>>2]>>>24-r%4*8&255)<<24-(k+r)%4*8;else for(r=0;r<d;r+=4)e[k+r>>>2]=h[r>>>2];this.sigBytes+=d;return this},clamp:function(){var d=this.words,h=this.sigBytes;d[h>>>2]&=4294967295<<32-h%4*8;d.length=e.ceil(h/4)},clone:function(){var d=
r.clone.call(this);d.words=this.words.slice(0);return d},random:function(d){for(var h=[],k=0;k<d;k+=4)h.push(4294967296*e.random()|0);return new n.init(h,d)}}),a=h.enc={},b=a.Hex={stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++){var r=e[k>>>2]>>>24-k%4*8&255;h.push((r>>>4).toString(16));h.push((r&15).toString(16))}return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k+=2)h[k>>>3]|=parseInt(d.substr(k,2),16)<<24-k%8*4;return new n.init(h,e/2)}},c=a.Latin1=
{stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++)h.push(String.fromCharCode(e[k>>>2]>>>24-k%4*8&255));return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k++)h[k>>>2]|=(d.charCodeAt(k)&255)<<24-k%4*8;return new n.init(h,e)}},g=a.Utf8={stringify:function(d){try{return decodeURIComponent(escape(c.stringify(d)))}catch(e){throw Error("Malformed UTF-8 data");}},parse:function(d){return c.parse(unescape(encodeURIComponent(d)))}},f=d.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=
new n.init;this._nDataBytes=0},_append:function(d){"string"==typeof d&&(d=g.parse(d));this._data.concat(d);this._nDataBytes+=d.sigBytes},_process:function(d){var h=this._data,k=h.words,r=h.sigBytes,a=this.blockSize,b=r/(4*a),b=d?e.ceil(b):e.max((b|0)-this._minBufferSize,0);d=b*a;r=e.min(4*d,r);if(d){for(var c=0;c<d;c+=a)this._doProcessBlock(k,c);c=k.splice(0,d);h.sigBytes-=r}return new n.init(c,r)},clone:function(){var d=r.clone.call(this);d._data=this._data.clone();return d},_minBufferSize:0});d.Hasher=
f.extend({cfg:r.extend(),init:function(d){this.cfg=this.cfg.extend(d);this.reset()},reset:function(){f.reset.call(this);this._doReset()},update:function(d){this._append(d);this._process();return this},finalize:function(d){d&&this._append(d);return this._doFinalize()},blockSize:16,_createHelper:function(d){return function(e,h){return(new d.init(h)).finalize(e)}},_createHmacHelper:function(d){return function(e,h){return(new l.HMAC.init(d,h)).finalize(e)}}});var l=h.algo={};return h}(Math);s.CryptoJS=
$b;var Kd=a.CryptoJS;(function(e){var k=Kd.lib,h=k.WordArray,d=k.Hasher,k=Kd.algo,r=[],n=[];(function(){function d(h){for(var k=e.sqrt(h),r=2;r<=k;r++)if(!(h%r))return!1;return!0}function h(d){return 4294967296*(d-(d|0))|0}for(var k=2,a=0;64>a;)d(k)&&(8>a&&(r[a]=h(e.pow(k,0.5))),n[a]=h(e.pow(k,1/3)),a++),k++})();var a=[],k=k.SHA256=d.extend({_doReset:function(){this._hash=new h.init(r.slice(0))},_doProcessBlock:function(d,e){for(var h=this._hash.words,k=h[0],r=h[1],b=h[2],c=h[3],g=h[4],f=h[5],l=h[6],
q=h[7],m=0;64>m;m++){if(16>m)a[m]=d[e+m]|0;else{var t=a[m-15],s=a[m-2];a[m]=((t<<25|t>>>7)^(t<<14|t>>>18)^t>>>3)+a[m-7]+((s<<15|s>>>17)^(s<<13|s>>>19)^s>>>10)+a[m-16]}t=q+((g<<26|g>>>6)^(g<<21|g>>>11)^(g<<7|g>>>25))+(g&f^~g&l)+n[m]+a[m];s=((k<<30|k>>>2)^(k<<19|k>>>13)^(k<<10|k>>>22))+(k&r^k&b^r&b);q=l;l=f;f=g;g=c+t|0;c=b;b=r;r=k;k=t+s|0}h[0]=h[0]+k|0;h[1]=h[1]+r|0;h[2]=h[2]+b|0;h[3]=h[3]+c|0;h[4]=h[4]+g|0;h[5]=h[5]+f|0;h[6]=h[6]+l|0;h[7]=h[7]+q|0},_doFinalize:function(){var d=this._data,h=d.words,
k=8*this._nDataBytes,r=8*d.sigBytes;h[r>>>5]|=128<<24-r%32;h[(r+64>>>9<<4)+14]=e.floor(k/4294967296);h[(r+64>>>9<<4)+15]=k;d.sigBytes=4*h.length;this._process();return this._hash},clone:function(){var e=d.clone.call(this);e._hash=this._hash.clone();return e}});Kd.SHA256=d._createHelper(k);Kd.HmacSHA256=d._createHmacHelper(k)})(Math);s.CryptoJS=Kd;(function(){var e=$b,k=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,d){e=this._hasher=new e.init;"string"==typeof d&&(d=k.parse(d));var r=e.blockSize,
n=4*r;d.sigBytes>n&&(d=e.finalize(d));d.clamp();for(var a=this._oKey=d.clone(),b=this._iKey=d.clone(),c=a.words,g=b.words,f=0;f<r;f++)c[f]^=1549556828,g[f]^=909522486;a.sigBytes=b.sigBytes=n;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var d=this._hasher;e=d.finalize(e);d.reset();return d.finalize(this._oKey.clone().concat(e))}})})();var Yb="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
Fd="=";s.b64tohex=w;s.b64toBA=function(e){e=w(e);var k,h=[];for(k=0;2*k<e.length;++k)h[k]=parseInt(e.substring(2*k,2*k+2),16);return h};s.hex2b64=function(e){var k,h,d="";for(k=0;k+3<=e.length;k+=3)h=parseInt(e.substring(k,k+3),16),d+=Yb.charAt(h>>6)+Yb.charAt(h&63);k+1==e.length?(h=parseInt(e.substring(k,k+1),16),d+=Yb.charAt(h<<2)):k+2==e.length&&(h=parseInt(e.substring(k,k+2),16),d+=Yb.charAt(h>>2)+Yb.charAt((h&3)<<4));if(Fd)for(;0<(d.length&3);)d+=Fd;return d};K.prototype.init=function(e){var k,
h,d;for(k=0;256>k;++k)this.S[k]=k;for(k=h=0;256>k;++k)h=h+this.S[k]+e[k%e.length]&255,d=this.S[k],this.S[k]=this.S[h],this.S[h]=d;this.j=this.i=0};K.prototype.next=function(){var e;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;e=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=e;return this.S[e+this.S[this.i]&255]};var Gd=256,zc,Db,Ra;if(null==Db){Db=[];Ra=0;var cd;if("Netscape"==navigator.appName&&"5">navigator.appVersion&&window.crypto){var Mc=window.crypto.random(32);for(cd=0;cd<
Mc.length;++cd)Db[Ra++]=Mc.charCodeAt(cd)&255}for(;Ra<Gd;)cd=Math.floor(65536*Math.random()),Db[Ra++]=cd>>>8,Db[Ra++]=cd&255;Ra=0;U()}V.prototype.nextBytes=function(e){var k;for(k=0;k<e.length;++k){var h=e,d=k,r;if(null==zc){U();zc=new K;zc.init(Db);for(Ra=0;Ra<Db.length;++Ra)Db[Ra]=0;Ra=0}r=zc.next();h[d]=r}};var kc=a,Qb=20;C.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)};C.prototype.setPublic=function(e,k){this.isPublic=!0;"string"!==typeof e?(this.n=e,this.e=k):null!=e&&null!=
k&&0<e.length&&0<k.length?(this.n=Y(e,16),this.e=parseInt(k,16)):alert("Invalid RSA public key")};C.prototype.encrypt=function(e){var k;k=this.n.bitLength()+7>>3;if(k<e.length+11)alert("Message too long for RSA"),k=null;else{for(var h=[],d=e.length-1;0<=d&&0<k;){var r=e.charCodeAt(d--);128>r?h[--k]=r:127<r&&2048>r?(h[--k]=r&63|128,h[--k]=r>>6|192):(h[--k]=r&63|128,h[--k]=r>>6&63|128,h[--k]=r>>12|224)}h[--k]=0;e=new V;for(d=[];2<k;){for(d[0]=0;0==d[0];)e.nextBytes(d);h[--k]=d[0]}h[--k]=2;h[--k]=0;
k=new B(h)}if(null==k)return null;k=this.doPublic(k);if(null==k)return null;k=k.toString(16);return 0==(k.length&1)?k:"0"+k};C.prototype.encryptOAEP=function(e,k){var h,d=this.n.bitLength()+7>>3;if(e.length+2*Qb+2>d)throw"Message too long for RSA";var r="";for(h=0;h<d-e.length-2*Qb-2;h+=1)r+="\x00";var n=rstr_sha1("")+r+"\u0001"+e,d=Array(Qb);(new V).nextBytes(d);var a=L(d,n.length,k||rstr_sha1),r=[];for(h=0;h<n.length;h+=1)r[h]=n.charCodeAt(h)^a.charCodeAt(h);n=L(r,d.length,rstr_sha1);a=[0];for(h=
0;h<d.length;h+=1)a[h+1]=d[h]^n.charCodeAt(h);h=new B(a.concat(r));if(null==h)return null;h=this.doPublic(h);if(null==h)return null;h=h.toString(16);return 0==(h.length&1)?h:"0"+h};C.prototype.type="RSA";s.RSAKey=C;var kc=a,B=kc.BigInteger?kc.BigInteger:kc,C=a.RSAKey,Qb=20;C.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);var k=e.mod(this.p).modPow(this.dmp1,this.p);for(e=e.mod(this.q).modPow(this.dmq1,this.q);0>k.compareTo(e);)k=k.add(this.p);return k.subtract(e).multiply(this.coeff).mod(this.p).multiply(this.q).add(e)};
C.prototype.setPrivate=function(e,k,h){this.isPrivate=!0;"string"!==typeof e?(this.n=e,this.e=k,this.d=h):null!=e&&null!=k&&0<e.length&&0<k.length?(this.n=Y(e,16),this.e=parseInt(k,16),this.d=Y(h,16)):alert("Invalid RSA private key")};C.prototype.setPrivateEx=function(e,k,h,d,r,n,a,b){this.isPrivate=!0;if(null==e)throw"RSASetPrivateEx N == null";if(null==k)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==k.length)throw"RSASetPrivateEx E.length == 0";null!=
e&&null!=k&&0<e.length&&0<k.length?(this.n=Y(e,16),this.e=parseInt(k,16),this.d=Y(h,16),this.p=Y(d,16),this.q=Y(r,16),this.dmp1=Y(n,16),this.dmq1=Y(a,16),this.coeff=Y(b,16)):alert("Invalid RSA private key in RSASetPrivateEx")};C.prototype.generate=function(e,k){var h=new V,d=e>>1;this.e=parseInt(k,16);for(var r=new B(k,16);;){for(;this.p=new B(e-d,1,h),0!=this.p.subtract(B.ONE).gcd(r).compareTo(B.ONE)||!this.p.isProbablePrime(10););for(;this.q=new B(d,1,h),0!=this.q.subtract(B.ONE).gcd(r).compareTo(B.ONE)||
!this.q.isProbablePrime(10););if(0>=this.p.compareTo(this.q)){var n=this.p;this.p=this.q;this.q=n}var n=this.p.subtract(B.ONE),a=this.q.subtract(B.ONE),b=n.multiply(a);if(0==b.gcd(r).compareTo(B.ONE)){this.n=this.p.multiply(this.q);this.d=r.modInverse(b);this.dmp1=this.d.mod(n);this.dmq1=this.d.mod(a);this.coeff=this.q.modInverse(this.p);break}}this.isPrivate=!0};C.prototype.decrypt=function(e){e=Y(e,16);e=this.doPrivate(e);if(null==e)return null;a:{var k=this.n.bitLength()+7>>3;e=e.toByteArray();
for(var h=0;h<e.length&&0==e[h];)++h;if(e.length-h!=k-1||2!=e[h])e=null;else{for(++h;0!=e[h];)if(++h>=e.length){e=null;break a}for(k="";++h<e.length;){var d=e[h]&255;128>d?k+=String.fromCharCode(d):191<d&&224>d?(k+=String.fromCharCode((d&31)<<6|e[h+1]&63),++h):(k+=String.fromCharCode((d&15)<<12|(e[h+1]&63)<<6|e[h+2]&63),h+=2)}e=k}}return e};C.prototype.decryptOAEP=function(e,k){var h=Y(e,16),h=this.doPrivate(h);if(null==h)return null;for(var d=h,r=this.n.bitLength()+7>>3,d=d.toByteArray(),h=0;h<d.length;h+=
1)d[h]&=255;for(;d.length<r;)d.unshift(0);d=String.fromCharCode.apply(String,d);if(d.length<2*Qb+2)throw"Cipher too short";for(var n=d.substr(1,Qb),r=d.substr(Qb+1),a=Sd(r,Qb,k||rstr_sha1),b=[],h=0;h<n.length;h+=1)b[h]=n.charCodeAt(h)^a.charCodeAt(h);n=Sd(String.fromCharCode.apply(String,b),d.length-Qb,rstr_sha1);d=[];for(h=0;h<r.length;h+=1)d[h]=r.charCodeAt(h)^n.charCodeAt(h);d=String.fromCharCode.apply(String,d);if(d.substr(0,Qb)!==rstr_sha1(""))throw"Hash mismatch";d=d.substr(Qb);h=d.indexOf("\u0001");
if((-1!=h?d.substr(0,h).lastIndexOf("\x00"):-1)+1!=h)throw"Malformed data";return d.substr(h+1)};s.RSAKey=C;$b=a.CryptoJS;kc=a;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",
md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"};this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",
SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",
SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"};this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"};this.getDigestInfoHex=function(e,k){if("undefined"==typeof this.DIGESTINFOHEAD[k])throw"alg not supported in Util.DIGESTINFOHEAD: "+
k;return this.DIGESTINFOHEAD[k]+e};this.getPaddedDigestInfoHex=function(e,k,h){var d=this.getDigestInfoHex(e,k);e=h/4;if(d.length+22>e)throw"key is too short for SigAlg: keylen="+h+","+k;k="00"+d;h="";e=e-4-k.length;for(d=0;d<e;d+=2)h+="ff";return"0001"+h+k};this.hashString=function(e,k){return(new N.crypto.MessageDigest({alg:k})).digestString(e)};this.hashHex=function(e,k){return(new N.crypto.MessageDigest({alg:k})).digestHex(e)};this.sha1=function(e){return(new N.crypto.MessageDigest({alg:"sha1",
prov:"cryptojs"})).digestString(e)};this.sha256=function(e){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestString(e)};this.sha256Hex=function(e){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestHex(e)};this.sha512=function(e){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestString(e)};this.sha512Hex=function(e){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestHex(e)};this.md5=function(e){return(new N.crypto.MessageDigest({alg:"md5",
prov:"cryptojs"})).digestString(e)};this.ripemd160=function(e){return(new N.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"})).digestString(e)};this.getCryptoJSMDByName=function(e){}};N.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,h){null!=e&&void 0===h&&(h=N.crypto.Util.DEFAULTPROVIDER[e]);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==h){try{this.md=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e]).create()}catch(d){throw"setAlgAndProvider hash alg set fail alg="+
e+"/"+d;}this.updateString=function(d){this.md.update(d)};this.updateHex=function(d){d=$b.enc.Hex.parse(d);this.md.update(d)};this.digest=function(){return this.md.finalize().toString($b.enc.Hex)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==h){try{this.md=new sjcl.hash.sha256}catch(r){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+r;}this.updateString=function(d){this.md.update(d)};
this.updateHex=function(d){d=sjcl.codec.hex.toBits(d);this.md.update(d)};this.digest=function(){var d=this.md.finalize();return sjcl.codec.hex.fromBits(d)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+
this.algName+"/"+this.provName;};this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName;};void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),
this.setAlgAndProvider(this.algName,this.provName))};N.crypto.Mac=function(e){this.setAlgAndProvider=function(e,h){e=e.toLowerCase();null==e&&(e="hmacsha1");e=e.toLowerCase();if("hmac"!=e.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===h&&(h=N.crypto.Util.DEFAULTPROVIDER[e]);this.algProv=e+"/"+h;var d=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(d)&&"cryptojs"==h){try{var r=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[d]);this.mac=$b.algo.HMAC.create(r,
this.pass)}catch(n){throw"setAlgAndProvider hash alg set fail hashAlg="+d+"/"+n;}this.updateString=function(d){this.mac.update(d)};this.updateHex=function(d){d=$b.enc.Hex.parse(d);this.mac.update(d)};this.doFinal=function(){return this.mac.finalize().toString($b.enc.Hex)};this.doFinalString=function(d){this.updateString(d);return this.doFinal()};this.doFinalHex=function(d){this.updateHex(d);return this.doFinal()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+
this.algProv;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv;};this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv;};this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv;};this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv;};this.setPassword=function(e){if("string"==typeof e){var h=e;1!=e.length%2&&e.match(/^[0-9A-Fa-f]+$/)||
(h=rstrtohex(e))}else{if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;h=null;if(void 0!==e.hex){if(0!=e.hex.length%2||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;h=e.hex}void 0!==e.utf8&&(h=utf8tohex(e.utf8));void 0!==e.rstr&&(h=rstrtohex(e.rstr));void 0!==e.b64&&(h=w(e.b64));void 0!==e.b64u&&(h=b64utohex(e.b64u));if(null==h)throw"KJUR.crypto.Mac unsupported password type: "+e;}this.pass=$b.enc.Hex.parse(h)};void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),
void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))};N.crypto.Signature=function(e){var k=null;this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())};this._zeroPaddingOfSignature=function(d,e){for(var h="",k=e/4-d.length,a=0;a<k;a++)h+="0";return h+d};this.setAlgAndProvider=function(d,e){this._setAlgNames();
if("cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new N.crypto.MessageDigest({alg:this.mdAlgName})}catch(h){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+h;}this.init=function(d,e){var h=null;try{h=void 0===e?KEYUTIL.getKey(d):KEYUTIL.getKey(d,e)}catch(k){throw"init failed:"+k;}if(!0===h.isPrivate)this.prvKey=h,this.state="SIGN";else if(!0===h.isPublic)this.pubKey=h,this.state=
"VERIFY";else throw"init failed.:"+h;};this.initSign=function(d){"string"==typeof d.ecprvhex&&"string"==typeof d.eccurvename?(this.ecprvhex=d.ecprvhex,this.eccurvename=d.eccurvename):this.prvKey=d;this.state="SIGN"};this.initVerifyByPublicKey=function(d){"string"==typeof d.ecpubhex&&"string"==typeof d.eccurvename?(this.ecpubhex=d.ecpubhex,this.eccurvename=d.eccurvename):d instanceof N.crypto.ECDSA?this.pubKey=d:d instanceof C&&(this.pubKey=d);this.state="VERIFY"};this.initVerifyByCertificatePEM=function(d){var e=
new ga;e.readCertPEM(d);this.pubKey=e.subjectPublicKeyRSA;this.state="VERIFY"};this.updateString=function(d){this.md.updateString(d)};this.updateHex=function(d){this.md.updateHex(d)};this.sign=function(){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename)this.hSign=(new N.crypto.ECDSA({curve:this.eccurvename})).signHex(this.sHashHex,this.ecprvhex);else if(this.prvKey instanceof C&&"rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,
this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof C&&"rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof N.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else if(this.prvKey instanceof N.crypto.DSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;return this.hSign};this.signString=function(d){this.updateString(d);
return this.sign()};this.signHex=function(d){this.updateHex(d);return this.sign()};this.verify=function(d){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return(new N.crypto.ECDSA({curve:this.eccurvename})).verifyHex(this.sHashHex,d,this.ecpubhex);if(this.pubKey instanceof C&&"rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,d,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof C&&"rsa"==this.pubkeyAlgName||
this.pubKey instanceof N.crypto.ECDSA||this.pubKey instanceof N.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,d);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;}}};this.init=function(d,e){throw"init(key, pass) not supported for this alg:prov="+this.algProvName;};this.initVerifyByPublicKey=function(d){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName;};this.initVerifyByCertificatePEM=function(d){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+
this.algProvName;};this.initSign=function(d){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName;};this.updateString=function(d){throw"updateString(str) not supported for this alg:prov="+this.algProvName;};this.updateHex=function(d){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName;};this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName;};this.signString=function(d){throw"digestString(str) not supported for this alg:prov="+
this.algProvName;};this.signHex=function(d){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName;};this.verify=function(d){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName;};this.initParams=e;if(void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,this.provName=void 0===e.prov?N.crypto.Util.DEFAULTPROVIDER[this.algName]:e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&
(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{k=new C,k.readPrivateKeyFromPEMString(e.prvkeypem),this.initSign(k)}catch(h){throw"fatal error to load pem private key: "+h;}}};N.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1",
"2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}};s.KJUR=N;var I=a.ASN1HEX,w=a.b64tohex,C=a.RSAKey;C.prototype.readPrivateKeyFromPEMString=function(e){e=e.replace("-----BEGIN RSA PRIVATE KEY-----","");e=e.replace("-----END RSA PRIVATE KEY-----","");e=e.replace(/[ \n]+/g,"");e=w(e);e=sd(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};C.prototype.readPrivateKeyFromASN1HexString=
function(e){e=sd(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};s.RSAKey=C;var kc=a,B=kc.BigInteger?kc.BigInteger:kc,C=a.RSAKey,Ud=RegExp("");Ud.compile("[^0-9a-f]","gi");C.prototype.signWithMessageHash=function(e,k){var h=N.crypto.Util.getPaddedDigestInfoHex(e,k,this.n.bitLength()),h=Y(h,16),h=this.doPrivate(h).toString(16);return Kb(h,this.n.bitLength())};C.prototype.signString=Td;C.prototype.signStringWithSHA1=se;C.prototype.signStringWithSHA256=te;C.prototype.sign=Td;C.prototype.signWithSHA1=
se;C.prototype.signWithSHA256=te;C.prototype.signWithMessageHashPSS=function(e,k,h){var d=hextorstr(e);e=d.length;var r=this.n.bitLength()-1,n=Math.ceil(r/8),a=function(d){return N.crypto.Util.hashHex(d,k)};if(-1===h||void 0===h)h=e;else if(-2===h)h=n-e-2;else if(-2>h)throw"invalid salt length";if(n<e+h+2)throw"data too long";var b="";0<h&&(b=Array(h),(new V).nextBytes(b),b=String.fromCharCode.apply(String,b));for(var c=hextorstr(a(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+d+b))),g=[],d=0;d<n-
h-e-2;d+=1)g[d]=0;h=String.fromCharCode.apply(String,g)+"\u0001"+b;a=ue(c,h.length,a);b=[];for(d=0;d<h.length;d+=1)b[d]=h.charCodeAt(d)^a.charCodeAt(d);b[0]&=~(65280>>8*n-r&255);for(d=0;d<e;d++)b.push(c.charCodeAt(d));b.push(188);return Kb(this.doPrivate(new B(b)).toString(16),this.n.bitLength())};C.prototype.signStringPSS=ve;C.prototype.signPSS=ve;C.SALT_LEN_HLEN=-1;C.SALT_LEN_MAX=-2;C.prototype.verifyWithMessageHash=function(e,k){k=k.replace(Ud,"");k=k.replace(/[ \n]+/g,"");var h=Y(k,16);if(h.bitLength()>
this.n.bitLength())return 0;h=this.doPublic(h).toString(16).replace(/^1f+00/,"");h=ce(h);return 0==h.length?!1:h[1]==e};C.prototype.verifyString=Hd;C.prototype.verifyHexSignatureForMessage=td;C.prototype.verify=Hd;C.prototype.verifyHexSignatureForByteArrayMessage=td;C.prototype.verifyWithMessageHashPSS=function(e,k,h,d){var r=new B(k,16);if(r.bitLength()>this.n.bitLength())return!1;k=function(d){return N.crypto.Util.hashHex(d,h)};e=hextorstr(e);var n=e.length,a=this.n.bitLength()-1,b=Math.ceil(a/
8);if(-1===d||void 0===d)d=n;else if(-2===d)d=b-n-2;else if(-2>d)throw"invalid salt length";if(b<n+d+2)throw"data too long";for(var c=this.doPublic(r).toByteArray(),r=0;r<c.length;r+=1)c[r]&=255;for(;c.length<b;)c.unshift(0);if(188!==c[b-1])throw"encoded message does not end in 0xbc";var c=String.fromCharCode.apply(String,c),g=c.substr(0,b-n-1),c=c.substr(g.length,n),f=65280>>8*b-a&255;if(0!==(g.charCodeAt(0)&f))throw"bits beyond keysize not zero";for(var l=ue(c,g.length,k),a=[],r=0;r<g.length;r+=
1)a[r]=g.charCodeAt(r)^l.charCodeAt(r);a[0]&=~f;n=b-n-d-2;for(r=0;r<n;r+=1)if(0!==a[r])throw"leftmost octets not zero";if(1!==a[n])throw"0x01 marker not found";return c===hextorstr(k(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+e+String.fromCharCode.apply(String,a.slice(-d)))))};C.prototype.verifyStringPSS=de;C.prototype.verifyPSS=de;C.SALT_LEN_RECOVER=-2;s.RSAKey=C;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.ECDSA=function(e){var k=new V;this.type=
"EC";this.getBigRandom=function(e){return(new B(e.bitLength(),k)).mod(e.subtract(B.ONE)).add(B.ONE)};this.setNamedCurve=function(e){this.ecparams=N.crypto.ECParameterDB.getByName(e);this.pubKeyHex=this.prvKeyHex=null;this.curveName=e};this.setPrivateKeyHex=function(e){this.isPrivate=!0;this.prvKeyHex=e};this.setPublicKeyHex=function(e){this.isPublic=!0;this.pubKeyHex=e};this.generateKeyPairHex=function(){var e=this.getBigRandom(this.ecparams.n),d=this.ecparams.G.multiply(e),k=d.getX().toBigInteger(),
d=d.getY().toBigInteger(),n=this.ecparams.keylen/4,e=("0000000000"+e.toString(16)).slice(-n),k=("0000000000"+k.toString(16)).slice(-n),d=("0000000000"+d.toString(16)).slice(-n),k="04"+k+d;this.setPrivateKeyHex(e);this.setPublicKeyHex(k);return{ecprvhex:e,ecpubhex:k}};this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)};this.signHex=function(e,d){var k=new B(d,16),n=this.ecparams.n,a=new B(e,16);do var b=this.getBigRandom(n),c=this.ecparams.G.multiply(b).getX().toBigInteger().mod(n);
while(0>=c.compareTo(B.ZERO));k=b.modInverse(n).multiply(a.add(k.multiply(c))).mod(n);return N.crypto.ECDSA.biRSSigToASN1Sig(c,k)};this.sign=function(e,d){var k=this.ecparams.n,n=B.fromByteArrayUnsigned(e);do var a=this.getBigRandom(k),b=this.ecparams.G.multiply(a).getX().toBigInteger().mod(k);while(0>=b.compareTo(B.ZERO));k=a.modInverse(k).multiply(n.add(d.multiply(b))).mod(k);return this.serializeSig(b,k)};this.verifyWithMessageHash=function(e,d){return this.verifyHex(e,d,this.pubKeyHex)};this.verifyHex=
function(e,d,k){var n;n=N.crypto.ECDSA.parseSigHex(d);d=n.r;n=n.s;k=ECPointFp.decodeFromHex(this.ecparams.curve,k);e=new B(e,16);return this.verifyRaw(e,d,n,k)};this.verify=function(e,d,k){var n;if(Bitcoin.Util.isArray(d))d=this.parseSig(d),n=d.r,d=d.s;else if("object"===typeof d&&d.r&&d.s)n=d.r,d=d.s;else throw"Invalid value for signature";if(!(k instanceof ECPointFp))if(Bitcoin.Util.isArray(k))k=ECPointFp.decodeFrom(this.ecparams.curve,k);else throw"Invalid format for pubkey value, must be byte array or ECPointFp";
e=B.fromByteArrayUnsigned(e);return this.verifyRaw(e,n,d,k)};this.verifyRaw=function(e,d,k,n){var a=this.ecparams.n,b=this.ecparams.G;if(0>d.compareTo(B.ONE)||0<=d.compareTo(a)||0>k.compareTo(B.ONE)||0<=k.compareTo(a))return!1;k=k.modInverse(a);e=e.multiply(k).mod(a);k=d.multiply(k).mod(a);return b.multiply(e).add(n.multiply(k)).getX().toBigInteger().mod(a).equals(d)};this.serializeSig=function(e,d){var k=e.toByteArraySigned(),n=d.toByteArraySigned(),a=[];a.push(2);a.push(k.length);a=a.concat(k);
a.push(2);a.push(n.length);a=a.concat(n);a.unshift(a.length);a.unshift(48);return a};this.parseSig=function(e){var d;if(48!=e[0])throw Error("Signature not a valid DERSequence");d=2;if(2!=e[d])throw Error("First element in signature must be a DERInteger");var k=e.slice(d+2,d+2+e[d+1]);d+=2+e[d+1];if(2!=e[d])throw Error("Second element in signature must be a DERInteger");e=e.slice(d+2,d+2+e[d+1]);k=B.fromByteArrayUnsigned(k);e=B.fromByteArrayUnsigned(e);return{r:k,s:e}};this.parseSigCompact=function(e){if(65!==
e.length)throw"Signature has the wrong length";var d=e[0]-27;if(0>d||7<d)throw"Invalid signature type";var k=this.ecparams.n,n=B.fromByteArrayUnsigned(e.slice(1,33)).mod(k);e=B.fromByteArrayUnsigned(e.slice(33,65)).mod(k);return{r:n,s:e,i:d}};void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve);void 0===this.curveName&&(this.curveName="secp256r1");this.setNamedCurve(this.curveName);void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))};N.crypto.ECDSA.parseSigHex=
function(e){var k=N.crypto.ECDSA.parseSigHexInHexRS(e);e=new B(k.r,16);k=new B(k.s,16);return{r:e,s:k}};N.crypto.ECDSA.parseSigHexInHexRS=function(e){if("30"!=e.substr(0,2))throw"signature is not a ASN.1 sequence";var k=I.getPosArrayOfChildren_AtObj(e,0);if(2!=k.length)throw"number of signature ASN.1 sequence elements seem wrong";var h=k[0],k=k[1];if("02"!=e.substr(h,2))throw"1st item of sequene of signature is not ASN.1 integer";if("02"!=e.substr(k,2))throw"2nd item of sequene of signature is not ASN.1 integer";
h=I.getHexOfV_AtObj(e,h);e=I.getHexOfV_AtObj(e,k);return{r:h,s:e}};N.crypto.ECDSA.asn1SigToConcatSig=function(e){var k=N.crypto.ECDSA.parseSigHexInHexRS(e);e=k.r;k=k.s;"00"==e.substr(0,2)&&8==e.length/2*8%128&&(e=e.substr(2));"00"==k.substr(0,2)&&8==k.length/2*8%128&&(k=k.substr(2));if(0!=e.length/2*8%128)throw"unknown ECDSA sig r length error";if(0!=k.length/2*8%128)throw"unknown ECDSA sig s length error";return e+k};N.crypto.ECDSA.concatSigToASN1Sig=function(e){if(0!=e.length/2*8%128)throw"unknown ECDSA concatinated r-s sig  length error";
var k=e.substr(0,e.length/2);e=e.substr(e.length/2);return N.crypto.ECDSA.hexRSSigToASN1Sig(k,e)};N.crypto.ECDSA.hexRSSigToASN1Sig=function(e,k){var h=new B(e,16),d=new B(k,16);return N.crypto.ECDSA.biRSSigToASN1Sig(h,d)};N.crypto.ECDSA.biRSSigToASN1Sig=function(e,k){var h=new N.asn1.DERInteger({bigint:e}),d=new N.asn1.DERInteger({bigint:k});return(new N.asn1.DERSequence({array:[h,d]})).getEncodedHex()};kc=a;I=new function(){this.getByteLengthOfL_AtObj=function(e,k){if("8"!=e.substring(k+2,k+3))return 1;
var h=parseInt(e.substring(k+3,k+4));return 0==h?-1:0<h&&10>h?h+1:-2};this.getHexOfL_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 1>h?"":e.substring(k+2,k+2+2*h)};this.getIntOfL_AtObj=function(e,k){var h=this.getHexOfL_AtObj(e,k);return""==h?-1:(8>parseInt(h.substring(0,1))?new B(h,16):new B(h.substring(2),16)).intValue()};this.getStartPosOfV_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 0>h?h:k+2*(h+1)};this.getHexOfV_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,
k),d=this.getIntOfL_AtObj(e,k);return e.substring(h,h+2*d)};this.getHexOfTLV_AtObj=function(e,k){var h=e.substr(k,2),d=this.getHexOfL_AtObj(e,k),r=this.getHexOfV_AtObj(e,k);return h+d+r};this.getPosOfNextSibling_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,k),d=this.getIntOfL_AtObj(e,k);return h+2*d};this.getPosArrayOfChildren_AtObj=function(e,k){var h=[],d=this.getStartPosOfV_AtObj(e,k);h.push(d);for(var r=this.getIntOfL_AtObj(e,k),n=d,a=0;;){n=this.getPosOfNextSibling_AtObj(e,n);if(null==
n||n-d>=2*r)break;if(200<=a)break;h.push(n);a++}return h};this.getNthChildIndex_AtObj=function(e,k,h){return this.getPosArrayOfChildren_AtObj(e,k)[h]};this.getDecendantIndexByNthList=function(e,k,h){if(0==h.length)return k;var d=h.shift();k=this.getPosArrayOfChildren_AtObj(e,k);return this.getDecendantIndexByNthList(e,k[d],h)};this.getDecendantHexTLVByNthList=function(e,k,h){k=this.getDecendantIndexByNthList(e,k,h);return this.getHexOfTLV_AtObj(e,k)};this.getDecendantHexVByNthList=function(e,k,h){k=
this.getDecendantIndexByNthList(e,k,h);return this.getHexOfV_AtObj(e,k)}};I.getVbyList=function(e,k,h,d){k=this.getDecendantIndexByNthList(e,k,h);if(void 0===k)throw"can't find nthList object";if(void 0!==d&&e.substr(k,2)!=d)throw"checking tag doesn't match: "+e.substr(k,2)+"!="+d;return this.getHexOfV_AtObj(e,k)};I.hextooidstr=function(e){var k=function(d,e){return d.length>=e?d:Array(e-d.length+1).join("0")+d},h=[],d=e.substr(0,2),d=parseInt(d,16);h[0]=new String(Math.floor(d/40));h[1]=new String(d%
40);var r=e.substr(2);e=[];for(d=0;d<r.length/2;d++)e.push(parseInt(r.substr(2*d,2),16));for(var r=[],n="",d=0;d<e.length;d++)e[d]&128?n+=k((e[d]&127).toString(2),7):(n+=k((e[d]&127).toString(2),7),r.push(new String(parseInt(n,2))),n="");k=h.join(".");0<r.length&&(k=k+"."+r.join("."));return k};I.dump=function(e,k,h,d){var r=function(d,e){return d.length<=2*e?d:d.substr(0,e)+"..(total "+d.length/2+"bytes).."+d.substr(d.length-e,e)};void 0===k&&(k={ommit_long_octet:32});void 0===h&&(h=0);void 0===
d&&(d="");var n=k.ommit_long_octet;if("01"==e.substr(h,2))return e=I.getHexOfV_AtObj(e,h),"00"==e?d+"BOOLEAN FALSE\n":d+"BOOLEAN TRUE\n";if("02"==e.substr(h,2))return e=I.getHexOfV_AtObj(e,h),d+"INTEGER "+r(e,n)+"\n";if("03"==e.substr(h,2))return e=I.getHexOfV_AtObj(e,h),d+"BITSTRING "+r(e,n)+"\n";if("04"==e.substr(h,2))return e=I.getHexOfV_AtObj(e,h),I.isASN1HEX(e)?r=d+"OCTETSTRING, encapsulates\n"+I.dump(e,k,0,d+"  "):d+"OCTETSTRING "+r(e,n)+"\n";if("05"==e.substr(h,2))return d+"NULL\n";if("06"==
e.substr(h,2)){e=I.getHexOfV_AtObj(e,h);var a=N.asn1.ASN1Util.oidHexToInt(e),n=N.asn1.x509.OID.oid2name(a);e=a.replace(/\./g," ");return""!=n?d+"ObjectIdentifier "+n+" ("+e+")\n":d+"ObjectIdentifier ("+e+")\n"}if("0c"==e.substr(h,2))return d+"UTF8String '"+hextoutf8(I.getHexOfV_AtObj(e,h))+"'\n";if("13"==e.substr(h,2))return d+"PrintableString '"+hextoutf8(I.getHexOfV_AtObj(e,h))+"'\n";if("14"==e.substr(h,2))return d+"TeletexString '"+hextoutf8(I.getHexOfV_AtObj(e,h))+"'\n";if("16"==e.substr(h,2))return d+
"IA5String '"+hextoutf8(I.getHexOfV_AtObj(e,h))+"'\n";if("17"==e.substr(h,2))return d+"UTCTime "+hextoutf8(I.getHexOfV_AtObj(e,h))+"\n";if("18"==e.substr(h,2))return d+"GeneralizedTime "+hextoutf8(I.getHexOfV_AtObj(e,h))+"\n";if("30"==e.substr(h,2)){if("3000"==e.substr(h,4))return d+"SEQUENCE {}\n";r=d+"SEQUENCE\n";h=I.getPosArrayOfChildren_AtObj(e,h);n=k;2!=h.length&&3!=h.length||"06"!=e.substr(h[0],2)||"04"!=e.substr(h[h.length-1],2)||(n=I.getHexOfV_AtObj(e,h[0]),a=N.asn1.ASN1Util.oidHexToInt(n),
n=N.asn1.x509.OID.oid2name(a),k=JSON.parse(JSON.stringify(k)),k.x509ExtName=n,n=k);for(a=0;a<h.length;a++)r+=I.dump(e,n,h[a],d+"  ");return r}if("31"==e.substr(h,2)){r=d+"SET\n";h=I.getPosArrayOfChildren_AtObj(e,h);for(a=0;a<h.length;a++)r+=I.dump(e,k,h[a],d+"  ");return r}n=parseInt(e.substr(h,2),16);if(0!=(n&128)){r=n&31;if(0!=(n&32))for(r=d+"["+r+"]\n",h=I.getPosArrayOfChildren_AtObj(e,h),a=0;a<h.length;a++)r+=I.dump(e,k,h[a],d+"  ");else e=I.getHexOfV_AtObj(e,h),"68747470"==e.substr(0,8)&&(e=
hextoutf8(e)),"subjectAltName"===k.x509ExtName&&2==r&&(e=hextoutf8(e)),r=d+"["+r+"] "+e+"\n";return r}return d+"UNKNOWN("+e.substr(h,2)+") "+I.getHexOfV_AtObj(e,h)+"\n"};I.isASN1HEX=function(e){if(1==e.length%2)return!1;var k=I.getIntOfL_AtObj(e,0),h=e.substr(0,2),d=I.getHexOfL_AtObj(e,0);return e.length-h.length-d.length==2*k?!0:!1};s.ASN1HEX=I;w=a.b64tohex;C=a.RSAKey;I=a.ASN1HEX;ga.pemToBase64=function(e){e=e.replace("-----BEGIN CERTIFICATE-----","");e=e.replace("-----END CERTIFICATE-----","");
return e=e.replace(/[ \n]+/g,"")};ga.pemToHex=function(e){e=ga.pemToBase64(e);return w(e)};ga.getSubjectPublicKeyPosFromCertHex=function(e){var k=ga.getSubjectPublicKeyInfoPosFromCertHex(e);if(-1==k)return-1;k=I.getPosArrayOfChildren_AtObj(e,k);if(2!=k.length)return-1;k=k[1];if("03"!=e.substring(k,k+2))return-1;k=I.getStartPosOfV_AtObj(e,k);return"00"!=e.substring(k,k+2)?-1:k+2};ga.getSubjectPublicKeyInfoPosFromCertHex=function(e){var k=I.getStartPosOfV_AtObj(e,0),k=I.getPosArrayOfChildren_AtObj(e,
k);return 1>k.length?-1:"a003020102"==e.substring(k[0],k[0]+10)?6>k.length?-1:k[6]:5>k.length?-1:k[5]};ga.getPublicKeyHexArrayFromCertHex=function(e){var k=ga.getSubjectPublicKeyPosFromCertHex(e),h=I.getPosArrayOfChildren_AtObj(e,k);if(2!=h.length)return[];k=I.getHexOfV_AtObj(e,h[0]);e=I.getHexOfV_AtObj(e,h[1]);return null!=k&&null!=e?[k,e]:[]};ga.getHexTbsCertificateFromCert=function(e){return I.getStartPosOfV_AtObj(e,0)};ga.getPublicKeyHexArrayFromCertPEM=function(e){e=ga.pemToHex(e);return ga.getPublicKeyHexArrayFromCertHex(e)};
ga.hex2dn=function(e){for(var k="",h=I.getPosArrayOfChildren_AtObj(e,0),d=0;d<h.length;d++)var r=I.getHexOfTLV_AtObj(e,h[d]),k=k+"/"+ga.hex2rdn(r);return k};ga.hex2rdn=function(e){var k=I.getDecendantHexTLVByNthList(e,0,[0,0]),h=I.getDecendantHexVByNthList(e,0,[0,1]);e="";try{e=ga.DN_ATTRHEX[k]}catch(d){e=k}h=h.replace(/(..)/g,"%$1");k=decodeURIComponent(h);return e+"="+k};ga.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"};
ga.getPublicKeyFromCertPEM=function(e){var k=ga.getPublicKeyInfoPropOfCertPEM(e);if("2a864886f70d010101"==k.algoid){var h=KEYUTIL.parsePublicRawRSAKeyHex(k.keyhex);e=new C;e.setPublic(h.n,h.e);return e}if("2a8648ce3d0201"==k.algoid)return e=new N.crypto.ECDSA({curve:N.crypto.OID.oidhex2name[k.algparam],info:k.keyhex}),e.setPublicKeyHex(k.keyhex),e;if("2a8648ce380401"==k.algoid){var h=I.getVbyList(k.algparam,0,[0],"02"),d=I.getVbyList(k.algparam,0,[1],"02"),r=I.getVbyList(k.algparam,0,[2],"02"),k=
I.getHexOfV_AtObj(k.keyhex,0),k=k.substr(2);e=new N.crypto.DSA;e.setPublic(new B(h,16),new B(d,16),new B(r,16),new B(k,16));return e}throw"unsupported key";};ga.getPublicKeyInfoPropOfCertPEM=function(e){var k={algparam:null};e=ga.pemToHex(e);var h=I.getPosArrayOfChildren_AtObj(e,0);if(3!=h.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(h[0],2))throw"malformed X.509 certificate PEM (code:002)";h=I.getPosArrayOfChildren_AtObj(e,h[0]);if(7>h.length)throw"malformed X.509 certificate PEM (code:003)";
h=I.getPosArrayOfChildren_AtObj(e,h[6]);if(2!=h.length)throw"malformed X.509 certificate PEM (code:004)";var d=I.getPosArrayOfChildren_AtObj(e,h[0]);if(2!=d.length)throw"malformed X.509 certificate PEM (code:005)";k.algoid=I.getHexOfV_AtObj(e,d[0]);"06"==e.substr(d[1],2)?k.algparam=I.getHexOfV_AtObj(e,d[1]):"30"==e.substr(d[1],2)&&(k.algparam=I.getHexOfTLV_AtObj(e,d[1]));if("03"!=e.substr(h[1],2))throw"malformed X.509 certificate PEM (code:006)";e=I.getHexOfV_AtObj(e,h[1]);k.keyhex=e.substr(2);return k};
ga.getPublicKeyInfoPosOfCertHEX=function(e){var k=I.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:002)";e=I.getPosArrayOfChildren_AtObj(e,k[0]);if(7>e.length)throw"malformed X.509 certificate PEM (code:003)";return e[6]};ga.getV3ExtInfoListOfCertHex=function(e){var k=I.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],
2))throw"malformed X.509 certificate PEM (code:002)";k=I.getPosArrayOfChildren_AtObj(e,k[0]);if(8>k.length)throw"malformed X.509 certificate PEM (code:003)";if("a3"!=e.substr(k[7],2))throw"malformed X.509 certificate PEM (code:004)";k=I.getPosArrayOfChildren_AtObj(e,k[7]);if(1!=k.length)throw"malformed X.509 certificate PEM (code:005)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:006)";for(var k=I.getPosArrayOfChildren_AtObj(e,k[0]),h=k.length,d=Array(h),r=0;r<h;r++)d[r]=
ga.getV3ExtItemInfo_AtObj(e,k[r]);return d};ga.getV3ExtItemInfo_AtObj=function(e,k){var h={};h.posTLV=k;var d=I.getPosArrayOfChildren_AtObj(e,k);if(2!=d.length&&3!=d.length)throw"malformed X.509v3 Ext (code:001)";if("06"!=e.substr(d[0],2))throw"malformed X.509v3 Ext (code:002)";var r=I.getHexOfV_AtObj(e,d[0]);h.oid=I.hextooidstr(r);h.critical=!1;3==d.length&&(h.critical=!0);d=d[d.length-1];if("04"!=e.substr(d,2))throw"malformed X.509v3 Ext (code:003)";h.posV=I.getStartPosOfV_AtObj(e,d);return h};
ga.getHexOfTLV_V3ExtValue=function(e,k){var h=ga.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":I.getHexOfTLV_AtObj(e,h)};ga.getHexOfV_V3ExtValue=function(e,k){var h=ga.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":I.getHexOfV_AtObj(e,h)};ga.getPosOfTLV_V3ExtValue=function(e,k){var h=k;k.match(/^[0-9.]+$/)||(h=N.asn1.x509.OID.name2oid(k));if(""==h)return-1;for(var d=ga.getV3ExtInfoListOfCertHex(e),r=0;r<d.length;r++){var n=d[r];if(n.oid==h)return n.posV}return-1};ga.KEYUSAGE_NAME="digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign encipherOnly decipherOnly".split(" ");
ga.getExtKeyUsageBin=function(e){var k=ga.getHexOfV_V3ExtValue(e,"keyUsage");if(""==k)return"";if(0!=k.length%2||2>=k.length)throw"malformed key usage value";e=parseInt(k.substr(0,2));k=parseInt(k.substr(2),16).toString(2);return k.substr(0,k.length-e)};ga.getExtKeyUsageString=function(e){e=ga.getExtKeyUsageBin(e);for(var k=[],h=0;h<e.length;h++)"1"==e.substr(h,1)&&k.push(ga.KEYUSAGE_NAME[h]);return k.join(",")};ga.getExtAIAInfo=function(e){var k={ocsp:[],caissuer:[]},h=ga.getPosOfTLV_V3ExtValue(e,
"authorityInfoAccess");if(-1==h)return null;if("30"!=e.substr(h,2))throw"malformed AIA Extn Value";for(var h=I.getPosArrayOfChildren_AtObj(e,h),d=0;d<h.length;d++){var r=I.getPosArrayOfChildren_AtObj(e,h[d]);if(2!=r.length)throw"malformed AccessDescription of AIA Extn";var n=r[0],r=r[1];"2b06010505073001"==I.getHexOfV_AtObj(e,n)&&"86"==e.substr(r,2)&&k.ocsp.push(hextoutf8(I.getHexOfV_AtObj(e,r)));"2b06010505073002"==I.getHexOfV_AtObj(e,n)&&"86"==e.substr(r,2)&&k.caissuer.push(hextoutf8(I.getHexOfV_AtObj(e,
r)))}return k};s.X509=ga;var Ac,B=function(e,k,h){null!=e&&("number"==typeof e?this.fromNumber(e,k,h):null==k&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,k))};"Microsoft Internet Explorer"==navigator.appName?(B.prototype.am=we,Ac=30):"Netscape"!=navigator.appName?(B.prototype.am=Ob,Ac=26):(B.prototype.am=ee,Ac=28);B.prototype.DB=Ac;B.prototype.DM=(1<<Ac)-1;B.prototype.DV=1<<Ac;B.prototype.FV=Math.pow(2,52);B.prototype.F1=52-Ac;B.prototype.F2=2*Ac-52;var Zb="0123456789abcdefghijklmnopqrstuvwxyz",
xe=[],Nc,ac;Nc=48;for(ac=0;9>=ac;++ac)xe[Nc++]=ac;Nc=97;for(ac=10;36>ac;++ac)xe[Nc++]=ac;Nc=65;for(ac=10;36>ac;++ac)xe[Nc++]=ac;yc.prototype.convert=function(e){return 0>e.s||0<=e.compareTo(this.m)?e.mod(this.m):e};yc.prototype.revert=function(e){return e};yc.prototype.reduce=function(e){e.divRemTo(this.m,null,e)};yc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};yc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};Sa.prototype.convert=function(e){var k=ka();e.abs().dlShiftTo(this.m.t,
k);k.divRemTo(this.m,null,k);0>e.s&&0<k.compareTo(B.ZERO)&&this.m.subTo(k,k);return k};Sa.prototype.revert=function(e){var k=ka();e.copyTo(k);this.reduce(k);return k};Sa.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var k=0;k<this.m.t;++k){var h=e[k]&32767,d=h*this.mpl+((h*this.mph+(e[k]>>15)*this.mpl&this.um)<<15)&e.DM,h=k+this.m.t;for(e[h]+=this.m.am(0,d,e,k,0,this.m.t);e[h]>=e.DV;)e[h]-=e.DV,e[++h]++}e.clamp();e.drShiftTo(this.m.t,e);0<=e.compareTo(this.m)&&e.subTo(this.m,e)};
Sa.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};Sa.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};B.prototype.copyTo=function(e){for(var k=this.t-1;0<=k;--k)e[k]=this[k];e.t=this.t;e.s=this.s};B.prototype.fromInt=function(e){this.t=1;this.s=0>e?-1:0;0<e?this[0]=e:-1>e?this[0]=e+this.DV:this.t=0};B.prototype.fromString=function(e,k){var h;if(16==k)h=4;else if(8==k)h=3;else if(256==k)h=8;else if(2==k)h=1;else if(32==k)h=5;else if(4==k)h=2;else{this.fromRadix(e,k);return}this.s=
this.t=0;for(var d=e.length,r=!1,n=0;0<=--d;){var a=8==h?e[d]&255:$c(e,d);0>a?"-"==e.charAt(d)&&(r=!0):(r=!1,0==n?this[this.t++]=a:n+h>this.DB?(this[this.t-1]|=(a&(1<<this.DB-n)-1)<<n,this[this.t++]=a>>this.DB-n):this[this.t-1]|=a<<n,n+=h,n>=this.DB&&(n-=this.DB))}8==h&&0!=(e[0]&128)&&(this.s=-1,0<n&&(this[this.t-1]|=(1<<this.DB-n)-1<<n));this.clamp();r&&B.ZERO.subTo(this,this)};B.prototype.clamp=function(){for(var e=this.s&this.DM;0<this.t&&this[this.t-1]==e;)--this.t};B.prototype.dlShiftTo=function(e,
k){var h;for(h=this.t-1;0<=h;--h)k[h+e]=this[h];for(h=e-1;0<=h;--h)k[h]=0;k.t=this.t+e;k.s=this.s};B.prototype.drShiftTo=function(e,k){for(var h=e;h<this.t;++h)k[h-e]=this[h];k.t=Math.max(this.t-e,0);k.s=this.s};B.prototype.lShiftTo=function(e,k){var h=e%this.DB,d=this.DB-h,r=(1<<d)-1,n=Math.floor(e/this.DB),a=this.s<<h&this.DM,b;for(b=this.t-1;0<=b;--b)k[b+n+1]=this[b]>>d|a,a=(this[b]&r)<<h;for(b=n-1;0<=b;--b)k[b]=0;k[n]=a;k.t=this.t+n+1;k.s=this.s;k.clamp()};B.prototype.rShiftTo=function(e,k){k.s=
this.s;var h=Math.floor(e/this.DB);if(h>=this.t)k.t=0;else{var d=e%this.DB,r=this.DB-d,n=(1<<d)-1;k[0]=this[h]>>d;for(var a=h+1;a<this.t;++a)k[a-h-1]|=(this[a]&n)<<r,k[a-h]=this[a]>>d;0<d&&(k[this.t-h-1]|=(this.s&n)<<r);k.t=this.t-h;k.clamp()}};B.prototype.subTo=function(e,k){for(var h=0,d=0,r=Math.min(e.t,this.t);h<r;)d+=this[h]-e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d-=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d-=e[h],k[h++]=d&this.DM,
d>>=this.DB;d-=e.s}k.s=0>d?-1:0;-1>d?k[h++]=this.DV+d:0<d&&(k[h++]=d);k.t=h;k.clamp()};B.prototype.multiplyTo=function(e,k){var h=this.abs(),d=e.abs(),r=h.t;for(k.t=r+d.t;0<=--r;)k[r]=0;for(r=0;r<d.t;++r)k[r+h.t]=h.am(0,d[r],k,r,0,h.t);k.s=0;k.clamp();this.s!=e.s&&B.ZERO.subTo(k,k)};B.prototype.squareTo=function(e){for(var k=this.abs(),h=e.t=2*k.t;0<=--h;)e[h]=0;for(h=0;h<k.t-1;++h){var d=k.am(h,k[h],e,2*h,0,1);(e[h+k.t]+=k.am(h+1,2*k[h],e,2*h+1,d,k.t-h-1))>=k.DV&&(e[h+k.t]-=k.DV,e[h+k.t+1]=1)}0<
e.t&&(e[e.t-1]+=k.am(h,k[h],e,2*h,0,1));e.s=0;e.clamp()};B.prototype.divRemTo=function(e,k,h){var d=e.abs();if(!(0>=d.t)){var r=this.abs();if(r.t<d.t)null!=k&&k.fromInt(0),null!=h&&this.copyTo(h);else{null==h&&(h=ka());var n=ka(),a=this.s;e=e.s;var b=this.DB-Id(d[d.t-1]);0<b?(d.lShiftTo(b,n),r.lShiftTo(b,h)):(d.copyTo(n),r.copyTo(h));d=n.t;r=n[d-1];if(0!=r){var c=r*(1<<this.F1)+(1<d?n[d-2]>>this.F2:0),g=this.FV/c,c=(1<<this.F1)/c,f=1<<this.F2,l=h.t,q=l-d,m=null==k?ka():k;n.dlShiftTo(q,m);0<=h.compareTo(m)&&
(h[h.t++]=1,h.subTo(m,h));B.ONE.dlShiftTo(d,m);for(m.subTo(n,n);n.t<d;)n[n.t++]=0;for(;0<=--q;){var t=h[--l]==r?this.DM:Math.floor(h[l]*g+(h[l-1]+f)*c);if((h[l]+=n.am(0,t,h,q,0,d))<t)for(n.dlShiftTo(q,m),h.subTo(m,h);h[l]<--t;)h.subTo(m,h)}null!=k&&(h.drShiftTo(d,k),a!=e&&B.ZERO.subTo(k,k));h.t=d;h.clamp();0<b&&h.rShiftTo(b,h);0>a&&B.ZERO.subTo(h,h)}}}};B.prototype.invDigit=function(){if(1>this.t)return 0;var e=this[0];if(0==(e&1))return 0;var k=e&3,k=k*(2-(e&15)*k)&15,k=k*(2-(e&255)*k)&255,k=k*(2-
((e&65535)*k&65535))&65535,k=k*(2-e*k%this.DV)%this.DV;return 0<k?this.DV-k:-k};B.prototype.isEven=function(){return 0==(0<this.t?this[0]&1:this.s)};B.prototype.exp=function(e,k){if(4294967295<e||1>e)return B.ONE;var h=ka(),d=ka(),r=k.convert(this),n=Id(e)-1;for(r.copyTo(h);0<=--n;)if(k.sqrTo(h,d),0<(e&1<<n))k.mulTo(d,r,h);else var a=h,h=d,d=a;return k.revert(h)};B.prototype.toString=function(e){if(0>this.s)return"-"+this.negate().toString(e);if(16==e)e=4;else if(8==e)e=3;else if(2==e)e=1;else if(32==
e)e=5;else if(4==e)e=2;else return this.toRadix(e);var k=(1<<e)-1,h,d=!1,r="",n=this.t,a=this.DB-n*this.DB%e;if(0<n--)for(a<this.DB&&0<(h=this[n]>>a)&&(d=!0,r=Zb.charAt(h));0<=n;)a<e?(h=(this[n]&(1<<a)-1)<<e-a,h|=this[--n]>>(a+=this.DB-e)):(h=this[n]>>(a-=e)&k,0>=a&&(a+=this.DB,--n)),0<h&&(d=!0),d&&(r+=Zb.charAt(h));return d?r:"0"};B.prototype.negate=function(){var e=ka();B.ZERO.subTo(this,e);return e};B.prototype.abs=function(){return 0>this.s?this.negate():this};B.prototype.compareTo=function(e){var k=
this.s-e.s;if(0!=k)return k;var h=this.t,k=h-e.t;if(0!=k)return 0>this.s?-k:k;for(;0<=--h;)if(0!=(k=this[h]-e[h]))return k;return 0};B.prototype.bitLength=function(){return 0>=this.t?0:this.DB*(this.t-1)+Id(this[this.t-1]^this.s&this.DM)};B.prototype.mod=function(e){var k=ka();this.abs().divRemTo(e,null,k);0>this.s&&0<k.compareTo(B.ZERO)&&e.subTo(k,k);return k};B.prototype.modPowInt=function(e,k){var h;h=256>e||k.isEven()?new yc(k):new Sa(k);return this.exp(e,h)};B.ZERO=Jc(0);B.ONE=Jc(1);bd.prototype.convert=
Jd;bd.prototype.revert=Jd;bd.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h)};bd.prototype.sqrTo=function(e,k){e.squareTo(k)};Kc.prototype.convert=function(e){if(0>e.s||e.t>2*this.m.t)return e.mod(this.m);if(0>e.compareTo(this.m))return e;var k=ka();e.copyTo(k);this.reduce(k);return k};Kc.prototype.revert=function(e){return e};Kc.prototype.reduce=function(e){e.drShiftTo(this.m.t-1,this.r2);e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp());this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);for(this.m.multiplyLowerTo(this.q3,
this.m.t+1,this.r2);0>e.compareTo(this.r2);)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);0<=e.compareTo(this.m);)e.subTo(this.m,e)};Kc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};Kc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};var wb=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,
313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],gf=67108864/wb[wb.length-1];B.prototype.chunkSize=function(e){return Math.floor(Math.LN2*
this.DB/Math.log(e))};B.prototype.toRadix=function(e){null==e&&(e=10);if(0==this.signum()||2>e||36<e)return"0";var k=this.chunkSize(e),k=Math.pow(e,k),h=Jc(k),d=ka(),r=ka(),n="";for(this.divRemTo(h,d,r);0<d.signum();)n=(k+r.intValue()).toString(e).substr(1)+n,d.divRemTo(h,d,r);return r.intValue().toString(e)+n};B.prototype.fromRadix=function(e,k){this.fromInt(0);null==k&&(k=10);for(var h=this.chunkSize(k),d=Math.pow(k,h),r=!1,n=0,a=0,b=0;b<e.length;++b){var c=$c(e,b);0>c?"-"==e.charAt(b)&&0==this.signum()&&
(r=!0):(a=k*a+c,++n>=h&&(this.dMultiply(d),this.dAddOffset(a,0),a=n=0))}0<n&&(this.dMultiply(Math.pow(k,n)),this.dAddOffset(a,0));r&&B.ZERO.subTo(this,this)};B.prototype.fromNumber=function(e,k,h){if("number"==typeof k)if(2>e)this.fromInt(1);else for(this.fromNumber(e,h),this.testBit(e-1)||this.bitwiseTo(B.ONE.shiftLeft(e-1),Vd,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(k);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(B.ONE.shiftLeft(e-1),this);else{h=[];var d=e&7;h.length=
(e>>3)+1;k.nextBytes(h);h[0]=0<d?h[0]&(1<<d)-1:0;this.fromString(h,256)}};B.prototype.bitwiseTo=function(e,k,h){var d,r,n=Math.min(e.t,this.t);for(d=0;d<n;++d)h[d]=k(this[d],e[d]);if(e.t<this.t){r=e.s&this.DM;for(d=n;d<this.t;++d)h[d]=k(this[d],r);h.t=this.t}else{r=this.s&this.DM;for(d=n;d<e.t;++d)h[d]=k(r,e[d]);h.t=e.t}h.s=k(this.s,e.s);h.clamp()};B.prototype.changeBit=function(e,k){var h=B.ONE.shiftLeft(e);this.bitwiseTo(h,k,h);return h};B.prototype.addTo=function(e,k){for(var h=0,d=0,r=Math.min(e.t,
this.t);h<r;)d+=this[h]+e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d+=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d+=e[h],k[h++]=d&this.DM,d>>=this.DB;d+=e.s}k.s=0>d?-1:0;0<d?k[h++]=d:-1>d&&(k[h++]=this.DV+d);k.t=h;k.clamp()};B.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t);++this.t;this.clamp()};B.prototype.dAddOffset=function(e,k){if(0!=e){for(;this.t<=k;)this[this.t++]=0;for(this[k]+=e;this[k]>=this.DV;)this[k]-=
this.DV,++k>=this.t&&(this[this.t++]=0),++this[k]}};B.prototype.multiplyLowerTo=function(e,k,h){var d=Math.min(this.t+e.t,k);h.s=0;for(h.t=d;0<d;)h[--d]=0;var r;for(r=h.t-this.t;d<r;++d)h[d+this.t]=this.am(0,e[d],h,d,0,this.t);for(r=Math.min(e.t,k);d<r;++d)this.am(0,e[d],h,d,0,k-d);h.clamp()};B.prototype.multiplyUpperTo=function(e,k,h){--k;var d=h.t=this.t+e.t-k;for(h.s=0;0<=--d;)h[d]=0;for(d=Math.max(k-this.t,0);d<e.t;++d)h[this.t+d-k]=this.am(k-d,e[d],h,0,0,this.t+d-k);h.clamp();h.drShiftTo(1,h)};
B.prototype.modInt=function(e){if(0>=e)return 0;var k=this.DV%e,h=0>this.s?e-1:0;if(0<this.t)if(0==k)h=this[0]%e;else for(var d=this.t-1;0<=d;--d)h=(k*h+this[d])%e;return h};B.prototype.millerRabin=function(e){var k=this.subtract(B.ONE),h=k.getLowestSetBit();if(0>=h)return!1;var d=k.shiftRight(h);e=e+1>>1;e>wb.length&&(e=wb.length);for(var r=ka(),n=0;n<e;++n){r.fromInt(wb[Math.floor(Math.random()*wb.length)]);var a=r.modPow(d,this);if(0!=a.compareTo(B.ONE)&&0!=a.compareTo(k)){for(var b=1;b++<h&&0!=
a.compareTo(k);)if(a=a.modPowInt(2,this),0==a.compareTo(B.ONE))return!1;if(0!=a.compareTo(k))return!1}}return!0};B.prototype.clone=function(){var e=ka();this.copyTo(e);return e};B.prototype.intValue=function(){if(0>this.s){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]};B.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24};B.prototype.shortValue=function(){return 0==
this.t?this.s:this[0]<<16>>16};B.prototype.signum=function(){return 0>this.s?-1:0>=this.t||1==this.t&&0>=this[0]?0:1};B.prototype.toByteArray=function(){var e=this.t,k=[];k[0]=this.s;var h=this.DB-e*this.DB%8,d,r=0;if(0<e--)for(h<this.DB&&(d=this[e]>>h)!=(this.s&this.DM)>>h&&(k[r++]=d|this.s<<this.DB-h);0<=e;)if(8>h?(d=(this[e]&(1<<h)-1)<<8-h,d|=this[--e]>>(h+=this.DB-8)):(d=this[e]>>(h-=8)&255,0>=h&&(h+=this.DB,--e)),0!=(d&128)&&(d|=-256),0==r&&(this.s&128)!=(d&128)&&++r,0<r||d!=this.s)k[r++]=d;
return k};B.prototype.equals=function(e){return 0==this.compareTo(e)};B.prototype.min=function(e){return 0>this.compareTo(e)?this:e};B.prototype.max=function(e){return 0<this.compareTo(e)?this:e};B.prototype.and=function(e){var k=ka();this.bitwiseTo(e,Le,k);return k};B.prototype.or=function(e){var k=ka();this.bitwiseTo(e,Vd,k);return k};B.prototype.xor=function(e){var k=ka();this.bitwiseTo(e,Wd,k);return k};B.prototype.andNot=function(e){var k=ka();this.bitwiseTo(e,ad,k);return k};B.prototype.not=
function(){for(var e=ka(),k=0;k<this.t;++k)e[k]=this.DM&~this[k];e.t=this.t;e.s=~this.s;return e};B.prototype.shiftLeft=function(e){var k=ka();0>e?this.rShiftTo(-e,k):this.lShiftTo(e,k);return k};B.prototype.shiftRight=function(e){var k=ka();0>e?this.lShiftTo(-e,k):this.rShiftTo(e,k);return k};B.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e]){var k=e*this.DB;e=this[e];if(0==e)e=-1;else{var h=0;0==(e&65535)&&(e>>=16,h+=16);0==(e&255)&&(e>>=8,h+=8);0==(e&15)&&(e>>=4,h+=
4);0==(e&3)&&(e>>=2,h+=2);0==(e&1)&&++h;e=h}return k+e}return 0>this.s?this.t*this.DB:-1};B.prototype.bitCount=function(){for(var e=0,k=this.s&this.DM,h=0;h<this.t;++h){for(var d=this[h]^k,r=0;0!=d;)d&=d-1,++r;e+=r}return e};B.prototype.testBit=function(e){var k=Math.floor(e/this.DB);return k>=this.t?0!=this.s:0!=(this[k]&1<<e%this.DB)};B.prototype.setBit=function(e){return this.changeBit(e,Vd)};B.prototype.clearBit=function(e){return this.changeBit(e,ad)};B.prototype.flipBit=function(e){return this.changeBit(e,
Wd)};B.prototype.add=function(e){var k=ka();this.addTo(e,k);return k};B.prototype.subtract=function(e){var k=ka();this.subTo(e,k);return k};B.prototype.multiply=function(e){var k=ka();this.multiplyTo(e,k);return k};B.prototype.divide=function(e){var k=ka();this.divRemTo(e,k,null);return k};B.prototype.remainder=function(e){var k=ka();this.divRemTo(e,null,k);return k};B.prototype.divideAndRemainder=function(e){var k=ka(),h=ka();this.divRemTo(e,k,h);return[k,h]};B.prototype.modPow=function(e,k){var h=
e.bitLength(),d,r=Jc(1),n;if(0>=h)return r;d=18>h?1:48>h?3:144>h?4:768>h?5:6;n=8>h?new yc(k):k.isEven()?new Kc(k):new Sa(k);var a=[],b=3,c=d-1,g=(1<<d)-1;a[1]=n.convert(this);if(1<d)for(h=ka(),n.sqrTo(a[1],h);b<=g;)a[b]=ka(),n.mulTo(h,a[b-2],a[b]),b+=2;for(var f=e.t-1,l,q=!0,m=ka(),h=Id(e[f])-1;0<=f;){h>=c?l=e[f]>>h-c&g:(l=(e[f]&(1<<h+1)-1)<<c-h,0<f&&(l|=e[f-1]>>this.DB+h-c));for(b=d;0==(l&1);)l>>=1,--b;0>(h-=b)&&(h+=this.DB,--f);if(q)a[l].copyTo(r),q=!1;else{for(;1<b;)n.sqrTo(r,m),n.sqrTo(m,r),b-=
2;0<b?n.sqrTo(r,m):(b=r,r=m,m=b);n.mulTo(m,a[l],r)}for(;0<=f&&0==(e[f]&1<<h);)n.sqrTo(r,m),b=r,r=m,m=b,0>--h&&(h=this.DB-1,--f)}return n.revert(r)};B.prototype.modInverse=function(e){var k=e.isEven();if(this.isEven()&&k||0==e.signum())return B.ZERO;for(var h=e.clone(),d=this.clone(),r=Jc(1),n=Jc(0),a=Jc(0),b=Jc(1);0!=h.signum();){for(;h.isEven();)h.rShiftTo(1,h),k?(r.isEven()&&n.isEven()||(r.addTo(this,r),n.subTo(e,n)),r.rShiftTo(1,r)):n.isEven()||n.subTo(e,n),n.rShiftTo(1,n);for(;d.isEven();)d.rShiftTo(1,
d),k?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(e,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(e,b),b.rShiftTo(1,b);0<=h.compareTo(d)?(h.subTo(d,h),k&&r.subTo(a,r),n.subTo(b,n)):(d.subTo(h,d),k&&a.subTo(r,a),b.subTo(n,b))}if(0!=d.compareTo(B.ONE))return B.ZERO;if(0<=b.compareTo(e))return b.subtract(e);if(0>b.signum())b.addTo(e,b);else return b;return 0>b.signum()?b.add(e):b};B.prototype.pow=function(e){return this.exp(e,new bd)};B.prototype.gcd=function(e){var k=0>this.s?this.negate():this.clone();
e=0>e.s?e.negate():e.clone();if(0>k.compareTo(e)){var h=k,k=e;e=h}var h=k.getLowestSetBit(),d=e.getLowestSetBit();if(0>d)return k;h<d&&(d=h);0<d&&(k.rShiftTo(d,k),e.rShiftTo(d,e));for(;0<k.signum();)0<(h=k.getLowestSetBit())&&k.rShiftTo(h,k),0<(h=e.getLowestSetBit())&&e.rShiftTo(h,e),0<=k.compareTo(e)?(k.subTo(e,k),k.rShiftTo(1,k)):(e.subTo(k,e),e.rShiftTo(1,e));0<d&&e.lShiftTo(d,e);return e};B.prototype.isProbablePrime=function(e){var k,h=this.abs();if(1==h.t&&h[0]<=wb[wb.length-1]){for(k=0;k<wb.length;++k)if(h[0]==
wb[k])return!0;return!1}if(h.isEven())return!1;for(k=1;k<wb.length;){for(var d=wb[k],r=k+1;r<wb.length&&d<gf;)d*=wb[r++];for(d=h.modInt(d);k<r;)if(0==d%wb[k++])return!1}return h.millerRabin(e)};B.prototype.square=function(){var e=ka();this.squareTo(e);return e};s.BigInteger=B;var I=a.ASN1HEX,N=a.KJUR,C=a.RSAKey,w=a.b64tohex,s=a=a||{};s.createHash=function(e){if("sha256"!=e)throw Error("createHash: unsupported algorithm.");e={};e.md=new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});e.update=
function(e){this.md.updateHex(e.toString("hex"))};e.digest=function(e){var h=this.md.digest();return"hex"==e?h:"base64"==e?(new f(h,"hex")).toString("base64"):new f(h,"hex")};return e};s.createHmac=function(e,k){if("sha256"!==e)throw Error("createHmac: unsupported algorithm.");var h={};h.md=new N.crypto.Mac({alg:"HmacSHA256",pass:{hex:k.toString("hex")}});h.update=function(d){this.md.updateHex(d.toString("hex"))};h.digest=function(d){var e=this.md.doFinal();return"hex"==d?e:"base64"==d?(new f(e,"hex")).toString("base64"):
new f(e,"hex")};return h};s.createSign=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");return{arr:[],update:function(e){this.arr.push(e)},sign:function(e){var h=new C;h.readPrivateKeyFromPEMString(e);e=new N.crypto.Signature({alg:"SHA256withRSA",prov:"cryptojs/jsrsa"});e.initSign(h);for(h=0;h<this.arr.length;++h)e.updateHex(this.arr[h].toString("hex"));return new f(e.sign(),"hex")}}};s.createVerify=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");
return{arr:[],update:function(e){this.arr.push(e)},verify:function(e,h){for(var d=e.split("\n"),r="",n=1;n<d.length-1;n++)r+=d[n];d=(new f(r,"base64")).toString("hex");r=I.getPosArrayOfChildren_AtObj(d,0);2!=r.length?r=-1:(r=r[1],"03"!=d.substring(r,r+2)?r=-1:(r=I.getStartPosOfV_AtObj(d,r),r="00"!=d.substring(r,r+2)?-1:r+2));n=I.getPosArrayOfChildren_AtObj(d,r);2!=n.length?r=null:(r=I.getHexOfV_AtObj(d,n[0]),d=I.getHexOfV_AtObj(d,n[1]),n=new C,n.setPublic(r,d),r=n);d=new N.crypto.Signature({alg:"SHA256withRSA",
prov:"cryptojs/jsrsa"});d.initVerifyByPublicKey(r);for(r=0;r<this.arr.length;r++)d.updateHex(this.arr[r].toString("hex"));r=h.toString("hex");return d.verify(r)}}};s.randomBytes=function(e){for(var k=new f(e),h=0;h<e;++h)k[h]=Math.floor(256*Math.random());return k};s.toByteArray=function(e){var k=[];w(e).replace(/(..)/g,function(e){k.push(parseInt(e,16))});return k};var dd={};(function(e){function k(e){e=e.charCodeAt(0);if(e===d)return 62;if(e===r)return 63;if(e<n)return-1;if(e<n+10)return e-n+52;
if(e<b+26)return e-b;if(e<a+26)return e-a+26}var h="undefined"!==typeof Uint8Array?Uint8Array:Array,d=43,r=47,n=48,a=97,b=65;e.toByteArray=function(d){function e(d){c[g++]=d}var r,n,a,b,c;if(0<d.length%4)throw Error("Invalid string. Length must be a multiple of 4");r=d.length;b="="===d.charAt(r-2)?2:"="===d.charAt(r-1)?1:0;c=new h(3*d.length/4-b);n=0<b?d.length-4:d.length;var g=0;for(r=0;r<n;r+=4)a=k(d.charAt(r))<<18|k(d.charAt(r+1))<<12|k(d.charAt(r+2))<<6|k(d.charAt(r+3)),e((a&16711680)>>16),e((a&
65280)>>8),e(a&255);2===b?(a=k(d.charAt(r))<<2|k(d.charAt(r+1))>>4,e(a&255)):1===b&&(a=k(d.charAt(r))<<10|k(d.charAt(r+1))<<4|k(d.charAt(r+2))>>2,e(a>>8&255),e(a&255));return c};e.fromByteArray=function(d){var e,h=d.length%3,k="",r,n;e=0;for(n=d.length-h;e<n;e+=3)r=(d[e]<<16)+(d[e+1]<<8)+d[e+2],r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>18&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>12&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>
6&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r&63),k+=r;switch(h){case 1:r=d[d.length-1];k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>2);k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r<<4&63);k+="==";break;case 2:r=(d[d.length-2]<<8)+d[d.length-1],k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>10),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>
4&63),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r<<2&63),k+="="}return k}})(dd);s.ieee={read:function(e,k,h,d,r){var n;n=8*r-d-1;var a=(1<<n)-1,b=a>>1,c=-7;r=h?r-1:0;var g=h?-1:1,f=e[k+r];r+=g;h=f&(1<<-c)-1;f>>=-c;for(c+=n;0<c;h=256*h+e[k+r],r+=g,c-=8);n=h&(1<<-c)-1;h>>=-c;for(c+=d;0<c;n=256*n+e[k+r],r+=g,c-=8);if(0===h)h=1-b;else{if(h===a)return n?NaN:Infinity*(f?-1:1);n+=Math.pow(2,d);h-=b}return(f?-1:1)*n*Math.pow(2,h-d)},write:function(e,k,h,d,r,n){var a,b=8*
n-r-1,c=(1<<b)-1,g=c>>1,f=23===r?Math.pow(2,-24)-Math.pow(2,-77):0;n=d?0:n-1;var l=d?1:-1,m=0>k||0===k&&0>1/k?1:0;k=Math.abs(k);isNaN(k)||Infinity===k?(k=isNaN(k)?1:0,d=c):(d=Math.floor(Math.log(k)/Math.LN2),1>k*(a=Math.pow(2,-d))&&(d--,a*=2),k=1<=d+g?k+f/a:k+f*Math.pow(2,1-g),2<=k*a&&(d++,a/=2),d+g>=c?(k=0,d=c):1<=d+g?(k=(k*a-1)*Math.pow(2,r),d+=g):(k=k*Math.pow(2,g-1)*Math.pow(2,r),d=0));for(;8<=r;e[h+n]=k&255,n+=l,k/=256,r-=8);d=d<<r|k;for(b+=r;0<b;e[h+n]=d&255,n+=l,d/=256,b-=8);e[h+n-l]|=128*
m}};var Na=a.ieee;s.Buffer=f;s.SlowBuffer=f;s.INSPECT_MAX_BYTES=50;f.poolSize=8192;f._useTypedArrays=function(){try{var e=new ArrayBuffer(0),k=new Uint8Array(e);k.foo=function(){return 42};return 42===k.foo()&&"function"===typeof k.subarray}catch(h){return!1}}();f.isEncoding=function(e){switch(String(e).toLowerCase()){case "hex":case "utf8":case "utf-8":case "ascii":case "binary":case "base64":case "raw":case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":return!0;default:return!1}};f.isBuffer=
function(e){return!(null===e||void 0===e||!e._isBuffer)};f.byteLength=function(e,k){var h;e=e.toString();switch(k||"utf8"){case "hex":h=e.length/2;break;case "utf8":case "utf-8":h=f.utf8ToBytes(e).length;break;case "ascii":case "binary":case "raw":h=e.length;break;case "base64":h=f.base64ToBytes(e).length;break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":h=2*e.length;break;default:throw Error("Unknown encoding");}return h};f.concat=function(e,k){f.assert(f.isArray(e),"Usage: Buffer.concat(list[, length])");
if(0===e.length)return new f(0);if(1===e.length)return e[0];var h;if(void 0===k)for(h=k=0;h<e.length;h++)k+=e[h].length;var d=new f(k),r=0;for(h=0;h<e.length;h++){var n=e[h];n.copy(d,r);r+=n.length}return d};f.compare=function(e,k){f.assert(f.isBuffer(e)&&f.isBuffer(k),"Arguments must be Buffers");for(var h=e.length,d=k.length,r=0,n=Math.min(h,d);r<n&&e[r]===k[r];r++);r!==n&&(h=e[r],d=k[r]);return h<d?-1:d<h?1:0};f.hexWrite=function(e,k,h,d){h=Number(h)||0;var r=e.length-h;d?(d=Number(d),d>r&&(d=
r)):d=r;r=k.length;f.assert(0===r%2,"Invalid hex string");d>r/2&&(d=r/2);for(r=0;r<d;r++){var n=parseInt(k.substr(2*r,2),16);f.assert(!isNaN(n),"Invalid hex string");e[h+r]=n}return r};f.utf8Write=function(e,k,h,d){return f.blitBuffer(f.utf8ToBytes(k),e,h,d)};f.asciiWrite=function(e,k,h,d){return f.blitBuffer(f.asciiToBytes(k),e,h,d)};f.binaryWrite=function(e,k,h,d){return f.asciiWrite(e,k,h,d)};f.base64Write=function(e,k,h,d){return f.blitBuffer(f.base64ToBytes(k),e,h,d)};f.utf16leWrite=function(e,
k,h,d){return f.blitBuffer(f.utf16leToBytes(k),e,h,d)};f.prototype.write=function(e,k,h,d){if(isFinite(k))isFinite(h)||(d=h,h=void 0);else{var r=d;d=k;k=h;h=r}k=Number(k)||0;r=this.length-k;h?(h=Number(h),h>r&&(h=r)):h=r;d=String(d||"utf8").toLowerCase();switch(d){case "hex":e=f.hexWrite(this,e,k,h);break;case "utf8":case "utf-8":e=f.utf8Write(this,e,k,h);break;case "ascii":e=f.asciiWrite(this,e,k,h);break;case "binary":e=f.binaryWrite(this,e,k,h);break;case "base64":e=f.base64Write(this,e,k,h);break;
case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=f.utf16leWrite(this,e,k,h);break;default:throw Error("Unknown encoding");}return e};f.prototype.toString=function(e,k,h){e=String(e||"utf8").toLowerCase();k=Number(k)||0;h=void 0===h?this.length:Number(h);if(h===k)return"";switch(e){case "hex":e=f.hexSlice(this,k,h);break;case "utf8":case "utf-8":e=f.utf8Slice(this,k,h);break;case "ascii":e=f.asciiSlice(this,k,h);break;case "binary":e=f.binarySlice(this,k,h);break;case "base64":e=f.base64Slice(this,
k,h);break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=this.slice(k,h);k="";for(h=0;h<e.length;h+=2)k+=String.fromCharCode(e[h]+256*e[h+1]);e=k;break;default:throw Error("Unknown encoding");}return e};f.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};f.prototype.equals=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");return 0===f.compare(this,e)};f.prototype.compare=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");
return f.compare(this,e)};f.prototype.copy=function(e,k,h,d){h||(h=0);d||0===d||(d=this.length);k||(k=0);if(d!==h&&0!==e.length&&0!==this.length)if(f.assert(d>=h,"sourceEnd < sourceStart"),f.assert(0<=k&&k<e.length,"targetStart out of bounds"),f.assert(0<=h&&h<this.length,"sourceStart out of bounds"),f.assert(0<=d&&d<=this.length,"sourceEnd out of bounds"),d>this.length&&(d=this.length),e.length-k<d-h&&(d=e.length-k+h),d-=h,100>d||!f._useTypedArrays)for(var r=0;r<d;r++)e[r+k]=this[r+h];else e._set(this.subarray(h,
h+d),k)};f.base64Slice=function(e,k,h){return 0===k&&h===e.length?dd.fromByteArray(e):dd.fromByteArray(e.slice(k,h))};f.utf8Slice=function(e,k,h){var d="",r="";for(h=Math.min(e.length,h);k<h;k++)127>=e[k]?(d+=f.decodeUtf8Char(r)+String.fromCharCode(e[k]),r=""):r+="%"+e[k].toString(16);return d+f.decodeUtf8Char(r)};f.asciiSlice=function(e,k,h){var d="";for(h=Math.min(e.length,h);k<h;k++)d+=String.fromCharCode(e[k]);return d};f.binarySlice=function(e,k,h){return f.asciiSlice(e,k,h)};f.hexSlice=function(e,
k,h){var d=e.length;if(!k||0>k)k=0;if(!h||0>h||h>d)h=d;for(d="";k<h;k++)d+=f.toHex(e[k]);return d};f.prototype.slice=function(e,k){var h=this.length;e=f.clamp(e,h,0);k=f.clamp(k,h,h);if(f._useTypedArrays)return f._augment(this.subarray(e,k));for(var h=k-e,d=new f(h,void 0,!0),r=0;r<h;r++)d[r]=this[r+e];return d};f.prototype.get=function(e){console.log(".get() is deprecated. Access using array indexes instead.");return this.readUInt8(e)};f.prototype.set=function(e,k){console.log(".set() is deprecated. Access using array indexes instead.");
return this.writeUInt8(e,k)};f.prototype.readUInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]};f.readUInt16=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d))return h?(h=e[k],k+1<d&&(h|=e[k+1]<<8)):(h=e[k]<<8,k+1<d&&
(h|=e[k+1])),h};f.prototype.readUInt16LE=function(e,k){return f.readUInt16(this,e,!0,k)};f.prototype.readUInt16BE=function(e,k){return f.readUInt16(this,e,!1,k)};f.readUInt32=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d)){var r;h?(k+2<d&&(r=e[k+2]<<16),k+1<d&&(r|=e[k+1]<<8),r|=e[k],k+3<d&&(r+=e[k+3]<<24>>>0)):(k+1<d&&(r=e[k+1]<<16),
k+2<d&&(r|=e[k+2]<<8),k+3<d&&(r|=e[k+3]),r+=e[k]<<24>>>0);return r}};f.prototype.readUInt32LE=function(e,k){return f.readUInt32(this,e,!0,k)};f.prototype.readUInt32BE=function(e,k){return f.readUInt32(this,e,!1,k)};f.prototype.readInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]&128?-1*(255-this[e]+1):this[e]};f.readInt16=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),
f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));if(!(k>=e.length))return e=f.readUInt16(e,k,h,!0),e&32768?-1*(65535-e+1):e};f.prototype.readInt16LE=function(e,k){return f.readInt16(this,e,!0,k)};f.prototype.readInt16BE=function(e,k){return f.readInt16(this,e,!1,k)};f.readInt32=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));
if(!(k>=e.length))return e=f.readUInt32(e,k,h,!0),e&2147483648?-1*(4294967295-e+1):e};f.prototype.readInt32LE=function(e,k){return f.readInt32(this,e,!0,k)};f.prototype.readInt32BE=function(e,k){return f.readInt32(this,e,!1,k)};f.readFloat=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));return Na.read(e,k,h,23,4)};f.prototype.readFloatLE=function(e,k){return f.readFloat(this,e,!0,k)};f.prototype.readFloatBE=
function(e,k){return f.readFloat(this,e,!1,k)};f.readDouble=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+7<e.length,"Trying to read beyond buffer length"));return Na.read(e,k,h,52,8)};f.prototype.readDoubleLE=function(e,k){return f.readDouble(this,e,!0,k)};f.prototype.readDoubleBE=function(e,k){return f.readDouble(this,e,!1,k)};f.prototype.writeUInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),
f.assert(k<this.length,"trying to write beyond buffer length"),f.verifuint(e,255));if(!(k>=this.length))return this[k]=e,k+1};f.writeUInt16=function(e,k,h,d,r){r||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"trying to write beyond buffer length"),f.verifuint(k,65535));var n=e.length;if(!(h>=n)){r=0;for(n=Math.min(n-h,2);r<n;r++)e[h+r]=(k&255<<8*(d?r:1-r))>>>8*(d?r:1-
r);return h+2}};f.prototype.writeUInt16LE=function(e,k,h){return f.writeUInt16(this,e,k,!0,h)};f.prototype.writeUInt16BE=function(e,k,h){return f.writeUInt16(this,e,k,!1,h)};f.writeUInt32=function(e,k,h,d,r){r||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"trying to write beyond buffer length"),f.verifuint(k,4294967295));var n=e.length;if(!(h>=n)){r=0;for(n=Math.min(n-
h,4);r<n;r++)e[h+r]=k>>>8*(d?r:3-r)&255;return h+4}};f.prototype.writeUInt32LE=function(e,k,h){return f.writeUInt32(this,e,k,!0,h)};f.prototype.writeUInt32BE=function(e,k,h){return f.writeUInt32(this,e,k,!1,h)};f.prototype.writeInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k<this.length,"Trying to write beyond buffer length"),f.verifsint(e,127,-128));if(!(k>=this.length))return 0<=e?this.writeUInt8(e,k,h):this.writeUInt8(255+
e+1,k,h),k+1};f.writeInt16=function(e,k,h,d,r){r||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"Trying to write beyond buffer length"),f.verifsint(k,32767,-32768));if(!(h>=e.length))return 0<=k?f.writeUInt16(e,k,h,d,r):f.writeUInt16(e,65535+k+1,h,d,r),h+2};f.prototype.writeInt16LE=function(e,k,h){return f.writeInt16(this,e,k,!0,h)};f.prototype.writeInt16BE=function(e,
k,h){return f.writeInt16(this,e,k,!1,h)};f.writeInt32=function(e,k,h,d,r){r||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifsint(k,2147483647,-2147483648));if(!(h>=e.length))return 0<=k?f.writeUInt32(e,k,h,d,r):f.writeUInt32(e,4294967295+k+1,h,d,r),h+4};f.prototype.writeInt32LE=function(e,k,h){return f.writeInt32(this,e,k,
!0,h)};f.prototype.writeInt32BE=function(e,k,h){return f.writeInt32(this,e,k,!1,h)};f.writeFloat=function(e,k,h,d,r){r||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,3.4028234663852886E38,-3.4028234663852886E38));if(!(h>=e.length))return Na.write(e,k,h,d,23,4),h+4};f.prototype.writeFloatLE=function(e,k,h){return f.writeFloat(this,
e,k,!0,h)};f.prototype.writeFloatBE=function(e,k,h){return f.writeFloat(this,e,k,!1,h)};f.writeDouble=function(e,k,h,d,r){r||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+7<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,1.7976931348623157E308,-1.7976931348623157E308));if(!(h>=e.length))return Na.write(e,k,h,d,52,8),h+8};f.prototype.writeDoubleLE=function(e,k,h){return f.writeDouble(this,
e,k,!0,h)};f.prototype.writeDoubleBE=function(e,k,h){return f.writeDouble(this,e,k,!1,h)};f.prototype.fill=function(e,k,h){e||(e=0);k||(k=0);h||(h=this.length);f.assert(h>=k,"end < start");if(h!==k&&0!==this.length){f.assert(0<=k&&k<this.length,"start out of bounds");f.assert(0<=h&&h<=this.length,"end out of bounds");if("number"===typeof e)for(;k<h;k++)this[k]=e;else{e=f.utf8ToBytes(e.toString());for(var d=e.length;k<h;k++)this[k]=e[k%d]}return this}};f.prototype.inspect=function(){for(var e=[],k=
this.length,h=0;h<k;h++)if(e[h]=f.toHex(this[h]),h===s.INSPECT_MAX_BYTES){e[h+1]="...";break}return"<Buffer "+e.join(" ")+">"};f.prototype.toArrayBuffer=function(){if("undefined"!==typeof Uint8Array){if(f._useTypedArrays)return(new f(this)).buffer;for(var e=new Uint8Array(this.length),k=0,h=e.length;k<h;k+=1)e[k]=this[k];return e.buffer}throw Error("Buffer.toArrayBuffer not supported in this browser");};var da=f.prototype;f._augment=function(e){e._isBuffer=!0;e._get=e.get;e._set=e.set;e.get=da.get;
e.set=da.set;e.write=da.write;e.toString=da.toString;e.toLocaleString=da.toString;e.toJSON=da.toJSON;e.equals=da.equals;e.compare=da.compare;e.copy=da.copy;e.slice=da.slice;e.readUInt8=da.readUInt8;e.readUInt16LE=da.readUInt16LE;e.readUInt16BE=da.readUInt16BE;e.readUInt32LE=da.readUInt32LE;e.readUInt32BE=da.readUInt32BE;e.readInt8=da.readInt8;e.readInt16LE=da.readInt16LE;e.readInt16BE=da.readInt16BE;e.readInt32LE=da.readInt32LE;e.readInt32BE=da.readInt32BE;e.readFloatLE=da.readFloatLE;e.readFloatBE=
da.readFloatBE;e.readDoubleLE=da.readDoubleLE;e.readDoubleBE=da.readDoubleBE;e.writeUInt8=da.writeUInt8;e.writeUInt16LE=da.writeUInt16LE;e.writeUInt16BE=da.writeUInt16BE;e.writeUInt32LE=da.writeUInt32LE;e.writeUInt32BE=da.writeUInt32BE;e.writeInt8=da.writeInt8;e.writeInt16LE=da.writeInt16LE;e.writeInt16BE=da.writeInt16BE;e.writeInt32LE=da.writeInt32LE;e.writeInt32BE=da.writeInt32BE;e.writeFloatLE=da.writeFloatLE;e.writeFloatBE=da.writeFloatBE;e.writeDoubleLE=da.writeDoubleLE;e.writeDoubleBE=da.writeDoubleBE;
e.fill=da.fill;e.inspect=da.inspect;e.toArrayBuffer=da.toArrayBuffer;return e};f.stringtrim=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")};f.clamp=function(e,k,h){if("number"!==typeof e)return h;e=~~e;if(e>=k)return k;if(0<=e)return e;e+=k;return 0<=e?e:0};f.coerce=function(e){e=~~Math.ceil(+e);return 0>e?0:e};f.isArray=function(e){return(Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)})(e)};f.isArrayish=function(e){return f.isArray(e)||f.isBuffer(e)||
e&&"object"===typeof e&&"number"===typeof e.length};f.toHex=function(e){return 16>e?"0"+e.toString(16):e.toString(16)};f.utf8ToBytes=function(e){for(var k=[],h=0;h<e.length;h++){var d=e.charCodeAt(h);if(127>=d)k.push(d);else{var r=h;55296<=d&&57343>=d&&h++;d=encodeURIComponent(e.slice(r,h+1)).substr(1).split("%");for(r=0;r<d.length;r++)k.push(parseInt(d[r],16))}}return k};f.asciiToBytes=function(e){for(var k=[],h=0;h<e.length;h++)k.push(e.charCodeAt(h)&255);return k};f.utf16leToBytes=function(e){for(var k,
h,d=[],r=0;r<e.length;r++)k=e.charCodeAt(r),h=k>>8,k%=256,d.push(k),d.push(h);return d};f.base64ToBytes=function(e){return dd.toByteArray(e)};f.blitBuffer=function(e,k,h,d){for(var r=0;r<d&&!(r+h>=k.length||r>=e.length);r++)k[r+h]=e[r];return r};f.decodeUtf8Char=function(e){try{return decodeURIComponent(e)}catch(k){return String.fromCharCode(65533)}};f.verifuint=function(e,k){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(0<=e,"specified a negative value for writing an unsigned value");
f.assert(e<=k,"value is larger than maximum value for type");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifsint=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(e<=k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifIEEE754=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");
f.assert(e<=k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value")};f.assert=function(e,k){if(!e)throw Error(k||"Failed assertion");};var Oc=function(){};s.Log=Oc;Oc.LOG=0;var ed=a.printStackTrace,P={};s.NdnCommon=P;P.MAX_NDN_PACKET_SIZE=8800;P.getErrorWithStackTrace=function(e){return e+"\n"+ed({e:e}).join("\n")};P.checkIndexedDb=function(e){try{var k=new Dexie("test-Dexie-support");k.version(1).stores({});k.open();setTimeout(function(){try{e(k.isOpen())}catch(d){e(!1)}},
200)}catch(h){e(!1)}};var P=a.NdnCommon,ud=function(e,k,h,d){d=d||{};this.face=e;this.callerOnData=k;this.callerOnTimeout=h;this.maxInterestLifetime=d.maxInterestLifetime||16E3};s.ExponentialReExpress=ud;ud.makeOnTimeout=function(e,k,h,d){var r=new ud(e,k,h,d);return function(d){r.onTimeout(d)}};ud.prototype.onTimeout=function(e){var k=e.getInterestLifetimeMilliseconds();if(null==k){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(h){console.log("Error in onTimeout: "+P.getErrorWithStackTrace(h))}}else if(k*=
2,k>this.maxInterestLifetime){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(d){console.log("Error in onTimeout: "+P.getErrorWithStackTrace(d))}}else{e=e.clone();e.setInterestLifetimeMilliseconds(k);var r=this;this.face.expressInterest(e,this.callerOnData,function(d){r.onTimeout(d)})}};var m=function k(h,d){null==d&&(d=!0);null==h?this.buffer=null:"object"===typeof h&&h instanceof k?this.buffer=h.buffer:"string"===typeof h?this.buffer=new f(h,"utf8"):d?this.buffer=new f(h):f.isBuffer(h)?
this.buffer=h:this.buffer=new f(h);this.length=null!=this.buffer?this.buffer.length:0};s.Blob=m;m.prototype.size=function(){return null!=this.buffer?this.buffer.length:0};m.prototype.buf=function(){return this.buffer};m.prototype.isNull=function(){return null==this.buffer};m.prototype.toHex=function(){return null==this.buffer?"":this.buffer.toString("hex")};m.prototype.toString=function(){return null==this.buffer?"":this.buffer.toString("utf8")};m.prototype.equals=function(k){if(this.isNull())return k.isNull();
if(k.isNull())return!1;if(this.buffer!==k.buffer){if(this.buffer.length!=k.buffer.length)return!1;for(var h=0;h<this.buffer.length;++h)if(this.buffer[h]!=k.buffer[h])return!1}return!0};var m=a.Blob,db=function h(d,r,n){m.call(this,d);null==this.buffer?this.signedPortionEndOffset=this.signedPortionBeginOffset=0:"object"===typeof d&&d instanceof h?(this.signedPortionBeginOffset=null==r?d.signedPortionBeginOffset:r,this.signedPortionEndOffset=null==n?d.signedPortionEndOffset:n):(this.signedPortionBeginOffset=
r||0,this.signedPortionEndOffset=n||0);this.signedBuffer=null==this.buffer?null:this.buffer.slice(this.signedPortionBeginOffset,this.signedPortionEndOffset)};db.prototype=new m;db.prototype.name="SignedBlob";s.SignedBlob=db;db.prototype.signedSize=function(){return null!=this.signedBuffer?this.signedBuffer.length:0};db.prototype.signedBuf=function(){return this.signedBuffer};db.prototype.getSignedPortionBeginOffset=function(){return this.signedPortionBeginOffset};db.prototype.getSignedPortionEndOffset=
function(){return this.signedPortionEndOffset};var gb=function(h){h||(h=16);this.array=new f(h)};s.DynamicBuffer=gb;gb.prototype.ensureLength=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;h>d&&(d=h);h=new f(d);this.array.copy(h);this.array=h}};gb.prototype.copy=function(h,d){this.ensureLength(h.length+d);f.isBuffer(h)?h.copy(this.array,d):(new f(h)).copy(this.array,d);return d+h.length};gb.prototype.ensureLengthFromBack=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;
h>d&&(d=h);h=new f(d);this.array.copy(h,h.length-this.array.length);this.array=h}};gb.prototype.copyFromBack=function(h,d){this.ensureLengthFromBack(d);f.isBuffer(h)?h.copy(this.array,this.array.length-d):(new f(h)).copy(this.array,this.array.length-d)};gb.prototype.slice=function(h,d){return void 0==d?this.array.slice(h):this.array.slice(h,d)};var qa=function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};s.ChangeCounter=qa;qa.prototype.get=function(){return this.target};qa.prototype.set=
function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};qa.prototype.checkChanged=function(){if(null==this.target)return!1;var h=this.target.getChangeCount();return this.changeCount!=h?(this.changeCount=h,!0):!1};var P=a.NdnCommon,b=function(h,d){this.value=h;this.isRejected=d};s.SyncPromise=b;b.prototype.then=function(h,d){if(this.isRejected)if(d)try{return d(this.value)}catch(r){return new b(r,!0)}else return this;else if(h)try{return h(this.value)}catch(n){return new b(n,!0)}else return this};
b.prototype.catch=function(h){return this.then(void 0,h)};b.resolve=function(h){return new b(h,!1)};b.reject=function(h){return new b(h,!0)};b.getValue=function(h){if(h instanceof b){if(h.isRejected)throw h.value;return h.value}throw Error("Cannot return immediately because promise is not a SyncPromise");};b.complete=function(h,d,r){var n;r?n=d:(r=d,n=null);if(h)r.then(function(d){try{h(d)}catch(r){console.log("Error in onComplete: "+P.getErrorWithStackTrace(r))}},function(d){if(n)try{n(d)}catch(h){console.log("Error in onError: "+
P.getErrorWithStackTrace(h))}else{if(r instanceof b)throw d;console.log("Uncaught exception from a Promise: "+P.getErrorWithStackTrace(d))}});else return b.getValue(r)};var M={};s.DataUtils=M;M.keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";M.stringtoBase64=function(h){var d="",r,n,a="",b,c,g="",f=0;do r=h.charCodeAt(f++),n=h.charCodeAt(f++),a=h.charCodeAt(f++),b=r>>2,r=(r&3)<<4|n>>4,c=(n&15)<<2|a>>6,g=a&63,isNaN(n)?c=g=64:isNaN(a)&&(g=64),d=d+M.keyStr.charAt(b)+M.keyStr.charAt(r)+
M.keyStr.charAt(c)+M.keyStr.charAt(g);while(f<h.length);return d};M.base64toString=function(h){var d="",r,a,b="",c,g="",f=0;/[^A-Za-z0-9\+\/\=]/g.exec(h)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.");h=h.replace(/[^A-Za-z0-9\+\/\=]/g,"");do r=M.keyStr.indexOf(h.charAt(f++)),a=M.keyStr.indexOf(h.charAt(f++)),c=M.keyStr.indexOf(h.charAt(f++)),g=M.keyStr.indexOf(h.charAt(f++)),r=r<<2|a>>4,a=(a&
15)<<4|c>>2,b=(c&3)<<6|g,d+=String.fromCharCode(r),64!=c&&(d+=String.fromCharCode(a)),64!=g&&(d+=String.fromCharCode(b));while(f<h.length);return d};M.toHex=function(h){return h.toString("hex")};M.stringToHex=function(h){for(var d="",r=0;r<h.length;++r)var a=h.charCodeAt(r),d=d+((16>a?"0":"")+a.toString(16));return d};M.toString=function(h){return h.toString("binary")};M.toNumbers=function(h){return new f(h,"hex")};M.hexToRawString=function(h){if("string"==typeof h){var d="";h.replace(/(..)/g,function(h){d+=
String.fromCharCode(parseInt(h,16))});return d}};M.toNumbersFromString=function(h){return new f(h,"binary")};M.toNumbersIfString=function(h){return"string"===typeof h?new f(h,"binary"):h};M.stringToUtf8Array=function(h){return new f(h,"utf8")};M.concatArrays=function(h){return f.concat(h)};M.decodeUtf8=function(h){for(var d="",r=0,a=0,b=0;r<h.length;)if(a=h.charCodeAt(r),128>a)d+=String.fromCharCode(a),r++;else if(191<a&&224>a)b=h.charCodeAt(r+1),d+=String.fromCharCode((a&31)<<6|b&63),r+=2;else var b=
h.charCodeAt(r+1),c=h.charCodeAt(r+2),d=d+String.fromCharCode((a&15)<<12|(b&63)<<6|c&63),r=r+3;return d};M.arraysEqual=function(h,d){if(!h.slice)throw Error("DataUtils.arraysEqual: a1 is not an array");if(!d.slice)throw Error("DataUtils.arraysEqual: a2 is not an array");if(h.length!=d.length)return!1;for(var r=0;r<h.length;++r)if(h[r]!=d[r])return!1;return!0};M.bigEndianToUnsignedInt=function(h){for(var d=0,r=0;r<h.length;++r)d*=256,d+=h[r];return d};M.nonNegativeIntToBigEndian=function(h){h=Math.round(h);
if(0>=h)return new f(0);for(var d=new f(8),r=0;0!=h;)++r,d[8-r]=h&255,h=Math.floor(h/256);return d.slice(8-r,8)};M.shuffle=function(h){for(var d=h.length-1;1<=d;--d){var r=Math.floor(Math.random()*(d+1)),a=h[d];h[d]=h[r];h[r]=a}};M.privateKeyPemToDer=function(h){h=h.split("\n");for(var d="",r=1;r<h.length-1;r++)d+=h[r];return new f(d,"base64")};T.prototype=Error();T.prototype.name="DecodingException";s.DecodingException=T;var q=function(){};s.Tlv=q;q.Interest=5;q.Data=6;q.Name=7;q.ImplicitSha256DigestComponent=
1;q.ParametersSha256DigestComponent=2;q.NameComponent=8;q.Selectors=9;q.Nonce=10;q.InterestLifetime=12;q.MinSuffixComponents=13;q.MaxSuffixComponents=14;q.PublisherPublicKeyLocator=15;q.Exclude=16;q.ChildSelector=17;q.MustBeFresh=18;q.Any=19;q.MetaInfo=20;q.Content=21;q.SignatureInfo=22;q.SignatureValue=23;q.ContentType=24;q.FreshnessPeriod=25;q.FinalBlockId=26;q.SignatureType=27;q.KeyLocator=28;q.KeyLocatorDigest=29;q.ForwardingHint=30;q.SelectedDelegation=32;q.CanBePrefix=33;q.HopLimit=34;q.ApplicationParameters=
36;q.SignatureType_DigestSha256=0;q.SignatureType_SignatureSha256WithRsa=1;q.SignatureType_SignatureSha256WithEcdsa=3;q.SignatureType_SignatureHmacWithSha256=4;q.ContentType_Default=0;q.ContentType_Link=1;q.ContentType_Key=2;q.NfdCommand_ControlResponse=101;q.NfdCommand_StatusCode=102;q.NfdCommand_StatusText=103;q.ControlParameters_ControlParameters=104;q.ControlParameters_FaceId=105;q.ControlParameters_Uri=114;q.ControlParameters_LocalUri=129;q.ControlParameters_LocalControlFeature=110;q.ControlParameters_Origin=
111;q.ControlParameters_Cost=106;q.ControlParameters_Capacity=131;q.ControlParameters_Count=132;q.ControlParameters_BaseCongestionMarkingInterval=135;q.ControlParameters_DefaultCongestionThreshold=136;q.ControlParameters_Mtu=137;q.ControlParameters_Flags=108;q.ControlParameters_Mask=112;q.ControlParameters_Strategy=107;q.ControlParameters_ExpirationPeriod=109;q.LpPacket_LpPacket=100;q.LpPacket_Fragment=80;q.LpPacket_Sequence=81;q.LpPacket_FragIndex=82;q.LpPacket_FragCount=83;q.LpPacket_Nack=800;q.LpPacket_NackReason=
801;q.LpPacket_NextHopFaceId=816;q.LpPacket_IncomingFaceId=817;q.LpPacket_CachePolicy=820;q.LpPacket_CachePolicyType=821;q.LpPacket_CongestionMark=832;q.LpPacket_IGNORE_MIN=800;q.LpPacket_IGNORE_MAX=959;q.Link_Preference=30;q.Link_Delegation=31;q.Encrypt_EncryptedContent=130;q.Encrypt_EncryptionAlgorithm=131;q.Encrypt_EncryptedPayload=132;q.Encrypt_InitialVector=133;q.Encrypt_EncryptedPayloadKey=134;q.SafeBag_SafeBag=128;q.SafeBag_EncryptedKeyBag=129;q.Encrypt_StartDate=134;q.Encrypt_EndDate=135;
q.Encrypt_IntervalStartHour=136;q.Encrypt_IntervalEndHour=137;q.Encrypt_NRepeats=138;q.Encrypt_RepeatUnit=139;q.Encrypt_RepetitiveInterval=140;q.Encrypt_WhiteIntervalList=141;q.Encrypt_BlackIntervalList=142;q.Encrypt_Schedule=143;q.ValidityPeriod_ValidityPeriod=253;q.ValidityPeriod_NotBefore=254;q.ValidityPeriod_NotAfter=255;q.getHighBytes=function(h){return(h-h%4294967296)/4294967296};var gb=a.DynamicBuffer,q=a.Tlv,sa=function(h){this.output=new gb(h||16);this.length=0};s.TlvEncoder=sa;sa.prototype.getLength=
function(){return this.length};sa.prototype.writeVarNumber=function(h){if(253>h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=3;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length;this.output.array[d]=253;this.output.array[d+1]=h>>8&255;this.output.array[d+2]=h&255}else if(4294967295>=h)this.length+=5,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-
this.length,this.output.array[d]=254,this.output.array[d+1]=h>>24&255,this.output.array[d+2]=h>>16&255,this.output.array[d+3]=h>>8&255,this.output.array[d+4]=h&255;else{this.length+=9;this.output.ensureLengthFromBack(this.length);d=this.output.array.length-this.length;this.output.array[d]=255;var r=q.getHighBytes(h);this.output.array[d+1]=r>>24&255;this.output.array[d+2]=r>>16&255;this.output.array[d+3]=r>>8&255;this.output.array[d+4]=r&255;this.output.array[d+5]=h>>24&255;this.output.array[d+6]=
h>>16&255;this.output.array[d+7]=h>>8&255;this.output.array[d+8]=h&255}};sa.prototype.writeTypeAndLength=function(h,d){this.writeVarNumber(d);this.writeVarNumber(h)};sa.prototype.writeNonNegativeInteger=function(h){if(0>h)throw Error("TLV integer value may not be negative");h=Math.round(h);if(255>=h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=2;this.output.ensureLengthFromBack(this.length);
var d=this.output.array.length-this.length;this.output.array[d]=h>>8&255;this.output.array[d+1]=h&255}else if(4294967295>=h)this.length+=4,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-this.length,this.output.array[d]=h>>24&255,this.output.array[d+1]=h>>16&255,this.output.array[d+2]=h>>8&255,this.output.array[d+3]=h&255;else{this.length+=8;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length,r=q.getHighBytes(h);this.output.array[d]=r>>
24&255;this.output.array[d+1]=r>>16&255;this.output.array[d+2]=r>>8&255;this.output.array[d+3]=r&255;this.output.array[d+4]=h>>24&255;this.output.array[d+5]=h>>16&255;this.output.array[d+6]=h>>8&255;this.output.array[d+7]=h&255}};sa.prototype.writeNonNegativeIntegerTlv=function(h,d){var r=this.length;this.writeNonNegativeInteger(d);this.writeTypeAndLength(h,this.length-r)};sa.prototype.writeOptionalNonNegativeIntegerTlv=function(h,d){null!=d&&0<=d&&this.writeNonNegativeIntegerTlv(h,d)};sa.prototype.writeBuffer=
function(h){null!=h&&(this.length+=h.length,this.output.copyFromBack(h,this.length))};sa.prototype.writeBlobTlv=function(h,d){null==d?this.writeTypeAndLength(h,0):(this.writeBuffer(d),this.writeTypeAndLength(h,d.length))};sa.prototype.writeOptionalBlobTlv=function(h,d){null!=d&&0<d.length&&this.writeBlobTlv(h,d)};sa.prototype.getOutput=function(){return this.output.array.slice(this.output.array.length-this.length)};var T=a.DecodingException,pa=function(h){this.input=h;this.offset=0};s.TlvDecoder=
pa;pa.prototype.readVarNumber=function(){var h=this.input[this.offset];this.offset+=1;return 253>h?h:this.readExtendedVarNumber(h)};pa.prototype.readExtendedVarNumber=function(h){253==h?(h=(this.input[this.offset]<<8)+this.input[this.offset+1],this.offset+=2):254==h?(h=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3],this.offset+=4):(h=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+
2]<<8)+this.input[this.offset+3])+(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7],this.offset+=8);return h};pa.prototype.readTypeAndLength=function(h){if(this.readVarNumber()!=h)throw new T(Error("Did not get the expected TLV type"));h=this.readVarNumber();if(this.offset+h>this.input.length)throw new T(Error("TLV length exceeds the buffer length"));return h};pa.prototype.readNestedTlvsStart=function(h){return this.readTypeAndLength(h)+
this.offset};pa.prototype.finishNestedTlvs=function(h,d){if(this.offset!=h){for(void 0==d&&(d=!1);this.offset<h;){var r=this.readVarNumber();if((31>=r||1==(r&1))&&!d)throw new T(Error("Unrecognized critical type code "+r));r=this.readVarNumber();this.offset+=r;if(this.offset>this.input.length)throw new T(Error("TLV length exceeds the buffer length"));}if(this.offset!=h)throw new T(Error("TLV length does not equal the total length of the nested TLVs"));}};pa.prototype.peekType=function(h,d){if(this.offset>=
d)return!1;var r=this.offset,a=this.readVarNumber();this.offset=r;return a==h};pa.prototype.readNonNegativeInteger=function(h){var d;if(1==h)d=this.input[this.offset];else if(2==h)d=(this.input[this.offset]<<8)+this.input[this.offset+1];else if(4==h)d=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3];else if(8==h)d=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<
8)+this.input[this.offset+3])+Math.abs(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7];else throw new T(Error("Invalid length for a TLV nonNegativeInteger"));this.offset+=h;return d};pa.prototype.readNonNegativeIntegerTlv=function(h){h=this.readTypeAndLength(h);return this.readNonNegativeInteger(h)};pa.prototype.readOptionalNonNegativeIntegerTlv=function(h,d){return this.peekType(h,d)?this.readNonNegativeIntegerTlv(h):null};pa.prototype.readBlobTlv=
function(h){h=this.readTypeAndLength(h);var d=this.input.slice(this.offset,this.offset+h);this.offset+=h;return d};pa.prototype.readOptionalBlobTlv=function(h,d){return this.peekType(h,d)?this.readBlobTlv(h):null};pa.prototype.readBooleanTlv=function(h,d){if(this.peekType(h,d)){var r=this.readTypeAndLength(h);this.offset+=r;return!0}return!1};pa.prototype.skipTlv=function(h){h=this.readTypeAndLength(h);this.offset+=h};pa.prototype.skipOptionalTlv=function(h,d){this.peekType(h,d)&&this.skipTlv(h)};
pa.prototype.getOffset=function(){return this.offset};pa.prototype.seek=function(h){this.offset=h};pa.prototype.getSlice=function(h,d){return this.input.slice(h,d)};var pa=a.TlvDecoder,G=function d(){this.gotElementEnd_=!1;this.offset_=0;this.state_=d.READ_TYPE;this.headerLength_=0;this.useHeaderBuffer_=!1;this.headerBuffer_=new f(8);this.nBytesToRead_=0};s.TlvStructureDecoder=G;G.READ_TYPE=0;G.READ_TYPE_BYTES=1;G.READ_LENGTH=2;G.READ_LENGTH_BYTES=3;G.READ_VALUE_BYTES=4;G.prototype.findElementEnd=
function(d){if(this.gotElementEnd_)return!0;for(var r=new pa(d);;){if(this.offset_>=d.length)return!1;if(this.state_==G.READ_TYPE){var a=d[this.offset_];this.offset_+=1;253>a?this.state_=G.READ_LENGTH:(this.nBytesToRead_=253==a?2:254==a?4:8,this.state_=G.READ_TYPE_BYTES)}else if(this.state_==G.READ_TYPE_BYTES){a=d.length-this.offset_;if(a<this.nBytesToRead_)return this.offset_+=a,this.nBytesToRead_-=a,!1;this.offset_+=this.nBytesToRead_;this.state_=G.READ_LENGTH}else if(this.state_==G.READ_LENGTH)if(a=
d[this.offset_],this.offset_+=1,253>a){this.nBytesToRead_=a;if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=G.READ_VALUE_BYTES}else this.nBytesToRead_=253==a?2:254==a?4:8,this.firstOctet_=a,this.state_=G.READ_LENGTH_BYTES;else if(this.state_==G.READ_LENGTH_BYTES){a=d.length-this.offset_;if(!this.useHeaderBuffer_&&a>=this.nBytesToRead_)r.seek(this.offset_),this.nBytesToRead_=r.readExtendedVarNumber(this.firstOctet_),this.offset_=r.getOffset();else{this.useHeaderBuffer_=!0;var b=
this.nBytesToRead_-this.headerLength_;if(b>a){if(this.headerLength_+a>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");d.slice(this.offset_,this.offset_+a).copy(this.headerBuffer_,this.headerLength_);this.offset_+=a;this.headerLength_+=a;return!1}if(this.headerLength_+b>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");d.slice(this.offset_,this.offset_+b).copy(this.headerBuffer_,this.headerLength_);
this.offset_+=b;this.nBytesToRead_=(new pa(this.headerBuffer_)).readExtendedVarNumber(this.firstOctet_)}if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=G.READ_VALUE_BYTES}else{if(this.state_==G.READ_VALUE_BYTES){a=d.length-this.offset_;if(a<this.nBytesToRead_)return this.offset_+=a,this.nBytesToRead_-=a,!1;this.offset_+=this.nBytesToRead_;return this.gotElementEnd_=!0}throw Error("findElementEnd: unrecognized state");}}};G.prototype.getOffset=function(){return this.offset_};G.prototype.seek=
function(d){this.offset_=d};var sa=a.TlvEncoder,pa=a.TlvDecoder,m=a.Blob,c=a.Name,mb=function(){};s.ProtobufTlv=mb;mb._Field=null;mb.establishField=function(){if(null===mb._Field)try{mb._Field=dcodeIO.ProtoBuf.Reflect.Message.Field}catch(d){mb._Field=a.Reflect.Message.Field}};mb.encode=function(d,r){mb.establishField();d.encodeAB();var a=new sa;mb._encodeMessageValue(d,r,a);return new m(a.getOutput(),!1)};mb.decode=function(d,r,a){mb.establishField();a="object"===typeof a&&a instanceof m?a.buf():
a;var b=new pa(a);mb._decodeMessageValue(d,r,b,a.length)};mb._encodeMessageValue=function(d,a,n){a=a.getChildren(mb._Field);for(var b=a.length-1;0<=b;--b){var c=a[b],g=c.id,l;if(c.repeated)l=d[c.name];else if(null!=d[c.name])l=[d[c.name]];else continue;for(var q=l.length-1;0<=q;--q){var t=l[q];if("message"==c.type.name){var s=n.getLength();mb._encodeMessageValue(t,c.resolvedType,n);n.writeTypeAndLength(g,n.getLength()-s)}else if("uint32"==c.type.name||"uint64"==c.type.name)n.writeNonNegativeIntegerTlv(g,
t);else if("enum"==c.type.name){if(0>t)throw Error("ProtobufTlv.encode: ENUM value may not be negative");n.writeNonNegativeIntegerTlv(g,t)}else if("bytes"==c.type.name)s=t.toBuffer(),void 0==s.length&&(s=new Uint8Array(t.toArrayBuffer())),n.writeBlobTlv(g,s);else if("string"==c.type.name)n.writeBlobTlv(g,(new m(t,!1)).buf());else if("bool"==c.type.name)t&&n.writeTypeAndLength(g,0);else if("double"==c.type.name)s=new f(8),s.writeDoubleLE(t,0),n.writeBlobTlv(g,s);else throw Error("ProtobufTlv.encode: Unknown field type");
}}};mb._decodeMessageValue=function(d,a,n,b){a=a.getChildren(mb._Field);for(var c=0;c<a.length;++c){var g=a[c],f=g.id;if(g.required||n.peekType(f,b))if(g.repeated)for(;n.peekType(f,b);)if("message"==g.type.name){var l=n.readNestedTlvsStart(f),m=new (g.resolvedType.build());d.add(g.name,m);mb._decodeMessageValue(m,g.resolvedType,n,l);n.finishNestedTlvs(l)}else d.add(g.name,mb._decodeFieldValue(g,f,n,b));else"message"==g.type.name?(l=n.readNestedTlvsStart(f),m=new (g.resolvedType.build()),d.set(g.name,
m),mb._decodeMessageValue(m,g.resolvedType,n,l),n.finishNestedTlvs(l)):d.set(g.name,mb._decodeFieldValue(g,f,n,b))}};mb._decodeFieldValue=function(d,a,n,b){if("uint32"==d.type.name||"uint64"==d.type.name||"enum"==d.type.name)return n.readNonNegativeIntegerTlv(a);if("bytes"==d.type.name)return n.readBlobTlv(a);if("string"==d.type.name)return n.readBlobTlv(a).toString();if("bool"==d.type.name)return n.readBooleanTlv(a,b);if("double"==d.type.name)return n.readBlobTlv(a).readDoubleLE(0);throw Error("ProtobufTlv.decode: Unknown field type");
};mb.toName=function(d){for(var a=new c,n=0;n<d.length;++n)a.append(new m(new f(d[n].toBinary(),"binary"),!1));return a};var nb=function(d){if("string"===typeof d){d=d.split(".");this.oid=[];for(var a=0;a<d.length;++a)this.oid.push(parseInt(d[a]))}else this.oid=d.slice(0,d.length)};s.OID=nb;nb.prototype.getIntegerList=function(){return this.oid};nb.prototype.setIntegerList=function(d){this.oid=d.slice(0,d.length)};nb.prototype.toString=function(){for(var d="",a=0;a<this.oid.length;++a)0!==a&&(d+=
"."),d+=this.oid[a];return d};nb.prototype.equals=function(d){if(!(d instanceof nb)||this.oid.length!==d.oid.length)return!1;for(var a=0;a<this.oid.length;++a)if(this.oid[a]!=d.oid[a])return!1;return!0};var t=function(){};s.WireFormat=t;t.prototype.encodeName=function(d){throw Error("encodeName is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.decodeName=function(d,a,n){throw Error("decodeName is unimplemented in the base WireFormat class.  You should use a derived class.");
};t.prototype.encodeInterest=function(d){throw Error("encodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.decodeInterest=function(d,a,n){throw Error("decodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.encodeData=function(d){throw Error("encodeData is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.decodeData=function(d,a,n){throw Error("decodeData is unimplemented in the base WireFormat class.  You should use a derived class.");
};t.prototype.encodeControlParameters=function(d){throw Error("encodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.decodeControlParameters=function(d,a,n){throw Error("decodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.encodeControlResponse=function(d){throw Error("encodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");
};t.prototype.decodeControlResponse=function(d,a,n){throw Error("decodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.encodeSignatureInfo=function(d){throw Error("encodeSignatureInfo is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.decodeSignatureInfoAndValue=function(d,a,n){throw Error("decodeSignatureInfoAndValue is unimplemented in the base WireFormat class.  You should use a derived class.");
};t.prototype.encodeSignatureValue=function(d){throw Error("encodeSignatureValue is unimplemented in the base WireFormat class.  You should use a derived class.");};t.prototype.decodeLpPacket=function(d,a,n){throw Error("decodeLpPacket is unimplemented in the base WireFormat class. You should use a derived class.");};t.prototype.encodeDelegationSet=function(d){throw Error("encodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};t.prototype.decodeDelegationSet=
function(d,a,n){throw Error("decodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};t.prototype.encodeEncryptedContent=function(d){throw Error("encodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};t.prototype.decodeEncryptedContent=function(d,a,n){throw Error("decodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};t.prototype.encodeEncryptedContentV2=
function(d){throw Error("encodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};t.prototype.decodeEncryptedContentV2=function(d,a,n){throw Error("decodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};t.setDefaultWireFormat=function(d){t.defaultWireFormat=d};t.getDefaultWireFormat=function(){return t.defaultWireFormat};var hb=a.TlvWireFormat,M=a.DataUtils,q=a.Tlv,G=a.TlvStructureDecoder,T=a.DecodingException,
P=a.NdnCommon,g=a.Log.LOG,Xd=function(d){this.elementListener_=d;this.dataParts_=[];this.tlvStructureDecoder_=new G};s.ElementReader=Xd;Xd.prototype.onReceivedData=function(d){for(;;){var a,n;try{if(0===this.dataParts_.length&&0>=d.length)break;this.tlvStructureDecoder_.seek(0);a=this.tlvStructureDecoder_.findElementEnd(d);n=this.tlvStructureDecoder_.getOffset()}catch(b){throw this.dataParts_=[],this.tlvStructureDecoder_=new G,b;}if(a){var c;0===this.dataParts_.length?c=d.slice(0,n):(this.dataParts_.push(d.slice(0,
n)),c=M.concatArrays(this.dataParts_),this.dataParts_=[]);d=d.slice(n,d.length);this.tlvStructureDecoder_=new G;this.elementListener_.onReceivedElement(c);if(0==d.length)break}else{a=d.length;for(n=0;n<this.dataParts_.length;++n)a+=this.dataParts_[n].length;if(a>P.MAX_NDN_PACKET_SIZE)throw this.dataParts_=[],this.tlvStructureDecoder_=new G,new T(Error("The incoming packet exceeds the maximum limit Face.getMaxNdnPacketSize()"));this.dataParts_.push(new f(d));3<g&&console.log("Incomplete packet received. Length "+
d.length+". Wait for more input.");break}}};wa.prototype=Error();wa.prototype.name="DerDecodingException";s.DerDecodingException=wa;Pb.prototype=Error();Pb.prototype.name="DerEncodingException";s.DerEncodingException=Pb;var Q=function(){};s.DerNodeType=Q;Q.Eoc=0;Q.Boolean=1;Q.Integer=2;Q.BitString=3;Q.OctetString=4;Q.Null=5;Q.ObjectIdentifier=6;Q.ObjectDescriptor=7;Q.External=40;Q.Real=9;Q.Enumerated=10;Q.EmbeddedPdv=43;Q.Utf8String=12;Q.RelativeOid=13;Q.Sequence=48;Q.Set=49;Q.NumericString=18;Q.PrintableString=
19;Q.T61String=20;Q.VideoTexString=21;Q.Ia5String=22;Q.UtcTime=23;Q.GeneralizedTime=24;Q.GraphicString=25;Q.VisibleString=26;Q.GeneralString=27;Q.UniversalString=28;Q.CharacterString=29;Q.BmpString=30;var gb=a.DynamicBuffer,m=a.Blob,wa=a.DerDecodingException,Pb=a.DerEncodingException,Q=a.DerNodeType,l=function(d){this.nodeType_=d;this.parent_=null;this.header_=new f(0);this.payload_=new gb(0);this.payloadPosition_=0};s.DerNode=l;l.prototype.getSize=function(){return this.header_.length+this.payloadPosition_};
l.prototype.encodeHeader=function(d){var a=new gb(10),n=0;a.array[n++]=this.nodeType_;if(0>d)throw Error("encodeHeader: DER object has negative length");if(127>=d)a.array[n++]=d&255;else{var b=new gb(10),c=d;for(d=0;0!=c;)++d,b.ensureLengthFromBack(d),b.array[b.array.length-d]=c&255,c>>=8;c=d+1;b.ensureLengthFromBack(c);b.array[b.array.length-c]=(128|d)&255;a.copy(b.slice(b.array.length-c),n);n+=c}this.header_=a.slice(0,n)};l.prototype.decodeHeader=function(d,a){var n=a,b=d[n]&255,n=n+1;this.nodeType_=
b;var c=d[n]&255,n=n+1,g=new gb(10),f=0;g.array[f++]=b;b=g.array[f++]=c;if(0!=(c&128))for(c&=127,b=0;0<c;){if(d.length<=n)throw new wa("DerNode.decodeHeader: The input length is too small");var l=d[n],n=n+1;g.ensureLength(f+1);g.array[f++]=l;b=256*b+(l&255);c-=1}this.header_=g.slice(0,f);return b};l.prototype.encode=function(){var d=new f(this.getSize());this.header_.copy(d);this.payload_.slice(0,this.payloadPosition_).copy(d,this.header_.length);return new m(d,!1)};l.prototype.decode=function(d,
a){var n=a,b=this.decodeHeader(d,n),c=this.header_.length;0<b&&(n+=c,this.payloadAppend(d.slice(n,n+b)))};l.prototype.payloadAppend=function(d){this.payloadPosition_=this.payload_.copy(d,this.payloadPosition_)};l.parse=function(d,a){void 0==a&&(a=0);if(d.length<=a)throw new wa("DerNode.parse: The input length is too small");var n=d[a]&255;if(n===Q.Boolean)n=new l.DerBoolean;else if(n===Q.Integer)n=new l.DerInteger;else if(n===Q.BitString)n=new l.DerBitString;else if(n===Q.OctetString)n=new l.DerOctetString;
else if(n===Q.Null)n=new l.DerNull;else if(n===Q.ObjectIdentifier)n=new l.DerOid;else if(n===Q.Sequence)n=new l.DerSequence;else if(n===Q.PrintableString)n=new l.DerPrintableString;else if(n===Q.GeneralizedTime)n=new l.DerGeneralizedTime;else throw new wa(Error("Unimplemented DER type "+n));n.decode(d,a);return n};l.prototype.toVal=function(){return this.encode()};l.prototype.getPayload=function(){return new m(this.payload_.slice(0,this.payloadPosition_),!0)};l.prototype.getChildren=function(){throw new wa(Error("getChildren: This DerNode is not DerSequence"));
};l.getSequence=function(d,a){if(0>a||a>=d.length)throw new wa(Error("getSequence: Child index is out of bounds"));if(!(d[a]instanceof l.DerSequence))throw new wa(Error("getSequence: Child DerNode is not a DerSequence"));return d[a]};l.DerStructure=function(d){l.call(this,d);this.childChanged_=!1;this.nodeList_=[];this.size_=0};l.DerStructure.prototype=new l;l.DerStructure.prototype.name="DerStructure";l.DerStructure.prototype.getSize=function(){this.childChanged_&&(this.updateSize(),this.childChanged_=
!1);this.encodeHeader(this.size_);return this.size_+this.header_.length};l.DerStructure.prototype.getChildren=function(){return this.nodeList_};l.DerStructure.prototype.updateSize=function(){for(var d=0,a=0;a<this.nodeList_.length;++a)d+=this.nodeList_[a].getSize();this.size_=d;this.childChanged_=!1};l.DerStructure.prototype.addChild=function(d,a){d.parent_=this;this.nodeList_.push(d);a&&null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};l.DerStructure.prototype.setChildChanged=
function(){null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};l.DerStructure.prototype.encode=function(){var d=new gb(10),a=0;this.updateSize();this.encodeHeader(this.size_);for(var a=d.copy(this.header_,a),n=0;n<this.nodeList_.length;++n)var b=this.nodeList_[n].encode(),a=d.copy(b.buf(),a);return new m(d.slice(0,a),!1)};l.DerStructure.prototype.decode=function(d,a){var n=a;this.size_=this.decodeHeader(d,n);for(var n=n+this.header_.length,b=0;b<this.size_;){var c=l.parse(d,
n),g=c.getSize(),n=n+g,b=b+g;this.addChild(c,!1)}};l.DerByteString=function(d,a){l.call(this,a);null!=d&&(this.payloadAppend(d),this.encodeHeader(d.length))};l.DerByteString.prototype=new l;l.DerByteString.prototype.name="DerByteString";l.DerByteString.prototype.toVal=function(){return this.getPayload()};l.DerBoolean=function(d){l.call(this,Q.Boolean);void 0!=d&&(d=d?255:0,this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=d,this.encodeHeader(1))};l.DerBoolean.prototype=
new l;l.DerBoolean.prototype.name="DerBoolean";l.DerBoolean.prototype.toVal=function(){return 0!=this.payload_.array[0]};l.DerInteger=function(d){l.call(this,Q.Integer);if(void 0!=d){if(f.isBuffer(d)){if(0<d.length&&128<=d[0])throw new Pb(Error("DerInteger: Negative integers are not currently supported"));0==d.length?this.payloadAppend(new f([0])):this.payloadAppend(d)}else{d=Math.round(d);if(0>d)throw new Pb(Error("DerInteger: Negative integers are not currently supported"));for(var a=new gb(10),
n=0;!(++n,a.ensureLengthFromBack(n),a.array[a.array.length-n]=d&255,d>>=8,0>=d););128<=a.array[a.array.length-n]&&(++n,a.ensureLengthFromBack(n),a.array[a.array.length-n]=0);this.payloadAppend(a.slice(a.array.length-n))}this.encodeHeader(this.payloadPosition_)}};l.DerInteger.prototype=new l;l.DerInteger.prototype.name="DerInteger";l.DerInteger.prototype.toVal=function(){if(0<this.payloadPosition_&&128<=this.payload_.array[0])throw new wa(Error("DerInteger: Negative integers are not currently supported"));
for(var d=0,a=0;a<this.payloadPosition_;++a)d<<=8,d+=this.payload_.array[a];return d};l.DerBitString=function(d,a){l.call(this,Q.BitString);void 0!=d&&(this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=a&255,this.payloadAppend(d),this.encodeHeader(this.payloadPosition_))};l.DerBitString.prototype=new l;l.DerBitString.prototype.name="DerBitString";l.DerOctetString=function(d){l.DerByteString.call(this,d,Q.OctetString)};l.DerOctetString.prototype=new l.DerByteString;
l.DerOctetString.prototype.name="DerOctetString";l.DerNull=function(){l.call(this,Q.Null);this.encodeHeader(0)};l.DerNull.prototype=new l;l.DerNull.prototype.name="DerNull";l.DerOid=function(d){l.call(this,Q.ObjectIdentifier);if(void 0!=d)if("string"===typeof d){d=d.split(".");for(var a=[],n=0;n<d.length;++n)a.push(parseInt(d[n]));this.prepareEncoding(a)}else this.prepareEncoding(d.getIntegerList())};l.DerOid.prototype=new l;l.DerOid.prototype.name="DerOid";l.DerOid.prototype.prepareEncoding=function(d){var a;
if(0==d.length)throw new Pb(Error("No integer in OID"));if(0<=d[0]&&2>=d[0])a=40*d[0];else throw new Pb(Error("First integer in OID is out of range"));if(2<=d.length)if(0<=d[1]&&39>=d[1])a+=d[1];else throw new Pb(Error("Second integer in OID is out of range"));var n=new gb(10),b=0,b=n.copy(l.DerOid.encode128(a),b);if(2<d.length)for(a=2;a<d.length;++a)b=n.copy(l.DerOid.encode128(d[a]),b);this.encodeHeader(b);this.payloadAppend(n.slice(0,b))};l.DerOid.encode128=function(d){var a=new gb(10),n=0;if(128>
d)++n,a.array[a.array.length-n]=d&127;else for(++n,a.array[a.array.length-n]=d&127,d>>=7;0!=d;)++n,a.ensureLengthFromBack(n),a.array[a.array.length-n]=d&127|128,d>>=7;return a.slice(a.array.length-n)};l.DerOid.prototype.decode128=function(d,a){for(var n=0,b=d;0!=(this.payload_.array[d]&128);)n=128*n+(this.payload_.array[d]&255)-128,d+=1;n=128*n+(this.payload_.array[d]&255);a[0]=d-b+1;return n};l.DerOid.prototype.toVal=function(){for(var d=0,a=[];d<this.payloadPosition_;){var n=[0],b=this.decode128(d,
n),d=d+n[0];a.push(b)}d=a[0];d=Math.floor(d/40)+"."+d%40;for(n=1;n<a.length;++n)d+="."+a[n];return d};l.DerSequence=function(){l.DerStructure.call(this,Q.Sequence)};l.DerSequence.prototype=new l.DerStructure;l.DerSequence.prototype.name="DerSequence";l.DerPrintableString=function(d){l.DerByteString.call(this,d,Q.PrintableString)};l.DerPrintableString.prototype=new l.DerByteString;l.DerPrintableString.prototype.name="DerPrintableString";l.DerGeneralizedTime=function(d){l.call(this,Q.GeneralizedTime);
void 0!=d&&(d=l.DerGeneralizedTime.toDerTimeString(d),this.payloadAppend((new m(d)).buf()),this.encodeHeader(this.payloadPosition_))};l.DerGeneralizedTime.prototype=new l;l.DerGeneralizedTime.prototype.name="DerGeneralizedTime";l.DerGeneralizedTime.toDerTimeString=function(d){d=new Date(Math.round(d));return d.getUTCFullYear()+l.DerGeneralizedTime.to2DigitString(d.getUTCMonth()+1)+l.DerGeneralizedTime.to2DigitString(d.getUTCDate())+l.DerGeneralizedTime.to2DigitString(d.getUTCHours())+l.DerGeneralizedTime.to2DigitString(d.getUTCMinutes())+
l.DerGeneralizedTime.to2DigitString(d.getUTCSeconds())+"Z"};l.DerGeneralizedTime.to2DigitString=function(d){d=d.toString();return 1===d.length?"0"+d:d};l.DerGeneralizedTime.prototype.toVal=function(){var d=this.payload_.slice(0,this.payloadPosition_).toString();return Date.UTC(parseInt(d.substr(0,4)),parseInt(d.substr(4,2)-1),parseInt(d.substr(6,2)),parseInt(d.substr(8,2)),parseInt(d.substr(10,2)),parseInt(d.substr(12,2)))};var Rb=a,gc=function(d,a){this.subtrees=[];this.value=d;this.parent=a;this.lastChild=
null};gc.prototype.addSubtree=function(d,a){var n=this.find(d);null!==n?n.push(a):this.subtrees.push({key:d,value:[a]});a.parent=this;this.lastChild=a};gc.prototype.createSubtree=function(d,a){var n=new gc(a,this);this.addSubtree(d,n);return n};gc.prototype.get=function(d){d=d.replace(/^\/+/,"");if(0===d.length)return[this];var a=d.split("/");d=this.find(a[0]);if(null===d)return[];if(1==a.length)return d.slice(0);for(var a=a.slice(1).join("/"),n=[],b=0;b<d.length;++b)var c=d[b].get(a),n=n.concat(c);
return n};gc.prototype.getFirstValue=function(d){d=this.get(d);return 1<=d.length?d[0].value:null};gc.prototype.getValue=function(){return this.value};gc.prototype.getParent=function(){return this.parent};gc.prototype.getLastChild=function(){return this.lastChild};gc.prototype.prettyPrint=function(d){d=d||1;var a=Array(d+1).join(" "),n="";null!=this.parent&&(this.value&&0<this.value.length&&(n+='"'+this.value+'"'),n+="\n");if(0<this.subtrees.length){this.parent&&(n+=a+"{\n");for(var b=Array(d+2+1).join(" "),
c=0;c<this.subtrees.length;++c)for(var g=0;g<this.subtrees[c].value.length;++g)n+=b+this.subtrees[c].key+" "+this.subtrees[c].value[g].prettyPrint(d+2);this.parent&&(n+=a+"}\n")}return n};gc.prototype.toString=function(){return this.prettyPrint()};gc.prototype.find=function(d){for(var a=0;a<this.subtrees.length;++a)if(this.subtrees[a].key==d)return this.subtrees[a].value;return null};var lc=function(){this.root=new gc};s.BoostInfoParser=lc;s.BoostInfoTree=gc;lc.prototype.read=function(d,a){var n;
"string"==typeof a?n=d:(a=d,n=Rb.readFileSync(d).toString());var b=this.root,c=this;n.split(/\r?\n/).forEach(function(d){b=c.parseLine(d.trim(),b)})};lc.prototype.write=function(d){Rb.writeFileSync(d,""+this.root)};lc.prototype.getRoot=function(){return this.root};lc.shlex_split=function(d){var a=[];if(""==d)return a;for(var n=0;;){for(;0<=" \t\n\r".indexOf(d[n]);)if(n+=1,n>=d.length)return a;for(var b=n,c=!1,g="";;){if("\\"==d[b]){if(g+=d.substring(n,b),b=n=b+1,b>=d.length)break}else if(c)'"'==d[b]&&
(g+=d.substring(n,b),n=b+1,c=!1);else if('"'==d[b])g+=d.substring(n,b),n=b+1,c=!0;else if(0<=" \t\n\r".indexOf(d[b]))break;b+=1;if(b>=d.length)break}g+=d.substring(n,b);a.push(g);if(b>=d.length)return a;n=b}};lc.prototype.parseLine=function(d,a){var n=d.indexOf(";");0<=n&&(d=d.substring(0,n).trim());if(0==d.length)return a;for(var n=lc.shlex_split(d),b=!1,c=!1,g=0;g<n.length;++g)b=b||"{"==n[g],c=c||"}"==n[g];if(!b&&!c){var b=n[0],f;1<n.length&&(f=n[1]);a.createSubtree(b,f);return a}n=d.indexOf("{");
if(0<n)return f=d.substring(0,n),n=d.substring(n),f=this.parseLine(f,a),this.parseLine(n,f);if("{"==d[0])return a=a.getLastChild();if("}"==d[0])return a=a.getParent();throw runtime_error("BoostInfoParser: input line is malformed");};var c=a.Name,Bc=a.InterestFilter,xa=a.RegistrationOptions,t=a.WireFormat,g=a.Log.LOG,Ta=function(d,a){a=a||1E3;this.face=d;this.cleanupIntervalMilliseconds=a;this.nextCleanupTime=(new Date).getTime()+a;this.onDataNotFoundForPrefix={};this.interestFilterIdList=[];this.registeredPrefixIdList=
[];this.noStaleTimeCache=[];this.staleTimeCache=[];this.emptyComponent=new c.Component;this.pendingInterestTable=[];this.minimumCacheLifetime_=0;var n=this;this.storePendingInterestCallback=function(d,a,r,b,c){n.storePendingInterest(a,r)}};s.MemoryContentCache=Ta;Ta.prototype.registerPrefix=function(d,a,n,b,c,g){var f=n,l=b,m=c;n="object"===typeof f&&1===f.length&&"function"===typeof f[0]?f[0]:null;b="function"===typeof f?f:"function"===typeof l?l:null;c=f instanceof xa?f:l instanceof xa?l:m instanceof
xa?m:new xa;g=f instanceof t?f:l instanceof t?l:m instanceof t?m:g instanceof t?g:t.getDefaultWireFormat();b&&(this.onDataNotFoundForPrefix[d.toUri()]=b);d=this.face.registerPrefix(d,this.onInterest.bind(this),a,n,c,g);this.registeredPrefixIdList.push(d)};Ta.prototype.setInterestFilter=function(d,a){if(a){var n;n="object"===typeof d&&d instanceof Bc?d.getPrefix():d;this.onDataNotFoundForPrefix[n.toUri()]=a}n=this.face.setInterestFilter(d,this.onInterest.bind(this));this.interestFilterIdList.push(n)};
Ta.prototype.unregisterAll=function(){for(var d=0;d<this.interestFilterIdList.length;++d)this.face.unsetInterestFilter(this.interestFilterIdList[d]);this.interestFilterIdList=[];for(d=0;d<this.registeredPrefixIdList.length;++d)this.face.removeRegisteredPrefix(this.registeredPrefixIdList[d]);this.registeredPrefixIdList=[];this.onDataNotFoundForPrefix={}};Ta.prototype.add=function(d){var a=(new Date).getTime();this.doCleanup(a);if(null!=d.getMetaInfo().getFreshnessPeriod()&&0<=d.getMetaInfo().getFreshnessPeriod()){for(var n=
new Ta.StaleTimeContent(d,a,this.minimumCacheLifetime_),b=this.staleTimeCache.length-1;0<=b&&!(this.staleTimeCache[b].cacheRemovalTimeMilliseconds_<=n.cacheRemovalTimeMilliseconds_);)--b;this.staleTimeCache.splice(b+1,0,n)}else this.noStaleTimeCache.push(new Ta.Content(d));for(b=this.pendingInterestTable.length-1;0<=b;--b)if(this.pendingInterestTable[b].isTimedOut(a))this.pendingInterestTable.splice(b,1);else if(this.pendingInterestTable[b].getInterest().matchesName(d.getName())){try{3<g&&console.log("MemoryContentCache:  Reply w/ add Data "+
d.getName().toUri()),this.pendingInterestTable[b].getFace().send(d.wireEncode().buf())}catch(c){0<g&&console.log(""+c);break}this.pendingInterestTable.splice(b,1)}};Ta.prototype.storePendingInterest=function(d,a){this.pendingInterestTable.push(new Ta.PendingInterest(d,a))};Ta.prototype.getStorePendingInterest=function(){return this.storePendingInterestCallback};Ta.prototype.getMinimumCacheLifetime=function(){return this.minimumCacheLifetime_};Ta.prototype.setMinimumCacheLifetime=function(d){this.minimumCacheLifetime_=
d};Ta.prototype.onInterest=function(d,a,n,b,c){3<g&&console.log("MemoryContentCache:  Received Interest "+a.toUri());var f=(new Date).getTime();this.doCleanup(f);for(var l=null,m=null,q=this.staleTimeCache.length+this.noStaleTimeCache.length,t=0;t<q;++t){var s,x=!0;t<this.staleTimeCache.length?(s=this.staleTimeCache[t],x=s.isFresh(f)):s=this.noStaleTimeCache[t-this.staleTimeCache.length];if(a.matchesName(s.getName())&&(!a.getMustBeFresh()||x)){if(null==a.getChildSelector()){3<g&&console.log("MemoryContentCache:         Reply Data "+
s.getName().toUri());n.send(s.getDataEncoding());return}var x=s.getName().size()>a.getName().size()?s.getName().get(a.getName().size()):this.emptyComponent,G=!1;null===m?G=!0:0==a.getChildSelector()?0>x.compare(l)&&(G=!0):0<x.compare(l)&&(G=!0);G&&(l=x,m=s.getDataEncoding())}}null!==m?(3<g&&console.log("MemoryContentCache: Reply Data to Interest "+a.toUri()),n.send(m)):(3<g&&console.log("MemoryContentCache: onDataNotFound for "+a.toUri()),(f=this.onDataNotFoundForPrefix[d.toUri()])&&f(d,a,n,b,c))};
Ta.prototype.doCleanup=function(d){if(d>=this.nextCleanupTime){for(;0<this.staleTimeCache.length&&this.staleTimeCache[0].isPastRemovalTime(d);)this.staleTimeCache.shift();this.nextCleanupTime=d+this.cleanupIntervalMilliseconds}};Ta.Content=function(d){d&&(this.name=new c(d.getName()),this.dataEncoding=d.wireEncode().buf())};Ta.Content.prototype.getName=function(){return this.name};Ta.Content.prototype.getDataEncoding=function(){return this.dataEncoding};Ta.StaleTimeContent=function(d,a,n){Ta.Content.call(this,
d);this.cacheRemovalTimeMilliseconds_=a+Math.max(d.getMetaInfo().getFreshnessPeriod(),n);this.freshnessExpiryTimeMilliseconds_=a+d.getMetaInfo().getFreshnessPeriod()};Ta.StaleTimeContent.prototype=new Ta.Content;Ta.StaleTimeContent.prototype.name="StaleTimeContent";Ta.StaleTimeContent.prototype.isPastRemovalTime=function(d){return this.cacheRemovalTimeMilliseconds_<=d};Ta.StaleTimeContent.prototype.isFresh=function(d){return this.freshnessExpiryTimeMilliseconds_>d};Ta.PendingInterest=function(d,a){this.interest=
d;this.face=a;var n=this.interest.getInterestLifetimeMilliseconds();if(null==n||0>n)n=4E3;this.timeoutMilliseconds=(new Date).getTime()+n};Ta.PendingInterest.prototype.getInterest=function(){return this.interest};Ta.PendingInterest.prototype.getFace=function(){return this.face};Ta.PendingInterest.prototype.isTimedOut=function(d){return d>=this.timeoutTimeMilliseconds};var E=a.Interest,D=a.KeyChain,Ub=a.PipelineFixed,Pa=a.PipelineCubic,Ld=function(){};s.SegmentFetcher=Ld;Ld.ErrorCode={INTEREST_TIMEOUT:1,
DATA_HAS_NO_SEGMENT:2,SEGMENT_VERIFICATION_FAILED:3,INVALID_KEYCHAIN:4,INVALID_PIPELINE:5};Ld.DontVerifySegment=function(d){return!0};Ld.fetch=function(d,a,n,b,c,g){null==g||void 0===g.pipeline||"cubic"===g.pipeline?null==n||n instanceof D?(new Pa(a,d,null,n,b,c)).run():c(Ld.ErrorCode.INVALID_KEYCHAIN,"validatorKeyChain should be either a KeyChain instance or null."):"fixed"===g.pipeline?null==n||n instanceof D?(new Ub(a,d,g,n,b,c)).run():c(Ld.ErrorCode.INVALID_KEYCHAIN,"validatorKeyChain should be either a KeyChain instance or null."):
c(Ld.ErrorCode.INVALID_PIPELINE,g.pipeline+" is not a valid pipeline type")};var P=a.NdnCommon,ia=function(){};ia.ErrorCode={INTEREST_TIMEOUT:1,INTEREST_LIFETIME_EXPIRATION:2,DATA_HAS_NO_VERSION:3,DATA_HAS_NO_SEGMENT:4,SEGMENT_VERIFICATION_FAILED:5,NACK_RECEIVED:6,NO_FINALBLOCK:7,MAX_NACK_TIMEOUT_RETRIES:8};ia.op=function(d,a,n){return null!=n&&n.hasOwnProperty(d)?n[d]:a};ia.reportWarning=function(d,a){console.log("Warning "+d+" : "+a)};ia.reportError=function(d,a,n){try{d(a,n)}catch(b){console.log("Error in onError: "+
P.getErrorWithStackTrace(b))}};s.Pipeline=ia;var E=a.Interest,m=a.Blob,D=a.KeyChain,P=a.NdnCommon,fd=a.DataFetcher,ia=a.Pipeline,Ub=function(d,a,n,b,c,g){this.baseInterest=d;this.face=a;this.validatorKeyChain=b;this.onComplete=c;this.onError=g;this.segmentsOnFly=this.nextSegmentToRequest=this.numberOfSatisfiedSegments=0;this.finalBlockId=Number.MAX_SAFE_INTEGER;this.windowSize=ia.op("windowSize",10,n);this.maxTimeoutRetries=ia.op("maxTimeoutRetries",3,n);this.maxNackRetries=ia.op("maxNackRetries",
3,n);this.contentParts=[];this.dataFetchersContainer=[]};s.PipelineFixed=Ub;Ub.prototype.fetchSegment=function(d){if(d.getName().get(-1).isSegment()){var a=d.getName().get(-1).toSegment();this.dataFetchersContainer[a]=new fd(this.face,d,this.maxTimeoutRetries,this.maxNackRetries,this.onData.bind(this),this.onTimeout.bind(this),this.onNack.bind(this));this.dataFetchersContainer[a].fetch()}else(new fd(this.face,d,this.maxTimeoutRetries,this.maxNackRetries,this.onData.bind(this),this.onTimeout.bind(this),
this.onNack.bind(this))).fetch()};Ub.prototype.run=function(){var d=new E(this.baseInterest);d.setMustBeFresh(!0);this.fetchSegment(d)};Ub.prototype.fetchNextSegments=function(d,a){var n=new E(d);for(n.setMustBeFresh(!1);this.nextSegmentToRequest<=this.finalBlockId&&this.segmentsOnFly<=this.windowSize;)void 0!==this.contentParts[this.nextSegmentToRequest]?this.nextSegmentToRequest+=1:(n.setName(a.getPrefix(-1).appendSegment(this.nextSegmentToRequest)),n.refreshNonce(),this.fetchSegment(n),this.nextSegmentToRequest+=
1,this.increaseNumberOfSegmentsOnFly())};Ub.prototype.cancelPendingInterestsAboveFinalBlockId=function(){for(var d=this.dataFetchersContainer.length,a=this.finalBlockId+1;a<d;a++)null!==this.dataFetchersContainer[a]&&this.dataFetchersContainer[a].cancelPendingInterest()};Ub.prototype.onData=function(d,a){if(null!==this.validatorKeyChain)try{var n=this;this.validatorKeyChain.verifyData(a,function(a){n.onVerified(a,d)},this.onValidationFailed.bind(this))}catch(b){ia.reportError(this.onError,ia.ErrorCode.SEGMENT_VERIFICATION_FAILED,
"Error in KeyChain.verifyData: "+b)}else this.onVerified(a,d)};Ub.prototype.onVerified=function(d,a){var n=0;try{n=d.getName().get(-1).toSegment()}catch(b){ia.reportError(this.onError,ia.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the name segment number "+d.getName().get(-1).toEscapedString()+": "+b);return}if(0<d.getMetaInfo().getFinalBlockId().getValue().size())try{this.finalBlockId=d.getMetaInfo().getFinalBlockId().toSegment(),this.cancelPendingInterestsAboveFinalBlockId()}catch(c){ia.reportError(this.onError,
ia.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the FinalBlockId segment number "+d.getMetaInfo().getFinalBlockId().toEscapedString()+": "+c);return}this.numberOfSatisfiedSegments+=1;this.contentParts[n]=d.getContent().buf();if(this.numberOfSatisfiedSegments>this.finalBlockId){n=f.concat(this.contentParts);try{this.onComplete(new m(n,!1))}catch(g){console.log("Error in onComplete: "+P.getErrorWithStackTrace(g))}}else this.decreaseNumberOfSegmentsOnFly(),this.fetchNextSegments(a,d.getName())};Ub.prototype.onValidationFailed=
function(d,a){ia.reportError(this.onError,ia.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+d.getName().toUri()+" . Reason: "+a)};Ub.prototype.onTimeout=function(d){ia.reportError(this.onError,ia.ErrorCode.INTEREST_TIMEOUT,"Time out for interest "+d.getName().toUri())};Ub.prototype.onNack=function(d){ia.reportError(this.onError,ia.ErrorCode.NACK_RECEIVED,"Received Nack for interest "+d.getName().toUri())};Ub.prototype.increaseNumberOfSegmentsOnFly=function(){this.segmentsOnFly++};
Ub.prototype.decreaseNumberOfSegmentsOnFly=function(){this.segmentsOnFly=Math.max(this.segmentsOnFly-1,0)};Ub.prototype.reportError=function(d,a){try{this.onError(d,a)}catch(n){console.log("Error in onError: "+P.getErrorWithStackTrace(n))}};var E=a.Interest,c=a.Name,m=a.Blob,D=a.KeyChain,P=a.NdnCommon,Pc=a.RttEstimator,ia=a.Pipeline,g=a.Log.LOG,Pa=function(d,a,n,b,c,g){this.baseInterest=d;this.face=a;this.validatorKeyChain=b;this.onComplete=c;this.onError=g;this.versionNo=NaN;this.versionIsProvided=
!1;0<d.getName().components.length&&d.getName().get(-1).isVersion()&&(this.versionIsProvided=!0);this.initCwnd=ia.op("initCwnd",1,n);this.cwnd=p=ia.op("cwnd",this.initCwnd,n);this.ssthresh=ia.op("ssthresh",Number.MAX_VALUE,n);this.rtoCheckInterval=ia.op("rtoCheckInterval",10,n);this.disableCwa=ia.op("disableCwa",!1,n);this.maxRetriesOnTimeoutOrNack=ia.op("maxRetriesOnTimeoutOrNack",3,n);this.enableFastConv=ia.op("enableFastConv",!1,n);this.cubicBeta=ia.op("cubicBeta",0.7,n);this.wmax=ia.op("wmax",
0,n);this.lastWmax=ia.op("lastWmax",0,n);this.lastDecrease=Date.now();this.cubic_c=0.4;this.nSent=this.nRetransmitted=this.nSkippedRetx=this.nTimeouts=this.nLossDecr=this.nInFlight=this.recPoint=this.highInterest=this.highData=0;this.segmentInfo=[];this.retxQueue=[];this.retxCount=[];this.hasFinalBlockId=this.hasFailure=this.isStopped=!1;this.numberOfSatisfiedSegments=this.nextSegmentNo=this.failedSegNo=0;this.finalBlockId=Number.MAX_SAFE_INTEGER;this.rttEstimator=new Pc(n);this.contentParts=[]};
s.PipelineCubic=Pa;Pa.SegmentState={FirstTimeSent:1,InRetxQueue:2,Retransmitted:3};Pa.prototype.increaseWindow=function(){if(this.cwnd<this.ssthresh)this.cwnd+=1;else{this.wmax<this.initCwnd&&(this.wmax=this.cwnd);var d=(Date.now()-this.lastDecrease)/1E3,a=Math.cbrt(this.wmax*(1-this.cubicBeta)/this.cubic_c),d=this.cubic_c*Math.pow(d-a,3)+this.wmax,d=Math.max(d,0)-this.cwnd,d=Math.max(0,d);this.cwnd+=d/this.cwnd}};Pa.prototype.decreaseWindow=function(){this.enableFastConv&&this.cwnd<this.lastWmax?
(this.lastWmax=this.cwnd,this.wmax=this.cwnd*(1+this.cubicBeta)/2):this.wmax=this.lastWmax=this.cwnd;this.cwnd=this.ssthresh=Math.max(this.initCwnd,this.cwnd*this.cubicBeta);this.lastDecrease=Date.now()};Pa.prototype.run=function(){setTimeout(this.checkRto.bind(this),this.rtoCheckInterval);this.sendInterest(this.getNextSegmentNo(),!1)};Pa.prototype.cancel=function(){this.isStopped||(this.isStopped=!0,this.segmentInfo.length=0)};Pa.prototype.sendInterest=function(d,a){if(!(this.isStopped||this.hasFinalBlockId&&
d>this.finalBlockId||!a&&this.hasFailure)){if(a){if(void 0===this.retxCount[d])this.retxCount[d]=1;else if(this.retxCount[d]++,this.retxCount[d]>this.maxRetriesOnTimeoutOrNack)return this.handleFail(d,ia.ErrorCode.MAX_NACK_TIMEOUT_RETRIES,"Reached the maximum number of retries ("+this.maxRetriesOnTimeoutOrNack+") while retrieving segment #"+d);1<g&&console.log("Retransmitting segment #"+d+" ("+this.retxCount[d]+")")}1<g&&!a&&console.log("Requesting segment #"+d);var n=new E(this.baseInterest);Number.isNaN(this.versionNo)||
(!1===this.versionIsProvided?n.setName((new c(this.baseInterest.getName())).appendVersion(this.versionNo).appendSegment(d)):n.setName((new c(this.baseInterest.getName())).appendSegment(d)));0===d?n.setMustBeFresh(!0):n.setMustBeFresh(!1);var b={};b.pendingInterestId=this.face.expressInterest(n,this.handleData.bind(this),this.handleLifetimeExpiration.bind(this),this.handleNack.bind(this));b.timeSent=Date.now();b.rto=this.rttEstimator.getEstimatedRto();this.nInFlight++;this.nSent++;a?(b.state=Pa.SegmentState.Retransmitted,
this.nRetransmitted++):(this.highInterest=d,b.state=Pa.SegmentState.FirstTimeSent);this.segmentInfo[d]=b}};Pa.prototype.schedulePackets=function(){0>this.nInFlight&&console.log("ERROR: Number of in flight Interests is negative");for(var d=this.cwnd-this.nInFlight;0<d;){if(0!=this.retxQueue.length){var a=this.retxQueue.shift();if(void 0===this.segmentInfo[a]){this.nSkippedRetx++;continue}this.sendInterest(a,!0)}else this.sendInterest(this.getNextSegmentNo(),!1);d--}};Pa.prototype.handleData=function(d,
a){if(null!==this.validatorKeyChain)try{var n=this;this.validatorKeyChain.verifyData(a,function(a){n.onVerified(a,d)},this.onValidationFailed.bind(this))}catch(b){ia.reportError(this.onError,ia.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Error in KeyChain.verifyData: "+b)}else this.onData(a)};Pa.prototype.onData=function(d){if(!this.isStopped){var a=0;if(Number.isNaN(this.versionNo))try{this.versionNo=d.getName().get(-2).toVersion()}catch(n){this.handleFailure(a,ia.ErrorCode.DATA_HAS_NO_VERSION,"Error decoding the name version number "+
d.getName().get(-2).toEscapedString()+": "+n);return}try{a=d.getName().get(-1).toSegment()}catch(b){this.handleFailure(a,ia.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the name segment number "+d.getName().get(-1).toEscapedString()+": "+b);return}if(!this.hasFinalBlockId&&0<d.getMetaInfo().getFinalBlockId().getValue().size()){try{this.finalBlockId=d.getMetaInfo().getFinalBlockId().toSegment()}catch(c){this.handleFailure(a,ia.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the name segment number "+
d.getName().get(-1).toEscapedString()+": "+c);return}this.hasFinalBlockId=!0}this.contentParts[a]=d.getContent().buf();if(this.hasFailure&&this.hasFinalBlockId&&this.finalBlockId>=this.failedSegNo)return this.onFailure(this.failureReason);this.hasFailure=!1;var l=this.segmentInfo[a];if(void 0!==l)if(d=Date.now()-l.timeSent,1<g&&console.log("Received segment #"+a+", rtt="+d+"ms, rto="+l.rto+"ms"),this.highData<a&&(this.highData=a),l.state!==Pa.SegmentState.InRetxQueue&&this.nInFlight--,l.state!==Pa.SegmentState.FirstTimeSent&&
l.state!==Pa.SegmentState.InRetxQueue||void 0!==this.retxCount[a]||(l=Math.max(this.nInFlight+1>>1,1),0>=l&&console.log("ERROR: nExpectedSamples is less than or equal to ZERO"),this.rttEstimator.addMeasurement(a,d,l)),this.segmentInfo[a]=void 0,this.numberOfSatisfiedSegments++,this.hasFinalBlockId&&this.numberOfSatisfiedSegments>this.finalBlockId){a=f.concat(this.contentParts);this.cancelInFlightSegmentsGreaterThan(this.finalBlockId);try{this.cancel(),this.printSummary(),this.onComplete(new m(a,!1))}catch(q){console.log("Error in onComplete: "+
P.getErrorWithStackTrace(q))}}else this.increaseWindow(),this.schedulePackets()}};Pa.prototype.getNextSegmentNo=function(){return this.nextSegmentNo++};Pa.prototype.checkRto=function(){if(!this.isStopped){for(var d=!1,a=0;a<this.segmentInfo.length;++a)if(void 0!==this.segmentInfo[a]){var n=this.segmentInfo[a];n.state!==Pa.SegmentState.InRetxQueue&&Date.now()-n.timeSent>n.rto&&(this.nTimeouts++,d=!0,this.onWarning(ia.ErrorCode.INTEREST_TIMEOUT,"handle timeout for segment "+a),this.enqueueForRetransmission(a))}d&&
(this.recordTimeout(),this.schedulePackets());setTimeout(this.checkRto.bind(this),this.rtoCheckInterval)}};Pa.prototype.enqueueForRetransmission=function(d){0>=this.nInFlight&&console.log("ERROR: number of in-flight segments is less than or equal to ZERO");this.nInFlight--;this.retxQueue.push(d);this.segmentInfo[d].state=Pa.SegmentState.InRetxQueue};Pa.prototype.recordTimeout=function(){if(this.disableCwa||this.highData>this.recPoint)this.recPoint=this.highInterest,this.decreaseWindow(),this.rttEstimator.backoffRto(),
this.nLossDecr++,1<g&&console.log("Packet loss event, new cwnd = "+this.cwnd+", ssthresh = "+this.ssthresh)};Pa.prototype.cancelInFlightSegmentsGreaterThan=function(d){for(d+=1;d<this.segmentInfo.length;++d)void 0!==this.segmentInfo[d]&&this.face.removePendingInterest(this.segmentInfo[d].pendingInterestId),this.segmentInfo[d]=void 0,this.nInFlight--};Pa.prototype.handleFail=function(d,a,n){if(!this.isStopped){if(0===d||this.hasFinalBlockId&&d<=this.finalBlockId)return this.onFailure(a,n);if(!this.hasFinalBlockId){this.segmentInfo[d]=
void 0;this.nInFlight--;a=!0;for(i=0;i<this.segmentInfo.length;++i)if(void 0!==this.segmentInfo[i]){a=!1;break}if(a)this.onFailure(ia.ErrorCode.NO_FINALBLOCK,"Fetching terminated at segment "+d+" but no finalBlockId has been found");else this.cancelInFlightSegmentsGreaterThan(d),this.hasFailure=!0,this.failedSegNo=d,this.failureReason=n}}};Pa.prototype.handleLifetimeExpiration=function(d){if(!this.isStopped){this.nTimeouts++;var a=0;d.getName().get(-1).isSegment()&&(a=d.getName().get(-1).toSegment());
this.enqueueForRetransmission(a);this.onWarning(ia.ErrorCode.INTEREST_LIFETIME_EXPIRATION,"handle interest lifetime expiration for segment "+a);this.recordTimeout();this.schedulePackets()}};Pa.prototype.handleNack=function(d){if(!this.isStopped){var a=0;0<d.getName().components.length&&d.getName().get(-1).isSegment()&&(a=d.getName().get(-1).toSegment());this.enqueueForRetransmission(a);this.onWarning(ia.ErrorCode.NACK_RECEIVED,"handle nack for segment "+a);this.recordTimeout();this.schedulePackets()}};
Pa.prototype.onValidationFailed=function(d,a){ia.reportError(this.onError,ia.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+d.getName().toUri()+" . Reason: "+a)};Pa.prototype.onFailure=function(d,a){this.cancel();ia.reportError(this.onError,d,a)};Pa.prototype.onWarning=function(d,a){2<g&&ia.reportWarning(d,a)};Pa.prototype.printSummary=function(){if(!(3>g)){var d="",d=this.rttEstimator.getMinRtt()===Number.MAX_VALUE||this.rttEstimator.getMaxRtt()===Number.NEGATIVE_INFINITY?
"stats unavailable":"min/avg/max = "+this.rttEstimator.getMinRtt().toPrecision(3)+"/"+this.rttEstimator.getAvgRtt().toPrecision(3)+"/"+this.rttEstimator.getMaxRtt().toPrecision(3)+" ms";console.log("Timeouts: "+this.nTimeouts+" (caused "+this.nLossDecr+" window decreases)\nRetransmitted segments: "+this.nRetransmitted+" ("+(0==this.nSent?0:this.nRetransmitted/this.nSent*100)+"%), skipped: "+this.nSkippedRetx+"\nRTT "+d)}};ia=a.Pipeline;Pc=function(d){this.alpha=ia.op("alpha",0.125,d);this.beta=ia.op("beta",
0.25,d);this.k=ia.op("k",8,d);this.initialRto=ia.op("initialRto",1E3,d);this.minRto=ia.op("minRto",200,d);this.maxRto=ia.op("maxRto",2E4,d);this.rtoBackoffMultiplier=ia.op("rtoBackoffMultiplier",2,d);this.rttVar=this.sRtt=NaN;this.rto=this.initialRto;this.rttMin=Number.MAX_VALUE;this.rttMax=Number.NEGATIVE_INFINITY;this.nRttSamples=this.rttAvg=0};s.RttEstimator=Pc;Pc.prototype.clamp=function(d,a,n){if(a<d&&d<n)return d;if(d<a)return a;if(n<d)return n};Pc.prototype.addMeasurement=function(d,a,n){0>=
n&&console.log("ERROR: nExpectedSamples is less than or equal to ZERO");0===this.nRttSamples?(this.sRtt=a,this.rttVar=this.sRtt/2):(d=this.alpha/n,n=this.beta/n,this.rttVar=(1-n)*this.rttVar+n*Math.abs(this.sRtt-a),this.sRtt=(1-d)*this.sRtt+d*a);this.rto=this.sRtt+this.k*this.rttVar;this.rto=this.clamp(this.rto,this.minRto,this.maxRto);this.rttAvg=(this.nRttSamples*this.rttAvg+a)/(this.nRttSamples+1);this.rttMax=Math.max(a,this.rttMax);this.rttMin=Math.min(a,this.rttMin);this.nRttSamples++};Pc.prototype.backoffRto=
function(){this.rto=this.clamp(this.rto*this.rtobackoffmultiplier,this.minrto,this.maxrto)};Pc.prototype.getEstimatedRto=function(){return this.rto};Pc.prototype.getMinRtt=function(){return this.rttMin};Pc.prototype.getMaxRtt=function(){return this.rttMax};Pc.prototype.getAvgRtt=function(){return this.rttAvg};E=a.Interest;g=a.Log.LOG;fd=function(d,a,n,b,c,g,f){this.face=d;this.interest=a;this.maxNackRetries=b;this.maxTimeoutRetries=n;this.onData=c;this.onTimeout=g;this.onNack=f;this.numberOfTimeoutRetries=
0;this.pendingInterestId=null};s.DataFetcher=fd;fd.prototype.fetch=function(){this.pendingInterestId=this.face.expressInterest(this.interest,this.handleData.bind(this),this.handleTimeout.bind(this),this.handleNack.bind(this))};fd.prototype.cancelPendingInterest=function(){this.face.removePendingInterest(this.pendingInterestId)};fd.prototype.handleData=function(d,a){this.onData(d,a)};fd.prototype.handleTimeout=function(d){this.numberOfTimeoutRetries++;if(this.numberOfTimeoutRetries<=this.maxTimeoutRetries){var a=
new E(d);a.refreshNonce();this.interest=a;3<g&&console.log("handle timeout for interest "+d.getName());this.fetch()}else this.onTimeout(d)};fd.prototype.handleNack=function(d){this.numberOfNackRetries+=1;if(this.numberOfNackRetries<=this.maxNackRetries){var a=new E(d);a.refreshNonce();this.interest=a;3<g&&console.log("handle nack for interest "+d.getName());setTimeout(this.fetch.bind(this),40+20*Math.random())}else this.onNack(d)};var Qc=function(){this.backrefs_=[]};s.NdnRegexBackrefManager=Qc;Qc.prototype.pushRef=
function(d){last=this.backrefs_.length;this.backrefs_.push(d);return last};Qc.prototype.popRef=function(){this.backrefs_.pop()};Qc.prototype.size=function(){return this.backrefs_.length};Qc.prototype.getBackref=function(d){return this.backrefs_[d]};var Qc=a.NdnRegexBackrefManager,$=function(d,a,n){this.matchers_=[];this.matchResult_=[];this.expr_=d;this.type_=a;void 0==n&&(n=new Qc);this.backrefManager_=n};s.NdnRegexMatcherBase=$;$.Error=function(d){if(d)return d.__proto__=$.Error.prototype,d};$.Error.prototype=
Error();$.Error.prototype.name="NdnRegexMatcherBaseError";$.NdnRegexExprType={TOP:0,PATTERN_LIST:1,REPEAT_PATTERN:2,BACKREF:3,COMPONENT_SET:4,COMPONENT:5,PSEUDO:6};$.prototype.match=function(d,a,n){var b=!1;this.matchResult_=[];if(this.recursiveMatch_(0,d,a,n)){for(b=a;b<a+n;)this.matchResult_.push(d.get(b)),++b;b=!0}else b=!1;return b};$.prototype.getMatchResult=function(){return this.matchResult_};$.prototype.getExpr=function(){return this.expr_};$.prototype.compile_=function(){throw Error("NdnRegexMatcherBase.compile is not implemented");
};$.prototype.recursiveMatch_=function(d,a,n,b){var c=b;if(d>=this.matchers_.length)return 0==b;for(var g=this.matchers_[d];0<=c;){if(g.match(a,n,c)&&this.recursiveMatch_(d+1,a,n+c,b-c))return!0;--c}return!1};var $=a.NdnRegexMatcherBase,gd=function(d,a){$.call(this,d,$.NdnRegexExprType.BACKREF,a)};gd.prototype=new $;gd.prototype.name="NdnRegexBackrefMatcher";s.NdnRegexBackrefMatcher=gd;gd.prototype.lateCompile=function(){this.compile_()};gd.prototype.compile_=function(){if(2>this.expr_.length)throw new $.Error(Error("Unrecognized format: "+
this.expr_));var d=this.expr_.length-1;if("("===this.expr_[0]&&")"===this.expr_[d])d=new mc(this.expr_.substring(1,d),this.backrefManager_),this.matchers_.push(d);else throw new $.Error(Error("Unrecognized format: "+this.expr_));};var mc=a.NdnRegexPatternListMatcher,$=a.NdnRegexMatcherBase,hd=a.NdnRegexPseudoMatcher,vd=function(d,a,n){$.call(this,d,$.NdnRegexExprType.COMPONENT,a);void 0===n&&(n=!0);this.componentRegex_=null;this.pseudoMatchers_=[];this.isExactMatch_=n;this.compile_()};vd.prototype=
new $;vd.prototype.name="NdnRegexComponentMatcher";s.NdnRegexComponentMatcher=vd;vd.prototype.match=function(d,a,n){this.matchResult_=[];if(""==this.expr_)return this.matchResult_.push(d.get(a)),!0;if(this.isExactMatch_){if(n=d.get(a).toEscapedString().match(this.componentRegex_),null!==n){for(var b=1;b<n.length;++b)this.pseudoMatchers_[b].resetMatchResult(),this.pseudoMatchers_[b].setMatchResult(n[b]);this.matchResult_.push(d.get(a));return!0}}else throw new $.Error(Error("Non-exact component search is not supported yet"));
return!1};vd.prototype.compile_=function(){this.componentRegex_=new RegExp(this.expr_);this.pseudoMatchers_=[];this.pseudoMatchers_.push(new hd);if(0<=this.expr_.indexOf("\\("))throw new $.Error(Error("Can't count subexpressions in regex with escaped parentheses: "+expr_));for(var d=0,a=0;a<this.expr_.length;++a)"("===this.expr_[a]&&++d;for(a=1;a<=d;++a){var n=new hd;this.pseudoMatchers_.push(n);this.backrefManager_.pushRef(n)}};var $=a.NdnRegexMatcherBase,Rc=function(d,a){$.call(this,d,$.NdnRegexExprType.COMPONENT_SET,
a);this.components_=[];this.isInclusion_=!0;this.compile_()};Rc.prototype=new $;Rc.prototype.name="NdnRegexComponentSetMatcher";s.NdnRegexComponentSetMatcher=Rc;Rc.prototype.match=function(d,a,n){isMatched=!1;if(1!==n)return!1;for(var b=0;b<this.components_.length;++b)if(this.components_[b].match(d,a,n)){isMatched=!0;break}this.matchResult_=[];return(this.isInclusion_?isMatched:!isMatched)?(this.matchResult_.push(d.get(a)),!0):!1};Rc.prototype.compile_=function(){if(2>this.expr_.length)throw new $.Error(Error("Regexp compile error (cannot parse "+
this.expr_+")"));if("<"===this.expr_[0])this.compileSingleComponent_();else if("["===this.expr_[0]){var d=this.expr_.length-1;if("]"!==this.expr_[d])throw new $.Error(Error("Regexp compile error (no matching ']' in "+this.expr_+")"));"^"===this.expr_[1]?(this.isInclusion_=!1,this.compileMultipleComponents_(2,d)):this.compileMultipleComponents_(1,d)}else throw new $.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));};Rc.prototype.extractComponent_=function(d){for(var a=1,n=0;a>n;){if(d>=
this.expr_.length)throw new $.Error(Error("Error: angle brackets mismatch"));"<"===this.expr_[d]?a+=1:">"===this.expr_[d]&&(n+=1);d+=1}return d};Rc.prototype.compileSingleComponent_=function(){var d=this.extractComponent_(1);if(this.expr_.length!==d)throw new $.Error(Error("Component expr error "+this.expr_));component=new vd(this.expr_.substring(1,d-1),this.backrefManager_);this.components_.push(component)};Rc.prototype.compileMultipleComponents_=function(d,a){for(var n=d,b=d;n<a;){if("<"!==this.expr_[n])throw new $.Error(Error("Component expr error "+
this.expr_));b=n+1;n=this.extractComponent_(b);component=new vd(this.expr_.substring(b,n-1),this.backrefManager_);this.components_.push(component)}if(n!=a)throw new $.Error(Error("Not sufficient expr to parse "+this.expr_));};vd=a.NdnRegexComponentMatcher;$=a.NdnRegexMatcherBase;mc=function(d,a){$.call(this,d,$.NdnRegexExprType.PATTERN_LIST,a);this.compile_()};mc.prototype=new $;mc.prototype.name="NdnRegexPatternListMatcher";s.NdnRegexPatternListMatcher=mc;mc.prototype.compile_=function(){for(var d=
this.expr_.length,a=[0],n=a[0];a[0]<d;)if(n=a[0],!this.extractPattern_(n,a))throw new $.Error(Error("Compile error"));};mc.prototype.extractPattern_=function(d,a){var n=d,b=d,c=d;if("("===this.expr_[d])c=d=this.extractSubPattern_("(",")",d+1),b=this.extractRepetition_(d),c===b?(n=new gd(this.expr_.substring(n,b),this.backrefManager_),this.backrefManager_.pushRef(n),n.lateCompile(),this.matchers_.push(n)):this.matchers_.push(new Cc(this.expr_.substring(n,b),this.backrefManager_,c-n));else if("<"===
this.expr_[d])d+=1,c=d=this.extractSubPattern_("<",">",d),b=this.extractRepetition_(d),this.matchers_.push(new Cc(this.expr_.substring(n,b),this.backrefManager_,c-n));else if("["===this.expr_[d])d+=1,c=d=this.extractSubPattern_("[","]",d),b=this.extractRepetition_(d),this.matchers_.push(new Cc(this.expr_.substring(n,b),this.backrefManager_,c-n));else throw new $.Error(Error("Unexpected syntax"));a[0]=b;return!0};mc.prototype.extractSubPattern_=function(d,a,n){for(var b=1,c=0;b>c;){if(n>=this.expr_.length)throw new $.Error(Error("Parenthesis mismatch"));
d==this.expr_[n]&&(b+=1);a==this.expr_[n]&&(c+=1);n+=1}return n};mc.prototype.extractRepetition_=function(d){var a=this.expr_.length;if(d===a)return d;if("+"==this.expr_[d]||"?"==this.expr_[d]||"*"==this.expr_[d])return++d,d;if("{"==this.expr_[d]){for(;"}"!=this.expr_[d]&&(++d,d!==a););if(d===a)throw new $.Error(Error("Missing right brace bracket"));++d}return d};var gd=a.NdnRegexBackrefMatcher,Cc=a.NdnRegexRepeatMatcher,c=a.Name,$=a.NdnRegexMatcherBase,hd=function(){$.call(this,"",$.NdnRegexExprType.PSEUDO)};
hd.prototype=new $;hd.prototype.name="NdnRegexPseudoMatcher";s.NdnRegexPseudoMatcher=hd;hd.prototype.compile_=function(){};hd.prototype.setMatchResult=function(d){this.matchResult_.push(new c.Component(d))};hd.prototype.resetMatchResult=function(){this.matchResult_=[]};$=a.NdnRegexMatcherBase;Cc=function(d,a,n){$.call(this,d,$.NdnRegexExprType.REPEAT_PATTERN,a);this.repeatMax_=this.repeatMin_=0;this.indicator_=n;this.compile_()};Cc.prototype=new $;Cc.prototype.name="NdnRegexRepeatMatcher";s.NdnRegexRepeatMatcher=
Cc;Cc.prototype.match=function(d,a,n){this.matchResult_=[];if(0===this.repeatMin_&&0===n)return!0;if(this.recursiveMatch2_(0,d,a,n)){for(var b=a;b<a+n;++b)this.matchResult_.push(d.get(b));return!0}return!1};Cc.prototype.compile_=function(){var d;"("==this.expr_[0]?(d=new gd(this.expr_.substring(0,this.indicator_),this.backrefManager_),this.backrefManager_.pushRef(d),d.lateCompile()):d=new Rc(this.expr_.substring(0,this.indicator_),this.backrefManager_);this.matchers_.push(d);this.parseRepetition_()};
Cc.prototype.parseRepetition_=function(){var d=this.expr_.length;if(d===this.indicator_)return this.repeatMax_=this.repeatMin_=1,!0;if(d===this.indicator_+1){if("?"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=1,!0;if("+"==this.expr_[this.indicator_])return this.repeatMin_=1,this.repeatMax_=32767,!0;if("*"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=32767,!0}else{var d=this.expr_.substring(this.indicator_,d),a=d.length,n=0,b=0;if(null!=d.match(/\{[0-9]+,[0-9]+\}/))separator=
d.indexOf(","),n=parseInt(d.substring(1,separator)),b=parseInt(d.substring(separator+1,a-1));else if(null!=d.match(/\{,[0-9]+\}/))separator=d.indexOf(","),n=0,b=parseInt(d.substring(separator+1,a-1));else if(null!=d.match(/\{[0-9]+,\}/))separator=d.indexOf(","),n=parseInt(d.substring(1,separator)),b=32767;else if(null!=d.match(/\{[0-9]+\}/))b=n=parseInt(d.substring(1,a-1));else throw new $.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Unrecognized format "+this.expr_));if(32767<n||32767<
b||n>b)throw new $.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Wrong number "+this.expr_));this.repeatMin_=n;this.repeatMax_=b;return!0}return!1};Cc.prototype.recursiveMatch2_=function(d,a,n,b){var c=b,g=this.matchers_[0];if(0<b&&d>=this.repeatMax_||0===b&&d<this.repeatMin_)return!1;if(0==b&&d>=this.repeatMin_)return!0;for(;0<=c;){if(g.match(a,n,c)&&this.recursiveMatch2_(d+1,a,n+c,b-c))return!0;--c}return!1};var gd=a.NdnRegexBackrefMatcher,Rc=a.NdnRegexComponentSetMatcher,c=a.Name,$=
a.NdnRegexMatcherBase,Qc=a.NdnRegexBackrefManager,mc=a.NdnRegexPatternListMatcher,$a=function(d,a){$.call(this,d,$.NdnRegexExprType.TOP);void 0==a&&(a="");this.secondaryMatcher_=this.primaryMatcher_=null;this.primaryBackrefManager_=new Qc;this.secondaryBackrefManager_=new Qc;this.isSecondaryUsed_=!1;this.expand_=a;this.compile_()};$a.prototype=new $;$a.prototype.name="NdnRegexTopMatcher";s.NdnRegexTopMatcher=$a;$a.prototype.match=function(d,a,n){this.isSecondaryUsed_=!1;this.matchResult_=[];if(this.primaryMatcher_.match(d,
0,d.size())){this.matchResult_=[];d=this.primaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return!0}if(null!=this.secondaryMatcher_&&this.secondaryMatcher_.match(d,0,d.size())){this.matchResult_=[];d=this.secondaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return this.isSecondaryUsed_=!0}return!1};$a.prototype.expand=function(d){void 0==d&&(d="");var a=new c,n=this.isSecondaryUsed_?this.secondaryBackrefManager_:this.primaryBackrefManager_,
b=n.size();d=""!=d?d:this.expand_;for(var g=[0];g[0]<d.length;){var f=$a.getItemFromExpand_(d,g);"<"==f[0]&&a.append(f.substring(1,f.length-1));if("\\"==f[0])if(f=parseInt(f.substring(1,f.length)),0===f)for(f=0;f<this.matchResult_.length;++f)a.append(this.matchResult_[f]);else if(f<=b)for(var l=n.getBackref(f-1).getMatchResult(),f=0;f<l.length;++f)a.append(l[f]);else throw new $.Error(Error("Exceeded the range of back reference"));}return a};$a.fromName=function(d,a){void 0==a&&(a=!1);for(var n="^",
b=0;b<d.size();++b)n+="<",n+=$a.convertSpecialChar_(d.get(b).toEscapedString()),n+=">";a&&(n+="$");return new $a(n)};$a.prototype.compile_=function(){var d=this.expr_,d="$"!=d[d.length-1]?d+"<.*>*":d.substring(0,d.length-1);"^"!=d[0]?this.secondaryMatcher_=new mc("<.*>*"+d,this.secondaryBackrefManager_):d=d.substring(1);this.primaryMatcher_=new mc(d,this.primaryBackrefManager_)};$a.getItemFromExpand_=function(d,a){var n=a[0];if("\\"==d[a[0]]){++a[0];if(a[0]>=d.length)throw new $.Error(Error("Wrong format of expand string!"));
for(;a[0]<d.length&&"9">=d[a[0]]&&"0"<=d[a[0]];)if(++a[0],a[0]>d.length)throw new $.Error(Error("Wrong format of expand string!"));if(a[0]>n+1)return d.substring(n,a[0])}else if("<"==d[a[0]]){++a[0];if(a[0]>=d.length)throw new $.Error(Error("Wrong format of expand string!"));for(var b=1,c=0;c<b;)if("<"==d[a[0]]&&++b,">"==d[a[0]]&&++c,++a[0],a[0]>=d.length)throw new $.Error(Error("Wrong format of expand string!"));return d.substring(n,a[0])}throw new $.Error(Error("Wrong format of expand string!"));
};$a.convertSpecialChar_=function(d){newStr="";for(var a=0;a<d.length;++a){var n=d[a];if("."==n||"["==n||"{"==n||"}"==n||"("==n||")"==n||"\\"==n||"*"==n||"+"==n||"?"==n||"|"==n||"^"==n||"$"==n)newStr+="\\";newStr+=n}return newStr};var xb=function(){};s.Transport=xb;xb.ConnectionInfo=function(){};xb.prototype.isLocal=function(d,a,n){n("Transport.isLocal is not implemented")};var nc=function(){xb.call(this);this.onReceivedObject=this.connectionInfo=this.elementReader=null;var d=this;window.addEventListener("message",
function(a){if(a.source==window&&a.data.type&&"FromMicroForwarderStub"==a.data.type)if(a=a.data.object,a.type&&"Buffer"==a.type){if(null!=d.elementReader)d.elementReader.onReceivedData(new f(a.data))}else if(d.onReceivedObject)d.onReceivedObject(a)},!1)};nc.prototype=new xb;nc.prototype.name="MicroForwarderTransport";nc.ConnectionInfo=function(){xb.ConnectionInfo.call(this)};nc.ConnectionInfo.prototype=new xb.ConnectionInfo;nc.ConnectionInfo.prototype.name="MicroForwarderTransport.ConnectionInfo";
nc.ConnectionInfo.prototype.equals=function(d){return null==d?!1:!0};nc.ConnectionInfo.prototype.toString=function(){return"{}"};nc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};nc.prototype.isLocal=function(d,a,n){a(!0)};nc.prototype.connect=function(d,a,n,b){this.elementReader=new Xd(a);this.connectionInfo=d;n()};nc.prototype.sendObject=function(d){window.postMessage({type:"FromMicroForwarderTransport",object:d},"*")};nc.prototype.send=function(d){null==this.connectionInfo?
console.log("MicroForwarderTransport connection is not established."):this.sendObject(d.toJSON())};var oc=function(d){xb.call(this);this.connectionInfo=this.elementReader=null;this.onReceivedObject=d;this.port=null};oc.prototype=new xb;oc.prototype.name="RuntimePortTransport";oc.ConnectionInfo=function(d){xb.ConnectionInfo.call(this);this.port=d};oc.ConnectionInfo.prototype=new xb.ConnectionInfo;oc.ConnectionInfo.prototype.name="RuntimePortTransport.ConnectionInfo";oc.ConnectionInfo.prototype.equals=
function(d){return null==d||void 0==d.port?!1:this.port==d.port};oc.ConnectionInfo.prototype.toString=function(){return"{}"};oc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};oc.prototype.isLocal=function(d,a,n){a(!0)};oc.prototype.connect=function(d,a,n,b){this.elementReader=new Xd(a);this.connectionInfo=d;this.port=this.connectionInfo.port;var c=this;this.port.onMessage.addListener(function(d){if("Buffer"==d.type)c.elementReader.onReceivedData(f.isBuffer(d.data)?d.data:new f(d.data));
else if(null!=c.onReceivedObject)c.onReceivedObject(d)});this.port.onDisconnect.addListener(function(){c.port=null;null!=b&&b()});n()};oc.prototype.sendObject=function(d){null==this.port?console.log("RuntimePortTransport connection is not established."):this.port.postMessage(d)};oc.prototype.send=function(d){this.sendObject(d.toJSON())};var Xd=a.ElementReader,g=a.Log.LOG,xb=a.Transport,aa,Lb=function r(){xb.call(this);if(!WebSocket)throw Error("WebSocket support is not available on this platform.");
this.elementReader=this.connectionInfo=this.ws=null;this.defaultGetConnectionInfo=aa.makeShuffledHostGetConnectionInfo("A.ws.ndn.ucla.edu B.ws.ndn.ucla.edu C.ws.ndn.ucla.edu D.ws.ndn.ucla.edu E.ws.ndn.ucla.edu F.ws.ndn.ucla.edu G.ws.ndn.ucla.edu H.ws.ndn.ucla.edu I.ws.ndn.ucla.edu J.ws.ndn.ucla.edu K.ws.ndn.ucla.edu L.ws.ndn.ucla.edu M.ws.ndn.ucla.edu N.ws.ndn.ucla.edu".split(" "),9696,function(a,b){return new r.ConnectionInfo(a,b)})};Lb.prototype=new xb;Lb.prototype.name="WebSocketTransport";Lb.importFace=
function(a){aa=a};s.WebSocketTransport=Lb;Lb.ConnectionInfo=function(a,n){xb.ConnectionInfo.call(this);this.host=a;this.port=void 0!==n?n:9696};Lb.ConnectionInfo.prototype=new xb.ConnectionInfo;Lb.ConnectionInfo.prototype.name="WebSocketTransport.ConnectionInfo";Lb.ConnectionInfo.prototype.equals=function(a){return null==a||void 0==a.host||void 0==a.port?!1:this.host==a.host&&this.port==a.port};Lb.ConnectionInfo.prototype.toString=function(){return this.hostIsUri()?"{ uri: "+this.host+" }":"{ host: "+
this.host+", port: "+this.port+" }"};Lb.ConnectionInfo.prototype.hostIsUri=function(){return"ws:"==this.host.substr(0,3)||"wss:"==this.host.substr(0,4)};Lb.prototype.isLocal=function(a,n,b){n(!1)};Lb.prototype.connect=function(a,n,b,c){this.close();var l=a.hostIsUri()?a.host:"ws://"+a.host+":"+a.port;this.ws=new WebSocket(l);0<g&&console.log("ws connection created.");this.connectionInfo=a;this.ws.binaryType="arraybuffer";this.elementReader=new Xd(n);var m=this;this.ws.onmessage=function(a){a=a.data;
if(null==a||void 0==a||""==a)console.log("INVALID ANSWER");else if(a instanceof ArrayBuffer){a=new f(new Uint8Array(a));3<g&&console.log("BINARY RESPONSE IS "+a.toString("hex"));try{m.elementReader.onReceivedData(a)}catch(n){console.log("NDN.ws.onmessage exception: "+n)}}};this.ws.onopen=function(a){3<g&&console.log(a);3<g&&console.log("ws.onopen: WebSocket connection opened.");3<g&&console.log("ws.onopen: ReadyState: "+this.readyState);b()};this.ws.onerror=function(a){console.log("ws.onerror: ReadyState: "+
this.readyState);console.log(a);console.log("ws.onerror: WebSocket error: "+a.data)};this.ws.onclose=function(a){console.log("ws.onclose: WebSocket connection closed.");m.ws=null;null!=c&&c()}};Lb.prototype.connectByFace=function(a,n){this.connect(a.connectionInfo,a,n,function(){a.closeByTransport()})};Lb.prototype.send=function(a){if(null!=this.ws){var n=new Uint8Array(a.length);n.set(a);this.ws.send(n.buffer);3<g&&console.log("ws.send() returned.")}else console.log("WebSocket connection is not established.")};
Lb.prototype.close=function(){null!=this.ws&&delete this.ws};s.TcpTransport=a.WebSocketTransport;var m=a.Blob,M=a.DataUtils,g=a.Log.LOG,T=a.DecodingException,c=function n(a){if("string"==typeof a)3<g&&console.log("Content Name String "+a),this.components=n.createNameArray(a);else if("object"===typeof a)if(this.components=[],a instanceof n)this.append(a);else for(var b=0;b<a.length;++b)this.append(a[b]);else null==a?this.components=[]:1<g&&console.log("NO CONTENT NAME GIVEN");this.changeCount=0},kb=
{IMPLICIT_SHA256_DIGEST:1,PARAMETERS_SHA256_DIGEST:2,GENERIC:8,OTHER_CODE:32767};s.Name=c;s.ComponentType=kb;c.Component=function(a,b,g){if("object"===typeof a&&a instanceof c.Component)this.value_=a.value_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_;else{this.value_=a?"object"===typeof a&&"undefined"!==typeof ArrayBuffer&&a instanceof ArrayBuffer?new m(new f(new Uint8Array(a)),!1):"object"===typeof a&&a instanceof m?a:new m(a):new m([]);if(b===kb.OTHER_CODE){if(void 0==g)throw Error("To use an other code, call Name.Component(value, ComponentType.OTHER_CODE, otherTypeCode)");
if(0>g)throw Error("Name.Component other type code must be non-negative");this.otherTypeCode_=g}else this.otherTypeCode_=-1;this.type_=void 0==b?kb.GENERIC:b}};c.Component.prototype.getValue=function(){return this.value_};c.Component.prototype.getValueAsBuffer=function(){return this.value_.buf()};c.Component.prototype.getType=function(){return this.type_};c.Component.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Object.defineProperty(c.Component.prototype,"value",{get:function(){return this.getValueAsBuffer()}});
c.Component.prototype.toEscapedString=function(){return this.type_===kb.IMPLICIT_SHA256_DIGEST?"sha256digest="+this.value_.toHex():this.type_===kb.PARAMETERS_SHA256_DIGEST?"params-sha256="+this.value_.toHex():(this.type_===kb.GENERIC?"":(this.type_===kb.OTHER_CODE?this.otherTypeCode_:this.type_)+"=")+c.toEscapedString(this.value_.buf())};c.Component.prototype.isSegment=function(){return 1<=this.value_.size()&&0==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isSegmentOffset=function(){return 1<=
this.value_.size()&&251==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isVersion=function(){return 1<=this.value_.size()&&253==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isTimestamp=function(){return 1<=this.value_.size()&&252==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isSequenceNumber=function(){return 1<=this.value_.size()&&254==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isGeneric=function(){return this.type_===kb.GENERIC};
c.Component.prototype.isImplicitSha256Digest=function(){return this.type_===kb.IMPLICIT_SHA256_DIGEST};c.Component.prototype.isParametersSha256Digest=function(){return this.type_===kb.PARAMETERS_SHA256_DIGEST};c.Component.prototype.toNumber=function(){return M.bigEndianToUnsignedInt(this.value_.buf())};c.Component.prototype.toNumberWithMarker=function(a){if(0==this.value_.size()||this.value_.buf()[0]!=a)throw Error("Name component does not begin with the expected marker");return M.bigEndianToUnsignedInt(this.value_.buf().slice(1))};
c.Component.prototype.toSegment=function(){return this.toNumberWithMarker(0)};c.Component.prototype.toSegmentOffset=function(){return this.toNumberWithMarker(251)};c.Component.prototype.toVersion=function(){return this.toNumberWithMarker(253)};c.Component.prototype.toTimestamp=function(){return this.toNumberWithMarker(252)};c.Component.prototype.toSequenceNumber=function(){return this.toNumberWithMarker(254)};c.Component.fromNumber=function(a,b,g){var f=new sa(8);f.writeNonNegativeInteger(a);return new c.Component(new m(f.getOutput(),
!1),b,g)};c.Component.fromNumberWithMarker=function(a,b){var g=new sa(9);g.writeNonNegativeInteger(a);g.writeNonNegativeInteger(b);return new c.Component(new m(g.getOutput(),!1))};c.Component.fromSegment=function(a){return c.Component.fromNumberWithMarker(a,0)};c.Component.fromSegmentOffset=function(a){return c.Component.fromNumberWithMarker(a,251)};c.Component.fromVersion=function(a){return c.Component.fromNumberWithMarker(a,253)};c.Component.fromTimestamp=function(a){return c.Component.fromNumberWithMarker(a,
252)};c.Component.fromSequenceNumber=function(a){return c.Component.fromNumberWithMarker(a,254)};c.Component.fromImplicitSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof m?a:new m(a,!0);if(32!==digestBlob.size())throw new T("Name.Component.fromImplicitSha256Digest: The digest length must be 32 bytes");a=new c.Component(digestBlob);a.type_=kb.IMPLICIT_SHA256_DIGEST;return a};c.Component.fromParametersSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof m?a:new m(a,
!0);if(32!==digestBlob.size())throw new T("Name.Component.fromParametersSha256Digest: The digest length must be 32 bytes");a=new c.Component(digestBlob);a.type_=kb.PARAMETERS_SHA256_DIGEST;return a};c.Component.prototype.getSuccessor=function(){for(var a=new f(this.value_.size()+1),b=!0,g=this.value_.size()-1;0<=g;--g)b?(a[g]=this.value_.buf()[g]+1&255,b=0===a[g]):a[g]=this.value_.buf()[g];b?a[a.length-1]=0:a=a.slice(0,this.value_.size());return new c.Component(new m(a,!1),this.type_,this.otherTypeCode_)};
c.Component.prototype.equals=function(a){return"object"===typeof a&&a instanceof c.Component?this.type_===kb.OTHER_CODE?this.value_.equals(a.value_)&&a.type_===kb.OTHER_CODE&&this.otherTypeCode_==a.otherTypeCode_:this.value_.equals(a.value_)&&this.type_===a.type_:!1};c.Component.prototype.compare=function(a){var b=this.type_===kb.OTHER_CODE?this.otherTypeCode_:this.type_,g=a.type_===kb.OTHER_CODE?a.otherTypeCode_:a.type_;return b<g?-1:b>g?1:c.Component.compareBuffers(this.value_.buf(),a.value_.buf())};
c.Component.compareBuffers=function(a,b){if(a.length<b.length)return-1;if(a.length>b.length)return 1;for(var c=0;c<a.length;++c){if(a[c]<b[c])return-1;if(a[c]>b[c])return 1}return 0};c.prototype.getName=function(){return this.toUri()};c.createNameArray=function(a){a=a.trim();if(0>=a.length)return[];var b=a.indexOf(":");if(0<=b){var g=a.indexOf("/");if(0>g||b<g)a=a.substr(b+1,a.length-b-1).trim()}if("/"==a[0])if(2<=a.length&&"/"==a[1]){b=a.indexOf("/",2);if(0>b)return[];a=a.substr(b+1,a.length-b-1).trim()}else a=
a.substr(1,a.length-1).trim();b=a.split("/");for(g=0;g<b.length;++g){var l=b[g];if("sha256digest="==l.substr(0,13))l=l.substr(13).trim(),l=c.Component.fromImplicitSha256Digest(new m(new f(l,"hex")),!1);else if("params-sha256="==l.substr(0,14))l=l.substr(14).trim(),l=c.Component.fromParametersSha256Digest(new m(new f(l,"hex")),!1);else{var q=kb.GENERIC,t=-1,s=l.indexOf("=");if(0<=s){q=l.substring(0,s);t=parseInt(q);if(isNaN(t))throw Error("Can't parse decimal Name Component type: "+q+" in URI "+a);
q=t==kb.GENERIC||t==kb.IMPLICIT_SHA256_DIGEST||t==kb.PARAMETERS_SHA256_DIGEST?t:kb.OTHER_CODE;l=l.substring(s+1)}l=new c.Component(c.fromEscapedString(l),q,t)}l.getValue().isNull()?(b.splice(g,1),--g):b[g]=l}return b};c.prototype.set=function(a){this.components=c.createNameArray(a);++this.changeCount};c.prototype.append=function(a,b,g){if("object"==typeof a&&a instanceof c)for(a=a==this?this.components.slice(0,this.components.length):a.components,b=0;b<a.length;++b)this.components.push(new c.Component(a[b]));
else"object"===typeof a&&a instanceof c.Component?this.components.push(a):this.components.push(new c.Component(a,b,g));++this.changeCount;return this};c.prototype.add=function(a){return this.append(a)};c.prototype.clear=function(){this.components=[];++this.changeCount};c.prototype.toUri=function(a){if(0==this.size())return a?"ndn:/":"/";a=a?"ndn:":"";for(var b=0;b<this.size();++b)a+="/"+this.components[b].toEscapedString();return a};c.prototype.to_uri=function(){return this.toUri()};c.prototype.toString=
function(){return this.toUri()};c.prototype.appendSegment=function(a){return this.append(c.Component.fromSegment(a))};c.prototype.appendSegmentOffset=function(a){return this.append(c.Component.fromSegmentOffset(a))};c.prototype.appendVersion=function(a){return this.append(c.Component.fromVersion(a))};c.prototype.appendTimestamp=function(a){return this.append(c.Component.fromTimestamp(a))};c.prototype.appendSequenceNumber=function(a){return this.append(c.Component.fromSequenceNumber(a))};c.prototype.appendImplicitSha256Digest=
function(a){return this.append(c.Component.fromImplicitSha256Digest(a))};c.prototype.appendParametersSha256Digest=function(a){return this.append(c.Component.fromParametersSha256Digest(a))};c.prototype.addSegment=function(a){return this.appendSegment(a)};c.prototype.getSubName=function(a,b){0>a&&(a=this.components.length- -a);void 0==b&&(b=this.components.length-a);for(var g=new c,f=a+b,l=a;l<f&&l<this.components.length;++l)g.components.push(this.components[l]);return g};c.prototype.getPrefix=function(a){return 0>
a?this.getSubName(0,this.components.length+a):this.getSubName(0,a)};c.prototype.cut=function(a){return new c(this.components.slice(0,this.components.length-a))};c.prototype.size=function(){return this.components.length};c.prototype.get=function(a){if(0<=a){if(a>=this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[a]}if(a<-this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[this.components.length- -a]};c.prototype.getComponentCount=
function(){return this.components.length};c.prototype.getComponent=function(a){return new f(this.components[a].getValue().buf())};c.prototype.indexOfFileName=function(){for(var a=this.size()-1;0<=a;--a){var b=this.components[a].getValue().buf();if(!(0>=b.length||0==b[0]||192==b[0]||193==b[0]||245<=b[0]&&255>=b[0]))return a}return-1};c.prototype.wireEncode=function(a){a=a||t.getDefaultWireFormat();return a.encodeName(this)};c.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();"object"===
typeof a&&a instanceof m?b.decodeName(this,a.buf(),!1):b.decodeName(this,a,!0)};c.prototype.compare=function(a,b,g,f,l){a instanceof c&&(g=a,a=0,b=this.size());void 0==f&&(f=0);void 0==l&&(l=g.size());0>a&&(a=this.size()- -a);0>f&&(f=g.size()- -f);b=Math.min(b,this.size()-a);l=Math.min(l,g.size()-f);for(var m=Math.min(b,l),q=0;q<m;++q){var t=this.components[a+q].compare(g.components[f+q]);if(0!=t)return t}return b<l?-1:b>l?1:0};c.prototype.equals=function(a){if(this.components.length!=a.components.length)return!1;
for(var b=this.components.length-1;0<=b;--b)if(!this.components[b].equals(a.components[b]))return!1;return!0};c.prototype.equalsName=function(a){return this.equals(a)};c.prototype.getContentDigestValue=function(){for(var a=this.size()-1;0<=a;--a){var b=c.getComponentContentDigestValue(this.components[a]);if(null!=b)return b}return null};c.getComponentContentDigestValue=function(a){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());return a.length==c.ContentDigestPrefix.length+32+
c.ContentDigestSuffix.length&&M.arraysEqual(a.slice(0,c.ContentDigestPrefix.length),c.ContentDigestPrefix)&&M.arraysEqual(a.slice(a.length-c.ContentDigestSuffix.length,a.length),c.ContentDigestSuffix)?a.slice(c.ContentDigestPrefix.length,c.ContentDigestPrefix.length+32):null};c.ContentDigestPrefix=new f([193,46,77,46,71,193,1,170,2,133]);c.ContentDigestSuffix=new f([0]);c.toEscapedString=function(a){"object"==typeof a&&a instanceof c.Component?a=a.getValue().buf():"object"===typeof a&&a instanceof
m&&(a=a.buf());for(var b="",g=!1,f=0;f<a.length;++f)if(46!=a[f]){g=!0;break}if(g)for(f=0;f<a.length;++f)g=a[f],b=48<=g&&57>=g||65<=g&&90>=g||97<=g&&122>=g||43==g||45==g||46==g||95==g?b+String.fromCharCode(g):b+("%"+(16>g?"0":"")+g.toString(16).toUpperCase());else for(b="...",f=0;f<a.length;++f)b+=".";return b};c.fromEscapedString=function(a){a=unescape(a.trim());return null==a.match(/[^.]/)?2>=a.length?new m:new m(M.toNumbersFromString(a.substr(3,a.length-3)),!1):new m(M.toNumbersFromString(a),!1)};
c.fromEscapedStringAsBuffer=function(a){return c.fromEscapedString(a).buf()};c.prototype.getSuccessor=function(){return 0==this.size()?new c("/sha256digest=0000000000000000000000000000000000000000000000000000000000000000"):this.getPrefix(-1).append(this.get(-1).getSuccessor())};c.prototype.match=function(a){var b=this.components;a=a.components;if(b.length>a.length)return!1;for(var c=b.length-1;0<=c;--c)if(!b[c].equals(a[c]))return!1;return!0};c.prototype.isPrefixOf=function(a){return this.match(a)};
c.prototype.getChangeCount=function(){return this.changeCount};var sa=a.TlvEncoder,t=a.WireFormat,m=a.Blob,qa=a.ChangeCounter,c=a.Name,va={KEYNAME:1,KEY_LOCATOR_DIGEST:2};s.KeyLocatorType=va;var W=function Xe(a,b){"object"===typeof a&&a instanceof Xe?(this.type_=a.type_,this.keyName_=new qa(new c(a.getKeyName())),this.keyData_=a.keyData_):(this.type_=b,this.keyName_=new qa(new c),this.keyData_=new m,b==va.KEYNAME?this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c):b==va.KEY_LOCATOR_DIGEST&&
(this.keyData_=new m(a)));this.changeCount_=0};s.KeyLocator=W;W.prototype.getType=function(){return this.type_};W.prototype.getKeyName=function(){return this.keyName_.get()};W.prototype.getKeyData=function(){return this.keyData_};W.prototype.getKeyDataAsBuffer=function(){return this.getKeyData().buf()};W.prototype.setType=function(a){this.type_=a;++this.changeCount_};W.prototype.setKeyName=function(a){this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_};W.prototype.setKeyData=
function(a){this.keyData_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};W.prototype.clear=function(){this.type_=null;this.keyName_.set(new c);this.keyData_=new m;++this.changeCount_};W.prototype.equals=function(a){if(this.type_!=a.type_)return!1;if(this.type_==va.KEYNAME){if(!this.getKeyName().equals(a.getKeyName()))return!1}else if(this.type_==va.KEY_LOCATOR_DIGEST&&!this.getKeyData().equals(a.getKeyData()))return!1;return!0};W.canGetFromSignature=function(a){return a instanceof
Ka||a instanceof Ya||a instanceof qb};W.getFromSignature=function(a){if(a instanceof Ka||a instanceof Ya||a instanceof qb)return a.getKeyLocator();throw Error("KeyLocator.getFromSignature: Signature type does not have a KeyLocator");};W.prototype.getChangeCount=function(){this.keyName_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(W.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(W.prototype,"keyData",
{get:function(){return this.getKeyDataAsBuffer()},set:function(a){this.setKeyData(a)}});var Ka=a.Sha256WithRsaSignature,Ya=a.Sha256WithEcdsaSignature,qb=a.HmacWithSha256Signature,c=a.Name,Ea={BLOB:0,LINK:1,KEY:2,NACK:3,OTHER_CODE:32767};s.ContentType=Ea;var eb=function Ye(a,b,c,g,f,l){if(b)throw Error("MetaInfo constructor: timestamp support has been removed.");if(g)throw Error("MetaInfo constructor: locator support has been removed.");if("object"===typeof a&&a instanceof Ye)this.publisher_=a.publisher_,
this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_,this.freshnessPeriod_=a.freshnessPeriod_,this.finalBlockId_=a.finalBlockId_;else{if(a)throw Error("MetaInfo constructor: publisher support has been removed.");this.type=null==c||0>c?Ea.BLOB:c;this.otherTypeCode_=-1;this.freshnessSeconds=f;this.setFinalBlockId(l)}this.changeCount_=0};s.MetaInfo=eb;eb.prototype.getType=function(){return this.type_};eb.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};eb.prototype.getFreshnessPeriod=
function(){return this.freshnessPeriod_};eb.prototype.getFinalBlockId=function(){return this.finalBlockId_};eb.prototype.getFinalBlockID=function(){return this.getFinalBlockId()};eb.prototype.getFinalBlockIDAsBuffer=function(){return this.finalBlockId_.getValue().buf()};eb.prototype.setType=function(a){this.type_=null==a||0>a?Ea.BLOB:a;++this.changeCount_};eb.prototype.setOtherTypeCode=function(a){if(0>a)throw Error("MetaInfo other type code must be non-negative");this.otherTypeCode_=a;++this.changeCount_};
eb.prototype.setFreshnessPeriod=function(a){this.freshnessPeriod_=null==a||0>a?null:a;++this.changeCount_};eb.prototype.setFinalBlockId=function(a){this.finalBlockId_="object"===typeof a&&a instanceof c.Component?a:new c.Component(a);++this.changeCount_};eb.prototype.setFinalBlockID=function(a){this.setFinalBlockId(a)};eb.prototype.clear=function(){this.type=Ea.BLOB;this.otherTypeCode_=-1;this.freshnessSeconds=null;this.finalBlockId_=new c.Component;++this.changeCount_};eb.prototype.getChangeCount=
function(){return this.changeCount_};Object.defineProperty(eb.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(eb.prototype,"freshnessSeconds",{get:function(){return null==this.freshnessPeriod_||0>this.freshnessPeriod_?null:this.freshnessPeriod_/1E3},set:function(a){this.freshnessPeriod_=null==a||0>a?null:1E3*a;++this.changeCount_}});Object.defineProperty(eb.prototype,"finalBlockID",{get:function(){return this.getFinalBlockIDAsBuffer()},
set:function(a){this.setFinalBlockId(a)}});var m=a.Blob,qa=a.ChangeCounter,W=a.KeyLocator,Fa=a.ValidityPeriod,Ya=function Ze(a){"object"===typeof a&&a instanceof Ze?(this.keyLocator_=new qa(new W(a.getKeyLocator())),this.validityPeriod_=new qa(new Fa(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new qa(new W),this.validityPeriod_=new qa(new Fa),this.signature_=new m);this.changeCount_=0};s.Sha256WithEcdsaSignature=Ya;Ya.prototype.clone=function(){return new Ya(this)};Ya.prototype.getKeyLocator=
function(){return this.keyLocator_.get()};Ya.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Ya.prototype.getSignature=function(){return this.signature_};Ya.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof W?new W(a):new W);++this.changeCount_};Ya.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof Fa?new Fa(a):new Fa);++this.changeCount_};Ya.prototype.setSignature=function(a){this.signature_=
"object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};Ya.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};m=a.Blob;qa=a.ChangeCounter;W=a.KeyLocator;Fa=a.ValidityPeriod;Ka=function $e(a){"object"===typeof a&&a instanceof $e?(this.keyLocator_=new qa(new W(a.getKeyLocator())),this.validityPeriod_=new qa(new Fa(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=
new qa(new W),this.validityPeriod_=new qa(new Fa),this.signature_=new m);this.changeCount_=0};s.Sha256WithRsaSignature=Ka;Ka.prototype.clone=function(){return new Ka(this)};Ka.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Ka.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Ka.prototype.getSignature=function(){return this.signature_};Ka.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Ka.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===
typeof a&&a instanceof W?new W(a):new W);++this.changeCount_};Ka.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof Fa?new Fa(a):new Fa);++this.changeCount_};Ka.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};Ka.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Object.defineProperty(Ka.prototype,
"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(Ka.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var m=a.Blob,bc=function af(a){"object"===typeof a&&a instanceof af?(this.signature_=a.signature_,this.signatureInfoEncoding_=a.signatureInfoEncoding_,this.typeCode_=a.typeCode_):(this.signature_=new m,this.signatureInfoEncoding_=new m,this.typeCode_=null);this.changeCount_=
0};s.GenericSignature=bc;bc.prototype.clone=function(){return new bc(this)};bc.prototype.getSignature=function(){return this.signature_};bc.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};bc.prototype.getSignatureInfoEncoding=function(){return this.signatureInfoEncoding_};bc.prototype.getTypeCode=function(){return this.typeCode_};bc.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};bc.prototype.setSignatureInfoEncoding=
function(a,b){this.signatureInfoEncoding_="object"===typeof a&&a instanceof m?a:new m(a);this.typeCode_=b;++this.changeCount_};bc.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(bc.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});m=a.Blob;qa=a.ChangeCounter;W=a.KeyLocator;qb=function ef(a){"object"===typeof a&&a instanceof ef?(this.keyLocator_=new qa(new W(a.getKeyLocator())),this.signature_=a.signature_):
(this.keyLocator_=new qa(new W),this.signature_=new m);this.changeCount_=0};s.HmacWithSha256Signature=qb;qb.prototype.clone=function(){return new qb(this)};qb.prototype.getKeyLocator=function(){return this.keyLocator_.get()};qb.prototype.getSignature=function(){return this.signature_};qb.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};qb.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof W?new W(a):new W);++this.changeCount_};qb.prototype.setSignature=
function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};qb.prototype.getChangeCount=function(){this.keyLocator_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(qb.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(qb.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var m=a.Blob,yb=
function bf(a){this.signature_="object"===typeof a&&a instanceof bf?a.signature_:new m;this.changeCount_=0};s.DigestSha256Signature=yb;yb.prototype.clone=function(){return new yb(this)};yb.prototype.getSignature=function(){return this.signature_};yb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};yb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(yb.prototype,"signature",{get:function(){return this.getSignature()},
set:function(a){this.setSignature(a)}});var m=a.Blob,db=a.SignedBlob,qa=a.ChangeCounter,c=a.Name,Ka=a.Sha256WithRsaSignature,eb=a.MetaInfo,Dc=a.IncomingFaceId,id=a.CongestionMark,t=a.WireFormat,X=a,S=function cf(a,b,g){a instanceof cf?(this.name_=new qa(new c(a.getName())),this.metaInfo_=new qa(new eb(a.getMetaInfo())),this.signature_=new qa(a.getSignature().clone()),this.content_=a.content_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultFullName_=new c(a.defaultFullName_),this.defaultWireEncodingFormat_=
a.defaultWireEncodingFormat_):(this.name_="string"===typeof a?new qa(new c(a)):new qa("object"===typeof a&&a instanceof c?new c(a):new c),"object"===typeof b&&b instanceof eb?(a=b,b=g):a=null,this.metaInfo_=new qa("object"===typeof a&&a instanceof eb?new eb(a):new eb),this.content_="object"===typeof b&&b instanceof m?b:new m(b,!0),this.signature_=new qa(new Ka),this.defaultWireEncoding_=new db,this.defaultFullName_=new c,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=
0;this.lpPacket_=null};s.Data=S;S.prototype.getName=function(){return this.name_.get()};S.prototype.getMetaInfo=function(){return this.metaInfo_.get()};S.prototype.getSignature=function(){return this.signature_.get()};S.prototype.getContent=function(){return this.content_};S.prototype.getContentAsBuffer=function(){return this.content_.buf()};S.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new db,this.defaultWireEncodingFormat_=
null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};S.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};S.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:Dc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};S.prototype.getCongestionMark=function(){var a=null===this.lpPacket_?null:id.getFirstHeader(this.lpPacket_);return null===a?0:a.getCongestionMark()};S.prototype.getFullName=
function(a){a=a||t.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&0<this.defaultFullName_.size()&&this.getDefaultWireEncodingFormat()==a)return this.defaultFullName_;var b=new c(this.getName()),g=X.createHash("sha256");g.update(this.wireEncode(a).buf());b.appendImplicitSha256Digest(new m(g.digest(),!1));a==t.getDefaultWireFormat()&&(this.defaultFullName_=b);return b};S.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;
return this};S.prototype.setMetaInfo=function(a){this.metaInfo_.set("object"===typeof a&&a instanceof eb?new eb(a):new eb);++this.changeCount_;return this};S.prototype.setSignature=function(a){this.signature_.set(null==a?new Ka:a.clone());++this.changeCount_;return this};S.prototype.setContent=function(a){this.content_="object"===typeof a&&a instanceof m?a:new m(a,!0);++this.changeCount_;return this};S.prototype.wireEncode=function(a){a=a||t.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&
this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeData(this),b=new db(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==t.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,t.getDefaultWireFormat());return b};S.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof m?b.decodeData(this,a.buf(),!1):b.decodeData(this,a,!0);b==t.getDefaultWireFormat()?this.setDefaultWireEncoding(new db(new m(a,
!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),t.getDefaultWireFormat()):this.setDefaultWireEncoding(new db,null)};S.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};S.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.metaInfo_.checkChanged()||a;(a=this.signature_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};S.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=
this.getChangeCount()};Object.defineProperty(S.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(S.prototype,"metaInfo",{get:function(){return this.getMetaInfo()},set:function(a){this.setMetaInfo(a)}});Object.defineProperty(S.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});Object.defineProperty(S.prototype,"content",{get:function(){return this.getContentAsBuffer()},set:function(a){this.setContent(a)}});
x.prototype=Error();x.prototype.name="SecurityException";s.SecurityException=x;Lc.prototype=new x;Lc.prototype.name="UnrecognizedKeyFormatException";s.UnrecognizedKeyFormatException=Lc;F.prototype=new x;F.prototype.name="UnrecognizedDigestAlgorithmException";s.UnrecognizedDigestAlgorithmException=F;fc.prototype=Error();fc.prototype.name="InvalidArgumentException";s.InvalidArgumentException=fc;var ea=function(){};s.KeyType=ea;ea.RSA=0;ea.EC=1;ea.ECDSA=1;ea.AES=128;var jd=function(){};s.KeyClass=jd;
jd.PUBLIC=1;jd.PRIVATE=2;jd.SYMMETRIC=3;var Ha=function(){};s.DigestAlgorithm=Ha;Ha.SHA256=1;var X=a,E=a.Interest,t=a.WireFormat,sa=a.TlvEncoder,m=a.Blob,kd=function(){this.lastUsedTimestamp_=Math.round((new Date).getTime());this.nowOffsetMilliseconds_=0};s.CommandInterestPreparer=kd;kd.prototype.prepareCommandInterestName=function(a,b){void 0==b&&t.getDefaultWireFormat();for(var c=(new Date).getTime()+this.nowOffsetMilliseconds_,c=Math.round(c);c<=this.lastUsedTimestamp_;)c+=1;this.lastUsedTimestamp_=
c;var g=new sa(8);g.writeNonNegativeInteger(c);a.getName().append(new m(g.getOutput(),!1));a.getName().append(new m(X.randomBytes(8),!1))};kd.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};var E=a.Interest,t=a.WireFormat,Z=a.SigningInfo,kd=a.CommandInterestPreparer,pc=function(a){kd.call(this);this.keyChain_=a};pc.prototype=new kd;pc.prototype.name="CommandInterestSigner";s.CommandInterestSigner=pc;pc.POS_SIGNATURE_VALUE=-1;pc.POS_SIGNATURE_INFO=-2;pc.POS_NONCE=-3;
pc.POS_TIMESTAMP=-4;pc.MINIMUM_SIZE=4;pc.prototype.makeCommandInterest=function(a,b,c,g,f){var l=b,m=c,q=g;b=l instanceof Z?l:void 0;c=l instanceof t?l:m instanceof t?m:void 0;"function"===typeof l?(g=l,f=m):"function"===typeof m?(g=m,f=q):"function"===typeof q?g=q:f=g=void 0;void 0==b&&(b=new Z);void 0==c&&(c=t.getDefaultWireFormat());a=new E(a);this.prepareCommandInterestName(a,c);return this.keyChain_.sign(a,b,c,g,f)};var zb=function(){};s.KeyIdType=zb;zb.USER_SPECIFIED=0;zb.SHA256=1;zb.RANDOM=
2;var c=a.Name,zb=a.KeyIdType,ea=a.KeyType,Mb=function(a,b){this.keyType_=a;if(b instanceof c.Component){if(0==b.getValue().size())throw Error("KeyParams: keyId is empty");this.keyIdType_=zb.USER_SPECIFIED;this.keyId_=b}else{if(b==zb.USER_SPECIFIED)throw Error("KeyParams: KeyIdType is USER_SPECIFIED");this.keyIdType_=b;this.keyId_=new c.Component}};s.KeyParams=Mb;Mb.prototype.getKeyType=function(){return this.keyType_};Mb.prototype.getKeyIdType=function(){return this.keyIdType_};Mb.prototype.getKeyId=
function(){return this.keyId_};Mb.prototype.setKeyId=function(a){this.keyId_=a};var cc=function fe(a,b){if(a instanceof c.Component)Mb.call(this,fe.getType(),a),this.size_=void 0==b?fe.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:zb.RANDOM;Mb.call(this,fe.getType(),g);this.size_=a}else Mb.call(this,fe.getType(),zb.RANDOM),this.size_=fe.getDefaultSize()};cc.prototype=new Mb;cc.prototype.name="RsaKeyParams";s.RsaKeyParams=cc;cc.prototype.getKeySize=function(){return this.size_};cc.getDefaultSize=
function(){return 2048};cc.getType=function(){return ea.RSA};var Sc=function ge(a,b){if(a instanceof c.Component)Mb.call(this,ge.getType(),a),this.size_=void 0==b?ge.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:zb.RANDOM;Mb.call(this,ge.getType(),g);this.size_=a}else Mb.call(this,ge.getType(),zb.RANDOM),this.size_=ge.getDefaultSize()};Sc.prototype=new Mb;Sc.prototype.name="EcKeyParams";s.EcKeyParams=Sc;Sc.prototype.getKeySize=function(){return this.size_};Sc.getDefaultSize=function(){return 256};
Sc.getType=function(){return ea.EC};var ie=function(a,b){Sc.call(this,a,b)};ie.prototype=new Sc;ie.prototype.name="EcdsaKeyParams";s.EcdsaKeyParams=ie;ie.getDefaultSize=function(){return Sc.getDefaultSize()};ie.getType=function(){return Sc.getType()};var wd=function he(a,b){if(a instanceof c.Component)Mb.call(this,he.getType(),a),this.size_=void 0==b?he.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:zb.RANDOM;Mb.call(this,he.getType(),g);this.size_=a}else Mb.call(this,he.getType(),zb.RANDOM),
this.size_=he.getDefaultSize()};wd.prototype=new Mb;wd.prototype.name="AesKeyParams";s.AesKeyParams=wd;wd.prototype.getKeySize=function(){return this.size_};wd.getDefaultSize=function(){return 64};wd.getType=function(){return ea.AES};var c=a.Name,S=a.Data,Ea=a.ContentType,Ka=a.Sha256WithRsaSignature,Ya=a.Sha256WithEcdsaSignature,W=a.KeyLocator,va=a.KeyLocatorType,t=a.WireFormat,Ha=a.DigestAlgorithm,ea=a.KeyType,Fa=a.ValidityPeriod,O=a.CertificateV2,b=a.SyncPromise,fb=a.Tpm,dc=a.TpmBackEndMemory,m=
a.Blob,q=a.Tlv,sa=a.TlvEncoder,pa=a.TlvDecoder,hb=a.TlvWireFormat,Ba=a.PublicKey,Tc=function df(a,b,g,f,z,y){a instanceof c?(void 0==z&&(z=Ha.SHA256),void 0==y&&(y=t.getDefaultWireFormat()),this.certificate_=df.makeSelfSignedCertificate_(a,b,g,f,z,y),this.privateKeyBag_=b):a instanceof S?(this.certificate_=new S(a),this.privateKeyBag_=b):this.wireDecode(a)};s.SafeBag=Tc;Tc.prototype.getCertificate=function(){return this.certificate_};Tc.prototype.getPrivateKeyBag=function(){return this.privateKeyBag_};
Tc.prototype.wireDecode=function(a){"object"===typeof a&&a instanceof m&&(a=a.buf());a=new pa(a);var b=a.readNestedTlvsStart(q.SafeBag_SafeBag),c=a.getOffset(),g=a.readNestedTlvsStart(q.Data);a.seek(g);this.certificate_=new S;this.certificate_.wireDecode(a.getSlice(c,g),hb.get());this.privateKeyBag_=new m(a.readBlobTlv(q.SafeBag_EncryptedKeyBag),!0);a.finishNestedTlvs(b)};Tc.prototype.wireEncode=function(){var a=new sa(256),b=a.getLength();a.writeBlobTlv(q.SafeBag_EncryptedKeyBag,this.privateKeyBag_.buf());
a.writeBuffer(this.certificate_.wireEncode(hb.get()).buf());a.writeTypeAndLength(q.SafeBag_SafeBag,a.getLength()-b);return new m(a.getOutput(),!1)};Tc.makeSelfSignedCertificate_=function(a,g,f,l,m,z){var y=new O,v=(new Date).getTime(),ab=new c(a);ab.append("self").appendVersion(v);y.setName(ab);y.getMetaInfo().setType(Ea.KEY);y.getMetaInfo().setFreshnessPeriod(36E5);ab=new Ba(f);y.setContent(ab.getKeyDer());f=new fb("","",new dc);b.complete(null,f.importPrivateKeyPromise_(a,g.buf(),l,!0));if(ab.getKeyType()==
ea.RSA)y.setSignature(new Ka);else if(ab.getKeyType()==ea.EC)y.setSignature(new Ya);else throw Error("Unsupported key type");g=y.getSignature();W.getFromSignature(g).setType(va.KEYNAME);W.getFromSignature(g).setKeyName(a);Fa.getFromSignature(g).setPeriod(v,v+63072E7);v=y.wireEncode(z);a=b.complete(null,f.signPromise(v.signedBuf(),a,m,!0));g.setSignature(a);y.wireEncode(z);return y};var c=a.Name,Sb=a.PibIdentity,ra=a.PibKey,Ha=a.DigestAlgorithm,Fa=a.ValidityPeriod,Z=function ye(a,b){this.validityPeriod_=
new Fa;if(void 0==a)this.reset(ye.SignerType.NULL),this.digestAlgorithm_=Ha.SHA256;else if(a instanceof ye)this.type_=a.type_,this.name_=new c(a.name_),this.identity_=a.identity_,this.key_=a.key_,this.digestAlgorithm_=a.digestAlgorithm_,this.validityPeriod_=new Fa(a.validityPeriod_);else if("number"===typeof a)this.reset(a),void 0!=b&&(this.name_=new c(b)),this.digestAlgorithm_=Ha.SHA256;else if(a instanceof Sb)this.digestAlgorithm_=Ha.SHA256,this.setPibIdentity(a);else if(a instanceof ra)this.digestAlgorithm_=
Ha.SHA256,this.setPibKey(a);else if("string"===typeof a){if(signingString=a,this.reset(ye.SignerType.NULL),this.digestAlgorithm_=Ha.SHA256,""!=signingString){var g=signingString.indexOf(":");if(0>g)throw Error("Invalid signing string cannot represent SigningInfo");var z=signingString.substring(0,g),g=signingString.substring(g+1);if("id"==z)g==ye.getDigestSha256Identity().toUri()?this.setSha256Signing():this.setSigningIdentity(new c(g));else if("key"==z)this.setSigningKeyName(new c(g));else if("cert"==
z)this.setSigningCertificateName(new c(g));else throw Error("Invalid signing string scheme");}}else throw Error("SigningInfo: Unrecognized type");};s.SigningInfo=Z;Z.SignerType=function(){};Z.SignerType.NULL=0;Z.SignerType.ID=1;Z.SignerType.KEY=2;Z.SignerType.CERT=3;Z.SignerType.SHA256=4;Z.prototype.setSigningIdentity=function(a){this.reset(Z.SignerType.ID);this.name_=new c(a);return this};Z.prototype.setSigningKeyName=function(a){this.reset(Z.SignerType.KEY);this.name_=new c(a);return this};Z.prototype.setSigningCertificateName=
function(a){this.reset(Z.SignerType.CERT);this.name_=new c(a);return this};Z.prototype.setSha256Signing=function(){this.reset(Z.SignerType.SHA256);this.digestAlgorithm_=Ha.SHA256;return this};Z.prototype.setPibIdentity=function(a){this.reset(Z.SignerType.ID);null!=a&&(this.name_=a.getName());this.identity_=a;return this};Z.prototype.setPibKey=function(a){this.reset(Z.SignerType.KEY);null!=a&&(this.name_=a.getName());this.key_=a;return this};Z.prototype.getSignerType=function(){return this.type_};
Z.prototype.getSignerName=function(){return this.name_};Z.prototype.getPibIdentity=function(){if(this.type_!=Z.SignerType.ID)throw Error("getPibIdentity: The signer type is not SignerType.ID");return this.identity_};Z.prototype.getPibKey=function(){if(this.type_!=Z.SignerType.KEY)throw Error("getPibKey: The signer type is not SignerType.KEY");return this.key_};Z.prototype.setDigestAlgorithm=function(a){this.digestAlgorithm_=a;return this};Z.prototype.getDigestAlgorithm=function(){return this.digestAlgorithm_};
Z.prototype.setValidityPeriod=function(a){this.validityPeriod_=new Fa(a);return this};Z.prototype.getValidityPeriod=function(){return this.validityPeriod_};Z.prototype.toString=function(){if(this.type_==Z.SignerType.NULL)return"";if(this.type_==Z.SignerType.ID)return"id:"+this.getSignerName().toUri();if(this.type_==Z.SignerType.KEY)return"key:"+this.getSignerName().toUri();if(this.type_==Z.SignerType.CERT)return"cert:"+this.getSignerName().toUri();if(this.type_==Z.SignerType.SHA256)return"id:"+Z.getDigestSha256Identity().toUri();
throw Error("Unknown signer type");};Z.getDigestSha256Identity=function(){return new c("/localhost/identity/digest-sha256")};Z.prototype.reset=function(a){if(a!=Z.SignerType.NULL&&a!=Z.SignerType.ID&&a!=Z.SignerType.KEY&&a!=Z.SignerType.CERT&&a!=Z.SignerType.SHA256)throw Error("SigningInfo: The signerType is not valid");this.type_=a;this.name_=new c;this.key_=this.identity_=null;this.validityPeriod_=new Fa};Fa=function ff(a,b){this.changeCount_=0;"object"===typeof a&&a instanceof ff?(validityPeriod=
a,this.notBefore_=validityPeriod.notBefore_,this.notAfter_=validityPeriod.notAfter_):void 0!=b?(notBefore=a,this.setPeriod(notBefore,b)):this.clear()};s.ValidityPeriod=Fa;Fa.prototype.hasPeriod=function(){return!(this.notBefore_===Number.MAX_VALUE&&this.notAfter_===-Number.MAX_VALUE)};Fa.prototype.getNotBefore=function(){return this.notBefore_};Fa.prototype.getNotAfter=function(){return this.notAfter_};Fa.prototype.clear=function(){this.notBefore_=Number.MAX_VALUE;this.notAfter_=-Number.MAX_VALUE;
++this.changeCount_};Fa.prototype.setPeriod=function(a,b){this.notBefore_=Math.round(1E3*Math.ceil(Math.round(a)/1E3));this.notAfter_=Math.round(1E3*Math.floor(Math.round(b)/1E3));++this.changeCount_;return this};Fa.prototype.isValid=function(a){void 0==a&&(a=Math.round(1E3*Math.ceil(Math.round((new Date).getTime())/1E3)));return this.notBefore_<=a&&a<=this.notAfter_};Fa.canGetFromSignature=function(a){return void 0!=a.constructor&&("Sha256WithRsaSignature"===a.constructor.name||"Sha256WithEcdsaSignature"===
a.constructor.name)};Fa.getFromSignature=function(a){if(void 0==a.constructor||"Sha256WithRsaSignature"!==a.constructor.name&&"Sha256WithEcdsaSignature"!==a.constructor.name)throw Error("ValidityPeriod.getFromSignature: Signature type does not have a ValidityPeriod");return a.getValidityPeriod()};Fa.prototype.getChangeCount=function(){return this.changeCount_};var X=a,b=a.SyncPromise,m=a.Blob,t=a.WireFormat,ea=a.KeyType,Ha=a.DigestAlgorithm,Hb=a.UseSubtleCrypto,O=a.CertificateV2,Ba=a.PublicKey,Ua=
function(){};s.VerificationHelpers=Ua;Ua.verifySignaturePromise=function(a,c,g,z,y){"boolean"===typeof z&&(y=z,z=void 0);a instanceof m&&(a=a.buf());c instanceof m&&(c=c.buf());if(!(g instanceof Ba))try{g instanceof m||(g=new m(g)),g=new Ba(g)}catch(v){return b.reject(Error("verifySignaturePromise: Error decoding public key DER: "+v))}void 0==z&&(z=Ha.SHA256);if(z==Ha.SHA256)if(g.getKeyType()==ea.RSA){if(Hb()&&!y){var ab={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};return crypto.subtle.importKey("spki",
g.getKeyDer().buf().buffer,ab,!0,["verify"]).then(function(z){return crypto.subtle.verify(ab,z,c,a)})}try{null===Ua.verifyUsesString_&&Ua.setVerifyUsesString_();for(var u=g.getKeyDer().buf().toString("base64"),A="-----BEGIN PUBLIC KEY-----\n",f=0;f<u.length;f+=64)A+=u.substr(f,64)+"\n";var A=A+"-----END PUBLIC KEY-----",ha=X.createVerify("RSA-SHA256");ha.update(a);var l=Ua.verifyUsesString_?c.toString("binary"):c;return b.resolve(ha.verify(A,l))}catch(q){return b.reject(Error("verifySignaturePromise: Error is RSA verify: "+
q))}}else if(g.getKeyType()==ea.EC)try{null===Ua.verifyUsesString_&&Ua.setVerifyUsesString_();u=g.getKeyDer().buf().toString("base64");A="-----BEGIN PUBLIC KEY-----\n";for(f=0;f<u.length;f+=64)A+=u.substr(f,64)+"\n";A+="-----END PUBLIC KEY-----";ha=X.createVerify("sha256");ha.update(a);l=Ua.verifyUsesString_?c.toString("binary"):c;return b.resolve(ha.verify(A,l))}catch(t){return b.reject(Error("verifySignaturePromise: Error is ECDSA verify: "+t))}else return b.reject(Error("verifySignaturePromise: Invalid key type"));
else return b.reject(Error("verifySignaturePromise: Invalid digest algorithm"))};Ua.verifySignature=function(a,c,g,z,y,v){"function"===typeof z&&(v=y,y=z,z=void 0);return b.complete(y,v,this.verifySignaturePromise(a,c,g,z,!y))};Ua.verifyDataSignaturePromise=function(a,c,g,z,y){var v=g,ab=z;g="number"===typeof v?v:void 0;z=v instanceof t?v:ab instanceof t?ab:void 0;y="boolean"===typeof v?v:"boolean"===typeof ab?ab:"boolean"===typeof y?y:!1;var u;if(c instanceof O)try{u=c.getPublicKey()}catch(A){return b.resolve(!1)}else u=
c;c=a.wireEncode(z);return Ua.verifySignaturePromise(c.signedBuf(),a.getSignature().getSignature(),u,g,y)};Ua.verifyInterestSignaturePromise=function(a,c,g,z,y){var v=g,ab=z;g="number"===typeof v?v:void 0;z=v instanceof t?v:ab instanceof t?ab:void 0;y="boolean"===typeof v?v:"boolean"===typeof ab?ab:"boolean"===typeof y?y:!1;var u;if(c instanceof O)try{u=c.getPublicKey()}catch(A){return b.resolve(!1)}else u=c;void 0==z&&(z=t.getDefaultWireFormat());c=Ua.extractSignature_(a,z);if(null==c)return b.resolve(!1);
a=a.wireEncode(z);return Ua.verifySignaturePromise(a.signedBuf(),c.getSignature(),u,g,y)};Ua.verifyDigest=function(a,b,c){a instanceof m&&(a=a.buf());b instanceof m&&(b=b.buf());if(c==Ha.SHA256){c=X.createHash("sha256");c.update(a);a=c.digest();if(b.length!=a.length)return!1;for(c=0;c<b.length;++c)if(b[c]!=a[c])return!1;return!0}throw Error("verifyDigest: Invalid digest algorithm");};Ua.extractSignature_=function(a,b){if(2>a.getName().size())return null;try{return b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf(),!1)}catch(c){return null}};Ua.verifyUsesString_=null;Ua.setVerifyUsesString_=function(){var a=X.createHash("sha256").digest();Ua.verifyUsesString_="string"===typeof a};var xd=a.constants,X=a,m=a.Blob,l=a.DerNode,x=a.SecurityException,Lc=a.UnrecognizedKeyFormatException,ea=a.KeyType,fa=a.EncryptAlgorithmType,b=a.SyncPromise,Hb=a.UseSubtleCrypto,Ha=a.DigestAlgorithm,Ba=function Se(a){if(a){this.keyDer=a;var z=null;try{var b=l.parse(a.buf(),0).getChildren(),z=l.getSequence(b,
0).getChildren()[0].toVal()}catch(v){throw new Lc(Error("PublicKey.decodeKeyType: Error decoding the public key: "+v.message));}z==Se.RSA_ENCRYPTION_OID?this.keyType=ea.RSA:z==Se.EC_ENCRYPTION_OID&&(this.keyType=ea.EC)}else this.keyDer=new m,this.keyType=null};s.PublicKey=Ba;Ba.prototype.toDer=function(){return l.parse(this.keyDer.buf())};Ba.prototype.getKeyType=function(){return this.keyType};Ba.prototype.getDigest=function(a){void 0==a&&(a=Ha.SHA256);if(a==Ha.SHA256)return a=X.createHash("sha256"),
a.update(this.keyDer.buf()),new m(a.digest(),!1);throw new x(Error("Wrong format!"));};Ba.prototype.getKeyDer=function(){return this.keyDer};Ba.prototype.encryptPromise=function(a,c,z){"object"===typeof a&&a instanceof m&&(a=a.buf());if(Hb()&&!z&&c!=fa.RsaPkcs)return c==fa.RsaOaep?this.keyType!=ea.RSA?Promise.reject(Error("The key type must be RSA")):crypto.subtle.importKey("spki",this.keyDer.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["encrypt"]).then(function(z){return crypto.subtle.encrypt({name:"RSA-OAEP"},
z,a)}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));var y=this.keyDer.buf().toString("base64");z="-----BEGIN PUBLIC KEY-----\n";for(var v=0;v<y.length;v+=64)z+=y.substr(v,64)+"\n";z+="-----END PUBLIC KEY-----";if(c==fa.RsaPkcs){if(this.keyType!=ea.RSA)return b.reject(Error("The key type must be RSA"));c=xd.RSA_PKCS1_PADDING}else if(c==fa.RsaOaep){if(this.keyType!=ea.RSA)return b.reject(Error("The key type must be RSA"));
c=xd.RSA_PKCS1_OAEP_PADDING}else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new m(X.publicEncrypt({key:z,padding:c},a),!1))}catch(ab){return b.reject(ab)}};Ba.prototype.encrypt=function(a,c){return b.getValue(this.encryptPromise(a,c,!0))};Ba.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";Ba.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var l=a.DerNode,nb=a.OID,yd=function(a,b,z){this.extensionId="string"===typeof a?new nb(a):a;this.isCritical=b;this.extensionValue=z};s.CertificateExtension=
yd;yd.prototype.toDer=function(){var a=new l.DerSequence,b=new l.DerOid(this.extensionId),z=new l.DerBoolean(this.isCritical),y=new l.DerOctetString(this.extensionValue.buf());a.addChild(b);a.addChild(z);a.addChild(y);a.getSize();return a};yd.prototype.toDerBlob=function(){return this.toDer().encode()};yd.prototype.getOid=function(){return this.extensionId};yd.prototype.getIsCritical=function(){return this.isCritical};yd.prototype.getValue=function(){return this.extensionValue};var m=a.Blob,nb=a.OID,
l=a.DerNode,ld=function(a,b){this.oid="string"===typeof a?new nb(a):a;this.value=b};s.CertificateSubjectDescription=ld;ld.prototype.toDer=function(){var a=new l.DerSequence,b=new l.DerOid(this.oid),z=new l.DerPrintableString((new m(this.value)).buf());a.addChild(b);a.addChild(z);return a};ld.prototype.getOidString=function(){return this.oid.toString()};ld.prototype.getValue=function(){return this.value};var S=a.Data,Ea=a.ContentType,t=a.WireFormat,l=a.DerNode,ea=a.KeyType,Ba=a.PublicKey,ld=a.CertificateSubjectDescription,
yd=a.CertificateExtension,Ca=function(a){void 0!=a?S.call(this,a):S.call(this);this.subjectDescriptionList=[];this.extensionList=[];this.notBefore=Number.MAX_VALUE;this.notAfter=-Number.MAX_VALUE;this.key=new Ba;void 0!=a&&this.decode()};Ca.prototype=new S;Ca.prototype.name="Certificate";s.Certificate=Ca;Ca.prototype.encode=function(){var a=this.toDer();this.setContent(a.encode());this.getMetaInfo().setType(Ea.KEY)};Ca.prototype.addSubjectDescription=function(a){this.subjectDescriptionList.push(a)};
Ca.prototype.getSubjectDescriptionList=function(){return this.subjectDescriptionList};Ca.prototype.addExtension=function(a){this.extensionList.push(a)};Ca.prototype.getExtensionList=function(){return this.extensionList};Ca.prototype.setNotBefore=function(a){this.notBefore=a};Ca.prototype.getNotBefore=function(){return this.notBefore};Ca.prototype.setNotAfter=function(a){this.notAfter=a};Ca.prototype.getNotAfter=function(){return this.notAfter};Ca.prototype.setPublicKeyInfo=function(a){this.key=a};
Ca.prototype.getPublicKeyInfo=function(){return this.key};Ca.prototype.getPublicKeyDer=function(){if(this.key.getKeyDer().isNull())throw Error("The public key is not set");return this.key.getKeyDer()};Ca.prototype.isTooEarly=function(){return(new Date).getTime()<this.getNotBefore()};Ca.prototype.isTooLate=function(){return(new Date).getTime()>this.getNotAfter()};Ca.prototype.isInValidityPeriod=function(a){return this.getSignature().getValidityPeriod().isValid(a)};Ca.prototype.toDer=function(){var a=
new l.DerSequence,b=new l.DerSequence,z=new l.DerGeneralizedTime(this.getNotBefore()),y=new l.DerGeneralizedTime(this.getNotAfter());b.addChild(z);b.addChild(y);a.addChild(b);z=new l.DerSequence;for(b=0;b<this.subjectDescriptionList.length;++b)z.addChild(this.subjectDescriptionList[b].toDer());a.addChild(z);a.addChild(this.key.toDer());if(0<this.extensionList.length){z=new l.DerSequence;for(b=0;b<this.extensionList.length;++b)z.addChild(this.extensionList[b].toDer());a.addChild(z)}return a};Ca.prototype.decode=
function(){var a=l.parse(this.getContent().buf()).getChildren(),b=l.getSequence(a,0).getChildren();this.notBefore=b[0].toVal();this.notAfter=b[1].toVal();for(var z=l.getSequence(a,1).getChildren(),b=0;b<z.length;++b){var y=l.getSequence(z,b).getChildren(),v=y[0].toVal(),y=y[1].toVal().buf().toString("binary");this.addSubjectDescription(new ld(v,y))}b=a[2].encode();this.key=new Ba(b);if(3<a.length)for(a=l.getSequence(a,3).getChildren(),b=0;b<a.length;++b)y=l.getSequence(a,b).getChildren(),v=y[0].toVal(),
z=y[1].toVal(),y=y[2].toVal(),this.addExtension(new yd(v,z,y))};Ca.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();S.prototype.wireDecode.call(this,a,b);this.decode()};Ca.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";var b=Ca.toIsoString(Math.round(this.getNotBefore())),z=Ca.toIsoString(Math.round(this.getNotAfter()));a=a+("  NotBefore: "+b+"\n")+("  NotAfter: "+z+"\n");for(b=0;b<this.subjectDescriptionList.length;++b)z=
this.subjectDescriptionList[b],a+="Subject Description:\n",a+="  "+z.getOidString()+": "+z.getValue()+"\n";a+="Public key bits:\n";z=this.getPublicKeyDer().buf().toString("base64");for(b=0;b<z.length;b+=64)a+=z.substring(b,Math.min(b+64,z.length))+"\n";if(0<this.extensionList.length)for(a+="Extensions:\n",b=0;b<this.extensionList.length;++b)z=this.extensionList[b],a+="  OID: "+z.getOid()+"\n",a+="  Is critical: "+(z.getIsCritical()?"Y":"N")+"\n",a+="  Value: "+z.getValue().toHex()+"\n";return a};
Ca.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+Ca.to2DigitString(a.getUTCMonth()+1)+Ca.to2DigitString(a.getUTCDate())+"T"+Ca.to2DigitString(a.getUTCHours())+Ca.to2DigitString(a.getUTCMinutes())+Ca.to2DigitString(a.getUTCSeconds())};Ca.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};var S=a.Data,c=a.Name,x=a.SecurityException,Ca=a.Certificate,t=a.WireFormat,Oa=function Te(a){void 0!=a?Ca.call(this,a):Ca.call(this);this.publicKeyName=new c;if(a instanceof
Te)this.publicKeyName=new c(a.publicKeyName);else if(a instanceof S){if(!Te.isCorrectName(a.getName()))throw new x(Error("Wrong Identity Certificate Name!"));this.setPublicKeyName()}};Oa.prototype=new Ca;Oa.prototype.name="IdentityCertificate";s.IdentityCertificate=Oa;Oa.prototype.setName=function(a){if(!Oa.isCorrectName(a))throw new x(Error("Wrong Identity Certificate Name!"));Ca.prototype.setName.call(this,a);this.setPublicKeyName();return this};Oa.prototype.wireDecode=function(a,z){z=z||t.getDefaultWireFormat();
Ca.prototype.wireDecode.call(this,a,z);this.setPublicKeyName()};Oa.prototype.getPublicKeyName=function(){return this.publicKeyName};Oa.isIdentityCertificate=function(a){return Oa.isCorrectName(a.getName())};Oa.certificateNameToPublicKeyName=function(a){for(var z=!1,b=a.size()-1;0<b+1;--b)if("ID-CERT"==a.get(b).toEscapedString()){z=!0;break}if(!z)throw Error("Incorrect identity certificate name "+a.toUri());for(var z=a.getSubName(0,b),b=!1,v=0;v<z.size();v++)if("KEY"==z.get(v).toEscapedString()){b=
!0;break}if(!b)throw Error("Incorrect identity certificate name "+a.toUri());return z.getSubName(0,v).append(z.getSubName(v+1,z.size()-v-1))};Oa.isCorrectName=function(a){for(var z=a.size()-1;0<=z&&"ID-CERT"!=a.get(z).toEscapedString();z--);if(0>z)return!1;for(z=0;z<a.size()&&"KEY"!=a.get(z).toEscapedString();z++);return z>=a.size()?!1:!0};Oa.prototype.setPublicKeyName=function(){this.publicKeyName=Oa.certificateNameToPublicKeyName(this.getName())};var c=a.Name,x=a.SecurityException,b=a.SyncPromise,
ba=function(){};s.IdentityStorage=ba;ba.prototype.doesIdentityExistPromise=function(a,z){return b.reject(Error("IdentityStorage.doesIdentityExistPromise is not implemented"))};ba.prototype.doesIdentityExist=function(a){return b.getValue(this.doesIdentityExistPromise(a,!0))};ba.prototype.addIdentityPromise=function(a,z){return b.reject(Error("IdentityStorage.addIdentityPromise is not implemented"))};ba.prototype.addIdentity=function(a){return b.getValue(this.addIdentityPromise(a,!0))};ba.prototype.revokeIdentity=
function(){return b.reject(Error("IdentityStorage.revokeIdentity is not implemented"))};ba.prototype.getNewKeyNamePromise=function(a,z,y){for(var v=Math.floor((new Date).getTime()/1E3);v<=ba.lastTimestamp;)v+=1;ba.lastTimestamp=v;v=""+v;z=z?"ksk-"+v:"dsk-"+v;var ab=(new c(a)).append(z);return this.doesKeyExistPromise(ab,y).then(function(a){if(a)throw new x(Error("Key name already exists"));return b.resolve(ab)})};ba.prototype.getNewKeyName=function(a,z){return b.getValue(this.getNewKeyNamePromise(a,
z,!0))};ba.prototype.doesKeyExistPromise=function(a,z){return b.reject(Error("IdentityStorage.doesKeyExistPromise is not implemented"))};ba.prototype.doesKeyExist=function(a){return b.getValue(this.doesKeyExistPromise(a,!0))};ba.prototype.addKeyPromise=function(a,z,y,v){return b.reject(Error("IdentityStorage.addKeyPromise is not implemented"))};ba.prototype.addKey=function(a,z,y){return b.getValue(this.addKeyPromise(a,z,y,!0))};ba.prototype.getKeyPromise=function(a,z){return b.reject(Error("IdentityStorage.getKeyPromise is not implemented"))};
ba.prototype.getKey=function(a){return b.getValue(this.getKeyPromise(a,!0))};ba.prototype.activateKey=function(a){throw Error("IdentityStorage.activateKey is not implemented");};ba.prototype.deactivateKey=function(a){throw Error("IdentityStorage.deactivateKey is not implemented");};ba.prototype.doesCertificateExistPromise=function(a,z){return b.reject(Error("IdentityStorage.doesCertificateExistPromise is not implemented"))};ba.prototype.doesCertificateExist=function(a){return b.getValue(this.doesCertificateExistPromise(a,
!0))};ba.prototype.addCertificatePromise=function(a,z){return b.reject(Error("IdentityStorage.addCertificatePromise is not implemented"))};ba.prototype.addCertificate=function(a){return b.getValue(this.addCertificatePromise(a,!0))};ba.prototype.getCertificatePromise=function(a,z){return b.reject(Error("IdentityStorage.getCertificatePromise is not implemented"))};ba.prototype.getCertificate=function(a){return b.getValue(this.getValuePromise(a,!0))};ba.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("IdentityStorage.getTpmLocatorPromise is not implemented"))};
ba.prototype.getTpmLocator=function(){return b.getValue(this.getTpmLocatorPromise(!0))};ba.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("IdentityStorage.getDefaultIdentityPromise is not implemented"))};ba.prototype.getDefaultIdentity=function(){return b.getValue(this.getDefaultIdentityPromise(!0))};ba.prototype.getDefaultKeyNameForIdentityPromise=function(a,z){return b.reject(Error("IdentityStorage.getDefaultKeyNameForIdentityPromise is not implemented"))};ba.prototype.getDefaultKeyNameForIdentity=
function(a){return b.getValue(this.getDefaultKeyNameForIdentityPromise(a,!0))};ba.prototype.getDefaultCertificateNameForIdentityPromise=function(a,z){var b=this;return this.getDefaultKeyNameForIdentityPromise(a).then(function(a){return b.getDefaultCertificateNameForKeyPromise(a)})};ba.prototype.getDefaultCertificateNameForIdentity=function(a){return b.getValue(this.getDefaultCertificateNameForIdentityPromise(a,!0))};ba.prototype.getDefaultCertificateNameForKeyPromise=function(a,z){return b.reject(Error("IdentityStorage.getDefaultCertificateNameForKeyPromise is not implemented"))};
ba.prototype.getDefaultCertificateNameForKey=function(a){return b.getValue(this.getDefaultCertificateNameForKeyPromise(a,!0))};ba.prototype.getAllIdentitiesPromise=function(a,z,y){return b.reject(Error("IdentityStorage.getAllIdentitiesPromise is not implemented"))};ba.prototype.getAllKeyNamesOfIdentityPromise=function(a,z,y,v){return b.reject(Error("IdentityStorage.getAllKeyNamesOfIdentityPromise is not implemented"))};ba.prototype.getAllCertificateNamesOfKeyPromise=function(a,z,y,v){return b.reject(Error("IdentityStorage.getAllCertificateNamesOfKeyPromise is not implemented"))};
ba.prototype.getAllKeyNamesOfIdentity=function(a,z,y){return b.getValue(this.getAllKeyNamesOfIdentityPromise(a,z,y,!0))};ba.prototype.setDefaultIdentityPromise=function(a,z){return b.reject(Error("IdentityStorage.setDefaultIdentityPromise is not implemented"))};ba.prototype.setDefaultIdentity=function(a){return b.getValue(this.setDefaultIdentityPromise(a,!0))};ba.prototype.setDefaultKeyNameForIdentityPromise=function(a,z,y){return b.reject(Error("IdentityStorage.setDefaultKeyNameForIdentityPromise is not implemented"))};
ba.prototype.setDefaultKeyNameForIdentity=function(a,z){return b.getValue(this.setDefaultKeyNameForIdentityPromise(a,z,!0))};ba.prototype.setDefaultCertificateNameForKeyPromise=function(a,z,y){return b.reject(Error("IdentityStorage.setDefaultCertificateNameForKeyPromise is not implemented"))};ba.prototype.setDefaultCertificateNameForKey=function(a,z){return b.getValue(this.setDefaultCertificateNameForKeyPromise(a,z,!0))};ba.prototype.getDefaultCertificatePromise=function(a){var z=this;return this.getDefaultIdentityPromise(a).then(function(b){return z.getDefaultCertificateNameForIdentityPromise(b,
a)},function(a){return b.resolve(null)}).then(function(y){return null==y?b.resolve(null):z.getCertificatePromise(y,a)})};ba.prototype.getDefaultCertificate=function(){return b.getValue(this.getDefaultCertificatePromise(!0))};ba.prototype.deleteCertificateInfoPromise=function(a,z){return b.reject(Error("IdentityStorage.deleteCertificateInfoPromise is not implemented"))};ba.prototype.deleteCertificateInfo=function(a){return b.getValue(this.deleteCertificateInfoPromise(a,!0))};ba.prototype.deletePublicKeyInfoPromise=
function(a,z){return b.reject(Error("IdentityStorage.deletePublicKeyInfoPromise is not implemented"))};ba.prototype.deletePublicKeyInfo=function(a){return b.getValue(this.deletePublicKeyInfoPromise(a,!0))};ba.prototype.deleteIdentityInfoPromise=function(a,z){return b.reject(Error("IdentityStorage.deleteIdentityInfoPromise is not implemented"))};ba.prototype.deleteIdentityInfo=function(a){return b.getValue(this.deleteIdentityInfoPromise(a,!0))};ba.lastTimestamp=Math.floor((new Date).getTime()/1E3);
new ba;var c=a.Name,m=a.Blob,x=a.SecurityException,Oa=a.IdentityCertificate,b=a.SyncPromise,ba=a.IdentityStorage,Ab=function(){ba.call(this);this.identityStore={};this.defaultIdentity="";this.keyStore={};this.certificateStore={}};Ab.prototype=new ba;Ab.prototype.name="MemoryIdentityStorage";s.MemoryIdentityStorage=Ab;Ab.prototype.doesIdentityExistPromise=function(a){return b.resolve(void 0!==this.identityStore[a.toUri()])};Ab.prototype.addIdentityPromise=function(a){a=a.toUri();void 0===this.identityStore[a]&&
(this.identityStore[a]={defaultKey:null});return b.resolve()};Ab.prototype.doesKeyExistPromise=function(a){return b.resolve(void 0!==this.keyStore[a.toUri()])};Ab.prototype.addKeyPromise=function(a,z,y){if(0===a.size()||this.doesKeyExist(a))return b.resolve();var v=a.getSubName(0,a.size()-1);this.addIdentity(v);this.keyStore[a.toUri()]={keyType:z,keyDer:new m(y),defaultCertificate:null};return b.resolve()};Ab.prototype.getKeyPromise=function(a){if(0===a.size())return b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: Empty keyName")));
a=a.toUri();a=this.keyStore[a];return void 0===a?b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: The key does not exist"))):b.resolve(a.keyDer)};Ab.prototype.doesCertificateExistPromise=function(a){return b.resolve(void 0!==this.certificateStore[a.toUri()])};Ab.prototype.addCertificatePromise=function(a){var z=a.getName(),y=a.getPublicKeyName();this.addKey(y,a.getPublicKeyInfo().getKeyType(),a.getPublicKeyInfo().getKeyDer());if(this.doesCertificateExist(z))return b.resolve();this.certificateStore[z.toUri()]=
a.wireEncode();return b.resolve()};Ab.prototype.getCertificatePromise=function(a){a=a.toUri();if(void 0===this.certificateStore[a])return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate does not exist")));var z=new Oa;try{z.wireDecode(this.certificateStore[a])}catch(y){return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate cannot be decoded")))}return b.resolve(z)};ba.prototype.getTpmLocatorPromise=function(a){return b.resolve("tpm-memory:")};
Ab.prototype.getDefaultIdentityPromise=function(){return 0===this.defaultIdentity.length?b.reject(new x(Error("MemoryIdentityStorage.getDefaultIdentity: The default identity is not defined"))):b.resolve(new c(this.defaultIdentity))};Ab.prototype.getDefaultKeyNameForIdentityPromise=function(a){a=a.toUri();return void 0!==this.identityStore[a]?null!=this.identityStore[a].defaultKey?b.resolve(this.identityStore[a].defaultKey):b.reject(new x(Error("No default key set."))):b.reject(new x(Error("Identity not found.")))};
Ab.prototype.getDefaultCertificateNameForKeyPromise=function(a){a=a.toUri();return void 0!==this.keyStore[a]?null!=this.keyStore[a].defaultCertificate?b.resolve(this.keyStore[a].defaultCertificate):b.reject(new x(Error("No default certificate set."))):b.reject(new x(Error("Key not found.")))};Ab.prototype.setDefaultIdentityPromise=function(a){a=a.toUri();this.defaultIdentity=void 0!==this.identityStore[a]?a:"";return b.resolve()};Ab.prototype.setDefaultKeyNameForIdentityPromise=function(a,z){z=z instanceof
c?z:null;var y=a.getPrefix(-1);if(null!=z&&0<z.size()&&!z.equals(y))return b.reject(new x(Error("The specified identity name does not match the key name")));y=y.toUri();void 0!==this.identityStore[y]&&(this.identityStore[y].defaultKey=new c(a));return b.resolve()};Ab.prototype.setDefaultCertificateNameForKeyPromise=function(a,z){var y=a.toUri();void 0!==this.keyStore[y]&&(this.keyStore[y].defaultCertificate=new c(z));return b.resolve()};Ab.prototype.deleteCertificateInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteCertificateInfoPromise is not implemented"))};
Ab.prototype.deletePublicKeyInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deletePublicKeyInfoPromise is not implemented"))};Ab.prototype.deleteIdentityInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteIdentityInfoPromise is not implemented"))};var b=a.SyncPromise,l=a.DerNode,ta=function(){};s.PrivateKeyStorage=ta;ta.prototype.generateKeyPairPromise=function(a,z,y){return b.reject(Error("PrivateKeyStorage.generateKeyPairPromise is not implemented"))};
ta.prototype.generateKeyPair=function(a,z){b.getValue(this.generateKeyPairPromise(a,z,!0))};ta.prototype.deleteKeyPairPromise=function(a,z){return b.reject(Error("PrivateKeyStorage.deleteKeyPairPromise is not implemented"))};ta.prototype.deleteKeyPair=function(a){b.getValue(this.deleteKeyPairPromise(a,!0))};ta.prototype.getPublicKeyPromise=function(a,z){return b.reject(Error("PrivateKeyStorage.getPublicKeyPromise is not implemented"))};ta.prototype.getPublicKey=function(a){return b.getValue(this.getPublicKeyPromise(a,
!0))};ta.prototype.signPromise=function(a,z,y,v){return b.reject(Error("PrivateKeyStorage.sign is not implemented"))};ta.prototype.sign=function(a,z,y){return b.getValue(this.signPromise(a,z,y,!0))};ta.prototype.decrypt=function(a,z,b){throw Error("PrivateKeyStorage.decrypt is not implemented");};ta.prototype.encrypt=function(a,z,b){throw Error("PrivateKeyStorage.encrypt is not implemented");};ta.prototype.generateKey=function(a,z){throw Error("PrivateKeyStorage.generateKey is not implemented");};
ta.prototype.doesKeyExistPromise=function(a,z,y){return b.reject(Error("PrivateKeyStorage.doesKeyExist is not implemented"))};ta.prototype.doesKeyExist=function(a,z){return b.getValue(this.doesKeyExistPromise(a,z,!0))};ta.encodePkcs8PrivateKey=function(a,z,b){var v=new l.DerSequence;v.addChild(new l.DerOid(z));v.addChild(b);z=new l.DerSequence;z.addChild(new l.DerInteger(0));z.addChild(v);z.addChild(new l.DerOctetString(a));return z.encode()};ta.encodePkcs1PrivateKeyFromRSAKey=function(a){var z=new l.DerSequence;
z.addChild(new l.DerInteger(0));z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.n)));z.addChild(new l.DerInteger(a.e));z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.d)));z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.p)));z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.q)));z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.dmp1)));z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.dmq1)));z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.coeff)));return z.encode()};ta.encodePublicKeyFromRSAKey=
function(a){var z=new l.DerSequence;z.addChild(new l.DerInteger(ta.bigIntegerToBuffer(a.n)));z.addChild(new l.DerInteger(a.e));a=new l.DerSequence;a.addChild(new l.DerOid(new nb(ta.RSA_ENCRYPTION_OID)));a.addChild(new l.DerNull);var b=new l.DerSequence;b.addChild(a);b.addChild(new l.DerBitString(z.encode().buf(),0));return b.encode()};ta.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("PrivateKeyStorage.bigIntegerToBuffer: Negative integers are not currently supported");
1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new f(a,"hex")};ta.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";ta.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var X=a,m=a.Blob,x=a.SecurityException,Ba=a.PublicKey,jd=a.KeyClass,ea=a.KeyType,Ha=a.DigestAlgorithm,M=a.DataUtils,ta=a.PrivateKeyStorage,l=a.DerNode,nb=a.OID,b=a.SyncPromise,Hb=a.UseSubtleCrypto,Ec=null;try{Ec=a}catch(mf){}var Fc=function(){ta.call(this);this.publicKeyStore={};this.privateKeyStore={}};Fc.prototype=new ta;Fc.prototype.name=
"MemoryPrivateKeyStorage";s.MemoryPrivateKeyStorage=Fc;Fc.prototype.setPublicKeyForKeyName=function(a,z,b){this.publicKeyStore[a.toUri()]=new Ba(new m(b,!0))};Fc.prototype.setPrivateKeyForKeyName=function(a,z,b){b=b.toString("base64");var v;if(z===ea.RSA){v="-----BEGIN RSA PRIVATE KEY-----\n";for(var c=0;c<b.length;c+=64)v+=b.substr(c,64)+"\n";v+="-----END RSA PRIVATE KEY-----"}else if(z===ea.EC){v="-----BEGIN EC PRIVATE KEY-----\n";for(c=0;c<b.length;c+=64)v+=b.substr(c,64)+"\n";v+="-----END EC PRIVATE KEY-----"}else throw new x(Error("MemoryPrivateKeyStorage: KeyType is not supported"));
this.privateKeyStore[a.toUri()]={keyType:z,privateKey:v}};Fc.prototype.setKeyPairForKeyName=function(a,z,b,v){this.setPublicKeyForKeyName(a,z,b);this.setPrivateKeyForKeyName(a,z,v)};Fc.prototype.generateKeyPairPromise=function(a,z,y){if(this.doesKeyExist(a,jd.PUBLIC))return b.reject(new x(Error("Public key already exists")));if(this.doesKeyExist(a,jd.PRIVATE))return b.reject(new x(Error("Private key already exists")));var v=this;if(Hb()&&!y){if(z.getKeyType()===ea.RSA){var c=null,u=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",
modulusLength:z.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){c=a.privateKey;return crypto.subtle.exportKey("spki",a.publicKey)}).then(function(a){u=(new m(new Uint8Array(a),!1)).buf();return crypto.subtle.exportKey("pkcs8",c)}).then(function(b){b=l.parse((new m(new Uint8Array(b),!1)).buf()).getChildren()[2].toVal();v.setKeyPairForKeyName(a,z.getKeyType(),u,b.buf());v.privateKeyStore[a.toUri()].subtleKey=c;return Promise.resolve()})}return b.reject(new x(Error("Only RSA key generation currently supported")))}return b.resolve().then(function(){if("undefined"!==
typeof C)if(z.getKeyType()===ea.RSA){var y=new C;y.generate(z.getKeySize(),"010001");v.setKeyPairForKeyName(a,z.getKeyType(),ta.encodePublicKeyFromRSAKey(y).buf(),ta.encodePkcs1PrivateKeyFromRSAKey(y).buf())}else return b.reject(new x(Error("Only RSA key generation currently supported")));else{var c;if(z.getKeyType()===ea.RSA){if(!Ec)return b.reject(new x(Error("Need to install rsa-keypair: sudo npm install rsa-keypair")));c=Ec.generate(z.getKeySize());y=c.publicKey.toString().replace("-----BEGIN PUBLIC KEY-----",
"").replace("-----END PUBLIC KEY-----","");y=new f(y,"base64");c=c.privateKey.toString()}else return b.reject(new x(Error("Only RSA key generation currently supported")));v.setPublicKeyForKeyName(a,z.getKeyType(),y);v.privateKeyStore[a.toUri()]={keyType:z.getKeyType(),privateKey:c}}return b.resolve()})};Fc.prototype.deleteKeyPairPromise=function(a){a=a.toUri();delete this.publicKeyStore[a];delete this.privateKeyStore[a];return b.resolve()};Fc.prototype.getPublicKeyPromise=function(a){var z=a.toUri(),
z=this.publicKeyStore[z];return void 0===z?b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find public key "+a.toUri()))):b.resolve(z)};Fc.prototype.signPromise=function(a,z,y,v){v="boolean"===typeof y?y:v;y="boolean"!==typeof y&&y?y:Ha.SHA256;if(y!=Ha.SHA256)return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unsupported digest algorithm")));z=z.toUri();var c=this.privateKeyStore[z];if(void 0===c)return b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find private key "+z)));if(Hb()&&
!v){var u={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};c.subtleKey?v=crypto.subtle.sign(u,c.subtleKey,a):(v=M.privateKeyPemToDer(c.privateKey),v=ta.encodePkcs8PrivateKey(v,new nb(ta.RSA_ENCRYPTION_OID),new l.DerNull).buf(),v=crypto.subtle.importKey("pkcs8",v.buffer,u,!0,["sign"]).then(function(z){c.subtleKey=z;return crypto.subtle.sign(u,z,a)}));return v.then(function(a){a=new m(new Uint8Array(a),!0);return Promise.resolve(a)})}if(c.keyType===ea.RSA)v=X.createSign("RSA-SHA256");else if(c.keyType===
ea.EC)v=X.createSign("sha256");else return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unrecognized private key type")));v.update(a);v=new f(M.toNumbersIfString(v.sign(c.privateKey)));v=new m(v,!1);return b.resolve(v)};Fc.prototype.doesKeyExistPromise=function(a,z){var y=a.toUri(),v=!1;z==jd.PUBLIC?v=void 0!==this.publicKeyStore[y]:z==jd.PRIVATE&&(v=void 0!==this.privateKeyStore[y]);return b.resolve(v)};X=a;new ta;var X=a,c=a.Name,S=a.Data,m=a.Blob,zd=a.ConfigFile,yb=a.DigestSha256Signature,
Ka=a.Sha256WithRsaSignature,Ya=a.Sha256WithEcdsaSignature,va=a.KeyLocatorType,t=a.WireFormat,x=a.SecurityException,Ha=a.DigestAlgorithm,ea=a.KeyType,cc=a.RsaKeyParams,Oa=a.IdentityCertificate,Ba=a.PublicKey,ld=a.CertificateSubjectDescription,b=a.SyncPromise,Me=a.BasicIdentityStorage,We=a.FilePrivateKeyStorage,la=function z(a,b){if(b){if(!a)throw Error("IdentityManager: A custom privateKeyStorage is supplied with a null identityStorage");this.identityStorage=a;this.privateKeyStorage=b}else{if(!zd)throw new x(Error("IdentityManager: If not in Node.js then you must supply identityStorage and privateKeyStorage."));
var c=new zd,u=[null],g=this;this.identityStorage=a?a:z.getDefaultIdentityStorage_(c,function(){return g.checkTpmPromise_(u[0])});this.privateKeyStorage=z.getDefaultPrivateKeyStorage_(c,u)}};s.IdentityManager=la;la.prototype.createIdentityAndCertificatePromise=function(a,y,v){var c=this,u=!0,g=null;return this.identityStorage.addIdentityPromise(a,v).then(function(){return c.identityStorage.getDefaultKeyNameForIdentityPromise(a,v).then(function(a){g=a;return c.identityStorage.getKeyPromise(g,v).then(function(a){(new Ba(a)).getKeyType()==
y.getKeyType()&&(u=!1);return b.resolve()})},function(a){if(!(a instanceof x))throw a;return b.resolve()})}).then(function(){return u?c.generateKeyPairPromise(a,!0,y,v).then(function(a){g=a;return c.identityStorage.setDefaultKeyNameForIdentityPromise(g,v)}):b.resolve()}).then(function(){return c.identityStorage.getDefaultCertificateNameForKeyPromise(g,v).then(function(a){return b.resolve(a)},function(a){if(!(a instanceof x))throw a;var z;return c.selfSignPromise(g,v).then(function(a){z=a.getName();
return c.addCertificateAsIdentityDefaultPromise(a,v)}).then(function(){return b.resolve(z)})})})};la.prototype.createIdentityAndCertificate=function(a,y,v,c){return b.complete(v,c,this.createIdentityAndCertificatePromise(a,y,!v))};la.prototype.createIdentity=function(a,b){return Oa.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,b))};la.prototype.deleteIdentity=function(a,y,v){var c=this,u=!0,g=this.identityStorage.getDefaultIdentityPromise(!y).then(function(y){y.equals(a)&&(u=
!1);return b.resolve()},function(a){return b.resolve()}).then(function(){if(!u)return b.resolve();var y=[];return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,y,!0).then(function(){return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,y,!1)}).then(function(){return c.identityStorage.deleteIdentityInfoPromise(a)}).then(function(){function a(z){return z>=y.length?b.resolve():c.privateKeyStorage.deleteKeyPairPromise(y[z]).then(function(){return a(z+1)})}return a(0)})});return b.complete(y,
v,g)};la.prototype.setDefaultIdentityPromise=function(a,b){return this.identityStorage.setDefaultIdentityPromise(a,b)};la.prototype.setDefaultIdentity=function(a,y,v){return b.complete(y,v,this.identityStorage.setDefaultIdentityPromise(a,!y))};la.prototype.getDefaultIdentityPromise=function(a){return this.identityStorage.getDefaultIdentityPromise(a)};la.prototype.getDefaultIdentity=function(a,y){return b.complete(a,y,this.identityStorage.getDefaultIdentityPromise(!a))};la.prototype.getDefaultCertificatePromise=
function(a){return this.identityStorage.getDefaultCertificatePromise(a)};la.prototype.generateRSAKeyPair=function(a,y,v){return b.getValue(this.generateKeyPairPromise(a,y,new cc(v),!0))};la.prototype.setDefaultKeyForIdentity=function(a,y,v,g){g="function"===typeof y?v:g;v="function"===typeof y?y:v;y="function"!==typeof y&&y?y:new c;return b.complete(v,g,this.identityStorage.setDefaultKeyNameForIdentityPromise(a,y,!v))};la.prototype.getDefaultKeyNameForIdentity=function(a,y,v){return b.complete(y,
v,this.identityStorage.getDefaultKeyNameForIdentityPromise(a,!y))};la.prototype.generateRSAKeyPairAsDefaultPromise=function(a,y,v,c){var u,g=this;return this.generateKeyPairPromise(a,y,new cc(v)).then(function(a){u=a;return g.identityStorage.setDefaultKeyNameForIdentityPromise(u)}).then(function(){return b.resolve(u)})};la.prototype.generateRSAKeyPairAsDefault=function(a,y,v){return b.getValue(this.generateRSAKeyPairAsDefaultPromise(a,y,v,!0))};la.prototype.getPublicKey=function(a,y,v){return b.complete(y,
v,this.identityStorage.getKeyPromise(a,!y).then(function(a){return b.resolve(new Ba(a))}))};la.prototype.prepareUnsignedIdentityCertificate=function(a,y,v,g,u,A,f,ha,l){y instanceof Ba||(l=ha,ha=f,f=A,A=u,u=g,g=v,v=y,y=null);var m=f,q=ha;f=m instanceof c?m:null;"function"===typeof m?(ha=m,l=q):"function"===typeof q?ha=q:l=ha=null;a=null==y?this.prepareUnsignedIdentityCertificatePromise(a,v,g,u,A,f,!ha):this.prepareUnsignedIdentityCertificatePromise(a,y,v,g,u,A,f,!ha);return b.complete(ha,l,a)};la.prototype.prepareUnsignedIdentityCertificatePromise=
function(a,y,v,g,u,A,f,ha){y instanceof Ba||(ha=f,f=A,A=u,u=g,g=v,v=y,y=null);var l=f;f=l instanceof c?l:null;return(null==y?this.identityStorage.getKeyPromise(a,"boolean"===typeof l?l:"boolean"===typeof ha?ha:!1).then(function(a){y=new Ba(a);return b.resolve()}):b.resolve()).then(function(){return b.resolve(la.prepareUnsignedIdentityCertificateHelper_(a,y,v,g,u,A,f))})};la.prepareUnsignedIdentityCertificateHelper_=function(a,b,v,g,u,A,f){if(1>a.size())return null;var ha=a.get(-1).toEscapedString();
if(4>ha.length)return null;keyIdPrefix=ha.substr(0,4);if("ksk-"!=keyIdPrefix&&"dsk-"!=keyIdPrefix)return null;var ha=new Oa,l=new c;if(null==f)v.match(a)?l.append(v).append("KEY").append(a.getSubName(v.size())).append("ID-CERT").appendVersion((new Date).getTime()):l.append(a.getPrefix(-1)).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion((new Date).getTime());else if(f.match(a)&&!f.equals(a))l.append(f).append("KEY").append(a.getSubName(f.size())).append("ID-CERT").appendVersion((new Date).getTime());
else return null;ha.setName(l);ha.setNotBefore(g);ha.setNotAfter(u);ha.setPublicKeyInfo(b);if(null==A||0===A.length)ha.addSubjectDescription(new ld("2.5.4.41",a.getPrefix(-1).toUri()));else for(a=0;a<A.length;++a)ha.addSubjectDescription(A[a]);try{ha.encode()}catch(m){throw x(Error("DerEncodingException: "+m));}return ha};la.prototype.addCertificate=function(a,y,v){return b.complete(y,v,this.identityStorage.addCertificatePromise(a,!y))};la.prototype.setDefaultCertificateForKeyPromise=function(a,b){var v=
this,c=a.getPublicKeyName();return this.identityStorage.doesKeyExistPromise(c,b).then(function(u){if(!u)throw new x(Error("No corresponding Key record for certificate!"));return v.identityStorage.setDefaultCertificateNameForKeyPromise(c,a.getName(),b)})};la.prototype.setDefaultCertificateForKey=function(a,y,v){return b.complete(y,v,this.setDefaultCertificateForKeyPromise(a,!y))};la.prototype.addCertificateAsIdentityDefaultPromise=function(a,b){var v=this;return this.identityStorage.addCertificatePromise(a,
b).then(function(){var c=a.getPublicKeyName();return v.identityStorage.setDefaultKeyNameForIdentityPromise(c,b)}).then(function(){return v.setDefaultCertificateForKeyPromise(a,b)})};la.prototype.addCertificateAsDefault=function(a,y,v){var c=!y,u=this;return b.complete(y,v,this.identityStorage.addCertificatePromise(a,c).then(function(){return u.setDefaultCertificateForKeyPromise(a,c)}))};la.prototype.getCertificate=function(a,y,v){return b.complete(y,v,this.identityStorage.getCertificatePromise(a,
!1,!y))};la.prototype.getDefaultCertificateNameForIdentityPromise=function(a,b){return this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,b)};la.prototype.getDefaultCertificateNameForIdentity=function(a,y,v){return b.complete(y,v,this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,!y))};la.prototype.getDefaultCertificateName=function(a,y){var v=!a,c=this;return b.complete(a,y,this.identityStorage.getDefaultIdentityPromise(v).then(function(a){return c.identityStorage.getDefaultCertificateNameForIdentityPromise(a,
v)}))};la.prototype.getAllIdentities=function(a,y,v,c){return b.complete(v,c,this.identityStorage.getAllIdentitiesPromise(a,y,!v))};la.prototype.getAllKeyNamesOfIdentity=function(a,y,v,c,u){return b.complete(c,u,this.identityStorage.getAllKeyNamesOfIdentityPromise(a,y,v,!c))};la.prototype.getAllCertificateNamesOfKey=function(a,y,c,g,u){return b.complete(g,u,this.identityStorage.getAllCertificateNamesOfKeyPromise(a,y,c,!g))};la.prototype.signByCertificatePromise=function(a,y,c,g){g="boolean"===typeof c?
c:g;c="boolean"!==typeof c&&c?c:t.getDefaultWireFormat();var u=la.certificateNameToPublicKeyName(y),A=this;if(a instanceof S){var f=[0];return this.makeSignatureByCertificatePromise(y,f,g).then(function(b){a.setSignature(b);b=a.wireEncode(c);return A.privateKeyStorage.signPromise(b.signedBuf(),u,f[0],g)}).then(function(y){a.getSignature().setSignature(y);a.wireEncode(c);return b.resolve(a)})}f=[0];return this.makeSignatureByCertificatePromise(y,f,g).then(function(b){return A.privateKeyStorage.signPromise(a,
u,f[0],g)}).then(function(a){signature.setSignature(a);return b.resolve(signature)})};la.prototype.signByCertificate=function(a,y,c,g,u){u="function"===typeof c?g:u;g="function"===typeof c?c:g;c="function"!==typeof c&&c?c:t.getDefaultWireFormat();return b.complete(g,u,this.signByCertificatePromise(a,y,c,!g))};la.prototype.signInterestByCertificatePromise=function(a,y,v,g){g="boolean"===typeof v?v:g;v="boolean"!==typeof v&&v?v:t.getDefaultWireFormat();var u=this,A,f=[0];return this.makeSignatureByCertificatePromise(y,
f,g).then(function(b){A=b;a.getName().append(v.encodeSignatureInfo(A));a.getName().append(new c.Component);b=a.wireEncode(v);var l=la.certificateNameToPublicKeyName(y);return u.privateKeyStorage.signPromise(b.signedBuf(),l,f[0],g)}).then(function(y){A.setSignature(y);a.setName(a.getName().getPrefix(-1).append(v.encodeSignatureValue(A)));return b.resolve(a)})};la.prototype.signInterestByCertificate=function(a,y,c,g,u){u="function"===typeof c?g:u;g="function"===typeof c?c:g;c="function"!==typeof c&&
c?c:t.getDefaultWireFormat();return b.complete(g,u,this.signInterestByCertificatePromise(a,y,c,!g))};la.prototype.signWithSha256=function(a,b){b=b||t.getDefaultWireFormat();a.setSignature(new yb);var c=a.wireEncode(b),g=X.createHash("sha256");g.update(c.signedBuf());a.getSignature().setSignature(new m(g.digest(),!1));a.wireEncode(b)};la.prototype.signInterestWithSha256=function(a,b){b=b||t.getDefaultWireFormat();var v=new yb;a.getName().append(b.encodeSignatureInfo(v));a.getName().append(new c.Component);
var g=a.wireEncode(b),u=X.createHash("sha256");u.update(g.signedBuf());v.setSignature(new m(u.digest(),!1));a.setName(a.getName().getPrefix(-1).append(b.encodeSignatureValue(v)))};la.prototype.selfSignPromise=function(a,b){var c=new Oa,g=this;return this.identityStorage.getKeyPromise(a,b).then(function(u){u=new Ba(u);var A=(new Date).getTime(),f=A+63072E6;c.setNotBefore(A);c.setNotAfter(f);A=a.getPrefix(-1).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion(c.getNotBefore());c.setName(A);
c.setPublicKeyInfo(u);c.addSubjectDescription(new ld("2.5.4.41",a.toUri()));c.encode();return g.signByCertificatePromise(c,c.getName(),b)})};la.prototype.selfSign=function(a,y,c){return b.complete(y,c,this.selfSignPromise(a,!y))};la.certificateNameToPublicKeyName=function(a){for(var b=a.size()-1;0<=b&&"ID-CERT"!=a.get(b).toEscapedString();)--b;a=a.getSubName(0,b);for(b=0;b<a.size()&&"KEY"!=a.get(b).toEscapedString();)++b;return a.getSubName(0,b).append(a.getSubName(b+1,a.size()-b-1))};la.prototype.makeSignatureByCertificatePromise=
function(a,y,c){var g=la.certificateNameToPublicKeyName(a);return this.privateKeyStorage.getPublicKeyPromise(g,c).then(function(c){c=c.getKeyType();var v=null;if(c==ea.RSA)v=new Ka,y[0]=Ha.SHA256,v.getKeyLocator().setType(va.KEYNAME),v.getKeyLocator().setKeyName(a.getPrefix(-1));else if(c==ea.EC)v=new Ya,y[0]=Ha.SHA256,v.getKeyLocator().setType(va.KEYNAME),v.getKeyLocator().setKeyName(a.getPrefix(-1));else throw new x(Error("Key type is not recognized"));return b.resolve(v)})};la.prototype.generateKeyPairPromise=
function(a,y,c,g){var u,A=this;return this.identityStorage.getNewKeyNamePromise(a,y,g).then(function(a){u=a;return A.privateKeyStorage.generateKeyPairPromise(u,c,g)}).then(function(){return A.privateKeyStorage.getPublicKeyPromise(u,g)}).then(function(a){return A.identityStorage.addKeyPromise(u,c.getKeyType(),a.getKeyDer())}).then(function(){return b.resolve(u)})};la.getDefaultIdentityStorage_=function(a,b){var c=a.get("pib","");if(""!==c&&"pib-sqlite3"!==c)throw new x(Error("Invalid config file pib value: "+
c));return new Me(b)};la.getDefaultPrivateKeyStorage_=function(a,b){var c=a.get("tpm","");if(""===c){if("darwin"===process.platform)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: OS X key chain storage is not yet implemented. You must supply a privateKeyStorage."));b[0]="tpm-file:";return new We}if("tpm-osxkeychain"===c)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: tpm-osxkeychain is not yet implemented."));if("tpm-file"===c)return b[0]="tpm-file:",new We;throw new x(Error("Invalid config file tpm value: "+
c));};la.prototype.checkTpmPromise_=function(a){return this.identityStorage.getTpmLocatorPromise().then(function(b){return""!==b&&b!==a?Promise.reject(new x(Error("The TPM locator supplied does not match the TPM locator in the PIB: "+b+" != "+a))):Promise.resolve()},function(a){return Promise.resolve()})};var c=a.Name,b=a.SyncPromise,O=a.CertificateV2,Uc=function(a,b,v){this.certificates_={};this.keyName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.certificateNameUris_=
[];for(var g in v)this.certificateNameUris_.push(v[g].toUri())};s.PibCertificateContainer=Uc;Uc.makePromise=function(a,y,c){return null==y?b.reject(Error("The pibImpl is null")):y.getCertificatesOfKeyPromise(a,c).then(function(c){return b.resolve(new Uc(a,y,c))})};Uc.prototype.size=function(){return this.certificateNameUris_.length};Uc.prototype.addPromise=function(a,y){if(!this.keyName_.equals(a.getKeyName()))return b.reject(Error("The certificate name `"+a.getKeyName().toUri()+"` does not match the key name"));
var c=a.getName().toUri();0>this.certificateNameUris_.indexOf(c)&&this.certificateNameUris_.push(c);this.certificates_[c]=new O(a);return this.pibImpl_.addCertificatePromise(a,y)};Uc.prototype.removePromise=function(a,c){if(!O.isValidName(a)||!O.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var v=a.toUri(),g=this.certificateNameUris_.indexOf(v);0<=g&&this.certificateNameUris_.splice(g,1);delete this.certificates_[v];
return this.pibImpl_.removeCertificatePromise(a,c)};Uc.prototype.getPromise=function(a,c){var v=a.toUri(),g=this.certificates_[v];if(void 0!=g)return b.resolve(new O(g));if(!O.isValidName(a)||!O.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var u=this;return this.pibImpl_.getCertificatePromise(a,c).then(function(a){u.certificates_[v]=a;return b.resolve(new O(a))})};var c=a.Name,Sb=a.PibIdentity,
qc=a.PibIdentityImpl,b=a.SyncPromise,Gc=function(a,b){this.identities_={};this.pibImpl_=a;if(null==a)throw Error("The pibImpl is null");this.identityNameUris_=[];for(var c in b)this.identityNameUris_.push(b[c].toUri())};s.PibIdentityContainer=Gc;Gc.makePromise=function(a,c){return null==a?b.reject(Error("The pibImpl is null")):a.getIdentitiesPromise(c).then(function(c){return b.resolve(new Gc(a,c))})};Gc.prototype.size=function(){return this.identityNameUris_.length};Gc.prototype.addPromise=function(a,
b){var c=a.toUri();if(0>this.identityNameUris_.indexOf(c)){var g=this;this.identityNameUris_.push(c);return qc.makePromise(a,this.pibImpl_,!0,b).then(function(u){g.identities_[c]=u;return g.getPromise(a,b)})}return this.getPromise(a,b)};Gc.prototype.removePromise=function(a,b){var c=a.toUri(),g=this.identityNameUris_.indexOf(c);0<=g&&this.identityNameUris_.splice(g,1);delete this.identities_[c];return this.pibImpl_.removeIdentityPromise(a,b)};Gc.prototype.getPromise=function(a,c){var v=a.toUri(),
g=this.identities_[v];if(void 0==g){var u=this;return qc.makePromise(a,this.pibImpl_,!1,c).then(function(a){u.identities_[v]=a;return b.resolve(new Sb(a))})}return b.resolve(new Sb(g))};Gc.prototype.resetPromise=function(a){var c=this;this.identities_={};return this.pibImpl_.getIdentitiesPromise(a).then(function(a){c.identityNameUris_=[];for(var z in a)c.identityNameUris_.push(a[z].toUri());return b.resolve()})};b=a.SyncPromise;Sb=function(a){this.impl_=a};s.PibIdentity=Sb;Sb.prototype.getName=function(){return this.lock_().getName()};
Sb.prototype.getKeyPromise=function(a,c){try{return this.lock_().getKeyPromise(a,c)}catch(v){return b.reject(v)}};Sb.prototype.getKey=function(a,c,v){return b.complete(c,v,this.getKeyPromise(a,!c))};Sb.prototype.getDefaultKeyPromise=function(a){try{return this.lock_().getDefaultKeyPromise(a)}catch(c){return b.reject(c)}};Sb.prototype.getDefaultKey=function(a,c){return b.complete(a,c,this.getDefaultKeyPromise(!a))};Sb.prototype.addKeyPromise_=function(a,c,v){try{return this.lock_().addKeyPromise(a,
c,v)}catch(g){return b.reject(g)}};Sb.prototype.removeKeyPromise_=function(a,c){try{return this.lock_().removeKeyPromise(a,c)}catch(v){return b.reject(v)}};Sb.prototype.setDefaultKeyPromise_=function(a,c,v){try{return this.lock_().setDefaultKeyPromise(a,c,v)}catch(g){return b.reject(g)}};Sb.prototype.getKeys_=function(){return this.lock_().keys_};Sb.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var b=a.SyncPromise,ca=function(){};s.PibImpl=ca;
ca.Error=function(a){if(a)return a.__proto__=ca.Error.prototype,a};ca.Error.prototype=Error();ca.Error.prototype.name="PibImplError";ca.prototype.setTpmLocatorPromise=function(a,c){return b.reject(Error("PibImpl.setTpmLocatorPromise is not implemented"))};ca.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("PibImpl.getTpmLocatorPromise is not implemented"))};ca.prototype.hasIdentityPromise=function(a,c){return b.reject(Error("PibImpl.hasIdentityPromise is not implemented"))};ca.prototype.addIdentityPromise=
function(a,c){return b.reject(Error("PibImpl.addIdentityPromise is not implemented"))};ca.prototype.removeIdentityPromise=function(a,c){return b.reject(Error("PibImpl.removeIdentityPromise is not implemented"))};ca.prototype.clearIdentitiesPromise=function(a){return b.reject(Error("PibImpl.clearIdentitiesPromise is not implemented"))};ca.prototype.getIdentitiesPromise=function(a){return b.reject(Error("PibImpl.getIdentitiesPromise is not implemented"))};ca.prototype.setDefaultIdentityPromise=function(a,
c){return b.reject(Error("PibImpl.setDefaultIdentityPromise is not implemented"))};ca.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("PibImpl.getDefaultIdentityPromise is not implemented"))};ca.prototype.hasKeyPromise=function(a,c){return b.reject(Error("PibImpl.hasKeyPromise is not implemented"))};ca.prototype.addKeyPromise=function(a,c,v,g){return b.reject(Error("PibImpl.addKeyPromise is not implemented"))};ca.prototype.removeKeyPromise=function(a,c){return b.reject(Error("PibImpl.removeKeyPromise is not implemented"))};
ca.prototype.getKeyBitsPromise=function(a,c){return b.reject(Error("PibImpl.getKeyBitsPromise is not implemented"))};ca.prototype.getKeysOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getKeysOfIdentityPromise is not implemented"))};ca.prototype.setDefaultKeyOfIdentityPromise=function(a,c,v){return b.reject(Error("PibImpl.setDefaultKeyOfIdentityPromise is not implemented"))};ca.prototype.getDefaultKeyOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultKeyOfIdentityPromise is not implemented"))};
ca.prototype.hasCertificatePromise=function(a,c){return b.reject(Error("PibImpl.hasCertificatePromise is not implemented"))};ca.prototype.addCertificatePromise=function(a,c){return b.reject(Error("PibImpl.addCertificatePromise is not implemented"))};ca.prototype.removeCertificatePromise=function(a,c){return b.reject(Error("PibImpl.removeCertificatePromise is not implemented"))};ca.prototype.getCertificatePromise=function(a,c){return b.reject(Error("PibImpl.getCertificatePromise is not implemented"))};
ca.prototype.getCertificatesOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getCertificatesOfKeyPromise is not implemented"))};ca.prototype.setDefaultCertificateOfKeyPromise=function(a,c,v){return b.reject(Error("PibImpl.setDefaultCertificateOfKeyPromise is not implemented"))};ca.prototype.getDefaultCertificateOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultCertificateOfKeyPromise is not implemented"))};var bb=function(){ca.call(this);this.database=new Dexie("pib");this.database.version(1).stores({globals:"key",
identities:"identityNameUri",keys:"keyNameUri",certificates:"certificateNameUri"});this.database.open()};bb.prototype=new ca;bb.prototype.name="PibIndexedDb";s.PibIndexedDb=bb;bb.getScheme=function(){return"pib-indexeddb"};bb.prototype.setTpmLocatorPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.setTpmLocatorPromise is only supported for async"))):this.database.globals.put({key:"tpmLocator",value:a})};bb.prototype.getTpmLocatorPromise=function(a){return a?Promise.reject(new ca.Error(Error("PibIndexedDb.getTpmLocatorPromise is only supported for async"))):
this.database.globals.get("tpmLocator").then(function(a){return a?Promise.resolve(a.value):Promise.resolve("")})};bb.prototype.hasIdentityPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.hasIdentityPromise is only supported for async"))):this.database.identities.where("identityNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};bb.prototype.addIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.addIdentityPromise is only supported for async")));
var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.get("defaultIdentityUri")}).then(function(b){return b?Promise.resolve():c.setDefaultIdentityPromise(a)})};bb.prototype.removeIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.removeIdentityPromise is only supported for async")));var v=a.toUri(),g=this;return this.database.certificates.each(function(b){O.extractIdentityFromCertName(new c(b.certificateNameUri)).equals(a)&&
g.database.certificates.delete(b.certificateNameUri)}).then(function(){return g.database.keys.each(function(b){ra.extractIdentityFromKeyName(new c(b.keyNameUri)).equals(a)&&g.database.keys.delete(b.keyNameUri)})}).then(function(){return g.database.identities.delete(v)}).then(function(){return g.database.globals.get("defaultIdentityUri")}).then(function(a){return a&&a.value==v?g.database.globals.delete("defaultIdentityUri"):Promise.resolve()})};bb.prototype.clearIdentitiesPromise=function(a){if(a)return Promise.reject(new ca.Error(Error("PibIndexedDb.clearIdentitiesPromise is only supported for async")));
var b=this;return this.database.globals.delete("defaultIdentityUri").then(function(){return b.database.certificates.clear()}).then(function(){return b.database.keys.clear()}).then(function(){return b.database.identities.clear()})};bb.prototype.getIdentitiesPromise=function(a){if(a)return Promise.reject(new ca.Error(Error("PibIndexedDb.getIdentitiesPromise is only supported for async")));var b=[];return this.database.identities.each(function(a){b.push(new c(a.identityNameUri))}).then(function(){return Promise.resolve(b)})};
bb.prototype.setDefaultIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.setDefaultIdentityPromise is only supported for async")));var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.put({key:"defaultIdentityUri",value:a.toUri()})})};bb.prototype.getDefaultIdentityPromise=function(a){return a?Promise.reject(new ca.Error(Error("PibIndexedDb.getDefaultIdentityPromise is only supported for async"))):
this.database.globals.get("defaultIdentityUri").then(function(a){return a?Promise.resolve(new c(a.value)):Promise.reject(new ma.Error(Error("No default identity")))})};bb.prototype.hasKeyPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.hasKeyPromise is only supported for async"))):this.database.keys.where("keyNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};bb.prototype.addKeyPromise=function(a,b,v,g){if(g)return Promise.reject(new ca.Error(Error("PibIndexedDb.addKeyPromise is only supported for async")));
var u=this;return this.addIdentityPromise(a).then(function(){return u.hasKeyPromise(b)}).then(function(a){return a?u.database.keys.update(b.toUri(),{keyDer:v}):u.database.keys.put({keyNameUri:b.toUri(),keyDer:v,defaultCertificateUri:null})}).then(function(){return u.database.identities.get(a.toUri())}).then(function(a){return a&&null!=a.defaultKeyUri?u.hasKeyPromise(new c(a.defaultKeyUri)):Promise.resolve(!1)}).then(function(c){return c?Promise.resolve():u.setDefaultKeyOfIdentityPromise(a,b)})};bb.prototype.removeKeyPromise=
function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.removeKeyPromise is only supported for async")));var v=this;return this.database.certificates.each(function(b){O.extractKeyNameFromCertName(new c(b.certificateNameUri)).equals(a)&&v.database.certificates.delete(b.certificateNameUri)}).then(function(){return v.database.keys.delete(a.toUri())})};bb.prototype.getKeyBitsPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.getKeyBitsPromise is only supported for async"))):
this.database.keys.get(a.toUri()).then(function(b){return b?Promise.resolve(new m(b.keyDer)):Promise.reject(new ma.Error(Error("Key `"+a.toUri()+"` does not exist")))})};bb.prototype.getKeysOfIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getKeysOfIdentityPromise is only supported for async")));var v=[];return this.database.keys.each(function(b){b=new c(b.keyNameUri);ra.extractIdentityFromKeyName(b).equals(a)&&v.push(b)}).then(function(){return Promise.resolve(v)})};
bb.prototype.setDefaultKeyOfIdentityPromise=function(a,b,c){if(c)return Promise.reject(new ca.Error(Error("PibIndexedDb.setDefaultKeyOfIdentityPromise is only supported for async")));var g=this;return this.hasKeyPromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new ma.Error(Error("Key `"+b.toUri()+"` does not exist")))}).then(function(){return g.database.identities.update(a.toUri(),{defaultKeyUri:b.toUri()})})};bb.prototype.getDefaultKeyOfIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getDefaultKeyOfIdentityPromise is only supported for async")));
var v=this;return this.database.identities.get(a.toUri()).then(function(b){if(b){if(null!=b.defaultKeyUri){var y=new c(b.defaultKeyUri);return v.hasKeyPromise(y).then(function(b){return b?Promise.resolve(y):Promise.reject(new ma.Error(Error("No default key for identity `"+a.toUri()+"`")))})}return Promise.reject(new ma.Error(Error("No default key for identity `"+a.toUri()+"`")))}return Promise.reject(new ma.Error(Error("Identity `"+a.toUri()+"` does not exist")))})};bb.prototype.hasCertificatePromise=
function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.hasCertificatePromise is only supported for async"))):this.database.certificates.where("certificateNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};bb.prototype.addCertificatePromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.addCertificatePromise is only supported for async")));var v=a.getKeyName(),g=v.toUri(),u=this,A=a.getContent();return this.addKeyPromise(a.getIdentity(),
v,A.buf()).then(function(){return u.database.certificates.put({certificateNameUri:a.getName().toUri(),encoding:a.wireEncode().buf()})}).then(function(){return u.database.keys.get(g)}).then(function(a){return a&&null!=a.defaultCertificateUri?u.hasCertificatePromise(new c(a.defaultCertificateUri)):Promise.resolve(!1)}).then(function(b){return b?Promise.resolve():u.setDefaultCertificateOfKeyPromise(v,a.getName())})};bb.prototype.removeCertificatePromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.removeCertificatePromise is only supported for async"))):
this.database.certificates.delete(a.toUri())};bb.prototype.getCertificatePromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.getCertificatePromise is only supported for async"))):this.database.certificates.get(a.toUri()).then(function(b){if(b){var c=new O;c.wireDecode(b.encoding);return Promise.resolve(c)}return Promise.reject(new ma.Error(Error("Certificate `"+a.toUri()+"` does not exit")))})};bb.prototype.getCertificatesOfKeyPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getCertificatesOfKeyPromise is only supported for async")));
var v=[];return this.database.certificates.each(function(b){b=new c(b.certificateNameUri);O.extractKeyNameFromCertName(b).equals(a)&&v.push(b)}).then(function(){return Promise.resolve(v)})};bb.prototype.setDefaultCertificateOfKeyPromise=function(a,b,c){if(c)return Promise.reject(new ca.Error(Error("PibIndexedDb.setDefaultCertificateOfKeyPromise is only supported for async")));var g=this;return this.hasCertificatePromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new ma.Error(Error("Certificate `"+
b.toUri()+"` does not exist")))}).then(function(){return g.database.keys.update(a.toUri(),{defaultCertificateUri:b.toUri()})})};bb.prototype.getDefaultCertificateOfKeyPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getDefaultCertificateOfKeyPromise is only supported for async")));var v=this;return this.database.keys.get(a.toUri()).then(function(b){return b&&null!=b.defaultCertificateUri?v.getCertificatePromise(new c(b.defaultCertificateUri)):Promise.reject(new ma.Error(Error("No default certificate for key `"+
a.toUri()+"`")))})};var c=a.Name,ra=a.PibKey,Vb=a.PibKeyImpl,b=a.SyncPromise,Vc=function(a,b,v){this.keys_={};this.identityName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.keyNameUris_=[];for(var g in v)this.keyNameUris_.push(v[g].toUri())};s.PibKeyContainer=Vc;Vc.makePromise=function(a,c,v){return null==c?b.reject(Error("The pibImpl is null")):c.getKeysOfIdentityPromise(a,v).then(function(v){return b.resolve(new Vc(a,c,v))})};Vc.prototype.size=function(){return this.keyNameUris_.length};
Vc.prototype.addPromise=function(a,c,v){if(!this.identityName_.equals(ra.extractIdentityFromKeyName(c)))return b.reject(Error("The key name `"+c.toUri()+"` does not match the identity name `"+this.identityName_.toUri()+"`"));var g=c.toUri();0>this.keyNameUris_.indexOf(g)&&this.keyNameUris_.push(g);var u=this;return Vb.makePromise(c,a,this.pibImpl_,v).then(function(a){u.keys_[g]=a;return u.getPromise(c,v)})};Vc.prototype.removePromise=function(a,c){if(!this.identityName_.equals(ra.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+
a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var v=a.toUri(),g=this.keyNameUris_.indexOf(v);0<=g&&this.keyNameUris_.splice(g,1);delete this.keys_[v];return this.pibImpl_.removeKeyPromise(a,c)};Vc.prototype.getPromise=function(a,c){if(!this.identityName_.equals(ra.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var v=a.toUri(),g=this.keys_[v];if(void 0==g){var u=this;return Vb.makePromise(a,
this.pibImpl_,c).then(function(a){u.keys_[v]=a;return b.resolve(new ra(a))})}return b.resolve(new ra(g))};Vc.prototype.getKeyNames=function(){var a=[],b;for(b in this.keys_)a.push(new c(b));return a};c=a.Name;O=a.CertificateV2;b=a.SyncPromise;ra=function(a){this.impl_=a};s.PibKey=ra;ra.prototype.getName=function(){return this.lock_().getName()};ra.prototype.getIdentityName=function(){return this.lock_().getIdentityName()};ra.prototype.getKeyType=function(){return this.lock_().getKeyType()};ra.prototype.getPublicKey=
function(){return this.lock_().getPublicKey()};ra.prototype.getCertificatePromise=function(a,c){try{return this.lock_().getCertificatePromise(a,c)}catch(v){return b.reject(v)}};ra.prototype.getCertificate=function(a,c,v){return b.complete(c,v,this.getCertificatePromise(a,!c))};ra.prototype.getDefaultCertificatePromise=function(a){try{return this.lock_().getDefaultCertificatePromise(a)}catch(c){return b.reject(c)}};ra.prototype.getDefaultCertificate=function(a,c){return b.complete(a,c,this.getDefaultCertificatePromise(!a))};
ra.constructKeyName=function(a,b){var v=new c(a);v.append(O.KEY_COMPONENT).append(b);return v};ra.isValidKeyName=function(a){return a.size()>O.MIN_KEY_NAME_LENGTH&&a.get(-O.MIN_KEY_NAME_LENGTH).equals(O.KEY_COMPONENT)};ra.extractIdentityFromKeyName=function(a){if(!ra.isValidKeyName(a))throw Error("Key name `"+a.toUri()+"` does not follow the naming conventions");return a.getPrefix(-O.MIN_KEY_NAME_LENGTH)};ra.prototype.addCertificatePromise_=function(a,b){return this.lock_().addCertificatePromise(a,
b)};ra.prototype.removeCertificatePromise_=function(a,b){return this.lock_().removeCertificatePromise(a,b)};ra.prototype.setDefaultCertificatePromise_=function(a,b){return this.lock_().setDefaultCertificatePromise(a,b)};ra.prototype.getCertificates_=function(){return this.lock_().certificates_};ra.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var c=a.Name,m=a.Blob,O=a.CertificateV2,ma=a.Pib,ra=a.PibKey,b=a.SyncPromise,ca=a.PibImpl,ya=function(){ca.call(this);
this.tpmLocator_="";this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={}};ya.prototype=new ca;ya.prototype.name="PibMemory";s.PibMemory=ya;ya.getScheme=function(){return"pib-memory"};ya.prototype.setTpmLocatorPromise=function(a){this.tpmLocator_=a;return b.resolve()};ya.prototype.getTpmLocatorPromise=function(){return b.resolve(this.tpmLocator_)};ya.prototype.hasIdentityPromise=function(a){return b.resolve(this.hasIdentity_(a))};
ya.prototype.hasIdentity_=function(a){for(var b in this.identityNames_)if(this.identityNames_[b].equals(a))return!0;return!1};ya.prototype.addIdentityPromise=function(a){this.addIdentity_(a);return b.resolve()};ya.prototype.addIdentity_=function(a){a=new c(a);this.hasIdentity_(a)||this.identityNames_.push(a);null===this.defaultIdentityName_&&(this.defaultIdentityName_=a)};ya.prototype.removeIdentityPromise=function(a){for(var c=this.identityNames_.length-1;0<=c;--c)this.identityNames_[c].equals(a)&&
this.identityNames_.splice(c,1);null!==this.defaultIdentityName_&&a.equals(this.defaultIdentityName_)&&(this.defaultIdentityName_=null);a=this.getKeysOfIdentity_(a);for(c in a)this.removeKey_(a[c]);return b.resolve()};ya.prototype.clearIdentitiesPromise=function(){this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={};return b.resolve()};ya.prototype.getIdentitiesPromise=function(){var a=[],y;for(y in this.identityNames_)a.push(new c(this.identityNames_[y]));
return b.resolve(a)};ya.prototype.setDefaultIdentityPromise=function(a){this.addIdentity_(a);this.defaultIdentityName_=new c(a);return b.resolve()};ya.prototype.getDefaultIdentityPromise=function(){return null!==this.defaultIdentityName_?b.resolve(new c(this.defaultIdentityName_)):b.reject(new ma.Error(Error("No default identity")))};ya.prototype.hasKeyPromise=function(a){return b.resolve(this.hasKey_(a))};ya.prototype.hasKey_=function(a){return a.toUri()in this.keys_};ya.prototype.addKeyPromise=
function(a,c,v){this.addKey_(a,c,v);return b.resolve()};ya.prototype.addKey_=function(a,b,v){this.addIdentity_(a);b=new c(b);this.keys_[b.toUri()]=new m(v,!0);a=a.toUri();a in this.defaultKeyNames_||(this.defaultKeyNames_[a]=b)};ya.prototype.removeKeyPromise=function(a){this.removeKey_(a);return b.resolve()};ya.prototype.removeKey_=function(a){var b=ra.extractIdentityFromKeyName(a);delete this.keys_[a.toUri()];delete this.defaultKeyNames_[b.toUri()];a=this.getCertificatesOfKey_(a);for(var c in a)this.removeCertificate_(a[c])};
ya.prototype.getKeyBitsPromise=function(a){if(!this.hasKey_(a))return b.reject(new ma.Error(Error("Key `"+a.toUri()+"` not found")));a=this.keys_[a.toUri()];return b.resolve(a)};ya.prototype.getKeysOfIdentityPromise=function(a){return b.resolve(this.getKeysOfIdentity_(a))};ya.prototype.getKeysOfIdentity_=function(a){var b=[],v;for(v in this.keys_){var g=new c(v);a.equals(ra.extractIdentityFromKeyName(g))&&b.push(g)}return b};ya.prototype.setDefaultKeyOfIdentityPromise=function(a,y){if(!this.hasKey_(y))return b.reject(new ma.Error(Error("Key `"+
y.toUri()+"` not found")));this.defaultKeyNames_[a.toUri()]=new c(y);return b.resolve()};ya.prototype.getDefaultKeyOfIdentityPromise=function(a){var y=this.defaultKeyNames_[a.toUri()];return void 0==y?b.reject(new ma.Error(Error("No default key for identity `"+a.toUri()+"`"))):b.resolve(new c(y))};ya.prototype.hasCertificatePromise=function(a){return b.resolve(this.hasCertificate_(a))};ya.prototype.hasCertificate_=function(a){return a.toUri()in this.certificates_};ya.prototype.addCertificatePromise=
function(a){var y=new c(a.getName()),v=a.getKeyName(),g=a.getIdentity();this.addKey_(g,v,a.getContent().buf());this.certificates_[y.toUri()]=new O(a);a=v.toUri();a in this.defaultCertificateNames_||(this.defaultCertificateNames_[a]=y);return b.resolve()};ya.prototype.removeCertificatePromise=function(a){this.removeCertificate_(a);return b.resolve()};ya.prototype.removeCertificate_=function(a){delete this.certificates_[a.toUri()];var b=O.extractKeyNameFromCertName(a).toUri(),c=this.defaultCertificateNames_[b];
void 0!=c&&c.equals(a)&&delete this.defaultCertificateNames_[b]};ya.prototype.getCertificatePromise=function(a){return this.hasCertificate_(a)?b.resolve(new O(this.certificates_[a.toUri()])):b.reject(new ma.Error(Error("Certificate `"+a.toUri()+"` does not exist")))};ya.prototype.getCertificatesOfKeyPromise=function(a){return b.resolve(this.getCertificatesOfKey_(a))};ya.prototype.getCertificatesOfKey_=function(a){var b=[],v;for(v in this.certificates_)O.extractKeyNameFromCertName(this.certificates_[v].getName()).equals(a)&&
b.push(new c(v));return b};ya.prototype.setDefaultCertificateOfKeyPromise=function(a,y){if(!this.hasCertificate_(y))return b.reject(new ma.Error(Error("Certificate `"+y.toUri()+"` does not exist")));this.defaultCertificateNames_[a.toUri()]=new c(y);return b.resolve()};ya.prototype.getDefaultCertificateOfKeyPromise=function(a){var c=this.defaultCertificateNames_[a.toUri()];if(void 0==c)return b.reject(new ma.Error(Error("No default certificate for key `"+a.toUri()+"`")));a=this.certificates_[c.toUri()];
return b.resolve(new O(a))};zd=a.ConfigFile;b=a.SyncPromise;ma=function(a,b,c){this.defaultIdentity_=null;this.scheme_=a;this.location_=b;this.identities_=null;this.pibImpl_=c;this.initializeTpmLocator_=this.initializePibLocator_=this.initializeTpm_=null;this.isInitialized_=this.initializeAllowReset_=!1;if(null==c)throw Error("The pibImpl is null");};s.Pib=ma;ma.Error=function(a){if(a)return a.__proto__=ma.Error.prototype,a};ma.Error.prototype=Error();ma.Error.prototype.name="PibError";ma.prototype.getScheme=
function(){return this.scheme_};ma.prototype.getPibLocator=function(){return this.scheme_+":"+this.location_};ma.prototype.setTpmLocatorPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.doSetTpmLocatorPromise_(a,b)})};ma.prototype.doSetTpmLocatorPromise_=function(a,c){var v=this;return this.pibImpl_.getTpmLocatorPromise(c).then(function(g){return a==g?b.resolve():v.resetPromise_(c).then(function(){return v.pibImpl_.setTpmLocatorPromise(a,c)})})};ma.prototype.getTpmLocatorPromise=
function(a){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getTpmLocatorPromise(a)}).then(function(a){return""==a?b.reject(new ma.Error(Error("TPM info does not exist"))):b.resolve(a)})};ma.prototype.getIdentityPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.getPromise(a,b)})};ma.prototype.getIdentity=function(a,c,v){return b.complete(c,v,this.getIdentityPromise(a,!c))};ma.prototype.getDefaultIdentityPromise=function(a){if(null==
this.defaultIdentity_){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getDefaultIdentityPromise(a)}).then(function(b){return c.identities_.getPromise(b,a)}).then(function(a){c.defaultIdentity_=a;return b.resolve(c.defaultIdentity_)})}return b.resolve(this.defaultIdentity_)};ma.prototype.getDefaultIdentity=function(a,c){return b.complete(a,c,this.getDefaultIdentityPromise(!a))};ma.prototype.resetPromise_=function(a){var b=this;return this.pibImpl_.clearIdentitiesPromise(a).then(function(){return b.pibImpl_.setTpmLocatorPromise("",
a)}).then(function(){b.defaultIdentity_=null;return Gc.makePromise(b.pibImpl_,a)}).then(function(c){b.identities_=c;return b.identities_.resetPromise(a)})};ma.prototype.addIdentityPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.addPromise(a,b)})};ma.prototype.removeIdentityPromise_=function(a,b){null!=this.defaultIdentity_&&this.defaultIdentity_.getName().equals(a)&&(this.defaultIdentity_=null);var c=this;return this.initializePromise_(b).then(function(){return c.identities_.removePromise(a,
b)})};ma.prototype.setDefaultIdentityPromise_=function(a,c){var v=this;return this.initializePromise_(c).then(function(){return v.identities_.addPromise(a,c)}).then(function(b){v.defaultIdentity_=b;return v.pibImpl_.setDefaultIdentityPromise(a)}).then(function(){return b.resolve(v.defaultIdentity_)})};ma.prototype.initializePromise_=function(a){if(this.isInitialized_)return b.resolve();var c=this;return Gc.makePromise(this.pibImpl_,a).then(function(v){c.identities_=v;return null!=c.initializeTpm_?
c.initializeFromLocatorsPromise_(a):b.resolve()}).then(function(){c.isInitialized_=!0;return b.resolve()})};ma.prototype.initializeFromLocatorsPromise_=function(a){var c=[null],v=[null];D.parseAndCheckPibLocator_(this.initializePibLocator_,c,v);var g=c[0]+":"+v[0],u,A=this;return this.pibImpl_.getTpmLocatorPromise(a).then(function(c){var v=[null],y=[null];D.parseAndCheckTpmLocator_(A.initializeTpmLocator_,v,y);u=v[0]+":"+y[0];var v=!1,f;zd&&(f=new zd);if(zd&&g==D.getDefaultPibLocator_(f))""!=c&&c!=
D.getDefaultTpmLocator_(f)&&(v=!0,u=D.getDefaultTpmLocator_(f));else if(""!=c&&c!=u)if(A.initializeAllowReset_)v=!0;else return b.reject(new je(Error("The supplied TPM locator does not match the TPM locator in the PIB: "+c+" != "+u)));return v?A.resetPromise_(a):b.resolve()}).then(function(){D.setUpTpm_(A.initializeTpm_,u);A.initializeTpm_.isInitialized_=!0;return A.doSetTpmLocatorPromise_(u,a)})};var D=a.KeyChain,je=a.LocatorMismatchError,Gc=a.PibIdentityContainer,c=a.Name,ma=a.Pib,Vc=a.PibKeyContainer,
b=a.SyncPromise,qc=function(){};s.PibIdentityImpl=qc;qc.makePromise=function(a,y,v,g){var u=new qc;return Vc.makePromise(a,y,g).then(function(A){u.defaultKey_=null;u.identityName_=new c(a);u.keys_=A;u.pibImpl_=y;return null==y?b.reject(Error("The pibImpl is null")):v?y.addIdentityPromise(u.identityName_,g).then(function(){return b.resolve(u)}):y.hasIdentityPromise(u.identityName_,g).then(function(a){return a?b.resolve(u):b.reject(new ma.Error(Error("Identity "+u.identityName_.toUri()+" does not exist")))})})};
qc.prototype.getName=function(){return this.identityName_};qc.prototype.addKeyPromise=function(a,b,c){return this.keys_.addPromise(a,b,c)};qc.prototype.removeKeyPromise=function(a,b){null!==this.defaultKey_&&this.defaultKey_.getName().equals(a)&&(this.defaultKey_=null);return this.keys_.removePromise(a,b)};qc.prototype.getKeyPromise=function(a,b){return this.keys_.getPromise(a,b)};qc.prototype.setDefaultKeyPromise=function(a,y,v){var g=this;if(a instanceof c){var u=a,A=y;return this.keys_.getPromise(u,
A).then(function(a){g.defaultKey_=a;return g.pibImpl_.setDefaultKeyOfIdentityPromise(g.identityName_,u,A)}).then(function(){return b.resolve(g.defaultKey_)})}u=y;A=v;return this.addKeyPromise(a,u,A).then(function(){return g.setDefaultKeyPromise(u,A)})};qc.prototype.getDefaultKeyPromise=function(a){var c=this;return null===this.defaultKey_?this.pibImpl_.getDefaultKeyOfIdentityPromise(this.identityName_,a).then(function(b){return c.keys_.getPromise(b,a)}).then(function(a){c.defaultKey_=a;return b.resolve(c.defaultKey_)}):
b.resolve(this.defaultKey_)};c=a.Name;Ba=a.PublicKey;m=a.Blob;ma=a.Pib;ra=a.PibKey;ca=a.PibImpl;Uc=a.PibCertificateContainer;b=a.SyncPromise;Vb=function(){};s.PibKeyImpl=Vb;Vb.makePromise=function(a,y,v,g){var u=new Vb;u.defaultCertificate_=null;if(y instanceof ca){var A=y,f=v;return null==A?b.reject(Error("The pibImpl is null")):Uc.makePromise(a,A,f).then(function(b){u.identityName_=ra.extractIdentityFromKeyName(a);u.keyName_=new c(a);u.pibImpl_=A;u.certificates_=b;return u.pibImpl_.getKeyBitsPromise(u.keyName_,
f)}).then(function(a){u.keyEncoding_=a;try{publicKey=new Ba(u.keyEncoding_)}catch(c){return b.reject(new ma.Error(Error("Error decoding public key")))}u.keyType_=publicKey.getKeyType();return b.resolve(u)})}A=v;f=g;return null==A?b.reject(Error("The pibImpl is null")):Uc.makePromise(a,A,f).then(function(v){u.identityName_=ra.extractIdentityFromKeyName(a);u.keyName_=new c(a);u.keyEncoding_=new m(y,!0);u.pibImpl_=A;u.certificates_=v;try{publicKey=new Ba(u.keyEncoding_),u.keyType_=publicKey.getKeyType()}catch(g){return b.reject(Error("Invalid key encoding"))}return u.pibImpl_.addKeyPromise(u.identityName_,
u.keyName_,y,f)}).then(function(){return b.resolve(u)})};Vb.prototype.getName=function(){return this.keyName_};Vb.prototype.getIdentityName=function(){return this.identityName_};Vb.prototype.getKeyType=function(){return this.keyType_};Vb.prototype.getPublicKey=function(){return this.keyEncoding_};Vb.prototype.addCertificatePromise=function(a,b){return this.certificates_.addPromise(a,b)};Vb.prototype.removeCertificatePromise=function(a,b){null!==this.defaultCertificate_&&this.defaultCertificate_.getName().equals(a)&&
(this.defaultCertificate_=null);return this.certificates_.removePromise(a,b)};Vb.prototype.getCertificatePromise=function(a,b){return this.certificates_.getPromise(a,b)};Vb.prototype.setDefaultCertificatePromise=function(a,g){var v=this,f;return b.resolve().then(function(){return a instanceof c?b.resolve(a):v.addCertificatePromise(a).then(function(){return b.resolve(a.getName())})}).then(function(a){f=a;return v.certificates_.getPromise(f,g)}).then(function(a){v.defaultCertificate_=a;return v.pibImpl_.setDefaultCertificateOfKeyPromise(v.keyName_,
f,g)}).then(function(){return b.resolve(v.defaultCertificate_)})};Vb.prototype.getDefaultCertificatePromise=function(a){var c=this;return null===this.defaultCertificate_?this.pibImpl_.getDefaultCertificateOfKeyPromise(this.keyName_,a).then(function(a){c.defaultCertificate_=a;return b.resolve(c.defaultCertificate_)}):b.resolve(c.defaultCertificate_)};var Ne=function(a,b,c,g,u){this.interest=a;this.onVerified=b;this.onValidationFailed=c;this.retry=g;this.stepCount=u};s.ValidationRequest=Ne;var X=a,
m=a.Blob,M=a.DataUtils,x=a.SecurityException,yb=a.DigestSha256Signature,Ka=a.Sha256WithRsaSignature,Ya=a.Sha256WithEcdsaSignature,Ua=a.VerificationHelpers,Ha=a.DigestAlgorithm,Ba=a.PublicKey,b=a.SyncPromise,pb=function(){};s.PolicyManager=pb;pb.prototype.skipVerifyAndTrust=function(a){throw Error("PolicyManager.skipVerifyAndTrust is not implemented");};pb.prototype.requireVerify=function(a){throw Error("PolicyManager.requireVerify is not implemented");};pb.prototype.checkVerificationPolicy=function(a,
b,c,g,u){throw Error("PolicyManager.checkVerificationPolicy is not implemented");};pb.prototype.checkSigningPolicy=function(a,b){throw Error("PolicyManager.checkSigningPolicy is not implemented");};pb.prototype.inferSigningIdentity=function(a){throw Error("PolicyManager.inferSigningIdentity is not implemented");};pb.verifyUsesString_=null;pb.setVerifyUsesString_=function(){var a=X.createHash("sha256").digest();pb.verifyUsesString_="string"===typeof a};pb.verifySignature=function(a,c,v,g){if(a instanceof
Ka||a instanceof Ya)if(v.isNull())g(!1);else{var u;try{u=new Ba(v)}catch(A){throw new x(Error("PolicyManager.verify: Error decoding public key: "+A));}b.complete(g,Ua.verifySignaturePromise(c.signedBuf(),a.getSignature(),u,Ha.SHA256,!g))}else if(a instanceof yb)g(Ua.verifyDigest(c.signedBuf(),a.getSignature(),Ha.SHA256));else throw new x(Error("PolicyManager.verify: Signature type is unknown"));};var Oa=a.IdentityCertificate,md=function(){this.cache={}};s.CertificateCache=md;md.prototype.insertCertificate=
function(a){var b=a.getName().getPrefix(-1);this.cache[b.toUri()]=a.wireEncode()};md.prototype.deleteCertificate=function(a){delete this.cache[a.toUri()]};md.prototype.getCertificate=function(a){a=this.cache[a.toUri()];if(void 0===a)return null;var b=new Oa;b.wireDecode(a);return b};md.prototype.reset=function(){this.cache={}};var ke=Rb=a,c=a.Name,S=a.Data,E=a.Interest,W=a.KeyLocator,va=a.KeyLocatorType,m=a.Blob,Oa=a.IdentityCertificate,O=a.CertificateV2,ec=a.CertificateCacheV2,lc=a.BoostInfoParser,
$a=a.NdnRegexTopMatcher,md=a.CertificateCache,Ne=a.ValidationRequest,x=a.SecurityException,t=a.WireFormat,pb=a.PolicyManager,P=a.NdnCommon,Aa=function(a,b,c,g,u,A){pb.call(this);void 0==b&&(b=null);void 0==c&&(c=5);void 0==g&&(g=3E3);void 0==u&&(u=36E5);void 0==A&&(A=1E3);null==b&&(b=new md);b instanceof md?(this.isSecurityV1_=!0,this.certificateCache_=b,this.certificateCacheV2_=null):(this.isSecurityV1_=!1,this.certificateCache_=null,this.certificateCacheV2_=b);this.maxDepth=c;this.keyGraceInterval=
g;this.keyTimestampTtl=u;this.maxTrackedKeys=A;this.reset();null!=a&&""!=a&&this.load(a)};Aa.prototype=new pb;Aa.prototype.name="ConfigPolicyManager";s.ConfigPolicyManager=Aa;Aa.prototype.reset=function(){this.isSecurityV1_?this.certificateCache_.reset():this.certificateCacheV2_.clear();this.fixedCertificateCache={};this.keyTimestamps={};this.requiresVerification=!0;this.config=new lc;this.refreshManager=new Aa.TrustAnchorRefreshManager(this.isSecurityV1_)};Aa.prototype.load=function(a,b){this.reset();
this.config.read(a,b);this.loadTrustAnchorCertificates()};Aa.prototype.requireVerify=function(a){return this.requiresVerification};Aa.prototype.checkSigningPolicy=function(a,b){return!0};Aa.prototype.skipVerifyAndTrust=function(a){return!this.requiresVerification};Aa.prototype.checkVerificationPolicy=function(a,b,c,g,u){var A=a.getName(),f="data";a instanceof E&&(A=A.getPrefix(-4),f="interest");u=Aa.extractSignature(a,u);if(null==u){try{g(a,"Cannot extract the signature from "+a.getName().toUri())}catch(l){console.log("Error in onValidationFailed: "+
P.getErrorWithStackTrace(l))}return null}var m=["unknown"],A=this.getCertificateInterest_(b,f,A,u,m);if(null==A){try{g(a,m[0])}catch(q){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(q))}return null}if(0<A.getName().size()){var t=this;return new Ne(A,function(u){var A;if(t.isSecurityV1_){try{A=new Oa(u)}catch(f){try{g(a,"Cannot decode certificate "+u.getName().toUri())}catch(Eb){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(Eb))}return null}t.certificateCache_.insertCertificate(A)}else{try{A=
new O(u)}catch(l){try{g(a,"Cannot decode certificate "+u.getName().toUri())}catch(ha){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(ha))}return null}t.certificateCacheV2_.insert(A)}t.checkVerificationPolicy(a,b+1,c,g)},g,2,b+1)}if(a instanceof E){var A=W.getFromSignature(u).getKeyName(),s;s=this.isSecurityV1_?Oa.certificateNameToPublicKeyName(A):A;var x=a.getName().get(-4).toNumber();if(!this.interestTimestampIsFresh(s,x,m)){try{g(a,m[0])}catch(Eb){console.log("Error in onValidationFailed: "+
P.getErrorWithStackTrace(Eb))}return null}}t=this;this.verify(u,a.wireEncode(),function(b,u){if(b){try{c(a)}catch(y){console.log("Error in onVerified: "+P.getErrorWithStackTrace(y))}a instanceof E&&t.updateTimestampForKey(s,x)}else try{g(a,u)}catch(A){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(A))}})};Aa.prototype.getCertificateInterest_=function(a,b,c,g,u){if(a>this.maxDepth)return u[0]="The verification stepCount "+a+" exceeded the maxDepth "+this.maxDepth,null;var A;try{A=
this.findMatchingRule(c,b)}catch(f){return null}if(null==A)return u[0]="No matching rule found for "+c.toUri(),null;if(!W.canGetFromSignature(g))return u[0]="The signature type does not support a KeyLocator",null;a=a=W.getFromSignature(g);a=a.getKeyName();if(0==a.size())return u[0]="The signature KeyLocator doesn't have a key name",null;if(!this.checkSignatureMatch(a,c,A,u))return null;this.refreshManager.refreshAnchors();this.isSecurityV1_?(c=this.refreshManager.getCertificate(a),null==c&&(c=this.certificateCache_.getCertificate(a))):
(c=this.refreshManager.getCertificateV2(a),null==c&&(c=this.certificateCacheV2_.find(a)));return null==c?new E(a):new E};Aa.prototype.loadTrustAnchorCertificates=function(){for(var a=this.config.getRoot().get("validator/trust-anchor"),b=0;b<a.length;++b){var c=a[b],g=c.get("type")[0].getValue(),u=!1,A;if("file"==g)A=c.get("file-name")[0].getValue(),u=!0;else if("base64"==g)A=c.get("base64-string")[0].getValue(),u=!1;else if("dir"==g){g=c.get("dir")[0].getValue();u=0;c=c.get("refresh");1<=c.length&&
(c=c[0].getValue().match(/(\d+)([hms])/),null==c?u=0:(u=parseInt(c[1]),"s"!=c[2]&&(u*=60,"m"!=c[2]&&(u*=60))));this.refreshManager.addDirectory(g,1E3*u);continue}else if("any"==g){this.requiresVerification=!1;break}this.isSecurityV1_?this.lookupCertificate(A,u):this.lookupCertificateV2(A,u)}};Aa.prototype.checkSignatureMatch=function(a,b,g,f){g=g.get("checker")[0];var u=g.get("type")[0].getValue();if("fixed-signer"==u){b=g.get("signer")[0];g=b.get("type")[0].getValue();if("file"==g){if(g=this.isSecurityV1_?
this.lookupCertificate(b.get("file-name")[0].getValue(),!0):this.lookupCertificateV2(b.get("file-name")[0].getValue(),!0),null==g)return f[0]="Can't find fixed-signer certificate file: "+b.get("file-name")[0].getValue(),!1}else if("base64"==g){if(g=this.isSecurityV1_?this.lookupCertificate(b.get("base64-string")[0].getValue(),!1):this.lookupCertificateV2(b.get("base64-string")[0].getValue(),!1),null==g)return f[0]="Can't find fixed-signer certificate base64: "+b.get("base64-string")[0].getValue(),
!1}else return f[0]="Unrecognized fixed-signer signerType: "+g,!1;if(g.getName().equals(a))return!0;f[0]='fixed-signer cert name "'+g.getName().toUri()+'" does not equal signatureName "'+a.toUri()+'"';return!1}if("hierarchical"==u){g=new $a("^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>");if(g.match(a)){a=g.expand("\\1").append(g.expand("\\2"));if(Aa.matchesRelation(b,a,"is-prefix-of"))return!0;f[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}if(!this.isSecurityV1_&&
(g=new $a("^(<>*)<KEY><>$"),g.match(a))){a=g.expand("\\1");if(Aa.matchesRelation(b,a,"is-prefix-of"))return!0;f[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}f[0]='The hierarchical identityRegex "^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>" does not match signatureName "'+a.toUri()+'"';return!1}if("customized"==u){var A=g.get("key-locator")[0];g=A.getFirstValue("relation");if(null!=g){b=new c(A.get("name")[0].getValue());if(Aa.matchesRelation(a,b,g))return!0;
f[0]='The custom signatureName "'+a.toUri()+'" does not match matchName "'+b.toUri()+'" using relation '+g;return!1}var l=A.getFirstValue("regex");if(null!=l){if((new $a(simpleKeyRegex)).match(a))return!0;f[0]='The custom signatureName "'+a.toUri()+'" does not regex match simpleKeyRegex "'+l+'"';return!1}g=A.get("hyper-relation");if(1<=g.length){g=g[0];var l=g.getFirstValue("k-regex"),ha=g.getFirstValue("k-expand"),A=g.getFirstValue("p-regex"),m=g.getFirstValue("p-expand");g=g.getFirstValue("h-relation");
if(null!=l&&null!=ha&&null!=A&&null!=m&&null!=g){u=new $a(l);if(!u.match(a))return f[0]='The custom hyper-relation signatureName "'+a.toUri()+'" does not match the keyRegex "'+l+'"',!1;a=u.expand(ha);u=new $a(A);if(!u.match(b))return f[0]='The custom hyper-relation objectName "'+b.toUri()+'" does not match the nameRegex "'+A+'"',!1;b=u.expand(m);if(Aa.matchesRelation(b,a,g))return!0;f[0]='The custom hyper-relation nameMatch "'+b.toUri()+'" does not match the keyMatchPrefix "'+a.toUri()+'" using relation '+
g;return!1}}}f[0]="Unrecognized checkerType: "+u;return!1};Aa.prototype.lookupCertificate=function(a,b){if(!this.isSecurityV1_)throw new x(Error("lookupCertificate: For security v2, use lookupCertificateV2()"));var g;g=this.fixedCertificateCache[a];if(void 0===g){if(b)g=Aa.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(a);else{var l=new f(a,"base64");g=new Oa;g.wireDecode(l)}l=g.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=l;this.certificateCache_.insertCertificate(g)}else g=
this.certificateCache_.getCertificate(new c(g));return g};Aa.prototype.lookupCertificateV2=function(a,b){if(this.isSecurityV1_)throw new x(Error("lookupCertificateV2: For security v1, use lookupCertificate()"));var g;g=this.fixedCertificateCache[a];if(void 0===g){if(b)g=Aa.TrustAnchorRefreshManager.loadCertificateV2FromFile(a);else{var l=new f(a,"base64");g=new O;g.wireDecode(l)}l=g.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=l;this.certificateCacheV2_.insert(g)}else g=this.certificateCacheV2_.find(new c(g));
return g};Aa.prototype.findMatchingRule=function(a,b){for(var g=this.config.getRoot().get("validator/rule"),f=0;f<g.length;++f){var u=g[f];if(u.get("for")[0].getValue()==b){var A=!0,l=u.get("filter");if(0==l.length)return u;for(var ha=0;ha<l.length;++ha){var m=l[ha],A=m.getFirstValue("regex");null===A?(A=m.get("relation")[0].getValue(),m=m.get("name")[0].getValue(),m=new c(m),A=Aa.matchesRelation(a,m,A)):A=(new $a(A)).match(a);if(!A)break}if(A)return u}}return null};Aa.matchesRelation=function(a,
b,c){var g=!1;"is-strict-prefix-of"==c?b.size()==a.size()?g=!1:b.match(a)&&(g=!0):"is-prefix-of"==c?b.match(a)&&(g=!0):"equal"==c&&b.equals(a)&&(g=!0);return g};Aa.extractSignature=function(a,b){if(a instanceof S)return a.getSignature();if(a instanceof E){b=b||t.getDefaultWireFormat();try{var c=b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(g){return null}return c}return null};Aa.prototype.interestTimestampIsFresh=function(a,b,c){a=
this.keyTimestamps[a.toUri()];if(void 0==a){a=(new Date).getTime();var g=a+this.keyGraceInterval;if(b>a-this.keyGraceInterval&&b<g)return!0;c[0]="The command interest timestamp is not within the first use grace period of "+this.keyGraceInterval+" milliseconds.";return!1}return b<=a?(c[0]="The command interest timestamp is not newer than the previous timestamp",!1):!0};Aa.prototype.updateTimestampForKey=function(a,b){this.keyTimestamps[a.toUri()]=b;var c=0,g=[],u=(new Date).getTime(),A=u,f=null,l;
for(l in this.keyTimestamps){++c;var m=this.keyTimestamps[l];u-m>this.keyTimestampTtl?g.push(l):m<A&&(A=m,f=l)}if(c>=this.maxTrackedKeys){for(u=0;u<g.length;++u)delete this.keyTimestamps[g[u]],--c;c>this.maxTrackedKeys&&delete this.keyTimestamps[f]}};Aa.prototype.verify=function(a,b,c){var g=W.getFromSignature(a);if(g.getType()==va.KEYNAME){var g=g.getKeyName(),u;if(this.isSecurityV1_){var A=this.refreshManager.getCertificate(g);null==A&&(A=this.certificateCache_.getCertificate(g));if(null==A){c(!1,
"Cannot find a certificate with name "+g.toUri());return}u=A.getPublicKeyInfo().getKeyDer();if(u.isNull()){c(!1,"There is no public key in the certificate with name "+A.getName().toUri());return}}else{A=this.refreshManager.getCertificateV2(g);null==A&&(A=this.certificateCacheV2_.find(g));if(null==A){c(!1,"Cannot find a certificate with name "+g.toUri());return}try{u=A.getPublicKey()}catch(f){c(!1,"There is no public key in the certificate with name "+A.getName().toUri());return}}pb.verifySignature(a,
b,u,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}else c(!1,"The KeyLocator does not have a key name")};Aa.TrustAnchorRefreshManager=function(a){this.isSecurityV1_=a;this.certificateCache_=new md;this.certificateCacheV2_=new ec;this.refreshDirectories={}};Aa.TrustAnchorRefreshManager.loadIdentityCertificateFromFile=function(a){a=Rb.readFileSync(a).toString();a=new f(a,"base64");var b=new Oa;b.wireDecode(new m(a,!1));return b};Aa.TrustAnchorRefreshManager.loadCertificateV2FromFile=
function(a){a=Rb.readFileSync(a).toString();a=new f(a,"base64");var b=new O;b.wireDecode(new m(a,!1));return b};Aa.TrustAnchorRefreshManager.prototype.getCertificate=function(a){if(!this.isSecurityV1_)throw new x(Error("getCertificate: For security v2, use getCertificateV2()"));return this.certificateCache_.getCertificate(a)};Aa.TrustAnchorRefreshManager.prototype.getCertificateV2=function(a){if(this.isSecurityV1_)throw new x(Error("getCertificateV2: For security v1, use getCertificate()"));return this.certificateCacheV2_.find(a)};
Aa.TrustAnchorRefreshManager.prototype.addDirectory=function(a,b){var c;try{c=Rb.readdirSync(a)}catch(g){throw new x(Error("Cannot list files in directory "+a));}for(var u=[],A=0;A<c.length;++A){if(this.isSecurityV1_){var f;try{var l=ke.join(a,c[A]);f=Aa.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(l)}catch(m){continue}var q=f.getName().getPrefix(-1).toUri();this.certificateCache_.insertCertificate(f)}else{try{l=ke.join(a,c[A]),f=Aa.TrustAnchorRefreshManager.loadCertificateV2FromFile(l)}catch(t){continue}q=
O.extractKeyNameFromCertName(f.getName()).toUri();this.certificateCacheV2_.insert(f)}u.push(q)}this.refreshDirectories[a]={certificates:u,nextRefresh:(new Date).getTime()+b,refreshPeriod:b}};Aa.TrustAnchorRefreshManager.prototype.refreshAnchors=function(){var a=(new Date).getTime(),b;for(b in this.refreshDirectories){var g=this.refreshDirectories[b];if(g.nextRefresh<=a){for(var f=g.certificates.slice(0),u=0;u<f.length;++u)try{if(this.isSecurityV1_)this.certificateCache_.deleteCertificate(new c(f[u]));
else{var A=this.certificateCacheV2_.find(new c(f[u]));null!=A&&this.certificateCacheV2_.deleteCertificate(A.getName())}}catch(l){}this.addDirectory(b,g.refreshPeriod)}}};var c=a.Name,pb=a.PolicyManager,P=a.NdnCommon,hc=function(){pb.call(this)};hc.prototype=new pb;hc.prototype.name="NoVerifyPolicyManager";s.NoVerifyPolicyManager=hc;hc.prototype.skipVerifyAndTrust=function(a){return!0};hc.prototype.requireVerify=function(a){return!1};hc.prototype.checkVerificationPolicy=function(a,b,c,g,u){try{c(a)}catch(A){console.log("Error in onVerified: "+
P.getErrorWithStackTrace(A))}return null};hc.prototype.checkSigningPolicy=function(a,b){return!0};hc.prototype.inferSigningIdentity=function(a){return new c};var c=a.Name,E=a.Interest,S=a.Data,m=a.Blob,Oa=a.IdentityCertificate,W=a.KeyLocator,va=a.KeyLocatorType,x=a.SecurityException,t=a.WireFormat,b=a.SyncPromise,pb=a.PolicyManager,ba=a.IdentityStorage,P=a.NdnCommon,Wc=function(a){pb.call(this);a instanceof ba?(this.identityStorage_=a,this.pibImpl_=null):(this.identityStorage_=null,this.pibImpl_=
a)};Wc.prototype=new pb;Wc.prototype.name="SelfVerifyPolicyManager";s.SelfVerifyPolicyManager=Wc;Wc.prototype.skipVerifyAndTrust=function(a){return!1};Wc.prototype.requireVerify=function(a){return!0};Wc.prototype.checkVerificationPolicy=function(a,b,c,g,u){u=u||t.getDefaultWireFormat();if(a instanceof S)this.verify(a.getSignature(),a.wireEncode(),function(b,u){if(b)try{c(a)}catch(y){console.log("Error in onVerified: "+P.getErrorWithStackTrace(y))}else try{g(a,u)}catch(A){console.log("Error in onValidationFailed: "+
P.getErrorWithStackTrace(A))}});else if(a instanceof E){if(2>a.getName().size()){try{g(a,"The signed interest has less than 2 components: "+a.getName().toUri())}catch(A){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(A))}return}var f;try{f=u.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(l){try{g(a,"Error decoding the signed interest signature: "+l)}catch(m){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(m))}return}this.verify(f,
a.wireEncode(),function(b,u){if(b)try{c(a)}catch(y){console.log("Error in onVerified: "+P.getErrorWithStackTrace(y))}else try{g(a,u)}catch(A){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(A))}})}else throw new x(Error("checkVerificationPolicy: unrecognized type for dataOrInterest"));return null};Wc.prototype.checkSigningPolicy=function(a,b){return!0};Wc.prototype.inferSigningIdentity=function(a){return new c};Wc.prototype.verify=function(a,b,c){if(W.canGetFromSignature(a))this.getPublicKeyDer(W.getFromSignature(a),
function(g,A){if(g.isNull())c(!1,A);else try{pb.verifySignature(a,b,g,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(f){c(!1,"Error in verifySignature: "+f)}});else try{pb.verifySignature(a,b,null,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(g){c(!1,"Error in verifySignature: "+g)}};Wc.prototype.getPublicKeyDer=function(a,c){if(a.getType()==va.KEYNAME&&null!=this.identityStorage_){var g;try{g=Oa.certificateNameToPublicKeyName(a.getKeyName())}catch(f){c(new m,
"Cannot get a public key name from the certificate named: "+a.getKeyName().toUri());return}b.complete(c,function(a){c(new m,"The identityStorage doesn't have the key named "+g.toUri())},this.identityStorage_.getKeyPromise(g,!c))}else a.getType()==va.KEYNAME&&null!=this.pibImpl_?b.complete(c,function(a){c(new m,"The identityStorage doesn't have the key named "+g.toUri())},this.pibImpl_.getKeyBitsPromise(a.getKeyName(),!c)):c(new m,"The signature KeyLocator doesn't have a key name")};var X=a,c=a.Name,
m=a.Blob,zb=a.KeyIdType,ra=a.PibKey,fb=a.Tpm,b=a.SyncPromise,Ia=function(){};s.TpmBackEnd=Ia;Ia.Error=function(a){if(a)return a.__proto__=Ia.Error.prototype,a};Ia.Error.prototype=Error();Ia.Error.prototype.name="TpmBackEndError";Ia.prototype.hasKeyPromise=function(a,b){return this.doHasKeyPromise_(a,b)};Ia.prototype.getKeyHandlePromise=function(a,b){return this.doGetKeyHandlePromise_(a,b)};Ia.prototype.createKeyPromise=function(a,g,v){var f=this;return b.resolve().then(function(){if(g.getKeyIdType()==
zb.USER_SPECIFIED){var u=ra.constructKeyName(a,g.getKeyId());return f.hasKeyPromise(u,v).then(function(a){return a?b.reject(new fb.Error(Error("Key `"+u.toUri()+"` already exists"))):b.resolve()})}if(g.getKeyIdType()==zb.SHA256)return b.resolve();if(g.getKeyIdType()==zb.RANDOM){var A,l=function(){var g=X.randomBytes(8);A=new c.Component(new m(g,!1));g=ra.constructKeyName(a,A);return f.hasKeyPromise(g,v).then(function(a){return a?l():b.resolve()})};return l().then(function(){g.setKeyId(A);return b.resolve()})}return b.reject(new fb.Error(Error("Unsupported key id type")))}).then(function(){return f.doCreateKeyPromise_(a,
g,v)})};Ia.prototype.deleteKeyPromise=function(a,b){return this.doDeleteKeyPromise_(a,b)};Ia.prototype.exportKeyPromise=function(a,c,g){var f=this;return this.hasKeyPromise(a,g).then(function(u){return u?f.doExportKeyPromise_(a,c,g):b.reject(new Ia.Error(Error("Key `"+a.toUri()+"` does not exist")))})};Ia.prototype.importKeyPromise=function(a,c,g,f){var u=this;return this.hasKeyPromise(a,f).then(function(A){return A?b.reject(new Ia.Error(Error("Key `"+a.toUri()+"` already exists"))):u.doImportKeyPromise_(a,
c,g,f)})};Ia.setKeyName=function(a,b,g){if(g.getKeyIdType()==zb.USER_SPECIFIED)g=g.getKeyId();else if(g.getKeyIdType()==zb.SHA256)g=X.createHash("sha256"),g.update(a.derivePublicKey().buf()),g=c.Component(new m(g.digest(),!1));else if(g.getKeyIdType()==zb.RANDOM){if(0==g.getKeyId().getValue().size())throw new Ia.Error(Error("setKeyName: The keyId is empty for type RANDOM"));g=g.getKeyId()}else throw new Ia.Error(Error("setKeyName: unrecognized params.getKeyIdType()"));a.setKeyName(ra.constructKeyName(b,
g))};Ia.prototype.doHasKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doHasKeyPromise_ is not implemented"))};Ia.prototype.doGetKeyHandlePromise_=function(a,c){return b.reject(Error("TpmBackEnd.doGetKeyHandlePromise_ is not implemented"))};Ia.prototype.doCreateKeyPromise_=function(a,c,g){return b.reject(Error("TpmBackEnd.doCreateKeyPromise_ is not implemented"))};Ia.prototype.doDeleteKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doDeleteKeyPromise_ is not implemented"))};
Ia.prototype.doExportKeyPromise_=function(a,c,g){return b.reject(Error("TpmBackEnd.doExportKeyPromise_ is not implemented"))};Ia.prototype.doImportKeyPromise_=function(a,c,g,f){return b.reject(Error("TpmBackEnd.doImportKeyPromise_ is not implemented"))};var b=a.SyncPromise,R=a.TpmPrivateKey,Ad=a.TpmKeyHandleMemory,Ia=a.TpmBackEnd,dc=function(){Ia.call(this);this.keys_={}};dc.prototype=new Ia;dc.prototype.name="TpmBackEndMemory";s.TpmBackEndMemory=dc;dc.getScheme=function(){return"tpm-memory"};dc.prototype.doHasKeyPromise_=
function(a,c){return b.resolve(a.toUri()in this.keys_)};dc.prototype.doGetKeyHandlePromise_=function(a,c){var g=this.keys_[a.toUri()];return void 0==g?b.resolve(null):b.resolve(new Ad(g))};dc.prototype.doCreateKeyPromise_=function(a,c,g){var f=this;return R.generatePrivateKeyPromise(c,g).then(function(g){var v=new Ad(g);Ia.setKeyName(v,a,c);f.keys_[v.getKeyName().toUri()]=g;return b.resolve(v)},function(a){return b.reject(new Ia.Error(Error("Error in TpmPrivateKey.generatePrivateKey: "+a)))})};dc.prototype.doDeleteKeyPromise_=
function(a,c){delete this.keys_[a.toUri()];return b.resolve()};Ia.prototype.doExportKeyPromise_=function(a,c,g){a=a.toUri();if(!(a in this.keys_))return b.reject(new Ia.Error(Error("exportKey: The key does not exist")));try{return null!=c?b.resolve(this.keys_[a].toEncryptedPkcs8(c)):b.resolve(this.keys_[a].toPkcs8())}catch(f){return b.reject(new Ia.Error(Error("Error in toPkcs8: "+f)))}};dc.prototype.doImportKeyPromise_=function(a,c,g,f){try{var u=new R;null!=g?u.loadEncryptedPkcs8(c,g):u.loadPkcs8(c);
this.keys_[a.toUri()]=u;return b.resolve()}catch(A){return b.reject(new Ia.Error(Error("Cannot import private key: "+A)))}};var c=a.Name,b=a.SyncPromise,ic=function(){this.keyName_=new c};s.TpmKeyHandle=ic;ic.prototype.signPromise=function(a,b,c){return this.doSignPromise_(a,b,c)};ic.prototype.decryptPromise=function(a,b){return this.doDecryptPromise_(a,b)};ic.prototype.derivePublicKey=function(a){return this.doDerivePublicKey_(a)};ic.prototype.setKeyName=function(a){this.keyName_=new c(a)};ic.prototype.getKeyName=
function(){return this.keyName_};ic.prototype.doSignPromise_=function(a,c,g){return b.reject(Error("TpmKeyHandle.doSignPromise_ is not implemented"))};ic.prototype.doDecryptPromise_=function(a,c){return b.reject(Error("TpmKeyHandle.doDecryptPromise_ is not implemented"))};ic.prototype.doDerivePublicKey_=function(a){return b.reject(Error("TpmKeyHandle.doDerivePublicKey_ is not implemented"))};m=a.Blob;b=a.SyncPromise;Ha=a.DigestAlgorithm;R=a.TpmPrivateKey;Ia=a.TpmBackEnd;ic=a.TpmKeyHandle;Ad=function(a){ic.call(this);
if(null==a)throw Error("The key is null");this.key_=a};Ad.prototype=new ic;Ad.prototype.name="TpmKeyHandleMemory";s.TpmKeyHandleMemory=Ad;Ad.prototype.doSignPromise_=function(a,c,g){return a==Ha.SHA256?this.key_.signPromise(c,a,g).catch(function(a){return b.reject(new Ia.Error(Error("Error in TpmPrivateKey.sign: "+a)))}):b.resolve(new m)};Ad.prototype.doDecryptPromise_=function(a,c){return this.key_.decryptPromise(a,c).catch(function(a){return b.reject(new Ia.Error(Error("Error in TpmPrivateKey.decrypt: "+
a)))})};ic.prototype.doDerivePublicKey_=function(){try{return this.key_.derivePublicKey()}catch(a){throw new Ia.Error(Error("Error in TpmPrivateKey.derivePublicKey: "+a));}};var xd=a.constants,X=a,ea=a.KeyType,fa=a.EncryptAlgorithmType,Ha=a.DigestAlgorithm,M=a.DataUtils,b=a.SyncPromise,l=a.DerNode,Yd=a.DerNode.DerSequence,nd=a.DerNode.DerInteger,nb=a.OID,m=a.Blob,Hb=a.UseSubtleCrypto,Ec=null;try{Ec=a}catch(nf){}R=function(){this.decryptSubtleKey_=this.subtleKey_=this.privateKey_=this.keyType_=null};
s.TpmPrivateKey=R;R.Error=function(a){if(a)return a.__proto__=R.Error.prototype,a};R.Error.prototype=Error();R.Error.prototype.name="TpmPrivateKeyError";R.prototype.loadPkcs1=function(a,b){a instanceof m&&(a=a.buf());if(void 0==b)try{var c=l.parse(a).getChildren();b=9==c.length&&c[0]instanceof nd&&0==c[0].toVal()&&c[1]instanceof nd&&c[2]instanceof nd&&c[3]instanceof nd&&c[4]instanceof nd&&c[5]instanceof nd&&c[6]instanceof nd&&c[7]instanceof nd&&c[8]instanceof nd?ea.RSA:ea.EC}catch(g){b=ea.EC}if(b==
ea.EC){for(var c=a.toString("base64"),u="-----BEGIN EC PRIVATE KEY-----\n",f=0;f<c.length;f+=64)u+=c.substr(f,64)+"\n";this.privateKey_=u+"-----END EC PRIVATE KEY-----"}else if(b==ea.RSA){c=a.toString("base64");u="-----BEGIN RSA PRIVATE KEY-----\n";for(f=0;f<c.length;f+=64)u+=c.substr(f,64)+"\n";this.privateKey_=u+="-----END RSA PRIVATE KEY-----"}else throw new R.Error(Error("loadPkcs1: Unrecognized keyType: "+b));this.keyType_=b;this.decryptSubtleKey_=this.subtleKey_=null};R.prototype.loadPkcs8=
function(a,b){a instanceof m&&(a=a.buf());var c;if(void 0==b){var g;try{var u=l.parse(a),f=u.getChildren();g=l.getSequence(f,1).getChildren()[0].toVal();c=f[2].toVal()}catch(q){try{this.loadPkcs1(a);return}catch(ha){throw new R.Error(Error("loadPkcs8: Error decoding private key: "+ha));}}if(g==R.EC_ENCRYPTION_OID)b=ea.EC;else if(g==R.RSA_ENCRYPTION_OID)b=ea.RSA;else throw new R.Error(Error("loadPkcs8: Unrecognized private key OID: "+g));}else u=l.parse(a),c=u.getChildren()[2].toVal();this.loadPkcs1(c,
b)};R.prototype.loadEncryptedPkcs8=function(a,b){a instanceof m&&(a=a.buf());b instanceof m&&(b=b.buf());var c,g,u;try{var A=l.parse(a,0).getChildren(),q=l.getSequence(A,0).getChildren();c=q[0].toVal();g=q[1];u=A[1].toVal()}catch(ha){throw new R.Error(Error("Cannot decode the PKCS #8 EncryptedPrivateKeyInfo: "+ha));}var t;if(c==R.PBES2_OID){var s,x,G,Q;try{var Eb=g.getChildren(),ob=l.getSequence(Eb,0).getChildren();s=ob[0].toVal();x=ob[1];var ze=l.getSequence(Eb,1).getChildren();G=ze[0].toVal();Q=
ze[1]}catch(Oe){throw new R.Error(Error("Cannot decode the PBES2 parameters: "+Oe));}c=null;if(s==R.PBKDF2_OID){var Ae,Be;try{var Ce=x.getChildren();Ae=Ce[0].toVal();Be=Ce[1].toVal()}catch(De){throw new R.Error(Error("Cannot decode the PBES2 parameters: "+De));}if(G==R.DES_EDE3_CBC_OID)s=R.DES_EDE3_KEY_LENGTH;else throw new R.Error(Error("Unrecognized PBES2 encryption scheme OID: "+G));try{c=X.pbkdf2Sync(b,Ae.buf(),Be,s,"sha1")}catch(Bd){throw new R.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+
Bd));}}else throw new R.Error(Error("Unrecognized PBES2 key derivation OID: "+s));if(G==R.DES_EDE3_CBC_OID){var Md;try{Md=Q.toVal()}catch(rc){throw new R.Error(Error("Cannot decode the DES-EDE3-CBC parameters: "+rc));}try{var Bb=X.createDecipheriv("des-ede3-cbc",c,Md.buf());t=f.concat([Bb.update(u.buf()),Bb.final()])}catch(Pe){throw new R.Error(Error("Error decrypting PKCS #8 key with DES-EDE3-CBC: "+Pe));}}else throw new R.Error(Error("Unrecognized PBES2 encryption scheme OID: "+G));}else throw new R.Error(Error("Unrecognized PKCS #8 EncryptedPrivateKeyInfo OID: "+
c));this.loadPkcs8(t)};R.prototype.derivePublicKey=function(){if(this.keyType_!=ea.RSA)throw new R.Error(Error("derivePublicKey: The private key is not loaded"));try{var a=M.privateKeyPemToDer(this.privateKey_),b=l.parse(a,0).getChildren(),c=b[1],g=b[2],u=new l.DerSequence;u.addChild(c);u.addChild(g);var f=u.encode(),m=new l.DerSequence;m.addChild(new l.DerOid(new nb(R.RSA_ENCRYPTION_OID)));m.addChild(new l.DerNull);var ha=new l.DerSequence;ha.addChild(m);ha.addChild(new l.DerBitString(f.buf(),0));
return ha.encode()}catch(q){throw new R.Error(Error("derivePublicKey: Error decoding private key "+q));}};R.prototype.decryptPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);void 0==c&&(c=fa.RsaOaep);if(null==this.keyType_)return b.reject(new R.Error(Error("decrypt: The private key is not loaded")));if(Hb()&&!g&&c!=fa.RsaPkcs)return c==fa.RsaOaep?this.getDecryptSubtleKeyPromise_().then(function(b){return crypto.subtle.decrypt({name:"RSA-OAEP"},b,a)}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),
!1))}):Promise.reject(Error("Unsupported padding scheme"));if(c==fa.RsaPkcs)c=xd.RSA_PKCS1_PADDING;else if(c==fa.RsaOaep)c=xd.RSA_PKCS1_OAEP_PADDING;else return b.reject(new R.Error(Error("Unsupported padding scheme")));try{return b.resolve(new m(X.privateDecrypt({key:this.privateKey_,padding:c},a),!1))}catch(f){return b.reject(new R.Error(f))}};R.prototype.signPromise=function(a,c,g){if(null==this.keyType_)return b.resolve(new m);if(c!=Ha.SHA256)return b.reject(new R.Error(Error("TpmPrivateKey.sign: Unsupported digest algorithm")));
if(Hb()&&!g){var l;if(this.keyType_===ea.RSA)l={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};else return b.reject(new R.Error(Error("signPromise: Unrecognized key type "+this.keyType_)));return this.getSubtleKeyPromise_().then(function(b){return crypto.subtle.sign(l,b,a)}).then(function(a){a=new m(new Uint8Array(a),!0);return Promise.resolve(a)})}if(this.keyType_===ea.RSA)c=X.createSign("RSA-SHA256");else if(this.keyType===ea.EC)c=X.createSign("sha256");else return b.reject(new R.Error(Error("signPromise: Unrecognized key type "+
this.keyType_)));c.update(a);c=new f(M.toNumbersIfString(c.sign(this.privateKey_)));c=new m(c,!1);return b.resolve(c)};R.prototype.toPkcs1=function(){if(null==this.keyType_)throw new R.Error(Error("toPkcs1: The private key is not loaded"));return new m(M.privateKeyPemToDer(this.privateKey_),!1)};R.prototype.toPkcs8=function(){if(null==this.keyType_)throw new R.Error(Error("toPkcs8: The private key is not loaded"));var a;if(this.keyType_===ea.RSA)a=new nb(R.RSA_ENCRYPTION_OID);else if(this.keyType===
ea.EC)a=new nb(R.EC_ENCRYPTION_OID);else throw new R.Error(Error("toPkcs8: Unrecognized key type "+this.keyType_));return R.encodePkcs8PrivateKey(this.toPkcs1().buf(),a,new l.DerNull)};R.prototype.toEncryptedPkcs8=function(a){if(null==this.keyType_)throw new R.Error(Error("toPkcs8: The private key is not loaded"));a instanceof m&&(a=a.buf());var b=X.randomBytes(8),c;try{c=X.pbkdf2Sync(a,b,2048,R.DES_EDE3_KEY_LENGTH,"sha1")}catch(g){throw new R.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+
g));}var u;a=X.randomBytes(8);try{var A=X.createCipheriv("des-ede3-cbc",c,a);u=f.concat([A.update(this.toPkcs8().buf()),A.final()])}catch(q){throw new R.Error(Error("Error encrypting PKCS #8 key with DES-EDE3-CBC: "+q));}try{var ha=new Yd;ha.addChild(new l.DerOctetString(b));ha.addChild(new l.DerInteger(2048));var t=new Yd;t.addChild(new l.DerOid(R.PBKDF2_OID));t.addChild(ha);var s=new Yd;s.addChild(new l.DerOid(R.DES_EDE3_CBC_OID));s.addChild(new l.DerOctetString(a));var x=new Yd;x.addChild(t);x.addChild(s);
var G=new Yd;G.addChild(new l.DerOid(R.PBES2_OID));G.addChild(x);var Q=new Yd;Q.addChild(G);Q.addChild(new l.DerOctetString(u));return Q.encode()}catch(Eb){throw new R.Error(Error("Error encoding the encryped PKCS #8 private key: "+Eb));}};R.generatePrivateKeyPromise=function(a,c){if(Hb()&&!c){if(a.getKeyType()===ea.RSA){var g=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){g=
a.privateKey;return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){var c=new R;c.loadPkcs8(new m(new Uint8Array(a),!1),ea.RSA);c.subtleKey_=g;return b.resolve(c)})}return Promise.reject(Error("Cannot generate a key pair of type "+a.getKeyType()))}var f;if(a.getKeyType()===ea.RSA){if(!Ec)return b.reject(new R.Error(Error("Need to install rsa-keypair: sudo npm install rsa-keypair")));f=Ec.generate(a.getKeySize()).privateKey.toString()}else return b.reject(Error("Cannot generate a key pair of type "+
a.getKeyType()));var u=new R;u.privateKey_=f;u.keyType_=a.getKeyType();return b.resolve(u)};R.encodePkcs8PrivateKey=function(a,b,c){var g=new l.DerSequence;g.addChild(new l.DerOid(b));g.addChild(c);b=new l.DerSequence;b.addChild(new l.DerInteger(0));b.addChild(g);b.addChild(new l.DerOctetString(a));return b.encode()};R.encodePkcs1PrivateKeyFromRSAKey=function(a){var b=new l.DerSequence;b.addChild(new l.DerInteger(0));b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));
b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.d)));b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.p)));b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.q)));b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.dmp1)));b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.dmq1)));b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.coeff)));return b.encode()};R.encodePublicKeyFromRSAKey=function(a){var b=new l.DerSequence;b.addChild(new l.DerInteger(R.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));
a=new l.DerSequence;a.addChild(new l.DerOid(new nb(R.RSA_ENCRYPTION_OID)));a.addChild(new l.DerNull);var c=new l.DerSequence;c.addChild(a);c.addChild(new l.DerBitString(b.encode().buf(),0));return c.encode()};R.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("TpmPrivateKey.bigIntegerToBuffer: Negative integers are not currently supported");1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new f(a,"hex")};R.prototype.getSubtleKeyPromise_=function(){if(this.subtleKey_)return Promise.resolve(this.subtleKey_);
if(this.keyType_===ea.RSA){var a=M.privateKeyPemToDer(this.privateKey_),a=R.encodePkcs8PrivateKey(a,new nb(R.RSA_ENCRYPTION_OID),new l.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){c.subtleKey_=a;return Promise.resolve(c.subtleKey_)})}return b.reject(new R.Error(Error("Unrecognized key type "+this.keyType_)))};R.prototype.getDecryptSubtleKeyPromise_=function(){if(this.decryptSubtleKey_)return Promise.resolve(this.decryptSubtleKey_);
if(this.keyType_===ea.RSA){var a=M.privateKeyPemToDer(this.privateKey_),a=R.encodePkcs8PrivateKey(a,new nb(R.RSA_ENCRYPTION_OID),new l.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){c.decryptSubtleKey_=a;return Promise.resolve(c.decryptSubtleKey_)})}return b.reject(new R.Error(Error("Unrecognized key type "+this.keyType_)))};R.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";R.EC_ENCRYPTION_OID="1.2.840.10045.2.1";R.PBES2_OID=
"1.2.840.113549.1.5.13";R.PBKDF2_OID="1.2.840.113549.1.5.12";R.DES_EDE3_CBC_OID="1.2.840.113549.3.7";R.DES_EDE3_KEY_LENGTH=24;ea=a.KeyType;b=a.SyncPromise;fb=function(a,b,c){this.keys_={};this.scheme_=a;this.location_=b;this.backEnd_=c;this.initializePib_=null;this.isInitialized_=!1};s.Tpm=fb;fb.Error=function(a){if(a)return a.__proto__=fb.Error.prototype,a};fb.Error.prototype=Error();fb.Error.prototype.name="TpmError";fb.prototype.getTpmLocator=function(){if(!this.isInitialized_)throw new fb.Error(Error("getTpmLocator: The Tpm is not initialized"));
return this.scheme_+":"+this.location_};fb.prototype.hasKeyPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.backEnd_.hasKeyPromise(a,b)})};fb.prototype.getPublicKeyPromise=function(a,c){var g=this;return this.initializePromise_(c).then(function(){return g.findKeyPromise_(a,c)}).then(function(a){return null==a?b.resolve(new m):b.resolve(a.derivePublicKey())})};fb.prototype.signPromise=function(a,c,g,f){var u=this;return this.initializePromise_(f).then(function(){return u.findKeyPromise_(c,
f)}).then(function(c){return null==c?b.resolve(new m):c.signPromise(g,a,f)})};fb.prototype.decryptPromise=function(a,c,g){var f=this;return this.initializePromise_(g).then(function(){return f.findKeyPromise_(c,g)}).then(function(c){return null==c?b.resolve(new m):c.decryptPromise(a,g)})};fb.prototype.createKeyPromise_=function(a,c,g){var f=this;return this.initializePromise_(g).then(function(){return c.getKeyType()==ea.RSA||c.getKeyType()==ea.EC?f.backEnd_.createKeyPromise(a,c,g).then(function(a){var c=
a.getKeyName();f.keys_[c.toUri()]=a;return b.resolve(c)}):b.resolve(new fb.Error(Error("createKey: Unsupported key type")))})};fb.prototype.deleteKeyPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){delete c.keys_[a.toUri()];return c.backEnd_.deleteKeyPromise(a,b)})};fb.prototype.exportPrivateKeyPromise_=function(a,b,c){var g=this;return this.initializePromise_(c).then(function(){return g.backEnd_.exportKeyPromise(a,b,c)})};fb.prototype.importPrivateKeyPromise_=function(a,
b,c,g){var u=this;return this.initializePromise_(g).then(function(){return u.backEnd_.importKeyPromise(a,b,c,g)})};fb.prototype.findKeyPromise_=function(a,c){var g=this;return this.initializePromise_(c).then(function(){var f=a.toUri(),u=g.keys_[f];return void 0!=u?b.resolve(u):g.backEnd_.getKeyHandlePromise(a,c).then(function(a){return null!=a?(g.keys_[f]=a,b.resolve(a)):b.resolve(null)})})};fb.prototype.initializePromise_=function(a){return this.isInitialized_?b.resolve():null==this.initializePib_?
(this.isInitialized_=!0,b.resolve()):this.initializePib_.initializePromise_(a)};var c=a.Name,ra=a.PibKey,J=a.ValidationError,Za=a.ConfigNameRelation,$a=a.NdnRegexTopMatcher,ua=a.ValidatorConfigError,Cb=function(){};s.ConfigChecker=Cb;Cb.prototype.check=function(a,b,c,g){return a?2>b.size()?!1:this.checkNames(b.getPrefix(-2),c,g):this.checkNames(b,c,g)};Cb.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ua(Error("Expected <checker.type>"));if("customized"==b.toLowerCase())return Cb.createCustomizedChecker_(a);
if("hierarchical"==b.toLowerCase())return Cb.createHierarchicalChecker_(a);throw new ua(Error("Unsupported checker type: "+b));};Cb.prototype.checkNames=function(a,b,c){throw Error("ConfigChecker.checkNames is not implemented");};Cb.createCustomizedChecker_=function(a){keyLocatorSection=a.get("key-locator");if(1!=keyLocatorSection.length)throw new ua(Error("Expected one <checker.key-locator>"));return Cb.createKeyLocatorChecker_(keyLocatorSection[0])};Cb.createHierarchicalChecker_=function(a){return new Zd("^(<>*)$",
"\\1","^(<>*)<KEY><>$","\\1",Za.Relation.IS_PREFIX_OF)};Cb.createKeyLocatorChecker_=function(a){var b=a.getFirstValue("type");if(null==b)throw new ua(Error("Expected <checker.key-locator.type>"));if("name"==b.toLowerCase())return Cb.createKeyLocatorNameChecker_(a);throw new ua(Error("Unsupported checker.key-locator.type: "+b));};Cb.createKeyLocatorNameChecker_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ua(Error("Expected <checker.key-locator.relation>"));
A=Za.getNameRelationFromString(a);return new le(b,A)}b=a.getFirstValue("regex");if(null!=b)try{return new me(b)}catch(g){throw new ua(Error("Invalid checker.key-locator.regex: "+b));}a=a.get("hyper-relation");if(1==a.length){var f=a[0];a=f.getFirstValue("k-regex");if(null==a)throw new ua(Error("Expected <checker.key-locator.hyper-relation.k-regex>"));b=f.getFirstValue("k-expand");if(null==b)throw new ua(Error("Expected <checker.key-locator.hyper-relation.k-expand"));A=f.getFirstValue("h-relation");
if(null==A)throw new ua(Error("Expected <checker.key-locator.hyper-relation.h-relation>"));var u=f.getFirstValue("p-regex");if(null==u)throw new ua(Error("Expected <checker.key-locator.hyper-relation.p-regex>"));f=f.getFirstValue("p-expand");if(null==f)throw new ua(Error("Expected <checker.key-locator.hyper-relation.p-expand>"));var A=Za.getNameRelationFromString(A);try{return new Zd(u,f,a,b,A)}catch(l){throw new ua(Error("Invalid regex for key-locator.hyper-relation"));}}throw new ua(Error("Unsupported checker.key-locator"));
};var le=function(a,b){Cb.call(this);this.name_=a;this.relation_=b};le.prototype=new Cb;le.prototype.name="ConfigNameRelationChecker";s.ConfigNameRelationChecker=le;le.prototype.checkNames=function(a,b,c){var g=ra.extractIdentityFromKeyName(b),u=Za.checkNameRelation(this.relation_,this.name_,g);u||c.fail(new J(J.POLICY_ERROR,"KeyLocator check failed: name relation "+this.name_.toUri()+" "+Za.toString(this.relation_)+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+", identity="+g.toUri()+
")"));return u};var me=function(a){Cb.call(this);this.regex_=new $a(a)};me.prototype=new Cb;me.prototype.name="ConfigRegexChecker";s.ConfigRegexChecker=me;me.prototype.checkNames=function(a,b,c){var g=this.regex_.match(b);g||c.fail(new J(J.POLICY_ERROR,"KeyLocator check failed: regex "+this.regex_.getExpr()+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+")"));return g};var Zd=function(a,b,c,g,u){Cb.call(this);this.packetNameRegex_=new $a(a);this.packetNameExpansion_=b;this.keyNameRegex_=
new $a(c);this.keyNameExpansion_=g;this.hyperRelation_=u};Zd.prototype=new Cb;Zd.prototype.name="ConfigHyperRelationChecker";s.ConfigHyperRelationChecker=Zd;Zd.prototype.checkNames=function(a,b,c){if(!this.packetNameRegex_.match(a))return c.fail(new J(J.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation packet name regex "+this.packetNameRegex_.getExpr())),!1;if(!this.keyNameRegex_.match(b))return c.fail(new J(J.POLICY_ERROR,"The packet "+a.toUri()+
" (KeyLocator="+b.toUri()+") does not match the hyper relation key name regex "+this.keyNameRegex_.getExpr())),!1;var g=this.keyNameRegex_.expand(this.keyNameExpansion_),u=this.packetNameRegex_.expand(this.packetNameExpansion_),f=Za.checkNameRelation(this.hyperRelation_,g,u);f||c.fail(new J(J.POLICY_ERROR,"KeyLocator check failed: hyper relation "+Za.toString(this.hyperRelation_)+" packet name match="+u.toUri()+", key name match="+g.toUri()+" of packet "+a.toUri()+" (KeyLocator="+b.toUri()+") is invalid"));
return f};var c=a.Name,Za=a.ConfigNameRelation,$a=a.NdnRegexTopMatcher,ua=a.ValidatorConfigError,sc=function(){};s.ConfigFilter=sc;sc.prototype.match=function(a,b){return a?2>b.size()?!1:this.matchName(b.getPrefix(-2)):this.matchName(b)};sc.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ua(Error("Expected <filter.type>"));if("name"==b.toLowerCase())return sc.createNameFilter_(a);throw new ua(Error("Unsupported filter.type: "+b));};sc.prototype.matchName=function(a){throw Error("ConfigFilter.matchName is not implemented");
};sc.createNameFilter_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ua(Error("Expected <filter.relation>"));a=Za.getNameRelationFromString(a);return new ne(b,a)}b=a.getFirstValue("regex");if(null!=b)try{return new oe(b)}catch(g){throw new ua(Error("Wrong filter.regex: "+b));}throw new ua(Error("Wrong filter(name) properties"));};var ne=function(a,b){sc.call(this);this.name_=new c(a);this.relation_=b};ne.prototype=new sc;ne.prototype.name=
"ConfigRelationNameFilter";s.ConfigRelationNameFilter=ne;ne.prototype.matchName=function(a){return Za.checkNameRelation(this.relation_,this.name_,a)};var oe=function(a){sc.call(this);this.regex_=new $a(a)};oe.prototype=new sc;oe.prototype.name="ConfigRegexNameFilter";s.ConfigRegexNameFilter=oe;oe.prototype.matchName=function(a){return this.regex_.match(a)};ua=a.ValidatorConfigError;Za=function(){};s.ConfigNameRelation=Za;Za.Relation=function(){};Za.Relation.EQUAL=0;Za.Relation.IS_PREFIX_OF=1;Za.Relation.IS_STRICT_PREFIX_OF=
2;Za.toString=function(a){return a==Za.Relation.EQUAL?"equal":a==Za.Relation.IS_PREFIX_OF?"is-prefix-of":a==Za.Relation.IS_STRICT_PREFIX_OF?"is-strict-prefix-of":""};Za.checkNameRelation=function(a,b,c){return a==Za.Relation.EQUAL?b.equals(c):a==Za.Relation.IS_PREFIX_OF?b.isPrefixOf(c):a==Za.Relation.IS_STRICT_PREFIX_OF?b.isPrefixOf(c)&&b.size()<c.size():!1};Za.getNameRelationFromString=function(a){if("equal"==a.toLowerCase())return Za.Relation.EQUAL;if("is-prefix-of"==a.toLowerCase())return Za.Relation.IS_PREFIX_OF;
if("is-strict-prefix-of"==a.toLowerCase())return Za.Relation.IS_STRICT_PREFIX_OF;throw new ua(Error("Unsupported relation: "+a));};var Cb=a.ConfigChecker,sc=a.ConfigFilter,ua=a.ValidatorConfigError,g=a.Log.LOG,Hc=function(a,b){this.id_=a;this.isForInterest_=b;this.filters_=[];this.checkers_=[]};s.ConfigRule=Hc;Hc.prototype.getId=function(){return this.id_};Hc.prototype.getIsForInterest=function(){return this.isForInterest_};Hc.prototype.addFilter=function(a){this.filters_.push(a)};Hc.prototype.addChecker=
function(a){this.checkers_.push(a)};Hc.prototype.match=function(a,b){3<g&&console.log("Trying to match "+b.toUri());if(a!=this.isForInterest_)throw new ua(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));if(0==this.filters_.length)return!0;for(var c=!1,f=0;f<this.filters_.length&&!(c=c||this.filters_[f].match(a,b));++f);return c};Hc.prototype.check=function(a,b,c,f){3<g&&console.log("Trying to check "+b.toUri()+" with keyLocator "+
c.toUri());if(a!=this.isForInterest_)throw new ua(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));for(var u=!1,A=0;A<this.checkers_.length;++A){u=this.checkers_[A].check(a,b,c,f);if(!u)break;u=!0}return u};Hc.create=function(a){var b=a.getFirstValue("id");if(null==b)throw new ua(Error("Expecting <rule.id>"));var c=a.getFirstValue("for");if(null==c)throw new ua(Error("Expecting <rule.for> in rule: "+b));if("data"==c.toLowerCase())c=
!1;else if("interest"==c.toLowerCase())c=!0;else throw new ua(Error("Unrecognized <rule.for>: "+c+" in rule: "+b));for(var c=new Hc(b,c),g=a.get("filter"),u=0;u<g.length;++u)c.addFilter(sc.create(g[u]));a=a.get("checker");for(u=0;u<a.length;++u)c.addChecker(Cb.create(a[u]));if(0==a.length)throw new ua(Error("No <rule.checker> is specified in rule: "+b));return c};var Rb=a,m=a.Blob,O=a.CertificateV2,tc=function(a,b){this.certificates_=a;this.id_=b;this.anchorNameUris_={}};s.TrustAnchorGroup=tc;tc.prototype.getId=
function(){return this.id_};tc.prototype.size=function(){return Object.keys(this.anchorNameUris_).length};tc.prototype.refresh=function(){};tc.readCertificate=function(a){try{var b=Rb.readFileSync(a).toString(),c=new f(b,"base64"),g=new O;g.wireDecode(new m(c,!1));return g}catch(u){return null}};var b=a.SyncPromise,J=a.ValidationError,g=a.Log.LOG,Ua=a.VerificationHelpers,O=a.CertificateV2,Ib=function(){this.certificateChain_=[];this.seenCertificateNameUris_={};this.outcome_=this.hasOutcome_=!1};s.ValidationState=
Ib;Ib.prototype.hasOutcome=function(){return this.hasOutcome_};Ib.prototype.isOutcomeFailed=function(){return this.hasOutcome_&&!1==this.outcome_};Ib.prototype.isOutcomeSuccess=function(){return this.hasOutcome_&&!0==this.outcome_};Ib.prototype.fail=function(a){throw Error("ValidationState.fail is not implemented");};Ib.prototype.getDepth=function(){return this.certificateChain_.length};Ib.prototype.hasSeenCertificateName=function(a){a=a.toUri();if(void 0!==this.seenCertificateNameUris_[a])return!0;
this.seenCertificateNameUris_[a]=!0;return!1};Ib.prototype.addCertificate=function(a){this.certificateChain_.unshift(new O(a))};Ib.prototype.setOutcome=function(a){if(this.hasOutcome_)throw Error("The ValidationState already has an outcome");this.hasOutcome_=!0;this.outcome_=a};Ib.prototype.verifyOriginalPacketPromise_=function(a){return b.reject(Error("ValidationState.verifyOriginalPacketPromise_ is not implemented"))};Ib.prototype.bypassValidation_=function(){throw Error("ValidationState.bypassValidation_ is not implemented");
};Ib.prototype.verifyCertificateChainPromise_=function(a){var c=a,f=this,l=function(a){if(a>=f.certificateChain_.length)return b.resolve(c);var A=f.certificateChain_[a];return Ua.verifyDataSignaturePromise(A,c).then(function(m){if(m)3<g&&console.log("OK signature for certificate `"+A.getName().toUri()+"`"),c=A;else{for(f.fail(new J(J.INVALID_SIGNATURE,"Invalid signature of certificate `"+A.getName().toUri()+"`"));f.certificateChain_.length>a;)f.certificateChain_.splice(a,1);return b.resolve(null)}++a;
return l(a)})};return l(0)};var c=a.Name,ja=a.Schedule,O=a.CertificateV2,g=a.Log.LOG,ec=function y(a){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE;this.maxLifetimeMilliseconds_=void 0==a?y.getDefaultLifetime():a;this.nowOffsetMilliseconds_=0};s.CertificateCacheV2=ec;ec.prototype.insert=function(a){var b=a.getValidityPeriod().getNotAfter(),c=(new Date).getTime()+this.nowOffsetMilliseconds_;if(b<c)3<g&&console.log("Not adding "+a.getName().toUri()+": already expired at "+ja.toIsoString(b));
else{b=Math.min(b,c+this.maxLifetimeMilliseconds_);b<this.nextRefreshTime_&&(this.nextRefreshTime_=b);3<g&&console.log("Adding "+a.getName().toUri()+", will remove in "+(b-c)/36E5+" hours");a=new O(a);var c=a.getName(),u=this.findFirstByName_(c);if(0>u)u=this.certificatesByName_.length;else if(this.certificatesByName_[u].name.equals(c)){this.certificatesByName_[u].certificate=a;this.certificatesByName_[u].removalTime=b;return}this.certificatesByName_.splice(u,0,{name:c,certificate:a,removalTime:b})}};
ec.prototype.find=function(a){if(a instanceof c){0<a.size()&&a.get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();var b=this.findFirstByName_(a);if(0>b)return null;b=this.certificatesByName_[b];return a.isPrefixOf(b.certificate.getName())?b.certificate:null}null!=a.getChildSelector()&&console.log("Certificate search using a ChildSelector is not supported. Searching as if this selector not specified");0<a.getName().size()&&
a.getName().get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();b=this.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.certificatesByName_.length;++b){var g=this.certificatesByName_[b].certificate;if(!a.getName().isPrefixOf(g.getName()))break;if(a.matchesData(g))return g}return null};ec.prototype.deleteCertificate=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(this.certificatesByName_[b].name.equals(a)){this.certificatesByName_.splice(b,
1);break}};ec.prototype.clear=function(){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE};ec.getDefaultLifetime=function(){return 36E5};ec.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};ec.prototype.findFirstByName_=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(0<=this.certificatesByName_[b].name.compare(a))return b;return-1};ec.prototype.refresh_=function(){var a=(new Date).getTime()+this.nowOffsetMilliseconds_;if(!(a<this.nextRefreshTime_)){for(var b=
Number.MAX_VALUE,c=this.certificatesByName_.length-1;0<=c;--c){var g=this.certificatesByName_[c];g.removalTime<=a?this.certificatesByName_.splice(c,1):b=Math.min(b,g.removalTime)}this.nextRefreshTime_=b}};var pe=function(){};s.CertificateContainerInterface=pe;pe.prototype.add=function(a){throw Error("CertificateContainerInterface.add is unimplemented");};pe.prototype.remove=function(a){throw Error("CertificateContainerInterface.remove is unimplemented");};var g=a.Log.LOG,uc=function(){this.certificateStorage_=
null};s.CertificateFetcher=uc;uc.prototype.setCertificateStorage=function(a){this.certificateStorage_=a};uc.prototype.fetch=function(a,b,c){if(null==this.certificateStorage_)throw Error("CertificateFetcher.fetch: You must first call setCertificateStorage");var u=this.certificateStorage_.getUnverifiedCertificateCache().find(a.interest_);if(null!=u)3<g&&console.log("Found certificate in **un**verified key cache "+u.getName().toUri()),c(u,b);else{var f=this;this.doFetch_(a,b,function(a,b){f.certificateStorage_.cacheUnverifiedCertificate(a);
c(a,b)})}};uc.prototype.doFetch_=function(a,b,c){throw Error("CertificateFetcher.doFetch_ is not implemented");};var g=a.Log.LOG,O=a.CertificateV2,J=a.ValidationError,uc=a.CertificateFetcher,Nd=function(a){uc.call(this);this.face_=a};Nd.prototype=new uc;Nd.prototype.name="CertificateFetcherFromNetwork";s.CertificateFetcherFromNetwork=Nd;Nd.prototype.doFetch_=function(a,b,c){var u=this;try{u.face_.expressInterest(a.interest_,function(a,u){3<g&&console.log("Fetched certificate from network "+u.getName().toUri());
var f;try{f=new O(u)}catch(A){b.fail(new J(J.MALFORMED_CERTIFICATE,"Fetched a malformed certificate `"+u.getName().toUri()+"` ("+A+")"));return}try{c(f,b)}catch(l){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Error in continueValidation: "+l))}},function(f){3<g&&console.log("Timeout while fetching certificate "+a.interest_.getName().toUri()+", retrying");--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{u.fetch(a,b,c)}catch(A){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+A))}else b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,
"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))},function(f,A){3<g&&console.log("NACK ("+A.getReason()+") while fetching certificate "+a.interest_.getName().toUri());--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{u.fetch(a,b,c)}catch(l){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+l))}else b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))})}catch(f){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,
"Error in expressInterest: "+f))}};var J=a.ValidationError,uc=a.CertificateFetcher,Cd=function(){uc.call(this)};Cd.prototype=new uc;Cd.prototype.name="CertificateFetcherOffline";s.CertificateFetcherOffline=Cd;Cd.prototype.doFetch_=function(a,b,c){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate "+a.interest_.getName().toUri()+" in offline mode"))};var E=a.Interest,Dd=function(a){void 0!=a?(this.interest_=new E(a),this.nRetriesLeft_=3):(this.interest_=new E,this.nRetriesLeft_=0)};
s.CertificateRequest=Dd;var c=a.Name,lb=a.TrustAnchorContainer,O=a.CertificateV2,ec=a.CertificateCacheV2,Wb=function(){this.trustAnchors_=new lb;this.verifiedCertificateCache_=new ec(36E5);this.unverifiedCertificateCache_=new ec(3E5)};s.CertificateStorage=Wb;Wb.prototype.findTrustedCertificate=function(a){var b=this.trustAnchors_.find(a);return null!=b?b:b=this.verifiedCertificateCache_.find(a)};Wb.prototype.isCertificateKnown=function(a){return null!=this.trustAnchors_.find(a)||null!=this.verifiedCertificateCache_.find(a)||
null!=this.unverifiedCertificateCache_.find(a)};Wb.prototype.cacheUnverifiedCertificate=function(a){this.unverifiedCertificateCache_.insert(a)};Wb.prototype.getTrustAnchors=function(){return this.trustAnchors_};Wb.prototype.getVerifiedCertificateCache=function(){return this.verifiedCertificateCache_};Wb.prototype.getUnverifiedCertificateCache=function(){return this.unverifiedCertificateCache_};Wb.prototype.loadAnchor=function(a,b,c,g){this.trustAnchors_.insert(a,b,c,g)};Wb.prototype.resetAnchors=
function(){this.trustAnchors_.clear()};Wb.prototype.cacheVerifiedCertificate=function(a){this.verifiedCertificateCache_.insert(a)};Wb.prototype.resetVerifiedCertificates=function(){this.verifiedCertificateCache_.clear()};Wb.prototype.setCacheNowOffsetMilliseconds_=function(a){this.verifiedCertificateCache_.setNowOffsetMilliseconds_(a);this.unverifiedCertificateCache_.setNowOffsetMilliseconds_(a)};c=a.Name;S=a.Data;W=a.KeyLocator;va=a.KeyLocatorType;Ka=a.Sha256WithRsaSignature;Ya=a.Sha256WithEcdsaSignature;
Ea=a.ContentType;t=a.WireFormat;ja=a.Schedule;Fa=a.ValidityPeriod;fc=a.InvalidArgumentException;O=function(a){void 0!=a?(S.call(this,a),this.checkFormat_()):(S.call(this),this.getMetaInfo().setType(Ea.KEY))};O.prototype=new S;O.prototype.name="CertificateV2";s.CertificateV2=O;O.Error=function(a){if(a)return a.__proto__=O.Error.prototype,a};O.Error.prototype=Error();O.Error.prototype.name="CertificateV2Error";O.prototype.checkFormat_=function(){if(!O.isValidName(this.getName()))throw new O.Error(Error("The Data Name does not follow the certificate naming convention"));
if(this.getMetaInfo().getType()!=Ea.KEY)throw new O.Error(Error("The Data ContentType is not KEY"));if(0>this.getMetaInfo().getFreshnessPeriod())throw new O.Error(Error("The Data FreshnessPeriod is not set"));if(0==this.getContent().size())throw new O.Error(Error("The Data Content is empty"));};O.prototype.getKeyName=function(){return this.getName().getPrefix(O.KEY_ID_OFFSET+1)};O.prototype.getIdentity=function(){return this.getName().getPrefix(O.KEY_COMPONENT_OFFSET)};O.prototype.getKeyId=function(){return this.getName().get(O.KEY_ID_OFFSET)};
O.prototype.getIssuerId=function(){return this.getName().get(O.ISSUER_ID_OFFSET)};O.prototype.getPublicKey=function(){if(0==this.getContent().size())throw new O.Error(Error("The public key is not set (the Data content is empty)"));return this.getContent()};O.prototype.getValidityPeriod=function(){if(!Fa.canGetFromSignature(this.getSignature()))throw new fc(Error("The SignatureInfo does not have a ValidityPeriod"));return Fa.getFromSignature(this.getSignature())};O.prototype.isValid=function(a){return this.getValidityPeriod().isValid(a)};
O.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();S.prototype.wireDecode.call(this,a,b);this.checkFormat_()};O.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";a+="  NotBefore: "+ja.toIsoString(this.getValidityPeriod().getNotBefore())+"\n";a+="  NotAfter: "+ja.toIsoString(this.getValidityPeriod().getNotAfter())+"\n";a+="Public key bits:\n";try{for(var b=this.getPublicKey().buf().toString("base64"),c=0;c<b.length;c+=64)a+=
b.substr(c,64)+"\n"}catch(g){}a+="Signature Information:\n";a+="  Signature Type: ";a=this.getSignature()instanceof Ya?a+"SignatureSha256WithEcdsa\n":this.getSignature()instanceof Ka?a+"SignatureSha256WithRsa\n":a+"<unknown>\n";W.canGetFromSignature(this.getSignature())&&(a+="  Key Locator: ",b=W.getFromSignature(this.getSignature()),b.getType()==va.KEYNAME?(b.getKeyName().equals(this.getKeyName())&&(a+="Self-Signed "),a+="Name="+b.getKeyName().toUri()+"\n"):a+="<no KeyLocator key name>\n");return a};
O.isValidName=function(a){return a.size()>=O.MIN_CERT_NAME_LENGTH&&a.get(O.KEY_COMPONENT_OFFSET).equals(O.KEY_COMPONENT)};O.extractIdentityFromCertName=function(a){if(!O.isValidName(a))throw new fc(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(O.KEY_COMPONENT_OFFSET)};O.extractKeyNameFromCertName=function(a){if(!O.isValidName(a))throw new fc(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(O.KEY_ID_OFFSET+
1)};O.VERSION_OFFSET=-1;O.ISSUER_ID_OFFSET=-2;O.KEY_ID_OFFSET=-3;O.KEY_COMPONENT_OFFSET=-4;O.MIN_CERT_NAME_LENGTH=4;O.MIN_KEY_NAME_LENGTH=2;O.KEY_COMPONENT=new c.Component("KEY");var b=a.SyncPromise,S=a.Data,g=a.Log.LOG,J=a.ValidationError,Ib=a.ValidationState,Ua=a.VerificationHelpers,P=a.NdnCommon,od=function(a,b,c){Ib.call(this);this.data_=new S(a);this.successCallback_=b;this.failureCallback_=c;if(null==this.successCallback_)throw Error("The successCallback is null");if(null==this.failureCallback_)throw Error("The failureCallback is null");
};od.prototype=new Ib;od.prototype.name="DataValidationState";s.DataValidationState=od;od.prototype.fail=function(a){3<g&&console.log(""+a);try{this.failureCallback_(this.data_,a)}catch(b){console.log("Error in failureCallback: "+P.getErrorWithStackTrace(b))}this.setOutcome(!1)};od.prototype.getOriginalData=function(){return this.data_};od.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Ua.verifyDataSignaturePromise(this.data_,a).then(function(a){if(a){3<g&&console.log("OK signature for data `"+
c.data_.getName().toUri()+"`");try{c.successCallback_(c.data_)}catch(u){console.log("Error in successCallback: "+P.getErrorWithStackTrace(u))}c.setOutcome(!0)}else c.fail(new J(J.INVALID_SIGNATURE,"Invalid signature of data `"+c.data_.getName().toUri()+"`"));return b.resolve()})};od.prototype.bypassValidation_=function(){3<g&&console.log("Signature verification bypassed for data `"+this.data_.getName().toUri()+"`");try{this.successCallback_(this.data_)}catch(a){console.log("Error in successCallback: "+
P.getErrorWithStackTrace(a))}this.setOutcome(!0)};var ke=Rb=a,tc=a.TrustAnchorGroup,c=a.Name,g=a.Log.LOG,Od=function(a,b,c,u,f){tc.call(this,a,b);this.isDirectory_=f;this.path_=c;this.refreshPeriod_=u;this.expireTime_=0;if(0>=u)throw Error("Refresh period for the dynamic group must be positive");0<g&&console.log("Create a dynamic trust anchor group "+b+" for file/dir "+c+" with refresh time "+u);this.refresh()};Od.prototype=new tc;Od.prototype.name="DynamicTrustAnchorGroup";s.DynamicTrustAnchorGroup=
Od;Od.prototype.refresh=function(){var a=(new Date).getTime();if(!(this.expireTime_>a)){this.expireTime_=a+this.refreshPeriod_;0<g&&console.log("Reloading the dynamic trust anchor group");var a={},b;for(b in this.anchorNameUris_)a[b]=!0;if(this.isDirectory_){var f;try{f=Rb.readdirSync(this.path_)}catch(u){throw Error("Cannot list files in directory "+this.path_);}for(var A=0;A<f.length;++A)this.loadCertificate_(ke.join(this.path_,f[A]),a)}else this.loadCertificate_(this.path_,a);for(b in a)delete this.anchorNameUris_[b],
this.certificates_.remove(new c(b))}};Od.prototype.loadCertificate_=function(a,b){var c=tc.readCertificate(a);if(null!=c){var g=c.getName().toUri();this.anchorNameUris_[g]?delete b[g]:(this.anchorNameUris_[g]=!0,this.certificates_.add(c))}};var b=a.SyncPromise,E=a.Interest,g=a.Log.LOG,J=a.ValidationError,Ib=a.ValidationState,Ua=a.VerificationHelpers,P=a.NdnCommon,Xc=function(a,b,c){Ib.call(this);this.interest_=new E(a);this.successCallbacks_=[b];this.failureCallback_=c;if(null==b)throw Error("The successCallback is null");
if(null==this.failureCallback_)throw Error("The failureCallback is null");};Xc.prototype=new Ib;Xc.prototype.name="InterestValidationState";s.InterestValidationState=Xc;Xc.prototype.fail=function(a){3<g&&console.log(""+a);try{this.failureCallback_(this.interest_,a)}catch(b){console.log("Error in failureCallback: "+P.getErrorWithStackTrace(b))}this.setOutcome(!1)};Xc.prototype.getOriginalInterest=function(){return this.interest_};Xc.prototype.addSuccessCallback=function(a){this.successCallbacks_.push(a)};
Xc.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Ua.verifyInterestSignaturePromise(this.interest_,a).then(function(a){if(a){3<g&&console.log("OK signature for interest `"+c.interest_.getName().toUri()+"`");for(a=0;a<c.successCallbacks_.length;++a)try{c.successCallbacks_[a](c.interest_)}catch(u){console.log("Error in successCallback: "+P.getErrorWithStackTrace(u))}c.setOutcome(!0)}else c.fail(new J(J.INVALID_SIGNATURE,"Invalid signature of interest `"+c.interest_.getName().toUri()+
"`"));return b.resolve()})};Xc.prototype.bypassValidation_=function(){3<g&&console.log("Signature verification bypassed for interest `"+this.interest_.getName().toUri()+"`");for(var a=0;a<this.successCallbacks_.length;++a)try{this.successCallbacks_[a](this.interest_)}catch(b){console.log("Error in successCallback: "+P.getErrorWithStackTrace(b))}this.setOutcome(!0)};var tc=a.TrustAnchorGroup,Ed=function(a,b){tc.call(this,a,b)};Ed.prototype=new tc;Ed.prototype.name="StaticTrustAnchorGroup";s.StaticTrustAnchorGroup=
Ed;Ed.prototype.add=function(a){var b=a.getName().toUri();this.anchorNameUris_[b]||(this.anchorNameUris_[b]=!0,this.certificates_.add(a))};Ed.prototype.remove=function(a){delete this.anchorNameUris_[a.toUri()];this.certificates_.remove(a)};c=a.Name;Ed=a.StaticTrustAnchorGroup;Od=a.DynamicTrustAnchorGroup;O=a.CertificateV2;pe=a.CertificateContainerInterface;lb=function v(){this.groups_={};this.anchors_=new v.AnchorContainer_};s.TrustAnchorContainer=lb;lb.Error=function(a){if(a)return a.__proto__=lb.Error.prototype,
a};lb.Error.prototype=Error();lb.Error.prototype.name="TrustAnchorContainerError";lb.prototype.insert=function(a,b,c,g){if(b instanceof O){c=this.groups_[a];void 0===c&&(c=new Ed(this.anchors_,a),this.groups_[a]=c);if(!(c instanceof Ed))throw new lb.Error(Error("Cannot add a static anchor to the non-static anchor group "+a));c.add(b)}else{null==g&&(g=!1);if(void 0!==this.groups_[a])throw new lb.Error(Error("Cannot create the dynamic group, because group "+a+" already exists"));this.groups_[a]=new Od(this.anchors_,
a,b,c,g)}};lb.prototype.clear=function(){this.groups_={};this.anchors_.clear()};lb.prototype.find=function(a){if(a instanceof c){this.refresh_();var b=this.anchors_.findFirstByName_(a);if(0>b)return null;var g=this.anchors_.anchorsByName_[b].certificate;return a.isPrefixOf(g.getName())?g:null}this.refresh_();b=this.anchors_.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.anchors_.anchorsByName_.length;++b){g=this.anchors_.anchorsByName_[b].certificate;if(!a.getName().isPrefixOf(g.getName()))break;
if(a.matchesData(g))return g}return null};lb.prototype.getGroup=function(a){var b=this.groups_[a];if(void 0===b)throw new lb.Error(Error("Trust anchor group "+a+" does not exist"));return b};lb.prototype.size=function(){return this.anchors_.size()};lb.AnchorContainer_=function(){this.anchorsByName_=[]};lb.AnchorContainer_.prototype=new pe;lb.AnchorContainer_.prototype.name="TrustAnchorContainerAnchorContainer";lb.AnchorContainer_.prototype.add=function(a){a=new O(a);var b=a.getName(),c=this.findFirstByName_(b);
if(0>c)c=this.anchorsByName_.length;else if(this.anchorsByName_[c].name.equals(b)){this.anchorsByName_[c].certificate=a;return}this.anchorsByName_.splice(c,0,{name:b,certificate:a})};lb.AnchorContainer_.prototype.remove=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(this.anchorsByName_[b].name.equals(a)){this.anchorsByName_.splice(b,1);break}};lb.AnchorContainer_.prototype.clear=function(){this.anchorsByName_=[]};lb.AnchorContainer_.prototype.size=function(){return this.anchorsByName_.length};
lb.AnchorContainer_.prototype.findFirstByName_=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(0<=this.anchorsByName_[b].name.compare(a))return b;return-1};lb.prototype.refresh_=function(){for(var a in this.groups_)this.groups_[a].refresh()};J=function(a,b){this.code_=a;this.info_=void 0!=b?b:""};s.ValidationError=J;J.NO_ERROR=0;J.INVALID_SIGNATURE=1;J.NO_SIGNATURE=2;J.CANNOT_RETRIEVE_CERTIFICATE=3;J.EXPIRED_CERTIFICATE=4;J.LOOP_DETECTED=5;J.MALFORMED_CERTIFICATE=6;J.EXCEEDED_DEPTH_LIMIT=
7;J.INVALID_KEY_LOCATOR=8;J.POLICY_ERROR=9;J.IMPLEMENTATION_ERROR=255;J.USER_MIN=256;J.prototype.getCode=function(){return this.code_};J.prototype.getInfo=function(){return this.info_};J.prototype.toString=function(){var a;a=this.code_===J.NO_ERROR?"No error":this.code_===J.INVALID_SIGNATURE?"Invalid signature":this.code_===J.NO_SIGNATURE?"Missing signature":this.code_===J.CANNOT_RETRIEVE_CERTIFICATE?"Cannot retrieve certificate":this.code_===J.EXPIRED_CERTIFICATE?"Certificate expired":this.code_===
J.LOOP_DETECTED?"Loop detected in certification chain":this.code_===J.MALFORMED_CERTIFICATE?"Malformed certificate":this.code_===J.EXCEEDED_DEPTH_LIMIT?"Exceeded validation depth limit":this.code_===J.INVALID_KEY_LOCATOR?"Key locator violates validation policy":this.code_===J.POLICY_ERROR?"Validation policy error":this.code_===J.IMPLEMENTATION_ERROR?"Internal implementation error":this.code_>=J.USER_MIN?"Custom error code "+this.code_:"Unrecognized error code "+this.code_;0<this.info_.length&&(a+=
" ("+this.info_+")");return a};var c=a.Name,S=a.Data,W=a.KeyLocator,va=a.KeyLocatorType,t=a.WireFormat,J=a.ValidationError,O=a.CertificateV2,Va=function(){this.innerPolicy_=this.validator_=null};s.ValidationPolicy=Va;Va.prototype.setInnerPolicy=function(a){if(null==a)throw Error("The innerPolicy argument cannot be null");null!=this.validator_&&a.setValidator(this.validator_);null==this.innerPolicy_?this.innerPolicy_=a:this.innerPolicy_.setInnerPolicy(a)};Va.prototype.hasInnerPolicy=function(){return null!=
this.innerPolicy_};Va.prototype.getInnerPolicy=function(){return this.innerPolicy_};Va.prototype.setValidator=function(a){this.validator_=a;null!=this.innerPolicy_&&this.innerPolicy_.setValidator(a)};Va.prototype.checkPolicy=function(a,b,c){throw Error("ValidationPolicy.checkPolicy is not implemented");};Va.prototype.checkCertificatePolicy=function(a,b,c){this.checkPolicy(a,b,c)};Va.getKeyLocatorName=function(a,b){if(a instanceof S)return Va.getKeyLocatorNameFromSignature_(a.getSignature(),b);if(2>
a.getName().size())return b.fail(new J(J.INVALID_KEY_LOCATOR,"Invalid signed Interest: name too short")),new c;var g;try{g=t.getDefaultWireFormat().decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf())}catch(f){return b.fail(new J(J.INVALID_KEY_LOCATOR,"Invalid signed Interest: "+f)),new c}return Va.getKeyLocatorNameFromSignature_(g,b)};Va.getKeyLocatorNameFromSignature_=function(a,b){if(!W.canGetFromSignature(a))return b.fail(new J(J.INVALID_KEY_LOCATOR,
"KeyLocator is missing")),new c;var g=W.getFromSignature(a);return g.getType()!=va.KEYNAME?(b.fail(new J(J.INVALID_KEY_LOCATOR,"KeyLocator type is not Name")),new c):g.getKeyName()};var Va=a.ValidationPolicy,Pd=function(){Va.call(this)};Pd.prototype=new Va;Pd.prototype.name="ValidationPolicyAcceptAll";s.ValidationPolicyAcceptAll=Pd;Pd.prototype.checkPolicy=function(a,b,c){c(null,b)};var c=a.Name,S=a.Data,pc=a.CommandInterestSigner,J=a.ValidationError,Va=a.ValidationPolicy,Xb=function ab(a,b){Va.call(this);
this.options_=void 0==b?new ab.Options:new ab.Options(b);this.container_=[];this.nowOffsetMilliseconds_=0;if(null==a)throw Error("inner policy is missing");this.setInnerPolicy(a);0>this.options_.gracePeriod_&&(this.options_.gracePeriod_=0)};Xb.prototype=new Va;Xb.prototype.name="ValidationPolicyCommandInterest";s.ValidationPolicyCommandInterest=Xb;Xb.Options=function(a,b,c){a instanceof Xb.Options?(this.gracePeriod_=a.gracePeriod_,this.maxRecords_=a.maxRecords_,this.recordLifetime_=a.recordLifetime_):
(void 0==a&&(a=12E4),void 0==b&&(b=1E3),void 0==c&&(c=36E5),this.gracePeriod_=a,this.maxRecords_=b,this.recordLifetime_=c)};Xb.prototype.checkPolicy=function(a,b,c){if(a instanceof S)this.getInnerPolicy().checkPolicy(a,b,c);else{var g=[null],f=[0];Xb.parseCommandInterest_(a,b,g,f)&&this.checkTimestamp_(b,g[0],f[0])&&this.getInnerPolicy().checkPolicy(a,b,c)}};Xb.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Xb.LastTimestampRecord=function(a,b,g){this.keyName_=new c(a);
this.timestamp_=b;this.lastRefreshed_=g};Xb.prototype.cleanUp_=function(){for(var a=(new Date).getTime()+this.nowOffsetMilliseconds_-this.options_.recordLifetime_;0<this.container_.length&&this.container_[0].lastRefreshed_<=a||0<=this.options_.maxRecords_&&this.container_.length>this.options_.maxRecords_;)this.container_.shift()};Xb.parseCommandInterest_=function(a,b,g,f){g[0]=new c;f[0]=0;var l=a.getName();if(l.size()<pc.MINIMUM_SIZE)return b.fail(new J(J.POLICY_ERROR,"Command interest name `"+a.getName().toUri()+
"` is too short")),!1;f[0]=l.get(pc.POS_TIMESTAMP).toNumber();g[0]=Va.getKeyLocatorName(a,b);return b.isOutcomeFailed()?!1:!0};Xb.prototype.checkTimestamp_=function(a,b,c){this.cleanUp_();var g=(new Date).getTime()+this.nowOffsetMilliseconds_;if(c<g-this.options_.gracePeriod_||c>g+this.options_.gracePeriod_)return a.fail(new J(J.POLICY_ERROR,"Timestamp is outside the grace period for key "+b.toUri())),!1;g=this.findByKeyName_(b);if(0<=g&&c<=this.container_[g].timestamp_)return a.fail(new J(J.POLICY_ERROR,
"Timestamp is reordered for key "+b.toUri())),!1;var f=this;a.addSuccessCallback(function(a){f.insertNewRecord_(a,b,c)});return!0};Xb.prototype.insertNewRecord_=function(a,b,c){a=(new Date).getTime()+this.nowOffsetMilliseconds_;c=new Xb.LastTimestampRecord(b,c,a);b=this.findByKeyName_(b);0<=b&&this.container_.splice(b,1);this.container_.push(c)};Xb.prototype.findByKeyName_=function(a){for(var b=0;b<this.container_.length;++b)if(this.container_[b].keyName_.equals(a))return b;return-1};var lc=a.BoostInfoParser,
Dd=a.CertificateRequest,ua=a.ValidatorConfigError,J=a.ValidationError,O=a.CertificateV2,Hc=a.ConfigRule,S=a.Data,E=a.Interest,Va=a.ValidationPolicy,jc=function(){Va.call(this);this.isConfigured_=this.shouldBypass_=!1;this.dataRules_=[];this.interestRules_=[]};jc.prototype=new Va;jc.prototype.name="ValidationPolicyConfig";s.ValidationPolicyConfig=jc;jc.prototype.load=function(a,b){if("string"===typeof a&&void 0==b){var c=new lc;c.read(a);this.load(c.getRoot(),a)}else if("string"===typeof a&&"string"===
typeof b)c=new lc,c.read(a,b),this.load(c.getRoot(),b);else{this.isConfigured_&&(this.shouldBypass_=!1,this.dataRules_=[],this.interestRules_=[],this.validator_.resetAnchors(),this.validator_.resetVerifiedCertificates());this.isConfigured_=!0;c=a.get("validator");if(1!=c.length)throw new ua(Error("ValidationPolicyConfig: Expected one validator section"));for(var g=c[0],f=g.get("rule"),c=0;c<f.length;++c){var l=Hc.create(f[c]);l.getIsForInterest()?this.interestRules_.push(l):this.dataRules_.push(l)}g=
g.get("trust-anchor");for(c=0;c<g.length;++c)this.processConfigTrustAnchor_(g[c],b)}};jc.prototype.checkPolicy=function(a,b,c){if(this.hasInnerPolicy())throw new ua(Error("ValidationPolicyConfig must be a terminal inner policy"));if(this.shouldBypass_)c(null,b);else{var g=Va.getKeyLocatorName(a,b);if(!b.isOutcomeFailed())if(a instanceof S){for(var f=0;f<this.dataRules_.length;++f){var l=this.dataRules_[f];if(l.match(!1,a.getName())){l.check(!1,a.getName(),g,b)&&c(new Dd(new E(g)),b);return}}b.fail(new J(J.POLICY_ERROR,
"No rule matched for data `"+a.getName().toUri()+"`"))}else{for(f=0;f<this.interestRules_.length;++f)if(l=this.interestRules_[f],l.match(!0,a.getName())){l.check(!0,a.getName(),g,b)&&c(new Dd(new E(g)),b);return}b.fail(new J(J.POLICY_ERROR,"No rule matched for interest `"+a.getName().toUri()+"`"))}}};jc.prototype.processConfigTrustAnchor_=function(a,b){var c=a.getFirstValue("type");if(null==c)throw new ua(Error("Expected <trust-anchor.type>"));if("file"==c.toLowerCase()){var g=a.getFirstValue("file-name");
if(null==g)throw new ua(Error("Expected <trust-anchor.file-name>"));c=jc.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,c,!1)}else if("base64"==c.toLowerCase()){c=a.getFirstValue("base64-string");if(null==c)throw new ua(Error("Expected <trust-anchor.base64-string>"));c=new f(c,"base64");g=new O;try{g.wireDecode(c)}catch(l){throw new ua(Error("Cannot decode certificate from base64-string: "+l));}this.validator_.loadAnchor("",g)}else if("dir"==c.toLowerCase()){g=a.getFirstValue("dir");if(null==
g)throw new ua(Error("Expected <trust-anchor.dir>"));c=jc.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,c,!0)}else if("any"==c.toLowerCase())this.shouldBypass_=!0;else throw new ua(Error("Unsupported trust-anchor.type"));};jc.getRefreshPeriod_=function(a){var b=a.getFirstValue("refresh");if(null==b)return 1E14;a=0;b=b.match(/(\d+)([hms])/);null!=b&&(a=parseInt(b[1]),"s"!=b[2]&&(a*=60,"m"!=b[2]&&(a*=60)));return 0==a?36E5:1E3*a};var E=a.Interest,Dd=a.CertificateRequest,ra=a.PibKey,J=a.ValidationError,
Va=a.ValidationPolicy,qe=function(a){Va.call(this);this.pib_=a};qe.prototype=new Va;qe.prototype.name="ValidationPolicyFromPib";s.ValidationPolicyFromPib=qe;qe.prototype.checkPolicy=function(a,b,c){a=Va.getKeyLocatorName(a,b);b.isOutcomeFailed()||this.checkPolicyHelper_(a,b,c)};qe.prototype.checkPolicyHelper_=function(a,b,c){var g;try{g=this.pib_.getIdentity(ra.extractIdentityFromKeyName(a))}catch(f){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB identity for key "+a.toUri()+": "+
f));return}var l;try{l=g.getKey(a)}catch(m){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB key "+a.toUri()+": "+m));return}var q;try{q=l.getDefaultCertificate()}catch(t){b.fail(new J(J.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the default certificate for key "+a.toUri()+": "+t));return}this.validator_.resetAnchors();this.validator_.loadAnchor("",q);c(new Dd(new E(a)),b);this.validator_.resetAnchors()};var Dd=a.CertificateRequest,J=a.ValidationError,E=a.Interest,Va=a.ValidationPolicy,
Ee=function(){Va.call(this)};Ee.prototype=new Va;Ee.prototype.name="ValidationPolicySimpleHierarchy";s.ValidationPolicySimpleHierarchy=Ee;Ee.prototype.checkPolicy=function(a,b,c){keyLocatorName=Va.getKeyLocatorName(a,b);b.isOutcomeFailed()||(keyLocatorName.getPrefix(-2).isPrefixOf(a.getName())?c(new Dd(new E(keyLocatorName)),b):b.fail(new J(J.INVALID_KEY_LOCATOR,"Signing policy violation for "+a.getName().toUri()+" by "+keyLocatorName.toUri())))};var b=a.SyncPromise,J=a.ValidationError,Cd=a.CertificateFetcherOffline,
Wb=a.CertificateStorage,od=a.DataValidationState,Xc=a.InterestValidationState,S=a.Data,g=a.Log.LOG,Nb=function(a,b){Wb.call(this);void 0==b&&(b=new Cd);this.policy_=a;this.certificateFetcher_=b;this.maxDepth_=25;if(null==this.policy_)throw Error("The policy is null");if(null==this.certificateFetcher_)throw Error("The certificateFetcher is null");this.policy_.setValidator(this);this.certificateFetcher_.setCertificateStorage(this)};Nb.prototype=new Wb;Nb.prototype.name="Validator";s.Validator=Nb;Nb.prototype.getPolicy=
function(){return this.policy_};Nb.prototype.getFetcher=function(){return this.certificateFetcher_};Nb.prototype.setMaxDepth=function(a){this.maxDepth_=a};Nb.prototype.getMaxDepth=function(){return this.maxDepth_};Nb.prototype.validate=function(a,b,c){a instanceof S?(b=new od(a,b,c),3<g&&console.log("Start validating data "+a.getName().toUri())):(b=new Xc(a,b,c),3<g&&console.log("Start validating interest "+a.getName().toUri()));var f=this;this.policy_.checkPolicy(a,b,function(a,b){null==a?b.bypassValidation_():
f.requestCertificate_(a,b)})};Nb.prototype.validateCertificate_=function(a,b){3<g&&console.log("Start validating certificate "+a.getName().toUri());if(a.isValid()){var c=this;this.policy_.checkCertificatePolicy(a,b,function(b,g){null==b?g.fail(new J(J.POLICY_ERROR,"Validation policy is not allowed to designate `"+a.getName().toUri()+"` as a trust anchor")):(g.addCertificate(a),c.requestCertificate_(b,g))})}else b.fail(new J(J.EXPIRED_CERTIFICATE,"Retrieved certificate is not yet valid or expired `"+
a.getName().toUri()+"`"))};Nb.prototype.requestCertificate_=function(a,c){if(c.getDepth()>=this.maxDepth_)c.fail(new J(J.EXCEEDED_DEPTH_LIMIT,"Exceeded validation depth limit"));else if(c.hasSeenCertificateName(a.interest_.getName()))c.fail(new J(J.LOOP_DETECTED,"Validation loop detected for certificate `"+a.interest_.getName().toUri()+"`"));else{3<g&&console.log("Retrieving "+a.interest_.getName().toUri());var f=this,l=this.findTrustedCertificate(a.interest_);null!=l?(3<g&&console.log("Found trusted certificate "+
l.getName().toUri()),c.verifyCertificateChainPromise_(l).then(function(a){return null!=a?c.verifyOriginalPacketPromise_(a):b.resolve()}).then(function(){for(var a=0;a<c.certificateChain_.length;++a)f.cacheVerifiedCertificate(c.certificateChain_[a])})):this.certificateFetcher_.fetch(a,c,function(a,b){f.validateCertificate_(a,b)})}};var X=Rb=ke=a,g=a.Log.LOG,c=a.Name,E=a.Interest,S=a.Data,Ea=a.ContentType,m=a.Blob,zd=a.ConfigFile,t=a.WireFormat,x=a.SecurityException,cc=a.RsaKeyParams,Me=a.BasicIdentityStorage,
Oa=a.IdentityCertificate,fb=a.Tpm,Fe=a.TpmBackEndFile,dc=a.TpmBackEndMemory,b=a.SyncPromise,P=a.NdnCommon,la=a.IdentityManager,O=a.CertificateV2,Z=a.SigningInfo,Ka=a.Sha256WithRsaSignature,Ya=a.Sha256WithEcdsaSignature,yb=a.DigestSha256Signature,qb=a.HmacWithSha256Signature,W=a.KeyLocator,va=a.KeyLocatorType,Ha=a.DigestAlgorithm,ea=a.KeyType,Fa=a.ValidityPeriod,Tc=a.SafeBag,Ua=a.VerificationHelpers,Ba=a.PublicKey,hc=a.NoVerifyPolicyManager,D=function u(a,b,c){this.identityManager_=null;this.policyManager_=
new hc;this.tpm_=this.pib_=this.face_=null;if(void 0==a){if(!zd)throw new x(Error("KeyChain: The default KeyChain constructor is not supported in the browser"));Rb.existsSync(Me.getDefaultDatabaseFilePath())&&!Rb.existsSync(re.getDefaultDatabaseFilePath())?(a=new la,b=new hc):b=a=""}if("string"===typeof a){void 0==c&&(c=!1);this.isSecurityV1_=!1;var g=[null],f=[null];u.parseAndCheckPibLocator_(a,g,f);this.pib_=u.createPib_(g[0]+":"+f[0]);this.tpm_=new fb("","",null);this.pib_.initializeTpm_=this.tpm_;
this.pib_.initializePibLocator_=a;this.pib_.initializeTpmLocator_=b;this.pib_.initializeAllowReset_=c;this.tpm_.initializePib_=this.pib_}else a instanceof ca?(void 0==c&&(c=new hc),this.isSecurityV1_=!1,this.policyManager_=c,this.pib_=new ma("","",a),this.tpm_=new fb("","",b)):(c=b,this.isSecurityV1_=!0,void 0==a&&(a=new la),void 0==c&&(c=new hc),this.identityManager_=a,this.policyManager_=c)};s.KeyChain=D;D.Error=function(a){if(a)return a.__proto__=D.Error.prototype,a};D.Error.prototype=Error();
D.Error.prototype.name="KeyChainError";D.prototype.getPib=function(){if(this.isSecurityV1_)throw new x(Error("getPib is not supported for security v1"));return this.pib_};D.prototype.getTpm=function(){if(this.isSecurityV1_)throw new x(Error("getTpm is not supported for security v1"));return this.tpm_};D.prototype.getIsSecurityV1=function(){return this.isSecurityV1_};D.prototype.createIdentityV2Promise=function(a,c,f){f="boolean"===typeof c?c:f;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=D.getDefaultKeyParams());
var l=this,m;return this.pib_.addIdentityPromise_(a,f).then(function(a){m=a;return m.getDefaultKeyPromise(f).catch(function(a){return a instanceof ma.Error?l.createKeyPromise(m,c,f):b.reject(a)})}).then(function(a){return a.getDefaultCertificatePromise(f).catch(function(c){return c instanceof ma.Error?(2<g&&console.log("No default cert for "+a.getName()+", requesting self-signing"),l.selfSignPromise(a,f)):b.reject(c)})}).then(function(){return b.resolve(m)})};D.prototype.createIdentityV2=function(a,
c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.createIdentityV2Promise(a,"function"!==typeof c&&c?c:void 0,!g))};D.prototype.deleteIdentityPromise=function(a,g){function f(a){return a>=q.length?b.resolve():l.tpm_.deleteKeyPromise_(q[a],g).then(function(){return f(a+1)})}var l=this;if(a instanceof c)return this.isSecurityV1_?b.reject(new D.Error(Error("deleteIdentityPromise is not supported for security v1. Use deleteIdentity."))):this.pib_.getIdentityPromise(a,
g).then(function(a){return l.deleteIdentityPromise(a,g)}).catch(function(a){return b.resolve()});var m=a.getName(),q=a.getKeys_().getKeyNames();return f(0).then(function(){return l.pib_.removeIdentityPromise_(m,g)})};D.prototype.deleteIdentity=function(a,g,f){if(a instanceof c&&this.isSecurityV1_)this.identityManager_.deleteIdentity(a,g,f);else return b.complete(g,f,this.deleteIdentityPromise(a,!g))};D.prototype.setDefaultIdentityPromise=function(a,b){return this.pib_.setDefaultIdentityPromise_(a.getName(),
b)};D.prototype.setDefaultIdentity=function(a,c,g){return b.complete(c,g,this.setDefaultIdentityPromise(a,!c))};D.prototype.createKeyPromise=function(a,c,f){f="boolean"===typeof c?c:f;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=D.getDefaultKeyParams());var l=this,m,q;return this.tpm_.createKeyPromise_(a.getName(),c,f).then(function(a){q=a;return l.tpm_.getPublicKeyPromise(q,f)}).then(function(b){return a.addKeyPromise_(b.buf(),q,f)}).then(function(a){m=a;2<g&&console.log("Requesting self-signing for newly created key "+
m.getName().toUri());return l.selfSignPromise(m,f)}).then(function(){return b.resolve(m)})};D.prototype.createKey=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.createKeyPromise(a,"function"!==typeof c&&c?c:void 0,!g))};D.prototype.deleteKeyPromise=function(a,c,g){var f=c.getName();if(!a.getName().equals(c.getIdentityName()))return b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+f.toUri()+"`"));var l=this;return a.removeKeyPromise_(f,
g).then(function(){return l.tpm_.deleteKeyPromise_(f,g)})};D.prototype.deleteKey=function(a,c,g,f){return b.complete(g,f,this.deleteKeyPromise(a,c,!g))};D.prototype.setDefaultKeyPromise=function(a,c,g){return a.getName().equals(c.getIdentityName())?a.setDefaultKeyPromise_(c.getName(),g):b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+c.getName().toUri()+"`"))};D.prototype.setDefaultKey=function(a,c,g,f){return b.complete(g,f,this.setDefaultKeyPromise(a,c,!g))};D.prototype.addCertificatePromise=
function(a,c,g){return a.getName().equals(c.getKeyName())&&c.getContent().equals(a.getPublicKey())?a.addCertificatePromise_(c,g):b.reject(Error("Key `"+a.getName().toUri()+"` does not match certificate `"+c.getKeyName().toUri()+"`"))};D.prototype.addCertificate=function(a,c,g,f){return b.complete(g,f,this.addCertificatePromise(a,c,!g))};D.prototype.deleteCertificatePromise=function(a,c,g){return O.isValidName(c)?a.removeCertificatePromise_(c,g):b.reject(Error("Wrong certificate name `"+c.toUri()+
"`"))};D.prototype.deleteCertificate=function(a,c,g,f){return b.complete(g,f,this.deleteCertificatePromise(a,c,!g))};D.prototype.setDefaultCertificatePromise=function(a,b,c){return this.addCertificatePromise(a,b,c).then(function(){return a.setDefaultCertificatePromise_(b.getName(),c)})};D.prototype.setDefaultCertificate=function(a,c,g,f){return b.complete(g,f,this.setDefaultCertificatePromise(a,c,!g))};D.prototype.signPromise=function(a,g,f,l){var m=g,q=f,s=l;g=m instanceof Z||m instanceof c?m:void 0;
f=m instanceof t?m:q instanceof t?q:void 0;l="boolean"===typeof m?m:"boolean"===typeof q?q:"boolean"===typeof s?s:!1;void 0==f&&(f=t.getDefaultWireFormat());var G=this;return b.resolve().then(function(){if(void 0==g){if(G.isSecurityV1_)return G.prepareDefaultCertificateNamePromise_(l).then(function(a){g=a;return b.resolve()});g=D.defaultSigningInfo_}return b.resolve()}).then(function(){if(g instanceof c){var m=g;if(G.isSecurityV1_)return a instanceof E?G.identityManager_.signInterestByCertificatePromise(a,
m,f,l):a instanceof S?G.identityManager_.signByCertificatePromise(a,m,f,l):G.identityManager_.signByCertificatePromise(a,m,l);if(!(a instanceof E||a instanceof S))return b.reject(new x(Error("sign(buffer, certificateName) is not supported for security v2. Use sign with SigningInfo.")));var Eb=new Z;Eb.setSigningCertificateName(m);return G.signPromise(a,Eb,f,l).catch(function(a){return b.reject(new x(Error("Error in sign: "+a)))})}var ob=g;if(a instanceof S){var q=[null];return G.prepareSignatureInfoPromise_(ob,
q,l).then(function(b){a.setSignature(b);b=a.wireEncode(f);return G.signBufferPromise_(b.signedBuf(),q[0],ob.getDigestAlgorithm(),l)}).then(function(c){a.getSignature().setSignature(c);a.wireEncode(f);return b.resolve(a)})}if(a instanceof E){var t,q=[null];return G.prepareSignatureInfoPromise_(ob,q,l).then(function(b){t=b;a.getName().append(f.encodeSignatureInfo(t));a.getName().append(new c.Component);b=a.wireEncode(f);return G.signBufferPromise_(b.signedBuf(),q[0],ob.getDigestAlgorithm(),l)}).then(function(c){t.setSignature(c);
a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(t)));return b.resolve(a)})}q=[null];return G.prepareSignatureInfoPromise_(ob,q,l).then(function(b){return G.signBufferPromise_(a,q[0],ob.getDigestAlgorithm(),l)})})};D.prototype.sign=function(a,g,f,l,m){var q=g,s=f,G=l;g=q instanceof Z||q instanceof c?q:null;f=q instanceof t?q:s instanceof t?s:null;"function"===typeof q?(l=q,m=s):"function"===typeof s?(l=s,m=G):"function"===typeof G?l=G:m=l=null;return b.complete(l,m,this.signPromise(a,
g,f,!l))};D.prototype.selfSignPromise=function(a,g,f){var l=g,m=f;g=l instanceof t?l:void 0;f="boolean"===typeof l?l:"boolean"===typeof m?m:!1;void 0==g&&(g=t.getDefaultWireFormat());var q=new O,l=(new Date).getTime(),m=new c(a.getName());m.append("self").appendVersion(l);q.setName(m);q.getMetaInfo().setType(Ea.KEY);q.getMetaInfo().setFreshnessPeriod(36E5);q.setContent(a.getPublicKey());signingInfo=new Z(a);signingInfo.setValidityPeriod(new Fa(l,l+63072E7));return this.signPromise(q,signingInfo,g,
f).then(function(){return a.addCertificatePromise_(q,f).catch(function(a){return b.reject(new D.Error(Error("Error encoding certificate: "+a)))})}).then(function(){return b.resolve(q)})};D.prototype.selfSign=function(a,c,g,f){"function"===typeof c&&(f=g,g=c,c=void 0);void 0==c&&(c=t.getDefaultWireFormat());return b.complete(g,f,this.selfSignPromise(a,c,!g))};D.prototype.exportSafeBagPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);var f=a.getKeyName(),l=this;return b.resolve().then(function(){return l.tpm_.exportPrivateKeyPromise_(f,
c,g)},function(a){return b.reject(new D.Error(Error("Failed to export private key `"+f.toUri()+"`: "+a)))}).then(function(c){return b.resolve(new Tc(a,c))})};D.prototype.exportSafeBag=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.exportSafeBagPromise(a,"function"===typeof c?null:c,!g))};D.prototype.importSafeBagPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);var f;try{f=new O(a.getCertificate())}catch(l){return b.reject(Error("Error reading CertificateV2: "+
l))}var q=f.getIdentity(),t=f.getKeyName(),s=f.getPublicKey(),G=new m([1,2,3,4]),Eb,ob=this;return b.resolve().then(function(){return ob.tpm_.hasKeyPromise(t,g)}).then(function(a){return a?b.reject(new D.Error(Error("Private key `"+t.toUri()+"` already exists"))):ob.pib_.getIdentityPromise(q,g).then(function(a){return a.getKeyPromise(t,g)}).then(function(){return b.reject(new D.Error(Error("Public key `"+t.toUri()+"` already exists")))},function(a){return b.resolve()})}).then(function(){return ob.tpm_.importPrivateKeyPromise_(t,
a.getPrivateKeyBag().buf(),c,g).catch(function(a){return b.reject(new D.Error(Error("Failed to import private key `"+t.toUri()+"`: "+a)))})}).then(function(){return ob.tpm_.signPromise(G.buf(),t,Ha.SHA256,g).then(function(a){Eb=a;return b.resolve()},function(a){return ob.tpm_.deleteKeyPromise_(t,g).then(function(){return b.reject(new D.Error(Error("Invalid private key `"+t.toUri()+"`")))})})}).then(function(){var a;try{a=new Ba(s)}catch(c){return ob.tpm_.deleteKeyPromise_(t,g).then(function(){return b.reject(new D.Error(Error("Error decoding public key "+
c)))})}return Ua.verifySignaturePromise(G,Eb,a,g)}).then(function(a){return a?ob.pib_.addIdentityPromise_(q,g):ob.tpm_.deleteKeyPromise_(t,g).then(function(){return b.reject(new D.Error(Error("Certificate `"+f.getName().toUri()+"` and private key `"+t.toUri()+"` do not match")))})}).then(function(a){return a.addKeyPromise_(f.getPublicKey().buf(),t,g)}).then(function(a){return a.addCertificatePromise_(f,g)})};D.prototype.importSafeBag=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?
c:g;return b.complete(g,f,this.importSafeBagPromise(a,"function"===typeof c?null:c,!g))};D.registerPibBackend=function(a,b){D.getPibFactories_()[a]=b};D.registerTpmBackend=function(a,b){D.getTpmFactories_()[a]=b};D.prototype.createIdentityAndCertificate=function(a,b,c,g){g="function"===typeof b?c:g;c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:D.getDefaultKeyParams();return this.identityManager_.createIdentityAndCertificate(a,b,c,g)};D.prototype.createIdentity=function(a,b){return Oa.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,
b))};D.prototype.getDefaultIdentity=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultIdentity(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(a){return b.resolve(a.getName())}))};D.prototype.getDefaultCertificateName=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultCertificateName(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(b){return b.getDefaultKeyPromise(!a)}).then(function(b){return b.getDefaultCertificatePromise(!a)}).then(function(a){return b.resolve(a.getName())}))};
D.prototype.generateRSAKeyPair=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPair is not supported for security v2. Use createIdentityV2."));(c="boolean"===typeof b?b:c)||(c=2048);return this.identityManager_.generateRSAKeyPair(a,"boolean"===typeof b?b:!1,c)};D.prototype.setDefaultKeyForIdentity=function(a,c,g,f){return this.isSecurityV1_?this.identityManager_.setDefaultKeyForIdentity(a,c,g,f):b.complete(g,f,b.reject(new x(Error("setDefaultKeyForIdentity is not supported for security v2. Use getPib() methods."))))};
D.prototype.generateRSAKeyPairAsDefault=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPairAsDefault is not supported for security v2. Use createIdentityV2."));return this.identityManager_.generateRSAKeyPairAsDefault(a,b,c)};D.prototype.createSigningRequest=function(a){return this.isSecurityV1_?this.identityManager_.getPublicKey(a).getKeyDer():b.complete(null,null,this.pib_.getIdentityPromise(ra.extractIdentityFromKeyName(a,!0)).then(function(b){return b.getKeyPromise(a,!0)}).then(function(a){return b.resolve(a.getPublicKey())}))};
D.prototype.installIdentityCertificate=function(a,c,g){if(!this.isSecurityV1_)return b.complete(c,g,b.reject(new x(Error("installIdentityCertificate is not supported for security v2. Use getPib() methods."))));this.identityManager_.addCertificate(a,c,g)};D.prototype.setDefaultCertificateForKey=function(a,c,g){if(!this.isSecurityV1_)return b.complete(c,g,b.reject(new x(Error("setDefaultCertificateForKey is not supported for security v2. Use getPib() methods."))));this.identityManager_.setDefaultCertificateForKey(a,
c,g)};D.prototype.getCertificate=function(a,c,g){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,g):b.complete(c,g,b.reject(new x(Error("getCertificate is not supported for security v2. Use getPib() methods."))))};D.prototype.getIdentityCertificate=function(a,c,g){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,g):b.complete(c,g,b.reject(new x(Error("getIdentityCertificate is not supported for security v2. Use getPib() methods."))))};D.prototype.revokeKey=function(a){};
D.prototype.revokeCertificate=function(a){};D.prototype.getIdentityManager=function(){if(!this.isSecurityV1_)throw new x(Error("getIdentityManager is not supported for security v2"));return this.identityManager_};D.prototype.getPolicyManager=function(){return this.policyManager_};D.prototype.signByIdentity=function(a,g,f,l,m){m="function"===typeof f?l:m;l="function"===typeof f?f:l;f="function"!==typeof f&&f?f:t.getDefaultWireFormat();if(!this.isSecurityV1_)return b.complete(l,m,b.reject(new x(Error("signByIdentity(buffer, identityName) is not supported for security v2. Use sign with SigningInfo."))));
var q=!l,s=this;null==g&&(g=new c);if(a instanceof S){var G=b.resolve().then(function(){if(0==g.size()){var b=s.policyManager_.inferSigningIdentity(a.getName());return 0==b.size()?s.identityManager_.getDefaultCertificateNamePromise(q):s.identityManager_.getDefaultCertificateNameForIdentityPromise(b,q)}return s.identityManager_.getDefaultCertificateNameForIdentityPromise(g,q)}).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));if(!s.policyManager_.checkSigningPolicy(a.getName(),
b))throw new x(Error("Signing Cert name does not comply with signing policy"));return s.identityManager_.signByCertificatePromise(a,b,f,q)});return b.complete(l,m,G)}return b.complete(l,m,this.identityManager_.getDefaultCertificateNameForIdentityPromise(g,q).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));return s.identityManager_.signByCertificatePromise(a,b,f,q)}))};D.prototype.signWithSha256=function(a,b){if(this.isSecurityV1_)a instanceof E?this.identityManager_.signInterestWithSha256(a,
b):this.identityManager_.signWithSha256(a,b);else{var c=Z();c.setSha256Signing();this.sign(a,c,b)}};D.prototype.verifyData=function(a,b,c,g){null==g&&(g=0);if(this.policyManager_.requireVerify(a)){var f=this.policyManager_.checkVerificationPolicy(a,g,b,c);if(null!=f){var l=this;this.face_.expressInterest(f.interest,function(a,b){l.onCertificateData(a,b,f)},function(b){l.onCertificateInterestTimeout(b,f.retry,c,a,f)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(m){console.log("Error in onVerified: "+
P.getErrorWithStackTrace(m))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(q){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(q))}};D.prototype.verifyInterest=function(a,b,c,g,f){null==g&&(g=0);f=f||t.getDefaultWireFormat();if(this.policyManager_.requireVerify(a)){var l=this.policyManager_.checkVerificationPolicy(a,g,b,c,f);if(null!=l){var m=this;this.face_.expressInterest(l.interest,function(a,b){m.onCertificateData(a,b,l)},function(b){m.onCertificateInterestTimeout(b,
l.retry,c,a,l)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(q){console.log("Error in onVerified: "+P.getErrorWithStackTrace(q))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(s){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(s))}};D.prototype.setFace=function(a){this.face_=a};D.signWithHmacWithSha256=function(a,b,g,f){g instanceof t&&(f=g,g=void 0);f=f||t.getDefaultWireFormat();if(a instanceof S)g=a.wireEncode(f),b=
X.createHmac("sha256",b.buf()),b.update(g.signedBuf()),a.getSignature().setSignature(new m(b.digest(),!1));else if(a instanceof E){if(null==g)throw new x(Error("signWithHmacWithSha256: keyName is required to sign an Interest"));var l=new qb;l.getKeyLocator().setType(va.KEYNAME);l.getKeyLocator().setKeyName(g);a.getName().append(f.encodeSignatureInfo(l));a.getName().append(new c.Component);g=a.wireEncode(f);b=X.createHmac("sha256",b.buf());b.update(g.signedBuf());l.setSignature(new m(b.digest(),!1));
a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(l)))}else throw new x(Error("signWithHmacWithSha256: Unrecognized target type"));};D.verifyDataWithHmacWithSha256=function(a,b,c){c=c||t.getDefaultWireFormat();c=a.wireEncode(c);b=X.createHmac("sha256",b.buf());b.update(c.signedBuf());return(new m(b.digest(),!1)).equals(a.getSignature().getSignature())};D.verifyInterestWithHmacWithSha256=function(a,b,c){c=c||t.getDefaultWireFormat();var g=c.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf());a=a.wireEncode(c);b=X.createHmac("sha256",b.buf());b.update(a.signedBuf());return(new m(b.digest(),!1)).equals(g.getSignature())};D.getDefaultKeyParams=function(){return D.defaultKeyParams_};D.DEFAULT_KEY_PARAMS=new cc;D.getPibFactories_=function(){null==D.pibFactories_&&(D.pibFactories_={},re&&(D.pibFactories_[re.getScheme()]=function(a){return new re(a)}),D.pibFactories_[ya.getScheme()]=function(a){return new ya});return D.pibFactories_};D.getTpmFactories_=
function(){null==D.tpmFactories_&&(D.tpmFactories_={},Fe&&(D.tpmFactories_[Fe.getScheme()]=function(a){return new Fe(a)}),D.tpmFactories_[dc.getScheme()]=function(a){return new dc});return D.tpmFactories_};D.parseLocatorUri_=function(a,b,c){iColon=a.indexOf(":");0<=iColon?(b[0]=a.substring(0,iColon),c[0]=a.substring(iColon+1)):(b[0]=a,c[0]="")};D.parseAndCheckPibLocator_=function(a,b,c){D.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=D.getDefaultPibScheme_());if(void 0==D.getPibFactories_()[b[0]])throw new D.Error(Error("PIB scheme `"+
b[0]+"` is not supported"));};D.parseAndCheckTpmLocator_=function(a,b,c){D.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=D.getDefaultTpmScheme_());if(void 0==D.getTpmFactories_()[b[0]])throw new D.Error(Error("TPM scheme `"+b[0]+"` is not supported"));};D.getDefaultPibScheme_=function(){return re.getScheme()};D.getDefaultTpmScheme_=function(){if("darwin"===process.platform)throw new D.Error(Error("TpmBackEndOsx is not implemented. You must use tpm-file."));return Fe.getScheme()};D.createPib_=function(a){var b=
[null],c=[null];D.parseAndCheckPibLocator_(a,b,c);a=D.getPibFactories_()[b[0]];return new ma(b[0],c[0],a(c[0]))};D.setUpTpm_=function(a,b){var c=[null],g=[null];D.parseAndCheckTpmLocator_(b,c,g);var f=D.getTpmFactories_()[c[0]];a.scheme_=c[0];a.location_=g[0];a.backEnd_=f(g[0])};D.getDefaultPibLocator_=function(a){if(null!=D.defaultPibLocator_)return D.defaultPibLocator_;var b=process.env.NDN_CLIENT_PIB;D.defaultPibLocator_=void 0!=b&&""!=b?b:a.get("pib",D.getDefaultPibScheme_()+":");return D.defaultPibLocator_};
D.getDefaultTpmLocator_=function(a){if(null!=D.defaultTpmLocator_)return D.defaultTpmLocator_;var b=process.env.NDN_CLIENT_TPM;D.defaultTpmLocator_=void 0!=b&&""!=b?b:a.get("tpm",D.getDefaultTpmScheme_()+":");return D.defaultTpmLocator_};D.prototype.prepareSignatureInfoPromise_=function(a,c,g){var f=null,l=null,m=this;return b.resolve().then(function(){if(a.getSignerType()==Z.SignerType.NULL)return m.pib_.getDefaultIdentityPromise(g).then(function(a){f=a;return b.resolve(null)},function(a){c[0]=Z.getDigestSha256Identity();
return b.resolve(new yb)});if(a.getSignerType()==Z.SignerType.ID)return f=a.getPibIdentity(),null==f?m.pib_.getIdentityPromise(a.getSignerName(),g).then(function(a){f=a;return b.resolve(null)},function(c){return b.reject(new Yc(Error("Signing identity `"+a.getSignerName().toUri()+"` does not exist")))}):b.resolve(null);if(a.getSignerType()==Z.SignerType.KEY)return l=a.getPibKey(),null==l?(q=ra.extractIdentityFromKeyName(a.getSignerName()),m.pib_.getIdentityPromise(q,g).then(function(c){return c.getKeyPromise(a.getSignerName(),
g).then(function(a){l=a;f=null;return b.resolve(null)})},function(c){return b.reject(new Yc(Error("Signing key `"+a.getSignerName().toUri()+"` does not exist")))})):b.resolve(null);if(a.getSignerType()==Z.SignerType.CERT){var q=O.extractIdentityFromCertName(a.getSignerName());return m.pib_.getIdentityPromise(q,g).then(function(c){f=c;return f.getKeyPromise(O.extractKeyNameFromCertName(a.getSignerName()),g).then(function(a){l=a;return b.resolve(null)})},function(c){return b.reject(new Yc(Error("Signing certificate `"+
a.getSignerName().toUri()+"` does not exist")))})}return a.getSignerType()==Z.SignerType.SHA256?(c[0]=Z.getDigestSha256Identity(),b.resolve(new yb)):b.reject(new Yc(Error("Unrecognized signer type")))}).then(function(m){return null!=m?b.resolve(m):null==f&&null==l?b.reject(new Yc(Error("Cannot determine signing parameters"))):b.resolve().then(function(){return null!=f&&null==l?f.getDefaultKeyPromise(g).then(function(a){l=a;return b.resolve(null)},function(a){return b.reject(new Yc(Error("Signing identity `"+
f.getName().toUri()+"` does not have default certificate")))}):b.resolve()}).then(function(){if(l.getKeyType()==ea.RSA&&a.getDigestAlgorithm()==Ha.SHA256)signatureInfo=new Ka;else if(l.getKeyType()==ea.EC&&a.getDigestAlgorithm()==Ha.SHA256)signatureInfo=new Ya;else return b.reject(new D.Error(Error("Unsupported key type")));a.getValidityPeriod().hasPeriod()&&Fa.canGetFromSignature(signatureInfo)&&Fa.getFromSignature(signatureInfo).setPeriod(a.getValidityPeriod().getNotBefore(),a.getValidityPeriod().getNotAfter());
var g=W.getFromSignature(signatureInfo);g.setType(va.KEYNAME);g.setKeyName(l.getName());c[0]=l.getName();return b.resolve(signatureInfo)})})};D.prototype.signBufferPromise_=function(a,c,g,f){return c.equals(Z.getDigestSha256Identity())?(c=X.createHash("sha256"),c.update(a),b.resolve(new m(c.digest(),!1))):this.tpm_.signPromise(a,c,g,f)};D.prototype.onCertificateData=function(a,b,c){this.verifyData(b,c.onVerified,c.onValidationFailed,c.stepCount)};D.prototype.onCertificateInterestTimeout=function(a,
b,c,g,f){if(0<b){var l=this;this.face_.expressInterest(a,function(a,b){l.onCertificateData(a,b,f)},function(a){l.onCertificateInterestTimeout(a,b-1,c,g,f)})}else try{c(g,"The retry count is zero after timeout for fetching "+a.getName().toUri())}catch(m){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(m))}};D.prototype.prepareDefaultCertificateNamePromise_=function(a){var c,g=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(f){c=f;return null!=c?
b.resolve():g.setDefaultCertificatePromise_(a).then(function(){return g.identityManager_.getDefaultCertificatePromise(a)}).then(function(a){c=a;return b.resolve()})}).then(function(){return b.resolve(c.getName())})};D.prototype.setDefaultCertificatePromise_=function(a){var g=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(f){if(null!=f)return b.resolve();var l;return g.identityManager_.getDefaultIdentityPromise(a).then(function(a){l=a;return b.resolve()},function(a){randomComponent=
X.randomBytes(4);l=(new c).append("tmp-identity").append(new m(randomComponent,!1));return b.resolve()}).then(function(){return g.identityManager_.createIdentityAndCertificatePromise(l,D.getDefaultKeyParams(),a)}).then(function(){return g.identityManager_.setDefaultIdentityPromise(l,a)})})};D.defaultPibLocator_=null;D.defaultTpmLocator_=null;D.pibFactories_=null;D.tpmFactories_=null;D.defaultSigningInfo_=new Z;D.defaultKeyParams_=new cc;var Yc=function(a){D.Error.call(this,a)};Yc.prototype=new D.Error;
Yc.prototype.name="InvalidSigningInfoError";s.InvalidSigningInfoError=Yc;s.InvalidSigningInfoError=Yc;je=function(a){D.Error.call(this,a)};je.prototype=new D.Error;je.prototype.name="LocatorMismatchError";s.LocatorMismatchError=je;var ma=a.Pib,ca=a.PibImpl,ra=a.PibKey,re=a.PibSqlite3,ya=a.PibMemory,ua=function A(a){if(a)return a.__proto__=A.prototype,a};ua.prototype=Error();ua.prototype.name="ValidatorConfigError";s.ValidatorConfigError=ua;var uc=a.CertificateFetcher,jc=a.ValidationPolicyConfig,Nd=
a.CertificateFetcherFromNetwork,Nb=a.Validator,Ge=function(a){a instanceof uc?Nb.call(this,new jc,a):Nb.call(this,new jc,new Nd(a));this.policyConfig_=this.getPolicy()};Ge.prototype=new Nb(new jc,new Nd(null));Ge.prototype.name="ValidatorConfig";s.ValidatorConfig=Ge;Ge.prototype.load=function(a,b){this.policyConfig_.load(a,b)};var Pd=a.ValidationPolicyAcceptAll,Cd=a.CertificateFetcherOffline,Nb=a.Validator,Qe=function(){Nb.call(this,new Pd,new Cd)};Qe.prototype=new Nb(new Pd);Qe.prototype.name="ValidatorNull";
s.ValidatorNull=Qe;var c=a.Name,M=a.DataUtils,m=a.Blob,Xa=function Ve(a){this.values=[];if("object"===typeof a&&a instanceof Ve)this.values=a.values.slice(0);else if(a)for(var b=this.changeCount=0;b<a.length;++b)a[b]==Ve.ANY?this.appendAny():this.appendComponent(a[b]);this.changeCount=0};s.Exclude=Xa;Xa.ANY="*";Xa.prototype.size=function(){return this.values.length};Xa.prototype.get=function(a){return this.values[a]};Xa.prototype.appendAny=function(){this.values.push(Xa.ANY);++this.changeCount;return this};
Xa.prototype.appendComponent=function(a){this.values.push(new c.Component(a));++this.changeCount;return this};Xa.prototype.clear=function(){++this.changeCount;this.values=[]};Xa.prototype.toUri=function(){if(null==this.values||0==this.values.length)return"";for(var a="",b=0;b<this.values.length;++b)0<b&&(a+=","),a=this.values[b]==Xa.ANY?a+"*":a+this.values[b].toEscapedString();return a};Xa.prototype.matches=function(a){"object"==typeof a&&a instanceof c.Component||(a=new c.Component(a));for(var b=
0;b<this.values.length;++b)if(this.values[b]==Xa.ANY){var g=null;0<b&&(g=this.values[b-1]);var f,l=null;for(f=b+1;f<this.values.length;++f)if(this.values[f]!=Xa.ANY){l=this.values[f];break}if(null!=l){if(null!=g){if(0<a.compare(g)&&0>a.compare(l))return!0}else if(0>a.compare(l))return!0;b=f-1}else if(null!=g){if(0<a.compare(g))return!0}else return!0}else if(a.equals(this.values[b]))return!0;return!1};Xa.compareComponents=function(a,b){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());
"object"==typeof b&&b instanceof c.Component&&(b=b.getValue().buf());return c.Component.compareBuffers(a,b)};Xa.prototype.getChangeCount=function(){return this.changeCount};var X=a,m=a.Blob,db=a.SignedBlob,qa=a.ChangeCounter,c=a.Name,Xa=a.Exclude,Fb=a.Link,W=a.KeyLocator,ib=a.DelegationSet,Dc=a.IncomingFaceId,t=a.WireFormat,E=function ha(a,b,g,f,l,Eb,ob,q,t,s){if(null!=f)throw Error("Interest constructor: PublisherPublicKeyDigest support has been removed.");if(null!=ob)throw Error("Interest constructor: answerOriginKind support has been removed. Use setMustBeFresh().");
if(null!=q)throw Error("Interest constructor: scope support has been removed.");if(null!=s)throw Error("Interest constructor: nonce support in the constructor has been removed.");null!=b&&console.log("Interest constructor: The minSuffixComponents param is deprecated. Use setMinSuffixComponents().");null!=g&&console.log("Interest constructor: The maxSuffixComponents param is deprecated. Use setMaxSuffixComponents().");null!=l&&console.log("Interest constructor: The exclude param is deprecated. Use setExclude().");
null!=Eb&&console.log("Interest constructor: The childSelector param is deprecated. Use setChildSelector().");null!=t&&console.log("Interest constructor: The interestLifetimeMilliseconds param is deprecated. Use setInterestLifetimeMilliseconds().");"object"===typeof a&&a instanceof ha?(this.name_=new qa(new c(a.getName())),this.maxSuffixComponents_=a.maxSuffixComponents_,this.didSetCanBePrefix_=a.didSetCanBePrefix_,this.minSuffixComponents_=a.minSuffixComponents_,this.keyLocator_=new qa(new W(a.getKeyLocator())),
this.exclude_=new qa(new Xa(a.getExclude())),this.childSelector_=a.childSelector_,this.mustBeFresh_=a.mustBeFresh_,this.interestLifetimeMilliseconds_=a.interestLifetimeMilliseconds_,this.forwardingHint_=new qa(new ib(a.getForwardingHint())),this.applicationParameters_=a.applicationParameters_,this.nonce_=a.nonce_,this.linkWireEncoding_=a.linkWireEncoding_,this.linkWireEncodingFormat_=a.linkWireEncodingFormat_,this.link_=new qa(null),null!=a.link_.get()&&this.link_.set(new Fb(a.link_.get())),this.selectedDelegationIndex_=
a.selectedDelegationIndex_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_=new qa(new c(a)),this.maxSuffixComponents_=null!=g?g:ha.defaultCanBePrefix_?null:1,this.didSetCanBePrefix_=ha.didSetDefaultCanBePrefix_,this.minSuffixComponents_=b,this.keyLocator_=new qa(new W),this.exclude_=new qa("object"===typeof l&&l instanceof Xa?new Xa(l):new Xa),this.childSelector_=Eb,this.mustBeFresh_=!0,this.interestLifetimeMilliseconds_=
t,this.forwardingHint_=new qa(new ib),this.applicationParameters_=new m,this.nonce_=new m,this.linkWireEncoding_=new m,this.linkWireEncodingFormat_=null,this.link_=new qa(null),this.selectedDelegationIndex_=null,this.defaultWireEncoding_=new db,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=this.getNonceChangeCount_=0;this.lpPacket_=null};s.Interest=E;E.RECURSIVE_POSTFIX="*";E.CHILD_SELECTOR_LEFT=0;E.CHILD_SELECTOR_RIGHT=1;E.defaultCanBePrefix_=!0;
E.didSetDefaultCanBePrefix_=!1;E.getDefaultCanBePrefix=function(){return E.defaultCanBePrefix_};E.setDefaultCanBePrefix=function(a){E.defaultCanBePrefix_=a;E.didSetDefaultCanBePrefix_=!0};E.prototype.matchesName=function(a){return!this.getName().match(a)||null!=this.minSuffixComponents_&&!(a.size()+1-this.getName().size()>=this.minSuffixComponents_)||null!=this.maxSuffixComponents_&&!(a.size()+1-this.getName().size()<=this.maxSuffixComponents_)||null!=this.getExclude()&&a.size()>this.getName().size()&&
this.getExclude().matches(a.get(this.getName().size()))?!1:!0};E.prototype.matches_name=function(a){return this.matchesName(a)};E.prototype.matchesData=function(a,b){b=b||t.getDefaultWireFormat();var c=this.getName().size(),g=a.getName(),f=g.size()+1,l=null!=this.getMinSuffixComponents()?this.getMinSuffixComponents():0;if(!(c+l<=f&&(null==this.getMaxSuffixComponents()||c+this.getMaxSuffixComponents()>=f)))return!1;if(c===f)if(this.getName().get(-1).isImplicitSha256Digest()){if(!this.getName().equals(a.getFullName(b)))return!1}else return!1;
else if(!this.getName().isPrefixOf(g))return!1;if(0<this.getExclude().size()&&f>c)if(c==f-1){if(this.getExclude().matches(a.getFullName(b).get(c)))return!1}else if(this.getExclude().matches(g.get(c)))return!1;c=this.getKeyLocator();return!c.getType()||(g=a.getSignature(),W.canGetFromSignature(g)&&c.equals(W.getFromSignature(g)))?!0:!1};E.prototype.clone=function(){return new E(this)};E.prototype.getName=function(){return this.name_.get()};E.prototype.getMinSuffixComponents=function(){return this.minSuffixComponents_};
E.prototype.getMaxSuffixComponents=function(){return this.maxSuffixComponents_};E.prototype.getCanBePrefix=function(){return 1!=this.maxSuffixComponents_};E.prototype.getKeyLocator=function(){return this.keyLocator_.get()};E.prototype.getExclude=function(){return this.exclude_.get()};E.prototype.getChildSelector=function(){return this.childSelector_};E.prototype.getMustBeFresh=function(){return this.mustBeFresh_};E.prototype.getNonce=function(){this.getNonceChangeCount_!=this.getChangeCount()&&(this.nonce_=
new m,this.getNonceChangeCount_=this.getChangeCount());return this.nonce_};E.prototype.getForwardingHint=function(){return this.forwardingHint_.get()};E.prototype.hasApplicationParameters=function(){return 0<this.applicationParameters_.size()};E.prototype.hasParameters=function(){return this.hasApplicationParameters()};E.prototype.getApplicationParameters=function(){return this.applicationParameters_};E.prototype.getParameters=function(){return this.getApplicationParameters()};E.prototype.getNonceAsBuffer=
function(){return this.getNonce().buf()};E.prototype.hasLink=function(){return null!=this.link_.get()||!this.linkWireEncoding_.isNull()};E.prototype.getLink=function(){if(null!=this.link_.get())return this.link_.get();if(this.linkWireEncoding_.isNull())return null;var a=new Fb;a.wireDecode(this.linkWireEncoding_,this.linkWireEncodingFormat_);this.link_.set(a);this.linkWireEncoding_=new m;this.linkWireEncodingFormat_=null;return a};E.prototype.getLinkWireEncoding=function(a){a=a||t.getDefaultWireFormat();
if(!this.linkWireEncoding_.isNull()&&this.linkWireEncodingFormat_==a)return this.linkWireEncoding_;var b=this.getLink();return null!=b?b.wireEncode(a):new m};E.prototype.getSelectedDelegationIndex=function(){return this.selectedDelegationIndex_};E.prototype.getInterestLifetimeMilliseconds=function(){return this.interestLifetimeMilliseconds_};E.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new db,this.defaultWireEncodingFormat_=
null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};E.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};E.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:Dc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};E.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;return this};E.prototype.setMinSuffixComponents=
function(a){this.minSuffixComponents_=a;++this.changeCount_;return this};E.prototype.setMaxSuffixComponents=function(a){this.maxSuffixComponents_=a;++this.changeCount_;return this};E.prototype.setCanBePrefix=function(a){this.maxSuffixComponents_=a?null:1;this.didSetCanBePrefix_=!0;++this.changeCount_;return this};E.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof W?new W(a):new W);++this.changeCount_;return this};E.prototype.setExclude=function(a){this.exclude_.set("object"===
typeof a&&a instanceof Xa?new Xa(a):new Xa);++this.changeCount_;return this};E.prototype.setForwardingHint=function(a){this.forwardingHint_.set("object"===typeof a&&a instanceof ib?new ib(a):new ib);++this.changeCount_;return this};E.prototype.setApplicationParameters=function(a){this.applicationParameters_="object"===typeof a&&a instanceof m?a:new m(a,!0);++this.changeCount_;return this};E.prototype.setParameters=function(a){return this.setApplicationParameters(a)};E.prototype.appendParametersDigestToName=
function(){if(!this.hasParameters())return this;var a=X.createHash("sha256");a.update(this.applicationParameters_.buf());this.getName().appendParametersSha256Digest(new m(a.digest(),!1));return this};E.prototype.setLinkWireEncoding=function(a,b){b=b||t.getDefaultWireFormat();this.linkWireEncoding_=a;this.linkWireEncodingFormat_=b;this.link_.set(null);++this.changeCount_;return this};E.prototype.unsetLink=function(){return this.setLinkWireEncoding(new m,null)};E.prototype.setSelectedDelegationIndex=
function(a){this.selectedDelegationIndex_=a;++this.changeCount_;return this};E.prototype.setChildSelector=function(a){this.childSelector_=a;++this.changeCount_;return this};E.prototype.setMustBeFresh=function(a){this.mustBeFresh_=a?!0:!1;++this.changeCount_;return this};E.prototype.setInterestLifetimeMilliseconds=function(a){this.interestLifetimeMilliseconds_=a;++this.changeCount_;return this};E.prototype.setNonce=function(a){this.nonce_="object"===typeof a&&a instanceof m?a:new m(a,!0);++this.changeCount_;
this.getNonceChangeCount_=this.getChangeCount();return this};E.prototype.toUri=function(){var a="";null!=this.minSuffixComponents_&&(a+="&ndn.MinSuffixComponents="+this.minSuffixComponents_);null!=this.maxSuffixComponents_&&(a+="&ndn.MaxSuffixComponents="+this.maxSuffixComponents_);null!=this.childSelector_&&(a+="&ndn.ChildSelector="+this.childSelector_);a+="&ndn.MustBeFresh="+(this.mustBeFresh_?1:0);null!=this.interestLifetimeMilliseconds_&&(a+="&ndn.InterestLifetime="+this.interestLifetimeMilliseconds_);
0<this.getNonce().size()&&(a+="&ndn.Nonce="+c.toEscapedString(this.getNonce().buf()));null!=this.getExclude()&&0<this.getExclude().size()&&(a+="&ndn.Exclude="+this.getExclude().toUri());var b=this.getName().toUri();""!=a&&(b+="?"+a.substr(1));return b};E.prototype.wireEncode=function(a){a=a||t.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeInterest(this),b=new db(b.encoding,b.signedPortionBeginOffset,
b.signedPortionEndOffset);a==t.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,t.getDefaultWireFormat());return b};E.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof m?b.decodeInterest(this,a.buf(),!1):b.decodeInterest(this,a,!0);b==t.getDefaultWireFormat()?this.setDefaultWireEncoding(new db(new m(a,!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),t.getDefaultWireFormat()):this.setDefaultWireEncoding(new db,null)};E.prototype.refreshNonce=
function(){var a=this.getNonce();if(0!==a.size()){for(var b;b=new m(X.randomBytes(a.size()),!1),b.equals(a););this.nonce_=b;++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount()}};E.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};E.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.keyLocator_.checkChanged()||a,a=this.exclude_.checkChanged()||a;(a=this.forwardingHint_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};E.prototype.setDefaultWireEncoding=
function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(E.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(E.prototype,"minSuffixComponents",{get:function(){return this.getMinSuffixComponents()},set:function(a){this.setMinSuffixComponents(a)}});Object.defineProperty(E.prototype,"maxSuffixComponents",{get:function(){return this.getMaxSuffixComponents()},
set:function(a){this.setMaxSuffixComponents(a)}});Object.defineProperty(E.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(E.prototype,"exclude",{get:function(){return this.getExclude()},set:function(a){this.setExclude(a)}});Object.defineProperty(E.prototype,"childSelector",{get:function(){return this.getChildSelector()},set:function(a){this.setChildSelector(a)}});Object.defineProperty(E.prototype,"interestLifetime",
{get:function(){return this.getInterestLifetimeMilliseconds()},set:function(a){this.setInterestLifetimeMilliseconds(a)}});Object.defineProperty(E.prototype,"nonce",{get:function(){return this.getNonceAsBuffer()},set:function(a){this.setNonce(a)}});xa=function hf(a){"object"===typeof a&&a instanceof hf?(this.childInherit=a.childInherit,this.capture=a.capture,this.origin=a.origin):(this.childInherit=!0,this.capture=!1,this.origin=null)};s.RegistrationOptions=xa;xa.NfdForwardingFlags_CHILD_INHERIT=1;
xa.NfdForwardingFlags_CAPTURE=2;xa.prototype.getNfdForwardingFlags=function(){var a=0;this.childInherit&&(a|=xa.NfdForwardingFlags_CHILD_INHERIT);this.capture&&(a|=xa.NfdForwardingFlags_CAPTURE);return a};xa.prototype.setNfdForwardingFlags=function(a){this.childInherit=0!=(a&xa.NfdForwardingFlags_CHILD_INHERIT);this.capture=0!=(a&xa.NfdForwardingFlags_CAPTURE);return this};xa.prototype.getChildInherit=function(){return this.childInherit};xa.prototype.getCapture=function(){return this.capture};xa.prototype.getOrigin=
function(){return this.origin};xa.prototype.setChildInherit=function(a){this.childInherit=a;return this};xa.prototype.setCapture=function(a){this.capture=a;return this};xa.prototype.setOrigin=function(a){this.origin=a;return this};var xa=a.RegistrationOptions,He=function(a){xa.call(this,a)};He.prototype=new xa;s.ForwardingFlags=He;He.NfdForwardingFlags_CHILD_INHERIT=xa.NfdForwardingFlags_CHILD_INHERIT;He.NfdForwardingFlags_CAPTURE=xa.NfdForwardingFlags_CAPTURE;var xa=a.RegistrationOptions,c=a.Name,
t=a.WireFormat,m=a.Blob,Wa=function jf(a){"object"===typeof a&&a instanceof jf?(this.name=null==a.name?null:new c(a.name),this.faceId=a.faceId,this.uri=a.uri,this.localControlFeature=a.localControlFeature,this.origin=a.origin,this.cost=a.cost,this.flags=new xa(a.flags),this.strategy=new c(a.strategy),this.expirationPeriod=a.expirationPeriod):(this.faceId=this.name=null,this.uri="",this.cost=this.origin=this.localControlFeature=null,this.flags=new xa,this.strategy=new c,this.expirationPeriod=null)};
s.ControlParameters=Wa;Wa.prototype.clear=function(){this.faceId=this.name=null;this.uri="";this.cost=this.origin=this.localControlFeature=null;this.flags=new xa;this.strategy=new c;this.expirationPeriod=null};Wa.prototype.wireEncode=function(a){a=a||t.getDefaultWireFormat();return a.encodeControlParameters(this)};Wa.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeControlParameters(this,a.buf(),!1):b.decodeControlParameters(this,a,!0)};
Wa.prototype.getName=function(){return this.name};Wa.prototype.getFaceId=function(){return this.faceId};Wa.prototype.getUri=function(){return this.uri};Wa.prototype.getLocalControlFeature=function(){return this.localControlFeature};Wa.prototype.getOrigin=function(){return this.origin};Wa.prototype.getCost=function(){return this.cost};Wa.prototype.getForwardingFlags=function(){return this.flags};Wa.prototype.getStrategy=function(){return this.strategy};Wa.prototype.getExpirationPeriod=function(){return this.expirationPeriod};
Wa.prototype.setName=function(a){this.name="object"===typeof a&&a instanceof c?new c(a):null};Wa.prototype.setFaceId=function(a){this.faceId=a};Wa.prototype.setUri=function(a){this.uri=a||""};Wa.prototype.setLocalControlFeature=function(a){this.localControlFeature=a};Wa.prototype.setOrigin=function(a){this.origin=a};Wa.prototype.setCost=function(a){this.cost=a};Wa.prototype.setForwardingFlags=function(a){this.flags="object"===typeof a&&a instanceof xa?new xa(a):new xa};Wa.prototype.setStrategy=function(a){this.strategy=
"object"===typeof a&&a instanceof c?new c(a):new c};Wa.prototype.setExpirationPeriod=function(a){this.expirationPeriod=a};var Wa=a.ControlParameters,t=a.WireFormat,m=a.Blob,vc=function kf(a){"object"===typeof a&&a instanceof kf?(this.statusCode_=a.statusCode_,this.statusText_=a.statusText_,this.bodyAsControlParameters_=null==a.bodyAsControlParameters_?null:new Wa(a.bodyAsControlParameters_)):(this.statusCode_=null,this.statusText_="",this.bodyAsControlParameters_=null)};s.ControlResponse=vc;vc.prototype.clear=
function(){this.statusCode_=null;this.statusText_="";this.bodyAsControlParameters_=null};vc.prototype.wireEncode=function(a){a=a||t.getDefaultWireFormat();return a.encodeControlResponse(this)};vc.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeControlResponse(this,a.buf(),!1):b.decodeControlResponse(this,a,!0)};vc.prototype.getStatusCode=function(){return this.statusCode_};vc.prototype.getStatusText=function(){return this.statusText_};vc.prototype.getBodyAsControlParameters=
function(){return this.bodyAsControlParameters_};vc.prototype.setStatusCode=function(a){this.statusCode_=a;return this};vc.prototype.setStatusText=function(a){this.statusText_=a||"";return this};vc.prototype.setBodyAsControlParameters=function(a){this.bodyAsControlParameters_="object"===typeof a&&a instanceof Wa?new Wa(a):null;return this};c=a.Name;$a=a.NdnRegexTopMatcher;Bc=function Ue(a,b){"object"===typeof a&&a instanceof Ue?(this.prefix=new c(a.prefix),this.regexFilter=a.regexFilter,this.regexFilterPattern=
a.regexFilterPattern):(this.prefix=new c(a),b?(this.regexFilter=b,this.regexFilterPattern=Ue.makePattern(b)):this.regexFilterPattern=this.regexFilter=null)};s.InterestFilter=Bc;Bc.prototype.doesMatch=function(a){return a.size()<this.prefix.size()?!1:this.hasRegexFilter()?this.prefix.match(a)?(new $a(this.regexFilterPattern)).match(a.getSubName(this.prefix.size())):!1:this.prefix.match(a)};Bc.prototype.getPrefix=function(){return this.prefix};Bc.prototype.hasRegexFilter=function(){return null!=this.regexFilter};
Bc.prototype.getRegexFilter=function(){return this.regexFilter};Bc.makePattern=function(a){1<=a.length&&"^"==a[0]||(a="^"+a);1<=a.length&&"$"==a[-1]||(a+="$");return a};c=a.Name;m=a.Blob;t=a.WireFormat;ib=function lf(a){this.delegations_="object"===typeof a&&a instanceof lf?a.delegations_.slice(0):[];this.changeCount_=0};s.DelegationSet=ib;ib.Delegation=function(a,b){this.preference_=a;this.name_=new c(b)};ib.Delegation.prototype.getPreference=function(){return this.preference_};ib.Delegation.prototype.getName=
function(){return this.name_};ib.Delegation.prototype.compare=function(a){return this.preference_<a.preference_?-1:this.preference_>a.preference_?1:this.name_.compare(a.name_)};ib.prototype.add=function(a,b){this.remove(b);for(var c=new ib.Delegation(a,b),g=0;g<this.delegations_.length&&!(0<=this.delegations_[g].compare(c));)++g;this.delegations_.splice(g,0,c);++this.changeCount_};ib.prototype.addUnsorted=function(a,b){this.delegations_.push(new ib.Delegation(a,b));++this.changeCount_};ib.prototype.remove=
function(a){for(var b=!1,c=this.delegations_.length-1;0<=c;--c)this.delegations_[c].getName().equals(a)&&(b=!0,this.delegations_.splice(c,1));b&&++this.changeCount_;return b};ib.prototype.clear=function(){this.delegations_=[];++this.changeCount_};ib.prototype.size=function(){return this.delegations_.length};ib.prototype.get=function(a){return this.delegations_[a]};ib.prototype.find=function(a){for(var b=0;b<this.delegations_.length;++b)if(this.delegations_[b].getName().equals(a))return b;return-1};
ib.prototype.wireEncode=function(a){a=a||t.getDefaultWireFormat();return a.encodeDelegationSet(this)};ib.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeDelegationSet(this,a.buf(),!1):b.decodeDelegationSet(this,a,!0)};ib.prototype.getChangeCount=function(){return this.changeCount_};ib=a.DelegationSet;Ea=a.ContentType;t=a.WireFormat;S=a.Data;Fb=function(a){this.delegations_=new ib;if(a instanceof S){if(S.call(this,a),!this.getContent().isNull())try{this.delegations_.wireDecode(this.getContent()),
this.getMetaInfo().setType(Ea.LINK)}catch(b){this.delegations_.clear()}}else void 0!=a?S.call(this,a):S.call(this),this.getMetaInfo().setType(Ea.LINK)};Fb.prototype=new S;Fb.prototype.name="Link";s.Link=Fb;Fb.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();S.prototype.wireDecode.call(this,a,b);if(this.getMetaInfo().getType()!=Ea.LINK)throw Error("Link.wireDecode: MetaInfo ContentType is not LINK.");this.delegations_.wireDecode(this.getContent())};Fb.prototype.addDelegation=function(a,
b,c){c=c||t.getDefaultWireFormat();this.delegations_.add(a,b);this.encodeContent(c);return this};Fb.prototype.removeDelegation=function(a,b){b=b||t.getDefaultWireFormat();var c=this.delegations_.remove(a);c&&this.encodeContent(b);return c};Fb.prototype.getDelegations=function(){return this.delegations_};Fb.prototype.encodeContent=function(a){this.setContent(this.delegations_.wireEncode(a));this.getMetaInfo().setType(Ea.LINK)};var cb=function Eb(){this.reason_=Eb.Reason.NONE;this.otherReasonCode_=
-1};s.NetworkNack=cb;cb.Reason={NONE:0,CONGESTION:50,DUPLICATE:100,NO_ROUTE:150,OTHER_CODE:32767};cb.prototype.getReason=function(){return this.reason_};cb.prototype.getOtherReasonCode=function(){return this.otherReasonCode_};cb.prototype.setReason=function(a){this.reason_=a;return this};cb.prototype.setOtherReasonCode=function(a){if(0>a)throw Error("NetworkNack other reason code must be non-negative");this.otherReasonCode_=a;return this};cb.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=
a.getHeaderField(b);if(c instanceof cb)return c}return null};var X=a,m=a.Blob,c=a.Name,kb=a.ComponentType,xa=a.RegistrationOptions,q=a.Tlv,sa=a.TlvEncoder,pa=a.TlvDecoder,t=a.WireFormat,Xa=a.Exclude,Ea=a.ContentType,va=a.KeyLocatorType,Ka=a.Sha256WithRsaSignature,Ya=a.Sha256WithEcdsaSignature,bc=a.GenericSignature,qb=a.HmacWithSha256Signature,yb=a.DigestSha256Signature,Wa=a.ControlParameters,cb=a.NetworkNack,ja=a.Schedule,Dc=a.IncomingFaceId,id=a.CongestionMark,T=a.DecodingException,H=function(){t.call(this)};
H.prototype=new t;H.prototype.name="Tlv0_2WireFormat";s.Tlv0_2WireFormat=H;H.instance=null;H.didCanBePrefixWarning_=!1;H.prototype.encodeName=function(a){var b=new sa;H.encodeName(a,b);return new m(b.getOutput(),!1)};H.prototype.decodeName=function(a,b,c){null==c&&(c=!0);b=new pa(b);H.decodeName(a,b,c)};H.prototype.encodeInterest=function(a){a.didSetCanBePrefix_||H.didCanBePrefixWarning_||(console.log("WARNING: The default CanBePrefix will change. See Interest.setDefaultCanBePrefix() for details."),
H.didCanBePrefixWarning_=!0);if(a.hasApplicationParameters())return H.encodeInterestV03_(a,c,l);var b=new sa(256),c=b.getLength();if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");l=b.getLength();H.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(q.ForwardingHint,
b.getLength()-l)}b.writeOptionalNonNegativeIntegerTlv(q.SelectedDelegation,a.getSelectedDelegationIndex());l=a.getLinkWireEncoding(this);l.isNull()||b.writeBuffer(l.buf());b.writeOptionalNonNegativeIntegerTlv(q.InterestLifetime,a.getInterestLifetimeMilliseconds());if(a.getNonce().isNull()||0==a.getNonce().size())b.writeBlobTlv(q.Nonce,X.randomBytes(4));else if(4>a.getNonce().size()){l=f(4);a.getNonce().buf().copy(l);for(var g=a.getNonce().size();4>g;++g)l[g]=X.randomBytes(1)[0];b.writeBlobTlv(q.Nonce,
l)}else 4==a.getNonce().size()?b.writeBlobTlv(q.Nonce,a.getNonce().buf()):b.writeBlobTlv(q.Nonce,a.getNonce().buf().slice(0,4));H.encodeSelectors(a,b);l=H.encodeName(a.getName(),b);a=b.getLength()-l.signedPortionBeginOffset;l=b.getLength()-l.signedPortionEndOffset;b.writeTypeAndLength(q.Interest,b.getLength()-c);var c=b.getLength()-a,l=b.getLength()-l;return{encoding:new m(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:l}};H.prototype.decodeInterest=function(a,b,c){try{return this.decodeInterestV02_(a,
b,c)}catch(g){try{return H.decodeInterestV03_(a,b,c)}catch(f){throw g;}}};H.prototype.decodeInterestV02_=function(a,b,c){null==c&&(c=!0);b=new pa(b);var g=b.readNestedTlvsStart(q.Interest),f=H.decodeName(a.getName(),b,c);b.peekType(q.Selectors,g)?H.decodeSelectors(a,b,c):(a.setMinSuffixComponents(null),a.setMaxSuffixComponents(null),a.getKeyLocator().clear(),a.getExclude().clear(),a.setChildSelector(null),a.setMustBeFresh(!1));var l=b.readBlobTlv(q.Nonce);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(q.InterestLifetime,
g));if(b.peekType(q.ForwardingHint,g)){var t=b.readNestedTlvsStart(q.ForwardingHint);H.decodeDelegationSet_(a.getForwardingHint(),t,b,c);b.finishNestedTlvs(t)}if(b.peekType(q.Data,g)){var t=b.getOffset(),s=b.readNestedTlvsStart(q.Data);b.seek(s);a.setLinkWireEncoding(new m(b.getSlice(t,s),c),this)}else a.unsetLink();a.setSelectedDelegationIndex(b.readOptionalNonNegativeIntegerTlv(q.SelectedDelegation,g));if(null!=a.getSelectedDelegationIndex()&&0<=a.getSelectedDelegationIndex()&&!a.hasLink())throw Error("Interest has a selected delegation, but no link object");
a.setApplicationParameters(new m);a.setNonce(new m(l,c));b.finishNestedTlvs(g);return f};H.prototype.encodeData=function(a){var b=new sa(1500),c=b.getLength();b.writeBlobTlv(q.SignatureValue,a.getSignature().getSignature().buf());var g=b.getLength();H.encodeSignatureInfo_(a.getSignature(),b);b.writeBlobTlv(q.Content,a.getContent().buf());H.encodeMetaInfo(a.getMetaInfo(),b);H.encodeName(a.getName(),b);a=b.getLength();b.writeTypeAndLength(q.Data,b.getLength()-c);c=b.getLength()-a;g=b.getLength()-g;
return{encoding:new m(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:g}};H.prototype.decodeData=function(a,b,c){null==c&&(c=!0);b=new pa(b);var g=b.readNestedTlvsStart(q.Data),f=b.getOffset();H.decodeName(a.getName(),b,c);b.peekType(q.MetaInfo,g)?H.decodeMetaInfo(a.getMetaInfo(),b,c):a.getMetaInfo().clear();a.setContent(new m(b.readOptionalBlobTlv(q.Content,g),c));H.decodeSignatureInfo(a,b,c);var l=b.getOffset();a.getSignature().setSignature(new m(b.readBlobTlv(q.SignatureValue),
c));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:l}};H.prototype.encodeControlParameters=function(a){var b=new sa(256);H.encodeControlParameters(a,b);return new m(b.getOutput(),!1)};H.prototype.decodeControlParameters=function(a,b,c){null==c&&(c=!0);b=new pa(b);H.decodeControlParameters(a,b,c)};H.prototype.encodeControlResponse=function(a){var b=new sa(256),c=b.getLength();null!=a.getBodyAsControlParameters()&&H.encodeControlParameters(a.getBodyAsControlParameters(),
b);b.writeBlobTlv(q.NfdCommand_StatusText,(new m(a.getStatusText())).buf());b.writeNonNegativeIntegerTlv(q.NfdCommand_StatusCode,a.getStatusCode());b.writeTypeAndLength(q.NfdCommand_ControlResponse,b.getLength()-c);return new m(b.getOutput(),!1)};H.prototype.decodeControlResponse=function(a,b,c){null==c&&(c=!0);b=new pa(b);var g=b.readNestedTlvsStart(q.NfdCommand_ControlResponse);a.setStatusCode(b.readNonNegativeIntegerTlv(q.NfdCommand_StatusCode));var f=new m(b.readBlobTlv(q.NfdCommand_StatusText),
!1);a.setStatusText(f.toString());b.peekType(q.ControlParameters_ControlParameters,g)?(a.setBodyAsControlParameters(new Wa),H.decodeControlParameters(a.getBodyAsControlParameters(),b,c)):a.setBodyAsControlParameters(null);b.finishNestedTlvs(g)};H.prototype.encodeSignatureInfo=function(a){var b=new sa(256);H.encodeSignatureInfo_(a,b);return new m(b.getOutput(),!1)};H.SignatureHolder=function(){};H.SignatureHolder.prototype.setSignature=function(a){this.signature=a};H.SignatureHolder.prototype.getSignature=
function(){return this.signature};H.prototype.decodeSignatureInfoAndValue=function(a,b,c){null==c&&(c=!0);var g=new H.SignatureHolder;a=new pa(a);H.decodeSignatureInfo(g,a,c);a=new pa(b);g.getSignature().setSignature(new m(a.readBlobTlv(q.SignatureValue),c));return g.getSignature()};H.prototype.encodeSignatureValue=function(a){var b=new sa(256);b.writeBlobTlv(q.SignatureValue,a.getSignature().buf());return new m(b.getOutput(),!1)};H.prototype.decodeLpPacket=function(a,b,c){null==c&&(c=!0);a.clear();
for(var g=new pa(b),f=g.readNestedTlvsStart(q.LpPacket_LpPacket);g.getOffset()<f;){var l=g.readVarNumber(),t=g.readVarNumber(),s=g.getOffset()+t;if(s>b.length)throw new T(Error("TLV length exceeds the buffer length"));if(l==q.LpPacket_Fragment){a.setFragmentWireEncoding(new m(g.getSlice(g.getOffset(),s),c));g.seek(s);break}else if(l==q.LpPacket_Nack)t=new cb,l=g.readOptionalNonNegativeIntegerTlv(q.LpPacket_NackReason,s),0>l||l==cb.Reason.NONE?t.setReason(cb.Reason.NONE):l==cb.Reason.CONGESTION||l==
cb.Reason.DUPLICATE||l==cb.Reason.NO_ROUTE?t.setReason(l):(t.setReason(cb.Reason.OTHER_CODE),t.setOtherReasonCode(l)),a.addHeaderField(t);else if(l==q.LpPacket_IncomingFaceId)l=new Dc,l.setFaceId(g.readNonNegativeInteger(t)),a.addHeaderField(l);else if(l==q.LpPacket_CongestionMark)l=new id,l.setCongestionMark(g.readNonNegativeInteger(t)),a.addHeaderField(l);else{if(!(l>=q.LpPacket_IGNORE_MIN&&l<=q.LpPacket_IGNORE_MAX&&0==(l&3)))throw new T(Error("Did not get the expected TLV type"));g.seek(s)}g.finishNestedTlvs(s)}g.finishNestedTlvs(f)};
H.prototype.encodeDelegationSet=function(a){var b=new sa(256);H.encodeDelegationSet_(a,b);return new m(b.getOutput(),!1)};H.prototype.decodeDelegationSet=function(a,b,c){null==c&&(c=!0);var g=new pa(b);H.decodeDelegationSet_(a,b.length,g,c)};H.prototype.encodeEncryptedContent=function(a){var b=new sa(256),c=b.getLength();b.writeBlobTlv(q.Encrypt_EncryptedPayload,a.getPayload().buf());b.writeOptionalBlobTlv(q.Encrypt_InitialVector,a.getInitialVector().buf());b.writeNonNegativeIntegerTlv(q.Encrypt_EncryptionAlgorithm,
a.getAlgorithmType());H.encodeKeyLocator(q.KeyLocator,a.getKeyLocator(),b);b.writeTypeAndLength(q.Encrypt_EncryptedContent,b.getLength()-c);return new m(b.getOutput(),!1)};H.prototype.decodeEncryptedContent=function(a,b,c){null==c&&(c=!0);b=new pa(b);var g=b.readNestedTlvsStart(q.Encrypt_EncryptedContent);a.clear();H.decodeKeyLocator(q.KeyLocator,a.getKeyLocator(),b,c);a.setAlgorithmType(b.readNonNegativeIntegerTlv(q.Encrypt_EncryptionAlgorithm));a.setInitialVector(new m(b.readOptionalBlobTlv(q.Encrypt_InitialVector,
g),c));a.setPayload(new m(b.readBlobTlv(q.Encrypt_EncryptedPayload),c));b.finishNestedTlvs(g)};H.prototype.encodeEncryptedContentV2=function(a){var b=new sa(256),c=b.getLength();a.getKeyLocator().getType()==va.KEYNAME&&H.encodeName(a.getKeyLocator().getKeyName(),b);b.writeOptionalBlobTlv(q.Encrypt_EncryptedPayloadKey,a.getPayloadKey().buf());b.writeOptionalBlobTlv(q.Encrypt_InitialVector,a.getInitialVector().buf());b.writeBlobTlv(q.Encrypt_EncryptedPayload,a.getPayload().buf());b.writeTypeAndLength(q.Encrypt_EncryptedContent,
b.getLength()-c);return new m(b.getOutput(),!1)};H.prototype.decodeEncryptedContentV2=function(a,b,c){null==c&&(c=!0);b=new pa(b);var g=b.readNestedTlvsStart(q.Encrypt_EncryptedContent);a.clear();a.setPayload(new m(b.readBlobTlv(q.Encrypt_EncryptedPayload),c));a.setInitialVector(new m(b.readOptionalBlobTlv(q.Encrypt_InitialVector,g),c));a.setPayloadKey(new m(b.readOptionalBlobTlv(q.Encrypt_EncryptedPayloadKey,g),c));b.peekType(q.Name,g)&&(H.decodeName(a.getKeyLocator().getKeyName(),b,c),a.getKeyLocator().setType(va.KEYNAME));
b.finishNestedTlvs(g)};H.get=function(){null===H.instance&&(H.instance=new H);return H.instance};H.encodeNameComponent=function(a,b){var c;c=a.getType()===kb.OTHER_CODE?a.getOtherTypeCode():a.getType();b.writeBlobTlv(c,a.getValue().buf())};H.decodeNameComponent=function(a,b){null==b&&(b=!0);var g=a.getOffset(),f=a.readVarNumber();a.seek(g);g=new m(a.readBlobTlv(f),b);return f===q.ImplicitSha256DigestComponent?c.Component.fromImplicitSha256Digest(g):f===q.ParametersSha256DigestComponent?c.Component.fromParametersSha256Digest(g):
f===q.NameComponent?new c.Component(g):new c.Component(g,kb.OTHER_CODE,f)};H.encodeName=function(a,b){for(var c=b.getLength(),g,f=a.size()-1;0<=f;--f)H.encodeNameComponent(a.get(f),b),f==a.size()-1&&(g=b.getLength());f=b.getLength();b.writeTypeAndLength(q.Name,b.getLength()-c);c=b.getLength()-f;g=0==a.size()?c:b.getLength()-g;return{signedPortionBeginOffset:c,signedPortionEndOffset:g}};H.decodeName=function(a,b,c){a.clear();for(var g=b.readNestedTlvsStart(q.Name),f=b.getOffset(),l=f;b.getOffset()<
g;)l=b.getOffset(),a.append(H.decodeNameComponent(b,c));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:l}};H.encodeSelectors=function(a,b){var c=b.getLength();a.getMustBeFresh()&&b.writeTypeAndLength(q.MustBeFresh,0);b.writeOptionalNonNegativeIntegerTlv(q.ChildSelector,a.getChildSelector());0<a.getExclude().size()&&H.encodeExclude(a.getExclude(),b);null!=a.getKeyLocator().getType()&&H.encodeKeyLocator(q.PublisherPublicKeyLocator,a.getKeyLocator(),b);b.writeOptionalNonNegativeIntegerTlv(q.MaxSuffixComponents,
a.getMaxSuffixComponents());b.writeOptionalNonNegativeIntegerTlv(q.MinSuffixComponents,a.getMinSuffixComponents());b.getLength()!=c&&b.writeTypeAndLength(q.Selectors,b.getLength()-c)};H.decodeSelectors=function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(q.Selectors);a.setMinSuffixComponents(b.readOptionalNonNegativeIntegerTlv(q.MinSuffixComponents,g));a.setMaxSuffixComponents(b.readOptionalNonNegativeIntegerTlv(q.MaxSuffixComponents,g));b.peekType(q.PublisherPublicKeyLocator,g)?H.decodeKeyLocator(q.PublisherPublicKeyLocator,
a.getKeyLocator(),b,c):a.getKeyLocator().clear();b.peekType(q.Exclude,g)?H.decodeExclude(a.getExclude(),b,c):a.getExclude().clear();a.setChildSelector(b.readOptionalNonNegativeIntegerTlv(q.ChildSelector,g));a.setMustBeFresh(b.readBooleanTlv(q.MustBeFresh,g));b.finishNestedTlvs(g)};H.encodeExclude=function(a,b){for(var c=b.getLength(),g=a.size()-1;0<=g;--g){var f=a.get(g);f==Xa.ANY?b.writeTypeAndLength(q.Any,0):H.encodeNameComponent(f,b)}b.writeTypeAndLength(q.Exclude,b.getLength()-c)};H.decodeExclude=
function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(q.Exclude);for(a.clear();b.getOffset()<g;)b.peekType(q.Any,g)?(b.readBooleanTlv(q.Any,g),a.appendAny()):a.appendComponent(H.decodeNameComponent(b,c));b.finishNestedTlvs(g)};H.encodeKeyLocator=function(a,b,c){var g=c.getLength();if(null!=b.getType())if(b.getType()==va.KEYNAME)H.encodeName(b.getKeyName(),c);else if(b.getType()==va.KEY_LOCATOR_DIGEST&&0<b.getKeyData().size())c.writeBlobTlv(q.KeyLocatorDigest,b.getKeyData().buf());else throw Error("Unrecognized KeyLocatorType "+
b.getType());c.writeTypeAndLength(a,c.getLength()-g)};H.decodeKeyLocator=function(a,b,c,g){null==g&&(g=!0);a=c.readNestedTlvsStart(a);b.clear();if(c.getOffset()!=a){if(c.peekType(q.Name,a))b.setType(va.KEYNAME),H.decodeName(b.getKeyName(),c,g);else if(c.peekType(q.KeyLocatorDigest,a))b.setType(va.KEY_LOCATOR_DIGEST),b.setKeyData(new m(c.readBlobTlv(q.KeyLocatorDigest),g));else throw new T(Error("decodeKeyLocator: Unrecognized key locator type"));c.finishNestedTlvs(a)}};H.encodeValidityPeriod_=function(a,
b){var c=b.getLength();b.writeBlobTlv(q.ValidityPeriod_NotAfter,(new m(ja.toIsoString(a.getNotAfter()))).buf());b.writeBlobTlv(q.ValidityPeriod_NotBefore,(new m(ja.toIsoString(a.getNotBefore()))).buf());b.writeTypeAndLength(q.ValidityPeriod_ValidityPeriod,b.getLength()-c)};H.decodeValidityPeriod_=function(a,b){var c=b.readNestedTlvsStart(q.ValidityPeriod_ValidityPeriod);a.clear();var g=new m(b.readBlobTlv(q.ValidityPeriod_NotBefore),!1),f=ja.fromIsoString(g.toString()),g=new m(b.readBlobTlv(q.ValidityPeriod_NotAfter),
!1),g=ja.fromIsoString(g.toString());a.setPeriod(f,g);b.finishNestedTlvs(c)};H.encodeSignatureInfo_=function(a,b){if(a instanceof bc){var c=a.getSignatureInfoEncoding();try{var g=new pa(c.buf()),f=g.readNestedTlvsStart(q.SignatureInfo);g.readNonNegativeIntegerTlv(q.SignatureType);g.finishNestedTlvs(f,!0)}catch(l){throw Error("The GenericSignature encoding is not a valid NDN-TLV SignatureInfo: "+l.message);}b.writeBuffer(c.buf())}else{c=b.getLength();if(a instanceof Ka)a.getValidityPeriod().hasPeriod()&&
H.encodeValidityPeriod_(a.getValidityPeriod(),b),H.encodeKeyLocator(q.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(q.SignatureType,q.SignatureType_SignatureSha256WithRsa);else if(a instanceof Ya)a.getValidityPeriod().hasPeriod()&&H.encodeValidityPeriod_(a.getValidityPeriod(),b),H.encodeKeyLocator(q.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(q.SignatureType,q.SignatureType_SignatureSha256WithEcdsa);else if(a instanceof qb)H.encodeKeyLocator(q.KeyLocator,a.getKeyLocator(),
b),b.writeNonNegativeIntegerTlv(q.SignatureType,q.SignatureType_SignatureHmacWithSha256);else if(a instanceof yb)b.writeNonNegativeIntegerTlv(q.SignatureType,q.SignatureType_DigestSha256);else throw Error("encodeSignatureInfo: Unrecognized Signature object type");b.writeTypeAndLength(q.SignatureInfo,b.getLength()-c)}};H.decodeSignatureInfo=function(a,b,c){null==c&&(c=!0);var g=b.getOffset(),f=b.readNestedTlvsStart(q.SignatureInfo),l=b.readNonNegativeIntegerTlv(q.SignatureType);l==q.SignatureType_SignatureSha256WithRsa?
(a.setSignature(new Ka),a=a.getSignature(),H.decodeKeyLocator(q.KeyLocator,a.getKeyLocator(),b,c),b.peekType(q.ValidityPeriod_ValidityPeriod,f)&&H.decodeValidityPeriod_(a.getValidityPeriod(),b)):l==q.SignatureType_SignatureSha256WithEcdsa?(a.setSignature(new Ya),a=a.getSignature(),H.decodeKeyLocator(q.KeyLocator,a.getKeyLocator(),b,c),b.peekType(q.ValidityPeriod_ValidityPeriod,f)&&H.decodeValidityPeriod_(a.getValidityPeriod(),b)):l==q.SignatureType_SignatureHmacWithSha256?(a.setSignature(new qb),
a=a.getSignature(),H.decodeKeyLocator(q.KeyLocator,a.getKeyLocator(),b,c)):l==q.SignatureType_DigestSha256?a.setSignature(new yb):(a.setSignature(new bc),a=a.getSignature(),a.setSignatureInfoEncoding(new m(b.getSlice(g,f),c),l),b.finishNestedTlvs(f,!0));b.finishNestedTlvs(f)};H.encodeMetaInfo=function(a,b){var c=b.getLength(),g=a.getFinalBlockId().getValue().buf();null!=g&&0<g.length&&(g=b.getLength(),H.encodeNameComponent(a.getFinalBlockId(),b),b.writeTypeAndLength(q.FinalBlockId,b.getLength()-g));
b.writeOptionalNonNegativeIntegerTlv(q.FreshnessPeriod,a.getFreshnessPeriod());if(a.getType()!=Ea.BLOB)if(a.getType()==Ea.LINK||a.getType()==Ea.KEY||a.getType()==Ea.NACK)b.writeNonNegativeIntegerTlv(q.ContentType,a.getType());else if(a.getType()==Ea.OTHER_CODE)b.writeNonNegativeIntegerTlv(q.ContentType,a.getOtherTypeCode());else throw Error("unrecognized TLV ContentType");b.writeTypeAndLength(q.MetaInfo,b.getLength()-c)};H.decodeMetaInfo=function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(q.MetaInfo),
f=b.readOptionalNonNegativeIntegerTlv(q.ContentType,g);null==f||0>f||f===Ea.BLOB?a.setType(Ea.BLOB):f===Ea.LINK||f===Ea.KEY||f===Ea.NACK?a.setType(f):(a.setType(Ea.OTHER_CODE),a.setOtherTypeCode(f));a.setFreshnessPeriod(b.readOptionalNonNegativeIntegerTlv(q.FreshnessPeriod,g));b.peekType(q.FinalBlockId,g)?(f=b.readNestedTlvsStart(q.FinalBlockId),a.setFinalBlockId(H.decodeNameComponent(b,c)),b.finishNestedTlvs(f)):a.setFinalBlockId(null);b.finishNestedTlvs(g)};H.encodeControlParameters=function(a,
b){var c=b.getLength();b.writeOptionalNonNegativeIntegerTlv(q.ControlParameters_ExpirationPeriod,a.getExpirationPeriod());if(0<a.getStrategy().size()){var g=b.getLength();H.encodeName(a.getStrategy(),b);b.writeTypeAndLength(q.ControlParameters_Strategy,b.getLength()-g)}g=a.getForwardingFlags().getNfdForwardingFlags();g!=(new xa).getNfdForwardingFlags()&&b.writeNonNegativeIntegerTlv(q.ControlParameters_Flags,g);b.writeOptionalNonNegativeIntegerTlv(q.ControlParameters_Cost,a.getCost());b.writeOptionalNonNegativeIntegerTlv(q.ControlParameters_Origin,
a.getOrigin());b.writeOptionalNonNegativeIntegerTlv(q.ControlParameters_LocalControlFeature,a.getLocalControlFeature());0!=a.getUri().length&&b.writeBlobTlv(q.ControlParameters_Uri,(new m(a.getUri())).buf());b.writeOptionalNonNegativeIntegerTlv(q.ControlParameters_FaceId,a.getFaceId());null!=a.getName()&&H.encodeName(a.getName(),b);b.writeTypeAndLength(q.ControlParameters_ControlParameters,b.getLength()-c)};H.decodeControlParameters=function(a,b,g){null==g&&(g=!0);a.clear();var f=b.readNestedTlvsStart(q.ControlParameters_ControlParameters);
if(b.peekType(q.Name,f)){var l=new c;H.decodeName(l,b,g);a.setName(l)}a.setFaceId(b.readOptionalNonNegativeIntegerTlv(q.ControlParameters_FaceId,f));b.peekType(q.ControlParameters_Uri,f)&&(l=new m(b.readOptionalBlobTlv(q.ControlParameters_Uri,f),!1),a.setUri(l.toString()));b.skipOptionalTlv(q.ControlParameters_LocalUri,f);a.setLocalControlFeature(b.readOptionalNonNegativeIntegerTlv(q.ControlParameters_LocalControlFeature,f));a.setOrigin(b.readOptionalNonNegativeIntegerTlv(q.ControlParameters_Origin,
f));a.setCost(b.readOptionalNonNegativeIntegerTlv(q.ControlParameters_Cost,f));b.skipOptionalTlv(q.ControlParameters_Capacity,f);b.skipOptionalTlv(q.ControlParameters_Count,f);b.skipOptionalTlv(q.ControlParameters_BaseCongestionMarkingInterval,f);b.skipOptionalTlv(q.ControlParameters_DefaultCongestionThreshold,f);b.skipOptionalTlv(q.ControlParameters_Mtu,f);b.peekType(q.ControlParameters_Flags,f)&&(l=new xa,l.setNfdForwardingFlags(b.readNonNegativeIntegerTlv(q.ControlParameters_Flags,f)),a.setForwardingFlags(l));
b.skipOptionalTlv(q.ControlParameters_Mask,f);b.peekType(q.ControlParameters_Strategy,f)&&(l=b.readNestedTlvsStart(q.ControlParameters_Strategy),H.decodeName(a.getStrategy(),b,g),b.finishNestedTlvs(l));a.setExpirationPeriod(b.readOptionalNonNegativeIntegerTlv(q.ControlParameters_ExpirationPeriod,f));b.finishNestedTlvs(f)};H.encodeDelegationSet_=function(a,b){for(var c=a.size()-1;0<=c;--c){var g=b.getLength();H.encodeName(a.get(c).getName(),b);b.writeNonNegativeIntegerTlv(q.Link_Preference,a.get(c).getPreference());
b.writeTypeAndLength(q.Link_Delegation,b.getLength()-g)}};H.decodeDelegationSet_=function(a,b,g,f){for(a.clear();g.getOffset()<b;){g.readTypeAndLength(q.Link_Delegation);var l=g.readNonNegativeIntegerTlv(q.Link_Preference),m=new c;H.decodeName(m,g,f);a.addUnsorted(l,m)}};H.encodeInterestV03_=function(a){var b=new sa(256),c=b.getLength();b.writeOptionalBlobTlv(q.ApplicationParameters,a.getApplicationParameters().buf());b.writeOptionalNonNegativeIntegerTlv(q.InterestLifetime,a.getInterestLifetimeMilliseconds());
if(a.getNonce().isNull()||0==a.getNonce().size())b.writeBlobTlv(q.Nonce,X.randomBytes(4));else if(4>a.getNonce().size()){var g=f(4);a.getNonce().buf().copy(g);for(var l=a.getNonce().size();4>l;++l)g[l]=X.randomBytes(1)[0];b.writeBlobTlv(q.Nonce,g)}else 4==a.getNonce().size()?b.writeBlobTlv(q.Nonce,a.getNonce().buf()):b.writeBlobTlv(q.Nonce,a.getNonce().buf().slice(0,4));if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");
if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");g=b.getLength();H.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(q.ForwardingHint,b.getLength()-g)}a.getMustBeFresh()&&b.writeTypeAndLength(q.MustBeFresh,0);a.getCanBePrefix()&&b.writeTypeAndLength(q.CanBePrefix,0);g=H.encodeName(a.getName(),b);a=b.getLength()-g.signedPortionBeginOffset;g=b.getLength()-g.signedPortionEndOffset;b.writeTypeAndLength(q.Interest,b.getLength()-c);c=
b.getLength()-a;a=b.getLength()-g;return{encoding:new m(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:a}};H.decodeInterestV03_=function(a,b,c){null==c&&(c=!0);b=new pa(b);var g=b.readNestedTlvsStart(q.Interest),f=H.decodeName(a.getName(),b,c);a.setCanBePrefix(b.readBooleanTlv(q.CanBePrefix,g));a.setMustBeFresh(b.readBooleanTlv(q.MustBeFresh,g));if(b.peekType(q.ForwardingHint,g)){var l=b.readNestedTlvsStart(q.ForwardingHint);H.decodeDelegationSet_(a.getForwardingHint(),l,b,c);
b.finishNestedTlvs(l)}else a.getForwardingHint().clear();l=b.readOptionalBlobTlv(q.Nonce,g);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(q.InterestLifetime,g));a.setMinSuffixComponents(null);a.getKeyLocator().clear();a.getExclude().clear();a.setChildSelector(null);a.unsetLink();a.setSelectedDelegationIndex(null);b.readOptionalBlobTlv(q.HopLimit,g);a.setApplicationParameters(new m(b.readOptionalBlobTlv(q.ApplicationParameters,g),c));a.setNonce(null==l?new m:new m(l,c));b.finishNestedTlvs(g);
return f};var H=a.Tlv0_2WireFormat,wc=function(){H.call(this)};wc.prototype=new H;wc.prototype.name="Tlv0_1_1WireFormat";s.Tlv0_1_1WireFormat=wc;wc.instance=null;wc.get=function(){null===wc.instance&&(wc.instance=new wc);return wc.instance};var t=a.WireFormat,wc=a.Tlv0_1_1WireFormat,pd=function(){wc.call(this)};pd.prototype=new wc;pd.prototype.name="Tlv0_1WireFormat";s.Tlv0_1WireFormat=pd;pd.instance=null;pd.get=function(){null===pd.instance&&(pd.instance=new pd);return pd.instance};t=a.WireFormat;
H=a.Tlv0_2WireFormat;hb=function(){H.call(this)};hb.prototype=new H;hb.prototype.name="TlvWireFormat";s.TlvWireFormat=hb;hb.instance=null;hb.get=function(){null===hb.instance&&(hb.instance=new hb);return hb.instance};t.setDefaultWireFormat(hb.get());var M=a.DataUtils,va=a.KeyLocatorType,E=a.Interest,S=a.Data,Ka=a.Sha256WithRsaSignature,Ya=a.Sha256WithEcdsaSignature,qb=a.HmacWithSha256Signature,yb=a.DigestSha256Signature,Ea=a.ContentType,t=a.WireFormat,Qd=function(){};s.EncodingUtils=Qd;Qd.encodeToHexInterest=
function(a,b){b=b||t.getDefaultWireFormat();return M.toHex(a.wireEncode(b).buf())};Qd.encodeToHexData=function(a,b){b=b||t.getDefaultWireFormat();return M.toHex(a.wireEncode(b).buf())};Qd.decodeHexInterest=function(a,b){b=b||t.getDefaultWireFormat();var c=new E;c.wireDecode(M.toNumbers(a),b);return c};Qd.decodeHexData=function(a,b){b=b||t.getDefaultWireFormat();var c=new S;c.wireDecode(M.toNumbers(a),b);return c};Qd.decodeSubjectPublicKeyInfo=function(a){a=M.toHex(a).toLowerCase();a=_x509_getPublicKeyHexArrayFromCertHex(a,
_x509_getSubjectPublicKeyPosFromCertHex(a,0));var b=new C;b.setPublic(a[0],a[1]);return b};Qd.dataToHtml=function(a){function b(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");c+=a;c+="<br/>"}if(-1==a)return"NO CONTENT FOUND";if(-2==a)return"CONTENT NAME IS EMPTY";var c="";b("name: "+a.getName().toUri());0<a.getContent().size()?(b("content (raw): "+a.getContent().buf().toString("binary")),b("content (hex): "+a.getContent().toHex())):b("content: <empty>");a.getMetaInfo().getType()!=Ea.BLOB&&
(a.getMetaInfo().getType()==Ea.KEY?b("metaInfo.type: KEY"):a.getMetaInfo().getType()==Ea.LINK?b("metaInfo.type: LINK"):a.getMetaInfo().getType()==Ea.NACK?b("metaInfo.type: NACK"):a.getMetaInfo().getType()==Ea.OTHER_CODE&&b("metaInfo.type: other code "+a.getMetaInfo().getOtherTypeCode()));b("metaInfo.freshnessPeriod (milliseconds): "+(0<=a.getMetaInfo().getFreshnessPeriod()?""+a.getMetaInfo().getFreshnessPeriod():"<none>"));b("metaInfo.finalBlockId: "+(0<a.getMetaInfo().getFinalBlockId().getValue().size()?
a.getMetaInfo().getFinalBlockId().getValue().toHex():"<none>"));var g=null,f=a.getSignature();f instanceof Ka?(f=a.getSignature(),b("Sha256WithRsa signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof Ya?(f=a.getSignature(),b("Sha256WithEcdsa signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof qb?(f=a.getSignature(),b("HmacWithSha256 signature.signature: "+(0<f.getSignature().size()?
f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof yb&&(f=a.getSignature(),b("DigestSha256 signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")));null!==g&&(null==g.getType()?b("signature.keyLocator: <none>"):g.getType()==va.KEY_LOCATOR_DIGEST?b("signature.keyLocator: KeyLocatorDigest: "+g.getKeyData().toHex()):g.getType()==va.KEYNAME?b("signature.keyLocator: KeyName: "+g.getKeyName().toUri()):b("signature.keyLocator: <unrecognized ndn_KeyLocatorType>"));
return c};var c=a.Name,S=a.Data,$d=function(){this.cache_=[]};s.InMemoryStorageRetaining=$d;$d.prototype.insert=function(a){this.cache_[a.getFullName().toUri()]=new S(a)};$d.prototype.find=function(a){for(var b in this.cache_)if(a.getName().isPrefixOf(new c(b)))return this.cache_[b]};$d.prototype.size=function(){return Object.keys(this.cache_).length};var X=a,m=a.Blob,Rd=a.DecryptKey,ae=a.EncryptKey,fa=a.EncryptAlgorithmType,Hb=a.UseSubtleCrypto,b=a.SyncPromise,rb=function(){};s.AesAlgorithm=rb;rb.generateKey=
function(a){a=X.randomBytes(a.getKeySize()/8);return new Rd(new m(a,!1))};rb.deriveEncryptKey=function(a){return new ae(a)};rb.decryptPromise=function(a,c,g,l){if(Hb()&&!l&&g.getAlgorithmType()!=fa.AesEcb)return g.getAlgorithmType()==fa.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"AES-CBC",iv:g.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),!1))}):
Promise.reject(Error("unsupported encryption mode"));if(g.getAlgorithmType()==fa.AesEcb)try{var q=X.createDecipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),"");return b.resolve(new m(f.concat([q.update(c.buf()),q.final()]),!1))}catch(t){return b.reject(t)}else if(g.getAlgorithmType()==fa.AesCbc)try{return q=X.createDecipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),g.getInitialVector().buf()),b.resolve(new m(f.concat([q.update(c.buf()),q.final()]),!1))}catch(s){return b.reject(s)}else return b.reject(Error("unsupported encryption mode"))};
rb.decrypt=function(a,c,g){return b.getValue(this.decryptPromise(a,c,g,!0))};rb.encryptPromise=function(a,c,g,l){return g.getAlgorithmType()==fa.AesCbc&&g.getInitialVector().size()!=rb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):Hb()&&!l&&g.getAlgorithmType()!=fa.AesEcb?g.getAlgorithmType()==fa.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.encrypt({name:"AES-CBC",iv:g.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),
!1))}):Promise.reject(Error("unsupported encryption mode")):g.getAlgorithmType()==fa.AesEcb?(a=X.createCipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),""),b.resolve(new m(f.concat([a.update(c.buf()),a.final()]),!1))):g.getAlgorithmType()==fa.AesCbc?(a=X.createCipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),g.getInitialVector().buf()),b.resolve(new m(f.concat([a.update(c.buf()),a.final()]),!1))):b.reject(Error("unsupported encryption mode"))};rb.encrypt=function(a,c,g){return b.getValue(this.encryptPromise(a,
c,g,!0))};rb.BLOCK_SIZE=16;X=a;m=a.Blob;fa=function(){};s.EncryptAlgorithmType=fa;fa.AesEcb=0;fa.AesCbc=1;fa.RsaPkcs=2;fa.RsaOaep=3;var Gb=function(a,b){this.algorithmType_=a;if(null!=b&&0<b){var c=X.randomBytes(b);this.initialVector_=new m(c,!1)}else this.initialVector_=new m};s.EncryptParams=Gb;Gb.prototype.getAlgorithmType=function(){return this.algorithmType_};Gb.prototype.getInitialVector=function(){return this.initialVector_};Gb.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};
Gb.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof m?a:new m(a);return this};var X=a,c=a.Name,W=a.KeyLocator,va=a.KeyLocatorType,hb=a.TlvWireFormat,m=a.Blob,rb=a.AesAlgorithm,sb=a.RsaAlgorithm,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,Ma=a.EncryptedContent,b=a.SyncPromise,Ga=function(a){};s.Encryptor=Ga;Ga.NAME_COMPONENT_FOR=new c.Component("FOR");Ga.NAME_COMPONENT_READ=new c.Component("READ");Ga.NAME_COMPONENT_SAMPLE=new c.Component("SAMPLE");Ga.NAME_COMPONENT_ACCESS=
new c.Component("ACCESS");Ga.NAME_COMPONENT_E_KEY=new c.Component("E-KEY");Ga.NAME_COMPONENT_D_KEY=new c.Component("D-KEY");Ga.NAME_COMPONENT_C_KEY=new c.Component("C-KEY");Ga.encryptDataPromise=function(a,g,l,q,t,s){a.getName().append(Ga.NAME_COMPONENT_FOR).append(l);var G=t.getAlgorithmType();return G==fa.AesCbc||G==fa.AesEcb?Ga.encryptSymmetricPromise_(g,q,l,t,s).then(function(c){a.setContent(c.wireEncode(hb.get()));return b.resolve()}):G==fa.RsaPkcs||G==fa.RsaOaep?Ga.encryptAsymmetricPromise_(g,
q,l,t,s).then(function(c){a.setContent(c.wireEncode(hb.get()));return b.resolve()},function(G){G=X.randomBytes(16);var x=new m(G,!1),Md=new c(l);Md.append("nonce");var rc=new Gb(fa.AesCbc,rb.BLOCK_SIZE),Bb;return Ga.encryptAsymmetricPromise_(x,q,l,t,s).then(function(a){Bb=a;return Ga.encryptSymmetricPromise_(g,x,Md,rc,s)}).then(function(c){c=c.wireEncode();var g=Bb.wireEncode(),l=new f(c.size()+g.size());g.buf().copy(l,0);c.buf().copy(l,g.size());a.setContent(new m(l,!1));return b.resolve()})}):b.reject(Error("Unsupported encryption method"))};
Ga.encryptData=function(a,c,g,f,l){return b.getValue(Ga.encryptDataPromise(a,c,g,f,l,!0))};Ga.encryptSymmetricPromise_=function(a,c,g,f,l){var m=f.getAlgorithmType(),q=f.getInitialVector(),t=new W;t.setType(va.KEYNAME);t.setKeyName(g);return m==fa.AesCbc||m==fa.AesEcb?m==fa.AesCbc&&q.size()!=rb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):rb.encryptPromise(c,a,f,l).then(function(a){var c=new Ma;c.setAlgorithmType(m);c.setKeyLocator(t);c.setPayload(a);c.setInitialVector(q);return b.resolve(c)}):
b.reject(Error("Unsupported encryption method"))};Ga.encryptAsymmetricPromise_=function(a,c,g,f,l){var m=f.getAlgorithmType(),q=new W;q.setType(va.KEYNAME);q.setKeyName(g);return m==fa.RsaPkcs||m==fa.RsaOaep?sb.encryptPromise(c,a,f,l).then(function(a){var c=new Ma;c.setAlgorithmType(m);c.setKeyLocator(q);c.setPayload(a);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};xd=a.constants;X=a;m=a.Blob;Rd=a.DecryptKey;ae=a.EncryptKey;fa=a.EncryptAlgorithmType;l=a.DerNode;nb=a.OID;
ta=a.PrivateKeyStorage;Hb=a.UseSubtleCrypto;b=a.SyncPromise;Ba=a.PublicKey;Ec=null;try{Ec=a}catch(of){}sb=function(){};s.RsaAlgorithm=sb;sb.generateKeyPromise=function(a,c){if(Hb()&&!c)return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){return Promise.resolve(new Rd(new m(new Uint8Array(a),!1)))});
if(!Ec)return b.reject(Error("Need to install rsa-keypair: sudo npm install rsa-keypair"));try{var g=Ec.generate(a.getKeySize()).privateKey.toString().replace("-----BEGIN RSA PRIVATE KEY-----","").replace("-----END RSA PRIVATE KEY-----",""),q=new f(g,"base64"),t=ta.encodePkcs8PrivateKey(q,new nb(ta.RSA_ENCRYPTION_OID),new l.DerNull).buf();return b.resolve(new Rd(t))}catch(s){return b.reject(s)}};sb.generateKey=function(a){return b.getValue(sb.generateKeyPromise(a,!0))};sb.deriveEncryptKey=function(a){a=
sb.getRsaPrivateKeyDer(a);var b=l.parse(a.buf(),0).getChildren();a=b[1];var b=b[2],c=new l.DerSequence;c.addChild(a);c.addChild(b);a=c.encode();b=new l.DerSequence;b.addChild(new l.DerOid(new nb(ta.RSA_ENCRYPTION_OID)));b.addChild(new l.DerNull);c=new l.DerSequence;c.addChild(b);c.addChild(new l.DerBitString(a.buf(),0));return new ae(c.encode())};sb.decryptPromise=function(a,c,g,f){if(Hb()&&!f&&g.getAlgorithmType()!=fa.RsaPkcs)return g.getAlgorithmType()==fa.RsaOaep?crypto.subtle.importKey("pkcs8",
a.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"RSA-OAEP"},a,c.buf())}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));f=sb.getRsaPrivateKeyDer(a).buf().toString("base64");a="-----BEGIN RSA PRIVATE KEY-----\n";for(var l=0;l<f.length;l+=64)a+=f.substr(l,64)+"\n";a+="-----END RSA PRIVATE KEY-----";if(g.getAlgorithmType()==fa.RsaPkcs)g=xd.RSA_PKCS1_PADDING;else if(g.getAlgorithmType()==
fa.RsaOaep)g=xd.RSA_PKCS1_OAEP_PADDING;else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new m(X.privateDecrypt({key:a,padding:g},c.buf()),!1))}catch(q){return b.reject(q)}};sb.decrypt=function(a,c,g){return b.getValue(sb.decryptPromise(a,c,g,!0))};sb.encryptPromise=function(a,c,g,f){var l;try{l=new Ba(a)}catch(m){return b.reject(m)}return l.encryptPromise(c,g.getAlgorithmType(),f)};sb.encrypt=function(a,c,g){return b.getValue(sb.encryptPromise(a,c,g,!0))};sb.getRsaPrivateKeyDer=
function(a){a=l.parse(a.buf(),0).getChildren();if(l.getSequence(a,1).getChildren()[0].toVal()!=ta.RSA_ENCRYPTION_OID)throw Error("The PKCS #8 private key is not RSA_ENCRYPTION");return a[2].getPayload()};var b=a.SyncPromise,qd=function(){};s.ConsumerDb=qd;qd.Error=function(a){if(a)return a.__proto__=qd.Error.prototype,a};qd.Error.prototype=Error();qd.Error.prototype.name="ConsumerDbError";qd.prototype.getKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.getKeyPromise is not implemented"))};
qd.prototype.addKeyPromise=function(a,c,g){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};qd.prototype.deleteKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};var m=a.Blob,c=a.Name,E=a.Interest,cb=a.NetworkNack,Fb=a.Link,Ma=a.EncryptedContent,za=a.EncryptError,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,sb=a.RsaAlgorithm,rb=a.AesAlgorithm,Ga=a.Encryptor,b=a.SyncPromise,P=a.NdnCommon,Qa=function ob(a,b,g,f,l,m,q){this.database_=
l;this.keyChain_=b;this.face_=a;this.groupName_=new c(g);this.consumerName_=new c(f);this.cKeyLink_=void 0==m?ob.NO_LINK:new Fb(m);this.dKeyLink_=void 0==q?ob.NO_LINK:new Fb(q);this.cKeyMap_={};this.dKeyMap_={}};s.Consumer=Qa;Qa.prototype.consume=function(a,b,c,g){void 0==g&&(g=Qa.NO_LINK);a=new E(a);var f=this;this.sendInterest_(a,1,new Fb(g),function(a){f.decryptContent_(a,function(c){try{b(a,c)}catch(g){console.log("Error in onConsumeComplete: "+P.getErrorWithStackTrace(g))}},c)},c)};Qa.prototype.setGroup=
function(a){this.groupName_=new c(a)};Qa.prototype.addDecryptionKeyPromise=function(a,c,g){return this.consumerName_.match(a)?this.database_.addKeyPromise(a,c,g):b.reject(Error("addDecryptionKey: The consumer name must be a prefix of the key name"))};Qa.prototype.addDecryptionKey=function(a,c,g,f){return b.complete(g,f,this.addDecryptionKeyPromise(a,c,!g))};Qa.Error=function(a,b){this.errorCode=a;this.message=b};Qa.Error.callOnError=function(a,b,c){c||(c="");if(b instanceof Qa.Error)try{a(b.errorCode,
b.message)}catch(g){console.log("Error in onError: "+P.getErrorWithStackTrace(g))}else try{a(za.ErrorCode.General,c+b)}catch(f){console.log("Error in onError: "+P.getErrorWithStackTrace(f))}};Qa.decryptPromise_=function(a,c){return b.resolve().then(function(){if("object"==typeof a&&a instanceof m){var g=a;a=new Ma;a.wireDecode(g)}g=a.getPayload();if(a.getAlgorithmType()==fa.AesCbc){var f=new Gb(fa.AesCbc);f.setInitialVector(a.getInitialVector());return rb.decryptPromise(c,g,f)}return a.getAlgorithmType()==
fa.RsaOaep?(f=new Gb(fa.RsaOaep),sb.decryptPromise(c,g,f)):b.reject(new Qa.Error(za.ErrorCode.UnsupportedEncryptionScheme,""+a.getAlgorithmType()))})};Qa.decrypt_=function(a,b,c,g){Qa.decryptPromise_(a,b).then(function(a){c(a)},function(a){Qa.Error.callOnError(g,a)})};Qa.prototype.decryptContent_=function(a,b,g){var f=new Ma;try{f.wireDecode(a.getContent())}catch(l){Qa.Error.callOnError(g,l,"Error decoding EncryptedContent: ");return}var m=f.getKeyLocator().getKeyName();if(a=this.cKeyMap_[m.toUri()])this.decrypt_(f,
a,b,g);else{a=new c(m);a.append(Ga.NAME_COMPONENT_FOR).append(this.groupName_);a=new E(a);var q=this;this.sendInterest_(a,1,this.cKeyLink_,function(a){q.decryptCKey_(a,function(a){q.cKeyMap_[m.toUri()]=a;Qa.decrypt_(f,a,b,g)},g)},g)}};Qa.prototype.decryptCKey_=function(a,b,g){a=a.getContent();var f=new Ma;try{f.wireDecode(a)}catch(l){Qa.Error.callOnError(g,l,"Error decoding EncryptedContent: ");return}a=f.getKeyLocator().getKeyName();var m=a.getPrefix(-3);m.append(Ga.NAME_COMPONENT_D_KEY).append(a.getSubName(-2));
if(a=this.dKeyMap_[m.toUri()])this.decrypt_(f,a,b,g);else{a=new c(m);a.append(Ga.NAME_COMPONENT_FOR).append(this.consumerName_);a=new E(a);var q=this;this.sendInterest_(a,1,this.dKeyLink_,function(a){q.decryptDKeyPromise_(a).then(function(a){q.dKeyMap_[m.toUri()]=a;Qa.decrypt_(f,a,b,g)},function(a){Qa.Error.callOnError(g,a,"decryptDKey error: ")})},g)}};Qa.prototype.decryptDKeyPromise_=function(a){var c,g,f,l=this;return b.resolve().then(function(){c=a.getContent();g=new Ma;g.wireDecode(c);var b=
g.getKeyLocator().getKeyName();return l.getDecryptionKeyPromise_(b)}).then(function(a){if(0==a.size())return b.reject(new Qa.Error(za.ErrorCode.NoDecryptKey,"The desired consumer decryption key in not in the database"));var l=c.buf().slice(g.wireEncode().size());f=new m(l,!1);return 0==f.size()?b.reject(new Qa.Error(za.ErrorCode.InvalidEncryptedFormat,"The data packet does not satisfy the D-KEY packet format")):Qa.decryptPromise_(g,a)}).then(function(a){return Qa.decryptPromise_(f,a)})};Qa.prototype.sendInterest_=
function(a,b,c,g,f){function l(a,b){try{f(za.ErrorCode.DataRetrievalFailure,a.getName().toUri())}catch(c){console.log("Error in onError: "+P.getErrorWithStackTrace(c))}}var m=this,q=function(a,b){try{m.keyChain_.verifyData(b,g,function(a,b){try{f(za.ErrorCode.Validation,"verifyData failed. Reason: "+b)}catch(c){console.log("Error in onError: "+P.getErrorWithStackTrace(c))}})}catch(c){Qa.Error.callOnError(f,c,"verifyData error: ")}},t=function(a){0<b?m.sendInterest_(a,b-1,c,g,f):l(a,new cb)};0!==c.getDelegations().size()&&
(a=new E(a),a.setLinkWireEncoding(c.wireEncode()));try{this.face_.expressInterest(a,q,t,l)}catch(s){Qa.Error.callOnError(f,s,"expressInterest error: ")}};Qa.prototype.getDecryptionKeyPromise_=function(a){return this.database_.getKeyPromise(a)};Qa.NO_LINK=new Fb;m=a.Blob;Rd=function ze(a){this.keyBits_="object"===typeof a&&a instanceof ze?a.keyBits_:"object"===typeof a&&a instanceof m?a:new m(a)};s.DecryptKey=Rd;Rd.prototype.getKeyBits=function(){return this.keyBits_};var c=a.Name,E=a.Interest,za=
a.EncryptError,D=a.KeyChain,Tc=a.SafeBag,Da=a.EncryptorV2,za=a.EncryptError,Ma=a.EncryptedContent,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,rb=a.AesAlgorithm,P=a.NdnCommon,ma=a.Pib,b=a.SyncPromise,va=a.KeyLocatorType,g=a.Log.LOG,Jb=function(a,b,c,g){this.contentKeys_={};this.credentialsKey_=a;this.face_=g;this.keyChain_=c;this.internalKeyChain_=new D("pib-memory:","tpm-memory:")};s.DecryptorV2=Jb;Jb.prototype.shutdown=function(){for(var a in this.contentKeys_){var b=this.contentKeys_[a];if(0<b.pendingInterest){this.face_.removePendingInterest(b.pendingInterest);
b.pendingInterest=0;for(var c in b.pendingDecrypts)b.pendingDecrypts[c].onError(za.ErrorCode.CkRetrievalFailure,"Canceling pending decrypt as ContentKey is being destroyed");b.pendingDecrypts=[]}}};Jb.prototype.decrypt=function(a,b,c){if(a.getKeyLocator().getType()!=va.KEYNAME)3<g&&console.log("Missing required KeyLocator in the supplied EncryptedContent block"),c(za.ErrorCode.MissingRequiredKeyLocator,"Missing required KeyLocator in the supplied EncryptedContent block");else if(a.hasInitialVector()){var f=
a.getKeyLocatorName(),l=f.toUri(),m=this.contentKeys_[l],q=void 0===m;q&&(m=new Jb.ContentKey,this.contentKeys_[l]=m);m.isRetrieved?Jb.doDecrypt_(a,m.bits,b,c):(3<g&&console.log("CK "+f.toUri()+" not yet available, so adding to the pending decrypt queue"),m.pendingDecrypts.push(new Jb.ContentKey.PendingDecrypt(a,b,c)));q&&this.fetchCk_(f,m,c,Da.N_RETRIES)}else 3<g&&console.log("Missing required initial vector in the supplied EncryptedContent block"),c(za.ErrorCode.MissingRequiredInitialVector,"Missing required initial vector in the supplied EncryptedContent block")};
Jb.ContentKey=function(){this.isRetrieved=!1;this.bits=null;this.pendingInterest=0;this.pendingDecrypts=[]};Jb.ContentKey.PendingDecrypt=function(a,b,c){this.encryptedContent=a;this.onSuccess=b;this.onError=c};Jb.prototype.fetchCk_=function(a,b,c,f){3<g&&console.log("Fetching CK "+a.toUri());var l=this,m=function(a,f){try{b.pendingInterest=0;var m=[null],q=[null],t=[null];if(Jb.extractKdkInfoFromCkName_(f.getName(),a.getName(),c,m,q,t)){var s=null;try{s=l.internalKeyChain_.getPib().getIdentity(q[0])}catch(rc){if(!(rc instanceof
ma.Error))throw rc;}if(null!=s){q=null;try{q=s.getKey(t[0])}catch(G){if(!(G instanceof ma.Error))throw G;}if(null!=q){3<g&&console.log("KDK "+t.toUri()+" already exists, so directly using it to decrypt the CK");l.decryptCkAndProcessPendingDecrypts_(b,f,t[0],c);return}}l.fetchKdk_(b,m[0],f,c,Da.N_RETRIES)}}catch(x){c(za.ErrorCode.General,"Error in fetchCk onData: "+x)}},q=function(g){b.pendingInterest=0;1<f?l.fetchCk_(a,b,c,f-1):c(za.ErrorCode.CkRetrievalTimeout,"Retrieval of CK ["+g.getName().toUri()+
"] timed out")},t=function(a,g){b.pendingInterest=0;c(za.ErrorCode.CkRetrievalFailure,"Retrieval of CK ["+a.getName().toUri()+"] failed. Got NACK ("+g.getReason()+")")};try{b.pendingInterest=this.face_.expressInterest((new E(a)).setMustBeFresh(!1).setCanBePrefix(!0),m,q,t)}catch(s){c(za.ErrorCode.General,"expressInterest error: "+s)}};Jb.prototype.fetchKdk_=function(a,b,f,l,m){var q=new c(b);q.append(Da.NAME_COMPONENT_ENCRYPTED_BY).append(this.credentialsKey_.getName());3<g&&console.log("Fetching KDK "+
q.toUri());var t=this,s=function(c,g){a.pendingInterest=0;if(t.decryptAndImportKdk_(g,l)){var m=b.getPrefix(-2).append("KEY").append(b.get(-1));t.decryptCkAndProcessPendingDecrypts_(a,f,m,l)}},rc=function(c){a.pendingInterest=0;1<m?t.fetchKdk_(a,b,f,l,m-1):l(za.ErrorCode.KdkRetrievalTimeout,"Retrieval of KDK ["+c.getName().toUri()+"] timed out")},Bb=function(b,c){a.pendingInterest=0;l(za.ErrorCode.KdkRetrievalFailure,"Retrieval of KDK ["+b.getName().toUri()+"] failed. Got NACK ("+c.getReason()+")")};
try{a.pendingInterest=this.face_.expressInterest((new E(q)).setMustBeFresh(!0).setCanBePrefix(!1),s,rc,Bb)}catch(Pe){l(za.ErrorCode.General,"expressInterest error: "+Pe)}};Jb.prototype.decryptAndImportKdk_=function(a,c){try{3<g&&console.log("Decrypting and importing KDK "+a.getName().toUri());var f=new Ma;f.wireDecodeV2(a.getContent());var l=new Tc(f.getPayload()),m=b.getValue(this.keyChain_.getTpm().decryptPromise(f.getPayloadKey().buf(),this.credentialsKey_.getName(),!0));if(m.isNull())return c(za.ErrorCode.TpmKeyNotFound,
"Could not decrypt secret, "+this.credentialsKey_.getName().toUri()+" not found in TPM"),!1;this.internalKeyChain_.importSafeBag(l,m.buf());return!0}catch(q){return c(za.ErrorCode.DecryptionFailure,"Failed to decrypt KDK ["+a.getName().toUri()+"]: "+q),!1}};Jb.prototype.decryptCkAndProcessPendingDecrypts_=function(a,c,f,l){3<g&&console.log("Decrypting CK data "+c.getName().toUri());var m=new Ma;try{m.wireDecodeV2(c.getContent())}catch(q){l(za.ErrorCode.InvalidEncryptedFormat,"Error decrypting EncryptedContent: "+
q);return}var t;try{t=b.getValue(this.internalKeyChain_.getTpm().decryptPromise(m.getPayload().buf(),f,!0))}catch(s){l(za.ErrorCode.DecryptionFailure,"Error decrypting the CK EncryptedContent "+s);return}if(t.isNull())l(za.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+f.toUri()+" not found in TPM");else{a.bits=t;a.isRetrieved=!0;for(var rc in a.pendingDecrypts)c=a.pendingDecrypts[rc],Jb.doDecrypt_(c.encryptedContent,a.bits,c.onSuccess,c.onError);a.pendingDecrypts=[]}};Jb.doDecrypt_=function(a,
b,c,g){if(a.hasInitialVector()){var f;try{var l=new Gb(fa.AesCbc);l.setInitialVector(a.getInitialVector());f=rb.decrypt(b,a.getPayload(),l)}catch(m){g(za.ErrorCode.DecryptionFailure,"Decryption error in doDecrypt: "+m);return}try{c(f)}catch(q){console.log("Error in onSuccess: "+P.getErrorWithStackTrace(q))}}else g(za.ErrorCode.MissingRequiredInitialVector,"Expecting Initial Vector in the encrypted content, but it is not present")};Jb.convertKekNameToKdkPrefix_=function(a,b){return 2>a.size()||!a.get(-2).equals(Da.NAME_COMPONENT_KEK)?
(b(za.ErrorCode.KekInvalidName,"Invalid KEK name ["+a.toUri()+"]"),null):a.getPrefix(-2).append(Da.NAME_COMPONENT_KDK).append(a.get(-1))};Jb.extractKdkInfoFromCkName_=function(a,b,c,g,f,l){if(a.size()<b.size()+1||!a.getPrefix(b.size()).equals(b)||!a.get(b.size()).equals(Da.NAME_COMPONENT_ENCRYPTED_BY))return c(za.ErrorCode.CkInvalidName,"Invalid CK name ["+a.toUri()+"]"),!1;a=a.getSubName(b.size()+1);g[0]=Jb.convertKekNameToKdkPrefix_(a,c);if(null==g[0])return!1;f[0]=a.getPrefix(-2);l[0]=a.getPrefix(-2).append("KEY").append(a.get(-1));
return!0};za=function(){};s.EncryptError=za;za.ErrorCode={KekRetrievalFailure:1,KekRetrievalTimeout:2,KekInvalidName:3,KdkRetrievalFailure:11,KdkRetrievalTimeout:12,KdkInvalidName:13,KdkDecryptionFailure:14,CkRetrievalFailure:21,CkRetrievalTimeout:22,CkInvalidName:23,MissingRequiredKeyLocator:101,TpmKeyNotFound:102,EncryptionFailure:103,DecryptionFailure:104,MissingRequiredInitialVector:110,General:200,Timeout:1001,Validation:1002,UnsupportedEncryptionScheme:1032,InvalidEncryptedFormat:1033,NoDecryptKey:1034,
DataRetrievalFailure:1036};m=a.Blob;ae=function Oe(a){this.keyBits_="object"===typeof a&&a instanceof Oe?a.keyBits_:"object"===typeof a&&a instanceof m?a:new m(a)};s.EncryptKey=ae;ae.prototype.getKeyBits=function(){return this.keyBits_};W=a.KeyLocator;va=a.KeyLocatorType;t=a.WireFormat;m=a.Blob;Ma=function Ae(a){"object"===typeof a&&a instanceof Ae?(this.algorithmType_=a.algorithmType_,this.keyLocator_=new W(a.keyLocator_),this.initialVector_=a.initialVector_,this.payload_=a.payload_,this.payloadKey_=
a.payloadKey_):this.clear()};s.EncryptedContent=Ma;Ma.prototype.getAlgorithmType=function(){return this.algorithmType_};Ma.prototype.getKeyLocator=function(){return this.keyLocator_};Ma.prototype.getKeyLocatorName=function(){if(this.keyLocator_.getType()!=va.KEYNAME)throw Error("getKeyLocatorName: The KeyLocator type must be KEYNAME");return this.keyLocator_.getKeyName()};Ma.prototype.hasInitialVector=function(){return!this.initialVector_.isNull()};Ma.prototype.getInitialVector=function(){return this.initialVector_};
Ma.prototype.getPayload=function(){return this.payload_};Ma.prototype.getPayloadKey=function(){return this.payloadKey_};Ma.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};Ma.prototype.setKeyLocator=function(a){this.keyLocator_="object"===typeof a&&a instanceof W?new W(a):new W;return this};Ma.prototype.setKeyLocatorName=function(a){this.keyLocator_.setType(va.KEYNAME);this.keyLocator_.setKeyName(a);return this};Ma.prototype.setInitialVector=function(a){this.initialVector_=
"object"===typeof a&&a instanceof m?a:new m(a);return this};Ma.prototype.setPayload=function(a){this.payload_="object"===typeof a&&a instanceof m?a:new m(a);return this};Ma.prototype.setPayloadKey=function(a){this.payloadKey_="object"===typeof a&&a instanceof m?a:new m(a);return this};Ma.prototype.clear=function(){this.algorithmType_=null;this.keyLocator_=new W;this.initialVector_=new m;this.payload_=new m;this.payloadKey_=new m};Ma.prototype.wireEncode=function(a){a=a||t.getDefaultWireFormat();return a.encodeEncryptedContent(this)};
Ma.prototype.wireEncodeV2=function(a){a=a||t.getDefaultWireFormat();return a.encodeEncryptedContentV2(this)};Ma.prototype.wireDecode=function(a,b){b=b||t.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeEncryptedContent(this,a.buf(),!1):b.decodeEncryptedContent(this,a,!0)};Ma.prototype.wireDecodeV2=function(a,b){b=b||t.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeEncryptedContentV2(this,a.buf(),!1):b.decodeEncryptedContentV2(this,a,!0)};X=a;m=a.Blob;c=a.Name;
S=a.Data;E=a.Interest;Z=a.SigningInfo;$d=a.InMemoryStorageRetaining;Ba=a.PublicKey;Ma=a.EncryptedContent;Gb=a.EncryptParams;fa=a.EncryptAlgorithmType;rb=a.AesAlgorithm;P=a.NdnCommon;za=a.EncryptError;g=a.Log.LOG;Da=function Be(a,b,f,l,m,q,t){this.accessPrefix_=new c(a);this.ckPrefix_=new c(b);this.ckBits_=null;this.ckDataSigningInfo_=new Z(f);this.isKekRetrievalInProgress_=!1;this.onError_=l;this.keyChain_=q;this.face_=t;this.kekData_=null;this.storage_=new $d;this.kekPendingInterestId_=0;this.regenerateCk();
var s=this;this.ckRegisteredPrefixId_=this.face_.registerPrefix((new c(b)).append(Be.NAME_COMPONENT_CK),function(a,b,c,f,l){a=s.storage_.find(b);if(null!=a){3<g&&console.log("Serving "+a.getName().toUri()+" from InMemoryStorage");try{c.putData(a)}catch(m){console.log("Error in Face.putData: "+P.getErrorWithStackTrace(m))}}else 3<g&&console.log("Didn't find CK data for "+b.getName().toUri())},function(a){0<g&&console.log("Failed to register prefix "+a.toUri())})};s.EncryptorV2=Da;Da.prototype.shutdown=
function(){this.face_.unsetInterestFilter(this.ckRegisteredPrefixId_);0<this.kekPendingInterestId_&&this.face_.removePendingInterest(this.kekPendingInterestId_)};Da.prototype.encrypt=function(a){var b=X.randomBytes(Da.AES_IV_SIZE),c=new Gb(fa.AesCbc);c.setInitialVector(new m(b,!1));a instanceof m||(a=new m(a));a=rb.encrypt(new m(this.ckBits_,!1),a,c);c=new Ma;c.setInitialVector(new m(b,!1));c.setPayload(a);c.setKeyLocatorName(this.ckName_);return c};Da.prototype.regenerateCk=function(){this.ckName_=
new c(this.ckPrefix_);this.ckName_.append(Da.NAME_COMPONENT_CK);this.ckName_.appendVersion((new Date).getTime());3<g&&console.log("Generating new CK: "+this.ckName_.toUri());this.ckBits_=X.randomBytes(Da.AES_KEY_SIZE);null==this.kekData_?this.retryFetchingKek_():this.makeAndPublishCkData_(this.onError_)};Da.prototype.size=function(){return this.storage_.size()};Da.prototype.retryFetchingKek_=function(){if(!this.isKekRetrievalInProgress_){3<g&&console.log("Retrying fetching of the KEK");this.isKekRetrievalInProgress_=
!0;var a=this;this.fetchKekAndPublishCkData_(function(){3<g&&console.log("The KEK was retrieved and published");a.isKekRetrievalInProgress_=!1},function(b,c){3<g&&console.log("Failed to retrieve KEK: "+c);a.isKekRetrievalInProgress_=!1;a.onError_(b,c)},Da.N_RETRIES)}};Da.prototype.fetchKekAndPublishCkData_=function(a,b,f){3<g&&console.log("Fetching KEK: "+(new c(this.accessPrefix_)).append(Da.NAME_COMPONENT_KEK).toUri());if(0<this.kekPendingInterestId_)b(za.ErrorCode.General,"fetchKekAndPublishCkData: There is already a kekPendingInterestId_");
else{var l=this,m=function(c,g){l.kekPendingInterestId_=0;l.kekData_=g;l.makeAndPublishCkData_(b)&&a()},q=function(c){l.kekPendingInterestId_=0;1<f?l.fetchKekAndPublishCkData_(a,b,f-1):(b(za.ErrorCode.KekRetrievalTimeout,"Retrieval of KEK ["+c.getName().toUri()+"] timed out"),3<g&&console.log("Scheduling retry after all timeouts"),setTimeout(function(){l.retryFetchingKek_()},Da.RETRY_DELAY_KEK_RETRIEVAL_MS))},t=function(c,m){l.kekPendingInterestId_=0;1<f?setTimeout(function(){l.fetchKekAndPublishCkData_(a,
b,f-1)},Da.RETRY_DELAY_AFTER_NACK_MS):(b(za.ErrorCode.KekRetrievalFailure,"Retrieval of KEK ["+c.getName().toUri()+"] failed. Got NACK ("+m.getReason()+")"),3<g&&console.log("Scheduling retry from NACK"),setTimeout(function(){l.retryFetchingKek_()},Da.RETRY_DELAY_KEK_RETRIEVAL_MS))};try{this.kekPendingInterestId_=this.face_.expressInterest((new E((new c(this.accessPrefix_)).append(Da.NAME_COMPONENT_KEK))).setMustBeFresh(!0).setCanBePrefix(!0),m,q,t)}catch(s){b(za.ErrorCode.General,"expressInterest error: "+
s)}}};Da.prototype.makeAndPublishCkData_=function(a){try{var b=new Ba(this.kekData_.getContent()),f=new Ma,l=b.encrypt(this.ckBits_,fa.RsaOaep);f.setPayload(l);var m=new S((new c(this.ckName_)).append(Da.NAME_COMPONENT_ENCRYPTED_BY).append(this.kekData_.getName()));m.setContent(f.wireEncodeV2());m.getMetaInfo().setFreshnessPeriod(Da.DEFAULT_CK_FRESHNESS_PERIOD_MS);this.keyChain_.sign(m,this.ckDataSigningInfo_);this.storage_.insert(m);3<g&&console.log("Publishing CK data: "+m.getName().toUri());return!0}catch(q){return a(za.ErrorCode.EncryptionFailure,
"Failed to encrypt generated CK with KEK "+this.kekData_.getName().toUri()),!1}};Da.NAME_COMPONENT_ENCRYPTED_BY=new c.Component("ENCRYPTED-BY");Da.NAME_COMPONENT_NAC=new c.Component("NAC");Da.NAME_COMPONENT_KEK=new c.Component("KEK");Da.NAME_COMPONENT_KDK=new c.Component("KDK");Da.NAME_COMPONENT_CK=new c.Component("CK");Da.RETRY_DELAY_AFTER_NACK_MS=1E3;Da.RETRY_DELAY_KEK_RETRIEVAL_MS=6E4;Da.AES_KEY_SIZE=32;Da.AES_IV_SIZE=16;Da.N_RETRIES=3;Da.DEFAULT_CK_FRESHNESS_PERIOD_MS=36E5;var b=a.SyncPromise,
jb=function(){};s.GroupManagerDb=jb;jb.Error=function(a){if(a)return a.__proto__=jb.Error.prototype,a};jb.Error.prototype=Error();jb.Error.prototype.name="GroupManagerDbError";jb.prototype.hasSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.hasSchedulePromise is not implemented"))};jb.prototype.listAllScheduleNamesPromise=function(a){return b.reject(Error("GroupManagerDb.listAllScheduleNamesPromise is not implemented"))};jb.prototype.getSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getSchedulePromise is not implemented"))};
jb.prototype.getScheduleMembersPromise=function(a,c){return b.reject(Error("GroupManagerDb.getScheduleMembersPromise is not implemented"))};jb.prototype.addSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.addSchedulePromise is not implemented"))};jb.prototype.deleteSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteSchedulePromise is not implemented"))};jb.prototype.renameSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.renameSchedulePromise is not implemented"))};
jb.prototype.updateSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.updateSchedulePromise is not implemented"))};jb.prototype.hasMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasMemberPromise is not implemented"))};jb.prototype.listAllMembersPromise=function(a){return b.reject(Error("GroupManagerDb.listAllMembersPromise is not implemented"))};jb.prototype.getMemberSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getMemberSchedulePromise is not implemented"))};
jb.prototype.addMemberPromise=function(a,c,g,f){return b.reject(Error("GroupManagerDb.addMemberPromise is not implemented"))};jb.prototype.updateMemberSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.updateMemberSchedulePromise is not implemented"))};jb.prototype.deleteMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteMemberPromise is not implemented"))};jb.prototype.hasEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasEKeyPromise is not implemented"))};
jb.prototype.addEKeyPromise=function(a,c,g,f){return b.reject(Error("GroupManagerDb.addEKeyPromise is not implemented"))};jb.prototype.getEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.getEKeyPromise is not implemented"))};jb.prototype.cleanEKeysPromise=function(a){return b.reject(Error("GroupManagerDb.cleanEKeysPromise is not implemented"))};jb.prototype.deleteEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteEKeyPromise is not implemented"))};var c=a.Name,S=
a.Data,b=a.SyncPromise,Oa=a.IdentityCertificate,x=a.SecurityException,cc=a.RsaKeyParams,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,Ga=a.Encryptor,sb=a.RsaAlgorithm,tb=a.Interval,ja=a.Schedule,ub=function(a,b,g,f,l,m){this.namespace_=(new c(a)).append(Ga.NAME_COMPONENT_READ).append(b);this.database_=g;this.keySize_=f;this.freshnessHours_=l;this.keyChain_=m};s.GroupManager=ub;ub.prototype.getGroupKeyPromise=function(a,g,f){void 0==g&&(g=!0);var l=[],m=[],q=this,t,s,G,x;return this.calculateIntervalPromise_(a,
l,f).then(function(a){if(!1==a.isValid())return b.resolve(m);G=ja.toIsoString(a.getStartTime());x=ja.toIsoString(a.getEndTime());var Q=new c(q.namespace_);Q.append(Ga.NAME_COMPONENT_E_KEY).append(G).append(x);return b.resolve().then(function(){return g?b.resolve(!1):q.database_.hasEKeyPromise(Q,f)}).then(function(a){return!g&&a?q.getEKeyPromise_(Q,f).then(function(a){t=a.privateKey;s=a.publicKey;return b.resolve()}):q.generateKeyPairPromise_(f).then(function(a){t=a.privateKeyBlob;s=a.publicKeyBlob;
return q.deleteEKeyPromise_(Q,f)}).then(function(){return q.addEKeyPromise_(Q,s,t,f)})}).then(function(){return q.createEKeyDataPromise_(G,x,s,f)}).then(function(a){function c(a){return a>=l.length?b.resolve():q.createDKeyDataPromise_(G,x,l[a].keyName,t,l[a].publicKey,f).then(function(b){m.push(b);return c(a+1)})}m.push(a);return c(0)}).then(function(){return b.resolve(m)})})};ub.prototype.addSchedulePromise=function(a,b,c){return this.database_.addSchedulePromise(a,b,c)};ub.prototype.deleteSchedulePromise=
function(a,b){return this.database_.deleteSchedulePromise(a,b)};ub.prototype.updateSchedulePromise=function(a,b,c){return this.database_.updateSchedulePromise(a,b,c)};ub.prototype.addMemberPromise=function(a,b,c){b=new Oa(b);return this.database_.addMemberPromise(a,b.getPublicKeyName(),b.getPublicKeyInfo().getKeyDer(),c)};ub.prototype.removeMemberPromise=function(a,b){return this.database_.deleteMemberPromise(a,b)};ub.prototype.updateMemberSchedulePromise=function(a,b,c){return this.database_.updateMemberSchedulePromise(a,
b,c)};ub.prototype.cleanEKeysPromise=function(a){return this.database_.cleanEKeysPromise(a)};ub.prototype.calculateIntervalPromise_=function(a,c,g){var f=new tb,l=new tb;c.splice(0,c.length);var m=this;return this.database_.listAllScheduleNamesPromise(g).then(function(q){function t(s){if(s>=q.length)return b.resolve();var G=q[s];return m.database_.getSchedulePromise(G,g).then(function(b){b=b.getCoveringInterval(a);var q=b.interval;if(b.isPositive)return f.isValid()||(f=q),f.intersectWith(q),m.database_.getScheduleMembersPromise(G,
g).then(function(a){for(var b=0;b<a.length;++b)ub.memberKeysAdd_(c,a[b]);return t(s+1)});l.isValid()||(l=q);l.intersectWith(q);return t(s+1)})}return t(0)}).then(function(){if(!f.isValid())return b.resolve(new tb(!1));var a;a=l.isValid()?f.intersectWith(l):f;return b.resolve(a)})};ub.memberKeysAdd_=function(a,b){for(var c=0;c<a.length;){var g=a[c].keyName.compare(b.keyName);if(0==g)return;if(0<g)break;c+=1}a.splice(c,0,b)};ub.prototype.generateKeyPairPromise_=function(a){a=new cc(this.keySize_);return sb.generateKeyPromise(a).then(function(a){a=
a.getKeyBits();var c=sb.deriveEncryptKey(a).getKeyBits();return b.resolve({privateKeyBlob:a,publicKeyBlob:c})})};ub.prototype.createEKeyDataPromise_=function(a,b,g,f){f=new c(this.namespace_);f.append(Ga.NAME_COMPONENT_E_KEY).append(a).append(b);a=new S(f);a.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*ub.MILLISECONDS_IN_HOUR);a.setContent(g);return this.keyChain_.signPromise(a)};ub.prototype.createDKeyDataPromise_=function(a,g,f,l,m,q){var t=new c(this.namespace_);t.append(Ga.NAME_COMPONENT_D_KEY);
t.append(a).append(g);var s=new S(t);s.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*ub.MILLISECONDS_IN_HOUR);a=new Gb(fa.RsaOaep);var G=this;return Ga.encryptDataPromise(s,l,f,m,a,q).catch(function(a){return b.reject(x(Error("createDKeyData: Error in encryptData: "+a)))}).then(function(){return G.keyChain_.signPromise(s)})};ub.prototype.addEKeyPromise_=function(a,b,c,g){return this.database_.addEKeyPromise(a,b,c,g)};ub.prototype.getEKeyPromise_=function(a,b){return this.database_.getEKeyPromise(a,
b)};ub.prototype.deleteEKeyPromise_=function(a,b){return this.database_.deleteEKeyPromise(a,b)};ub.MILLISECONDS_IN_HOUR=36E5;tb=function Ce(a,b){if("object"===typeof a&&a instanceof Ce)this.startTime_=a.startTime_,this.endTime_=a.endTime_,this.isValid_=a.isValid_;else if("number"===typeof a){if(!(a<b))throw Error("Interval start time must be less than the end time");this.startTime_=a;this.endTime_=b;this.isValid_=!0}else this.startTime_=-Number.MAX_VALUE,this.endTime_=-Number.MAX_VALUE,this.isValid_=
a?!0:!1};s.Interval=tb;tb.prototype.set=function(a){this.startTime_=a.startTime_;this.endTime_=a.endTime_;this.isValid_=a.isValid_};tb.prototype.covers=function(a){if(!this.isValid_)throw Error("Interval.covers: This Interval is invalid");return this.isEmpty()?!1:this.startTime_<=a&&a<this.endTime_};tb.prototype.intersectWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");
if(this.isEmpty()||a.isEmpty()||this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)return this.startTime_=this.endTime_,this;this.startTime_<=a.startTime_&&(this.startTime_=a.startTime_);this.endTime_>a.endTime_&&(this.endTime_=a.endTime_);return this};tb.prototype.unionWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");if(this.isEmpty())return this.startTime_=
a.startTime_,this.endTime_=a.endTime_,this;if(a.isEmpty())return this;if(this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)throw Error("Interval.unionWith: The two intervals do not have an intersection");this.startTime_>a.startTime_&&(this.startTime_=a.startTime_);this.endTime_<a.endTime_&&(this.endTime_=a.endTime_);return this};tb.prototype.getStartTime=function(){if(!this.isValid_)throw Error("Interval.getStartTime: This Interval is invalid");return this.startTime_};tb.prototype.getEndTime=
function(){if(!this.isValid_)throw Error("Interval.getEndTime: This Interval is invalid");return this.endTime_};tb.prototype.isValid=function(){return this.isValid_};tb.prototype.isEmpty=function(){if(!this.isValid_)throw Error("Interval.isEmpty: This Interval is invalid");return this.startTime_==this.endTime_};var b=a.SyncPromise,Ic=function(){};s.ProducerDb=Ic;Ic.Error=function(a){if(a)return a.__proto__=Ic.Error.prototype,a};Ic.Error.prototype=Error();Ic.Error.prototype.name="ProducerDbError";
Ic.prototype.hasContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.hasContentKeyPromise is not implemented"))};Ic.prototype.getContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.getContentKeyPromise is not implemented"))};Ic.prototype.addContentKeyPromise=function(a,c,g){return b.reject(Error("ProducerDb.addContentKeyPromise is not implemented"))};Ic.prototype.deleteContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.deleteContentKeyPromise is not implemented"))};
Ic.getFixedTimeSlot=function(a){return Math.floor(Math.round(a)/36E5)};var c=a.Name,E=a.Interest,S=a.Data,Fb=a.Link,cb=a.NetworkNack,Xa=a.Exclude,Ga=a.Encryptor,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,wd=a.AesKeyParams,rb=a.AesAlgorithm,ja=a.Schedule,za=a.EncryptError,P=a.NdnCommon,b=a.SyncPromise,na=function De(a,b,g,f,l,m,q){this.face_=g;this.keyChain_=f;this.database_=l;this.maxRepeatAttempts_=void 0==m?3:m;this.keyRetrievalLink_=void 0==q?De.NO_LINK:new Fb(q);this.eKeyInfo_={};this.keyRequests_=
{};g=new c(a);f=new c(b);for(g.append(Ga.NAME_COMPONENT_READ);0<f.size();)l=new c(g),l.append(f),l.append(Ga.NAME_COMPONENT_E_KEY),this.eKeyInfo_[l.toUri()]={keyName:l,keyInfo:new De.KeyInfo_},f=f.getPrefix(-1);g.append(b);this.namespace_=new c(a);this.namespace_.append(Ga.NAME_COMPONENT_SAMPLE);this.namespace_.append(b)};s.Producer=na;na.prototype.createContentKey=function(a,b,g,f){f||(f=na.defaultOnError);var l=na.getRoundedTimeSlot_(a),m=new c(this.namespace_);m.append(Ga.NAME_COMPONENT_C_KEY);
m.append(ja.toIsoString(l));var q,t=this;this.database_.hasContentKeyPromise(a).then(function(l){l?null!=g&&g(m):(l=new wd(128),q=rb.generateKey(l).getKeyBits(),t.database_.addContentKeyPromise(a,q).then(function(){var l=Math.round(a);t.keyRequests_[l]=new na.KeyRequest_(t.getEKeyInfoSize_());var l=t.keyRequests_[l],q=new Xa;na.excludeAfter(q,new c.Component(ja.toIsoString(a)));for(var s in t.eKeyInfo_){var Bb=t.eKeyInfo_[s],G=Bb.keyInfo;a<G.beginTimeSlot||a>=G.endTimeSlot?(l.repeatAttempts[s]=0,
t.sendKeyInterest_((new E(Bb.keyName)).setExclude(q).setChildSelector(1),a,b,f)):(Bb=new c(Bb.keyName),Bb.append(ja.toIsoString(G.beginTimeSlot)),Bb.append(ja.toIsoString(G.endTimeSlot)),t.encryptContentKeyPromise_(G.keyBits,Bb,a,b,f))}null!=g&&g(m)}))})};na.prototype.produce=function(a,b,g,f,l){l||(l=na.defaultOnError);var m=this;this.createContentKey(b,null,function(q){m.database_.getContentKeyPromise(b).then(function(f){var l=new c(m.namespace_);l.append(ja.toIsoString(b));a.setName(l);l=new Gb(fa.AesCbc,
16);return Ga.encryptData(a,g,q,f,l)}).then(function(){return m.keyChain_.signPromise(a)}).then(function(){try{f()}catch(a){console.log("Error in onComplete: "+P.getErrorWithStackTrace(a))}},function(a){try{l(za.ErrorCode.General,""+a)}catch(b){console.log("Error in onError: "+P.getErrorWithStackTrace(b))}})},l)};na.defaultOnError=function(a,b){};na.KeyInfo_=function(){this.endTimeSlot=this.beginTimeSlot=0;this.keyBits=null};na.KeyRequest_=function(a){this.interestCount=a;this.repeatAttempts={};this.encryptedKeys=
[]};na.getRoundedTimeSlot_=function(a){return Math.round(36E5*Math.floor(Math.round(a)/36E5))};na.prototype.sendKeyInterest_=function(a,b,c,g){var f=this;0!==this.keyRetrievalLink_.getDelegations().size()&&(a=new E(a),a.setLinkWireEncoding(this.keyRetrievalLink_.wireEncode()));this.face_.expressInterest(a,function(a,l){f.handleCoveringKey_(a,l,b,c,g)},function(a){f.handleTimeout_(a,b,c,g)},function(a,l){f.handleNetworkNack_(a,l,b,c,g)})};na.prototype.handleTimeout_=function(a,b,c,g){var f=Math.round(b),
f=this.keyRequests_[f],l=a.getName().toUri();f.repeatAttempts[l]<this.maxRepeatAttempts_?(++f.repeatAttempts[l],this.sendKeyInterest_(a,b,c,g)):this.handleNetworkNack_(a,new cb,b,c,g)};na.prototype.handleNetworkNack_=function(a,b,c,g,f){a=Math.round(c);this.updateKeyRequest_(this.keyRequests_[a],a,g)};na.prototype.updateKeyRequest_=function(a,b,c){--a.interestCount;if(0==a.interestCount&&null!=c){try{c(a.encryptedKeys)}catch(g){console.log("Error in onEncryptedKeys: "+P.getErrorWithStackTrace(g))}delete this.keyRequests_[b]}};
na.prototype.handleCoveringKey_=function(a,b,c,g,f){var l=Math.round(c),l=this.keyRequests_[l],m=a.getName(),q=m.toUri(),t=b.getName(),s=ja.fromIsoString(t.get(na.START_TIME_STAMP_INDEX).getValue().toString()),G=ja.fromIsoString(t.get(na.END_TIME_STAMP_INDEX).getValue().toString());if(c>=G)a=new Xa(a.getExclude()),na.excludeBefore(a,t.get(na.START_TIME_STAMP_INDEX)),l.repeatAttempts[q]=0,this.sendKeyInterest_((new E(m)).setExclude(a).setChildSelector(1),c,g,f);else{var x=b.getContent(),Q=this;this.encryptContentKeyPromise_(x,
t,c,g,f).then(function(a){a&&(a=Q.eKeyInfo_[q].keyInfo,a.beginTimeSlot=s,a.endTimeSlot=G,a.keyBits=x)})}};na.prototype.encryptContentKeyPromise_=function(a,g,f,l,m){var q=Math.round(f),t=this.keyRequests_[q],s=new c(this.namespace_);s.append(Ga.NAME_COMPONENT_C_KEY);s.append(ja.toIsoString(na.getRoundedTimeSlot_(f)));var G,x=this;return this.database_.getContentKeyPromise(f).then(function(b){G=new S;G.setName(s);var c=new Gb(fa.RsaOaep);return Ga.encryptDataPromise(G,b,g,a,c)}).then(function(){return b.resolve(!0)},
function(a){try{m(za.ErrorCode.EncryptionFailure,"encryptData failed: "+a)}catch(c){console.log("Error in onError: "+P.getErrorWithStackTrace(c))}return b.resolve(!1)}).then(function(a){return a?x.keyChain_.signPromise(G).then(function(){t.encryptedKeys.push(G);x.updateKeyRequest_(t,q,l);return b.resolve(!0)}):b.resolve(!1)})};na.prototype.getEKeyInfoSize_=function(){var a=0;for(key in this.eKeyInfo_)this.eKeyInfo_.hasOwnProperty(key)&&++a;return a};na.ExcludeEntry=function(a,b){this.component_=a;
this.anyFollowsComponent_=b};na.getExcludeEntries=function(a){for(var b=[],g=0;g<a.size();++g)a.get(g)==Xa.ANY?0==b.length?b.push(new na.ExcludeEntry(new c.Component,!0)):b[b.length-1].anyFollowsComponent_=!0:b.push(new na.ExcludeEntry(a.get(g),!1));return b};na.setExcludeEntries=function(a,b){a.clear();for(var c=0;c<b.length;++c){var g=b[c];0==c&&0==g.component_.getValue().size()&&g.anyFollowsComponent_?a.appendAny():(a.appendComponent(g.component_),g.anyFollowsComponent_&&a.appendAny())}};na.findEntryBeforeOrAt=
function(a,b){for(var c=a.length-1;0<=c&&!(0>=a[c].component_.compare(b));)--c;return c};na.excludeAfter=function(a,b){var c=na.getExcludeEntries(a),g;g=na.findEntryBeforeOrAt(c,b);if(0>g)c.splice(0,0,new na.ExcludeEntry(b,!0)),g=0;else{var f=c[g];f.anyFollowsComponent_||(f.component_.equals(b)?f.anyFollowsComponent_=!0:(c.splice(g+1,0,new na.ExcludeEntry(b,!0)),g+=1))}g+=1;c.splice(g,c.length-g);na.setExcludeEntries(a,c)};na.excludeBefore=function(a,b){na.excludeRange(a,new c.Component,b)};na.excludeRange=
function(a,b,c){if(0<=b.compare(c)){if(0==b.compare(c))throw Error("excludeRange: from == to. To exclude a single component, sue excludeOne.");throw Error("excludeRange: from must be less than to. Invalid range: ["+b.toEscapedString()+", "+c.toEscapedString()+"]");}var g=na.getExcludeEntries(a),f=na.findEntryBeforeOrAt(g,b);if(0>f)g.splice(0,0,new na.ExcludeEntry(b,!0)),b=0;else{var l=g[f];l.anyFollowsComponent_?b=f:l.component_.equals(b)?(l.anyFollowsComponent_=!0,b=f):(g.splice(f+1,0,new na.ExcludeEntry(b,
!0)),b=f+1)}f=na.findEntryBeforeOrAt(g,c);l=g[f];f==b?g.splice(b+1,0,new na.ExcludeEntry(c,!1)):(l.anyFollowsComponent_?c=f+1:l.component_.equals(c)?c=f:(g.splice(f+1,0,new na.ExcludeEntry(c,!1)),c=f+1),b+=1,g.splice(b,c-b));na.setExcludeEntries(a,g)};na.START_TIME_STAMP_INDEX=-2;na.END_TIME_STAMP_INDEX=-1;na.NO_LINK=new Fb;var tb=a.Interval,Ja=function Bd(a,b,c,g,f,l){if("object"===typeof a&&a instanceof Bd)repetitiveInterval=a,this.startDate_=repetitiveInterval.startDate_,this.endDate_=repetitiveInterval.endDate_,
this.intervalStartHour_=repetitiveInterval.intervalStartHour_,this.intervalEndHour_=repetitiveInterval.intervalEndHour_,this.nRepeats_=repetitiveInterval.nRepeats_,this.repeatUnit_=repetitiveInterval.repeatUnit_;else if("number"===typeof a){void 0==f&&(f=0);void 0==l&&(l=Bd.RepeatUnit.NONE);this.startDate_=Bd.toDateOnlyMilliseconds_(a);this.endDate_=Bd.toDateOnlyMilliseconds_(b);this.intervalStartHour_=Math.round(c);this.intervalEndHour_=Math.round(g);this.nRepeats_=Math.round(f);this.repeatUnit_=
l;if(!(this.intervalStartHour_<this.intervalEndHour_))throw Error("ReptitiveInterval: startHour must be less than endHour");if(!(this.startDate_<=this.endDate_))throw Error("ReptitiveInterval: startDate must be earlier than or same as endDate");if(!(0<=this.intervalStartHour_))throw Error("ReptitiveInterval: intervalStartHour must be non-negative");if(!(1<=this.intervalEndHour_&&24>=this.intervalEndHour_))throw Error("ReptitiveInterval: intervalEndHour must be from 1 to 24");if(this.repeatUnit_==
Bd.RepeatUnit.NONE&&this.startDate_!=this.endDate_)throw Error("ReptitiveInterval: With RepeatUnit.NONE, startDate must equal endDate");}else this.startDate_=-Number.MAX_VALUE,this.endDate_=-Number.MAX_VALUE,this.intervalStartHour_=0,this.intervalEndHour_=24,this.nRepeats_=0,this.repeatUnit_=Bd.RepeatUnit.NONE};s.RepetitiveInterval=Ja;Ja.RepeatUnit={NONE:0,DAY:1,MONTH:2,YEAR:3};Ja.prototype.getInterval=function(a){var b,c;this.hasIntervalOnDate_(a)?(b=Ja.toDateOnlyMilliseconds_(a)+this.intervalStartHour_*
Ja.MILLISECONDS_IN_HOUR,c=Ja.toDateOnlyMilliseconds_(a)+this.intervalEndHour_*Ja.MILLISECONDS_IN_HOUR,a<b?(c=b,b=Ja.toDateOnlyMilliseconds_(a),a=!1):a>c?(b=c,c=Ja.toDateOnlyMilliseconds_(a)+Ja.MILLISECONDS_IN_DAY,a=!1):a=!0):(b=Ja.toDateOnlyMilliseconds_(a),c=Ja.toDateOnlyMilliseconds_(a)+24*Ja.MILLISECONDS_IN_HOUR,a=!1);return{isPositive:a,interval:new tb(b,c)}};Ja.prototype.compare=function(a){return this.startDate_<a.startDate_?-1:this.startDate_>a.startDate_?1:this.endDate_<a.endDate_?-1:this.endDate_>
a.endDate_?1:this.intervalStartHour_<a.intervalStartHour_?-1:this.intervalStartHour_>a.intervalStartHour_?1:this.intervalEndHour_<a.intervalEndHour_?-1:this.intervalEndHour_>a.intervalEndHour_?1:this.nRepeats_<a.nRepeats_?-1:this.nRepeats_>a.nRepeats_?1:this.repeatUnit_<a.repeatUnit_?-1:this.repeatUnit_>a.repeatUnit_?1:0};Ja.prototype.getStartDate=function(){return this.startDate_};Ja.prototype.getEndDate=function(){return this.endDate_};Ja.prototype.getIntervalStartHour=function(){return this.intervalStartHour_};
Ja.prototype.getIntervalEndHour=function(){return this.intervalEndHour_};Ja.prototype.getNRepeats=function(){return this.nRepeats_};Ja.prototype.getRepeatUnit=function(){return this.repeatUnit_};Ja.prototype.hasIntervalOnDate_=function(a){a=Ja.toDateOnlyMilliseconds_(a);if(a<this.startDate_||a>this.endDate_)return!1;if(this.repeatUnit_==Ja.RepeatUnit.NONE)return!0;if(this.repeatUnit_==Ja.RepeatUnit.DAY){if(0==(a-this.startDate_)/Ja.MILLISECONDS_IN_DAY%this.nRepeats_)return!0}else{a=new Date(a);var b=
new Date(this.startDate_);if(this.repeatUnit_==Ja.RepeatUnit.MONTH&&a.getUTCDate()==b.getUTCDate()){if(0==(12*(a.getUTCFullYear()-b.getUTCFullYear())+a.getUTCMonth()-b.getUTCMonth())%this.nRepeats_)return!0}else if(this.repeatUnit_==Ja.RepeatUnit.YEAR&&a.getUTCDate()==b.getUTCDate()&&a.getUTCMonth()==b.getUTCMonth()&&0==(a.getUTCFullYear()-b.getUTCFullYear())%this.nRepeats_)return!0}return!1};Ja.toDateOnlyMilliseconds_=function(a){a=Math.round(a);return a-=a%Ja.MILLISECONDS_IN_DAY};Ja.MILLISECONDS_IN_HOUR=
36E5;Ja.MILLISECONDS_IN_DAY=864E5;tb=a.Interval;Ja=a.RepetitiveInterval;q=a.Tlv;sa=a.TlvEncoder;pa=a.TlvDecoder;m=a.Blob;ja=function Md(a){"object"===typeof a&&a instanceof Md?(this.whiteIntervalList_=a.whiteIntervalList_.slice(0),this.blackIntervalList_=a.blackIntervalList_.slice(0)):(this.whiteIntervalList_=[],this.blackIntervalList_=[])};s.Schedule=ja;ja.prototype.addWhiteInterval=function(a){ja.sortedSetAdd_(this.whiteIntervalList_,a);return this};ja.prototype.addBlackInterval=function(a){ja.sortedSetAdd_(this.blackIntervalList_,
a);return this};ja.prototype.getCoveringInterval=function(a){var b=new tb(!0),c=new tb(!0),g=new tb,f=new tb;ja.calculateIntervalResult_(this.blackIntervalList_,a,b,g);if(!b.isEmpty())return{isPositive:!1,interval:b};ja.calculateIntervalResult_(this.whiteIntervalList_,a,c,f);return c.isEmpty()&&!f.isValid()?(a=Ja.toDateOnlyMilliseconds_(a),{isPositive:!1,interval:new tb(a,a+Ja.MILLISECONDS_IN_DAY)}):c.isEmpty()?{isPositive:!1,interval:f}:g.isValid()?{isPositive:!0,interval:c.intersectWith(g)}:{isPositive:!0,
interval:c}};ja.prototype.wireEncode=function(){for(var a=new sa(256),b=a.getLength(),c=a.getLength(),g=this.blackIntervalList_.length-1;0<=g;g--)ja.encodeRepetitiveInterval_(this.blackIntervalList_[g],a);a.writeTypeAndLength(q.Encrypt_BlackIntervalList,a.getLength()-c);c=a.getLength();for(g=this.whiteIntervalList_.length-1;0<=g;g--)ja.encodeRepetitiveInterval_(this.whiteIntervalList_[g],a);a.writeTypeAndLength(q.Encrypt_WhiteIntervalList,a.getLength()-c);a.writeTypeAndLength(q.Encrypt_Schedule,a.getLength()-
b);return new m(a.getOutput(),!1)};ja.prototype.wireDecode=function(a){a="object"===typeof a&&a instanceof m?a.buf():a;a=new pa(a);var b=a.readNestedTlvsStart(q.Encrypt_Schedule);this.whiteIntervalList_=[];for(var c=a.readNestedTlvsStart(q.Encrypt_WhiteIntervalList);a.getOffset()<c;)ja.sortedSetAdd_(this.whiteIntervalList_,ja.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);this.blackIntervalList_=[];for(c=a.readNestedTlvsStart(q.Encrypt_BlackIntervalList);a.getOffset()<c;)ja.sortedSetAdd_(this.blackIntervalList_,
ja.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);a.finishNestedTlvs(b)};ja.sortedSetAdd_=function(a,b){for(var c=0;c<a.length;){var g=a[c].compare(b);if(0==g)return;if(!(0>g))break;++c}a.splice(c,0,b)};ja.encodeRepetitiveInterval_=function(a,b){var c=b.getLength();b.writeNonNegativeIntegerTlv(q.Encrypt_RepeatUnit,a.getRepeatUnit());b.writeNonNegativeIntegerTlv(q.Encrypt_NRepeats,a.getNRepeats());b.writeNonNegativeIntegerTlv(q.Encrypt_IntervalEndHour,a.getIntervalEndHour());b.writeNonNegativeIntegerTlv(q.Encrypt_IntervalStartHour,
a.getIntervalStartHour());b.writeBlobTlv(q.Encrypt_EndDate,(new m(ja.toIsoString(a.getEndDate()))).buf());b.writeBlobTlv(q.Encrypt_StartDate,(new m(ja.toIsoString(a.getStartDate()))).buf());b.writeTypeAndLength(q.Encrypt_RepetitiveInterval,b.getLength()-c)};ja.decodeRepetitiveInterval_=function(a){var b=a.readNestedTlvsStart(q.Encrypt_RepetitiveInterval),c=ja.fromIsoString((new m(a.readBlobTlv(q.Encrypt_StartDate),!0)).toString()),g=ja.fromIsoString((new m(a.readBlobTlv(q.Encrypt_EndDate),!0)).toString()),
f=a.readNonNegativeIntegerTlv(q.Encrypt_IntervalStartHour),l=a.readNonNegativeIntegerTlv(q.Encrypt_IntervalEndHour),t=a.readNonNegativeIntegerTlv(q.Encrypt_NRepeats),s=a.readNonNegativeIntegerTlv(q.Encrypt_RepeatUnit);a.finishNestedTlvs(b);return new Ja(c,g,f,l,t,s)};ja.calculateIntervalResult_=function(a,b,c,g){for(var f=0;f<a.length;++f){var l=a[f].getInterval(b),m=l.interval;!0==l.isPositive?c.unionWith(m):g.isValid()?g.intersectWith(m):g.set(m)}};ja.toIsoString=function(a){a=new Date(Math.round(a));
return a.getUTCFullYear()+ja.to2DigitString(a.getUTCMonth()+1)+ja.to2DigitString(a.getUTCDate())+"T"+ja.to2DigitString(a.getUTCHours())+ja.to2DigitString(a.getUTCMinutes())+ja.to2DigitString(a.getUTCSeconds())};ja.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};ja.fromIsoString=function(a){if(15!=a.length||"T"!=a.substr(8,1))throw Error("fromIsoString: Format is not the expected yyyymmddThhmmss");return Date.UTC(parseInt(a.substr(0,4)),parseInt(a.substr(4,2)-1),parseInt(a.substr(6,
2)),parseInt(a.substr(9,2)),parseInt(a.substr(11,2)),parseInt(a.substr(13,2)))};new qd;new jb;new Ic;var vb=a.DigestTree,E=a.Interest,S=a.Data,c=a.Name,m=a.Blob,Ta=a.MemoryContentCache,Ie=a.SyncStateProto,P=a.NdnCommon,La=function rc(b,c,g,f,l,m,q,t,s,G){this.onReceivedSyncState=b;this.onInitialized=c;this.applicationDataPrefixUri=g.toUri();this.applicationBroadcastPrefix=f;this.session=l;this.face=m;this.keyChain=q;this.certificateName=t;this.sync_lifetime=s;this.usrseq=-1;this.digest_tree=new vb;
this.contentCache=new Ta(m);this.digest_log=[];this.digest_log.push(new rc.DigestLogEntry("00",[]));this.contentCache.registerPrefix(this.applicationBroadcastPrefix,G,this.onInterest.bind(this));this.enabled=!0;b=new E(this.applicationBroadcastPrefix);b.getName().append("00");b.setInterestLifetimeMilliseconds(1E3);var x;try{x=dcodeIO.ProtoBuf.newBuilder().import(Ie).build("Sync")}catch(Q){x=a.newBuilder().import(Ie).build("Sync")}this.SyncStateMsg=x.SyncStateMsg;this.SyncState=x.SyncState;this.face.expressInterest(b,
this.onData.bind(this),this.initialTimeOut.bind(this))};s.ChronoSync2013=La;La.prototype.getProducerPrefixes=function(){for(var a=[],b=0;b<this.digest_tree.digestnode.length;++b){var c=this.digest_tree.get(b);a.push(new La.PrefixAndSessionNo(c.getDataPrefix(),c.getSessionNo()))}return a};La.prototype.getProducerSequenceNo=function(a,b){var c=this.digest_tree.find(a,b);return 0>c?-1:this.digest_tree.get(c).getSequenceNo()};La.prototype.publishNextSequenceNo=function(a){a=a instanceof m?a:new m(a,!0);
this.usrseq++;var b={name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}};!a.isNull()&&0<a.size()&&(b.application_info=a.buf());a=[new this.SyncState(b)];b=new this.SyncStateMsg({ss:a});this.broadcastSyncState(this.digest_tree.getRoot(),b);this.update(a)||console.log("Warning: ChronoSync: update did not create a new digest log entry");a=new E(this.applicationBroadcastPrefix);a.getName().append(this.digest_tree.getRoot());a.setInterestLifetimeMilliseconds(this.sync_lifetime);
this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};La.prototype.getSequenceNo=function(){return this.usrseq};La.DigestLogEntry=function(a,b){this.digest=a;this.data=b};La.DigestLogEntry.prototype.getDigest=function(){return this.digest};La.DigestLogEntry.prototype.getData=function(){return this.data};La.prototype.shutdown=function(){this.enabled=!1;this.contentCache.unregisterAll()};La.SyncState=function(a,b,c,g){this.dataPrefixUri_=a;this.sessionNo_=b;this.sequenceNo_=
c;this.applicationInfo_=g};La.SyncState.prototype.getDataPrefix=function(){return this.dataPrefixUri_};La.SyncState.prototype.getSessionNo=function(){return this.sessionNo_};La.SyncState.prototype.getSequenceNo=function(){return this.sequenceNo_};La.SyncState.prototype.getApplicationInfo=function(){return this.applicationInfo_};La.PrefixAndSessionNo=function(a,b){this.dataPrefixUri_=a;this.sessionNo_=b};La.PrefixAndSessionNo.prototype.getDataPrefix=function(){return this.dataPrefixUri_};La.PrefixAndSessionNo.prototype.getSessionNo=
function(){return this.sessionNo_};La.prototype.broadcastSyncState=function(a,b){var c=new Uint8Array(b.toArrayBuffer()),g=new S(this.applicationBroadcastPrefix);g.getName().append(a);g.setContent(new m(c,!1));var f=this;this.keyChain.sign(g,this.certificateName,function(){f.contentCache.add(g)})};La.prototype.update=function(a){for(var b=0;b<a.length;b++)0==a[b].type&&this.digest_tree.update(a[b].name,a[b].seqno.session,a[b].seqno.seq)&&this.applicationDataPrefixUri==a[b].name&&(this.usrseq=a[b].seqno.seq);
return-1==this.logfind(this.digest_tree.getRoot())?(a=new La.DigestLogEntry(this.digest_tree.getRoot(),a),this.digest_log.push(a),!0):!1};La.prototype.logfind=function(a){for(var b=0;b<this.digest_log.length;b++)if(a==this.digest_log[b].digest)return b;return-1};La.prototype.onInterest=function(a,b,g,f,l){this.enabled&&(a=b.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString(),b.getName().size()==this.applicationBroadcastPrefix.size()+2&&(a=b.getName().get(this.applicationBroadcastPrefix.size()+
1).toEscapedString()),b.getName().size()==this.applicationBroadcastPrefix.size()+2||"00"==a?this.processRecoveryInst(b,a,g):(this.contentCache.storePendingInterest(b,g),a!=this.digest_tree.getRoot()&&(b=this.logfind(a),-1==b?(b=new E(new c("/local/timeout")),b.setInterestLifetimeMilliseconds(2E3),this.face.expressInterest(b,this.dummyOnData,this.judgeRecovery.bind(this,b,a,g))):this.processSyncInst(b,a,g))))};La.prototype.onData=function(a,b){if(this.enabled){var g=new Uint8Array(b.getContent().size());
g.set(b.getContent().buf());var g=this.SyncStateMsg.decode(g.buffer).ss,l=!1;"00"==this.digest_tree.getRoot()?(l=!0,this.initialOndata(g)):(this.update(g),l=a.getName().size()==this.applicationBroadcastPrefix.size()+2?!0:!1);for(var q=[],t=0;t<g.length;t++)if(0==g[t].type){var s;g[t].application_info?(s=g[t].application_info.toBinary(),s=0<s.length?new m(new f(s,"binary"),!1):new m):s=new m;q.push(new La.SyncState(g[t].name,g[t].seqno.session,g[t].seqno.seq,s))}try{this.onReceivedSyncState(q,l)}catch(G){console.log("Error in onReceivedSyncState: "+
P.getErrorWithStackTrace(G))}g=new c(this.applicationBroadcastPrefix);g.append(this.digest_tree.getRoot());a=new E(g);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};La.prototype.initialTimeOut=function(a){if(this.enabled){console.log("no other people");this.usrseq++;try{this.onInitialized()}catch(b){console.log("Error in onInitialized: "+P.getErrorWithStackTrace(b))}a=[new this.SyncState({name:this.applicationDataPrefixUri,
type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})];this.update(a);a=new c(this.applicationBroadcastPrefix);a.append(this.digest_tree.getRoot());a=new E(a);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};La.prototype.processRecoveryInst=function(a,b,c){if(-1!=this.logfind(b)){b=[];for(var g=0;g<this.digest_tree.digestnode.length;g++)b[g]=new this.SyncState({name:this.digest_tree.digestnode[g].getDataPrefix(),
type:"UPDATE",seqno:{seq:this.digest_tree.digestnode[g].getSequenceNo(),session:this.digest_tree.digestnode[g].getSessionNo()}});if(0!=b.length){b=new this.SyncStateMsg({ss:b});b=new Uint8Array(b.toArrayBuffer());var f=new S(a.getName());f.setContent(new m(b,!1));"00"==a.getName().get(-1).toEscapedString()&&f.getMetaInfo().setFreshnessPeriod(1E3);this.keyChain.sign(f,this.certificateName,function(){try{c.putData(f)}catch(a){console.log(a.toString())}})}}};La.prototype.processSyncInst=function(a,b,
g){for(var f=[],l=[],q=[],t=[],s=a+1;s<this.digest_log.length;s++)for(var G=this.digest_log[s].getData(),x=0;x<G.length;x++)0==G[x].type&&-1!=this.digest_tree.find(G[x].name,G[x].seqno.session)&&(a=l.indexOf(G[x].name),-1==a?(l.push(G[x].name),q.push(G[x].seqno.seq),t.push(G[x].seqno.session)):(q[a]=G[x].seqno.seq,t[a]=G[x].seqno.session));for(x=0;x<l.length;x++)f[x]=new this.SyncState({name:l[x],type:"UPDATE",seqno:{seq:q[x],session:t[x]}});if(0!=f.length){f=new this.SyncStateMsg({ss:f});f=new Uint8Array(f.toArrayBuffer());
a=new c(this.prefix);a.append(this.chatroom).append(b);var Q=new S(a);Q.setContent(new m(f,!1));this.keyChain.sign(Q,this.certificateName,function(){try{g.putData(Q)}catch(a){console.log(a.toString())}})}};La.prototype.sendRecovery=function(a){var b=new c(this.applicationBroadcastPrefix);b.append("recovery").append(a);a=new E(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};La.prototype.judgeRecovery=function(a,
b,c){a=this.logfind(b);-1!=a?b!=this.digest_tree.root&&this.processSyncInst(a,b,c):this.sendRecovery(b)};La.prototype.syncTimeout=function(a){if(this.enabled&&a.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString()==this.digest_tree.root){var b=new c(a.getName()),b=new E(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(b,this.onData.bind(this),this.syncTimeout.bind(this))}};La.prototype.initialOndata=function(a){this.update(a);for(var b=this.digest_tree.getRoot(),
c=0;c<a.length;c++)if(a[c].name==this.applicationDataPrefixUri&&a[c].seqno.session==this.session){var g=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:a[c].seqno.seq+1,session:this.session}})];if(this.update(g)){g=new La.DigestLogEntry(this.digest_tree.getRoot(),g);this.digest_log.push(g);try{this.onInitialized()}catch(f){console.log("Error in onInitialized: "+P.getErrorWithStackTrace(f))}}}g=0<=this.usrseq?new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",
seqno:{seq:this.usrseq,session:this.session}}):new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:0,session:this.session}});a=new this.SyncStateMsg({ss:g});this.broadcastSyncState(b,a);if(-1==this.digest_tree.find(this.applicationDataPrefixUri,this.session)&&(this.usrseq++,a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})],this.update(a)))try{this.onInitialized()}catch(l){console.log("Error in onInitialized: "+
P.getErrorWithStackTrace(l))}};La.prototype.dummyOnData=function(a,b){console.log("*** dummyOnData called. ***")};X=a;vb=function(){this.root="00";this.digestnode=[]};s.DigestTree=vb;vb.Node=function(a,b,c){this.dataPrefix=a;this.seqno_session=b;this.seqno_seq=c;this.recomputeDigest()};vb.Node.prototype.getDataPrefix=function(){return this.dataPrefix};vb.Node.prototype.getSessionNo=function(){return this.seqno_session};vb.Node.prototype.getSequenceNo=function(){return this.seqno_seq};vb.Node.prototype.getDigest=
function(){return this.digest};vb.Node.prototype.setSequenceNo=function(a){this.seqno_seq=a;this.recomputeDigest()};vb.Node.prototype.Int32ToBuffer=function(a){for(var b=new f(4),c=0;4>c;c++)b[c]=a%256,a=Math.floor(a/256);return b};vb.Node.prototype.recomputeDigest=function(){var a=X.createHash("sha256");a.update(this.Int32ToBuffer(this.seqno_session));a.update(this.Int32ToBuffer(this.seqno_seq));var a=a.digest(),b=X.createHash("sha256");b.update(this.dataPrefix);var b=b.digest(),c=X.createHash("sha256");
c.update(b);c.update(a);this.digest=c.digest("hex")};vb.Node.Compare=function(a,b){return a.dataPrefix!=b.dataPrefix?a.dataPrefix<b.dataPrefix:a.seqno_session<b.seqno_session};vb.prototype.update=function(a,b,c){var g=this.find(a,b);if(0<=g)if(this.digestnode[g].getSequenceNo()<c)this.digestnode[g].setSequenceNo(c);else return!1;else a=new vb.Node(a,b,c),this.digestnode.push(a),this.digestnode.sort(this.sortNodes);this.recomputeRoot();return!0};vb.prototype.sortNodes=function(){for(var a,b=this.digestnode.length;0<
b;b--)for(var c=0;c<b-1;c++)this.digestnode[c].getDataPrefix()>this.digestnode[c+1].getDataPrefix()&&(a=this.digestnode[c],this.digestnode[c]=this.digestnode[c+1],this.digestnode[c+1]=a)};vb.prototype.sortNodes=function(a,b){return a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()==b.getSessionNo()?0:a.getDataPrefix()>b.getDataPrefix()||a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()>b.getSessionNo()?1:-1};vb.prototype.find=function(a,b){for(var c=0;c<this.digestnode.length;++c)if(this.digestnode[c].getDataPrefix()==
a&&this.digestnode[c].getSessionNo()==b)return c;return-1};vb.prototype.size=function(){return this.digestnode.size()};vb.prototype.get=function(a){return this.digestnode[a]};vb.prototype.getRoot=function(){return this.root};vb.prototype.recomputeRoot=function(){for(var a=X.createHash("sha256"),b=0;b<this.digestnode.length;b++)a.update(new f(this.digestnode[b].digest,"hex"));this.root=a.digest("hex")};Ie={"package":"Sync",messages:[{name:"SyncState",fields:[{rule:"required",type:"string",name:"name",
id:1,options:{}},{rule:"required",type:"ActionType",name:"type",id:2,options:{}},{rule:"optional",type:"SeqNo",name:"seqno",id:3,options:{}},{rule:"optional",type:"bytes",name:"application_info",id:4,options:{}}],enums:[{name:"ActionType",values:[{name:"UPDATE",id:0},{name:"DELETE",id:1},{name:"OTHER",id:2}],options:{}}],messages:[{name:"SeqNo",fields:[{rule:"required",type:"uint32",name:"seq",id:1,options:{}},{rule:"required",type:"uint32",name:"session",id:2,options:{}}],enums:[],messages:[],options:{}}],
options:{}},{name:"SyncStateMsg",fields:[{rule:"repeated",type:"SyncState",name:"ss",id:1,options:{}}],enums:[],messages:[],options:{}}],enums:[],imports:[],options:{}};s.SyncStateProto=Ie;var t=a.WireFormat,kd=a.CommandInterestPreparer,be=function(){kd.call(this)};be.prototype=new kd;be.prototype.name="CommandInterestGenerator";s.CommandInterestGenerator=be;be.prototype.generate=function(a,b,c,g,f){f="function"===typeof g?g:f;g="function"!==typeof g&&g?g:t.getDefaultWireFormat();this.prepareCommandInterestName(a,
g);b.sign(a,c,g,function(){(null==a.getInterestLifetimeMilliseconds()||0>a.getInterestLifetimeMilliseconds())&&a.setInterestLifetimeMilliseconds(1E3);f&&f()})};var g=a.Log.LOG,xc=function(){this.table_=[]};s.InterestFilterTable=xc;xc.Entry=function(a,b,c,g){this.interestFilterId_=a;this.filter_=b;this.onInterest_=c;this.face_=g};xc.Entry.prototype.getInterestFilterId=function(){return this.interestFilterId_};xc.Entry.prototype.getFilter=function(){return this.filter_};xc.Entry.prototype.getOnInterest=
function(){return this.onInterest_};xc.Entry.prototype.getFace=function(){return this.face_};xc.prototype.setInterestFilter=function(a,b,c,g){this.table_.push(new xc.Entry(a,b,c,g))};xc.prototype.getMatchedFilters=function(a,b){for(var c=0;c<this.table_.length;++c){var g=this.table_[c];g.getFilter().doesMatch(a.getName())&&b.push(g)}};xc.prototype.unsetInterestFilter=function(a){for(var b=0,c=this.table_.length-1;0<=c;--c)this.table_[c].getInterestFilterId()==a&&(++b,this.table_.splice(c,1));0===
b&&0<g&&console.log("unsetInterestFilter: Didn't find interestFilterId "+a)};var P=a.NdnCommon,g=a.Log.LOG,Tb=function(){this.table_=[];this.removeRequests_=[]};s.PendingInterestTable=Tb;Tb.Entry=function(a,b,c,g,f){this.pendingInterestId_=a;this.interest_=b;this.onData_=c;this.onTimeout_=g;this.onNetworkNack_=f;this.timerId_=-1};Tb.Entry.prototype.getPendingInterestId=function(){return this.pendingInterestId_};Tb.Entry.prototype.getInterest=function(){return this.interest_};Tb.Entry.prototype.getOnData=
function(){return this.onData_};Tb.Entry.prototype.getOnNetworkNack=function(){return this.onNetworkNack_};Tb.Entry.prototype.callTimeout=function(){if(this.onTimeout_)try{this.onTimeout_(this.interest_)}catch(a){console.log("Error in onTimeout: "+P.getErrorWithStackTrace(a))}};Tb.Entry.prototype.setTimeout=function(a,b){-1===this.timerId_&&(this.timerId_=setTimeout(a,b))};Tb.Entry.prototype.clearTimeout=function(){-1!==this.timerId_&&(clearTimeout(this.timerId_),this.timerId_=-1)};Tb.prototype.add=
function(a,b,c,f,l){var m=this.removeRequests_.indexOf(a);if(0<=m)return this.removeRequests_.splice(m,1),null;var q=new Tb.Entry(a,b,c,f,l);this.table_.push(q);a=b.getInterestLifetimeMilliseconds()||4E3;var t=this;q.setTimeout(function(){1<g&&console.log("Interest time out: "+b.getName().toUri());var a=t.table_.indexOf(q);0<=a&&t.table_.splice(a,1);q.callTimeout()},a);return q};Tb.prototype.extractEntriesForExpressedInterest=function(a,b){for(var c=this.table_.length-1;0<=c;--c){var g=this.table_[c];
g.getInterest().matchesData(a)&&(g.clearTimeout(),b.push(g),this.table_.splice(c,1))}};Tb.prototype.extractEntriesForNackInterest=function(a,b){for(var c=a.wireEncode(),g=this.table_.length-1;0<=g;--g){var f=this.table_[g];null!=f.getOnNetworkNack()&&f.getInterest().wireEncode().equals(c)&&(f.clearTimeout(),b.push(f),this.table_.splice(g,1))}};Tb.prototype.removePendingInterest=function(a){if(null!=a){for(var b=0,c=this.table_.length-1;0<=c;--c){var f=this.table_[c];f.getPendingInterestId()==a&&(f.clearTimeout(),
this.table_.splice(c,1),++b)}0===b&&0<g&&console.log("removePendingInterest: Didn't find pendingInterestId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)}};var g=a.Log.LOG,Zc=function(a){this.interestFilterTable_=a;this.table_=[];this.removeRequests_=[]};s.RegisteredPrefixTable=Zc;Zc.prototype.add=function(a,b,c){var g=this.removeRequests_.indexOf(a);if(0<=g)return this.removeRequests_.splice(g,1),!1;this.table_.push(new Zc._Entry(a,b,c));return!0};Zc.prototype.removeRegisteredPrefix=
function(a){for(var b=0,c=this.table_.length-1;0<=c;--c){var f=this.table_[c];f.getRegisteredPrefixId()==a&&(++b,0<f.getRelatedInterestFilterId()&&this.interestFilterTable_.unsetInterestFilter(f.getRelatedInterestFilterId()),this.table_.splice(c,1))}0===b&&0<g&&console.log("removeRegisteredPrefix: Didn't find registeredPrefixId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)};Zc._Entry=function(a,b,c){this.registeredPrefixId_=a;this.prefix_=b;this.relatedInterestFilterId_=
c};Zc._Entry.prototype.getRegisteredPrefixId=function(){return this.registeredPrefixId_};Zc._Entry.prototype.getPrefix=function(){return this.prefix_};Zc._Entry.prototype.getRelatedInterestFilterId=function(){return this.relatedInterestFilterId_};id=function(){this.congestionMark_=0};s.CongestionMark=id;id.prototype.getCongestionMark=function(){return this.congestionMark_};id.prototype.setCongestionMark=function(a){this.congestionMark_=a};id.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=
a.getHeaderField(b);if(c instanceof id)return c}return null};Dc=function(){this.faceId_=null};s.IncomingFaceId=Dc;Dc.prototype.getFaceId=function(){return this.faceId_};Dc.prototype.setFaceId=function(a){this.faceId_=a};Dc.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);if(c instanceof Dc)return c}return null};var m=a.Blob,rd=function(){this.headerFields_=[];this.fragmentWireEncoding_=new m};s.LpPacket=rd;rd.prototype.getFragmentWireEncoding=function(){return this.fragmentWireEncoding_};
rd.prototype.countHeaderFields=function(){return this.headerFields_.length};rd.prototype.getHeaderField=function(a){return this.headerFields_[a]};rd.prototype.clear=function(){this.headerFields_=[];this.fragmentWireEncoding_=new m};rd.prototype.setFragmentWireEncoding=function(a){this.fragmentWireEncoding_="object"===typeof a&&a instanceof m?a:new m(a)};rd.prototype.addHeaderField=function(a){this.headerFields_.push(a)};var M=a.DataUtils,c=a.Name,E=a.Interest,S=a.Data,Wa=a.ControlParameters,vc=a.ControlResponse,
Bc=a.InterestFilter,t=a.WireFormat,hb=a.TlvWireFormat,q=a.Tlv,pa=a.TlvDecoder,sa=a.TlvEncoder,xa=a.RegistrationOptions,xb=a.Transport,Je=a.TcpTransport,Re=a.UnixTransport,be=a.CommandInterestGenerator,m=a.Blob,P=a.NdnCommon,cb=a.NetworkNack,rd=a.LpPacket,xc=a.InterestFilterTable,Tb=a.PendingInterestTable,Zc=a.RegisteredPrefixTable,Rb=a,g=a.Log.LOG;aa=function Bb(a,b){if(!Bb.supported)throw Error("The necessary JavaScript support is not available on this platform.");var f;if("object"==typeof a&&a instanceof
xb){if(this.getConnectionInfo=null,this.transport=a,this.connectionInfo=b||null,f={},null==this.connectionInfo&&this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name){var l=Bb.getUnixSocketFilePathForLocalhost();null!=l?this.connectionInfo=new Re.ConnectionInfo(l):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport");0<g&&console.log("Using "+this.connectionInfo.toString())}}else f=a||{},this.transport=(f.getTransport||
function(){return new Je})(),this.getConnectionInfo=f.getConnectionInfo||this.transport.defaultGetConnectionInfo,this.connectionInfo=f.connectionInfo||null,null==this.connectionInfo&&(l=void 0!==f.host?f.host:null,this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name?null!=l?this.connectionInfo=new Re.ConnectionInfo(l):null==this.getConnectionInfo&&(l=Bb.getUnixSocketFilePathForLocalhost(),null!=l?this.connectionInfo=new Re.ConnectionInfo(l):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport")):
null!=l&&(this.connectionInfo="undefined"!=typeof Lb?new Lb.ConnectionInfo(l,f.port||9696):new Je.ConnectionInfo(l,f.port||6363)));null==this.connectionInfo?this.host=this.host=null:(this.host=this.connectionInfo.host,this.host=this.connectionInfo.port);this.readyStatus=Bb.UNOPEN;this.onopen=f.onopen||function(){3<g&&console.log("Face connection established.")};this.onclose=f.onclose||function(){3<g&&console.log("Face connection closed.")};this.onConnectedCallbacks=[];this.commandKeyChain=null;this.commandCertificateName=
new c;this.commandInterestGenerator=new be;this.timeoutPrefix=new c("/local/timeout");this.pendingInterestTable_=new Tb;this.interestFilterTable_=new xc;this.registeredPrefixTable_=new Zc(this.interestFilterTable_);this.lastEntryId=0;this.interestLoopbackEnabled_=!1};s.Face=aa;aa.UNOPEN=0;aa.OPEN_REQUESTED=1;aa.OPENED=2;aa.CLOSED=3;Je.importFace(aa);aa.getUnixSocketFilePathForLocalhost=function(){var a="/var/run/nfd.sock";if(Rb.existsSync(a))return a;a="/tmp/.ndnd.sock";return Rb.existsSync(a)?a:
""};aa.getSupported=function(){try{(new f(1)).slice(0,1)}catch(a){return console.log("NDN not available: Buffer not supported. "+a),!1}return!0};aa.supported=aa.getSupported();aa.prototype.createRoute=function(a,b){this.connectionInfo=a instanceof xb.ConnectionInfo?a:new Je.ConnectionInfo(a,b);this.host=this.connectionInfo.host;this.host=this.connectionInfo.port};aa.prototype.close=function(){this.readyStatus==aa.OPENED&&(this.readyStatus=aa.CLOSED,this.transport.close())};aa.prototype.getNextEntryId=
function(){return++this.lastEntryId};aa.makeShuffledHostGetConnectionInfo=function(a,b,c){a=a.slice(0,a.length);M.shuffle(a);return function(){return 0==a.length?null:c(a.splice(0,1)[0],b)}};aa.prototype.setInterestLoopbackEnabled=function(a){this.interestLoopbackEnabled_=a};aa.prototype.expressInterest=function(a,b,c,g,f,l){var m;"object"===typeof a&&a instanceof E?m=new E(a):b&&"object"===typeof b&&b instanceof E?(m=new E(b),m.setName(a),b=c,c=g,g=f,f=l):(m=new E(a),m.setInterestLifetimeMilliseconds(4E3));
var q=b,s,G,x;s="function"===typeof c?c:function(){};G="function"===typeof g?g:null;x=c instanceof t?c:g instanceof t?g:f instanceof t?f:t.getDefaultWireFormat();var Q=this.getNextEntryId();m.setNonce(aa.nonceTemplate_);m.refreshNonce();if(null==this.connectionInfo)if(null==this.getConnectionInfo)console.log("ERROR: connectionInfo is NOT SET");else{var B=this;this.connectAndExecute(function(){B.reconnectAndExpressInterest(Q,m,q,s,G,x)})}else this.reconnectAndExpressInterest(Q,m,q,s,G,x);return Q};
aa.prototype.reconnectAndExpressInterest=function(a,b,c,g,f,l){var m=this;if(this.connectionInfo.equals(this.transport.connectionInfo)&&this.readyStatus!==aa.UNOPEN)if(this.readyStatus===aa.OPEN_REQUESTED)this.onConnectedCallbacks.push(function(){m.expressInterestHelper(a,b,c,g,f,l)});else if(this.readyStatus===aa.OPENED)this.expressInterestHelper(a,b,c,g,f,l);else throw Error("reconnectAndExpressInterest: unexpected connection is not opened");else this.readyStatus=aa.OPEN_REQUESTED,this.onConnectedCallbacks.push(function(){m.expressInterestHelper(a,
b,c,g,f,l)}),this.transport.connect(this.connectionInfo,this,function(){for(m.readyStatus=aa.OPENED;0<m.onConnectedCallbacks.length;)try{m.onConnectedCallbacks.shift()()}catch(a){console.log("Face.reconnectAndExpressInterest: ignoring exception from onConnectedCallbacks: "+a)}if(m.onopen)m.onopen()},function(){m.closeByTransport()})};aa.prototype.expressInterestHelper=function(a,b,c,g,f,l){if(null!=this.pendingInterestTable_.add(a,b,c,g,f)&&!this.timeoutPrefix.match(b.getName())){a=b.wireEncode(l);
if(a.size()>aa.getMaxNdnPacketSize())throw Error("The encoded interest size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a.buf());this.interestLoopbackEnabled_&&dispatchInterest(b)}};aa.prototype.removePendingInterest=function(a){this.pendingInterestTable_.removePendingInterest(a)};aa.prototype.setCommandSigningInfo=function(a,b){this.commandKeyChain=a;this.commandCertificateName=new c(b)};aa.prototype.setCommandCertificateName=function(a){this.commandCertificateName=new c(a)};
aa.prototype.makeCommandInterest=function(a,b,c){c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:t.getDefaultWireFormat();this.nodeMakeCommandInterest(a,this.commandKeyChain,this.commandCertificateName,b,c)};aa.prototype.nodeMakeCommandInterest=function(a,b,c,g,f){this.commandInterestGenerator.generate(a,b,c,g,f)};aa.prototype.registerPrefix=function(a,b,c,g,f,l){var m=g,q=f,s=l;g="function"===typeof m?m:null;f=m instanceof xa?m:q instanceof xa?q:new xa;l=m instanceof t?m:q instanceof t?
q:s instanceof t?s:t.getDefaultWireFormat();c||(c=function(){});var G=this.getNextEntryId(),x=this,m=function(){x.nfdRegisterPrefix(G,a,b,f,c,g,x.commandKeyChain,x.commandCertificateName,l)};null==this.connectionInfo?null==this.getConnectionInfo?console.log("ERROR: connectionInfo is NOT SET"):this.connectAndExecute(m):m();return G};aa.getMaxNdnPacketSize=function(){return P.MAX_NDN_PACKET_SIZE};aa.RegisterResponse=function(a,b,c,g,f,l){this.prefix=a;this.onRegisterFailed=b;this.onRegisterSuccess=
c;this.registeredPrefixId=g;this.parent=f;this.onInterest=l};aa.RegisterResponse.prototype.onData=function(a,b){var c=new vc;try{c.wireDecode(b.getContent(),hb.get())}catch(f){0<g&&console.log("Register prefix failed: Error decoding the NFD response: "+f);if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(l){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(l))}return}if(200!=c.getStatusCode()){if(0<g&&console.log("Register prefix failed: Expected NFD status code 200, got: "+
c.getStatusCode()),this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(m){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(m))}}else{if(0!=this.registeredPrefixId&&(c=0,null!=this.onInterest&&(c=this.parent.setInterestFilter(new Bc(this.prefix),this.onInterest)),!this.parent.registeredPrefixTable_.add(this.registeredPrefixId,this.prefix,c))){0<c&&this.parent.unsetInterestFilter(c);return}2<g&&console.log("Register prefix succeeded with the NFD forwarder for prefix "+
this.prefix.toUri());if(null!=this.onRegisterSuccess)try{this.onRegisterSuccess(this.prefix,this.registeredPrefixId)}catch(q){console.log("Error in onRegisterSuccess: "+P.getErrorWithStackTrace(q))}}};aa.RegisterResponse.prototype.onTimeout=function(a){2<g&&console.log("Timeout for NFD register prefix command.");if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(b){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(b))}};aa.prototype.nfdRegisterPrefix=function(a,
b,f,l,m,q,t,s,G){if(null==t)throw Error("registerPrefix: The command KeyChain has not been set. You must call setCommandSigningInfo.");if(0==s.size())throw Error("registerPrefix: The command certificate name has not been set. You must call setCommandSigningInfo.");var x=new Wa;x.setName(b);x.setForwardingFlags(l);null!=l.getOrigin()&&0<=l.getOrigin()&&(x.setOrigin(l.getOrigin()),x.getForwardingFlags().setOrigin(null));var Q=this;this.isLocal(function(g){var l=new E;l.setCanBePrefix(!0);g?(l.setName(new c("/localhost/nfd/rib/register")),
l.setInterestLifetimeMilliseconds(2E3)):(l.setName(new c("/localhop/nfd/rib/register")),l.setInterestLifetimeMilliseconds(4E3));l.getName().append(x.wireEncode(hb.get()));Q.nodeMakeCommandInterest(l,t,s,hb.get(),function(){var c=new aa.RegisterResponse(b,m,q,a,Q,f);Q.reconnectAndExpressInterest(null,l,c.onData.bind(c),c.onTimeout.bind(c),null,G)})},function(a){0<g&&console.log("Error in Transport.isLocal: "+a);if(m)try{m(b)}catch(c){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(c))}})};
aa.prototype.removeRegisteredPrefix=function(a){this.registeredPrefixTable_.removeRegisteredPrefix(a)};aa.prototype.setInterestFilter=function(a,b){var c=this.getNextEntryId();this.interestFilterTable_.setInterestFilter(c,new Bc(a),b,this);return c};aa.prototype.unsetInterestFilter=function(a){this.interestFilterTable_.unsetInterestFilter(a)};aa.prototype.putData=function(a,b){b=b||t.getDefaultWireFormat();if(!this.interestLoopbackEnabled_||!this.satisfyPendingInterests(a)){var c=a.wireEncode(b);
if(c.size()>aa.getMaxNdnPacketSize())throw Error("The encoded Data packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(c.buf())}};aa.prototype.putNack=function(a,b){var c=aa.encodeLpNack_(a,b);if(c.size()>aa.getMaxNdnPacketSize())throw Error("The encoded Nack packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(c.buf())};aa.prototype.send=function(a){if(a.length>aa.getMaxNdnPacketSize())throw Error("The encoded packet size exceeds the maximum limit getMaxNdnPacketSize()");
this.transport.send(a)};aa.prototype.isLocal=function(a,b){null==this.connectionInfo?a(!1):this.transport.isLocal(this.connectionInfo,a,b)};aa.prototype.onReceivedElement=function(a){3<g&&console.log("Complete element received. Length "+a.length+". Start decoding.");var b=null;a[0]==q.LpPacket_LpPacket&&(b=new rd,hb.get().decodeLpPacket(b,a,!1),a=b.getFragmentWireEncoding().buf());var c=null,f=null;if(a[0]==q.Interest||a[0]==q.Data){var l=new pa(a);l.peekType(q.Interest,a.length)?(c=new E,c.wireDecode(a,
hb.get()),null!=b&&c.setLpPacket(b)):l.peekType(q.Data,a.length)&&(f=new S,f.wireDecode(a,hb.get()),null!=b&&f.setLpPacket(b))}if(null!==b&&(b.setFragmentWireEncoding(new m),a=cb.getFirstHeader(b),null!=a)){if(null==c)return;f=[];this.pendingInterestTable_.extractEntriesForNackInterest(c,f);for(c=0;c<f.length;++c){b=f[c];try{b.getOnNetworkNack()(b.getInterest(),a)}catch(t){console.log("Error in onNetworkNack: "+P.getErrorWithStackTrace(t))}}return}null!==c?(3<g&&console.log("Interest packet received."),
this.dispatchInterest_(c)):null!==f&&(3<g&&console.log("Data packet received."),this.satisfyPendingInterests_(f))};aa.prototype.dispatchInterest_=function(a){var b=[];this.interestFilterTable_.getMatchedFilters(a,b);for(var c=0;c<b.length;++c){var f=b[c];3<g&&console.log("Found interest filter for "+a.getName().toUri());try{f.getOnInterest()(f.getFilter().getPrefix(),a,this,f.getInterestFilterId(),f.getFilter())}catch(l){console.log("Error in onInterest: "+P.getErrorWithStackTrace(l))}}};aa.prototype.satisfyPendingInterests_=
function(a){var b=!1,c=[];this.pendingInterestTable_.extractEntriesForExpressedInterest(a,c);for(var g=0;g<c.length;++g){var f=c[g],b=!0;try{f.getOnData()(f.getInterest(),a)}catch(l){console.log("Error in onData: "+P.getErrorWithStackTrace(l))}}return b};aa.prototype.connectAndExecute=function(a){var b=this.getConnectionInfo();if(null==b)console.log("ERROR: No more connectionInfo from getConnectionInfo"),this.host=this.host=this.connectionInfo=null;else if(b.equals(this.connectionInfo))console.log("ERROR: The host returned by getConnectionInfo is not alive: "+
this.connectionInfo.toString());else{this.connectionInfo=b;0<g&&console.log("connectAndExecute: trying host from getConnectionInfo: "+this.connectionInfo.toString());this.host=this.connectionInfo.host;this.host=this.connectionInfo.port;b=new E(new c("/"));b.setInterestLifetimeMilliseconds(4E3);var f=this,l=setTimeout(function(){0<g&&console.log("connectAndExecute: timeout waiting for host "+f.host);f.connectAndExecute(a)},3E3);this.reconnectAndExpressInterest(null,b,function(b,c){clearTimeout(l);
0<g&&console.log("connectAndExecute: connected to host "+f.host);a()},function(a){},null,t.getDefaultWireFormat())}};aa.prototype.closeByTransport=function(){this.readyStatus=aa.CLOSED;this.onclose()};aa.encodeLpNack_=function(a,b){var c=new sa(256),g=c.getLength();c.writeBlobTlv(q.LpPacket_Fragment,a.wireEncode(hb.get()).buf());var f;if(b.getReason()==cb.Reason.NONE||b.getReason()==cb.Reason.CONGESTION||b.getReason()==cb.Reason.DUPLICATE||b.getReason()==cb.Reason.NO_ROUTE)f=b.getReason();else if(b.getReason()==
cb.Reason.OTHER_CODE)f=b.getOtherReasonCode();else throw Error("unrecognized NetworkNack.getReason() value");var l=c.getLength();c.writeNonNegativeIntegerTlv(q.LpPacket_NackReason,f);c.writeTypeAndLength(q.LpPacket_Nack,c.getLength()-l);c.writeTypeAndLength(q.LpPacket_LpPacket,c.getLength()-g);return new m(c.getOutput(),!1)};aa.nonceTemplate_=new m(new f(4),!1);new aa(new xb,{equals:function(){return!0}});var Ke={};Object.keys(a).forEach(function(b){Ke[b]=oa[b];oa[b]=a[b]});a.noConflict=function(){Object.keys(Ke).forEach(function(b){oa[b]===
a[b]&&("undefined"==typeof Ke[b]?delete oa[b]:oa[b]=Ke[b])});return a};oa.ndn=a})(this);
(function(oa,w,K){function U(f,w){"object"!==typeof w&&(w=w());Object.keys(w).forEach(function(F){f[F]=w[F]});return f}function V(f){return{from:function(w){f.prototype=Object.create(w.prototype);f.prototype.constructor=f;return{extend:function(F){U(f.prototype,"object"!==typeof F?F(w.prototype):F)}}}}}function Y(f,w){return w(f)}function L(x,w){function F(a){this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null};this.stores({})}function fc(f,c,m,q){if(0===f){Object.keys(da).forEach(function(a){s(c,
a,da[a].primKey,da[a].indexes)});var t=M._createTransaction(b,ed,da);t.idbtrans=c;t.idbtrans.onerror=Sa(m,["populating database"]);t.on("error").subscribe(m);T.newPSD(function(){T.PSD.trans=t;try{M.on("populate").fire(t)}catch(a){q.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();m(a)}})}else{var x=[],g=Oc.filter(function(a){return a._cfg.version===f})[0];if(!g)throw new Na("Dexie specification of currently installed DB version is missing");da=M._dbSchema=g._cfg.dbschema;
var B=!1;Oc.filter(function(a){return a._cfg.version>f}).forEach(function(g){var f=da,q=g._cfg.dbschema;Nc(f,c);Nc(q,c);da=M._dbSchema=q;f=a(f,q);f.add.forEach(function(a){x.push(function(b,c){s(b,a[0],a[1].primKey,a[1].indexes);c()})});f.change.forEach(function(a){if(a.recreate)throw new Na("Not yet support for changing primary key");x.push(function(b,c){var g=b.objectStore(a.name);a.add.forEach(function(a){$b(g,a)});a.change.forEach(function(a){g.deleteIndex(a.name);$b(g,a)});a.del.forEach(function(a){g.deleteIndex(a)});
c()})});g._cfg.contentUpgrade&&x.push(function(a,c){B=!0;var f=M._createTransaction(b,[].slice.call(a.db.objectStoreNames,0),q);f.idbtrans=a;var t=0;f._promise=Y(f._promise,function(a){return function(b,g,f){function l(a){return function(){a.apply(this,arguments);0===--t&&c()}}++t;return a.call(this,b,function(a,b,c){arguments[0]=l(a);arguments[1]=l(b);g.apply(this,arguments)},f)}});a.onerror=Sa(m,["running upgrader function for version",g._cfg.version]);f.on("error").subscribe(m);g._cfg.contentUpgrade(f);
0===t&&c()});B&&(0<=navigator.userAgent.indexOf("Trident")||0<=navigator.userAgent.indexOf("MSIE"))||x.push(function(a,b){for(var c=0;c<a.db.objectStoreNames.length;++c){var g=a.db.objectStoreNames[c];null!==q[g]&&q[g]!==K||a.db.deleteObjectStore(g)}b()})});var Q=function(){try{x.length?x.shift()(c,Q):oa(da,c)}catch(a){q.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();m(a)}};Q()}}function a(a,b){var f={del:[],add:[],change:[]},m;for(m in a)b[m]||f.del.push(m);
for(m in b){var q=a[m],s=b[m];if(q){var g={name:m,def:b[m],recreate:!1,del:[],add:[],change:[]};if(q.primKey.src!==s.primKey.src)g.recreate=!0,f.change.push(g);else{var q=q.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),s=s.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),x;for(x in q)s[x]||g.del.push(x);for(x in s){var Q=q[x],l=s[x];Q?Q.src!==l.src&&g.change.push(l):g.add.push(l)}(g.recreate||0<g.del.length||0<g.add.length||0<g.change.length)&&f.change.push(g)}}else f.add.push([m,s])}return f}
function s(a,b,f,m){var q=a.db.createObjectStore(b,f.keyPath?{keyPath:f.keyPath,autoIncrement:f.auto}:{autoIncrement:f.auto});m.forEach(function(a){$b(q,a)});return q}function oa(a,b){Object.keys(a).forEach(function(f){b.db.objectStoreNames.contains(f)||s(b,f,a[f].primKey,a[f].indexes)})}function $b(a,b){a.createIndex(b.name,b.keyPath,{unique:b.unique,multiEntry:b.multi})}function Kd(a,b){throw new Na("Table "+b[0]+" not part of transaction. Original Scope Function Source: "+L.Promise.PSD.trans.scopeFunc.toString());
}function Yb(a,b,f,m){this.name=a;this.schema=f;this.hook=P[a]?P[a].hook:td(null,{creating:[Td,C],reading:[sd,Sd],updating:[se,C],deleting:[ve,C]});this._tpf=b;this._collClass=m||Db}function Fd(a,b,f,m){Yb.call(this,a,b,f,m||Ra)}function Gd(a,b,f,m){function q(a,b,c,g){return s._promise(a,c,g)}var s=this;this.db=M;this.mode=a;this.storeNames=b;this.idbtrans=null;this.on=td(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._psd=null;this.active=!0;this._dbschema=f;m&&(this.parent=
m);this._tpf=q;this.tables=Object.create(ud);for(m=b.length-1;-1!==m;--m){var g=b[m],x=M._tableFactory(a,f[g],q);this.tables[g]=x;this[g]||(this[g]=x)}}function zc(a,b,f){this._ctx={table:a,index:":id"===b?null:b,collClass:a._collClass,or:f}}function Db(a,b){var f=null,m=null;if(b)try{f=b()}catch(q){m=q}var s=a._ctx;this._ctx={table:s.table,index:s.index,isPrimKey:!s.index||s.table.schema.primKey.keyPath&&s.index===s.table.schema.primKey.name,range:f,op:"openCursor",dir:"next",unique:"",algorithm:null,
filter:null,isMatch:null,offset:0,limit:Infinity,error:m,or:s.or}}function Ra(){Db.apply(this,arguments)}function cd(a,b){return a._cfg.version-b._cfg.version}function Mc(a,b,f,m,q,s){f.forEach(function(g){var f=M._tableFactory(m,q[g],b);a.forEach(function(a){a[g]||(s?Object.defineProperty(a,g,{configurable:!0,enumerable:!0,get:function(){var a=T.PSD&&T.PSD.trans;return a&&a.db===M?a.tables[g]:f}}):a[g]=f)})})}function kc(a){a.forEach(function(a){for(var b in a)a[b]instanceof Yb&&delete a[b]})}function Qb(a,
b,f,m,q,s){var g=T.PSD;s=s||Sd;a.onerror||(a.onerror=Sa(q));a.onsuccess=b?ga(function(g){var x=a.result;if(x){var l=function(){x.continue()};b(x,function(a){l=a},m,q)&&f(s(x.value),x,function(a){l=a});l()}else m()},q,g):ga(function(b){var c=a.result;if(c){var g=function(){c.continue()};f(s(c.value),c,function(a){g=a});g()}else m()},q,g)}function B(a){var b=[];a.split(",").forEach(function(a){a=a.trim();var f=a.replace("&","").replace("++","").replace("*",""),m=0!==f.indexOf("[")?f:a.substring(a.indexOf("[")+
1,a.indexOf("]")).split("+");b.push(new ad(f,m||null,-1!==a.indexOf("&"),-1!==a.indexOf("*"),-1!==a.indexOf("++"),Array.isArray(m),-1!==m.indexOf(".")))});return b}function I(a,b){return a<b?-1:a>b?1:0}function Ud(a,b){return a<b?1:a>b?-1:0}function Ac(a){return function(b,f){for(var m=0;;){var q=a(b[m],f[m]);if(0!==q)return q;++m;if(m===b.length||m===f.length)return a(b.length,f.length)}}}function Zb(a,b){return a?b?function(){return a.apply(this,arguments)&&b.apply(this,arguments)}:a:b}function Pb(){M.verno=
m.version/10;M._dbSchema=da={};ed=[].slice.call(m.objectStoreNames,0);if(0!==ed.length){var a=m.transaction(Kc(ed),"readonly");ed.forEach(function(b){for(var f=a.objectStore(b),m=f.keyPath,q=m&&"string"===typeof m&&-1!==m.indexOf("."),s=new ad(m,m||"",!1,!1,!!f.autoIncrement,m&&"string"!==typeof m,q),g=[],x=0;x<f.indexNames.length;++x){var Q=f.index(f.indexNames[x]),q=(m=Q.keyPath)&&"string"===typeof m&&-1!==m.indexOf("."),m=new ad(Q.name,m,!!Q.unique,!!Q.multiEntry,!1,m&&"string"!==typeof m,q);g.push(m)}da[b]=
new bd(b,s,g,{})});Mc([P],M._transPromiseFactory,Object.keys(da),b,da)}}function Nc(a,b){for(var f=b.db.objectStoreNames,m=0;m<f.length;++m)for(var q=f[m],s=b.objectStore(q),g=0;g<s.indexNames.length;++g){var x=s.indexNames[g],Q=s.index(x).keyPath,Q="string"===typeof Q?Q:"["+[].slice.call(Q).join("+")+"]";a[q]&&(Q=a[q].idxByName[Q])&&(Q.name=x)}}var ac=w&&w.addons||L.addons,wb=L.dependencies,Kb=wb.indexedDB,N=wb.IDBKeyRange,dd=wb.TypeError,Na=wb.Error,da=this._dbSchema={},Oc=[],ed=[],P={},ud={},m=
null,db=!0,gb=null,qa=!1,b="readwrite",M=this,q=[],sa=!1,pa=!!f();this.version=function(a){if(m)throw new Na("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var b=Oc.filter(function(b){return b._cfg.version===a})[0];if(b)return b;b=new F(a);Oc.push(b);Oc.sort(cd);return b};U(F.prototype,{stores:function(a){this._cfg.storesSource=this._cfg.storesSource?U(this._cfg.storesSource,a):a;var c={};Oc.forEach(function(a){U(c,a._cfg.storesSource)});a=this._cfg.dbschema={};this._parseStoresSpec(c,
a);da=M._dbSchema=a;kc([P,M,ud]);Mc([ud],Kd,Object.keys(a),b,a);Mc([P,M,this._cfg.tables],M._transPromiseFactory,Object.keys(a),b,a,!0);ed=Object.keys(a);return this},upgrade:function(a){var c=this;wa(function(){a(M._createTransaction(b,Object.keys(c._cfg.dbschema),c._cfg.dbschema))});this._cfg.contentUpgrade=a;return this},_parseStoresSpec:function(a,b){Object.keys(a).forEach(function(f){if(null!==a[f]){var m={},q=B(a[f]),s=q.shift();if(s.multi)throw new Na("Primary key cannot be multi-valued");
s.keyPath&&s.auto&&Ob(m,s.keyPath,0);q.forEach(function(a){if(a.auto)throw new Na("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new Na("Index must have a name and cannot be an empty string");Ob(m,a.keyPath,a.compound?a.keyPath.map(function(){return""}):"")});b[f]=new bd(f,s,q,m)}})}});this._allTables=P;this._tableFactory=function(a,b,f){return"readonly"===a?new Yb(b.name,f,b,Db):new Fd(b.name,f,b)};this._createTransaction=function(a,b,f,m){return new Gd(a,b,f,m)};this._transPromiseFactory=
function(a,b,f){if(!db||T.PSD&&T.PSD.letThrough){var m=M._createTransaction(a,b,da);return m._promise(a,function(a,b){m.error(function(a){M.on("error").fire(a)});f(function(b){m.complete(function(){a(b)})},b,m)})}var s=new T(function(m,g){q.push({resume:function(){var q=M._transPromiseFactory(a,b,f);s.onuncatched=q.onuncatched;q.then(m,g)}})});return s};this._whenReady=function(a){return!db||T.PSD&&T.PSD.letThrough?new T(a):new T(function(b,f){wa(function(){new T(function(){a(b,f)})});q.push({resume:function(){a(b,
f)}})})};this.verno=0;this.open=function(){return new T(function(a,b){function f(a){try{s.transaction.abort()}catch(g){}qa=!1;gb=a;db=!1;b(gb);q.forEach(function(a){a.resume()});q=[]}if(m||qa)throw new Na("Database already opened or being opened");var s;try{gb=null;qa=!0;0===Oc.length&&(sa=!0);if(!Kb)throw new Na("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");s=sa?Kb.open(x):Kb.open(x,
Math.round(10*M.verno));s.onerror=Sa(f,["opening database",x]);s.onblocked=function(a){M.on("blocked").fire(a)};s.onupgradeneeded=ga(function(a){sa&&!M._allowEmptyDB?(s.onerror=function(a){a.preventDefault()},s.transaction.abort(),s.result.close(),a=Kb.deleteDatabase(x),a.onsuccess=a.onerror=function(){f(new Na("Database '"+x+"' doesnt exist"))}):(s.transaction.onerror=Sa(f),a=a.oldVersion>Math.pow(2,62)?0:a.oldVersion,fc(a/10,s.transaction,f,s))},f);s.onsuccess=ga(function(b){qa=!1;m=s.result;sa?
Pb():0<m.objectStoreNames.length&&Nc(da,m.transaction(Kc(m.objectStoreNames),"readonly"));m.onversionchange=M.on("versionchange").fire;pa||Wd(function(a){if(-1===a.indexOf(x))return a.push(x)});T.newPSD(function(){function b(){db=!1;q.forEach(function(a){a.resume()});q=[];a()}T.PSD.letThrough=!0;try{var c=M.on.ready.fire();c&&"function"===typeof c.then?c.then(b,function(a){m.close();m=null;f(a)}):Hd(b)}catch(s){f(s)}})},f)}catch(t){f(t)}})};this.close=function(){m&&(m.close(),m=null,db=!0,gb=null)};
this.delete=function(){var a=arguments;return new T(function(b,f){function m(){M.close();var a=Kb.deleteDatabase(x);a.onsuccess=function(){pa||Wd(function(a){var b=a.indexOf(x);if(0<=b)return a.splice(b,1)});b()};a.onerror=Sa(f,["deleting",x]);a.onblocked=function(){M.on("blocked").fire()}}if(0<a.length)throw new Na("Arguments not allowed in db.delete()");qa?q.push({resume:m}):m()})};this.backendDB=function(){return m};this.isOpen=function(){return null!==m};this.hasFailed=function(){return null!==
gb};this.dynamicallyOpened=function(){return sa};this.name=x;Object.defineProperty(this,"tables",{get:function(){return Object.keys(P).map(function(a){return P[a]})}});this.on=td(this,"error","populate","blocked",{ready:[ce,C],versionchange:[ue,C]});this.on.ready.subscribe=Y(this.on.ready.subscribe,function(a){return function(b,f){function m(){f||M.on.ready.unsubscribe(m);return b.apply(this,arguments)}a.call(this,m);M.isOpen()&&(db?q.push({resume:m}):m())}});wa(function(){M.on("populate").fire(M._createTransaction(b,
ed,da));M.on("error").fire(new Na)});this.transaction=function(a,c,f){function m(b,c){var s=null;try{if(g)throw g;var s=M._createTransaction(a,x,da,q),B=x.map(function(a){return s.tables[a]});B.push(s);var w,F=0;T.newPSD(function(){T.PSD.trans=s;s.scopeFunc=f;q&&(s.idbtrans=q.idbtrans,s._promise=Y(s._promise,function(a){return function(b,c,g){function f(a){return function(b){var c;T._rootExec(function(){c=a(b);T._tickFinalize(function(){0===--F&&s.active&&(s.active=!1,s.on.complete.fire())})});return c}}
++F;return a.call(this,b,function(a,b,g){return c(f(a),f(b),g)},g)}}));s.complete(function(){b(w)});s.error(function(a){s.idbtrans&&(s.idbtrans.onerror=Vd);try{s.abort()}catch(b){}q&&(q.active=!1,q.on.error.fire(a));var g=c(a);q||g||M.on.error.fire(a)});T._rootExec(function(){w=f.apply(s,B)})});(!s.idbtrans||q&&0===F)&&s._nop()}catch(I){s&&s.idbtrans&&(s.idbtrans.onerror=Vd),s&&s.abort(),q&&q.on.error.fire(I),Hd(function(){c(I)||M.on("error").fire(I)})}}c=[].slice.call(arguments,1,arguments.length-
1);f=arguments[arguments.length-1];var q=T.PSD&&T.PSD.trans;q&&q.db===M&&-1===a.indexOf("!")||(q=null);var s=-1!==a.indexOf("?");a=a.replace("!","").replace("?","");var g=null,x=(Array.isArray(c[0])?c.reduce(function(a,b){return a.concat(b)}):c).map(function(a){if("string"===typeof a)return a;a instanceof Yb||(g=g||new dd("Invalid type. Arguments following mode must be instances of Table or String"));return a.name});"r"==a||"readonly"==a?a="readonly":"rw"==a||a==b?a=b:g=new Na("Invalid transaction mode: "+
a);q&&!g&&(q&&"readonly"===q.mode&&a===b&&(s?q=null:g=g||new Na("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY")),q&&x.forEach(function(a){q.tables.hasOwnProperty(a)||(s?q=null:g=g||new Na("Table "+a+" not included in parent transaction. Parent Transaction function: "+q.scopeFunc.toString()))}));return q?q._promise(a,m,"lock"):M._whenReady(m)};this.table=function(a){if(!sa&&!P.hasOwnProperty(a))throw new Na("Table does not exist");return P[a]};U(Yb.prototype,
function(){function a(){throw new Na("Current Transaction is READONLY");}return{_trans:function(a,b,f){return this._tpf(a,[this.name],b,f)},_idbstore:function(a,b,f){var m=this;return this._tpf(a,[this.name],function(a,c,f){b(a,c,f.idbtrans.objectStore(m.name),f)},f)},get:function(a,b){var f=this;wa(function(){b(f.schema.instanceTemplate)});return this._idbstore("readonly",function(b,m,g){var q=g.get(a);q.onerror=Sa(m,["getting",a,"from",f.name]);q.onsuccess=function(){b(f.hook.reading.fire(q.result))}}).then(b)},
where:function(a){return new zc(this,a)},count:function(a){return this.toCollection().count(a)},offset:function(a){return this.toCollection().offset(a)},limit:function(a){return this.toCollection().limit(a)},reverse:function(){return this.toCollection().reverse()},filter:function(a){return this.toCollection().and(a)},each:function(a){var b=this;wa(function(){a(b.schema.instanceTemplate)});return this._idbstore("readonly",function(f,m,q){q=q.openCursor();q.onerror=Sa(m,["calling","Table.each()","on",
b.name]);Qb(q,null,a,f,m,b.hook.reading.fire)})},toArray:function(a){var b=this;wa(function(){a([b.schema.instanceTemplate])});return this._idbstore("readonly",function(a,c,f){var g=[];f=f.openCursor();f.onerror=Sa(c,["calling","Table.toArray()","on",b.name]);Qb(f,null,function(a){g.push(a)},function(){a(g)},c,b.hook.reading.fire)}).then(a)},orderBy:function(a){return new this._collClass(new zc(this,a))},toCollection:function(){return new this._collClass(new zc(this))},mapToClass:function(a,b){this.schema.mappedClass=
a;var f=Object.create(a.prototype);this.schema.primKey.keyPath&&(Ob(f,this.schema.primKey.keyPath,this.schema.primKey.auto?0:""),we(a.prototype,this.schema.primKey.keyPath));b&&yc(f,b);this.schema.instanceTemplate=f;f=Object.setPrototypeOf?function(b){if(!b)return b;Object.setPrototypeOf(b,a.prototype);return b}:function(b){if(!b)return b;var f=Object.create(a.prototype),g;for(g in b)b.hasOwnProperty(g)&&(f[g]=b[g]);return f};this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook);
this.schema.readHook=f;this.hook("reading",f);return a},defineClass:function(a){return this.mapToClass(L.defineClass(a),a)},add:a,put:a,"delete":a,clear:a,update:a}});V(Fd).from(Yb).extend(function(){return{add:function(a,c){var f=this,m=this.hook.creating.fire;return this._idbstore(b,function(b,q,g,s){var x={};if(m!==C){var l=c||(g.keyPath?ka(a,g.keyPath):K);s=m.call(x,l,a,s);l===K&&s!==K&&(g.keyPath?Ob(a,g.keyPath,s):c=s)}var B=c?g.add(a,c):g.add(a);B.onerror=Sa(function(a){if(x.onerror)x.onerror(a);
return q(a)},["adding",a,"into",f.name]);B.onsuccess=function(c){var f=g.keyPath;f&&Ob(a,f,c.target.result);if(x.onsuccess)x.onsuccess(c.target.result);b(B.result)}})},put:function(a,c){var f=this,m=this.hook.updating.fire;return this.hook.creating.fire!==C||m!==C?this._trans(b,function(b,m,g){var q=c||f.schema.primKey.keyPath&&ka(a,f.schema.primKey.keyPath);q===K?g.tables[f.name].add(a).then(b,m):(g._lock(),a=$c(a),g.tables[f.name].where(":id").equals(q).modify(function(b){this.value=a}).then(function(b){return 0===
b?g.tables[f.name].add(a,c):q}).finally(function(){g._unlock()}).then(b,m))}):this._idbstore(b,function(b,m,g){var q=c?g.put(a,c):g.put(a);q.onerror=Sa(m,["putting",a,"into",f.name]);q.onsuccess=function(c){var f=g.keyPath;f&&Ob(a,f,c.target.result);b(q.result)}})},"delete":function(a){return this.hook.deleting.subscribers.length?this.where(":id").equals(a).delete():this._idbstore(b,function(b,f,m){var q=m.delete(a);q.onerror=Sa(f,["deleting",a,"from",m.name]);q.onsuccess=function(a){b(q.result)}})},
clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore(b,function(a,b,f){var m=f.clear();m.onerror=Sa(b,["clearing",f.name]);m.onsuccess=function(b){a(m.result)}})},update:function(a,b){if("object"!==typeof b||Array.isArray(b))throw new Na("db.update(keyOrObject, modifications). modifications must be an object.");if("object"!==typeof a||Array.isArray(a))return this.where(":id").equals(a).modify(b);Object.keys(b).forEach(function(f){Ob(a,f,b[f])});
var f=ka(a,this.schema.primKey.keyPath);f===K&&T.reject(new Na("Object does not contain its primary key"));return this.where(":id").equals(f).modify(b)}}});U(Gd.prototype,{_lock:function(){++this._reculock;1===this._reculock&&T.PSD&&(T.PSD.lockOwnerFor=this);return this},_unlock:function(){if(0===--this._reculock)for(T.PSD&&(T.PSD.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{a()}catch(b){}}return this},_locked:function(){return this._reculock&&
(!T.PSD||T.PSD.lockOwnerFor!==this)},_nop:function(a){this.tables[this.storeNames[0]].get(0).then(a)},_promise:function(a,b,f){var q=this;return T.newPSD(function(){var s;q._locked()?s=new T(function(m,g){q._blockedFuncs.push(function(){q._promise(a,b,f).then(m,g)})}):(s=q.active?new T(function(s,g){if(!q.idbtrans&&a){if(!m)throw gb?new Na("Database not open. Following error in populate, ready or upgrade function made Dexie.open() fail: "+gb):new Na("Database not open");var t=q.idbtrans=m.transaction(Kc(q.storeNames),
q.mode);t.onerror=function(a){q.on("error").fire(a&&a.target.error);a.preventDefault();q.abort()};t.onabort=function(a){q.active=!1;q.on("abort").fire(a)};t.oncomplete=function(a){q.active=!1;q.on("complete").fire(a)}}f&&q._lock();try{b(s,g,q)}catch(x){L.ignoreTransaction(function(){q.on("error").fire(x)}),q.abort(),g(x)}}):T.reject(Le(new Na("Transaction is inactive. Original Scope Function Source: "+q.scopeFunc.toString()))),q.active&&f&&s.finally(function(){q._unlock()}));s.onuncatched=function(a){L.ignoreTransaction(function(){q.on("error").fire(a)});
q.abort()};return s})},complete:function(a){return this.on("complete",a)},error:function(a){return this.on("error",a)},abort:function(){if(this.idbtrans&&this.active)try{this.active=!1,this.idbtrans.abort(),this.on.error.fire(new Na("Transaction Aborted"))}catch(a){}},table:function(a){if(!this.tables.hasOwnProperty(a))throw new Na("Table "+a+" not in transaction");return this.tables[a]}});U(zc.prototype,function(){function a(b,c){try{throw c;}catch(f){b._ctx.error=f}return b}function b(a){return Array.prototype.slice.call(1===
a.length&&Array.isArray(a[0])?a[0]:a)}function f(a){return"next"===a?function(a){return a.toUpperCase()}:function(a){return a.toLowerCase()}}function m(a){return"next"===a?function(a){return a.toLowerCase()}:function(a){return a.toUpperCase()}}function q(a,b,c,f,m,s){for(var t=Math.min(a.length,f.length),x=-1,B=0;B<t;++B){var w=b[B];if(w!==f[B])return 0>m(a[B],c[B])?a.substr(0,B)+c[B]+c.substr(B+1):0>m(a[B],f[B])?a.substr(0,B)+f[B]+c.substr(B+1):0<=x?a.substr(0,x)+b[x]+c.substr(x+1):null;0>m(a[B],
w)&&(x=B)}return t<f.length&&"next"===s?a+c.substr(a.length):t<a.length&&"prev"===s?a.substr(0,c.length):0>x?null:a.substr(0,x)+f[x]+c.substr(x+1)}function s(a,b,c){function l(a){x=f(a);B=m(a);w="next"===a?I:Ud;G=x(c);F=B(c);Lc=a}var x,B,w,G,F,Lc;l("next");a._ondirectionchange=function(a){l(a)};a._addAlgorithm(function(a,c,g){var f=a.key;if("string"!==typeof f)return!1;var l=B(f);if(b(l,F))return c(function(){a.continue()}),!0;var m=q(f,l,G,F,w,Lc);m?c(function(){a.continue(m)}):c(g);return!1})}return{between:function(a,
b,c,f){c=!1!==c;f=!0===f;return a>b||a===b&&!(!c&&!f||c&&f)?(new this._ctx.collClass(this,function(){return N.only(a)})).limit(0):new this._ctx.collClass(this,function(){return N.bound(a,b,!c,!f)})},equals:function(a){return new this._ctx.collClass(this,function(){return N.only(a)})},above:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a,!0)})},aboveOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a)})},below:function(a){return new this._ctx.collClass(this,
function(){return N.upperBound(a,!0)})},belowOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.upperBound(a)})},startsWith:function(b){return"string"!==typeof b?a(new this._ctx.collClass(this),new dd("String expected")):this.between(b,b+String.fromCharCode(65535),!0,!0)},startsWithIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new dd("String expected"));if(""===b)return this.startsWith(b);var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),
b.toLowerCase()+String.fromCharCode(65535))});s(c,function(a,b){return 0===a.indexOf(b)},b);c._ondirectionchange=function(){a(c,new Na("reverse() not supported with WhereClause.startsWithIgnoreCase()"))};return c},equalsIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new dd("String expected"));var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),b.toLowerCase())});s(c,function(a,b){return a===b},b);return c},anyOf:function(a){var f=this._ctx,
m=f.table.schema,l=(f=f.index?m.idxByName[f.index]:m.primKey)&&f.compound,q=b(arguments),s=l?Ac(I):I;q.sort(s);if(0===q.length)return(new this._ctx.collClass(this,function(){return N.only("")})).limit(0);f=new this._ctx.collClass(this,function(){return N.bound(q[0],q[q.length-1])});f._ondirectionchange=function(a){s="next"===a?I:Ud;l&&(s=Ac(s));q.sort(s)};var t=0;f._addAlgorithm(function(a,b,c){for(var g=a.key;0<s(g,q[t]);)if(++t,t===q.length)return b(c),!1;if(0===s(g,q[t]))return b(function(){a.continue()}),
!0;b(function(){a.continue(q[t])});return!1});return f}}});U(Db.prototype,function(){function a(b,c){b.filter=Zb(b.filter,c)}function c(a,b){a.isMatch=Zb(a.isMatch,b)}function f(a,b){if(a.isPrimKey)return b;var c=a.table.schema.idxByName[a.index];if(!c)throw new Na("KeyPath "+a.index+" on object store "+b.name+" is not indexed");return a.isPrimKey?b:b.index(c.name)}function m(a,b){return f(a,b)[a.op](a.range||null,a.dir+a.unique)}function q(a,b,c,f,s){a.or?function(){function q(){2===++w&&c()}function t(a,
c,g){if(!x||x(c,g,q,f)){var m=c.primaryKey.toString();B.hasOwnProperty(m)||(B[m]=!0,b(a,c,g))}}var x=a.filter,B={},w=0;a.or._iterate(t,q,f,s);Qb(m(a,s),a.algorithm,t,q,f,a.table.hook.reading.fire)}():Qb(m(a,s),Zb(a.algorithm,a.filter),b,c,f,a.table.hook.reading.fire)}function s(a){return a.table.schema.instanceTemplate}return{_read:function(a,b){var c=this._ctx;return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore("readonly",a).then(b)},_write:function(a){var c=this._ctx;
return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore(b,a,"locked")},_addAlgorithm:function(a){var b=this._ctx;b.algorithm=Zb(b.algorithm,a)},_iterate:function(a,b,c,f){return q(this._ctx,a,b,c,f)},each:function(a){var b=this._ctx;wa(function(){a(s(b))});return this._read(function(c,f,m){q(b,a,c,f,m)})},count:function(a){wa(function(){a(0)});var b=this,c=this._ctx;if(c.filter||c.algorithm||c.or){var l=0;return this._read(function(a,b,g){q(c,function(){++l;return!1},function(){a(l)},
b,g)},a)}return this._read(function(a,g,l){l=f(c,l);l=c.range?l.count(c.range):l.count();l.onerror=Sa(g,["calling","count()","on",b.name]);l.onsuccess=function(b){a(Math.min(b.target.result,Math.max(0,c.limit-c.offset)))}},a)},sortBy:function(a,b){function c(a,b){return b?c(a[q[b]],b-1):a[t]}function f(a,b){var g=c(a,x),l=c(b,x);return g<l?-B:g>l?B:0}var m=this._ctx;wa(function(){b([s(m)])});var q=a.split(".").reverse(),t=q[0],x=q.length-1,B="next"===this._ctx.dir?1:-1;return this.toArray(function(a){return a.sort(f)}).then(b)},
toArray:function(a){var b=this._ctx;wa(function(){a([s(b)])});return this._read(function(a,c,g){var f=[];q(b,function(a){f.push(a)},function(){a(f)},c,g)},a)},offset:function(b){var c=this._ctx;if(0>=b)return this;c.offset+=b;c.or||c.algorithm||c.filter?a(c,function(a,c,f){return 0>--b}):a(c,function(a,c,f){if(0===b)return!0;if(1===b)return--b,!1;c(function(){a.advance(b);b=0});return!1});return this},limit:function(b){this._ctx.limit=Math.min(this._ctx.limit,b);a(this._ctx,function(a,c,f){0>=--b&&
c(f);return 0<=b});return this},until:function(b,c){var f=this._ctx;wa(function(){b(s(f))});a(this._ctx,function(a,f,m){return b(a.value)?(f(m),c):!0});return this},first:function(a){var b=this;wa(function(){a(s(b._ctx))});return this.limit(1).toArray(function(a){return a[0]}).then(a)},last:function(a){return this.reverse().first(a)},and:function(b){var f=this;wa(function(){b(s(f._ctx))});a(this._ctx,function(a){return b(a.value)});c(this._ctx,b);return this},or:function(a){return new zc(this._ctx.table,
a,this)},reverse:function(){this._ctx.dir="prev"===this._ctx.dir?"next":"prev";this._ondirectionchange&&this._ondirectionchange(this._ctx.dir);return this},desc:function(){return this.reverse()},eachKey:function(a){var b=this,c=this._ctx;wa(function(){a(s(b._ctx)[b._ctx.index])});c.isPrimKey||(c.op="openKeyCursor");return this.each(function(b,c){a(c.key,c)})},eachUniqueKey:function(a){this._ctx.unique="unique";return this.eachKey(a)},keys:function(a){wa(function(){a([s(c)[b._ctx.index]])});var b=
this,c=this._ctx;c.isPrimKey||(c.op="openKeyCursor");var f=[];return this.each(function(a,b){f.push(b.key)}).then(function(){return f}).then(a)},uniqueKeys:function(a){this._ctx.unique="unique";return this.keys(a)},firstKey:function(a){return this.limit(1).keys(function(a){return a[0]}).then(a)},lastKey:function(a){return this.reverse().firstKey(a)},distinct:function(){var b={};a(this._ctx,function(a){a=a.primaryKey.toString();var c=b.hasOwnProperty(a);b[a]=!0;return!c});return this}}});V(Ra).from(Db).extend({modify:function(a){var b=
this,f=this._ctx,m=f.table.hook,q=m.updating.fire,s=m.deleting.fire;wa(function(){"function"===typeof a&&a.call({value:f.table.schema.instanceTemplate},f.table.schema.instanceTemplate)});return this._write(function(g,m,x,l){function B(a){a&&(N.push(a),Mc.push(fc));return m(new Jd("Error modifying one or more objects",N,D,Mc))}function w(){P&&D+N.length===E&&(0<N.length?B():g(D))}var F;if("function"===typeof a)F=q===C&&s===C?a:function(b){var c=$c(b);if(!1===a.call(this,b))return!1;if(this.hasOwnProperty("value")){var g=
Jc(c,this.value),f=q.call(this,g,this.primKey,c,l);f&&(b=this.value,Object.keys(f).forEach(function(a){Ob(b,a,f[a])}))}else s.call(this,this.primKey,b,l)};else if(q===C){var I=Object.keys(a),Lc=I.length;F=function(b){for(var c=!1,g=0;g<Lc;++g){var f=I[g],l=a[f];ka(b,f)!==l&&(Ob(b,f,l),c=!0)}return c}}else{var M=a;a=ee(M);F=function(b){var c=!1,g=q.call(this,a,this.primKey,$c(b),l);g&&U(a,g);Object.keys(a).forEach(function(g){var f=a[g];ka(b,g)!==f&&(Ob(b,g,f),c=!0)});g&&(a=ee(M));return c}}var E=
0,D=0,P=!1,N=[],Mc=[],fc=null;b._iterate(function(a,b,c){fc=b.primaryKey;var g={primKey:b.primaryKey,value:a};if(!1!==F.call(g,a))b=(c=!g.hasOwnProperty("value"))?b.delete():b.update(g.value),++E,b.onerror=Sa(function(a){N.push(a);Mc.push(g.primKey);if(g.onerror)g.onerror(a);w();return!0},c?["deleting",a,"from",f.table.name]:["modifying",a,"on",f.table.name]),b.onsuccess=function(a){if(g.onsuccess)g.onsuccess(g.value);++D;w()};else if(g.onsuccess)g.onsuccess(g.value)},function(){P=!0;w()},B,x)})},
"delete":function(){return this.modify(function(){delete this.value})}});U(this,{Collection:Db,Table:Yb,Transaction:Gd,Version:F,WhereClause:zc,WriteableCollection:Ra,WriteableTable:Fd});(function(){M.on("versionchange",function(a){M.close();M.on("error").fire(new Na("Database version changed by other database connection."))})})();ac.forEach(function(a){a(M)})}function C(){}function Sd(f){return f}function sd(f,w){return f===Sd?w:function(F){return w(f(F))}}function Kb(f,w){return function(){f.apply(this,
arguments);w.apply(this,arguments)}}function Td(f,w){return f===C?w:function(){var F=f.apply(this,arguments);F!==K&&(arguments[0]=F);var C=this.onsuccess,a=this.onerror;delete this.onsuccess;delete this.onerror;var s=w.apply(this,arguments);C&&(this.onsuccess=this.onsuccess?Kb(C,this.onsuccess):C);a&&(this.onerror=this.onerror?Kb(a,this.onerror):a);return s!==K?s:F}}function se(f,w){return f===C?w:function(){var F=f.apply(this,arguments);F!==K&&U(arguments[0],F);var C=this.onsuccess,a=this.onerror;
delete this.onsuccess;delete this.onerror;var s=w.apply(this,arguments);C&&(this.onsuccess=this.onsuccess?Kb(C,this.onsuccess):C);a&&(this.onerror=this.onerror?Kb(a,this.onerror):a);return F===K?s===K?K:s:s===K?F:U(F,s)}}function te(f,w){return f===C?w:function(){return!1===f.apply(this,arguments)?!1:w.apply(this,arguments)}}function ue(f,w){return f===C?w:function(){return!1===w.apply(this,arguments)?!1:f.apply(this,arguments)}}function ve(f,w){return f===C?w:function(){f.apply(this,arguments);w.apply(this,
arguments)}}function ce(f,w){return f===C?w:function(){var F=f.apply(this,arguments);if(F&&"function"===typeof F.then){var C=this,a=arguments;return F.then(function(){return w.apply(C,a)})}return w.apply(this,arguments)}}function td(f,w){function F(f,s,x){if(Array.isArray(f))return a(f);if("object"===typeof f)return L(f);s||(s=te);x||(x=C);var w={subscribers:[],fire:x,subscribe:function(a){w.subscribers.push(a);w.fire=s(w.fire,a)},unsubscribe:function(a){w.subscribers=w.subscribers.filter(function(f){return f!==
a});w.fire=w.subscribers.reduce(s,x)}};return K[f]=T[f]=w}function L(a){Object.keys(a).forEach(function(f){var s=a[f];if(Array.isArray(s))F(f,a[f][0],a[f][1]);else if("asap"===s){var x=F(f,null,function(){var a=arguments;x.subscribers.forEach(function(f){Hd(function(){f.apply(oa,a)})})});x.subscribe=function(a){-1===x.subscribers.indexOf(a)&&x.subscribers.push(a)};x.unsubscribe=function(a){a=x.subscribers.indexOf(a);-1!==a&&x.subscribers.splice(a,1)}}else throw Error("Invalid event config");})}function a(a){function f(){if(s)return!1;
s=!0}var s=!1;a.forEach(function(a){F(a).subscribe(f)})}var s=arguments,K={},T=function(a,s){if(s){var w=[].slice.call(arguments,1),F=K[a];F.subscribe.apply(F,w);return f}if("string"===typeof a)return K[a]};T.addEventType=F;for(var U=1,V=s.length;U<V;++U)F(s[U]);return T}function Hd(f){oa.setImmediate?setImmediate(f):setTimeout(f,0)}function de(f){f=setTimeout(f,1E3);clearTimeout(f)}function ga(f,w,F){return function(){var C=T.PSD;T.PSD=F;try{f.apply(this,arguments)}catch(a){w(a)}finally{T.PSD=C}}}
function ka(f,w){if(f.hasOwnProperty(w))return f[w];if(!w)return f;if("string"!==typeof w){for(var F=[],C=0,a=w.length;C<a;++C){var s=ka(f,w[C]);F.push(s)}return F}F=w.indexOf(".");return-1!==F?(C=f[w.substr(0,F)],C===K?K:ka(C,w.substr(F+1))):K}function Ob(f,w,F){if(f&&w!==K)if("string"!==typeof w&&"length"in w){if(!("string"!==typeof F&&"length"in F))throw Error("Assertion failed");for(var C=0,a=w.length;C<a;++C)Ob(f,w[C],F[C])}else a=w.indexOf("."),-1!==a?(C=w.substr(0,a),w=w.substr(a+1),""===w?
F===K?delete f[C]:f[C]=F:((a=f[C])||(a=f[C]={}),Ob(a,w,F))):F===K?delete f[w]:f[w]=F}function we(f,w){Ob(f,w,K)}function ee(f){var w={},F;for(F in f)f.hasOwnProperty(F)&&(w[F]=f[F]);return w}function $c(f){if(!f||"object"!==typeof f)return f;var w;if(Array.isArray(f)){w=[];for(var F=0,C=f.length;F<C;++F)w.push($c(f[F]))}else if(f instanceof Date)w=new Date,w.setTime(f.getTime());else for(F in w=f.constructor?Object.create(f.constructor.prototype):{},f)f.hasOwnProperty(F)&&(w[F]=$c(f[F]));return w}
function Jc(f,w){var F={},C;for(C in f)f.hasOwnProperty(C)&&(w.hasOwnProperty(C)?f[C]!==w[C]&&JSON.stringify(f[C])!=JSON.stringify(w[C])&&(F[C]=w[C]):F[C]=K);for(C in w)w.hasOwnProperty(C)&&!f.hasOwnProperty(C)&&(F[C]=w[C]);return F}function Id(f){if("function"===typeof f)return new f;if(Array.isArray(f))return[Id(f[0])];if(f&&"object"===typeof f){var w={};yc(w,f);return w}return f}function yc(f,w){Object.keys(w).forEach(function(F){var C=Id(w[F]);f[F]=C})}function Sa(f,w){return function(F){var C=
F&&F.target.error||Error();if(w){var a=" occurred when "+w.map(function(a){switch(typeof a){case "function":return a();case "string":return a;default:return JSON.stringify(a)}}).join(" ");C.name?C.toString=function(){return C.name+a+(C.message?". "+C.message:"")}:C+=a}f(C);F&&(F.stopPropagation&&F.stopPropagation(),F.preventDefault&&F.preventDefault());return!1}}function Le(f){try{throw f;}catch(w){return w}}function Vd(f){f.preventDefault()}function Wd(f){var w,C=L.dependencies.localStorage;if(!C)return f([]);
try{w=JSON.parse(C.getItem("Dexie.DatabaseNames")||"[]")}catch(K){w=[]}f(w)&&C.setItem("Dexie.DatabaseNames",JSON.stringify(w))}function ad(f,w,C,K,a,s,L){this.name=f;this.keyPath=w;this.unique=C;this.multi=K;this.auto=a;this.compound=s;this.dotted=L;f="string"===typeof w?w:w&&"["+[].join.call(w,"+")+"]";this.src=(C?"&":"")+(K?"*":"")+(a?"++":"")+f}function bd(f,w,C,K){this.name=f;this.primKey=w||new ad;this.indexes=C||[new ad];this.instanceTemplate=K;this.mappedClass=null;this.idxByName=C.reduce(function(a,
f){a[f.name]=f;return a},{})}function Jd(f,w,C,K){this.name="ModifyError";this.failures=w;this.failedKeys=K;this.successCount=C;this.message=w.join("\n")}function Kc(f){return 1===f.length?f[0]:f}function f(){var f=L.dependencies.indexedDB,w=f&&(f.getDatabaseNames||f.webkitGetDatabaseNames);return w&&w.bind(f)}var T=function(){function f(a,s){Ra.push([a,Y.call(arguments,1)])}function w(){var a=Ra;Ra=[];for(var f=0,s=a.length;f<s;++f){var x=a[f];x[0].apply(oa,x[1])}}function F(a){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");
if("function"!==typeof a)throw new TypeError("not a function");this._value=this._state=null;this._deferreds=[];this._catched=!1;var f=this,w=!0;this._PSD=F.PSD;try{V(this,a,function(a){w?ka(s,f,a):s(f,a)},function(a){return w?(ka(L,f,a),!1):L(f,a)})}finally{w=!1}}function K(s,C){if(null===s._state)s._deferreds.push(C);else{var L=s._state?C.onFulfilled:C.onRejected;if(null===L)return(s._state?C.resolve:C.reject)(s._value);var B,I=wa;wa=!1;ka=f;try{var T=F.PSD;F.PSD=s._PSD;B=L(s._value);s._state||B&&
"function"===typeof B.then&&!1===B._state||a(s);C.resolve(B)}catch(U){if(!C.reject(U)&&s.onuncatched)try{s.onuncatched(U)}catch(V){}}finally{if(F.PSD=T,I){do{for(;0<Ra.length;)w();if(L=Sa.pop())try{L()}catch(Y){}}while(0<Sa.length||0<Ra.length);ka=ga;wa=!0}}}}function a(f){f._catched=!0;f._parent&&a(f._parent)}function s(a,f){var w=F.PSD;F.PSD=a._PSD;try{if(f===a)throw new TypeError("A promise cannot be resolved with itself.");!f||"object"!==typeof f&&"function"!==typeof f||"function"!==typeof f.then?
(a._state=!0,a._value=f,T.call(a)):V(a,function(a,s){f.then(a,s)},function(f){s(a,f)},function(f){L(a,f)})}catch(x){L(x)}finally{F.PSD=w}}function L(a,f){var s=F.PSD;F.PSD=a._PSD;a._state=!1;a._value=f;T.call(a);if(!a._catched)try{if(a.onuncatched)a.onuncatched(a._value);F.on.error.fire(a._value)}catch(w){}F.PSD=s;return a._catched}function T(){for(var a=0,f=this._deferreds.length;a<f;a++)K(this,this._deferreds[a]);this._deferreds=[]}function U(a,f,s,w){this.onFulfilled="function"===typeof a?a:null;
this.onRejected="function"===typeof f?f:null;this.resolve=s;this.reject=w}function V(a,f,s,w){var x=!1;try{f(function(a){x||(x=!0,s(a))},function(f){if(x)return a._catched;x=!0;return w(f)})}catch(C){if(!x)return w(C)}}var Y=[].slice,ga="undefined"===typeof setImmediate?function(a,f,s,w){var x=arguments;setTimeout(function(){a.apply(oa,Y.call(x,1))},0)}:setImmediate,ka=ga,wa=!0,Ra=[],Sa=[];F.on=td(null,"error");F.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&Array.isArray(arguments[0])?
arguments[0]:arguments);return new F(function(f,s){function w(C,F){try{if(F&&("object"===typeof F||"function"===typeof F)){var K=F.then;if("function"===typeof K){K.call(F,function(a){w(C,a)},s);return}}a[C]=F;0===--x&&f(a)}catch(L){s(L)}}if(0===a.length)return f([]);for(var x=a.length,C=0;C<a.length;C++)w(C,a[C])})};F.prototype.then=function(a,f){var s=this,w=new F(function(w,x){null===s._state?K(s,new U(a,f,w,x)):ka(K,s,new U(a,f,w,x))});w._PSD=this._PSD;w.onuncatched=this.onuncatched;w._parent=
this;return w};F.prototype._then=function(a,f){K(this,new U(a,f,C,C))};F.prototype["catch"]=function(a){if(1===arguments.length)return this.then(null,a);var f=arguments[0],s=arguments[1];return"function"===typeof f?this.then(null,function(a){return a instanceof f?s(a):F.reject(a)}):this.then(null,function(a){return a&&a.name===f?s(a):F.reject(a)})};F.prototype["finally"]=function(a){return this.then(function(f){a();return f},function(f){a();return F.reject(f)})};F.prototype.onuncatched=null;F.resolve=
function(a){var f=new F(function(){});f._state=!0;f._value=a;return f};F.reject=function(a){var f=new F(function(){});f._state=!1;f._value=a;return f};F.race=function(a){return new F(function(f,s){a.map(function(a){a.then(f,s)})})};F.PSD=null;F.newPSD=function(a){var f=F.PSD;F.PSD=f?Object.create(f):{};try{return a()}finally{F.PSD=f}};F._rootExec=function(a){var s=wa;wa=!1;ka=f;try{a()}finally{if(s){do{for(;0<Ra.length;)w();if(a=Sa.pop())try{a()}catch(C){}}while(0<Sa.length||0<Ra.length);ka=ga;wa=
!0}}};F._tickFinalize=function(a){if(wa)throw Error("Not in a virtual tick");Sa.push(a)};return F}(),wa=function(){};V(Jd).from(Error);L.delete=function(f){var w=new L(f);f=w.delete();f.onblocked=function(f){w.on("blocked",f);return this};return f};L.getDatabaseNames=function(w){return(new T(function(w,x){var C=f();C?(C=C(),C.onsuccess=function(a){w([].slice.call(a.target.result,0))},C.onerror=Sa(x)):Wd(function(a){w(a);return!1})})).then(w)};L.defineClass=function(f){function w(f){f&&U(this,f)}yc(w.prototype,
f);return w};L.ignoreTransaction=function(f){return T.newPSD(function(){T.PSD.trans=null;return f()})};L.spawn=function(){oa.console&&console.warn("Dexie.spawn() is deprecated. Use Dexie.ignoreTransaction() instead.");return L.ignoreTransaction.apply(this,arguments)};L.vip=function(f){return T.newPSD(function(){T.PSD.letThrough=!0;return f()})};Object.defineProperty(L,"currentTransaction",{get:function(){return T.PSD&&T.PSD.trans||null}});L.Promise=T;L.derive=V;L.extend=U;L.override=Y;L.events=td;
L.getByKeyPath=ka;L.setByKeyPath=Ob;L.delByKeyPath=we;L.shallowClone=ee;L.deepClone=$c;L.addons=[];L.fakeAutoComplete=wa;L.asap=Hd;L.ModifyError=Jd;L.MultiModifyError=Jd;L.IndexSpec=ad;L.TableSchema=bd;var Pb=oa.idbModules&&oa.idbModules.shimIndexedDB?oa.idbModules:{};L.dependencies={indexedDB:Pb.shimIndexedDB||oa.indexedDB||oa.mozIndexedDB||oa.webkitIndexedDB||oa.msIndexedDB,IDBKeyRange:Pb.IDBKeyRange||oa.IDBKeyRange||oa.webkitIDBKeyRange,IDBTransaction:Pb.IDBTransaction||oa.IDBTransaction||oa.webkitIDBTransaction,
Error:oa.Error||String,SyntaxError:oa.SyntaxError||String,TypeError:oa.TypeError||String,DOMError:oa.DOMError||String,localStorage:null!=("undefined"!==typeof chrome&&null!==chrome?chrome.storage:void 0)?null:oa.localStorage};L.version=1.1;w("Dexie",L);de(function(){wa=de})}).apply(null,"function"===typeof define&&define.amd?[self||window,function(oa,w){define(oa,function(){return w})}]:"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?[global,function(oa,w){module.exports=
w}]:[self||window,function(oa,w){(self||window)[oa]=w}]);
