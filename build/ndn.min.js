/*
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
  MIT
 <a href="https://github.com/bitcoinjs/bitcoinjs-lib/blob/master/LICENSE">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
*/
(function(ma,t){"object"===typeof exports?module.exports.printStackTrace=t():"function"===typeof define&&define.amd?define(t):ma.printStackTrace=t()})(this,function(){function ma(t){t=t||{guess:!0};var J=t.e||null,T=!!t.guess,U=t.mode||null;t=new ma.implementation;J=t.run(J,U);return T?t.guessAnonymousFunctions(J):J}ma.implementation=function(){};ma.implementation.prototype={run:function(t,J){t=t||this.createException();J=J||this.mode(t);return"other"===J?this.other(arguments.callee):this[J](t)},
createException:function(){try{this.undef()}catch(t){return t}},mode:function(t){return"undefined"!==typeof window&&-1<window.navigator.userAgent.indexOf("PhantomJS")?"phantomjs":t.arguments&&t.stack?"chrome":t.stack&&t.sourceURL?"safari":t.stack&&t.number?"ie":t.stack&&t.fileName?"firefox":t.message&&t["opera#sourceloc"]?!t.stacktrace||-1<t.message.indexOf("\n")&&t.message.split("\n").length>t.stacktrace.split("\n").length?"opera9":"opera10a":t.message&&t.stack&&t.stacktrace?0>t.stacktrace.indexOf("called from line")?
"opera10b":"opera11":t.stack&&!t.fileName?"chrome":"other"},instrumentFunction:function(t,J,T){t=t||window;var U=t[J];t[J]=function(){T.call(this,ma().slice(4));return t[J]._instrumented.apply(this,arguments)};t[J]._instrumented=U},deinstrumentFunction:function(t,J){t[J].constructor===Function&&t[J]._instrumented&&t[J]._instrumented.constructor===Function&&(t[J]=t[J]._instrumented)},chrome:function(t){return(t.stack+"\n").replace(/^[\s\S]+?\s+at\s+/," at ").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,
"{anonymous}() ($1)$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}() ($1)").replace(/^(.+) \((.+)\)$/gm,"$1@$2").split("\n").slice(0,-1)},safari:function(t){return t.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(t){return t.stack.replace(/^\s*at\s+(.*)$/gm,"$1").replace(/^Anonymous function\s+/gm,"{anonymous}() ").replace(/^(.+)\s+\((.+)\)$/gm,"$1@$2").split("\n").slice(1)},firefox:function(t){return t.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^(?:\((\S*)\))?@/gm,"{anonymous}($1)@").split("\n")},opera11:function(t){var J=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;t=t.stacktrace.split("\n");for(var T=[],U=0,X=t.length;U<X;U+=2){var K=J.exec(t[U]);if(K){var B=K[4]+":"+K[1]+":"+K[2],K=K[3]||"global code",K=K.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");T.push(K+"@"+B+" -- "+t[U+1].replace(/^\s+/,""))}}return T},opera10b:function(t){var J=/^(.*)@(.+):(\d+)$/;t=t.stacktrace.split("\n");
for(var T=[],U=0,X=t.length;U<X;U++){var K=J.exec(t[U]);K&&T.push((K[1]?K[1]+"()":"global code")+"@"+K[2]+":"+K[3])}return T},opera10a:function(t){var J=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;t=t.stacktrace.split("\n");for(var T=[],U=0,X=t.length;U<X;U+=2){var K=J.exec(t[U]);K&&T.push((K[3]||"{anonymous}")+"()@"+K[2]+":"+K[1]+" -- "+t[U+1].replace(/^\s+/,""))}return T},opera9:function(t){var J=/Line (\d+).*script (?:in )?(\S+)/i;t=t.message.split("\n");for(var T=[],U=2,X=t.length;U<
X;U+=2){var K=J.exec(t[U]);K&&T.push("{anonymous}()@"+K[2]+":"+K[1]+" -- "+t[U+1].replace(/^\s+/,""))}return T},phantomjs:function(t){var J=/(\S+) \((\S+)\)/i;t=t.stack.split("\n");for(var T=[],U=1,X=t.length;U<X;U++){t[U]=t[U].replace(/^\s+at\s+/gm,"");var K=J.exec(t[U]);K?T.push(K[1]+"()@"+K[2]):T.push("{anonymous}()@"+t[U])}return T},other:function(t){for(var J=/function(?:\s+([\w$]+))?\s*\(/,T=[],U,X,K=Array.prototype.slice;t&&10>T.length;){U=J.test(t.toString())?RegExp.$1||"{anonymous}":"{anonymous}";
try{X=K.call(t.arguments||[])}catch(B){X=["Cannot access arguments: "+B]}T[T.length]=U+"("+this.stringifyArguments(X)+")";try{t=t.caller}catch(ma){T[T.length]="Cannot access caller: "+ma;break}}return T},stringifyArguments:function(t){for(var J=[],T=Array.prototype.slice,U=0;U<t.length;++U){var X=t[U];void 0===X?J[U]="undefined":null===X?J[U]="null":X.constructor&&(J[U]=X.constructor===Array?3>X.length?"["+this.stringifyArguments(X)+"]":"["+this.stringifyArguments(T.call(X,0,1))+"..."+this.stringifyArguments(T.call(X,
-1))+"]":X.constructor===Object?"#object":X.constructor===Function?"#function":X.constructor===String?'"'+X+'"':X.constructor===Number?X:"?")}return J.join(",")},sourceCache:{},ajax:function(t){var J=this.createXMLHTTPObject();if(J)try{return J.open("GET",t,!1),J.send(null),J.responseText}catch(T){}return""},createXMLHTTPObject:function(){for(var t,J=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},
function(){return new ActiveXObject("Microsoft.XMLHTTP")}],T=0;T<J.length;T++)try{return t=J[T](),this.createXMLHTTPObject=J[T],t}catch(U){}},isSameDomain:function(t){return"undefined"!==typeof location&&-1!==t.indexOf(location.hostname)},getSource:function(t){t in this.sourceCache||(this.sourceCache[t]=this.ajax(t).split("\n"));return this.sourceCache[t]},guessAnonymousFunctions:function(t){for(var J=0;J<t.length;++J){var T=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,U=t[J],X=/\{anonymous\}\(.*\)@(.*)/.exec(U);
if(X){var K=T.exec(X[1]);K&&(T=K[1],X=K[2],K=K[3]||0,T&&this.isSameDomain(T)&&X&&(T=this.guessAnonymousFunction(T,X,K),t[J]=U.replace("{anonymous}",T)))}}return t},guessAnonymousFunction:function(t,J,T){var U;try{U=this.findFunctionName(this.getSource(t),J)}catch(X){U="getSource failed with url: "+t+", exception: "+X.toString()}return U},findFunctionName:function(t,J){for(var T=/function\s+([^(]*?)\s*\(([^)]*)\)/,U=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/,X=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/,
K="",B,ma=Math.min(J,20),od,Ib=0;Ib<ma;++Ib)if(B=t[J-Ib-1],od=B.indexOf("//"),0<=od&&(B=B.substr(0,od)),B)if(K=B+K,(B=U.exec(K))&&B[1]||(B=T.exec(K))&&B[1]||(B=X.exec(K))&&B[1])return B[1];return"(?)"}};return ma});
(function(ma){function t(e){var k="",h,d=0,w,n;for(h=0;h<e.length&&e.charAt(h)!=Bd;++h)n=Wb.indexOf(e.charAt(h)),0>n||(0==d?(k+=Xb.charAt(n>>2),w=n&3,d=1):1==d?(k+=Xb.charAt(w<<2|n>>4),w=n&15,d=2):2==d?(k+=Xb.charAt(w),k+=Xb.charAt(n>>2),w=n&3,d=3):(k+=Xb.charAt(w<<2|n>>4),k+=Xb.charAt(n&15),d=0));1==d&&(k+=Xb.charAt(w<<2));return k}function J(){this.j=this.i=0;this.S=[]}function T(){var e=(new Date).getTime();Bb[Oa++]^=e&255;Bb[Oa++]^=e>>8&255;Bb[Oa++]^=e>>16&255;Bb[Oa++]^=e>>24&255;Oa>=Cd&&(Oa-=
Cd)}function U(){}function X(e,k){return new A(e,k)}function K(e,k,h){for(var d="",w=0;d.length<k;)d+=h(String.fromCharCode.apply(String,e.concat([(w&4278190080)>>24,(w&16711680)>>16,(w&65280)>>8,w&255]))),w+=1;return d}function B(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}function Nd(e,k,h){for(var d="",w=0;d.length<k;)d+=h(e+String.fromCharCode.apply(String,[(w&4278190080)>>24,(w&16711680)>>16,(w&65280)>>8,w&255])),w+=1;return d}function od(e){var k=[],h=H.getStartPosOfV_AtObj(e,
0),d=H.getPosOfNextSibling_AtObj(e,h),w=H.getPosOfNextSibling_AtObj(e,d),n=H.getPosOfNextSibling_AtObj(e,w),a=H.getPosOfNextSibling_AtObj(e,n),b=H.getPosOfNextSibling_AtObj(e,a),c=H.getPosOfNextSibling_AtObj(e,b),g=H.getPosOfNextSibling_AtObj(e,c),f=H.getPosOfNextSibling_AtObj(e,g);k.push(h,d,w,n,a,b,c,g,f);h=H.getHexOfV_AtObj(e,k[0]);d=H.getHexOfV_AtObj(e,k[1]);w=H.getHexOfV_AtObj(e,k[2]);n=H.getHexOfV_AtObj(e,k[3]);a=H.getHexOfV_AtObj(e,k[4]);b=H.getHexOfV_AtObj(e,k[5]);c=H.getHexOfV_AtObj(e,k[6]);
g=H.getHexOfV_AtObj(e,k[7]);e=H.getHexOfV_AtObj(e,k[8]);k=[];k.push(h,d,w,n,a,b,c,g,e);return k}function Ib(e,k){for(var h="",d=k/4-e.length,w=0;w<d;w++)h+="0";return h+e}function Od(e,k){var h=N.crypto.Util.hashString(e,k);return this.signWithMessageHash(h,k)}function oe(e){return Od.call(this,e,"sha1")}function pe(e){return Od.call(this,e,"sha256")}function qe(e,k,h){for(var d="",w=0;d.length<k;)d+=hextorstr(h(rstrtohex(e+String.fromCharCode.apply(String,[(w&4278190080)>>24,(w&16711680)>>16,(w&
65280)>>8,w&255])))),w+=1;return d}function re(e,k,h){e=rstrtohex(e);e=N.crypto.Util.hashHex(e,k);void 0===h&&(h=-1);return this.signWithMessageHashPSS(e,k,h)}function Yd(e){for(var k in N.crypto.Util.DIGESTINFOHEAD){var h=N.crypto.Util.DIGESTINFOHEAD[k],d=h.length;if(e.substring(0,d)==h)return[k,e.substring(d)]}return[]}function pd(e,k){var h=X(e,16);var d=this.n.toString(16),w=this.e.toString(16),n=new B;n.setPublic(d,w);h=n.doPublic(h).toString(16).replace(/^1f+00/,"");d=Yd(h);0==d.length?h=!1:
(h=d[1],d=N.crypto.Util.hashString(k,d[0]),h=h==d);return h}function Dd(e,k){k=k.replace(Pd,"");k=k.replace(/[ \n]+/g,"");var h=X(k,16);if(h.bitLength()>this.n.bitLength())return 0;var h=this.doPublic(h).toString(16).replace(/^1f+00/,""),d=Yd(h);if(0==d.length)return!1;h=d[1];d=N.crypto.Util.hashString(e,d[0]);return h==d}function Zd(e,k,h,d){e=rstrtohex(e);e=N.crypto.Util.hashHex(e,h);void 0===d&&(d=-1);return this.verifyWithMessageHashPSS(e,k,h,d)}function fa(){this.hex=this.subjectPublicKeyRSA_hE=
this.subjectPublicKeyRSA_hN=this.subjectPublicKeyRSA=null;this.getSerialNumberHex=function(){return H.getDecendantHexVByNthList(this.hex,0,[0,1])};this.getIssuerHex=function(){return H.getDecendantHexTLVByNthList(this.hex,0,[0,3])};this.getIssuerString=function(){return fa.hex2dn(H.getDecendantHexTLVByNthList(this.hex,0,[0,3]))};this.getSubjectHex=function(){return H.getDecendantHexTLVByNthList(this.hex,0,[0,5])};this.getSubjectString=function(){return fa.hex2dn(H.getDecendantHexTLVByNthList(this.hex,
0,[0,5]))};this.getNotBefore=function(){var e=H.getDecendantHexVByNthList(this.hex,0,[0,4,0]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.getNotAfter=function(){var e=H.getDecendantHexVByNthList(this.hex,0,[0,4,1]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.readCertPEM=function(e){e=fa.pemToHex(e);var k=fa.getPublicKeyHexArrayFromCertHex(e),h=new B;h.setPublic(k[0],k[1]);this.subjectPublicKeyRSA=h;this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=
k[1];this.hex=e};this.readCertPEMWithoutRSAInit=function(e){e=fa.pemToHex(e);var k=fa.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(k[0],k[1]);this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=k[1];this.hex=e}}function ia(){return new A(null)}function Nb(e,k,h,d,w,n){for(;0<=--n;){var a=k*this[e++]+h[d]+w;w=Math.floor(a/67108864);h[d++]=a&67108863}return w}function se(e,k,h,d,w,n){var a=k&32767;for(k>>=15;0<=--n;){var b=this[e]&32767,c=this[e++]>>15,g=k*b+c*a,b=
a*b+((g&32767)<<15)+h[d]+(w&1073741823);w=(b>>>30)+(g>>>15)+k*c+(w>>>30);h[d++]=b&1073741823}return w}function $d(e,k,h,d,w,n){var a=k&16383;for(k>>=14;0<=--n;){var b=this[e]&16383,c=this[e++]>>14,g=k*b+c*a,b=a*b+((g&16383)<<14)+h[d]+w;w=(b>>28)+(g>>14)+k*c;h[d++]=b&268435455}return w}function Wc(e,k){var h=te[e.charCodeAt(k)];return null==h?-1:h}function Hc(e){var k=ia();k.fromInt(e);return k}function Ed(e){var k=1,h;0!=(h=e>>>16)&&(e=h,k+=16);0!=(h=e>>8)&&(e=h,k+=8);0!=(h=e>>4)&&(e=h,k+=4);0!=(h=
e>>2)&&(e=h,k+=2);0!=e>>1&&(k+=1);return k}function wc(e){this.m=e}function Pa(e){this.m=e;this.mp=e.invDigit();this.mpl=this.mp&32767;this.mph=this.mp>>15;this.um=(1<<e.DB-15)-1;this.mt2=2*e.t}function He(e,k){return e&k}function Qd(e,k){return e|k}function Rd(e,k){return e^k}function Xc(e,k){return e&~k}function Yc(){}function Fd(e){return e}function Ic(e){this.r2=ia();this.q3=ia();A.ONE.dlShiftTo(2*e.t,this.r2);this.mu=this.r2.divide(e);this.m=e}function f(e,k,h){if(!(this instanceof f))return new f(e,
k,h);var d=typeof e;if("base64"===k&&"string"===d)for(e=f.stringtrim(e);0!==e.length%4;)e+="=";var w;if("number"===d)w=f.coerce(e);else if("string"===d)w=f.byteLength(e,k);else if("object"===d)w=f.coerce(e.length);else throw Error("First argument needs to be a number, array or string.");var n;f._useTypedArrays?n=f._augment(new Uint8Array(w)):(n=this,n.length=w,n._isBuffer=!0);if(f._useTypedArrays&&"number"===typeof e.byteLength)n._set(e);else if(f.isArrayish(e))if(f.isBuffer(e))for(k=0;k<w;k++)n[k]=
e.readUInt8(k);else for(k=0;k<w;k++)n[k]=(e[k]%256+256)%256;else if("string"===d)n.write(e,0,k);else if("number"===d&&!f._useTypedArrays&&!h)for(k=0;k<w;k++)n[k]=0;return n}function S(e){if(e)return e.__proto__=S.prototype,e}function ua(e){if(e)return e.__proto__=ua.prototype,e}function Ob(e){if(e)return e.__proto__=Ob.prototype,e}function v(e){if(e)return e.__proto__=v.prototype,e}function Jc(e){v.call(this,e)}function D(e){v.call(this,e)}function dc(e){if(e)return e.__proto__=dc.prototype,e}var a=
a||{},q=a;q.printStackTrace=ma.printStackTrace;var Fb=function(){var e=!1;if("undefined"!==typeof crypto&&crypto&&crypto.subtle){var k={name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:{name:"SHA-256"},publicExponent:new Uint8Array([1,0,1])},h;crypto.subtle.generateKey(k,!0,["sign","verify"]).then(function(d){h=d;return crypto.subtle.sign(k,d.privateKey,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.verify(k,h.publicKey,d,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.exportKey("pkcs8",
h.privateKey)}).then(function(d){return crypto.subtle.importKey("pkcs8",d,k,!0,["sign"])}).then(function(d){return crypto.subtle.exportKey("spki",h.publicKey)}).then(function(d){return crypto.subtle.importKey("spki",d,k,!0,["verify"])}).then(function(d){d=new Uint8Array([1,2,3,4,5]);return crypto.subtle.digest({name:"SHA-256"},d.buffer)}).then(function(d){e=!0},function(d){console.log("DetectSubtleCrypto encountered error, not using crypto.subtle: ",d)})}return function(){return e}}();q.UseSubtleCrypto=
Fb;var Yb=Yb||function(e,k){var h={},d=h.lib={},w=d.Base=function(){function d(){}return{extend:function(e){d.prototype=this;var h=new d;e&&h.mixIn(e);h.hasOwnProperty("init")||(h.init=function(){h.$super.init.apply(this,arguments)});h.init.prototype=h;h.$super=this;return h},create:function(){var d=this.extend();d.init.apply(d,arguments);return d},init:function(){},mixIn:function(d){for(var e in d)d.hasOwnProperty(e)&&(this[e]=d[e]);d.hasOwnProperty("toString")&&(this.toString=d.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),
n=d.WordArray=w.extend({init:function(d,e){d=this.words=d||[];this.sigBytes=e!=k?e:4*d.length},toString:function(d){return(d||b).stringify(this)},concat:function(d){var e=this.words,h=d.words,k=this.sigBytes;d=d.sigBytes;this.clamp();if(k%4)for(var n=0;n<d;n++)e[k+n>>>2]|=(h[n>>>2]>>>24-n%4*8&255)<<24-(k+n)%4*8;else for(n=0;n<d;n+=4)e[k+n>>>2]=h[n>>>2];this.sigBytes+=d;return this},clamp:function(){var d=this.words,h=this.sigBytes;d[h>>>2]&=4294967295<<32-h%4*8;d.length=e.ceil(h/4)},clone:function(){var d=
w.clone.call(this);d.words=this.words.slice(0);return d},random:function(d){for(var h=[],k=0;k<d;k+=4)h.push(4294967296*e.random()|0);return new n.init(h,d)}}),a=h.enc={},b=a.Hex={stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++){var n=e[k>>>2]>>>24-k%4*8&255;h.push((n>>>4).toString(16));h.push((n&15).toString(16))}return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k+=2)h[k>>>3]|=parseInt(d.substr(k,2),16)<<24-k%8*4;return new n.init(h,e/2)}},c=a.Latin1=
{stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++)h.push(String.fromCharCode(e[k>>>2]>>>24-k%4*8&255));return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k++)h[k>>>2]|=(d.charCodeAt(k)&255)<<24-k%4*8;return new n.init(h,e)}},g=a.Utf8={stringify:function(d){try{return decodeURIComponent(escape(c.stringify(d)))}catch(e){throw Error("Malformed UTF-8 data");}},parse:function(d){return c.parse(unescape(encodeURIComponent(d)))}},f=d.BufferedBlockAlgorithm=w.extend({reset:function(){this._data=
new n.init;this._nDataBytes=0},_append:function(d){"string"==typeof d&&(d=g.parse(d));this._data.concat(d);this._nDataBytes+=d.sigBytes},_process:function(d){var h=this._data,k=h.words,w=h.sigBytes,a=this.blockSize,b=w/(4*a),b=d?e.ceil(b):e.max((b|0)-this._minBufferSize,0);d=b*a;w=e.min(4*d,w);if(d){for(var c=0;c<d;c+=a)this._doProcessBlock(k,c);c=k.splice(0,d);h.sigBytes-=w}return new n.init(c,w)},clone:function(){var d=w.clone.call(this);d._data=this._data.clone();return d},_minBufferSize:0});d.Hasher=
f.extend({cfg:w.extend(),init:function(d){this.cfg=this.cfg.extend(d);this.reset()},reset:function(){f.reset.call(this);this._doReset()},update:function(d){this._append(d);this._process();return this},finalize:function(d){d&&this._append(d);return this._doFinalize()},blockSize:16,_createHelper:function(d){return function(e,h){return(new d.init(h)).finalize(e)}},_createHmacHelper:function(d){return function(e,h){return(new l.HMAC.init(d,h)).finalize(e)}}});var l=h.algo={};return h}(Math);q.CryptoJS=
Yb;var Gd=a.CryptoJS;(function(e){var k=Gd.lib,h=k.WordArray,d=k.Hasher,k=Gd.algo,w=[],n=[];(function(){function d(h){for(var k=e.sqrt(h),n=2;n<=k;n++)if(!(h%n))return!1;return!0}function h(d){return 4294967296*(d-(d|0))|0}for(var k=2,a=0;64>a;)d(k)&&(8>a&&(w[a]=h(e.pow(k,0.5))),n[a]=h(e.pow(k,1/3)),a++),k++})();var a=[],k=k.SHA256=d.extend({_doReset:function(){this._hash=new h.init(w.slice(0))},_doProcessBlock:function(d,e){for(var h=this._hash.words,k=h[0],w=h[1],b=h[2],c=h[3],g=h[4],f=h[5],l=h[6],
m=h[7],p=0;64>p;p++){if(16>p)a[p]=d[e+p]|0;else{var r=a[p-15],q=a[p-2];a[p]=((r<<25|r>>>7)^(r<<14|r>>>18)^r>>>3)+a[p-7]+((q<<15|q>>>17)^(q<<13|q>>>19)^q>>>10)+a[p-16]}r=m+((g<<26|g>>>6)^(g<<21|g>>>11)^(g<<7|g>>>25))+(g&f^~g&l)+n[p]+a[p];q=((k<<30|k>>>2)^(k<<19|k>>>13)^(k<<10|k>>>22))+(k&w^k&b^w&b);m=l;l=f;f=g;g=c+r|0;c=b;b=w;w=k;k=r+q|0}h[0]=h[0]+k|0;h[1]=h[1]+w|0;h[2]=h[2]+b|0;h[3]=h[3]+c|0;h[4]=h[4]+g|0;h[5]=h[5]+f|0;h[6]=h[6]+l|0;h[7]=h[7]+m|0},_doFinalize:function(){var d=this._data,h=d.words,
k=8*this._nDataBytes,n=8*d.sigBytes;h[n>>>5]|=128<<24-n%32;h[(n+64>>>9<<4)+14]=e.floor(k/4294967296);h[(n+64>>>9<<4)+15]=k;d.sigBytes=4*h.length;this._process();return this._hash},clone:function(){var e=d.clone.call(this);e._hash=this._hash.clone();return e}});Gd.SHA256=d._createHelper(k);Gd.HmacSHA256=d._createHmacHelper(k)})(Math);q.CryptoJS=Gd;(function(){var e=Yb,k=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,d){e=this._hasher=new e.init;"string"==typeof d&&(d=k.parse(d));var w=e.blockSize,
n=4*w;d.sigBytes>n&&(d=e.finalize(d));d.clamp();for(var a=this._oKey=d.clone(),b=this._iKey=d.clone(),c=a.words,g=b.words,f=0;f<w;f++)c[f]^=1549556828,g[f]^=909522486;a.sigBytes=b.sigBytes=n;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var d=this._hasher;e=d.finalize(e);d.reset();return d.finalize(this._oKey.clone().concat(e))}})})();var Wb="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
Bd="=";q.b64tohex=t;q.b64toBA=function(e){e=t(e);var k,h=[];for(k=0;2*k<e.length;++k)h[k]=parseInt(e.substring(2*k,2*k+2),16);return h};q.hex2b64=function(e){var k,h,d="";for(k=0;k+3<=e.length;k+=3)h=parseInt(e.substring(k,k+3),16),d+=Wb.charAt(h>>6)+Wb.charAt(h&63);k+1==e.length?(h=parseInt(e.substring(k,k+1),16),d+=Wb.charAt(h<<2)):k+2==e.length&&(h=parseInt(e.substring(k,k+2),16),d+=Wb.charAt(h>>2)+Wb.charAt((h&3)<<4));if(Bd)for(;0<(d.length&3);)d+=Bd;return d};J.prototype.init=function(e){var k,
h,d;for(k=0;256>k;++k)this.S[k]=k;for(k=h=0;256>k;++k)h=h+this.S[k]+e[k%e.length]&255,d=this.S[k],this.S[k]=this.S[h],this.S[h]=d;this.j=this.i=0};J.prototype.next=function(){var e;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;e=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=e;return this.S[e+this.S[this.i]&255]};var Cd=256,xc,Bb,Oa;if(null==Bb){Bb=[];Oa=0;var Zc;if("Netscape"==navigator.appName&&"5">navigator.appVersion&&window.crypto){var ic=window.crypto.random(32);for(Zc=0;Zc<
ic.length;++Zc)Bb[Oa++]=ic.charCodeAt(Zc)&255}for(;Oa<Cd;)Zc=Math.floor(65536*Math.random()),Bb[Oa++]=Zc>>>8,Bb[Oa++]=Zc&255;Oa=0;T()}U.prototype.nextBytes=function(e){var k;for(k=0;k<e.length;++k){var h=e,d=k,w;if(null==xc){T();xc=new J;xc.init(Bb);for(Oa=0;Oa<Bb.length;++Oa)Bb[Oa]=0;Oa=0}w=xc.next();h[d]=w}};var jc=a,Pb=20;B.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)};B.prototype.setPublic=function(e,k){this.isPublic=!0;"string"!==typeof e?(this.n=e,this.e=k):null!=e&&null!=
k&&0<e.length&&0<k.length?(this.n=X(e,16),this.e=parseInt(k,16)):alert("Invalid RSA public key")};B.prototype.encrypt=function(e){var k;k=this.n.bitLength()+7>>3;if(k<e.length+11)alert("Message too long for RSA"),k=null;else{for(var h=[],d=e.length-1;0<=d&&0<k;){var w=e.charCodeAt(d--);128>w?h[--k]=w:127<w&&2048>w?(h[--k]=w&63|128,h[--k]=w>>6|192):(h[--k]=w&63|128,h[--k]=w>>6&63|128,h[--k]=w>>12|224)}h[--k]=0;e=new U;for(d=[];2<k;){for(d[0]=0;0==d[0];)e.nextBytes(d);h[--k]=d[0]}h[--k]=2;h[--k]=0;
k=new A(h)}if(null==k)return null;k=this.doPublic(k);if(null==k)return null;k=k.toString(16);return 0==(k.length&1)?k:"0"+k};B.prototype.encryptOAEP=function(e,k){var h,d=this.n.bitLength()+7>>3;if(e.length+2*Pb+2>d)throw"Message too long for RSA";var w="";for(h=0;h<d-e.length-2*Pb-2;h+=1)w+="\x00";var n=rstr_sha1("")+w+"\u0001"+e,d=Array(Pb);(new U).nextBytes(d);var a=K(d,n.length,k||rstr_sha1),w=[];for(h=0;h<n.length;h+=1)w[h]=n.charCodeAt(h)^a.charCodeAt(h);n=K(w,d.length,rstr_sha1);a=[0];for(h=
0;h<d.length;h+=1)a[h+1]=d[h]^n.charCodeAt(h);h=new A(a.concat(w));if(null==h)return null;h=this.doPublic(h);if(null==h)return null;h=h.toString(16);return 0==(h.length&1)?h:"0"+h};B.prototype.type="RSA";q.RSAKey=B;var jc=a,A=jc.BigInteger?jc.BigInteger:jc,B=a.RSAKey,Pb=20;B.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);var k=e.mod(this.p).modPow(this.dmp1,this.p);for(e=e.mod(this.q).modPow(this.dmq1,this.q);0>k.compareTo(e);)k=k.add(this.p);return k.subtract(e).multiply(this.coeff).mod(this.p).multiply(this.q).add(e)};
B.prototype.setPrivate=function(e,k,h){this.isPrivate=!0;"string"!==typeof e?(this.n=e,this.e=k,this.d=h):null!=e&&null!=k&&0<e.length&&0<k.length?(this.n=X(e,16),this.e=parseInt(k,16),this.d=X(h,16)):alert("Invalid RSA private key")};B.prototype.setPrivateEx=function(e,k,h,d,w,n,a,b){this.isPrivate=!0;if(null==e)throw"RSASetPrivateEx N == null";if(null==k)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==k.length)throw"RSASetPrivateEx E.length == 0";null!=
e&&null!=k&&0<e.length&&0<k.length?(this.n=X(e,16),this.e=parseInt(k,16),this.d=X(h,16),this.p=X(d,16),this.q=X(w,16),this.dmp1=X(n,16),this.dmq1=X(a,16),this.coeff=X(b,16)):alert("Invalid RSA private key in RSASetPrivateEx")};B.prototype.generate=function(e,k){var h=new U,d=e>>1;this.e=parseInt(k,16);for(var w=new A(k,16);;){for(;this.p=new A(e-d,1,h),0!=this.p.subtract(A.ONE).gcd(w).compareTo(A.ONE)||!this.p.isProbablePrime(10););for(;this.q=new A(d,1,h),0!=this.q.subtract(A.ONE).gcd(w).compareTo(A.ONE)||
!this.q.isProbablePrime(10););if(0>=this.p.compareTo(this.q)){var n=this.p;this.p=this.q;this.q=n}var n=this.p.subtract(A.ONE),a=this.q.subtract(A.ONE),b=n.multiply(a);if(0==b.gcd(w).compareTo(A.ONE)){this.n=this.p.multiply(this.q);this.d=w.modInverse(b);this.dmp1=this.d.mod(n);this.dmq1=this.d.mod(a);this.coeff=this.q.modInverse(this.p);break}}this.isPrivate=!0};B.prototype.decrypt=function(e){e=X(e,16);e=this.doPrivate(e);if(null==e)return null;a:{var k=this.n.bitLength()+7>>3;e=e.toByteArray();
for(var h=0;h<e.length&&0==e[h];)++h;if(e.length-h!=k-1||2!=e[h])e=null;else{for(++h;0!=e[h];)if(++h>=e.length){e=null;break a}for(k="";++h<e.length;){var d=e[h]&255;128>d?k+=String.fromCharCode(d):191<d&&224>d?(k+=String.fromCharCode((d&31)<<6|e[h+1]&63),++h):(k+=String.fromCharCode((d&15)<<12|(e[h+1]&63)<<6|e[h+2]&63),h+=2)}e=k}}return e};B.prototype.decryptOAEP=function(e,k){var h=X(e,16),h=this.doPrivate(h);if(null==h)return null;for(var d=h,w=this.n.bitLength()+7>>3,d=d.toByteArray(),h=0;h<d.length;h+=
1)d[h]&=255;for(;d.length<w;)d.unshift(0);d=String.fromCharCode.apply(String,d);if(d.length<2*Pb+2)throw"Cipher too short";for(var n=d.substr(1,Pb),w=d.substr(Pb+1),a=Nd(w,Pb,k||rstr_sha1),b=[],h=0;h<n.length;h+=1)b[h]=n.charCodeAt(h)^a.charCodeAt(h);n=Nd(String.fromCharCode.apply(String,b),d.length-Pb,rstr_sha1);d=[];for(h=0;h<w.length;h+=1)d[h]=w.charCodeAt(h)^n.charCodeAt(h);d=String.fromCharCode.apply(String,d);if(d.substr(0,Pb)!==rstr_sha1(""))throw"Hash mismatch";d=d.substr(Pb);h=d.indexOf("\u0001");
if((-1!=h?d.substr(0,h).lastIndexOf("\x00"):-1)+1!=h)throw"Malformed data";return d.substr(h+1)};q.RSAKey=B;Yb=a.CryptoJS;jc=a;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",
md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"};this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",
SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",
SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"};this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"};this.getDigestInfoHex=function(e,k){if("undefined"==typeof this.DIGESTINFOHEAD[k])throw"alg not supported in Util.DIGESTINFOHEAD: "+
k;return this.DIGESTINFOHEAD[k]+e};this.getPaddedDigestInfoHex=function(e,k,h){var d=this.getDigestInfoHex(e,k);e=h/4;if(d.length+22>e)throw"key is too short for SigAlg: keylen="+h+","+k;k="00"+d;h="";e=e-4-k.length;for(d=0;d<e;d+=2)h+="ff";return"0001"+h+k};this.hashString=function(e,k){return(new N.crypto.MessageDigest({alg:k})).digestString(e)};this.hashHex=function(e,k){return(new N.crypto.MessageDigest({alg:k})).digestHex(e)};this.sha1=function(e){return(new N.crypto.MessageDigest({alg:"sha1",
prov:"cryptojs"})).digestString(e)};this.sha256=function(e){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestString(e)};this.sha256Hex=function(e){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestHex(e)};this.sha512=function(e){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestString(e)};this.sha512Hex=function(e){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestHex(e)};this.md5=function(e){return(new N.crypto.MessageDigest({alg:"md5",
prov:"cryptojs"})).digestString(e)};this.ripemd160=function(e){return(new N.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"})).digestString(e)};this.getCryptoJSMDByName=function(e){}};N.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,h){null!=e&&void 0===h&&(h=N.crypto.Util.DEFAULTPROVIDER[e]);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==h){try{this.md=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e]).create()}catch(d){throw"setAlgAndProvider hash alg set fail alg="+
e+"/"+d;}this.updateString=function(d){this.md.update(d)};this.updateHex=function(d){d=Yb.enc.Hex.parse(d);this.md.update(d)};this.digest=function(){return this.md.finalize().toString(Yb.enc.Hex)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==h){try{this.md=new sjcl.hash.sha256}catch(w){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+w;}this.updateString=function(d){this.md.update(d)};
this.updateHex=function(d){d=sjcl.codec.hex.toBits(d);this.md.update(d)};this.digest=function(){var d=this.md.finalize();return sjcl.codec.hex.fromBits(d)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+
this.algName+"/"+this.provName;};this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName;};void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),
this.setAlgAndProvider(this.algName,this.provName))};N.crypto.Mac=function(e){this.setAlgAndProvider=function(e,h){e=e.toLowerCase();null==e&&(e="hmacsha1");e=e.toLowerCase();if("hmac"!=e.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===h&&(h=N.crypto.Util.DEFAULTPROVIDER[e]);this.algProv=e+"/"+h;var d=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(d)&&"cryptojs"==h){try{var w=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[d]);this.mac=Yb.algo.HMAC.create(w,
this.pass)}catch(n){throw"setAlgAndProvider hash alg set fail hashAlg="+d+"/"+n;}this.updateString=function(d){this.mac.update(d)};this.updateHex=function(d){d=Yb.enc.Hex.parse(d);this.mac.update(d)};this.doFinal=function(){return this.mac.finalize().toString(Yb.enc.Hex)};this.doFinalString=function(d){this.updateString(d);return this.doFinal()};this.doFinalHex=function(d){this.updateHex(d);return this.doFinal()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+
this.algProv;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv;};this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv;};this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv;};this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv;};this.setPassword=function(e){if("string"==typeof e){var h=e;1!=e.length%2&&e.match(/^[0-9A-Fa-f]+$/)||
(h=rstrtohex(e))}else{if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;h=null;if(void 0!==e.hex){if(0!=e.hex.length%2||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;h=e.hex}void 0!==e.utf8&&(h=utf8tohex(e.utf8));void 0!==e.rstr&&(h=rstrtohex(e.rstr));void 0!==e.b64&&(h=t(e.b64));void 0!==e.b64u&&(h=b64utohex(e.b64u));if(null==h)throw"KJUR.crypto.Mac unsupported password type: "+e;}this.pass=Yb.enc.Hex.parse(h)};void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),
void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))};N.crypto.Signature=function(e){var k=null;this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())};this._zeroPaddingOfSignature=function(d,e){for(var h="",k=e/4-d.length,a=0;a<k;a++)h+="0";return h+d};this.setAlgAndProvider=function(d,e){this._setAlgNames();
if("cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new N.crypto.MessageDigest({alg:this.mdAlgName})}catch(h){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+h;}this.init=function(d,e){var h=null;try{h=void 0===e?KEYUTIL.getKey(d):KEYUTIL.getKey(d,e)}catch(k){throw"init failed:"+k;}if(!0===h.isPrivate)this.prvKey=h,this.state="SIGN";else if(!0===h.isPublic)this.pubKey=h,this.state=
"VERIFY";else throw"init failed.:"+h;};this.initSign=function(d){"string"==typeof d.ecprvhex&&"string"==typeof d.eccurvename?(this.ecprvhex=d.ecprvhex,this.eccurvename=d.eccurvename):this.prvKey=d;this.state="SIGN"};this.initVerifyByPublicKey=function(d){"string"==typeof d.ecpubhex&&"string"==typeof d.eccurvename?(this.ecpubhex=d.ecpubhex,this.eccurvename=d.eccurvename):d instanceof N.crypto.ECDSA?this.pubKey=d:d instanceof B&&(this.pubKey=d);this.state="VERIFY"};this.initVerifyByCertificatePEM=function(d){var e=
new fa;e.readCertPEM(d);this.pubKey=e.subjectPublicKeyRSA;this.state="VERIFY"};this.updateString=function(d){this.md.updateString(d)};this.updateHex=function(d){this.md.updateHex(d)};this.sign=function(){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename)this.hSign=(new N.crypto.ECDSA({curve:this.eccurvename})).signHex(this.sHashHex,this.ecprvhex);else if(this.prvKey instanceof B&&"rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,
this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof B&&"rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof N.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else if(this.prvKey instanceof N.crypto.DSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;return this.hSign};this.signString=function(d){this.updateString(d);
return this.sign()};this.signHex=function(d){this.updateHex(d);return this.sign()};this.verify=function(d){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return(new N.crypto.ECDSA({curve:this.eccurvename})).verifyHex(this.sHashHex,d,this.ecpubhex);if(this.pubKey instanceof B&&"rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,d,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof B&&"rsa"==this.pubkeyAlgName||
this.pubKey instanceof N.crypto.ECDSA||this.pubKey instanceof N.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,d);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;}}};this.init=function(d,e){throw"init(key, pass) not supported for this alg:prov="+this.algProvName;};this.initVerifyByPublicKey=function(d){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName;};this.initVerifyByCertificatePEM=function(d){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+
this.algProvName;};this.initSign=function(d){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName;};this.updateString=function(d){throw"updateString(str) not supported for this alg:prov="+this.algProvName;};this.updateHex=function(d){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName;};this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName;};this.signString=function(d){throw"digestString(str) not supported for this alg:prov="+
this.algProvName;};this.signHex=function(d){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName;};this.verify=function(d){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName;};this.initParams=e;if(void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,this.provName=void 0===e.prov?N.crypto.Util.DEFAULTPROVIDER[this.algName]:e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&
(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{k=new B,k.readPrivateKeyFromPEMString(e.prvkeypem),this.initSign(k)}catch(h){throw"fatal error to load pem private key: "+h;}}};N.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1",
"2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}};q.KJUR=N;var H=a.ASN1HEX,t=a.b64tohex,B=a.RSAKey;B.prototype.readPrivateKeyFromPEMString=function(e){e=e.replace("-----BEGIN RSA PRIVATE KEY-----","");e=e.replace("-----END RSA PRIVATE KEY-----","");e=e.replace(/[ \n]+/g,"");e=t(e);e=od(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};B.prototype.readPrivateKeyFromASN1HexString=
function(e){e=od(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};q.RSAKey=B;var jc=a,A=jc.BigInteger?jc.BigInteger:jc,B=a.RSAKey,Pd=RegExp("");Pd.compile("[^0-9a-f]","gi");B.prototype.signWithMessageHash=function(e,k){var h=N.crypto.Util.getPaddedDigestInfoHex(e,k,this.n.bitLength()),h=X(h,16),h=this.doPrivate(h).toString(16);return Ib(h,this.n.bitLength())};B.prototype.signString=Od;B.prototype.signStringWithSHA1=oe;B.prototype.signStringWithSHA256=pe;B.prototype.sign=Od;B.prototype.signWithSHA1=
oe;B.prototype.signWithSHA256=pe;B.prototype.signWithMessageHashPSS=function(e,k,h){var d=hextorstr(e);e=d.length;var w=this.n.bitLength()-1,n=Math.ceil(w/8),a=function(d){return N.crypto.Util.hashHex(d,k)};if(-1===h||void 0===h)h=e;else if(-2===h)h=n-e-2;else if(-2>h)throw"invalid salt length";if(n<e+h+2)throw"data too long";var b="";0<h&&(b=Array(h),(new U).nextBytes(b),b=String.fromCharCode.apply(String,b));for(var c=hextorstr(a(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+d+b))),g=[],d=0;d<n-
h-e-2;d+=1)g[d]=0;h=String.fromCharCode.apply(String,g)+"\u0001"+b;a=qe(c,h.length,a);b=[];for(d=0;d<h.length;d+=1)b[d]=h.charCodeAt(d)^a.charCodeAt(d);b[0]&=~(65280>>8*n-w&255);for(d=0;d<e;d++)b.push(c.charCodeAt(d));b.push(188);return Ib(this.doPrivate(new A(b)).toString(16),this.n.bitLength())};B.prototype.signStringPSS=re;B.prototype.signPSS=re;B.SALT_LEN_HLEN=-1;B.SALT_LEN_MAX=-2;B.prototype.verifyWithMessageHash=function(e,k){k=k.replace(Pd,"");k=k.replace(/[ \n]+/g,"");var h=X(k,16);if(h.bitLength()>
this.n.bitLength())return 0;h=this.doPublic(h).toString(16).replace(/^1f+00/,"");h=Yd(h);return 0==h.length?!1:h[1]==e};B.prototype.verifyString=Dd;B.prototype.verifyHexSignatureForMessage=pd;B.prototype.verify=Dd;B.prototype.verifyHexSignatureForByteArrayMessage=pd;B.prototype.verifyWithMessageHashPSS=function(e,k,h,d){var w=new A(k,16);if(w.bitLength()>this.n.bitLength())return!1;k=function(d){return N.crypto.Util.hashHex(d,h)};e=hextorstr(e);var n=e.length,a=this.n.bitLength()-1,b=Math.ceil(a/
8);if(-1===d||void 0===d)d=n;else if(-2===d)d=b-n-2;else if(-2>d)throw"invalid salt length";if(b<n+d+2)throw"data too long";for(var c=this.doPublic(w).toByteArray(),w=0;w<c.length;w+=1)c[w]&=255;for(;c.length<b;)c.unshift(0);if(188!==c[b-1])throw"encoded message does not end in 0xbc";var c=String.fromCharCode.apply(String,c),g=c.substr(0,b-n-1),c=c.substr(g.length,n),f=65280>>8*b-a&255;if(0!==(g.charCodeAt(0)&f))throw"bits beyond keysize not zero";for(var l=qe(c,g.length,k),a=[],w=0;w<g.length;w+=
1)a[w]=g.charCodeAt(w)^l.charCodeAt(w);a[0]&=~f;n=b-n-d-2;for(w=0;w<n;w+=1)if(0!==a[w])throw"leftmost octets not zero";if(1!==a[n])throw"0x01 marker not found";return c===hextorstr(k(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+e+String.fromCharCode.apply(String,a.slice(-d)))))};B.prototype.verifyStringPSS=Zd;B.prototype.verifyPSS=Zd;B.SALT_LEN_RECOVER=-2;q.RSAKey=B;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.ECDSA=function(e){var k=new U;this.type=
"EC";this.getBigRandom=function(e){return(new A(e.bitLength(),k)).mod(e.subtract(A.ONE)).add(A.ONE)};this.setNamedCurve=function(e){this.ecparams=N.crypto.ECParameterDB.getByName(e);this.pubKeyHex=this.prvKeyHex=null;this.curveName=e};this.setPrivateKeyHex=function(e){this.isPrivate=!0;this.prvKeyHex=e};this.setPublicKeyHex=function(e){this.isPublic=!0;this.pubKeyHex=e};this.generateKeyPairHex=function(){var e=this.getBigRandom(this.ecparams.n),d=this.ecparams.G.multiply(e),k=d.getX().toBigInteger(),
d=d.getY().toBigInteger(),n=this.ecparams.keylen/4,e=("0000000000"+e.toString(16)).slice(-n),k=("0000000000"+k.toString(16)).slice(-n),d=("0000000000"+d.toString(16)).slice(-n),k="04"+k+d;this.setPrivateKeyHex(e);this.setPublicKeyHex(k);return{ecprvhex:e,ecpubhex:k}};this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)};this.signHex=function(e,d){var k=new A(d,16),n=this.ecparams.n,a=new A(e,16);do var b=this.getBigRandom(n),c=this.ecparams.G.multiply(b).getX().toBigInteger().mod(n);
while(0>=c.compareTo(A.ZERO));k=b.modInverse(n).multiply(a.add(k.multiply(c))).mod(n);return N.crypto.ECDSA.biRSSigToASN1Sig(c,k)};this.sign=function(e,d){var k=this.ecparams.n,n=A.fromByteArrayUnsigned(e);do var a=this.getBigRandom(k),b=this.ecparams.G.multiply(a).getX().toBigInteger().mod(k);while(0>=b.compareTo(A.ZERO));k=a.modInverse(k).multiply(n.add(d.multiply(b))).mod(k);return this.serializeSig(b,k)};this.verifyWithMessageHash=function(e,d){return this.verifyHex(e,d,this.pubKeyHex)};this.verifyHex=
function(e,d,k){var n;n=N.crypto.ECDSA.parseSigHex(d);d=n.r;n=n.s;k=ECPointFp.decodeFromHex(this.ecparams.curve,k);e=new A(e,16);return this.verifyRaw(e,d,n,k)};this.verify=function(e,d,k){var n;if(Bitcoin.Util.isArray(d))d=this.parseSig(d),n=d.r,d=d.s;else if("object"===typeof d&&d.r&&d.s)n=d.r,d=d.s;else throw"Invalid value for signature";if(!(k instanceof ECPointFp))if(Bitcoin.Util.isArray(k))k=ECPointFp.decodeFrom(this.ecparams.curve,k);else throw"Invalid format for pubkey value, must be byte array or ECPointFp";
e=A.fromByteArrayUnsigned(e);return this.verifyRaw(e,n,d,k)};this.verifyRaw=function(e,d,k,n){var a=this.ecparams.n,b=this.ecparams.G;if(0>d.compareTo(A.ONE)||0<=d.compareTo(a)||0>k.compareTo(A.ONE)||0<=k.compareTo(a))return!1;k=k.modInverse(a);e=e.multiply(k).mod(a);k=d.multiply(k).mod(a);return b.multiply(e).add(n.multiply(k)).getX().toBigInteger().mod(a).equals(d)};this.serializeSig=function(e,d){var k=e.toByteArraySigned(),n=d.toByteArraySigned(),a=[];a.push(2);a.push(k.length);a=a.concat(k);
a.push(2);a.push(n.length);a=a.concat(n);a.unshift(a.length);a.unshift(48);return a};this.parseSig=function(e){var d;if(48!=e[0])throw Error("Signature not a valid DERSequence");d=2;if(2!=e[d])throw Error("First element in signature must be a DERInteger");var k=e.slice(d+2,d+2+e[d+1]);d+=2+e[d+1];if(2!=e[d])throw Error("Second element in signature must be a DERInteger");e=e.slice(d+2,d+2+e[d+1]);k=A.fromByteArrayUnsigned(k);e=A.fromByteArrayUnsigned(e);return{r:k,s:e}};this.parseSigCompact=function(e){if(65!==
e.length)throw"Signature has the wrong length";var d=e[0]-27;if(0>d||7<d)throw"Invalid signature type";var k=this.ecparams.n,n=A.fromByteArrayUnsigned(e.slice(1,33)).mod(k);e=A.fromByteArrayUnsigned(e.slice(33,65)).mod(k);return{r:n,s:e,i:d}};void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve);void 0===this.curveName&&(this.curveName="secp256r1");this.setNamedCurve(this.curveName);void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))};N.crypto.ECDSA.parseSigHex=
function(e){var k=N.crypto.ECDSA.parseSigHexInHexRS(e);e=new A(k.r,16);k=new A(k.s,16);return{r:e,s:k}};N.crypto.ECDSA.parseSigHexInHexRS=function(e){if("30"!=e.substr(0,2))throw"signature is not a ASN.1 sequence";var k=H.getPosArrayOfChildren_AtObj(e,0);if(2!=k.length)throw"number of signature ASN.1 sequence elements seem wrong";var h=k[0],k=k[1];if("02"!=e.substr(h,2))throw"1st item of sequene of signature is not ASN.1 integer";if("02"!=e.substr(k,2))throw"2nd item of sequene of signature is not ASN.1 integer";
h=H.getHexOfV_AtObj(e,h);e=H.getHexOfV_AtObj(e,k);return{r:h,s:e}};N.crypto.ECDSA.asn1SigToConcatSig=function(e){var k=N.crypto.ECDSA.parseSigHexInHexRS(e);e=k.r;k=k.s;"00"==e.substr(0,2)&&8==e.length/2*8%128&&(e=e.substr(2));"00"==k.substr(0,2)&&8==k.length/2*8%128&&(k=k.substr(2));if(0!=e.length/2*8%128)throw"unknown ECDSA sig r length error";if(0!=k.length/2*8%128)throw"unknown ECDSA sig s length error";return e+k};N.crypto.ECDSA.concatSigToASN1Sig=function(e){if(0!=e.length/2*8%128)throw"unknown ECDSA concatinated r-s sig  length error";
var k=e.substr(0,e.length/2);e=e.substr(e.length/2);return N.crypto.ECDSA.hexRSSigToASN1Sig(k,e)};N.crypto.ECDSA.hexRSSigToASN1Sig=function(e,k){var h=new A(e,16),d=new A(k,16);return N.crypto.ECDSA.biRSSigToASN1Sig(h,d)};N.crypto.ECDSA.biRSSigToASN1Sig=function(e,k){var h=new N.asn1.DERInteger({bigint:e}),d=new N.asn1.DERInteger({bigint:k});return(new N.asn1.DERSequence({array:[h,d]})).getEncodedHex()};jc=a;H=new function(){this.getByteLengthOfL_AtObj=function(e,k){if("8"!=e.substring(k+2,k+3))return 1;
var h=parseInt(e.substring(k+3,k+4));return 0==h?-1:0<h&&10>h?h+1:-2};this.getHexOfL_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 1>h?"":e.substring(k+2,k+2+2*h)};this.getIntOfL_AtObj=function(e,k){var h=this.getHexOfL_AtObj(e,k);return""==h?-1:(8>parseInt(h.substring(0,1))?new A(h,16):new A(h.substring(2),16)).intValue()};this.getStartPosOfV_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 0>h?h:k+2*(h+1)};this.getHexOfV_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,
k),d=this.getIntOfL_AtObj(e,k);return e.substring(h,h+2*d)};this.getHexOfTLV_AtObj=function(e,k){var h=e.substr(k,2),d=this.getHexOfL_AtObj(e,k),w=this.getHexOfV_AtObj(e,k);return h+d+w};this.getPosOfNextSibling_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,k),d=this.getIntOfL_AtObj(e,k);return h+2*d};this.getPosArrayOfChildren_AtObj=function(e,k){var h=[],d=this.getStartPosOfV_AtObj(e,k);h.push(d);for(var w=this.getIntOfL_AtObj(e,k),n=d,a=0;;){n=this.getPosOfNextSibling_AtObj(e,n);if(null==
n||n-d>=2*w)break;if(200<=a)break;h.push(n);a++}return h};this.getNthChildIndex_AtObj=function(e,k,h){return this.getPosArrayOfChildren_AtObj(e,k)[h]};this.getDecendantIndexByNthList=function(e,k,h){if(0==h.length)return k;var d=h.shift();k=this.getPosArrayOfChildren_AtObj(e,k);return this.getDecendantIndexByNthList(e,k[d],h)};this.getDecendantHexTLVByNthList=function(e,k,h){k=this.getDecendantIndexByNthList(e,k,h);return this.getHexOfTLV_AtObj(e,k)};this.getDecendantHexVByNthList=function(e,k,h){k=
this.getDecendantIndexByNthList(e,k,h);return this.getHexOfV_AtObj(e,k)}};H.getVbyList=function(e,k,h,d){k=this.getDecendantIndexByNthList(e,k,h);if(void 0===k)throw"can't find nthList object";if(void 0!==d&&e.substr(k,2)!=d)throw"checking tag doesn't match: "+e.substr(k,2)+"!="+d;return this.getHexOfV_AtObj(e,k)};H.hextooidstr=function(e){var k=function(d,e){return d.length>=e?d:Array(e-d.length+1).join("0")+d},h=[],d=e.substr(0,2),d=parseInt(d,16);h[0]=new String(Math.floor(d/40));h[1]=new String(d%
40);var w=e.substr(2);e=[];for(d=0;d<w.length/2;d++)e.push(parseInt(w.substr(2*d,2),16));for(var w=[],n="",d=0;d<e.length;d++)e[d]&128?n+=k((e[d]&127).toString(2),7):(n+=k((e[d]&127).toString(2),7),w.push(new String(parseInt(n,2))),n="");k=h.join(".");0<w.length&&(k=k+"."+w.join("."));return k};H.dump=function(e,k,h,d){var w=function(d,e){return d.length<=2*e?d:d.substr(0,e)+"..(total "+d.length/2+"bytes).."+d.substr(d.length-e,e)};void 0===k&&(k={ommit_long_octet:32});void 0===h&&(h=0);void 0===
d&&(d="");var n=k.ommit_long_octet;if("01"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),"00"==e?d+"BOOLEAN FALSE\n":d+"BOOLEAN TRUE\n";if("02"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),d+"INTEGER "+w(e,n)+"\n";if("03"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),d+"BITSTRING "+w(e,n)+"\n";if("04"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),H.isASN1HEX(e)?w=d+"OCTETSTRING, encapsulates\n"+H.dump(e,k,0,d+"  "):d+"OCTETSTRING "+w(e,n)+"\n";if("05"==e.substr(h,2))return d+"NULL\n";if("06"==
e.substr(h,2)){e=H.getHexOfV_AtObj(e,h);var a=N.asn1.ASN1Util.oidHexToInt(e),n=N.asn1.x509.OID.oid2name(a);e=a.replace(/\./g," ");return""!=n?d+"ObjectIdentifier "+n+" ("+e+")\n":d+"ObjectIdentifier ("+e+")\n"}if("0c"==e.substr(h,2))return d+"UTF8String '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("13"==e.substr(h,2))return d+"PrintableString '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("14"==e.substr(h,2))return d+"TeletexString '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("16"==e.substr(h,2))return d+
"IA5String '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("17"==e.substr(h,2))return d+"UTCTime "+hextoutf8(H.getHexOfV_AtObj(e,h))+"\n";if("18"==e.substr(h,2))return d+"GeneralizedTime "+hextoutf8(H.getHexOfV_AtObj(e,h))+"\n";if("30"==e.substr(h,2)){if("3000"==e.substr(h,4))return d+"SEQUENCE {}\n";w=d+"SEQUENCE\n";h=H.getPosArrayOfChildren_AtObj(e,h);n=k;2!=h.length&&3!=h.length||"06"!=e.substr(h[0],2)||"04"!=e.substr(h[h.length-1],2)||(n=H.getHexOfV_AtObj(e,h[0]),a=N.asn1.ASN1Util.oidHexToInt(n),
n=N.asn1.x509.OID.oid2name(a),k=JSON.parse(JSON.stringify(k)),k.x509ExtName=n,n=k);for(a=0;a<h.length;a++)w+=H.dump(e,n,h[a],d+"  ");return w}if("31"==e.substr(h,2)){w=d+"SET\n";h=H.getPosArrayOfChildren_AtObj(e,h);for(a=0;a<h.length;a++)w+=H.dump(e,k,h[a],d+"  ");return w}n=parseInt(e.substr(h,2),16);if(0!=(n&128)){w=n&31;if(0!=(n&32))for(w=d+"["+w+"]\n",h=H.getPosArrayOfChildren_AtObj(e,h),a=0;a<h.length;a++)w+=H.dump(e,k,h[a],d+"  ");else e=H.getHexOfV_AtObj(e,h),"68747470"==e.substr(0,8)&&(e=
hextoutf8(e)),"subjectAltName"===k.x509ExtName&&2==w&&(e=hextoutf8(e)),w=d+"["+w+"] "+e+"\n";return w}return d+"UNKNOWN("+e.substr(h,2)+") "+H.getHexOfV_AtObj(e,h)+"\n"};H.isASN1HEX=function(e){if(1==e.length%2)return!1;var k=H.getIntOfL_AtObj(e,0),h=e.substr(0,2),d=H.getHexOfL_AtObj(e,0);return e.length-h.length-d.length==2*k?!0:!1};q.ASN1HEX=H;t=a.b64tohex;B=a.RSAKey;H=a.ASN1HEX;fa.pemToBase64=function(e){e=e.replace("-----BEGIN CERTIFICATE-----","");e=e.replace("-----END CERTIFICATE-----","");
return e=e.replace(/[ \n]+/g,"")};fa.pemToHex=function(e){e=fa.pemToBase64(e);return t(e)};fa.getSubjectPublicKeyPosFromCertHex=function(e){var k=fa.getSubjectPublicKeyInfoPosFromCertHex(e);if(-1==k)return-1;k=H.getPosArrayOfChildren_AtObj(e,k);if(2!=k.length)return-1;k=k[1];if("03"!=e.substring(k,k+2))return-1;k=H.getStartPosOfV_AtObj(e,k);return"00"!=e.substring(k,k+2)?-1:k+2};fa.getSubjectPublicKeyInfoPosFromCertHex=function(e){var k=H.getStartPosOfV_AtObj(e,0),k=H.getPosArrayOfChildren_AtObj(e,
k);return 1>k.length?-1:"a003020102"==e.substring(k[0],k[0]+10)?6>k.length?-1:k[6]:5>k.length?-1:k[5]};fa.getPublicKeyHexArrayFromCertHex=function(e){var k=fa.getSubjectPublicKeyPosFromCertHex(e),h=H.getPosArrayOfChildren_AtObj(e,k);if(2!=h.length)return[];k=H.getHexOfV_AtObj(e,h[0]);e=H.getHexOfV_AtObj(e,h[1]);return null!=k&&null!=e?[k,e]:[]};fa.getHexTbsCertificateFromCert=function(e){return H.getStartPosOfV_AtObj(e,0)};fa.getPublicKeyHexArrayFromCertPEM=function(e){e=fa.pemToHex(e);return fa.getPublicKeyHexArrayFromCertHex(e)};
fa.hex2dn=function(e){for(var k="",h=H.getPosArrayOfChildren_AtObj(e,0),d=0;d<h.length;d++)var w=H.getHexOfTLV_AtObj(e,h[d]),k=k+"/"+fa.hex2rdn(w);return k};fa.hex2rdn=function(e){var k=H.getDecendantHexTLVByNthList(e,0,[0,0]),h=H.getDecendantHexVByNthList(e,0,[0,1]);e="";try{e=fa.DN_ATTRHEX[k]}catch(d){e=k}h=h.replace(/(..)/g,"%$1");k=decodeURIComponent(h);return e+"="+k};fa.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"};
fa.getPublicKeyFromCertPEM=function(e){var k=fa.getPublicKeyInfoPropOfCertPEM(e);if("2a864886f70d010101"==k.algoid){var h=KEYUTIL.parsePublicRawRSAKeyHex(k.keyhex);e=new B;e.setPublic(h.n,h.e);return e}if("2a8648ce3d0201"==k.algoid)return e=new N.crypto.ECDSA({curve:N.crypto.OID.oidhex2name[k.algparam],info:k.keyhex}),e.setPublicKeyHex(k.keyhex),e;if("2a8648ce380401"==k.algoid){var h=H.getVbyList(k.algparam,0,[0],"02"),d=H.getVbyList(k.algparam,0,[1],"02"),w=H.getVbyList(k.algparam,0,[2],"02"),k=
H.getHexOfV_AtObj(k.keyhex,0),k=k.substr(2);e=new N.crypto.DSA;e.setPublic(new A(h,16),new A(d,16),new A(w,16),new A(k,16));return e}throw"unsupported key";};fa.getPublicKeyInfoPropOfCertPEM=function(e){var k={algparam:null};e=fa.pemToHex(e);var h=H.getPosArrayOfChildren_AtObj(e,0);if(3!=h.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(h[0],2))throw"malformed X.509 certificate PEM (code:002)";h=H.getPosArrayOfChildren_AtObj(e,h[0]);if(7>h.length)throw"malformed X.509 certificate PEM (code:003)";
h=H.getPosArrayOfChildren_AtObj(e,h[6]);if(2!=h.length)throw"malformed X.509 certificate PEM (code:004)";var d=H.getPosArrayOfChildren_AtObj(e,h[0]);if(2!=d.length)throw"malformed X.509 certificate PEM (code:005)";k.algoid=H.getHexOfV_AtObj(e,d[0]);"06"==e.substr(d[1],2)?k.algparam=H.getHexOfV_AtObj(e,d[1]):"30"==e.substr(d[1],2)&&(k.algparam=H.getHexOfTLV_AtObj(e,d[1]));if("03"!=e.substr(h[1],2))throw"malformed X.509 certificate PEM (code:006)";e=H.getHexOfV_AtObj(e,h[1]);k.keyhex=e.substr(2);return k};
fa.getPublicKeyInfoPosOfCertHEX=function(e){var k=H.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:002)";e=H.getPosArrayOfChildren_AtObj(e,k[0]);if(7>e.length)throw"malformed X.509 certificate PEM (code:003)";return e[6]};fa.getV3ExtInfoListOfCertHex=function(e){var k=H.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],
2))throw"malformed X.509 certificate PEM (code:002)";k=H.getPosArrayOfChildren_AtObj(e,k[0]);if(8>k.length)throw"malformed X.509 certificate PEM (code:003)";if("a3"!=e.substr(k[7],2))throw"malformed X.509 certificate PEM (code:004)";k=H.getPosArrayOfChildren_AtObj(e,k[7]);if(1!=k.length)throw"malformed X.509 certificate PEM (code:005)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:006)";for(var k=H.getPosArrayOfChildren_AtObj(e,k[0]),h=k.length,d=Array(h),w=0;w<h;w++)d[w]=
fa.getV3ExtItemInfo_AtObj(e,k[w]);return d};fa.getV3ExtItemInfo_AtObj=function(e,k){var h={};h.posTLV=k;var d=H.getPosArrayOfChildren_AtObj(e,k);if(2!=d.length&&3!=d.length)throw"malformed X.509v3 Ext (code:001)";if("06"!=e.substr(d[0],2))throw"malformed X.509v3 Ext (code:002)";var w=H.getHexOfV_AtObj(e,d[0]);h.oid=H.hextooidstr(w);h.critical=!1;3==d.length&&(h.critical=!0);d=d[d.length-1];if("04"!=e.substr(d,2))throw"malformed X.509v3 Ext (code:003)";h.posV=H.getStartPosOfV_AtObj(e,d);return h};
fa.getHexOfTLV_V3ExtValue=function(e,k){var h=fa.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":H.getHexOfTLV_AtObj(e,h)};fa.getHexOfV_V3ExtValue=function(e,k){var h=fa.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":H.getHexOfV_AtObj(e,h)};fa.getPosOfTLV_V3ExtValue=function(e,k){var h=k;k.match(/^[0-9.]+$/)||(h=N.asn1.x509.OID.name2oid(k));if(""==h)return-1;for(var d=fa.getV3ExtInfoListOfCertHex(e),w=0;w<d.length;w++){var n=d[w];if(n.oid==h)return n.posV}return-1};fa.KEYUSAGE_NAME="digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign encipherOnly decipherOnly".split(" ");
fa.getExtKeyUsageBin=function(e){var k=fa.getHexOfV_V3ExtValue(e,"keyUsage");if(""==k)return"";if(0!=k.length%2||2>=k.length)throw"malformed key usage value";e=parseInt(k.substr(0,2));k=parseInt(k.substr(2),16).toString(2);return k.substr(0,k.length-e)};fa.getExtKeyUsageString=function(e){e=fa.getExtKeyUsageBin(e);for(var k=[],h=0;h<e.length;h++)"1"==e.substr(h,1)&&k.push(fa.KEYUSAGE_NAME[h]);return k.join(",")};fa.getExtAIAInfo=function(e){var k={ocsp:[],caissuer:[]},h=fa.getPosOfTLV_V3ExtValue(e,
"authorityInfoAccess");if(-1==h)return null;if("30"!=e.substr(h,2))throw"malformed AIA Extn Value";for(var h=H.getPosArrayOfChildren_AtObj(e,h),d=0;d<h.length;d++){var w=H.getPosArrayOfChildren_AtObj(e,h[d]);if(2!=w.length)throw"malformed AccessDescription of AIA Extn";var n=w[0],w=w[1];"2b06010505073001"==H.getHexOfV_AtObj(e,n)&&"86"==e.substr(w,2)&&k.ocsp.push(hextoutf8(H.getHexOfV_AtObj(e,w)));"2b06010505073002"==H.getHexOfV_AtObj(e,n)&&"86"==e.substr(w,2)&&k.caissuer.push(hextoutf8(H.getHexOfV_AtObj(e,
w)))}return k};q.X509=fa;var yc,A=function(e,k,h){null!=e&&("number"==typeof e?this.fromNumber(e,k,h):null==k&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,k))};"Microsoft Internet Explorer"==navigator.appName?(A.prototype.am=se,yc=30):"Netscape"!=navigator.appName?(A.prototype.am=Nb,yc=26):(A.prototype.am=$d,yc=28);A.prototype.DB=yc;A.prototype.DM=(1<<yc)-1;A.prototype.DV=1<<yc;A.prototype.FV=Math.pow(2,52);A.prototype.F1=52-yc;A.prototype.F2=2*yc-52;var Xb="0123456789abcdefghijklmnopqrstuvwxyz",
te=[],Kc,Zb;Kc=48;for(Zb=0;9>=Zb;++Zb)te[Kc++]=Zb;Kc=97;for(Zb=10;36>Zb;++Zb)te[Kc++]=Zb;Kc=65;for(Zb=10;36>Zb;++Zb)te[Kc++]=Zb;wc.prototype.convert=function(e){return 0>e.s||0<=e.compareTo(this.m)?e.mod(this.m):e};wc.prototype.revert=function(e){return e};wc.prototype.reduce=function(e){e.divRemTo(this.m,null,e)};wc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};wc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};Pa.prototype.convert=function(e){var k=ia();e.abs().dlShiftTo(this.m.t,
k);k.divRemTo(this.m,null,k);0>e.s&&0<k.compareTo(A.ZERO)&&this.m.subTo(k,k);return k};Pa.prototype.revert=function(e){var k=ia();e.copyTo(k);this.reduce(k);return k};Pa.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var k=0;k<this.m.t;++k){var h=e[k]&32767,d=h*this.mpl+((h*this.mph+(e[k]>>15)*this.mpl&this.um)<<15)&e.DM,h=k+this.m.t;for(e[h]+=this.m.am(0,d,e,k,0,this.m.t);e[h]>=e.DV;)e[h]-=e.DV,e[++h]++}e.clamp();e.drShiftTo(this.m.t,e);0<=e.compareTo(this.m)&&e.subTo(this.m,e)};
Pa.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};Pa.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};A.prototype.copyTo=function(e){for(var k=this.t-1;0<=k;--k)e[k]=this[k];e.t=this.t;e.s=this.s};A.prototype.fromInt=function(e){this.t=1;this.s=0>e?-1:0;0<e?this[0]=e:-1>e?this[0]=e+this.DV:this.t=0};A.prototype.fromString=function(e,k){var h;if(16==k)h=4;else if(8==k)h=3;else if(256==k)h=8;else if(2==k)h=1;else if(32==k)h=5;else if(4==k)h=2;else{this.fromRadix(e,k);return}this.s=
this.t=0;for(var d=e.length,w=!1,n=0;0<=--d;){var a=8==h?e[d]&255:Wc(e,d);0>a?"-"==e.charAt(d)&&(w=!0):(w=!1,0==n?this[this.t++]=a:n+h>this.DB?(this[this.t-1]|=(a&(1<<this.DB-n)-1)<<n,this[this.t++]=a>>this.DB-n):this[this.t-1]|=a<<n,n+=h,n>=this.DB&&(n-=this.DB))}8==h&&0!=(e[0]&128)&&(this.s=-1,0<n&&(this[this.t-1]|=(1<<this.DB-n)-1<<n));this.clamp();w&&A.ZERO.subTo(this,this)};A.prototype.clamp=function(){for(var e=this.s&this.DM;0<this.t&&this[this.t-1]==e;)--this.t};A.prototype.dlShiftTo=function(e,
k){var h;for(h=this.t-1;0<=h;--h)k[h+e]=this[h];for(h=e-1;0<=h;--h)k[h]=0;k.t=this.t+e;k.s=this.s};A.prototype.drShiftTo=function(e,k){for(var h=e;h<this.t;++h)k[h-e]=this[h];k.t=Math.max(this.t-e,0);k.s=this.s};A.prototype.lShiftTo=function(e,k){var h=e%this.DB,d=this.DB-h,w=(1<<d)-1,n=Math.floor(e/this.DB),a=this.s<<h&this.DM,b;for(b=this.t-1;0<=b;--b)k[b+n+1]=this[b]>>d|a,a=(this[b]&w)<<h;for(b=n-1;0<=b;--b)k[b]=0;k[n]=a;k.t=this.t+n+1;k.s=this.s;k.clamp()};A.prototype.rShiftTo=function(e,k){k.s=
this.s;var h=Math.floor(e/this.DB);if(h>=this.t)k.t=0;else{var d=e%this.DB,w=this.DB-d,n=(1<<d)-1;k[0]=this[h]>>d;for(var a=h+1;a<this.t;++a)k[a-h-1]|=(this[a]&n)<<w,k[a-h]=this[a]>>d;0<d&&(k[this.t-h-1]|=(this.s&n)<<w);k.t=this.t-h;k.clamp()}};A.prototype.subTo=function(e,k){for(var h=0,d=0,w=Math.min(e.t,this.t);h<w;)d+=this[h]-e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d-=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d-=e[h],k[h++]=d&this.DM,
d>>=this.DB;d-=e.s}k.s=0>d?-1:0;-1>d?k[h++]=this.DV+d:0<d&&(k[h++]=d);k.t=h;k.clamp()};A.prototype.multiplyTo=function(e,k){var h=this.abs(),d=e.abs(),w=h.t;for(k.t=w+d.t;0<=--w;)k[w]=0;for(w=0;w<d.t;++w)k[w+h.t]=h.am(0,d[w],k,w,0,h.t);k.s=0;k.clamp();this.s!=e.s&&A.ZERO.subTo(k,k)};A.prototype.squareTo=function(e){for(var k=this.abs(),h=e.t=2*k.t;0<=--h;)e[h]=0;for(h=0;h<k.t-1;++h){var d=k.am(h,k[h],e,2*h,0,1);(e[h+k.t]+=k.am(h+1,2*k[h],e,2*h+1,d,k.t-h-1))>=k.DV&&(e[h+k.t]-=k.DV,e[h+k.t+1]=1)}0<
e.t&&(e[e.t-1]+=k.am(h,k[h],e,2*h,0,1));e.s=0;e.clamp()};A.prototype.divRemTo=function(e,k,h){var d=e.abs();if(!(0>=d.t)){var w=this.abs();if(w.t<d.t)null!=k&&k.fromInt(0),null!=h&&this.copyTo(h);else{null==h&&(h=ia());var n=ia(),a=this.s;e=e.s;var b=this.DB-Ed(d[d.t-1]);0<b?(d.lShiftTo(b,n),w.lShiftTo(b,h)):(d.copyTo(n),w.copyTo(h));d=n.t;w=n[d-1];if(0!=w){var c=w*(1<<this.F1)+(1<d?n[d-2]>>this.F2:0),g=this.FV/c,c=(1<<this.F1)/c,f=1<<this.F2,l=h.t,m=l-d,p=null==k?ia():k;n.dlShiftTo(m,p);0<=h.compareTo(p)&&
(h[h.t++]=1,h.subTo(p,h));A.ONE.dlShiftTo(d,p);for(p.subTo(n,n);n.t<d;)n[n.t++]=0;for(;0<=--m;){var r=h[--l]==w?this.DM:Math.floor(h[l]*g+(h[l-1]+f)*c);if((h[l]+=n.am(0,r,h,m,0,d))<r)for(n.dlShiftTo(m,p),h.subTo(p,h);h[l]<--r;)h.subTo(p,h)}null!=k&&(h.drShiftTo(d,k),a!=e&&A.ZERO.subTo(k,k));h.t=d;h.clamp();0<b&&h.rShiftTo(b,h);0>a&&A.ZERO.subTo(h,h)}}}};A.prototype.invDigit=function(){if(1>this.t)return 0;var e=this[0];if(0==(e&1))return 0;var k=e&3,k=k*(2-(e&15)*k)&15,k=k*(2-(e&255)*k)&255,k=k*(2-
((e&65535)*k&65535))&65535,k=k*(2-e*k%this.DV)%this.DV;return 0<k?this.DV-k:-k};A.prototype.isEven=function(){return 0==(0<this.t?this[0]&1:this.s)};A.prototype.exp=function(e,k){if(4294967295<e||1>e)return A.ONE;var h=ia(),d=ia(),w=k.convert(this),n=Ed(e)-1;for(w.copyTo(h);0<=--n;)if(k.sqrTo(h,d),0<(e&1<<n))k.mulTo(d,w,h);else var a=h,h=d,d=a;return k.revert(h)};A.prototype.toString=function(e){if(0>this.s)return"-"+this.negate().toString(e);if(16==e)e=4;else if(8==e)e=3;else if(2==e)e=1;else if(32==
e)e=5;else if(4==e)e=2;else return this.toRadix(e);var k=(1<<e)-1,h,d=!1,w="",n=this.t,a=this.DB-n*this.DB%e;if(0<n--)for(a<this.DB&&0<(h=this[n]>>a)&&(d=!0,w=Xb.charAt(h));0<=n;)a<e?(h=(this[n]&(1<<a)-1)<<e-a,h|=this[--n]>>(a+=this.DB-e)):(h=this[n]>>(a-=e)&k,0>=a&&(a+=this.DB,--n)),0<h&&(d=!0),d&&(w+=Xb.charAt(h));return d?w:"0"};A.prototype.negate=function(){var e=ia();A.ZERO.subTo(this,e);return e};A.prototype.abs=function(){return 0>this.s?this.negate():this};A.prototype.compareTo=function(e){var k=
this.s-e.s;if(0!=k)return k;var h=this.t,k=h-e.t;if(0!=k)return 0>this.s?-k:k;for(;0<=--h;)if(0!=(k=this[h]-e[h]))return k;return 0};A.prototype.bitLength=function(){return 0>=this.t?0:this.DB*(this.t-1)+Ed(this[this.t-1]^this.s&this.DM)};A.prototype.mod=function(e){var k=ia();this.abs().divRemTo(e,null,k);0>this.s&&0<k.compareTo(A.ZERO)&&e.subTo(k,k);return k};A.prototype.modPowInt=function(e,k){var h;h=256>e||k.isEven()?new wc(k):new Pa(k);return this.exp(e,h)};A.ZERO=Hc(0);A.ONE=Hc(1);Yc.prototype.convert=
Fd;Yc.prototype.revert=Fd;Yc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h)};Yc.prototype.sqrTo=function(e,k){e.squareTo(k)};Ic.prototype.convert=function(e){if(0>e.s||e.t>2*this.m.t)return e.mod(this.m);if(0>e.compareTo(this.m))return e;var k=ia();e.copyTo(k);this.reduce(k);return k};Ic.prototype.revert=function(e){return e};Ic.prototype.reduce=function(e){e.drShiftTo(this.m.t-1,this.r2);e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp());this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);for(this.m.multiplyLowerTo(this.q3,
this.m.t+1,this.r2);0>e.compareTo(this.r2);)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);0<=e.compareTo(this.m);)e.subTo(this.m,e)};Ic.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};Ic.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};var ub=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,
313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],cf=67108864/ub[ub.length-1];A.prototype.chunkSize=function(e){return Math.floor(Math.LN2*
this.DB/Math.log(e))};A.prototype.toRadix=function(e){null==e&&(e=10);if(0==this.signum()||2>e||36<e)return"0";var k=this.chunkSize(e),k=Math.pow(e,k),h=Hc(k),d=ia(),a=ia(),n="";for(this.divRemTo(h,d,a);0<d.signum();)n=(k+a.intValue()).toString(e).substr(1)+n,d.divRemTo(h,d,a);return a.intValue().toString(e)+n};A.prototype.fromRadix=function(e,k){this.fromInt(0);null==k&&(k=10);for(var h=this.chunkSize(k),d=Math.pow(k,h),a=!1,n=0,b=0,c=0;c<e.length;++c){var g=Wc(e,c);0>g?"-"==e.charAt(c)&&0==this.signum()&&
(a=!0):(b=k*b+g,++n>=h&&(this.dMultiply(d),this.dAddOffset(b,0),b=n=0))}0<n&&(this.dMultiply(Math.pow(k,n)),this.dAddOffset(b,0));a&&A.ZERO.subTo(this,this)};A.prototype.fromNumber=function(e,k,h){if("number"==typeof k)if(2>e)this.fromInt(1);else for(this.fromNumber(e,h),this.testBit(e-1)||this.bitwiseTo(A.ONE.shiftLeft(e-1),Qd,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(k);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(A.ONE.shiftLeft(e-1),this);else{h=[];var d=e&7;h.length=
(e>>3)+1;k.nextBytes(h);h[0]=0<d?h[0]&(1<<d)-1:0;this.fromString(h,256)}};A.prototype.bitwiseTo=function(e,k,h){var d,a,n=Math.min(e.t,this.t);for(d=0;d<n;++d)h[d]=k(this[d],e[d]);if(e.t<this.t){a=e.s&this.DM;for(d=n;d<this.t;++d)h[d]=k(this[d],a);h.t=this.t}else{a=this.s&this.DM;for(d=n;d<e.t;++d)h[d]=k(a,e[d]);h.t=e.t}h.s=k(this.s,e.s);h.clamp()};A.prototype.changeBit=function(e,k){var h=A.ONE.shiftLeft(e);this.bitwiseTo(h,k,h);return h};A.prototype.addTo=function(e,k){for(var h=0,d=0,a=Math.min(e.t,
this.t);h<a;)d+=this[h]+e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d+=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d+=e[h],k[h++]=d&this.DM,d>>=this.DB;d+=e.s}k.s=0>d?-1:0;0<d?k[h++]=d:-1>d&&(k[h++]=this.DV+d);k.t=h;k.clamp()};A.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t);++this.t;this.clamp()};A.prototype.dAddOffset=function(e,k){if(0!=e){for(;this.t<=k;)this[this.t++]=0;for(this[k]+=e;this[k]>=this.DV;)this[k]-=
this.DV,++k>=this.t&&(this[this.t++]=0),++this[k]}};A.prototype.multiplyLowerTo=function(e,k,h){var d=Math.min(this.t+e.t,k);h.s=0;for(h.t=d;0<d;)h[--d]=0;var a;for(a=h.t-this.t;d<a;++d)h[d+this.t]=this.am(0,e[d],h,d,0,this.t);for(a=Math.min(e.t,k);d<a;++d)this.am(0,e[d],h,d,0,k-d);h.clamp()};A.prototype.multiplyUpperTo=function(e,k,h){--k;var d=h.t=this.t+e.t-k;for(h.s=0;0<=--d;)h[d]=0;for(d=Math.max(k-this.t,0);d<e.t;++d)h[this.t+d-k]=this.am(k-d,e[d],h,0,0,this.t+d-k);h.clamp();h.drShiftTo(1,h)};
A.prototype.modInt=function(e){if(0>=e)return 0;var k=this.DV%e,h=0>this.s?e-1:0;if(0<this.t)if(0==k)h=this[0]%e;else for(var d=this.t-1;0<=d;--d)h=(k*h+this[d])%e;return h};A.prototype.millerRabin=function(e){var k=this.subtract(A.ONE),h=k.getLowestSetBit();if(0>=h)return!1;var d=k.shiftRight(h);e=e+1>>1;e>ub.length&&(e=ub.length);for(var a=ia(),n=0;n<e;++n){a.fromInt(ub[Math.floor(Math.random()*ub.length)]);var b=a.modPow(d,this);if(0!=b.compareTo(A.ONE)&&0!=b.compareTo(k)){for(var c=1;c++<h&&0!=
b.compareTo(k);)if(b=b.modPowInt(2,this),0==b.compareTo(A.ONE))return!1;if(0!=b.compareTo(k))return!1}}return!0};A.prototype.clone=function(){var e=ia();this.copyTo(e);return e};A.prototype.intValue=function(){if(0>this.s){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]};A.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24};A.prototype.shortValue=function(){return 0==
this.t?this.s:this[0]<<16>>16};A.prototype.signum=function(){return 0>this.s?-1:0>=this.t||1==this.t&&0>=this[0]?0:1};A.prototype.toByteArray=function(){var e=this.t,k=[];k[0]=this.s;var h=this.DB-e*this.DB%8,d,a=0;if(0<e--)for(h<this.DB&&(d=this[e]>>h)!=(this.s&this.DM)>>h&&(k[a++]=d|this.s<<this.DB-h);0<=e;)if(8>h?(d=(this[e]&(1<<h)-1)<<8-h,d|=this[--e]>>(h+=this.DB-8)):(d=this[e]>>(h-=8)&255,0>=h&&(h+=this.DB,--e)),0!=(d&128)&&(d|=-256),0==a&&(this.s&128)!=(d&128)&&++a,0<a||d!=this.s)k[a++]=d;
return k};A.prototype.equals=function(e){return 0==this.compareTo(e)};A.prototype.min=function(e){return 0>this.compareTo(e)?this:e};A.prototype.max=function(e){return 0<this.compareTo(e)?this:e};A.prototype.and=function(e){var k=ia();this.bitwiseTo(e,He,k);return k};A.prototype.or=function(e){var k=ia();this.bitwiseTo(e,Qd,k);return k};A.prototype.xor=function(e){var k=ia();this.bitwiseTo(e,Rd,k);return k};A.prototype.andNot=function(e){var k=ia();this.bitwiseTo(e,Xc,k);return k};A.prototype.not=
function(){for(var e=ia(),k=0;k<this.t;++k)e[k]=this.DM&~this[k];e.t=this.t;e.s=~this.s;return e};A.prototype.shiftLeft=function(e){var k=ia();0>e?this.rShiftTo(-e,k):this.lShiftTo(e,k);return k};A.prototype.shiftRight=function(e){var k=ia();0>e?this.lShiftTo(-e,k):this.rShiftTo(e,k);return k};A.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e]){var k=e*this.DB;e=this[e];if(0==e)e=-1;else{var h=0;0==(e&65535)&&(e>>=16,h+=16);0==(e&255)&&(e>>=8,h+=8);0==(e&15)&&(e>>=4,h+=
4);0==(e&3)&&(e>>=2,h+=2);0==(e&1)&&++h;e=h}return k+e}return 0>this.s?this.t*this.DB:-1};A.prototype.bitCount=function(){for(var e=0,k=this.s&this.DM,h=0;h<this.t;++h){for(var d=this[h]^k,a=0;0!=d;)d&=d-1,++a;e+=a}return e};A.prototype.testBit=function(e){var k=Math.floor(e/this.DB);return k>=this.t?0!=this.s:0!=(this[k]&1<<e%this.DB)};A.prototype.setBit=function(e){return this.changeBit(e,Qd)};A.prototype.clearBit=function(e){return this.changeBit(e,Xc)};A.prototype.flipBit=function(e){return this.changeBit(e,
Rd)};A.prototype.add=function(e){var k=ia();this.addTo(e,k);return k};A.prototype.subtract=function(e){var k=ia();this.subTo(e,k);return k};A.prototype.multiply=function(e){var k=ia();this.multiplyTo(e,k);return k};A.prototype.divide=function(e){var k=ia();this.divRemTo(e,k,null);return k};A.prototype.remainder=function(e){var k=ia();this.divRemTo(e,null,k);return k};A.prototype.divideAndRemainder=function(e){var k=ia(),h=ia();this.divRemTo(e,k,h);return[k,h]};A.prototype.modPow=function(e,k){var h=
e.bitLength(),d,a=Hc(1),n;if(0>=h)return a;d=18>h?1:48>h?3:144>h?4:768>h?5:6;n=8>h?new wc(k):k.isEven()?new Ic(k):new Pa(k);var b=[],c=3,g=d-1,f=(1<<d)-1;b[1]=n.convert(this);if(1<d)for(h=ia(),n.sqrTo(b[1],h);c<=f;)b[c]=ia(),n.mulTo(h,b[c-2],b[c]),c+=2;for(var l=e.t-1,m,p=!0,r=ia(),h=Ed(e[l])-1;0<=l;){h>=g?m=e[l]>>h-g&f:(m=(e[l]&(1<<h+1)-1)<<g-h,0<l&&(m|=e[l-1]>>this.DB+h-g));for(c=d;0==(m&1);)m>>=1,--c;0>(h-=c)&&(h+=this.DB,--l);if(p)b[m].copyTo(a),p=!1;else{for(;1<c;)n.sqrTo(a,r),n.sqrTo(r,a),c-=
2;0<c?n.sqrTo(a,r):(c=a,a=r,r=c);n.mulTo(r,b[m],a)}for(;0<=l&&0==(e[l]&1<<h);)n.sqrTo(a,r),c=a,a=r,r=c,0>--h&&(h=this.DB-1,--l)}return n.revert(a)};A.prototype.modInverse=function(e){var k=e.isEven();if(this.isEven()&&k||0==e.signum())return A.ZERO;for(var h=e.clone(),d=this.clone(),a=Hc(1),n=Hc(0),b=Hc(0),c=Hc(1);0!=h.signum();){for(;h.isEven();)h.rShiftTo(1,h),k?(a.isEven()&&n.isEven()||(a.addTo(this,a),n.subTo(e,n)),a.rShiftTo(1,a)):n.isEven()||n.subTo(e,n),n.rShiftTo(1,n);for(;d.isEven();)d.rShiftTo(1,
d),k?(b.isEven()&&c.isEven()||(b.addTo(this,b),c.subTo(e,c)),b.rShiftTo(1,b)):c.isEven()||c.subTo(e,c),c.rShiftTo(1,c);0<=h.compareTo(d)?(h.subTo(d,h),k&&a.subTo(b,a),n.subTo(c,n)):(d.subTo(h,d),k&&b.subTo(a,b),c.subTo(n,c))}if(0!=d.compareTo(A.ONE))return A.ZERO;if(0<=c.compareTo(e))return c.subtract(e);if(0>c.signum())c.addTo(e,c);else return c;return 0>c.signum()?c.add(e):c};A.prototype.pow=function(e){return this.exp(e,new Yc)};A.prototype.gcd=function(e){var k=0>this.s?this.negate():this.clone();
e=0>e.s?e.negate():e.clone();if(0>k.compareTo(e)){var h=k,k=e;e=h}var h=k.getLowestSetBit(),d=e.getLowestSetBit();if(0>d)return k;h<d&&(d=h);0<d&&(k.rShiftTo(d,k),e.rShiftTo(d,e));for(;0<k.signum();)0<(h=k.getLowestSetBit())&&k.rShiftTo(h,k),0<(h=e.getLowestSetBit())&&e.rShiftTo(h,e),0<=k.compareTo(e)?(k.subTo(e,k),k.rShiftTo(1,k)):(e.subTo(k,e),e.rShiftTo(1,e));0<d&&e.lShiftTo(d,e);return e};A.prototype.isProbablePrime=function(e){var k,h=this.abs();if(1==h.t&&h[0]<=ub[ub.length-1]){for(k=0;k<ub.length;++k)if(h[0]==
ub[k])return!0;return!1}if(h.isEven())return!1;for(k=1;k<ub.length;){for(var d=ub[k],a=k+1;a<ub.length&&d<cf;)d*=ub[a++];for(d=h.modInt(d);k<a;)if(0==d%ub[k++])return!1}return h.millerRabin(e)};A.prototype.square=function(){var e=ia();this.squareTo(e);return e};q.BigInteger=A;var H=a.ASN1HEX,N=a.KJUR,B=a.RSAKey,t=a.b64tohex,q=a=a||{};q.createHash=function(e){if("sha256"!=e)throw Error("createHash: unsupported algorithm.");e={};e.md=new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});e.update=
function(e){this.md.updateHex(e.toString("hex"))};e.digest=function(e){var h=this.md.digest();return"hex"==e?h:"base64"==e?(new f(h,"hex")).toString("base64"):new f(h,"hex")};return e};q.createHmac=function(e,k){if("sha256"!==e)throw Error("createHmac: unsupported algorithm.");var h={};h.md=new N.crypto.Mac({alg:"HmacSHA256",pass:{hex:k.toString("hex")}});h.update=function(d){this.md.updateHex(d.toString("hex"))};h.digest=function(d){var e=this.md.doFinal();return"hex"==d?e:"base64"==d?(new f(e,"hex")).toString("base64"):
new f(e,"hex")};return h};q.createSign=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");return{arr:[],update:function(e){this.arr.push(e)},sign:function(e){var h=new B;h.readPrivateKeyFromPEMString(e);e=new N.crypto.Signature({alg:"SHA256withRSA",prov:"cryptojs/jsrsa"});e.initSign(h);for(h=0;h<this.arr.length;++h)e.updateHex(this.arr[h].toString("hex"));return new f(e.sign(),"hex")}}};q.createVerify=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");
return{arr:[],update:function(e){this.arr.push(e)},verify:function(e,h){for(var d=e.split("\n"),a="",n=1;n<d.length-1;n++)a+=d[n];d=(new f(a,"base64")).toString("hex");a=H.getPosArrayOfChildren_AtObj(d,0);2!=a.length?a=-1:(a=a[1],"03"!=d.substring(a,a+2)?a=-1:(a=H.getStartPosOfV_AtObj(d,a),a="00"!=d.substring(a,a+2)?-1:a+2));n=H.getPosArrayOfChildren_AtObj(d,a);2!=n.length?a=null:(a=H.getHexOfV_AtObj(d,n[0]),d=H.getHexOfV_AtObj(d,n[1]),n=new B,n.setPublic(a,d),a=n);d=new N.crypto.Signature({alg:"SHA256withRSA",
prov:"cryptojs/jsrsa"});d.initVerifyByPublicKey(a);for(a=0;a<this.arr.length;a++)d.updateHex(this.arr[a].toString("hex"));a=h.toString("hex");return d.verify(a)}}};q.randomBytes=function(e){for(var k=new f(e),h=0;h<e;++h)k[h]=Math.floor(256*Math.random());return k};q.toByteArray=function(e){var k=[];t(e).replace(/(..)/g,function(e){k.push(parseInt(e,16))});return k};var $c={};(function(e){function k(e){e=e.charCodeAt(0);if(e===d)return 62;if(e===a)return 63;if(e<n)return-1;if(e<n+10)return e-n+52;
if(e<c+26)return e-c;if(e<b+26)return e-b+26}var h="undefined"!==typeof Uint8Array?Uint8Array:Array,d=43,a=47,n=48,b=97,c=65;e.toByteArray=function(d){function e(d){c[g++]=d}var a,n,w,b,c;if(0<d.length%4)throw Error("Invalid string. Length must be a multiple of 4");a=d.length;b="="===d.charAt(a-2)?2:"="===d.charAt(a-1)?1:0;c=new h(3*d.length/4-b);n=0<b?d.length-4:d.length;var g=0;for(a=0;a<n;a+=4)w=k(d.charAt(a))<<18|k(d.charAt(a+1))<<12|k(d.charAt(a+2))<<6|k(d.charAt(a+3)),e((w&16711680)>>16),e((w&
65280)>>8),e(w&255);2===b?(w=k(d.charAt(a))<<2|k(d.charAt(a+1))>>4,e(w&255)):1===b&&(w=k(d.charAt(a))<<10|k(d.charAt(a+1))<<4|k(d.charAt(a+2))>>2,e(w>>8&255),e(w&255));return c};e.fromByteArray=function(d){var e,h=d.length%3,k="",a,n;e=0;for(n=d.length-h;e<n;e+=3)a=(d[e]<<16)+(d[e+1]<<8)+d[e+2],a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>18&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>12&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>
6&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a&63),k+=a;switch(h){case 1:a=d[d.length-1];k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>2);k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a<<4&63);k+="==";break;case 2:a=(d[d.length-2]<<8)+d[d.length-1],k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>10),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>
4&63),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a<<2&63),k+="="}return k}})($c);q.ieee={read:function(e,k,h,d,a){var n;n=8*a-d-1;var b=(1<<n)-1,c=b>>1,g=-7;a=h?a-1:0;var f=h?-1:1,l=e[k+a];a+=f;h=l&(1<<-g)-1;l>>=-g;for(g+=n;0<g;h=256*h+e[k+a],a+=f,g-=8);n=h&(1<<-g)-1;h>>=-g;for(g+=d;0<g;n=256*n+e[k+a],a+=f,g-=8);if(0===h)h=1-c;else{if(h===b)return n?NaN:Infinity*(l?-1:1);n+=Math.pow(2,d);h-=c}return(l?-1:1)*n*Math.pow(2,h-d)},write:function(e,k,h,d,a,n){var b,c=8*
n-a-1,g=(1<<c)-1,f=g>>1,l=23===a?Math.pow(2,-24)-Math.pow(2,-77):0;n=d?0:n-1;var m=d?1:-1,p=0>k||0===k&&0>1/k?1:0;k=Math.abs(k);isNaN(k)||Infinity===k?(k=isNaN(k)?1:0,d=g):(d=Math.floor(Math.log(k)/Math.LN2),1>k*(b=Math.pow(2,-d))&&(d--,b*=2),k=1<=d+f?k+l/b:k+l*Math.pow(2,1-f),2<=k*b&&(d++,b/=2),d+f>=g?(k=0,d=g):1<=d+f?(k=(k*b-1)*Math.pow(2,a),d+=f):(k=k*Math.pow(2,f-1)*Math.pow(2,a),d=0));for(;8<=a;e[h+n]=k&255,n+=m,k/=256,a-=8);d=d<<a|k;for(c+=a;0<c;e[h+n]=d&255,n+=m,d/=256,c-=8);e[h+n-m]|=128*
p}};var La=a.ieee;q.Buffer=f;q.SlowBuffer=f;q.INSPECT_MAX_BYTES=50;f.poolSize=8192;f._useTypedArrays=function(){try{var e=new ArrayBuffer(0),k=new Uint8Array(e);k.foo=function(){return 42};return 42===k.foo()&&"function"===typeof k.subarray}catch(h){return!1}}();f.isEncoding=function(e){switch(String(e).toLowerCase()){case "hex":case "utf8":case "utf-8":case "ascii":case "binary":case "base64":case "raw":case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":return!0;default:return!1}};f.isBuffer=
function(e){return!(null===e||void 0===e||!e._isBuffer)};f.byteLength=function(e,k){var h;e=e.toString();switch(k||"utf8"){case "hex":h=e.length/2;break;case "utf8":case "utf-8":h=f.utf8ToBytes(e).length;break;case "ascii":case "binary":case "raw":h=e.length;break;case "base64":h=f.base64ToBytes(e).length;break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":h=2*e.length;break;default:throw Error("Unknown encoding");}return h};f.concat=function(e,k){f.assert(f.isArray(e),"Usage: Buffer.concat(list[, length])");
if(0===e.length)return new f(0);if(1===e.length)return e[0];var h;if(void 0===k)for(h=k=0;h<e.length;h++)k+=e[h].length;var d=new f(k),a=0;for(h=0;h<e.length;h++){var n=e[h];n.copy(d,a);a+=n.length}return d};f.compare=function(e,k){f.assert(f.isBuffer(e)&&f.isBuffer(k),"Arguments must be Buffers");for(var h=e.length,d=k.length,a=0,n=Math.min(h,d);a<n&&e[a]===k[a];a++);a!==n&&(h=e[a],d=k[a]);return h<d?-1:d<h?1:0};f.hexWrite=function(e,k,h,d){h=Number(h)||0;var a=e.length-h;d?(d=Number(d),d>a&&(d=
a)):d=a;a=k.length;f.assert(0===a%2,"Invalid hex string");d>a/2&&(d=a/2);for(a=0;a<d;a++){var n=parseInt(k.substr(2*a,2),16);f.assert(!isNaN(n),"Invalid hex string");e[h+a]=n}return a};f.utf8Write=function(e,k,h,d){return f.blitBuffer(f.utf8ToBytes(k),e,h,d)};f.asciiWrite=function(e,k,h,d){return f.blitBuffer(f.asciiToBytes(k),e,h,d)};f.binaryWrite=function(e,k,h,d){return f.asciiWrite(e,k,h,d)};f.base64Write=function(e,k,h,d){return f.blitBuffer(f.base64ToBytes(k),e,h,d)};f.utf16leWrite=function(e,
k,h,d){return f.blitBuffer(f.utf16leToBytes(k),e,h,d)};f.prototype.write=function(e,k,h,d){if(isFinite(k))isFinite(h)||(d=h,h=void 0);else{var a=d;d=k;k=h;h=a}k=Number(k)||0;a=this.length-k;h?(h=Number(h),h>a&&(h=a)):h=a;d=String(d||"utf8").toLowerCase();switch(d){case "hex":e=f.hexWrite(this,e,k,h);break;case "utf8":case "utf-8":e=f.utf8Write(this,e,k,h);break;case "ascii":e=f.asciiWrite(this,e,k,h);break;case "binary":e=f.binaryWrite(this,e,k,h);break;case "base64":e=f.base64Write(this,e,k,h);break;
case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=f.utf16leWrite(this,e,k,h);break;default:throw Error("Unknown encoding");}return e};f.prototype.toString=function(e,k,h){e=String(e||"utf8").toLowerCase();k=Number(k)||0;h=void 0===h?this.length:Number(h);if(h===k)return"";switch(e){case "hex":e=f.hexSlice(this,k,h);break;case "utf8":case "utf-8":e=f.utf8Slice(this,k,h);break;case "ascii":e=f.asciiSlice(this,k,h);break;case "binary":e=f.binarySlice(this,k,h);break;case "base64":e=f.base64Slice(this,
k,h);break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=this.slice(k,h);k="";for(h=0;h<e.length;h+=2)k+=String.fromCharCode(e[h]+256*e[h+1]);e=k;break;default:throw Error("Unknown encoding");}return e};f.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};f.prototype.equals=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");return 0===f.compare(this,e)};f.prototype.compare=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");
return f.compare(this,e)};f.prototype.copy=function(e,k,h,d){h||(h=0);d||0===d||(d=this.length);k||(k=0);if(d!==h&&0!==e.length&&0!==this.length)if(f.assert(d>=h,"sourceEnd < sourceStart"),f.assert(0<=k&&k<e.length,"targetStart out of bounds"),f.assert(0<=h&&h<this.length,"sourceStart out of bounds"),f.assert(0<=d&&d<=this.length,"sourceEnd out of bounds"),d>this.length&&(d=this.length),e.length-k<d-h&&(d=e.length-k+h),d-=h,100>d||!f._useTypedArrays)for(var a=0;a<d;a++)e[a+k]=this[a+h];else e._set(this.subarray(h,
h+d),k)};f.base64Slice=function(e,k,h){return 0===k&&h===e.length?$c.fromByteArray(e):$c.fromByteArray(e.slice(k,h))};f.utf8Slice=function(e,k,h){var d="",a="";for(h=Math.min(e.length,h);k<h;k++)127>=e[k]?(d+=f.decodeUtf8Char(a)+String.fromCharCode(e[k]),a=""):a+="%"+e[k].toString(16);return d+f.decodeUtf8Char(a)};f.asciiSlice=function(e,k,h){var d="";for(h=Math.min(e.length,h);k<h;k++)d+=String.fromCharCode(e[k]);return d};f.binarySlice=function(e,k,h){return f.asciiSlice(e,k,h)};f.hexSlice=function(e,
k,h){var d=e.length;if(!k||0>k)k=0;if(!h||0>h||h>d)h=d;for(d="";k<h;k++)d+=f.toHex(e[k]);return d};f.prototype.slice=function(e,k){var h=this.length;e=f.clamp(e,h,0);k=f.clamp(k,h,h);if(f._useTypedArrays)return f._augment(this.subarray(e,k));for(var h=k-e,d=new f(h,void 0,!0),a=0;a<h;a++)d[a]=this[a+e];return d};f.prototype.get=function(e){console.log(".get() is deprecated. Access using array indexes instead.");return this.readUInt8(e)};f.prototype.set=function(e,k){console.log(".set() is deprecated. Access using array indexes instead.");
return this.writeUInt8(e,k)};f.prototype.readUInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]};f.readUInt16=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d))return h?(h=e[k],k+1<d&&(h|=e[k+1]<<8)):(h=e[k]<<8,k+1<d&&
(h|=e[k+1])),h};f.prototype.readUInt16LE=function(e,k){return f.readUInt16(this,e,!0,k)};f.prototype.readUInt16BE=function(e,k){return f.readUInt16(this,e,!1,k)};f.readUInt32=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d)){var a;h?(k+2<d&&(a=e[k+2]<<16),k+1<d&&(a|=e[k+1]<<8),a|=e[k],k+3<d&&(a+=e[k+3]<<24>>>0)):(k+1<d&&(a=e[k+1]<<16),
k+2<d&&(a|=e[k+2]<<8),k+3<d&&(a|=e[k+3]),a+=e[k]<<24>>>0);return a}};f.prototype.readUInt32LE=function(e,k){return f.readUInt32(this,e,!0,k)};f.prototype.readUInt32BE=function(e,k){return f.readUInt32(this,e,!1,k)};f.prototype.readInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]&128?-1*(255-this[e]+1):this[e]};f.readInt16=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),
f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));if(!(k>=e.length))return e=f.readUInt16(e,k,h,!0),e&32768?-1*(65535-e+1):e};f.prototype.readInt16LE=function(e,k){return f.readInt16(this,e,!0,k)};f.prototype.readInt16BE=function(e,k){return f.readInt16(this,e,!1,k)};f.readInt32=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));
if(!(k>=e.length))return e=f.readUInt32(e,k,h,!0),e&2147483648?-1*(4294967295-e+1):e};f.prototype.readInt32LE=function(e,k){return f.readInt32(this,e,!0,k)};f.prototype.readInt32BE=function(e,k){return f.readInt32(this,e,!1,k)};f.readFloat=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));return La.read(e,k,h,23,4)};f.prototype.readFloatLE=function(e,k){return f.readFloat(this,e,!0,k)};f.prototype.readFloatBE=
function(e,k){return f.readFloat(this,e,!1,k)};f.readDouble=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+7<e.length,"Trying to read beyond buffer length"));return La.read(e,k,h,52,8)};f.prototype.readDoubleLE=function(e,k){return f.readDouble(this,e,!0,k)};f.prototype.readDoubleBE=function(e,k){return f.readDouble(this,e,!1,k)};f.prototype.writeUInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),
f.assert(k<this.length,"trying to write beyond buffer length"),f.verifuint(e,255));if(!(k>=this.length))return this[k]=e,k+1};f.writeUInt16=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"trying to write beyond buffer length"),f.verifuint(k,65535));var n=e.length;if(!(h>=n)){a=0;for(n=Math.min(n-h,2);a<n;a++)e[h+a]=(k&255<<8*(d?a:1-a))>>>8*(d?a:1-
a);return h+2}};f.prototype.writeUInt16LE=function(e,k,h){return f.writeUInt16(this,e,k,!0,h)};f.prototype.writeUInt16BE=function(e,k,h){return f.writeUInt16(this,e,k,!1,h)};f.writeUInt32=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"trying to write beyond buffer length"),f.verifuint(k,4294967295));var n=e.length;if(!(h>=n)){a=0;for(n=Math.min(n-
h,4);a<n;a++)e[h+a]=k>>>8*(d?a:3-a)&255;return h+4}};f.prototype.writeUInt32LE=function(e,k,h){return f.writeUInt32(this,e,k,!0,h)};f.prototype.writeUInt32BE=function(e,k,h){return f.writeUInt32(this,e,k,!1,h)};f.prototype.writeInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k<this.length,"Trying to write beyond buffer length"),f.verifsint(e,127,-128));if(!(k>=this.length))return 0<=e?this.writeUInt8(e,k,h):this.writeUInt8(255+
e+1,k,h),k+1};f.writeInt16=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"Trying to write beyond buffer length"),f.verifsint(k,32767,-32768));if(!(h>=e.length))return 0<=k?f.writeUInt16(e,k,h,d,a):f.writeUInt16(e,65535+k+1,h,d,a),h+2};f.prototype.writeInt16LE=function(e,k,h){return f.writeInt16(this,e,k,!0,h)};f.prototype.writeInt16BE=function(e,
k,h){return f.writeInt16(this,e,k,!1,h)};f.writeInt32=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifsint(k,2147483647,-2147483648));if(!(h>=e.length))return 0<=k?f.writeUInt32(e,k,h,d,a):f.writeUInt32(e,4294967295+k+1,h,d,a),h+4};f.prototype.writeInt32LE=function(e,k,h){return f.writeInt32(this,e,k,
!0,h)};f.prototype.writeInt32BE=function(e,k,h){return f.writeInt32(this,e,k,!1,h)};f.writeFloat=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,3.4028234663852886E38,-3.4028234663852886E38));if(!(h>=e.length))return La.write(e,k,h,d,23,4),h+4};f.prototype.writeFloatLE=function(e,k,h){return f.writeFloat(this,
e,k,!0,h)};f.prototype.writeFloatBE=function(e,k,h){return f.writeFloat(this,e,k,!1,h)};f.writeDouble=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+7<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,1.7976931348623157E308,-1.7976931348623157E308));if(!(h>=e.length))return La.write(e,k,h,d,52,8),h+8};f.prototype.writeDoubleLE=function(e,k,h){return f.writeDouble(this,
e,k,!0,h)};f.prototype.writeDoubleBE=function(e,k,h){return f.writeDouble(this,e,k,!1,h)};f.prototype.fill=function(e,k,h){e||(e=0);k||(k=0);h||(h=this.length);f.assert(h>=k,"end < start");if(h!==k&&0!==this.length){f.assert(0<=k&&k<this.length,"start out of bounds");f.assert(0<=h&&h<=this.length,"end out of bounds");if("number"===typeof e)for(;k<h;k++)this[k]=e;else{e=f.utf8ToBytes(e.toString());for(var d=e.length;k<h;k++)this[k]=e[k%d]}return this}};f.prototype.inspect=function(){for(var e=[],k=
this.length,h=0;h<k;h++)if(e[h]=f.toHex(this[h]),h===q.INSPECT_MAX_BYTES){e[h+1]="...";break}return"<Buffer "+e.join(" ")+">"};f.prototype.toArrayBuffer=function(){if("undefined"!==typeof Uint8Array){if(f._useTypedArrays)return(new f(this)).buffer;for(var e=new Uint8Array(this.length),k=0,h=e.length;k<h;k+=1)e[k]=this[k];return e.buffer}throw Error("Buffer.toArrayBuffer not supported in this browser");};var ba=f.prototype;f._augment=function(e){e._isBuffer=!0;e._get=e.get;e._set=e.set;e.get=ba.get;
e.set=ba.set;e.write=ba.write;e.toString=ba.toString;e.toLocaleString=ba.toString;e.toJSON=ba.toJSON;e.equals=ba.equals;e.compare=ba.compare;e.copy=ba.copy;e.slice=ba.slice;e.readUInt8=ba.readUInt8;e.readUInt16LE=ba.readUInt16LE;e.readUInt16BE=ba.readUInt16BE;e.readUInt32LE=ba.readUInt32LE;e.readUInt32BE=ba.readUInt32BE;e.readInt8=ba.readInt8;e.readInt16LE=ba.readInt16LE;e.readInt16BE=ba.readInt16BE;e.readInt32LE=ba.readInt32LE;e.readInt32BE=ba.readInt32BE;e.readFloatLE=ba.readFloatLE;e.readFloatBE=
ba.readFloatBE;e.readDoubleLE=ba.readDoubleLE;e.readDoubleBE=ba.readDoubleBE;e.writeUInt8=ba.writeUInt8;e.writeUInt16LE=ba.writeUInt16LE;e.writeUInt16BE=ba.writeUInt16BE;e.writeUInt32LE=ba.writeUInt32LE;e.writeUInt32BE=ba.writeUInt32BE;e.writeInt8=ba.writeInt8;e.writeInt16LE=ba.writeInt16LE;e.writeInt16BE=ba.writeInt16BE;e.writeInt32LE=ba.writeInt32LE;e.writeInt32BE=ba.writeInt32BE;e.writeFloatLE=ba.writeFloatLE;e.writeFloatBE=ba.writeFloatBE;e.writeDoubleLE=ba.writeDoubleLE;e.writeDoubleBE=ba.writeDoubleBE;
e.fill=ba.fill;e.inspect=ba.inspect;e.toArrayBuffer=ba.toArrayBuffer;return e};f.stringtrim=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")};f.clamp=function(e,k,h){if("number"!==typeof e)return h;e=~~e;if(e>=k)return k;if(0<=e)return e;e+=k;return 0<=e?e:0};f.coerce=function(e){e=~~Math.ceil(+e);return 0>e?0:e};f.isArray=function(e){return(Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)})(e)};f.isArrayish=function(e){return f.isArray(e)||f.isBuffer(e)||
e&&"object"===typeof e&&"number"===typeof e.length};f.toHex=function(e){return 16>e?"0"+e.toString(16):e.toString(16)};f.utf8ToBytes=function(e){for(var k=[],h=0;h<e.length;h++){var d=e.charCodeAt(h);if(127>=d)k.push(d);else{var a=h;55296<=d&&57343>=d&&h++;d=encodeURIComponent(e.slice(a,h+1)).substr(1).split("%");for(a=0;a<d.length;a++)k.push(parseInt(d[a],16))}}return k};f.asciiToBytes=function(e){for(var k=[],h=0;h<e.length;h++)k.push(e.charCodeAt(h)&255);return k};f.utf16leToBytes=function(e){for(var k,
h,d=[],a=0;a<e.length;a++)k=e.charCodeAt(a),h=k>>8,k%=256,d.push(k),d.push(h);return d};f.base64ToBytes=function(e){return $c.toByteArray(e)};f.blitBuffer=function(e,k,h,d){for(var a=0;a<d&&!(a+h>=k.length||a>=e.length);a++)k[a+h]=e[a];return a};f.decodeUtf8Char=function(e){try{return decodeURIComponent(e)}catch(k){return String.fromCharCode(65533)}};f.verifuint=function(e,k){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(0<=e,"specified a negative value for writing an unsigned value");
f.assert(e<=k,"value is larger than maximum value for type");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifsint=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(e<=k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifIEEE754=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");
f.assert(e<=k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value")};f.assert=function(e,k){if(!e)throw Error(k||"Failed assertion");};var Lc=function(){};q.Log=Lc;Lc.LOG=0;var ad=a.printStackTrace,P={};q.NdnCommon=P;P.MAX_NDN_PACKET_SIZE=8800;P.getErrorWithStackTrace=function(e){return e+"\n"+ad({e:e}).join("\n")};P.checkIndexedDb=function(e){try{var k=new Dexie("test-Dexie-support");k.version(1).stores({});k.open();setTimeout(function(){try{e(k.isOpen())}catch(d){e(!1)}},
200)}catch(h){e(!1)}};var P=a.NdnCommon,qd=function(e,k,h,d){d=d||{};this.face=e;this.callerOnData=k;this.callerOnTimeout=h;this.maxInterestLifetime=d.maxInterestLifetime||16E3};q.ExponentialReExpress=qd;qd.makeOnTimeout=function(e,k,h,d){var a=new qd(e,k,h,d);return function(d){a.onTimeout(d)}};qd.prototype.onTimeout=function(e){var k=e.getInterestLifetimeMilliseconds();if(null==k){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(h){console.log("Error in onTimeout: "+P.getErrorWithStackTrace(h))}}else if(k*=
2,k>this.maxInterestLifetime){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(d){console.log("Error in onTimeout: "+P.getErrorWithStackTrace(d))}}else{e=e.clone();e.setInterestLifetimeMilliseconds(k);var a=this;this.face.expressInterest(e,this.callerOnData,function(d){a.onTimeout(d)})}};var p=function k(h,d){null==d&&(d=!0);null==h?this.buffer=null:"object"===typeof h&&h instanceof k?this.buffer=h.buffer:"string"===typeof h?this.buffer=new f(h,"utf8"):d?this.buffer=new f(h):f.isBuffer(h)?
this.buffer=h:this.buffer=new f(h);this.length=null!=this.buffer?this.buffer.length:0};q.Blob=p;p.prototype.size=function(){return null!=this.buffer?this.buffer.length:0};p.prototype.buf=function(){return this.buffer};p.prototype.isNull=function(){return null==this.buffer};p.prototype.toHex=function(){return null==this.buffer?"":this.buffer.toString("hex")};p.prototype.toString=function(){return null==this.buffer?"":this.buffer.toString("utf8")};p.prototype.equals=function(k){if(this.isNull())return k.isNull();
if(k.isNull())return!1;if(this.buffer!==k.buffer){if(this.buffer.length!=k.buffer.length)return!1;for(var h=0;h<this.buffer.length;++h)if(this.buffer[h]!=k.buffer[h])return!1}return!0};var p=a.Blob,$a=function h(d,a,n){p.call(this,d);null==this.buffer?this.signedPortionEndOffset=this.signedPortionBeginOffset=0:"object"===typeof d&&d instanceof h?(this.signedPortionBeginOffset=null==a?d.signedPortionBeginOffset:a,this.signedPortionEndOffset=null==n?d.signedPortionEndOffset:n):(this.signedPortionBeginOffset=
a||0,this.signedPortionEndOffset=n||0);this.signedBuffer=null==this.buffer?null:this.buffer.slice(this.signedPortionBeginOffset,this.signedPortionEndOffset)};$a.prototype=new p;$a.prototype.name="SignedBlob";q.SignedBlob=$a;$a.prototype.signedSize=function(){return null!=this.signedBuffer?this.signedBuffer.length:0};$a.prototype.signedBuf=function(){return this.signedBuffer};$a.prototype.getSignedPortionBeginOffset=function(){return this.signedPortionBeginOffset};$a.prototype.getSignedPortionEndOffset=
function(){return this.signedPortionEndOffset};var cb=function(h){h||(h=16);this.array=new f(h)};q.DynamicBuffer=cb;cb.prototype.ensureLength=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;h>d&&(d=h);h=new f(d);this.array.copy(h);this.array=h}};cb.prototype.copy=function(h,d){this.ensureLength(h.length+d);f.isBuffer(h)?h.copy(this.array,d):(new f(h)).copy(this.array,d);return d+h.length};cb.prototype.ensureLengthFromBack=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;
h>d&&(d=h);h=new f(d);this.array.copy(h,h.length-this.array.length);this.array=h}};cb.prototype.copyFromBack=function(h,d){this.ensureLengthFromBack(d);f.isBuffer(h)?h.copy(this.array,this.array.length-d):(new f(h)).copy(this.array,this.array.length-d)};cb.prototype.slice=function(h,d){return void 0==d?this.array.slice(h):this.array.slice(h,d)};var oa=function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};q.ChangeCounter=oa;oa.prototype.get=function(){return this.target};oa.prototype.set=
function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};oa.prototype.checkChanged=function(){if(null==this.target)return!1;var h=this.target.getChangeCount();return this.changeCount!=h?(this.changeCount=h,!0):!1};var P=a.NdnCommon,b=function(h,d){this.value=h;this.isRejected=d};q.SyncPromise=b;b.prototype.then=function(h,d){if(this.isRejected)if(d)try{return d(this.value)}catch(a){return new b(a,!0)}else return this;else if(h)try{return h(this.value)}catch(n){return new b(n,!0)}else return this};
b.prototype.catch=function(h){return this.then(void 0,h)};b.resolve=function(h){return new b(h,!1)};b.reject=function(h){return new b(h,!0)};b.getValue=function(h){if(h instanceof b){if(h.isRejected)throw h.value;return h.value}throw Error("Cannot return immediately because promise is not a SyncPromise");};b.complete=function(h,d,a){var n;a?n=d:(a=d,n=null);if(h)a.then(function(d){try{h(d)}catch(a){console.log("Error in onComplete: "+P.getErrorWithStackTrace(a))}},function(d){if(n)try{n(d)}catch(h){console.log("Error in onError: "+
P.getErrorWithStackTrace(h))}else{if(a instanceof b)throw d;console.log("Uncaught exception from a Promise: "+P.getErrorWithStackTrace(d))}});else return b.getValue(a)};var L={};q.DataUtils=L;L.keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";L.stringtoBase64=function(h){var d="",a,n,b="",c,g,f="",l=0;do a=h.charCodeAt(l++),n=h.charCodeAt(l++),b=h.charCodeAt(l++),c=a>>2,a=(a&3)<<4|n>>4,g=(n&15)<<2|b>>6,f=b&63,isNaN(n)?g=f=64:isNaN(b)&&(f=64),d=d+L.keyStr.charAt(c)+L.keyStr.charAt(a)+
L.keyStr.charAt(g)+L.keyStr.charAt(f);while(l<h.length);return d};L.base64toString=function(h){var d="",a,n,b="",c,g="",f=0;/[^A-Za-z0-9\+\/\=]/g.exec(h)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.");h=h.replace(/[^A-Za-z0-9\+\/\=]/g,"");do a=L.keyStr.indexOf(h.charAt(f++)),n=L.keyStr.indexOf(h.charAt(f++)),c=L.keyStr.indexOf(h.charAt(f++)),g=L.keyStr.indexOf(h.charAt(f++)),a=a<<2|n>>4,n=(n&
15)<<4|c>>2,b=(c&3)<<6|g,d+=String.fromCharCode(a),64!=c&&(d+=String.fromCharCode(n)),64!=g&&(d+=String.fromCharCode(b));while(f<h.length);return d};L.toHex=function(h){return h.toString("hex")};L.stringToHex=function(h){for(var d="",a=0;a<h.length;++a)var n=h.charCodeAt(a),d=d+((16>n?"0":"")+n.toString(16));return d};L.toString=function(h){return h.toString("binary")};L.toNumbers=function(h){return new f(h,"hex")};L.hexToRawString=function(h){if("string"==typeof h){var d="";h.replace(/(..)/g,function(h){d+=
String.fromCharCode(parseInt(h,16))});return d}};L.toNumbersFromString=function(h){return new f(h,"binary")};L.toNumbersIfString=function(h){return"string"===typeof h?new f(h,"binary"):h};L.stringToUtf8Array=function(h){return new f(h,"utf8")};L.concatArrays=function(h){return f.concat(h)};L.decodeUtf8=function(h){for(var d="",a=0,n=0,b=0;a<h.length;)if(n=h.charCodeAt(a),128>n)d+=String.fromCharCode(n),a++;else if(191<n&&224>n)b=h.charCodeAt(a+1),d+=String.fromCharCode((n&31)<<6|b&63),a+=2;else var b=
h.charCodeAt(a+1),c=h.charCodeAt(a+2),d=d+String.fromCharCode((n&15)<<12|(b&63)<<6|c&63),a=a+3;return d};L.arraysEqual=function(h,d){if(!h.slice)throw Error("DataUtils.arraysEqual: a1 is not an array");if(!d.slice)throw Error("DataUtils.arraysEqual: a2 is not an array");if(h.length!=d.length)return!1;for(var a=0;a<h.length;++a)if(h[a]!=d[a])return!1;return!0};L.bigEndianToUnsignedInt=function(h){for(var d=0,a=0;a<h.length;++a)d*=256,d+=h[a];return d};L.nonNegativeIntToBigEndian=function(h){h=Math.round(h);
if(0>=h)return new f(0);for(var d=new f(8),a=0;0!=h;)++a,d[8-a]=h&255,h=Math.floor(h/256);return d.slice(8-a,8)};L.shuffle=function(h){for(var d=h.length-1;1<=d;--d){var a=Math.floor(Math.random()*(d+1)),n=h[d];h[d]=h[a];h[a]=n}};L.privateKeyPemToDer=function(h){h=h.split("\n");for(var d="",a=1;a<h.length-1;a++)d+=h[a];return new f(d,"base64")};S.prototype=Error();S.prototype.name="DecodingException";q.DecodingException=S;var m=function(){};q.Tlv=m;m.Interest=5;m.Data=6;m.Name=7;m.ImplicitSha256DigestComponent=
1;m.ParametersSha256DigestComponent=2;m.NameComponent=8;m.Selectors=9;m.Nonce=10;m.InterestLifetime=12;m.MinSuffixComponents=13;m.MaxSuffixComponents=14;m.PublisherPublicKeyLocator=15;m.Exclude=16;m.ChildSelector=17;m.MustBeFresh=18;m.Any=19;m.MetaInfo=20;m.Content=21;m.SignatureInfo=22;m.SignatureValue=23;m.ContentType=24;m.FreshnessPeriod=25;m.FinalBlockId=26;m.SignatureType=27;m.KeyLocator=28;m.KeyLocatorDigest=29;m.ForwardingHint=30;m.SelectedDelegation=32;m.CanBePrefix=33;m.HopLimit=34;m.ApplicationParameters=
35;m.SignatureType_DigestSha256=0;m.SignatureType_SignatureSha256WithRsa=1;m.SignatureType_SignatureSha256WithEcdsa=3;m.SignatureType_SignatureHmacWithSha256=4;m.ContentType_Default=0;m.ContentType_Link=1;m.ContentType_Key=2;m.NfdCommand_ControlResponse=101;m.NfdCommand_StatusCode=102;m.NfdCommand_StatusText=103;m.ControlParameters_ControlParameters=104;m.ControlParameters_FaceId=105;m.ControlParameters_Uri=114;m.ControlParameters_LocalUri=129;m.ControlParameters_LocalControlFeature=110;m.ControlParameters_Origin=
111;m.ControlParameters_Cost=106;m.ControlParameters_Capacity=131;m.ControlParameters_Count=132;m.ControlParameters_BaseCongestionMarkingInterval=135;m.ControlParameters_DefaultCongestionThreshold=136;m.ControlParameters_Mtu=137;m.ControlParameters_Flags=108;m.ControlParameters_Mask=112;m.ControlParameters_Strategy=107;m.ControlParameters_ExpirationPeriod=109;m.LpPacket_LpPacket=100;m.LpPacket_Fragment=80;m.LpPacket_Sequence=81;m.LpPacket_FragIndex=82;m.LpPacket_FragCount=83;m.LpPacket_Nack=800;m.LpPacket_NackReason=
801;m.LpPacket_NextHopFaceId=816;m.LpPacket_IncomingFaceId=817;m.LpPacket_CachePolicy=820;m.LpPacket_CachePolicyType=821;m.LpPacket_CongestionMark=832;m.LpPacket_IGNORE_MIN=800;m.LpPacket_IGNORE_MAX=959;m.Link_Preference=30;m.Link_Delegation=31;m.Encrypt_EncryptedContent=130;m.Encrypt_EncryptionAlgorithm=131;m.Encrypt_EncryptedPayload=132;m.Encrypt_InitialVector=133;m.Encrypt_EncryptedPayloadKey=134;m.SafeBag_SafeBag=128;m.SafeBag_EncryptedKeyBag=129;m.Encrypt_StartDate=134;m.Encrypt_EndDate=135;
m.Encrypt_IntervalStartHour=136;m.Encrypt_IntervalEndHour=137;m.Encrypt_NRepeats=138;m.Encrypt_RepeatUnit=139;m.Encrypt_RepetitiveInterval=140;m.Encrypt_WhiteIntervalList=141;m.Encrypt_BlackIntervalList=142;m.Encrypt_Schedule=143;m.ValidityPeriod_ValidityPeriod=253;m.ValidityPeriod_NotBefore=254;m.ValidityPeriod_NotAfter=255;m.getHighBytes=function(h){return(h-h%4294967296)/4294967296};var cb=a.DynamicBuffer,m=a.Tlv,sa=function(h){this.output=new cb(h||16);this.length=0};q.TlvEncoder=sa;sa.prototype.getLength=
function(){return this.length};sa.prototype.writeVarNumber=function(h){if(253>h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=3;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length;this.output.array[d]=253;this.output.array[d+1]=h>>8&255;this.output.array[d+2]=h&255}else if(4294967295>=h)this.length+=5,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-
this.length,this.output.array[d]=254,this.output.array[d+1]=h>>24&255,this.output.array[d+2]=h>>16&255,this.output.array[d+3]=h>>8&255,this.output.array[d+4]=h&255;else{this.length+=9;this.output.ensureLengthFromBack(this.length);d=this.output.array.length-this.length;this.output.array[d]=255;var a=m.getHighBytes(h);this.output.array[d+1]=a>>24&255;this.output.array[d+2]=a>>16&255;this.output.array[d+3]=a>>8&255;this.output.array[d+4]=a&255;this.output.array[d+5]=h>>24&255;this.output.array[d+6]=
h>>16&255;this.output.array[d+7]=h>>8&255;this.output.array[d+8]=h&255}};sa.prototype.writeTypeAndLength=function(h,d){this.writeVarNumber(d);this.writeVarNumber(h)};sa.prototype.writeNonNegativeInteger=function(h){if(0>h)throw Error("TLV integer value may not be negative");h=Math.round(h);if(255>=h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=2;this.output.ensureLengthFromBack(this.length);
var d=this.output.array.length-this.length;this.output.array[d]=h>>8&255;this.output.array[d+1]=h&255}else if(4294967295>=h)this.length+=4,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-this.length,this.output.array[d]=h>>24&255,this.output.array[d+1]=h>>16&255,this.output.array[d+2]=h>>8&255,this.output.array[d+3]=h&255;else{this.length+=8;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length,a=m.getHighBytes(h);this.output.array[d]=a>>
24&255;this.output.array[d+1]=a>>16&255;this.output.array[d+2]=a>>8&255;this.output.array[d+3]=a&255;this.output.array[d+4]=h>>24&255;this.output.array[d+5]=h>>16&255;this.output.array[d+6]=h>>8&255;this.output.array[d+7]=h&255}};sa.prototype.writeNonNegativeIntegerTlv=function(h,d){var a=this.length;this.writeNonNegativeInteger(d);this.writeTypeAndLength(h,this.length-a)};sa.prototype.writeOptionalNonNegativeIntegerTlv=function(h,d){null!=d&&0<=d&&this.writeNonNegativeIntegerTlv(h,d)};sa.prototype.writeBuffer=
function(h){null!=h&&(this.length+=h.length,this.output.copyFromBack(h,this.length))};sa.prototype.writeBlobTlv=function(h,d){null==d?this.writeTypeAndLength(h,0):(this.writeBuffer(d),this.writeTypeAndLength(h,d.length))};sa.prototype.writeOptionalBlobTlv=function(h,d){null!=d&&0<d.length&&this.writeBlobTlv(h,d)};sa.prototype.getOutput=function(){return this.output.array.slice(this.output.array.length-this.length)};var S=a.DecodingException,na=function(h){this.input=h;this.offset=0};q.TlvDecoder=
na;na.prototype.readVarNumber=function(){var h=this.input[this.offset];this.offset+=1;return 253>h?h:this.readExtendedVarNumber(h)};na.prototype.readExtendedVarNumber=function(h){253==h?(h=(this.input[this.offset]<<8)+this.input[this.offset+1],this.offset+=2):254==h?(h=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3],this.offset+=4):(h=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+
2]<<8)+this.input[this.offset+3])+(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7],this.offset+=8);return h};na.prototype.readTypeAndLength=function(h){if(this.readVarNumber()!=h)throw new S(Error("Did not get the expected TLV type"));h=this.readVarNumber();if(this.offset+h>this.input.length)throw new S(Error("TLV length exceeds the buffer length"));return h};na.prototype.readNestedTlvsStart=function(h){return this.readTypeAndLength(h)+
this.offset};na.prototype.finishNestedTlvs=function(h,d){if(this.offset!=h){for(void 0==d&&(d=!1);this.offset<h;){var a=this.readVarNumber();if((31>=a||1==(a&1))&&!d)throw new S(Error("Unrecognized critical type code "+a));a=this.readVarNumber();this.offset+=a;if(this.offset>this.input.length)throw new S(Error("TLV length exceeds the buffer length"));}if(this.offset!=h)throw new S(Error("TLV length does not equal the total length of the nested TLVs"));}};na.prototype.peekType=function(h,d){if(this.offset>=
d)return!1;var a=this.offset,n=this.readVarNumber();this.offset=a;return n==h};na.prototype.readNonNegativeInteger=function(h){var d;if(1==h)d=this.input[this.offset];else if(2==h)d=(this.input[this.offset]<<8)+this.input[this.offset+1];else if(4==h)d=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3];else if(8==h)d=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<
8)+this.input[this.offset+3])+Math.abs(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7];else throw new S(Error("Invalid length for a TLV nonNegativeInteger"));this.offset+=h;return d};na.prototype.readNonNegativeIntegerTlv=function(h){h=this.readTypeAndLength(h);return this.readNonNegativeInteger(h)};na.prototype.readOptionalNonNegativeIntegerTlv=function(h,d){return this.peekType(h,d)?this.readNonNegativeIntegerTlv(h):null};na.prototype.readBlobTlv=
function(h){h=this.readTypeAndLength(h);var d=this.input.slice(this.offset,this.offset+h);this.offset+=h;return d};na.prototype.readOptionalBlobTlv=function(h,d){return this.peekType(h,d)?this.readBlobTlv(h):null};na.prototype.readBooleanTlv=function(h,d){if(this.peekType(h,d)){var a=this.readTypeAndLength(h);this.offset+=a;return!0}return!1};na.prototype.skipTlv=function(h){h=this.readTypeAndLength(h);this.offset+=h};na.prototype.skipOptionalTlv=function(h,d){this.peekType(h,d)&&this.skipTlv(h)};
na.prototype.getOffset=function(){return this.offset};na.prototype.seek=function(h){this.offset=h};na.prototype.getSlice=function(h,d){return this.input.slice(h,d)};var na=a.TlvDecoder,F=function d(){this.gotElementEnd_=!1;this.offset_=0;this.state_=d.READ_TYPE;this.headerLength_=0;this.useHeaderBuffer_=!1;this.headerBuffer_=new f(8);this.nBytesToRead_=0};q.TlvStructureDecoder=F;F.READ_TYPE=0;F.READ_TYPE_BYTES=1;F.READ_LENGTH=2;F.READ_LENGTH_BYTES=3;F.READ_VALUE_BYTES=4;F.prototype.findElementEnd=
function(d){if(this.gotElementEnd_)return!0;for(var a=new na(d);;){if(this.offset_>=d.length)return!1;if(this.state_==F.READ_TYPE){var n=d[this.offset_];this.offset_+=1;253>n?this.state_=F.READ_LENGTH:(this.nBytesToRead_=253==n?2:254==n?4:8,this.state_=F.READ_TYPE_BYTES)}else if(this.state_==F.READ_TYPE_BYTES){n=d.length-this.offset_;if(n<this.nBytesToRead_)return this.offset_+=n,this.nBytesToRead_-=n,!1;this.offset_+=this.nBytesToRead_;this.state_=F.READ_LENGTH}else if(this.state_==F.READ_LENGTH)if(n=
d[this.offset_],this.offset_+=1,253>n){this.nBytesToRead_=n;if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=F.READ_VALUE_BYTES}else this.nBytesToRead_=253==n?2:254==n?4:8,this.firstOctet_=n,this.state_=F.READ_LENGTH_BYTES;else if(this.state_==F.READ_LENGTH_BYTES){n=d.length-this.offset_;if(!this.useHeaderBuffer_&&n>=this.nBytesToRead_)a.seek(this.offset_),this.nBytesToRead_=a.readExtendedVarNumber(this.firstOctet_),this.offset_=a.getOffset();else{this.useHeaderBuffer_=!0;var b=
this.nBytesToRead_-this.headerLength_;if(b>n){if(this.headerLength_+n>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");d.slice(this.offset_,this.offset_+n).copy(this.headerBuffer_,this.headerLength_);this.offset_+=n;this.headerLength_+=n;return!1}if(this.headerLength_+b>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");d.slice(this.offset_,this.offset_+b).copy(this.headerBuffer_,this.headerLength_);
this.offset_+=b;this.nBytesToRead_=(new na(this.headerBuffer_)).readExtendedVarNumber(this.firstOctet_)}if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=F.READ_VALUE_BYTES}else{if(this.state_==F.READ_VALUE_BYTES){n=d.length-this.offset_;if(n<this.nBytesToRead_)return this.offset_+=n,this.nBytesToRead_-=n,!1;this.offset_+=this.nBytesToRead_;return this.gotElementEnd_=!0}throw Error("findElementEnd: unrecognized state");}}};F.prototype.getOffset=function(){return this.offset_};F.prototype.seek=
function(d){this.offset_=d};var sa=a.TlvEncoder,na=a.TlvDecoder,p=a.Blob,c=a.Name,ib=function(){};q.ProtobufTlv=ib;ib._Field=null;ib.establishField=function(){if(null===ib._Field)try{ib._Field=dcodeIO.ProtoBuf.Reflect.Message.Field}catch(d){ib._Field=a.Reflect.Message.Field}};ib.encode=function(d,a){ib.establishField();d.encodeAB();var n=new sa;ib._encodeMessageValue(d,a,n);return new p(n.getOutput(),!1)};ib.decode=function(d,a,n){ib.establishField();n="object"===typeof n&&n instanceof p?n.buf():
n;var b=new na(n);ib._decodeMessageValue(d,a,b,n.length)};ib._encodeMessageValue=function(d,a,n){a=a.getChildren(ib._Field);for(var b=a.length-1;0<=b;--b){var c=a[b],g=c.id,l;if(c.repeated)l=d[c.name];else if(null!=d[c.name])l=[d[c.name]];else continue;for(var m=l.length-1;0<=m;--m){var r=l[m];if("message"==c.type.name){var q=n.getLength();ib._encodeMessageValue(r,c.resolvedType,n);n.writeTypeAndLength(g,n.getLength()-q)}else if("uint32"==c.type.name||"uint64"==c.type.name)n.writeNonNegativeIntegerTlv(g,
r);else if("enum"==c.type.name){if(0>r)throw Error("ProtobufTlv.encode: ENUM value may not be negative");n.writeNonNegativeIntegerTlv(g,r)}else if("bytes"==c.type.name)q=r.toBuffer(),void 0==q.length&&(q=new Uint8Array(r.toArrayBuffer())),n.writeBlobTlv(g,q);else if("string"==c.type.name)n.writeBlobTlv(g,(new p(r,!1)).buf());else if("bool"==c.type.name)r&&n.writeTypeAndLength(g,0);else if("double"==c.type.name)q=new f(8),q.writeDoubleLE(r,0),n.writeBlobTlv(g,q);else throw Error("ProtobufTlv.encode: Unknown field type");
}}};ib._decodeMessageValue=function(d,a,n,b){a=a.getChildren(ib._Field);for(var c=0;c<a.length;++c){var g=a[c],f=g.id;if(g.required||n.peekType(f,b))if(g.repeated)for(;n.peekType(f,b);)if("message"==g.type.name){var l=n.readNestedTlvsStart(f),m=new (g.resolvedType.build());d.add(g.name,m);ib._decodeMessageValue(m,g.resolvedType,n,l);n.finishNestedTlvs(l)}else d.add(g.name,ib._decodeFieldValue(g,f,n,b));else"message"==g.type.name?(l=n.readNestedTlvsStart(f),m=new (g.resolvedType.build()),d.set(g.name,
m),ib._decodeMessageValue(m,g.resolvedType,n,l),n.finishNestedTlvs(l)):d.set(g.name,ib._decodeFieldValue(g,f,n,b))}};ib._decodeFieldValue=function(d,a,n,b){if("uint32"==d.type.name||"uint64"==d.type.name||"enum"==d.type.name)return n.readNonNegativeIntegerTlv(a);if("bytes"==d.type.name)return n.readBlobTlv(a);if("string"==d.type.name)return n.readBlobTlv(a).toString();if("bool"==d.type.name)return n.readBooleanTlv(a,b);if("double"==d.type.name)return n.readBlobTlv(a).readDoubleLE(0);throw Error("ProtobufTlv.decode: Unknown field type");
};ib.toName=function(d){for(var a=new c,n=0;n<d.length;++n)a.append(new p(new f(d[n].toBinary(),"binary"),!1));return a};var jb=function(d){if("string"===typeof d){d=d.split(".");this.oid=[];for(var a=0;a<d.length;++a)this.oid.push(parseInt(d[a]))}else this.oid=d.slice(0,d.length)};q.OID=jb;jb.prototype.getIntegerList=function(){return this.oid};jb.prototype.setIntegerList=function(d){this.oid=d.slice(0,d.length)};jb.prototype.toString=function(){for(var d="",a=0;a<this.oid.length;++a)0!==a&&(d+=
"."),d+=this.oid[a];return d};jb.prototype.equals=function(d){if(!(d instanceof jb)||this.oid.length!==d.oid.length)return!1;for(var a=0;a<this.oid.length;++a)if(this.oid[a]!=d.oid[a])return!1;return!0};var r=function(){};q.WireFormat=r;r.prototype.encodeName=function(d){throw Error("encodeName is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeName=function(d,a,n){throw Error("decodeName is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.encodeInterest=function(d){throw Error("encodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeInterest=function(d,a,n){throw Error("decodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.encodeData=function(d){throw Error("encodeData is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeData=function(d,a,n){throw Error("decodeData is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.encodeControlParameters=function(d){throw Error("encodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeControlParameters=function(d,a,n){throw Error("decodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.encodeControlResponse=function(d){throw Error("encodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.decodeControlResponse=function(d,a,n){throw Error("decodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.encodeSignatureInfo=function(d){throw Error("encodeSignatureInfo is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeSignatureInfoAndValue=function(d,a,n){throw Error("decodeSignatureInfoAndValue is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.encodeSignatureValue=function(d){throw Error("encodeSignatureValue is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeLpPacket=function(d,a,n){throw Error("decodeLpPacket is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.encodeDelegationSet=function(d){throw Error("encodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.decodeDelegationSet=
function(d,a,n){throw Error("decodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.encodeEncryptedContent=function(d){throw Error("encodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.decodeEncryptedContent=function(d,a,n){throw Error("decodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.encodeEncryptedContentV2=
function(d){throw Error("encodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.decodeEncryptedContentV2=function(d,a,n){throw Error("decodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};r.setDefaultWireFormat=function(d){r.defaultWireFormat=d};r.getDefaultWireFormat=function(){return r.defaultWireFormat};var fb=a.TlvWireFormat,L=a.DataUtils,m=a.Tlv,F=a.TlvStructureDecoder,S=a.DecodingException,
P=a.NdnCommon,g=a.Log.LOG,Sd=function(d){this.elementListener_=d;this.dataParts_=[];this.tlvStructureDecoder_=new F};q.ElementReader=Sd;Sd.prototype.onReceivedData=function(d){for(;;){var a,n;try{if(0===this.dataParts_.length&&0>=d.length)break;this.tlvStructureDecoder_.seek(0);a=this.tlvStructureDecoder_.findElementEnd(d);n=this.tlvStructureDecoder_.getOffset()}catch(b){throw this.dataParts_=[],this.tlvStructureDecoder_=new F,b;}if(a){var c;0===this.dataParts_.length?c=d.slice(0,n):(this.dataParts_.push(d.slice(0,
n)),c=L.concatArrays(this.dataParts_),this.dataParts_=[]);d=d.slice(n,d.length);this.tlvStructureDecoder_=new F;this.elementListener_.onReceivedElement(c);if(0==d.length)break}else{a=d.length;for(n=0;n<this.dataParts_.length;++n)a+=this.dataParts_[n].length;if(a>P.MAX_NDN_PACKET_SIZE)throw this.dataParts_=[],this.tlvStructureDecoder_=new F,new S(Error("The incoming packet exceeds the maximum limit Face.getMaxNdnPacketSize()"));this.dataParts_.push(new f(d));3<g&&console.log("Incomplete packet received. Length "+
d.length+". Wait for more input.");break}}};ua.prototype=Error();ua.prototype.name="DerDecodingException";q.DerDecodingException=ua;Ob.prototype=Error();Ob.prototype.name="DerEncodingException";q.DerEncodingException=Ob;var O=function(){};q.DerNodeType=O;O.Eoc=0;O.Boolean=1;O.Integer=2;O.BitString=3;O.OctetString=4;O.Null=5;O.ObjectIdentifier=6;O.ObjectDescriptor=7;O.External=40;O.Real=9;O.Enumerated=10;O.EmbeddedPdv=43;O.Utf8String=12;O.RelativeOid=13;O.Sequence=48;O.Set=49;O.NumericString=18;O.PrintableString=
19;O.T61String=20;O.VideoTexString=21;O.Ia5String=22;O.UtcTime=23;O.GeneralizedTime=24;O.GraphicString=25;O.VisibleString=26;O.GeneralString=27;O.UniversalString=28;O.CharacterString=29;O.BmpString=30;var cb=a.DynamicBuffer,p=a.Blob,ua=a.DerDecodingException,Ob=a.DerEncodingException,O=a.DerNodeType,l=function(d){this.nodeType_=d;this.parent_=null;this.header_=new f(0);this.payload_=new cb(0);this.payloadPosition_=0};q.DerNode=l;l.prototype.getSize=function(){return this.header_.length+this.payloadPosition_};
l.prototype.encodeHeader=function(d){var a=new cb(10),n=0;a.array[n++]=this.nodeType_;if(0>d)throw Error("encodeHeader: DER object has negative length");if(127>=d)a.array[n++]=d&255;else{var b=new cb(10),c=d;for(d=0;0!=c;)++d,b.ensureLengthFromBack(d),b.array[b.array.length-d]=c&255,c>>=8;c=d+1;b.ensureLengthFromBack(c);b.array[b.array.length-c]=(128|d)&255;a.copy(b.slice(b.array.length-c),n);n+=c}this.header_=a.slice(0,n)};l.prototype.decodeHeader=function(d,a){var n=a,b=d[n]&255,n=n+1;this.nodeType_=
b;var c=d[n]&255,n=n+1,g=new cb(10),f=0;g.array[f++]=b;b=g.array[f++]=c;if(0!=(c&128))for(c&=127,b=0;0<c;){if(d.length<=n)throw new ua("DerNode.decodeHeader: The input length is too small");var l=d[n],n=n+1;g.ensureLength(f+1);g.array[f++]=l;b=256*b+(l&255);c-=1}this.header_=g.slice(0,f);return b};l.prototype.encode=function(){var d=new f(this.getSize());this.header_.copy(d);this.payload_.slice(0,this.payloadPosition_).copy(d,this.header_.length);return new p(d,!1)};l.prototype.decode=function(d,
a){var n=a,b=this.decodeHeader(d,n),c=this.header_.length;0<b&&(n+=c,this.payloadAppend(d.slice(n,n+b)))};l.prototype.payloadAppend=function(d){this.payloadPosition_=this.payload_.copy(d,this.payloadPosition_)};l.parse=function(d,a){void 0==a&&(a=0);if(d.length<=a)throw new ua("DerNode.parse: The input length is too small");var n=d[a]&255;if(n===O.Boolean)n=new l.DerBoolean;else if(n===O.Integer)n=new l.DerInteger;else if(n===O.BitString)n=new l.DerBitString;else if(n===O.OctetString)n=new l.DerOctetString;
else if(n===O.Null)n=new l.DerNull;else if(n===O.ObjectIdentifier)n=new l.DerOid;else if(n===O.Sequence)n=new l.DerSequence;else if(n===O.PrintableString)n=new l.DerPrintableString;else if(n===O.GeneralizedTime)n=new l.DerGeneralizedTime;else throw new ua(Error("Unimplemented DER type "+n));n.decode(d,a);return n};l.prototype.toVal=function(){return this.encode()};l.prototype.getPayload=function(){return new p(this.payload_.slice(0,this.payloadPosition_),!0)};l.prototype.getChildren=function(){throw new ua(Error("getChildren: This DerNode is not DerSequence"));
};l.getSequence=function(d,a){if(0>a||a>=d.length)throw new ua(Error("getSequence: Child index is out of bounds"));if(!(d[a]instanceof l.DerSequence))throw new ua(Error("getSequence: Child DerNode is not a DerSequence"));return d[a]};l.DerStructure=function(d){l.call(this,d);this.childChanged_=!1;this.nodeList_=[];this.size_=0};l.DerStructure.prototype=new l;l.DerStructure.prototype.name="DerStructure";l.DerStructure.prototype.getSize=function(){this.childChanged_&&(this.updateSize(),this.childChanged_=
!1);this.encodeHeader(this.size_);return this.size_+this.header_.length};l.DerStructure.prototype.getChildren=function(){return this.nodeList_};l.DerStructure.prototype.updateSize=function(){for(var d=0,a=0;a<this.nodeList_.length;++a)d+=this.nodeList_[a].getSize();this.size_=d;this.childChanged_=!1};l.DerStructure.prototype.addChild=function(d,a){d.parent_=this;this.nodeList_.push(d);a&&null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};l.DerStructure.prototype.setChildChanged=
function(){null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};l.DerStructure.prototype.encode=function(){var d=new cb(10),a=0;this.updateSize();this.encodeHeader(this.size_);for(var a=d.copy(this.header_,a),n=0;n<this.nodeList_.length;++n)var b=this.nodeList_[n].encode(),a=d.copy(b.buf(),a);return new p(d.slice(0,a),!1)};l.DerStructure.prototype.decode=function(d,a){var n=a;this.size_=this.decodeHeader(d,n);for(var n=n+this.header_.length,b=0;b<this.size_;){var c=l.parse(d,
n),g=c.getSize(),n=n+g,b=b+g;this.addChild(c,!1)}};l.DerByteString=function(d,a){l.call(this,a);null!=d&&(this.payloadAppend(d),this.encodeHeader(d.length))};l.DerByteString.prototype=new l;l.DerByteString.prototype.name="DerByteString";l.DerByteString.prototype.toVal=function(){return this.getPayload()};l.DerBoolean=function(d){l.call(this,O.Boolean);void 0!=d&&(d=d?255:0,this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=d,this.encodeHeader(1))};l.DerBoolean.prototype=
new l;l.DerBoolean.prototype.name="DerBoolean";l.DerBoolean.prototype.toVal=function(){return 0!=this.payload_.array[0]};l.DerInteger=function(d){l.call(this,O.Integer);if(void 0!=d){if(f.isBuffer(d)){if(0<d.length&&128<=d[0])throw new Ob(Error("DerInteger: Negative integers are not currently supported"));0==d.length?this.payloadAppend(new f([0])):this.payloadAppend(d)}else{d=Math.round(d);if(0>d)throw new Ob(Error("DerInteger: Negative integers are not currently supported"));for(var a=new cb(10),
n=0;!(++n,a.ensureLengthFromBack(n),a.array[a.array.length-n]=d&255,d>>=8,0>=d););128<=a.array[a.array.length-n]&&(++n,a.ensureLengthFromBack(n),a.array[a.array.length-n]=0);this.payloadAppend(a.slice(a.array.length-n))}this.encodeHeader(this.payloadPosition_)}};l.DerInteger.prototype=new l;l.DerInteger.prototype.name="DerInteger";l.DerInteger.prototype.toVal=function(){if(0<this.payloadPosition_&&128<=this.payload_.array[0])throw new ua(Error("DerInteger: Negative integers are not currently supported"));
for(var d=0,a=0;a<this.payloadPosition_;++a)d<<=8,d+=this.payload_.array[a];return d};l.DerBitString=function(d,a){l.call(this,O.BitString);void 0!=d&&(this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=a&255,this.payloadAppend(d),this.encodeHeader(this.payloadPosition_))};l.DerBitString.prototype=new l;l.DerBitString.prototype.name="DerBitString";l.DerOctetString=function(d){l.DerByteString.call(this,d,O.OctetString)};l.DerOctetString.prototype=new l.DerByteString;
l.DerOctetString.prototype.name="DerOctetString";l.DerNull=function(){l.call(this,O.Null);this.encodeHeader(0)};l.DerNull.prototype=new l;l.DerNull.prototype.name="DerNull";l.DerOid=function(d){l.call(this,O.ObjectIdentifier);if(void 0!=d)if("string"===typeof d){d=d.split(".");for(var a=[],n=0;n<d.length;++n)a.push(parseInt(d[n]));this.prepareEncoding(a)}else this.prepareEncoding(d.getIntegerList())};l.DerOid.prototype=new l;l.DerOid.prototype.name="DerOid";l.DerOid.prototype.prepareEncoding=function(d){var a;
if(0==d.length)throw new Ob(Error("No integer in OID"));if(0<=d[0]&&2>=d[0])a=40*d[0];else throw new Ob(Error("First integer in OID is out of range"));if(2<=d.length)if(0<=d[1]&&39>=d[1])a+=d[1];else throw new Ob(Error("Second integer in OID is out of range"));var n=new cb(10),b=0,b=n.copy(l.DerOid.encode128(a),b);if(2<d.length)for(a=2;a<d.length;++a)b=n.copy(l.DerOid.encode128(d[a]),b);this.encodeHeader(b);this.payloadAppend(n.slice(0,b))};l.DerOid.encode128=function(d){var a=new cb(10),n=0;if(128>
d)++n,a.array[a.array.length-n]=d&127;else for(++n,a.array[a.array.length-n]=d&127,d>>=7;0!=d;)++n,a.ensureLengthFromBack(n),a.array[a.array.length-n]=d&127|128,d>>=7;return a.slice(a.array.length-n)};l.DerOid.prototype.decode128=function(d,a){for(var n=0,b=d;0!=(this.payload_.array[d]&128);)n=128*n+(this.payload_.array[d]&255)-128,d+=1;n=128*n+(this.payload_.array[d]&255);a[0]=d-b+1;return n};l.DerOid.prototype.toVal=function(){for(var d=0,a=[];d<this.payloadPosition_;){var n=[0],b=this.decode128(d,
n),d=d+n[0];a.push(b)}d=a[0];d=Math.floor(d/40)+"."+d%40;for(n=1;n<a.length;++n)d+="."+a[n];return d};l.DerSequence=function(){l.DerStructure.call(this,O.Sequence)};l.DerSequence.prototype=new l.DerStructure;l.DerSequence.prototype.name="DerSequence";l.DerPrintableString=function(d){l.DerByteString.call(this,d,O.PrintableString)};l.DerPrintableString.prototype=new l.DerByteString;l.DerPrintableString.prototype.name="DerPrintableString";l.DerGeneralizedTime=function(d){l.call(this,O.GeneralizedTime);
void 0!=d&&(d=l.DerGeneralizedTime.toDerTimeString(d),this.payloadAppend((new p(d)).buf()),this.encodeHeader(this.payloadPosition_))};l.DerGeneralizedTime.prototype=new l;l.DerGeneralizedTime.prototype.name="DerGeneralizedTime";l.DerGeneralizedTime.toDerTimeString=function(d){d=new Date(Math.round(d));return d.getUTCFullYear()+l.DerGeneralizedTime.to2DigitString(d.getUTCMonth()+1)+l.DerGeneralizedTime.to2DigitString(d.getUTCDate())+l.DerGeneralizedTime.to2DigitString(d.getUTCHours())+l.DerGeneralizedTime.to2DigitString(d.getUTCMinutes())+
l.DerGeneralizedTime.to2DigitString(d.getUTCSeconds())+"Z"};l.DerGeneralizedTime.to2DigitString=function(d){d=d.toString();return 1===d.length?"0"+d:d};l.DerGeneralizedTime.prototype.toVal=function(){var d=this.payload_.slice(0,this.payloadPosition_).toString();return Date.UTC(parseInt(d.substr(0,4)),parseInt(d.substr(4,2)-1),parseInt(d.substr(6,2)),parseInt(d.substr(8,2)),parseInt(d.substr(10,2)),parseInt(d.substr(12,2)))};var Qb=a,ec=function(d,a){this.subtrees=[];this.value=d;this.parent=a;this.lastChild=
null};ec.prototype.addSubtree=function(d,a){var n=this.find(d);null!==n?n.push(a):this.subtrees.push({key:d,value:[a]});a.parent=this;this.lastChild=a};ec.prototype.createSubtree=function(d,a){var n=new ec(a,this);this.addSubtree(d,n);return n};ec.prototype.get=function(d){d=d.replace(/^\/+/,"");if(0===d.length)return[this];var a=d.split("/");d=this.find(a[0]);if(null===d)return[];if(1==a.length)return d.slice(0);for(var a=a.slice(1).join("/"),n=[],b=0;b<d.length;++b)var c=d[b].get(a),n=n.concat(c);
return n};ec.prototype.getFirstValue=function(d){d=this.get(d);return 1<=d.length?d[0].value:null};ec.prototype.getValue=function(){return this.value};ec.prototype.getParent=function(){return this.parent};ec.prototype.getLastChild=function(){return this.lastChild};ec.prototype.prettyPrint=function(d){d=d||1;var a=Array(d+1).join(" "),n="";null!=this.parent&&(this.value&&0<this.value.length&&(n+='"'+this.value+'"'),n+="\n");if(0<this.subtrees.length){this.parent&&(n+=a+"{\n");for(var b=Array(d+2+1).join(" "),
c=0;c<this.subtrees.length;++c)for(var g=0;g<this.subtrees[c].value.length;++g)n+=b+this.subtrees[c].key+" "+this.subtrees[c].value[g].prettyPrint(d+2);this.parent&&(n+=a+"}\n")}return n};ec.prototype.toString=function(){return this.prettyPrint()};ec.prototype.find=function(d){for(var a=0;a<this.subtrees.length;++a)if(this.subtrees[a].key==d)return this.subtrees[a].value;return null};var kc=function(){this.root=new ec};q.BoostInfoParser=kc;q.BoostInfoTree=ec;kc.prototype.read=function(d,a){var n;
"string"==typeof a?n=d:(a=d,n=Qb.readFileSync(d).toString());var b=this.root,c=this;n.split(/\r?\n/).forEach(function(d){b=c.parseLine(d.trim(),b)})};kc.prototype.write=function(d){Qb.writeFileSync(d,""+this.root)};kc.prototype.getRoot=function(){return this.root};kc.shlex_split=function(d){var a=[];if(""==d)return a;for(var n=0;;){for(;0<=" \t\n\r".indexOf(d[n]);)if(n+=1,n>=d.length)return a;for(var b=n,c=!1,g="";;){if("\\"==d[b]){if(g+=d.substring(n,b),b=n=b+1,b>=d.length)break}else if(c)'"'==d[b]&&
(g+=d.substring(n,b),n=b+1,c=!1);else if('"'==d[b])g+=d.substring(n,b),n=b+1,c=!0;else if(0<=" \t\n\r".indexOf(d[b]))break;b+=1;if(b>=d.length)break}g+=d.substring(n,b);a.push(g);if(b>=d.length)return a;n=b}};kc.prototype.parseLine=function(d,a){var n=d.indexOf(";");0<=n&&(d=d.substring(0,n).trim());if(0==d.length)return a;for(var n=kc.shlex_split(d),b=!1,c=!1,g=0;g<n.length;++g)b=b||"{"==n[g],c=c||"}"==n[g];if(!b&&!c){var b=n[0],f;1<n.length&&(f=n[1]);a.createSubtree(b,f);return a}n=d.indexOf("{");
if(0<n)return f=d.substring(0,n),n=d.substring(n),f=this.parseLine(f,a),this.parseLine(n,f);if("{"==d[0])return a=a.getLastChild();if("}"==d[0])return a=a.getParent();throw runtime_error("BoostInfoParser: input line is malformed");};var c=a.Name,zc=a.InterestFilter,va=a.RegistrationOptions,r=a.WireFormat,g=a.Log.LOG,Qa=function(d,a){a=a||1E3;this.face=d;this.cleanupIntervalMilliseconds=a;this.nextCleanupTime=(new Date).getTime()+a;this.onDataNotFoundForPrefix={};this.interestFilterIdList=[];this.registeredPrefixIdList=
[];this.noStaleTimeCache=[];this.staleTimeCache=[];this.emptyComponent=new c.Component;this.pendingInterestTable=[];this.minimumCacheLifetime_=0;var n=this;this.storePendingInterestCallback=function(d,a,b,c,g){n.storePendingInterest(a,b)}};q.MemoryContentCache=Qa;Qa.prototype.registerPrefix=function(d,a,n,b,c,g){var f=n,l=b,m=c;n="object"===typeof f&&1===f.length&&"function"===typeof f[0]?f[0]:null;b="function"===typeof f?f:"function"===typeof l?l:null;c=f instanceof va?f:l instanceof va?l:m instanceof
va?m:new va;g=f instanceof r?f:l instanceof r?l:m instanceof r?m:g instanceof r?g:r.getDefaultWireFormat();b&&(this.onDataNotFoundForPrefix[d.toUri()]=b);d=this.face.registerPrefix(d,this.onInterest.bind(this),a,n,c,g);this.registeredPrefixIdList.push(d)};Qa.prototype.setInterestFilter=function(d,a){if(a){var n;n="object"===typeof d&&d instanceof zc?d.getPrefix():d;this.onDataNotFoundForPrefix[n.toUri()]=a}n=this.face.setInterestFilter(d,this.onInterest.bind(this));this.interestFilterIdList.push(n)};
Qa.prototype.unregisterAll=function(){for(var d=0;d<this.interestFilterIdList.length;++d)this.face.unsetInterestFilter(this.interestFilterIdList[d]);this.interestFilterIdList=[];for(d=0;d<this.registeredPrefixIdList.length;++d)this.face.removeRegisteredPrefix(this.registeredPrefixIdList[d]);this.registeredPrefixIdList=[];this.onDataNotFoundForPrefix={}};Qa.prototype.add=function(d){var a=(new Date).getTime();this.doCleanup(a);if(null!=d.getMetaInfo().getFreshnessPeriod()&&0<=d.getMetaInfo().getFreshnessPeriod()){for(var n=
new Qa.StaleTimeContent(d,a,this.minimumCacheLifetime_),b=this.staleTimeCache.length-1;0<=b&&!(this.staleTimeCache[b].cacheRemovalTimeMilliseconds_<=n.cacheRemovalTimeMilliseconds_);)--b;this.staleTimeCache.splice(b+1,0,n)}else this.noStaleTimeCache.push(new Qa.Content(d));for(b=this.pendingInterestTable.length-1;0<=b;--b)if(this.pendingInterestTable[b].isTimedOut(a))this.pendingInterestTable.splice(b,1);else if(this.pendingInterestTable[b].getInterest().matchesName(d.getName())){try{3<g&&console.log("MemoryContentCache:  Reply w/ add Data "+
d.getName().toUri()),this.pendingInterestTable[b].getFace().send(d.wireEncode().buf())}catch(c){0<g&&console.log(""+c);break}this.pendingInterestTable.splice(b,1)}};Qa.prototype.storePendingInterest=function(d,a){this.pendingInterestTable.push(new Qa.PendingInterest(d,a))};Qa.prototype.getStorePendingInterest=function(){return this.storePendingInterestCallback};Qa.prototype.getMinimumCacheLifetime=function(){return this.minimumCacheLifetime_};Qa.prototype.setMinimumCacheLifetime=function(d){this.minimumCacheLifetime_=
d};Qa.prototype.onInterest=function(d,a,n,b,c){3<g&&console.log("MemoryContentCache:  Received Interest "+a.toUri());var f=(new Date).getTime();this.doCleanup(f);for(var l=null,m=null,p=this.staleTimeCache.length+this.noStaleTimeCache.length,r=0;r<p;++r){var q,v=!0;r<this.staleTimeCache.length?(q=this.staleTimeCache[r],v=q.isFresh(f)):q=this.noStaleTimeCache[r-this.staleTimeCache.length];if(a.matchesName(q.getName())&&(!a.getMustBeFresh()||v)){if(null==a.getChildSelector()){3<g&&console.log("MemoryContentCache:         Reply Data "+
q.getName().toUri());n.send(q.getDataEncoding());return}var v=q.getName().size()>a.getName().size()?q.getName().get(a.getName().size()):this.emptyComponent,F=!1;null===m?F=!0:0==a.getChildSelector()?0>v.compare(l)&&(F=!0):0<v.compare(l)&&(F=!0);F&&(l=v,m=q.getDataEncoding())}}null!==m?(3<g&&console.log("MemoryContentCache: Reply Data to Interest "+a.toUri()),n.send(m)):(3<g&&console.log("MemoryContentCache: onDataNotFound for "+a.toUri()),(f=this.onDataNotFoundForPrefix[d.toUri()])&&f(d,a,n,b,c))};
Qa.prototype.doCleanup=function(d){if(d>=this.nextCleanupTime){for(;0<this.staleTimeCache.length&&this.staleTimeCache[0].isPastRemovalTime(d);)this.staleTimeCache.shift();this.nextCleanupTime=d+this.cleanupIntervalMilliseconds}};Qa.Content=function(d){d&&(this.name=new c(d.getName()),this.dataEncoding=d.wireEncode().buf())};Qa.Content.prototype.getName=function(){return this.name};Qa.Content.prototype.getDataEncoding=function(){return this.dataEncoding};Qa.StaleTimeContent=function(d,a,n){Qa.Content.call(this,
d);this.cacheRemovalTimeMilliseconds_=a+Math.max(d.getMetaInfo().getFreshnessPeriod(),n);this.freshnessExpiryTimeMilliseconds_=a+d.getMetaInfo().getFreshnessPeriod()};Qa.StaleTimeContent.prototype=new Qa.Content;Qa.StaleTimeContent.prototype.name="StaleTimeContent";Qa.StaleTimeContent.prototype.isPastRemovalTime=function(d){return this.cacheRemovalTimeMilliseconds_<=d};Qa.StaleTimeContent.prototype.isFresh=function(d){return this.freshnessExpiryTimeMilliseconds_>d};Qa.PendingInterest=function(d,a){this.interest=
d;this.face=a;var n=this.interest.getInterestLifetimeMilliseconds();if(null==n||0>n)n=4E3;this.timeoutMilliseconds=(new Date).getTime()+n};Qa.PendingInterest.prototype.getInterest=function(){return this.interest};Qa.PendingInterest.prototype.getFace=function(){return this.face};Qa.PendingInterest.prototype.isTimedOut=function(d){return d>=this.timeoutTimeMilliseconds};var E=a.Interest,C=a.KeyChain,lb=a.PipelineFixed,de=function(){};q.SegmentFetcher=de;de.ErrorCode={INTEREST_TIMEOUT:1,DATA_HAS_NO_SEGMENT:2,
SEGMENT_VERIFICATION_FAILED:3,INVALID_KEYCHAIN:4};de.DontVerifySegment=function(d){return!0};de.fetch=function(d,a,n,b,c){var g=a.getName().toUri();null==n||n instanceof C?(new lb(g,d,n,b,c)).fetchFirstSegment(a):c(de.ErrorCode.INVALID_KEYCHAIN,"validatorKeyChain should be either a KeyChain instance or null.")};var E=a.Interest,p=a.Blob,C=a.KeyChain,P=a.NdnCommon,bd=a.DataFetcher,lb=function(d,a,n,b,c){this.contentPrefix=d;this.face=a;this.validatorKeyChain=n;this.onComplete=b;this.onError=c;this.segmentsOnFly=
this.nextSegmentToRequest=this.numberOfSatisfiedSegments=0;this.finalBlockId=Number.MAX_SAFE_INTEGER;this.windowSize=10;this.maxNackRetries=this.maxTimeoutRetries=3;this.contentParts=[];this.dataFetchersContainer=[]};q.PipelineFixed=lb;lb.ErrorCode={INTEREST_TIMEOUT:1,DATA_HAS_NO_SEGMENT:2,SEGMENT_VERIFICATION_FAILED:3,NACK_RECEIVED:4};lb.prototype.fetchSegment=function(d){if(d.getName().get(-1).isSegment()){var a=d.getName().get(-1).toSegment();this.dataFetchersContainer[a]=new bd(this.face,d,this.maxTimeoutRetries,
this.maxNackRetries,this.onData.bind(this),this.onTimeout.bind(this),this.onNack.bind(this));this.dataFetchersContainer[a].fetch()}else(new bd(this.face,d,this.maxTimeoutRetries,this.maxNackRetries,this.onData.bind(this),this.onTimeout.bind(this),this.onNack.bind(this))).fetch()};lb.prototype.fetchFirstSegment=function(d){d=new E(d);d.setMustBeFresh(!0);this.fetchSegment(d)};lb.prototype.fetchNextSegments=function(d,a){var n=new E(d);for(n.setMustBeFresh(!1);this.nextSegmentToRequest<=this.finalBlockId&&
this.segmentsOnFly<=this.windowSize;)void 0!==this.contentParts[this.nextSegmentToRequest]?this.nextSegmentToRequest+=1:(n.setName(a.getPrefix(-1).appendSegment(this.nextSegmentToRequest)),n.refreshNonce(),this.fetchSegment(n),this.nextSegmentToRequest+=1,this.increaseNumberOfSegmentsOnFly())};lb.prototype.cancelPendingInterestsAboveFinalBlockId=function(){for(var d=this.dataFetchersContainer.length,a=this.finalBlockId+1;a<d;a++)null!==this.dataFetchersContainer[a]&&this.dataFetchersContainer[a].cancelPendingInterest()};
lb.prototype.onData=function(d,a){if(null!==this.validatorKeyChain)try{var n=this;this.validatorKeyChain.verifyData(a,function(a){n.onVerified(a,d)},this.onValidationFailed.bind(this))}catch(b){this.reportError(lb.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Error in KeyChain.verifyData: "+b)}else this.onVerified(a,d)};lb.prototype.onVerified=function(d,a){var n=0;try{n=d.getName().get(-1).toSegment()}catch(b){this.reportError(lb.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the name segment number "+d.getName().get(-1).toEscapedString()+
": "+b);return}if(0<d.getMetaInfo().getFinalBlockId().getValue().size())try{this.finalBlockId=d.getMetaInfo().getFinalBlockId().toSegment(),this.cancelPendingInterestsAboveFinalBlockId()}catch(c){this.reportError(lb.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the FinalBlockId segment number "+d.getMetaInfo().getFinalBlockId().toEscapedString()+": "+c);return}this.numberOfSatisfiedSegments+=1;this.contentParts[n]=d.getContent().buf();if(this.numberOfSatisfiedSegments>this.finalBlockId){n=f.concat(this.contentParts);
try{this.onComplete(new p(n,!1))}catch(g){console.log("Error in onComplete: "+P.getErrorWithStackTrace(g))}}else this.decreaseNumberOfSegmentsOnFly(),this.fetchNextSegments(a,d.getName())};lb.prototype.onValidationFailed=function(d,a){this.reportError(lb.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+d.getName().toUri()+" . Reason: "+a)};lb.prototype.onTimeout=function(d){this.reportError(lb.ErrorCode.INTEREST_TIMEOUT,"Time out for interest "+d.getName().toUri())};lb.prototype.onNack=
function(d){this.reportError(lb.ErrorCode.NACK_RECEIVED,"Received Nack for interest "+d.getName().toUri())};lb.prototype.increaseNumberOfSegmentsOnFly=function(){this.segmentsOnFly++};lb.prototype.decreaseNumberOfSegmentsOnFly=function(){this.segmentsOnFly=Math.max(this.segmentsOnFly-1,0)};lb.prototype.reportError=function(d,a){try{this.onError(d,a)}catch(n){console.log("Error in onError: "+P.getErrorWithStackTrace(n))}};E=a.Interest;g=a.Log.LOG;bd=function(d,a,n,b,c,g,f){this.face=d;this.interest=
a;this.maxNackRetries=b;this.maxTimeoutRetries=n;this.onData=c;this.onTimeout=g;this.onNack=f;this.numberOfTimeoutRetries=0;this.pendingInterestId=null};q.DataFetcher=bd;bd.prototype.fetch=function(){this.pendingInterestId=this.face.expressInterest(this.interest,this.handleData.bind(this),this.handleTimeout.bind(this),this.handleNack.bind(this))};bd.prototype.cancelPendingInterest=function(){this.face.removePendingInterest(this.pendingInterestId)};bd.prototype.handleData=function(d,a){this.onData(d,
a)};bd.prototype.handleTimeout=function(d){this.numberOfTimeoutRetries++;if(this.numberOfTimeoutRetries<=this.maxTimeoutRetries){var a=new E(d);a.refreshNonce();this.interest=a;3<g&&console.log("handle timeout for interest "+d.getName());this.fetch()}else this.onTimeout(d)};bd.prototype.handleNack=function(d){this.numberOfNackRetries+=1;if(this.numberOfNackRetries<=this.maxNackRetries){var a=new E(d);a.refreshNonce();this.interest=a;3<g&&console.log("handle nack for interest "+d.getName());setTimeout(this.fetch.bind(this),
40+20*Math.random())}else this.onNack(d)};var Mc=function(){this.backrefs_=[]};q.NdnRegexBackrefManager=Mc;Mc.prototype.pushRef=function(d){last=this.backrefs_.length;this.backrefs_.push(d);return last};Mc.prototype.popRef=function(){this.backrefs_.pop()};Mc.prototype.size=function(){return this.backrefs_.length};Mc.prototype.getBackref=function(d){return this.backrefs_[d]};var Mc=a.NdnRegexBackrefManager,Z=function(d,a,n){this.matchers_=[];this.matchResult_=[];this.expr_=d;this.type_=a;void 0==n&&
(n=new Mc);this.backrefManager_=n};q.NdnRegexMatcherBase=Z;Z.Error=function(d){if(d)return d.__proto__=Z.Error.prototype,d};Z.Error.prototype=Error();Z.Error.prototype.name="NdnRegexMatcherBaseError";Z.NdnRegexExprType={TOP:0,PATTERN_LIST:1,REPEAT_PATTERN:2,BACKREF:3,COMPONENT_SET:4,COMPONENT:5,PSEUDO:6};Z.prototype.match=function(d,a,n){var b=!1;this.matchResult_=[];if(this.recursiveMatch_(0,d,a,n)){for(b=a;b<a+n;)this.matchResult_.push(d.get(b)),++b;b=!0}else b=!1;return b};Z.prototype.getMatchResult=
function(){return this.matchResult_};Z.prototype.getExpr=function(){return this.expr_};Z.prototype.compile_=function(){throw Error("NdnRegexMatcherBase.compile is not implemented");};Z.prototype.recursiveMatch_=function(d,a,n,b){var c=b;if(d>=this.matchers_.length)return 0==b;for(var g=this.matchers_[d];0<=c;){if(g.match(a,n,c)&&this.recursiveMatch_(d+1,a,n+c,b-c))return!0;--c}return!1};var Z=a.NdnRegexMatcherBase,cd=function(d,a){Z.call(this,d,Z.NdnRegexExprType.BACKREF,a)};cd.prototype=new Z;cd.prototype.name=
"NdnRegexBackrefMatcher";q.NdnRegexBackrefMatcher=cd;cd.prototype.lateCompile=function(){this.compile_()};cd.prototype.compile_=function(){if(2>this.expr_.length)throw new Z.Error(Error("Unrecognized format: "+this.expr_));var d=this.expr_.length-1;if("("===this.expr_[0]&&")"===this.expr_[d])d=new lc(this.expr_.substring(1,d),this.backrefManager_),this.matchers_.push(d);else throw new Z.Error(Error("Unrecognized format: "+this.expr_));};var lc=a.NdnRegexPatternListMatcher,Z=a.NdnRegexMatcherBase,
dd=a.NdnRegexPseudoMatcher,rd=function(d,a,n){Z.call(this,d,Z.NdnRegexExprType.COMPONENT,a);void 0===n&&(n=!0);this.componentRegex_=null;this.pseudoMatchers_=[];this.isExactMatch_=n;this.compile_()};rd.prototype=new Z;rd.prototype.name="NdnRegexComponentMatcher";q.NdnRegexComponentMatcher=rd;rd.prototype.match=function(d,a,n){this.matchResult_=[];if(""==this.expr_)return this.matchResult_.push(d.get(a)),!0;if(this.isExactMatch_){if(n=d.get(a).toEscapedString().match(this.componentRegex_),null!==n){for(var b=
1;b<n.length;++b)this.pseudoMatchers_[b].resetMatchResult(),this.pseudoMatchers_[b].setMatchResult(n[b]);this.matchResult_.push(d.get(a));return!0}}else throw new Z.Error(Error("Non-exact component search is not supported yet"));return!1};rd.prototype.compile_=function(){this.componentRegex_=new RegExp(this.expr_);this.pseudoMatchers_=[];this.pseudoMatchers_.push(new dd);if(0<=this.expr_.indexOf("\\("))throw new Z.Error(Error("Can't count subexpressions in regex with escaped parentheses: "+expr_));
for(var d=0,a=0;a<this.expr_.length;++a)"("===this.expr_[a]&&++d;for(a=1;a<=d;++a){var n=new dd;this.pseudoMatchers_.push(n);this.backrefManager_.pushRef(n)}};var Z=a.NdnRegexMatcherBase,Nc=function(d,a){Z.call(this,d,Z.NdnRegexExprType.COMPONENT_SET,a);this.components_=[];this.isInclusion_=!0;this.compile_()};Nc.prototype=new Z;Nc.prototype.name="NdnRegexComponentSetMatcher";q.NdnRegexComponentSetMatcher=Nc;Nc.prototype.match=function(d,a,n){isMatched=!1;if(1!==n)return!1;for(var b=0;b<this.components_.length;++b)if(this.components_[b].match(d,
a,n)){isMatched=!0;break}this.matchResult_=[];return(this.isInclusion_?isMatched:!isMatched)?(this.matchResult_.push(d.get(a)),!0):!1};Nc.prototype.compile_=function(){if(2>this.expr_.length)throw new Z.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));if("<"===this.expr_[0])this.compileSingleComponent_();else if("["===this.expr_[0]){var d=this.expr_.length-1;if("]"!==this.expr_[d])throw new Z.Error(Error("Regexp compile error (no matching ']' in "+this.expr_+")"));"^"===this.expr_[1]?
(this.isInclusion_=!1,this.compileMultipleComponents_(2,d)):this.compileMultipleComponents_(1,d)}else throw new Z.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));};Nc.prototype.extractComponent_=function(d){for(var a=1,n=0;a>n;){if(d>=this.expr_.length)throw new Z.Error(Error("Error: angle brackets mismatch"));"<"===this.expr_[d]?a+=1:">"===this.expr_[d]&&(n+=1);d+=1}return d};Nc.prototype.compileSingleComponent_=function(){var d=this.extractComponent_(1);if(this.expr_.length!==
d)throw new Z.Error(Error("Component expr error "+this.expr_));component=new rd(this.expr_.substring(1,d-1),this.backrefManager_);this.components_.push(component)};Nc.prototype.compileMultipleComponents_=function(d,a){for(var n=d,b=d;n<a;){if("<"!==this.expr_[n])throw new Z.Error(Error("Component expr error "+this.expr_));b=n+1;n=this.extractComponent_(b);component=new rd(this.expr_.substring(b,n-1),this.backrefManager_);this.components_.push(component)}if(n!=a)throw new Z.Error(Error("Not sufficient expr to parse "+
this.expr_));};rd=a.NdnRegexComponentMatcher;Z=a.NdnRegexMatcherBase;lc=function(d,a){Z.call(this,d,Z.NdnRegexExprType.PATTERN_LIST,a);this.compile_()};lc.prototype=new Z;lc.prototype.name="NdnRegexPatternListMatcher";q.NdnRegexPatternListMatcher=lc;lc.prototype.compile_=function(){for(var d=this.expr_.length,a=[0],n=a[0];a[0]<d;)if(n=a[0],!this.extractPattern_(n,a))throw new Z.Error(Error("Compile error"));};lc.prototype.extractPattern_=function(d,a){var n=d,b=d,c=d;if("("===this.expr_[d])c=d=this.extractSubPattern_("(",
")",d+1),b=this.extractRepetition_(d),c===b?(n=new cd(this.expr_.substring(n,b),this.backrefManager_),this.backrefManager_.pushRef(n),n.lateCompile(),this.matchers_.push(n)):this.matchers_.push(new Ac(this.expr_.substring(n,b),this.backrefManager_,c-n));else if("<"===this.expr_[d])d+=1,c=d=this.extractSubPattern_("<",">",d),b=this.extractRepetition_(d),this.matchers_.push(new Ac(this.expr_.substring(n,b),this.backrefManager_,c-n));else if("["===this.expr_[d])d+=1,c=d=this.extractSubPattern_("[","]",
d),b=this.extractRepetition_(d),this.matchers_.push(new Ac(this.expr_.substring(n,b),this.backrefManager_,c-n));else throw new Z.Error(Error("Unexpected syntax"));a[0]=b;return!0};lc.prototype.extractSubPattern_=function(d,a,n){for(var b=1,c=0;b>c;){if(n>=this.expr_.length)throw new Z.Error(Error("Parenthesis mismatch"));d==this.expr_[n]&&(b+=1);a==this.expr_[n]&&(c+=1);n+=1}return n};lc.prototype.extractRepetition_=function(d){var a=this.expr_.length;if(d===a)return d;if("+"==this.expr_[d]||"?"==
this.expr_[d]||"*"==this.expr_[d])return++d,d;if("{"==this.expr_[d]){for(;"}"!=this.expr_[d]&&(++d,d!==a););if(d===a)throw new Z.Error(Error("Missing right brace bracket"));++d}return d};var cd=a.NdnRegexBackrefMatcher,Ac=a.NdnRegexRepeatMatcher,c=a.Name,Z=a.NdnRegexMatcherBase,dd=function(){Z.call(this,"",Z.NdnRegexExprType.PSEUDO)};dd.prototype=new Z;dd.prototype.name="NdnRegexPseudoMatcher";q.NdnRegexPseudoMatcher=dd;dd.prototype.compile_=function(){};dd.prototype.setMatchResult=function(d){this.matchResult_.push(new c.Component(d))};
dd.prototype.resetMatchResult=function(){this.matchResult_=[]};Z=a.NdnRegexMatcherBase;Ac=function(d,a,n){Z.call(this,d,Z.NdnRegexExprType.REPEAT_PATTERN,a);this.repeatMax_=this.repeatMin_=0;this.indicator_=n;this.compile_()};Ac.prototype=new Z;Ac.prototype.name="NdnRegexRepeatMatcher";q.NdnRegexRepeatMatcher=Ac;Ac.prototype.match=function(d,a,n){this.matchResult_=[];if(0===this.repeatMin_&&0===n)return!0;if(this.recursiveMatch2_(0,d,a,n)){for(var b=a;b<a+n;++b)this.matchResult_.push(d.get(b));return!0}return!1};
Ac.prototype.compile_=function(){var d;"("==this.expr_[0]?(d=new cd(this.expr_.substring(0,this.indicator_),this.backrefManager_),this.backrefManager_.pushRef(d),d.lateCompile()):d=new Nc(this.expr_.substring(0,this.indicator_),this.backrefManager_);this.matchers_.push(d);this.parseRepetition_()};Ac.prototype.parseRepetition_=function(){var d=this.expr_.length;if(d===this.indicator_)return this.repeatMax_=this.repeatMin_=1,!0;if(d===this.indicator_+1){if("?"==this.expr_[this.indicator_])return this.repeatMin_=
0,this.repeatMax_=1,!0;if("+"==this.expr_[this.indicator_])return this.repeatMin_=1,this.repeatMax_=32767,!0;if("*"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=32767,!0}else{var d=this.expr_.substring(this.indicator_,d),a=d.length,n=0,b=0;if(null!=d.match(/\{[0-9]+,[0-9]+\}/))separator=d.indexOf(","),n=parseInt(d.substring(1,separator)),b=parseInt(d.substring(separator+1,a-1));else if(null!=d.match(/\{,[0-9]+\}/))separator=d.indexOf(","),n=0,b=parseInt(d.substring(separator+
1,a-1));else if(null!=d.match(/\{[0-9]+,\}/))separator=d.indexOf(","),n=parseInt(d.substring(1,separator)),b=32767;else if(null!=d.match(/\{[0-9]+\}/))b=n=parseInt(d.substring(1,a-1));else throw new Z.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Unrecognized format "+this.expr_));if(32767<n||32767<b||n>b)throw new Z.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Wrong number "+this.expr_));this.repeatMin_=n;this.repeatMax_=b;return!0}return!1};Ac.prototype.recursiveMatch2_=
function(d,a,n,b){var c=b,g=this.matchers_[0];if(0<b&&d>=this.repeatMax_||0===b&&d<this.repeatMin_)return!1;if(0==b&&d>=this.repeatMin_)return!0;for(;0<=c;){if(g.match(a,n,c)&&this.recursiveMatch2_(d+1,a,n+c,b-c))return!0;--c}return!1};var cd=a.NdnRegexBackrefMatcher,Nc=a.NdnRegexComponentSetMatcher,c=a.Name,Z=a.NdnRegexMatcherBase,Mc=a.NdnRegexBackrefManager,lc=a.NdnRegexPatternListMatcher,Xa=function(d,a){Z.call(this,d,Z.NdnRegexExprType.TOP);void 0==a&&(a="");this.secondaryMatcher_=this.primaryMatcher_=
null;this.primaryBackrefManager_=new Mc;this.secondaryBackrefManager_=new Mc;this.isSecondaryUsed_=!1;this.expand_=a;this.compile_()};Xa.prototype=new Z;Xa.prototype.name="NdnRegexTopMatcher";q.NdnRegexTopMatcher=Xa;Xa.prototype.match=function(d,a,n){this.isSecondaryUsed_=!1;this.matchResult_=[];if(this.primaryMatcher_.match(d,0,d.size())){this.matchResult_=[];d=this.primaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return!0}if(null!=this.secondaryMatcher_&&this.secondaryMatcher_.match(d,
0,d.size())){this.matchResult_=[];d=this.secondaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return this.isSecondaryUsed_=!0}return!1};Xa.prototype.expand=function(d){void 0==d&&(d="");var a=new c,n=this.isSecondaryUsed_?this.secondaryBackrefManager_:this.primaryBackrefManager_,b=n.size();d=""!=d?d:this.expand_;for(var g=[0];g[0]<d.length;){var f=Xa.getItemFromExpand_(d,g);"<"==f[0]&&a.append(f.substring(1,f.length-1));if("\\"==f[0])if(f=parseInt(f.substring(1,f.length)),
0===f)for(f=0;f<this.matchResult_.length;++f)a.append(this.matchResult_[f]);else if(f<=b)for(var l=n.getBackref(f-1).getMatchResult(),f=0;f<l.length;++f)a.append(l[f]);else throw new Z.Error(Error("Exceeded the range of back reference"));}return a};Xa.fromName=function(d,a){void 0==a&&(a=!1);for(var n="^",b=0;b<d.size();++b)n+="<",n+=Xa.convertSpecialChar_(d.get(b).toEscapedString()),n+=">";a&&(n+="$");return new Xa(n)};Xa.prototype.compile_=function(){var d=this.expr_,d="$"!=d[d.length-1]?d+"<.*>*":
d.substring(0,d.length-1);"^"!=d[0]?this.secondaryMatcher_=new lc("<.*>*"+d,this.secondaryBackrefManager_):d=d.substring(1);this.primaryMatcher_=new lc(d,this.primaryBackrefManager_)};Xa.getItemFromExpand_=function(d,a){var n=a[0];if("\\"==d[a[0]]){++a[0];if(a[0]>=d.length)throw new Z.Error(Error("Wrong format of expand string!"));for(;a[0]<d.length&&"9">=d[a[0]]&&"0"<=d[a[0]];)if(++a[0],a[0]>d.length)throw new Z.Error(Error("Wrong format of expand string!"));if(a[0]>n+1)return d.substring(n,a[0])}else if("<"==
d[a[0]]){++a[0];if(a[0]>=d.length)throw new Z.Error(Error("Wrong format of expand string!"));for(var b=1,c=0;c<b;)if("<"==d[a[0]]&&++b,">"==d[a[0]]&&++c,++a[0],a[0]>=d.length)throw new Z.Error(Error("Wrong format of expand string!"));return d.substring(n,a[0])}throw new Z.Error(Error("Wrong format of expand string!"));};Xa.convertSpecialChar_=function(d){newStr="";for(var a=0;a<d.length;++a){var n=d[a];if("."==n||"["==n||"{"==n||"}"==n||"("==n||")"==n||"\\"==n||"*"==n||"+"==n||"?"==n||"|"==n||"^"==
n||"$"==n)newStr+="\\";newStr+=n}return newStr};var vb=function(){};q.Transport=vb;vb.ConnectionInfo=function(){};vb.prototype.isLocal=function(d,a,n){n("Transport.isLocal is not implemented")};var mc=function(){vb.call(this);this.onReceivedObject=this.connectionInfo=this.elementReader=null;var d=this;window.addEventListener("message",function(a){if(a.source==window&&a.data.type&&"FromMicroForwarderStub"==a.data.type)if(a=a.data.object,a.type&&"Buffer"==a.type){if(null!=d.elementReader)d.elementReader.onReceivedData(new f(a.data))}else if(d.onReceivedObject)d.onReceivedObject(a)},
!1)};mc.prototype=new vb;mc.prototype.name="MicroForwarderTransport";mc.ConnectionInfo=function(){vb.ConnectionInfo.call(this)};mc.ConnectionInfo.prototype=new vb.ConnectionInfo;mc.ConnectionInfo.prototype.name="MicroForwarderTransport.ConnectionInfo";mc.ConnectionInfo.prototype.equals=function(d){return null==d?!1:!0};mc.ConnectionInfo.prototype.toString=function(){return"{}"};mc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};mc.prototype.isLocal=function(d,a,n){a(!0)};mc.prototype.connect=
function(d,a,n,b){this.elementReader=new Sd(a);this.connectionInfo=d;n()};mc.prototype.sendObject=function(d){window.postMessage({type:"FromMicroForwarderTransport",object:d},"*")};mc.prototype.send=function(d){null==this.connectionInfo?console.log("MicroForwarderTransport connection is not established."):this.sendObject(d.toJSON())};var nc=function(d){vb.call(this);this.connectionInfo=this.elementReader=null;this.onReceivedObject=d;this.port=null};nc.prototype=new vb;nc.prototype.name="RuntimePortTransport";
nc.ConnectionInfo=function(d){vb.ConnectionInfo.call(this);this.port=d};nc.ConnectionInfo.prototype=new vb.ConnectionInfo;nc.ConnectionInfo.prototype.name="RuntimePortTransport.ConnectionInfo";nc.ConnectionInfo.prototype.equals=function(d){return null==d||void 0==d.port?!1:this.port==d.port};nc.ConnectionInfo.prototype.toString=function(){return"{}"};nc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};nc.prototype.isLocal=function(d,a,n){a(!0)};nc.prototype.connect=function(d,a,
n,b){this.elementReader=new Sd(a);this.connectionInfo=d;this.port=this.connectionInfo.port;var c=this;this.port.onMessage.addListener(function(d){if("Buffer"==d.type)c.elementReader.onReceivedData(f.isBuffer(d.data)?d.data:new f(d.data));else if(null!=c.onReceivedObject)c.onReceivedObject(d)});this.port.onDisconnect.addListener(function(){c.port=null;null!=b&&b()});n()};nc.prototype.sendObject=function(d){null==this.port?console.log("RuntimePortTransport connection is not established."):this.port.postMessage(d)};
nc.prototype.send=function(d){this.sendObject(d.toJSON())};var Sd=a.ElementReader,g=a.Log.LOG,vb=a.Transport,ca,Jb=function w(){vb.call(this);if(!WebSocket)throw Error("WebSocket support is not available on this platform.");this.elementReader=this.connectionInfo=this.ws=null;this.defaultGetConnectionInfo=ca.makeShuffledHostGetConnectionInfo("A.ws.ndn.ucla.edu B.ws.ndn.ucla.edu C.ws.ndn.ucla.edu D.ws.ndn.ucla.edu E.ws.ndn.ucla.edu F.ws.ndn.ucla.edu G.ws.ndn.ucla.edu H.ws.ndn.ucla.edu I.ws.ndn.ucla.edu J.ws.ndn.ucla.edu K.ws.ndn.ucla.edu L.ws.ndn.ucla.edu M.ws.ndn.ucla.edu N.ws.ndn.ucla.edu".split(" "),
9696,function(a,b){return new w.ConnectionInfo(a,b)})};Jb.prototype=new vb;Jb.prototype.name="WebSocketTransport";Jb.importFace=function(a){ca=a};q.WebSocketTransport=Jb;Jb.ConnectionInfo=function(a,n){vb.ConnectionInfo.call(this);this.host=a;this.port=void 0!==n?n:9696};Jb.ConnectionInfo.prototype=new vb.ConnectionInfo;Jb.ConnectionInfo.prototype.name="WebSocketTransport.ConnectionInfo";Jb.ConnectionInfo.prototype.equals=function(a){return null==a||void 0==a.host||void 0==a.port?!1:this.host==a.host&&
this.port==a.port};Jb.ConnectionInfo.prototype.toString=function(){return this.hostIsUri()?"{ uri: "+this.host+" }":"{ host: "+this.host+", port: "+this.port+" }"};Jb.ConnectionInfo.prototype.hostIsUri=function(){return"ws:"==this.host.substr(0,3)||"wss:"==this.host.substr(0,4)};Jb.prototype.isLocal=function(a,n,b){n(!1)};Jb.prototype.connect=function(a,n,b,c){this.close();var l=a.hostIsUri()?a.host:"ws://"+a.host+":"+a.port;this.ws=new WebSocket(l);0<g&&console.log("ws connection created.");this.connectionInfo=
a;this.ws.binaryType="arraybuffer";this.elementReader=new Sd(n);var m=this;this.ws.onmessage=function(a){a=a.data;if(null==a||void 0==a||""==a)console.log("INVALID ANSWER");else if(a instanceof ArrayBuffer){a=new f(new Uint8Array(a));3<g&&console.log("BINARY RESPONSE IS "+a.toString("hex"));try{m.elementReader.onReceivedData(a)}catch(n){console.log("NDN.ws.onmessage exception: "+n)}}};this.ws.onopen=function(a){3<g&&console.log(a);3<g&&console.log("ws.onopen: WebSocket connection opened.");3<g&&console.log("ws.onopen: ReadyState: "+
this.readyState);b()};this.ws.onerror=function(a){console.log("ws.onerror: ReadyState: "+this.readyState);console.log(a);console.log("ws.onerror: WebSocket error: "+a.data)};this.ws.onclose=function(a){console.log("ws.onclose: WebSocket connection closed.");m.ws=null;null!=c&&c()}};Jb.prototype.connectByFace=function(a,n){this.connect(a.connectionInfo,a,n,function(){a.closeByTransport()})};Jb.prototype.send=function(a){if(null!=this.ws){var n=new Uint8Array(a.length);n.set(a);this.ws.send(n.buffer);
3<g&&console.log("ws.send() returned.")}else console.log("WebSocket connection is not established.")};Jb.prototype.close=function(){null!=this.ws&&delete this.ws};q.TcpTransport=a.WebSocketTransport;var p=a.Blob,L=a.DataUtils,g=a.Log.LOG,S=a.DecodingException,c=function n(a){if("string"==typeof a)3<g&&console.log("Content Name String "+a),this.components=n.createNameArray(a);else if("object"===typeof a)if(this.components=[],a instanceof n)this.append(a);else for(var b=0;b<a.length;++b)this.append(a[b]);
else null==a?this.components=[]:1<g&&console.log("NO CONTENT NAME GIVEN");this.changeCount=0},gb={IMPLICIT_SHA256_DIGEST:1,PARAMETERS_SHA256_DIGEST:2,GENERIC:8,OTHER_CODE:32767};q.Name=c;q.ComponentType=gb;c.Component=function(a,b,g){if("object"===typeof a&&a instanceof c.Component)this.value_=a.value_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_;else{this.value_=a?"object"===typeof a&&"undefined"!==typeof ArrayBuffer&&a instanceof ArrayBuffer?new p(new f(new Uint8Array(a)),!1):"object"===
typeof a&&a instanceof p?a:new p(a):new p([]);if(b===gb.OTHER_CODE){if(void 0==g)throw Error("To use an other code, call Name.Component(value, ComponentType.OTHER_CODE, otherTypeCode)");if(0>g)throw Error("Name.Component other type code must be non-negative");this.otherTypeCode_=g}else this.otherTypeCode_=-1;this.type_=void 0==b?gb.GENERIC:b}};c.Component.prototype.getValue=function(){return this.value_};c.Component.prototype.getValueAsBuffer=function(){return this.value_.buf()};c.Component.prototype.getType=
function(){return this.type_};c.Component.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Object.defineProperty(c.Component.prototype,"value",{get:function(){return this.getValueAsBuffer()}});c.Component.prototype.toEscapedString=function(){return this.type_===gb.IMPLICIT_SHA256_DIGEST?"sha256digest="+this.value_.toHex():this.type_===gb.PARAMETERS_SHA256_DIGEST?"params-sha256="+this.value_.toHex():(this.type_===gb.GENERIC?"":(this.type_===gb.OTHER_CODE?this.otherTypeCode_:this.type_)+
"=")+c.toEscapedString(this.value_.buf())};c.Component.prototype.isSegment=function(){return 1<=this.value_.size()&&0==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isSegmentOffset=function(){return 1<=this.value_.size()&&251==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isVersion=function(){return 1<=this.value_.size()&&253==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isTimestamp=function(){return 1<=this.value_.size()&&252==this.value_.buf()[0]&&
this.isGeneric()};c.Component.prototype.isSequenceNumber=function(){return 1<=this.value_.size()&&254==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isGeneric=function(){return this.type_===gb.GENERIC};c.Component.prototype.isImplicitSha256Digest=function(){return this.type_===gb.IMPLICIT_SHA256_DIGEST};c.Component.prototype.isParametersSha256Digest=function(){return this.type_===gb.PARAMETERS_SHA256_DIGEST};c.Component.prototype.toNumber=function(){return L.bigEndianToUnsignedInt(this.value_.buf())};
c.Component.prototype.toNumberWithMarker=function(a){if(0==this.value_.size()||this.value_.buf()[0]!=a)throw Error("Name component does not begin with the expected marker");return L.bigEndianToUnsignedInt(this.value_.buf().slice(1))};c.Component.prototype.toSegment=function(){return this.toNumberWithMarker(0)};c.Component.prototype.toSegmentOffset=function(){return this.toNumberWithMarker(251)};c.Component.prototype.toVersion=function(){return this.toNumberWithMarker(253)};c.Component.prototype.toTimestamp=
function(){return this.toNumberWithMarker(252)};c.Component.prototype.toSequenceNumber=function(){return this.toNumberWithMarker(254)};c.Component.fromNumber=function(a,b,g){var f=new sa(8);f.writeNonNegativeInteger(a);return new c.Component(new p(f.getOutput(),!1),b,g)};c.Component.fromNumberWithMarker=function(a,b){var g=new sa(9);g.writeNonNegativeInteger(a);g.writeNonNegativeInteger(b);return new c.Component(new p(g.getOutput(),!1))};c.Component.fromSegment=function(a){return c.Component.fromNumberWithMarker(a,
0)};c.Component.fromSegmentOffset=function(a){return c.Component.fromNumberWithMarker(a,251)};c.Component.fromVersion=function(a){return c.Component.fromNumberWithMarker(a,253)};c.Component.fromTimestamp=function(a){return c.Component.fromNumberWithMarker(a,252)};c.Component.fromSequenceNumber=function(a){return c.Component.fromNumberWithMarker(a,254)};c.Component.fromImplicitSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,!0);if(32!==digestBlob.size())throw new S("Name.Component.fromImplicitSha256Digest: The digest length must be 32 bytes");
a=new c.Component(digestBlob);a.type_=gb.IMPLICIT_SHA256_DIGEST;return a};c.Component.fromParametersSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,!0);if(32!==digestBlob.size())throw new S("Name.Component.fromParametersSha256Digest: The digest length must be 32 bytes");a=new c.Component(digestBlob);a.type_=gb.PARAMETERS_SHA256_DIGEST;return a};c.Component.prototype.getSuccessor=function(){for(var a=new f(this.value_.size()+1),b=!0,g=this.value_.size()-1;0<=g;--g)b?
(a[g]=this.value_.buf()[g]+1&255,b=0===a[g]):a[g]=this.value_.buf()[g];b?a[a.length-1]=0:a=a.slice(0,this.value_.size());return new c.Component(new p(a,!1),this.type_,this.otherTypeCode_)};c.Component.prototype.equals=function(a){return"object"===typeof a&&a instanceof c.Component?this.type_===gb.OTHER_CODE?this.value_.equals(a.value_)&&a.type_===gb.OTHER_CODE&&this.otherTypeCode_==a.otherTypeCode_:this.value_.equals(a.value_)&&this.type_===a.type_:!1};c.Component.prototype.compare=function(a){var b=
this.type_===gb.OTHER_CODE?this.otherTypeCode_:this.type_,g=a.type_===gb.OTHER_CODE?a.otherTypeCode_:a.type_;return b<g?-1:b>g?1:c.Component.compareBuffers(this.value_.buf(),a.value_.buf())};c.Component.compareBuffers=function(a,b){if(a.length<b.length)return-1;if(a.length>b.length)return 1;for(var c=0;c<a.length;++c){if(a[c]<b[c])return-1;if(a[c]>b[c])return 1}return 0};c.prototype.getName=function(){return this.toUri()};c.createNameArray=function(a){a=a.trim();if(0>=a.length)return[];var b=a.indexOf(":");
if(0<=b){var g=a.indexOf("/");if(0>g||b<g)a=a.substr(b+1,a.length-b-1).trim()}if("/"==a[0])if(2<=a.length&&"/"==a[1]){b=a.indexOf("/",2);if(0>b)return[];a=a.substr(b+1,a.length-b-1).trim()}else a=a.substr(1,a.length-1).trim();b=a.split("/");for(g=0;g<b.length;++g){var l=b[g];if("sha256digest="==l.substr(0,13))l=l.substr(13).trim(),l=c.Component.fromImplicitSha256Digest(new p(new f(l,"hex")),!1);else if("params-sha256="==l.substr(0,14))l=l.substr(14).trim(),l=c.Component.fromParametersSha256Digest(new p(new f(l,
"hex")),!1);else{var m=gb.GENERIC,r=-1,q=l.indexOf("=");if(0<=q){m=l.substring(0,q);r=parseInt(m);if(isNaN(r))throw Error("Can't parse decimal Name Component type: "+m+" in URI "+a);m=r==gb.GENERIC||r==gb.IMPLICIT_SHA256_DIGEST||r==gb.PARAMETERS_SHA256_DIGEST?r:gb.OTHER_CODE;l=l.substring(q+1)}l=new c.Component(c.fromEscapedString(l),m,r)}l.getValue().isNull()?(b.splice(g,1),--g):b[g]=l}return b};c.prototype.set=function(a){this.components=c.createNameArray(a);++this.changeCount};c.prototype.append=
function(a,b,g){if("object"==typeof a&&a instanceof c)for(a=a==this?this.components.slice(0,this.components.length):a.components,b=0;b<a.length;++b)this.components.push(new c.Component(a[b]));else"object"===typeof a&&a instanceof c.Component?this.components.push(a):this.components.push(new c.Component(a,b,g));++this.changeCount;return this};c.prototype.add=function(a){return this.append(a)};c.prototype.clear=function(){this.components=[];++this.changeCount};c.prototype.toUri=function(a){if(0==this.size())return a?
"ndn:/":"/";a=a?"ndn:":"";for(var b=0;b<this.size();++b)a+="/"+this.components[b].toEscapedString();return a};c.prototype.to_uri=function(){return this.toUri()};c.prototype.toString=function(){return this.toUri()};c.prototype.appendSegment=function(a){return this.append(c.Component.fromSegment(a))};c.prototype.appendSegmentOffset=function(a){return this.append(c.Component.fromSegmentOffset(a))};c.prototype.appendVersion=function(a){return this.append(c.Component.fromVersion(a))};c.prototype.appendTimestamp=
function(a){return this.append(c.Component.fromTimestamp(a))};c.prototype.appendSequenceNumber=function(a){return this.append(c.Component.fromSequenceNumber(a))};c.prototype.appendImplicitSha256Digest=function(a){return this.append(c.Component.fromImplicitSha256Digest(a))};c.prototype.appendParametersSha256Digest=function(a){return this.append(c.Component.fromParametersSha256Digest(a))};c.prototype.addSegment=function(a){return this.appendSegment(a)};c.prototype.getSubName=function(a,b){0>a&&(a=this.components.length-
-a);void 0==b&&(b=this.components.length-a);for(var g=new c,f=a+b,l=a;l<f&&l<this.components.length;++l)g.components.push(this.components[l]);return g};c.prototype.getPrefix=function(a){return 0>a?this.getSubName(0,this.components.length+a):this.getSubName(0,a)};c.prototype.cut=function(a){return new c(this.components.slice(0,this.components.length-a))};c.prototype.size=function(){return this.components.length};c.prototype.get=function(a){if(0<=a){if(a>=this.components.length)throw Error("Name.get: Index is out of bounds");
return this.components[a]}if(a<-this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[this.components.length- -a]};c.prototype.getComponentCount=function(){return this.components.length};c.prototype.getComponent=function(a){return new f(this.components[a].getValue().buf())};c.prototype.indexOfFileName=function(){for(var a=this.size()-1;0<=a;--a){var b=this.components[a].getValue().buf();if(!(0>=b.length||0==b[0]||192==b[0]||193==b[0]||245<=b[0]&&255>=b[0]))return a}return-1};
c.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeName(this)};c.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeName(this,a.buf(),!1):b.decodeName(this,a,!0)};c.prototype.compare=function(a,b,g,f,l){a instanceof c&&(g=a,a=0,b=this.size());void 0==f&&(f=0);void 0==l&&(l=g.size());0>a&&(a=this.size()- -a);0>f&&(f=g.size()- -f);b=Math.min(b,this.size()-a);l=Math.min(l,g.size()-f);for(var m=Math.min(b,l),p=0;p<
m;++p){var r=this.components[a+p].compare(g.components[f+p]);if(0!=r)return r}return b<l?-1:b>l?1:0};c.prototype.equals=function(a){if(this.components.length!=a.components.length)return!1;for(var b=this.components.length-1;0<=b;--b)if(!this.components[b].equals(a.components[b]))return!1;return!0};c.prototype.equalsName=function(a){return this.equals(a)};c.prototype.getContentDigestValue=function(){for(var a=this.size()-1;0<=a;--a){var b=c.getComponentContentDigestValue(this.components[a]);if(null!=
b)return b}return null};c.getComponentContentDigestValue=function(a){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());return a.length==c.ContentDigestPrefix.length+32+c.ContentDigestSuffix.length&&L.arraysEqual(a.slice(0,c.ContentDigestPrefix.length),c.ContentDigestPrefix)&&L.arraysEqual(a.slice(a.length-c.ContentDigestSuffix.length,a.length),c.ContentDigestSuffix)?a.slice(c.ContentDigestPrefix.length,c.ContentDigestPrefix.length+32):null};c.ContentDigestPrefix=new f([193,46,77,
46,71,193,1,170,2,133]);c.ContentDigestSuffix=new f([0]);c.toEscapedString=function(a){"object"==typeof a&&a instanceof c.Component?a=a.getValue().buf():"object"===typeof a&&a instanceof p&&(a=a.buf());for(var b="",g=!1,f=0;f<a.length;++f)if(46!=a[f]){g=!0;break}if(g)for(f=0;f<a.length;++f)g=a[f],b=48<=g&&57>=g||65<=g&&90>=g||97<=g&&122>=g||43==g||45==g||46==g||95==g?b+String.fromCharCode(g):b+("%"+(16>g?"0":"")+g.toString(16).toUpperCase());else for(b="...",f=0;f<a.length;++f)b+=".";return b};c.fromEscapedString=
function(a){a=unescape(a.trim());return null==a.match(/[^.]/)?2>=a.length?new p:new p(L.toNumbersFromString(a.substr(3,a.length-3)),!1):new p(L.toNumbersFromString(a),!1)};c.fromEscapedStringAsBuffer=function(a){return c.fromEscapedString(a).buf()};c.prototype.getSuccessor=function(){return 0==this.size()?new c("/sha256digest=0000000000000000000000000000000000000000000000000000000000000000"):this.getPrefix(-1).append(this.get(-1).getSuccessor())};c.prototype.match=function(a){var b=this.components;
a=a.components;if(b.length>a.length)return!1;for(var c=b.length-1;0<=c;--c)if(!b[c].equals(a[c]))return!1;return!0};c.prototype.isPrefixOf=function(a){return this.match(a)};c.prototype.getChangeCount=function(){return this.changeCount};var sa=a.TlvEncoder,r=a.WireFormat,p=a.Blob,oa=a.ChangeCounter,c=a.Name,ta={KEYNAME:1,KEY_LOCATOR_DIGEST:2};q.KeyLocatorType=ta;var V=function Te(a,b){"object"===typeof a&&a instanceof Te?(this.type_=a.type_,this.keyName_=new oa(new c(a.getKeyName())),this.keyData_=
a.keyData_):(this.type_=b,this.keyName_=new oa(new c),this.keyData_=new p,b==ta.KEYNAME?this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c):b==ta.KEY_LOCATOR_DIGEST&&(this.keyData_=new p(a)));this.changeCount_=0};q.KeyLocator=V;V.prototype.getType=function(){return this.type_};V.prototype.getKeyName=function(){return this.keyName_.get()};V.prototype.getKeyData=function(){return this.keyData_};V.prototype.getKeyDataAsBuffer=function(){return this.getKeyData().buf()};V.prototype.setType=
function(a){this.type_=a;++this.changeCount_};V.prototype.setKeyName=function(a){this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_};V.prototype.setKeyData=function(a){this.keyData_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};V.prototype.clear=function(){this.type_=null;this.keyName_.set(new c);this.keyData_=new p;++this.changeCount_};V.prototype.equals=function(a){if(this.type_!=a.type_)return!1;if(this.type_==ta.KEYNAME){if(!this.getKeyName().equals(a.getKeyName()))return!1}else if(this.type_==
ta.KEY_LOCATOR_DIGEST&&!this.getKeyData().equals(a.getKeyData()))return!1;return!0};V.canGetFromSignature=function(a){return a instanceof Ia||a instanceof Va||a instanceof ob};V.getFromSignature=function(a){if(a instanceof Ia||a instanceof Va||a instanceof ob)return a.getKeyLocator();throw Error("KeyLocator.getFromSignature: Signature type does not have a KeyLocator");};V.prototype.getChangeCount=function(){this.keyName_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(V.prototype,
"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(V.prototype,"keyData",{get:function(){return this.getKeyDataAsBuffer()},set:function(a){this.setKeyData(a)}});var Ia=a.Sha256WithRsaSignature,Va=a.Sha256WithEcdsaSignature,ob=a.HmacWithSha256Signature,c=a.Name,Ca={BLOB:0,LINK:1,KEY:2,NACK:3,OTHER_CODE:32767};q.ContentType=Ca;var ab=function Ue(a,b,c,g,f,l){if(b)throw Error("MetaInfo constructor: timestamp support has been removed.");if(g)throw Error("MetaInfo constructor: locator support has been removed.");
if("object"===typeof a&&a instanceof Ue)this.publisher_=a.publisher_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_,this.freshnessPeriod_=a.freshnessPeriod_,this.finalBlockId_=a.finalBlockId_;else{if(a)throw Error("MetaInfo constructor: publisher support has been removed.");this.type=null==c||0>c?Ca.BLOB:c;this.otherTypeCode_=-1;this.freshnessSeconds=f;this.setFinalBlockId(l)}this.changeCount_=0};q.MetaInfo=ab;ab.prototype.getType=function(){return this.type_};ab.prototype.getOtherTypeCode=
function(){return this.otherTypeCode_};ab.prototype.getFreshnessPeriod=function(){return this.freshnessPeriod_};ab.prototype.getFinalBlockId=function(){return this.finalBlockId_};ab.prototype.getFinalBlockID=function(){return this.getFinalBlockId()};ab.prototype.getFinalBlockIDAsBuffer=function(){return this.finalBlockId_.getValue().buf()};ab.prototype.setType=function(a){this.type_=null==a||0>a?Ca.BLOB:a;++this.changeCount_};ab.prototype.setOtherTypeCode=function(a){if(0>a)throw Error("MetaInfo other type code must be non-negative");
this.otherTypeCode_=a;++this.changeCount_};ab.prototype.setFreshnessPeriod=function(a){this.freshnessPeriod_=null==a||0>a?null:a;++this.changeCount_};ab.prototype.setFinalBlockId=function(a){this.finalBlockId_="object"===typeof a&&a instanceof c.Component?a:new c.Component(a);++this.changeCount_};ab.prototype.setFinalBlockID=function(a){this.setFinalBlockId(a)};ab.prototype.clear=function(){this.type=Ca.BLOB;this.otherTypeCode_=-1;this.freshnessSeconds=null;this.finalBlockId_=new c.Component;++this.changeCount_};
ab.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(ab.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(ab.prototype,"freshnessSeconds",{get:function(){return null==this.freshnessPeriod_||0>this.freshnessPeriod_?null:this.freshnessPeriod_/1E3},set:function(a){this.freshnessPeriod_=null==a||0>a?null:1E3*a;++this.changeCount_}});Object.defineProperty(ab.prototype,"finalBlockID",{get:function(){return this.getFinalBlockIDAsBuffer()},
set:function(a){this.setFinalBlockId(a)}});var p=a.Blob,oa=a.ChangeCounter,V=a.KeyLocator,Da=a.ValidityPeriod,Va=function Ve(a){"object"===typeof a&&a instanceof Ve?(this.keyLocator_=new oa(new V(a.getKeyLocator())),this.validityPeriod_=new oa(new Da(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new oa(new V),this.validityPeriod_=new oa(new Da),this.signature_=new p);this.changeCount_=0};q.Sha256WithEcdsaSignature=Va;Va.prototype.clone=function(){return new Va(this)};Va.prototype.getKeyLocator=
function(){return this.keyLocator_.get()};Va.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Va.prototype.getSignature=function(){return this.signature_};Va.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof V?new V(a):new V);++this.changeCount_};Va.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof Da?new Da(a):new Da);++this.changeCount_};Va.prototype.setSignature=function(a){this.signature_=
"object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Va.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};p=a.Blob;oa=a.ChangeCounter;V=a.KeyLocator;Da=a.ValidityPeriod;Ia=function We(a){"object"===typeof a&&a instanceof We?(this.keyLocator_=new oa(new V(a.getKeyLocator())),this.validityPeriod_=new oa(new Da(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=
new oa(new V),this.validityPeriod_=new oa(new Da),this.signature_=new p);this.changeCount_=0};q.Sha256WithRsaSignature=Ia;Ia.prototype.clone=function(){return new Ia(this)};Ia.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Ia.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Ia.prototype.getSignature=function(){return this.signature_};Ia.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Ia.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===
typeof a&&a instanceof V?new V(a):new V);++this.changeCount_};Ia.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof Da?new Da(a):new Da);++this.changeCount_};Ia.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Ia.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Object.defineProperty(Ia.prototype,
"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(Ia.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var p=a.Blob,$b=function Xe(a){"object"===typeof a&&a instanceof Xe?(this.signature_=a.signature_,this.signatureInfoEncoding_=a.signatureInfoEncoding_,this.typeCode_=a.typeCode_):(this.signature_=new p,this.signatureInfoEncoding_=new p,this.typeCode_=null);this.changeCount_=
0};q.GenericSignature=$b;$b.prototype.clone=function(){return new $b(this)};$b.prototype.getSignature=function(){return this.signature_};$b.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};$b.prototype.getSignatureInfoEncoding=function(){return this.signatureInfoEncoding_};$b.prototype.getTypeCode=function(){return this.typeCode_};$b.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};$b.prototype.setSignatureInfoEncoding=
function(a,b){this.signatureInfoEncoding_="object"===typeof a&&a instanceof p?a:new p(a);this.typeCode_=b;++this.changeCount_};$b.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty($b.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});p=a.Blob;oa=a.ChangeCounter;V=a.KeyLocator;ob=function af(a){"object"===typeof a&&a instanceof af?(this.keyLocator_=new oa(new V(a.getKeyLocator())),this.signature_=a.signature_):
(this.keyLocator_=new oa(new V),this.signature_=new p);this.changeCount_=0};q.HmacWithSha256Signature=ob;ob.prototype.clone=function(){return new ob(this)};ob.prototype.getKeyLocator=function(){return this.keyLocator_.get()};ob.prototype.getSignature=function(){return this.signature_};ob.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};ob.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof V?new V(a):new V);++this.changeCount_};ob.prototype.setSignature=
function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};ob.prototype.getChangeCount=function(){this.keyLocator_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(ob.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(ob.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var p=a.Blob,wb=
function Ye(a){this.signature_="object"===typeof a&&a instanceof Ye?a.signature_:new p;this.changeCount_=0};q.DigestSha256Signature=wb;wb.prototype.clone=function(){return new wb(this)};wb.prototype.getSignature=function(){return this.signature_};wb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};wb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(wb.prototype,"signature",{get:function(){return this.getSignature()},
set:function(a){this.setSignature(a)}});var p=a.Blob,$a=a.SignedBlob,oa=a.ChangeCounter,c=a.Name,Ia=a.Sha256WithRsaSignature,ab=a.MetaInfo,Bc=a.IncomingFaceId,ed=a.CongestionMark,r=a.WireFormat,W=a,R=function Ze(a,b,g){a instanceof Ze?(this.name_=new oa(new c(a.getName())),this.metaInfo_=new oa(new ab(a.getMetaInfo())),this.signature_=new oa(a.getSignature().clone()),this.content_=a.content_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultFullName_=new c(a.defaultFullName_),this.defaultWireEncodingFormat_=
a.defaultWireEncodingFormat_):(this.name_="string"===typeof a?new oa(new c(a)):new oa("object"===typeof a&&a instanceof c?new c(a):new c),"object"===typeof b&&b instanceof ab?(a=b,b=g):a=null,this.metaInfo_=new oa("object"===typeof a&&a instanceof ab?new ab(a):new ab),this.content_="object"===typeof b&&b instanceof p?b:new p(b,!0),this.signature_=new oa(new Ia),this.defaultWireEncoding_=new $a,this.defaultFullName_=new c,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=
0;this.lpPacket_=null};q.Data=R;R.prototype.getName=function(){return this.name_.get()};R.prototype.getMetaInfo=function(){return this.metaInfo_.get()};R.prototype.getSignature=function(){return this.signature_.get()};R.prototype.getContent=function(){return this.content_};R.prototype.getContentAsBuffer=function(){return this.content_.buf()};R.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new $a,this.defaultWireEncodingFormat_=
null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};R.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};R.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:Bc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};R.prototype.getCongestionMark=function(){var a=null===this.lpPacket_?null:ed.getFirstHeader(this.lpPacket_);return null===a?0:a.getCongestionMark()};R.prototype.getFullName=
function(a){a=a||r.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&0<this.defaultFullName_.size()&&this.getDefaultWireEncodingFormat()==a)return this.defaultFullName_;var b=new c(this.getName()),g=W.createHash("sha256");g.update(this.wireEncode(a).buf());b.appendImplicitSha256Digest(new p(g.digest(),!1));a==r.getDefaultWireFormat()&&(this.defaultFullName_=b);return b};R.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;
return this};R.prototype.setMetaInfo=function(a){this.metaInfo_.set("object"===typeof a&&a instanceof ab?new ab(a):new ab);++this.changeCount_;return this};R.prototype.setSignature=function(a){this.signature_.set(null==a?new Ia:a.clone());++this.changeCount_;return this};R.prototype.setContent=function(a){this.content_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;return this};R.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&
this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeData(this),b=new $a(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==r.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,r.getDefaultWireFormat());return b};R.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof p?b.decodeData(this,a.buf(),!1):b.decodeData(this,a,!0);b==r.getDefaultWireFormat()?this.setDefaultWireEncoding(new $a(new p(a,
!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),r.getDefaultWireFormat()):this.setDefaultWireEncoding(new $a,null)};R.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};R.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.metaInfo_.checkChanged()||a;(a=this.signature_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};R.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=
this.getChangeCount()};Object.defineProperty(R.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(R.prototype,"metaInfo",{get:function(){return this.getMetaInfo()},set:function(a){this.setMetaInfo(a)}});Object.defineProperty(R.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});Object.defineProperty(R.prototype,"content",{get:function(){return this.getContentAsBuffer()},set:function(a){this.setContent(a)}});
v.prototype=Error();v.prototype.name="SecurityException";q.SecurityException=v;Jc.prototype=new v;Jc.prototype.name="UnrecognizedKeyFormatException";q.UnrecognizedKeyFormatException=Jc;D.prototype=new v;D.prototype.name="UnrecognizedDigestAlgorithmException";q.UnrecognizedDigestAlgorithmException=D;dc.prototype=Error();dc.prototype.name="InvalidArgumentException";q.InvalidArgumentException=dc;var da=function(){};q.KeyType=da;da.RSA=0;da.EC=1;da.ECDSA=1;da.AES=128;var fd=function(){};q.KeyClass=fd;
fd.PUBLIC=1;fd.PRIVATE=2;fd.SYMMETRIC=3;var Fa=function(){};q.DigestAlgorithm=Fa;Fa.SHA256=1;var W=a,E=a.Interest,r=a.WireFormat,sa=a.TlvEncoder,p=a.Blob,gd=function(){this.lastUsedTimestamp_=Math.round((new Date).getTime());this.nowOffsetMilliseconds_=0};q.CommandInterestPreparer=gd;gd.prototype.prepareCommandInterestName=function(a,b){void 0==b&&r.getDefaultWireFormat();for(var c=(new Date).getTime()+this.nowOffsetMilliseconds_,c=Math.round(c);c<=this.lastUsedTimestamp_;)c+=1;this.lastUsedTimestamp_=
c;var g=new sa(8);g.writeNonNegativeInteger(c);a.getName().append(new p(g.getOutput(),!1));a.getName().append(new p(W.randomBytes(8),!1))};gd.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};var E=a.Interest,r=a.WireFormat,Y=a.SigningInfo,gd=a.CommandInterestPreparer,oc=function(a){gd.call(this);this.keyChain_=a};oc.prototype=new gd;oc.prototype.name="CommandInterestSigner";q.CommandInterestSigner=oc;oc.POS_SIGNATURE_VALUE=-1;oc.POS_SIGNATURE_INFO=-2;oc.POS_NONCE=-3;
oc.POS_TIMESTAMP=-4;oc.MINIMUM_SIZE=4;oc.prototype.makeCommandInterest=function(a,b,c,g,f){var l=b,m=c,p=g;b=l instanceof Y?l:void 0;c=l instanceof r?l:m instanceof r?m:void 0;"function"===typeof l?(g=l,f=m):"function"===typeof m?(g=m,f=p):"function"===typeof p?g=p:f=g=void 0;void 0==b&&(b=new Y);void 0==c&&(c=r.getDefaultWireFormat());a=new E(a);this.prepareCommandInterestName(a,c);return this.keyChain_.sign(a,b,c,g,f)};var xb=function(){};q.KeyIdType=xb;xb.USER_SPECIFIED=0;xb.SHA256=1;xb.RANDOM=
2;var c=a.Name,xb=a.KeyIdType,da=a.KeyType,Kb=function(a,b){this.keyType_=a;if(b instanceof c.Component){if(0==b.getValue().size())throw Error("KeyParams: keyId is empty");this.keyIdType_=xb.USER_SPECIFIED;this.keyId_=b}else{if(b==xb.USER_SPECIFIED)throw Error("KeyParams: KeyIdType is USER_SPECIFIED");this.keyIdType_=b;this.keyId_=new c.Component}};q.KeyParams=Kb;Kb.prototype.getKeyType=function(){return this.keyType_};Kb.prototype.getKeyIdType=function(){return this.keyIdType_};Kb.prototype.getKeyId=
function(){return this.keyId_};Kb.prototype.setKeyId=function(a){this.keyId_=a};var ac=function ae(a,b){if(a instanceof c.Component)Kb.call(this,ae.getType(),a),this.size_=void 0==b?ae.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:xb.RANDOM;Kb.call(this,ae.getType(),g);this.size_=a}else Kb.call(this,ae.getType(),xb.RANDOM),this.size_=ae.getDefaultSize()};ac.prototype=new Kb;ac.prototype.name="RsaKeyParams";q.RsaKeyParams=ac;ac.prototype.getKeySize=function(){return this.size_};ac.getDefaultSize=
function(){return 2048};ac.getType=function(){return da.RSA};var Oc=function be(a,b){if(a instanceof c.Component)Kb.call(this,be.getType(),a),this.size_=void 0==b?be.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:xb.RANDOM;Kb.call(this,be.getType(),g);this.size_=a}else Kb.call(this,be.getType(),xb.RANDOM),this.size_=be.getDefaultSize()};Oc.prototype=new Kb;Oc.prototype.name="EcKeyParams";q.EcKeyParams=Oc;Oc.prototype.getKeySize=function(){return this.size_};Oc.getDefaultSize=function(){return 256};
Oc.getType=function(){return da.EC};var ee=function(a,b){Oc.call(this,a,b)};ee.prototype=new Oc;ee.prototype.name="EcdsaKeyParams";q.EcdsaKeyParams=ee;ee.getDefaultSize=function(){return Oc.getDefaultSize()};ee.getType=function(){return Oc.getType()};var sd=function ce(a,b){if(a instanceof c.Component)Kb.call(this,ce.getType(),a),this.size_=void 0==b?ce.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:xb.RANDOM;Kb.call(this,ce.getType(),g);this.size_=a}else Kb.call(this,ce.getType(),xb.RANDOM),
this.size_=ce.getDefaultSize()};sd.prototype=new Kb;sd.prototype.name="AesKeyParams";q.AesKeyParams=sd;sd.prototype.getKeySize=function(){return this.size_};sd.getDefaultSize=function(){return 64};sd.getType=function(){return da.AES};var c=a.Name,R=a.Data,Ca=a.ContentType,Ia=a.Sha256WithRsaSignature,Va=a.Sha256WithEcdsaSignature,V=a.KeyLocator,ta=a.KeyLocatorType,r=a.WireFormat,Fa=a.DigestAlgorithm,da=a.KeyType,Da=a.ValidityPeriod,M=a.CertificateV2,b=a.SyncPromise,bb=a.Tpm,bc=a.TpmBackEndMemory,p=
a.Blob,m=a.Tlv,sa=a.TlvEncoder,na=a.TlvDecoder,fb=a.TlvWireFormat,za=a.PublicKey,Pc=function $e(a,b,g,f,x,y){a instanceof c?(void 0==x&&(x=Fa.SHA256),void 0==y&&(y=r.getDefaultWireFormat()),this.certificate_=$e.makeSelfSignedCertificate_(a,b,g,f,x,y),this.privateKeyBag_=b):a instanceof R?(this.certificate_=new R(a),this.privateKeyBag_=b):this.wireDecode(a)};q.SafeBag=Pc;Pc.prototype.getCertificate=function(){return this.certificate_};Pc.prototype.getPrivateKeyBag=function(){return this.privateKeyBag_};
Pc.prototype.wireDecode=function(a){"object"===typeof a&&a instanceof p&&(a=a.buf());a=new na(a);var b=a.readNestedTlvsStart(m.SafeBag_SafeBag),c=a.getOffset(),g=a.readNestedTlvsStart(m.Data);a.seek(g);this.certificate_=new R;this.certificate_.wireDecode(a.getSlice(c,g),fb.get());this.privateKeyBag_=new p(a.readBlobTlv(m.SafeBag_EncryptedKeyBag),!0);a.finishNestedTlvs(b)};Pc.prototype.wireEncode=function(){var a=new sa(256),b=a.getLength();a.writeBlobTlv(m.SafeBag_EncryptedKeyBag,this.privateKeyBag_.buf());
a.writeBuffer(this.certificate_.wireEncode(fb.get()).buf());a.writeTypeAndLength(m.SafeBag_SafeBag,a.getLength()-b);return new p(a.getOutput(),!1)};Pc.makeSelfSignedCertificate_=function(a,g,f,l,m,x){var y=new M,u=(new Date).getTime(),Ya=new c(a);Ya.append("self").appendVersion(u);y.setName(Ya);y.getMetaInfo().setType(Ca.KEY);y.getMetaInfo().setFreshnessPeriod(36E5);Ya=new za(f);y.setContent(Ya.getKeyDer());f=new bb("","",new bc);b.complete(null,f.importPrivateKeyPromise_(a,g.buf(),l,!0));if(Ya.getKeyType()==
da.RSA)y.setSignature(new Ia);else if(Ya.getKeyType()==da.EC)y.setSignature(new Va);else throw Error("Unsupported key type");g=y.getSignature();V.getFromSignature(g).setType(ta.KEYNAME);V.getFromSignature(g).setKeyName(a);Da.getFromSignature(g).setPeriod(u,u+63072E7);u=y.wireEncode(x);a=b.complete(null,f.signPromise(u.signedBuf(),a,m,!0));g.setSignature(a);y.wireEncode(x);return y};var c=a.Name,Rb=a.PibIdentity,pa=a.PibKey,Fa=a.DigestAlgorithm,Da=a.ValidityPeriod,Y=function ue(a,b){this.validityPeriod_=
new Da;if(void 0==a)this.reset(ue.SignerType.NULL),this.digestAlgorithm_=Fa.SHA256;else if(a instanceof ue)this.type_=a.type_,this.name_=new c(a.name_),this.identity_=a.identity_,this.key_=a.key_,this.digestAlgorithm_=a.digestAlgorithm_,this.validityPeriod_=new Da(a.validityPeriod_);else if("number"===typeof a)this.reset(a),void 0!=b&&(this.name_=new c(b)),this.digestAlgorithm_=Fa.SHA256;else if(a instanceof Rb)this.digestAlgorithm_=Fa.SHA256,this.setPibIdentity(a);else if(a instanceof pa)this.digestAlgorithm_=
Fa.SHA256,this.setPibKey(a);else if("string"===typeof a){if(signingString=a,this.reset(ue.SignerType.NULL),this.digestAlgorithm_=Fa.SHA256,""!=signingString){var g=signingString.indexOf(":");if(0>g)throw Error("Invalid signing string cannot represent SigningInfo");var x=signingString.substring(0,g),g=signingString.substring(g+1);if("id"==x)g==ue.getDigestSha256Identity().toUri()?this.setSha256Signing():this.setSigningIdentity(new c(g));else if("key"==x)this.setSigningKeyName(new c(g));else if("cert"==
x)this.setSigningCertificateName(new c(g));else throw Error("Invalid signing string scheme");}}else throw Error("SigningInfo: Unrecognized type");};q.SigningInfo=Y;Y.SignerType=function(){};Y.SignerType.NULL=0;Y.SignerType.ID=1;Y.SignerType.KEY=2;Y.SignerType.CERT=3;Y.SignerType.SHA256=4;Y.prototype.setSigningIdentity=function(a){this.reset(Y.SignerType.ID);this.name_=new c(a);return this};Y.prototype.setSigningKeyName=function(a){this.reset(Y.SignerType.KEY);this.name_=new c(a);return this};Y.prototype.setSigningCertificateName=
function(a){this.reset(Y.SignerType.CERT);this.name_=new c(a);return this};Y.prototype.setSha256Signing=function(){this.reset(Y.SignerType.SHA256);this.digestAlgorithm_=Fa.SHA256;return this};Y.prototype.setPibIdentity=function(a){this.reset(Y.SignerType.ID);null!=a&&(this.name_=a.getName());this.identity_=a;return this};Y.prototype.setPibKey=function(a){this.reset(Y.SignerType.KEY);null!=a&&(this.name_=a.getName());this.key_=a;return this};Y.prototype.getSignerType=function(){return this.type_};
Y.prototype.getSignerName=function(){return this.name_};Y.prototype.getPibIdentity=function(){if(this.type_!=Y.SignerType.ID)throw Error("getPibIdentity: The signer type is not SignerType.ID");return this.identity_};Y.prototype.getPibKey=function(){if(this.type_!=Y.SignerType.KEY)throw Error("getPibKey: The signer type is not SignerType.KEY");return this.key_};Y.prototype.setDigestAlgorithm=function(a){this.digestAlgorithm_=a;return this};Y.prototype.getDigestAlgorithm=function(){return this.digestAlgorithm_};
Y.prototype.setValidityPeriod=function(a){this.validityPeriod_=new Da(a);return this};Y.prototype.getValidityPeriod=function(){return this.validityPeriod_};Y.prototype.toString=function(){if(this.type_==Y.SignerType.NULL)return"";if(this.type_==Y.SignerType.ID)return"id:"+this.getSignerName().toUri();if(this.type_==Y.SignerType.KEY)return"key:"+this.getSignerName().toUri();if(this.type_==Y.SignerType.CERT)return"cert:"+this.getSignerName().toUri();if(this.type_==Y.SignerType.SHA256)return"id:"+Y.getDigestSha256Identity().toUri();
throw Error("Unknown signer type");};Y.getDigestSha256Identity=function(){return new c("/localhost/identity/digest-sha256")};Y.prototype.reset=function(a){if(a!=Y.SignerType.NULL&&a!=Y.SignerType.ID&&a!=Y.SignerType.KEY&&a!=Y.SignerType.CERT&&a!=Y.SignerType.SHA256)throw Error("SigningInfo: The signerType is not valid");this.type_=a;this.name_=new c;this.key_=this.identity_=null;this.validityPeriod_=new Da};Da=function bf(a,b){this.changeCount_=0;"object"===typeof a&&a instanceof bf?(validityPeriod=
a,this.notBefore_=validityPeriod.notBefore_,this.notAfter_=validityPeriod.notAfter_):void 0!=b?(notBefore=a,this.setPeriod(notBefore,b)):this.clear()};q.ValidityPeriod=Da;Da.prototype.hasPeriod=function(){return!(this.notBefore_===Number.MAX_VALUE&&this.notAfter_===-Number.MAX_VALUE)};Da.prototype.getNotBefore=function(){return this.notBefore_};Da.prototype.getNotAfter=function(){return this.notAfter_};Da.prototype.clear=function(){this.notBefore_=Number.MAX_VALUE;this.notAfter_=-Number.MAX_VALUE;
++this.changeCount_};Da.prototype.setPeriod=function(a,b){this.notBefore_=Math.round(1E3*Math.ceil(Math.round(a)/1E3));this.notAfter_=Math.round(1E3*Math.floor(Math.round(b)/1E3));++this.changeCount_;return this};Da.prototype.isValid=function(a){void 0==a&&(a=Math.round(1E3*Math.ceil(Math.round((new Date).getTime())/1E3)));return this.notBefore_<=a&&a<=this.notAfter_};Da.canGetFromSignature=function(a){return void 0!=a.constructor&&("Sha256WithRsaSignature"===a.constructor.name||"Sha256WithEcdsaSignature"===
a.constructor.name)};Da.getFromSignature=function(a){if(void 0==a.constructor||"Sha256WithRsaSignature"!==a.constructor.name&&"Sha256WithEcdsaSignature"!==a.constructor.name)throw Error("ValidityPeriod.getFromSignature: Signature type does not have a ValidityPeriod");return a.getValidityPeriod()};Da.prototype.getChangeCount=function(){return this.changeCount_};var W=a,b=a.SyncPromise,p=a.Blob,r=a.WireFormat,da=a.KeyType,Fa=a.DigestAlgorithm,Fb=a.UseSubtleCrypto,M=a.CertificateV2,za=a.PublicKey,Ra=
function(){};q.VerificationHelpers=Ra;Ra.verifySignaturePromise=function(a,c,g,x,y){"boolean"===typeof x&&(y=x,x=void 0);a instanceof p&&(a=a.buf());c instanceof p&&(c=c.buf());if(!(g instanceof za))try{g instanceof p||(g=new p(g)),g=new za(g)}catch(u){return b.reject(Error("verifySignaturePromise: Error decoding public key DER: "+u))}void 0==x&&(x=Fa.SHA256);if(x==Fa.SHA256)if(g.getKeyType()==da.RSA){if(Fb()&&!y){var Ya={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};return crypto.subtle.importKey("spki",
g.getKeyDer().buf().buffer,Ya,!0,["verify"]).then(function(x){return crypto.subtle.verify(Ya,x,c,a)})}try{null===Ra.verifyUsesString_&&Ra.setVerifyUsesString_();for(var s=g.getKeyDer().buf().toString("base64"),z="-----BEGIN PUBLIC KEY-----\n",f=0;f<s.length;f+=64)z+=s.substr(f,64)+"\n";var z=z+"-----END PUBLIC KEY-----",ga=W.createVerify("RSA-SHA256");ga.update(a);var l=Ra.verifyUsesString_?c.toString("binary"):c;return b.resolve(ga.verify(z,l))}catch(m){return b.reject(Error("verifySignaturePromise: Error is RSA verify: "+
m))}}else if(g.getKeyType()==da.EC)try{null===Ra.verifyUsesString_&&Ra.setVerifyUsesString_();s=g.getKeyDer().buf().toString("base64");z="-----BEGIN PUBLIC KEY-----\n";for(f=0;f<s.length;f+=64)z+=s.substr(f,64)+"\n";z+="-----END PUBLIC KEY-----";ga=W.createVerify("sha256");ga.update(a);l=Ra.verifyUsesString_?c.toString("binary"):c;return b.resolve(ga.verify(z,l))}catch(r){return b.reject(Error("verifySignaturePromise: Error is ECDSA verify: "+r))}else return b.reject(Error("verifySignaturePromise: Invalid key type"));
else return b.reject(Error("verifySignaturePromise: Invalid digest algorithm"))};Ra.verifySignature=function(a,c,g,x,y,u){"function"===typeof x&&(u=y,y=x,x=void 0);return b.complete(y,u,this.verifySignaturePromise(a,c,g,x,!y))};Ra.verifyDataSignaturePromise=function(a,c,g,x,y){var u=g,Ya=x;g="number"===typeof u?u:void 0;x=u instanceof r?u:Ya instanceof r?Ya:void 0;y="boolean"===typeof u?u:"boolean"===typeof Ya?Ya:"boolean"===typeof y?y:!1;var s;if(c instanceof M)try{s=c.getPublicKey()}catch(z){return b.resolve(!1)}else s=
c;c=a.wireEncode(x);return Ra.verifySignaturePromise(c.signedBuf(),a.getSignature().getSignature(),s,g,y)};Ra.verifyInterestSignaturePromise=function(a,c,g,x,y){var u=g,Ya=x;g="number"===typeof u?u:void 0;x=u instanceof r?u:Ya instanceof r?Ya:void 0;y="boolean"===typeof u?u:"boolean"===typeof Ya?Ya:"boolean"===typeof y?y:!1;var s;if(c instanceof M)try{s=c.getPublicKey()}catch(z){return b.resolve(!1)}else s=c;void 0==x&&(x=r.getDefaultWireFormat());c=Ra.extractSignature_(a,x);if(null==c)return b.resolve(!1);
a=a.wireEncode(x);return Ra.verifySignaturePromise(a.signedBuf(),c.getSignature(),s,g,y)};Ra.verifyDigest=function(a,b,c){a instanceof p&&(a=a.buf());b instanceof p&&(b=b.buf());if(c==Fa.SHA256){c=W.createHash("sha256");c.update(a);a=c.digest();if(b.length!=a.length)return!1;for(c=0;c<b.length;++c)if(b[c]!=a[c])return!1;return!0}throw Error("verifyDigest: Invalid digest algorithm");};Ra.extractSignature_=function(a,b){if(2>a.getName().size())return null;try{return b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf(),!1)}catch(c){return null}};Ra.verifyUsesString_=null;Ra.setVerifyUsesString_=function(){var a=W.createHash("sha256").digest();Ra.verifyUsesString_="string"===typeof a};var td=a.constants,W=a,p=a.Blob,l=a.DerNode,v=a.SecurityException,Jc=a.UnrecognizedKeyFormatException,da=a.KeyType,ea=a.EncryptAlgorithmType,b=a.SyncPromise,Fb=a.UseSubtleCrypto,Fa=a.DigestAlgorithm,za=function Oe(a){if(a){this.keyDer=a;var x=null;try{var b=l.parse(a.buf(),0).getChildren(),x=l.getSequence(b,
0).getChildren()[0].toVal()}catch(u){throw new Jc(Error("PublicKey.decodeKeyType: Error decoding the public key: "+u.message));}x==Oe.RSA_ENCRYPTION_OID?this.keyType=da.RSA:x==Oe.EC_ENCRYPTION_OID&&(this.keyType=da.EC)}else this.keyDer=new p,this.keyType=null};q.PublicKey=za;za.prototype.toDer=function(){return l.parse(this.keyDer.buf())};za.prototype.getKeyType=function(){return this.keyType};za.prototype.getDigest=function(a){void 0==a&&(a=Fa.SHA256);if(a==Fa.SHA256)return a=W.createHash("sha256"),
a.update(this.keyDer.buf()),new p(a.digest(),!1);throw new v(Error("Wrong format!"));};za.prototype.getKeyDer=function(){return this.keyDer};za.prototype.encryptPromise=function(a,c,x){"object"===typeof a&&a instanceof p&&(a=a.buf());if(Fb()&&!x&&c!=ea.RsaPkcs)return c==ea.RsaOaep?this.keyType!=da.RSA?Promise.reject(Error("The key type must be RSA")):crypto.subtle.importKey("spki",this.keyDer.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["encrypt"]).then(function(x){return crypto.subtle.encrypt({name:"RSA-OAEP"},
x,a)}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));var y=this.keyDer.buf().toString("base64");x="-----BEGIN PUBLIC KEY-----\n";for(var u=0;u<y.length;u+=64)x+=y.substr(u,64)+"\n";x+="-----END PUBLIC KEY-----";if(c==ea.RsaPkcs){if(this.keyType!=da.RSA)return b.reject(Error("The key type must be RSA"));c=td.RSA_PKCS1_PADDING}else if(c==ea.RsaOaep){if(this.keyType!=da.RSA)return b.reject(Error("The key type must be RSA"));
c=td.RSA_PKCS1_OAEP_PADDING}else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new p(W.publicEncrypt({key:x,padding:c},a),!1))}catch(Ya){return b.reject(Ya)}};za.prototype.encrypt=function(a,c){return b.getValue(this.encryptPromise(a,c,!0))};za.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";za.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var l=a.DerNode,jb=a.OID,ud=function(a,b,x){this.extensionId="string"===typeof a?new jb(a):a;this.isCritical=b;this.extensionValue=x};q.CertificateExtension=
ud;ud.prototype.toDer=function(){var a=new l.DerSequence,b=new l.DerOid(this.extensionId),x=new l.DerBoolean(this.isCritical),y=new l.DerOctetString(this.extensionValue.buf());a.addChild(b);a.addChild(x);a.addChild(y);a.getSize();return a};ud.prototype.toDerBlob=function(){return this.toDer().encode()};ud.prototype.getOid=function(){return this.extensionId};ud.prototype.getIsCritical=function(){return this.isCritical};ud.prototype.getValue=function(){return this.extensionValue};var p=a.Blob,jb=a.OID,
l=a.DerNode,hd=function(a,b){this.oid="string"===typeof a?new jb(a):a;this.value=b};q.CertificateSubjectDescription=hd;hd.prototype.toDer=function(){var a=new l.DerSequence,b=new l.DerOid(this.oid),x=new l.DerPrintableString((new p(this.value)).buf());a.addChild(b);a.addChild(x);return a};hd.prototype.getOidString=function(){return this.oid.toString()};hd.prototype.getValue=function(){return this.value};var R=a.Data,Ca=a.ContentType,r=a.WireFormat,l=a.DerNode,da=a.KeyType,za=a.PublicKey,hd=a.CertificateSubjectDescription,
ud=a.CertificateExtension,Aa=function(a){void 0!=a?R.call(this,a):R.call(this);this.subjectDescriptionList=[];this.extensionList=[];this.notBefore=Number.MAX_VALUE;this.notAfter=-Number.MAX_VALUE;this.key=new za;void 0!=a&&this.decode()};Aa.prototype=new R;Aa.prototype.name="Certificate";q.Certificate=Aa;Aa.prototype.encode=function(){var a=this.toDer();this.setContent(a.encode());this.getMetaInfo().setType(Ca.KEY)};Aa.prototype.addSubjectDescription=function(a){this.subjectDescriptionList.push(a)};
Aa.prototype.getSubjectDescriptionList=function(){return this.subjectDescriptionList};Aa.prototype.addExtension=function(a){this.extensionList.push(a)};Aa.prototype.getExtensionList=function(){return this.extensionList};Aa.prototype.setNotBefore=function(a){this.notBefore=a};Aa.prototype.getNotBefore=function(){return this.notBefore};Aa.prototype.setNotAfter=function(a){this.notAfter=a};Aa.prototype.getNotAfter=function(){return this.notAfter};Aa.prototype.setPublicKeyInfo=function(a){this.key=a};
Aa.prototype.getPublicKeyInfo=function(){return this.key};Aa.prototype.getPublicKeyDer=function(){if(this.key.getKeyDer().isNull())throw Error("The public key is not set");return this.key.getKeyDer()};Aa.prototype.isTooEarly=function(){return(new Date).getTime()<this.getNotBefore()};Aa.prototype.isTooLate=function(){return(new Date).getTime()>this.getNotAfter()};Aa.prototype.isInValidityPeriod=function(a){return this.getSignature().getValidityPeriod().isValid(a)};Aa.prototype.toDer=function(){var a=
new l.DerSequence,b=new l.DerSequence,x=new l.DerGeneralizedTime(this.getNotBefore()),y=new l.DerGeneralizedTime(this.getNotAfter());b.addChild(x);b.addChild(y);a.addChild(b);x=new l.DerSequence;for(b=0;b<this.subjectDescriptionList.length;++b)x.addChild(this.subjectDescriptionList[b].toDer());a.addChild(x);a.addChild(this.key.toDer());if(0<this.extensionList.length){x=new l.DerSequence;for(b=0;b<this.extensionList.length;++b)x.addChild(this.extensionList[b].toDer());a.addChild(x)}return a};Aa.prototype.decode=
function(){var a=l.parse(this.getContent().buf()).getChildren(),b=l.getSequence(a,0).getChildren();this.notBefore=b[0].toVal();this.notAfter=b[1].toVal();for(var x=l.getSequence(a,1).getChildren(),b=0;b<x.length;++b){var y=l.getSequence(x,b).getChildren(),u=y[0].toVal(),y=y[1].toVal().buf().toString("binary");this.addSubjectDescription(new hd(u,y))}b=a[2].encode();this.key=new za(b);if(3<a.length)for(a=l.getSequence(a,3).getChildren(),b=0;b<a.length;++b)y=l.getSequence(a,b).getChildren(),u=y[0].toVal(),
x=y[1].toVal(),y=y[2].toVal(),this.addExtension(new ud(u,x,y))};Aa.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();R.prototype.wireDecode.call(this,a,b);this.decode()};Aa.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";var b=Aa.toIsoString(Math.round(this.getNotBefore())),x=Aa.toIsoString(Math.round(this.getNotAfter()));a=a+("  NotBefore: "+b+"\n")+("  NotAfter: "+x+"\n");for(b=0;b<this.subjectDescriptionList.length;++b)x=
this.subjectDescriptionList[b],a+="Subject Description:\n",a+="  "+x.getOidString()+": "+x.getValue()+"\n";a+="Public key bits:\n";x=this.getPublicKeyDer().buf().toString("base64");for(b=0;b<x.length;b+=64)a+=x.substring(b,Math.min(b+64,x.length))+"\n";if(0<this.extensionList.length)for(a+="Extensions:\n",b=0;b<this.extensionList.length;++b)x=this.extensionList[b],a+="  OID: "+x.getOid()+"\n",a+="  Is critical: "+(x.getIsCritical()?"Y":"N")+"\n",a+="  Value: "+x.getValue().toHex()+"\n";return a};
Aa.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+Aa.to2DigitString(a.getUTCMonth()+1)+Aa.to2DigitString(a.getUTCDate())+"T"+Aa.to2DigitString(a.getUTCHours())+Aa.to2DigitString(a.getUTCMinutes())+Aa.to2DigitString(a.getUTCSeconds())};Aa.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};var R=a.Data,c=a.Name,v=a.SecurityException,Aa=a.Certificate,r=a.WireFormat,Ma=function Pe(a){void 0!=a?Aa.call(this,a):Aa.call(this);this.publicKeyName=new c;if(a instanceof
Pe)this.publicKeyName=new c(a.publicKeyName);else if(a instanceof R){if(!Pe.isCorrectName(a.getName()))throw new v(Error("Wrong Identity Certificate Name!"));this.setPublicKeyName()}};Ma.prototype=new Aa;Ma.prototype.name="IdentityCertificate";q.IdentityCertificate=Ma;Ma.prototype.setName=function(a){if(!Ma.isCorrectName(a))throw new v(Error("Wrong Identity Certificate Name!"));Aa.prototype.setName.call(this,a);this.setPublicKeyName();return this};Ma.prototype.wireDecode=function(a,x){x=x||r.getDefaultWireFormat();
Aa.prototype.wireDecode.call(this,a,x);this.setPublicKeyName()};Ma.prototype.getPublicKeyName=function(){return this.publicKeyName};Ma.isIdentityCertificate=function(a){return Ma.isCorrectName(a.getName())};Ma.certificateNameToPublicKeyName=function(a){for(var x=!1,b=a.size()-1;0<b+1;--b)if("ID-CERT"==a.get(b).toEscapedString()){x=!0;break}if(!x)throw Error("Incorrect identity certificate name "+a.toUri());for(var x=a.getSubName(0,b),b=!1,u=0;u<x.size();u++)if("KEY"==x.get(u).toEscapedString()){b=
!0;break}if(!b)throw Error("Incorrect identity certificate name "+a.toUri());return x.getSubName(0,u).append(x.getSubName(u+1,x.size()-u-1))};Ma.isCorrectName=function(a){for(var x=a.size()-1;0<=x&&"ID-CERT"!=a.get(x).toEscapedString();x--);if(0>x)return!1;for(x=0;x<a.size()&&"KEY"!=a.get(x).toEscapedString();x++);return x>=a.size()?!1:!0};Ma.prototype.setPublicKeyName=function(){this.publicKeyName=Ma.certificateNameToPublicKeyName(this.getName())};var c=a.Name,v=a.SecurityException,b=a.SyncPromise,
$=function(){};q.IdentityStorage=$;$.prototype.doesIdentityExistPromise=function(a,x){return b.reject(Error("IdentityStorage.doesIdentityExistPromise is not implemented"))};$.prototype.doesIdentityExist=function(a){return b.getValue(this.doesIdentityExistPromise(a,!0))};$.prototype.addIdentityPromise=function(a,x){return b.reject(Error("IdentityStorage.addIdentityPromise is not implemented"))};$.prototype.addIdentity=function(a){return b.getValue(this.addIdentityPromise(a,!0))};$.prototype.revokeIdentity=
function(){return b.reject(Error("IdentityStorage.revokeIdentity is not implemented"))};$.prototype.getNewKeyNamePromise=function(a,x,y){for(var u=Math.floor((new Date).getTime()/1E3);u<=$.lastTimestamp;)u+=1;$.lastTimestamp=u;u=""+u;x=x?"ksk-"+u:"dsk-"+u;var Ya=(new c(a)).append(x);return this.doesKeyExistPromise(Ya,y).then(function(a){if(a)throw new v(Error("Key name already exists"));return b.resolve(Ya)})};$.prototype.getNewKeyName=function(a,x){return b.getValue(this.getNewKeyNamePromise(a,x,
!0))};$.prototype.doesKeyExistPromise=function(a,x){return b.reject(Error("IdentityStorage.doesKeyExistPromise is not implemented"))};$.prototype.doesKeyExist=function(a){return b.getValue(this.doesKeyExistPromise(a,!0))};$.prototype.addKeyPromise=function(a,x,y,u){return b.reject(Error("IdentityStorage.addKeyPromise is not implemented"))};$.prototype.addKey=function(a,x,y){return b.getValue(this.addKeyPromise(a,x,y,!0))};$.prototype.getKeyPromise=function(a,x){return b.reject(Error("IdentityStorage.getKeyPromise is not implemented"))};
$.prototype.getKey=function(a){return b.getValue(this.getKeyPromise(a,!0))};$.prototype.activateKey=function(a){throw Error("IdentityStorage.activateKey is not implemented");};$.prototype.deactivateKey=function(a){throw Error("IdentityStorage.deactivateKey is not implemented");};$.prototype.doesCertificateExistPromise=function(a,x){return b.reject(Error("IdentityStorage.doesCertificateExistPromise is not implemented"))};$.prototype.doesCertificateExist=function(a){return b.getValue(this.doesCertificateExistPromise(a,
!0))};$.prototype.addCertificatePromise=function(a,x){return b.reject(Error("IdentityStorage.addCertificatePromise is not implemented"))};$.prototype.addCertificate=function(a){return b.getValue(this.addCertificatePromise(a,!0))};$.prototype.getCertificatePromise=function(a,x){return b.reject(Error("IdentityStorage.getCertificatePromise is not implemented"))};$.prototype.getCertificate=function(a){return b.getValue(this.getValuePromise(a,!0))};$.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("IdentityStorage.getTpmLocatorPromise is not implemented"))};
$.prototype.getTpmLocator=function(){return b.getValue(this.getTpmLocatorPromise(!0))};$.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("IdentityStorage.getDefaultIdentityPromise is not implemented"))};$.prototype.getDefaultIdentity=function(){return b.getValue(this.getDefaultIdentityPromise(!0))};$.prototype.getDefaultKeyNameForIdentityPromise=function(a,x){return b.reject(Error("IdentityStorage.getDefaultKeyNameForIdentityPromise is not implemented"))};$.prototype.getDefaultKeyNameForIdentity=
function(a){return b.getValue(this.getDefaultKeyNameForIdentityPromise(a,!0))};$.prototype.getDefaultCertificateNameForIdentityPromise=function(a,x){var b=this;return this.getDefaultKeyNameForIdentityPromise(a).then(function(a){return b.getDefaultCertificateNameForKeyPromise(a)})};$.prototype.getDefaultCertificateNameForIdentity=function(a){return b.getValue(this.getDefaultCertificateNameForIdentityPromise(a,!0))};$.prototype.getDefaultCertificateNameForKeyPromise=function(a,x){return b.reject(Error("IdentityStorage.getDefaultCertificateNameForKeyPromise is not implemented"))};
$.prototype.getDefaultCertificateNameForKey=function(a){return b.getValue(this.getDefaultCertificateNameForKeyPromise(a,!0))};$.prototype.getAllIdentitiesPromise=function(a,x,y){return b.reject(Error("IdentityStorage.getAllIdentitiesPromise is not implemented"))};$.prototype.getAllKeyNamesOfIdentityPromise=function(a,x,y,u){return b.reject(Error("IdentityStorage.getAllKeyNamesOfIdentityPromise is not implemented"))};$.prototype.getAllCertificateNamesOfKeyPromise=function(a,x,y,u){return b.reject(Error("IdentityStorage.getAllCertificateNamesOfKeyPromise is not implemented"))};
$.prototype.getAllKeyNamesOfIdentity=function(a,x,y){return b.getValue(this.getAllKeyNamesOfIdentityPromise(a,x,y,!0))};$.prototype.setDefaultIdentityPromise=function(a,x){return b.reject(Error("IdentityStorage.setDefaultIdentityPromise is not implemented"))};$.prototype.setDefaultIdentity=function(a){return b.getValue(this.setDefaultIdentityPromise(a,!0))};$.prototype.setDefaultKeyNameForIdentityPromise=function(a,x,y){return b.reject(Error("IdentityStorage.setDefaultKeyNameForIdentityPromise is not implemented"))};
$.prototype.setDefaultKeyNameForIdentity=function(a,x){return b.getValue(this.setDefaultKeyNameForIdentityPromise(a,x,!0))};$.prototype.setDefaultCertificateNameForKeyPromise=function(a,x,y){return b.reject(Error("IdentityStorage.setDefaultCertificateNameForKeyPromise is not implemented"))};$.prototype.setDefaultCertificateNameForKey=function(a,x){return b.getValue(this.setDefaultCertificateNameForKeyPromise(a,x,!0))};$.prototype.getDefaultCertificatePromise=function(a){var x=this;return this.getDefaultIdentityPromise(a).then(function(b){return x.getDefaultCertificateNameForIdentityPromise(b,
a)},function(a){return b.resolve(null)}).then(function(y){return null==y?b.resolve(null):x.getCertificatePromise(y,a)})};$.prototype.getDefaultCertificate=function(){return b.getValue(this.getDefaultCertificatePromise(!0))};$.prototype.deleteCertificateInfoPromise=function(a,x){return b.reject(Error("IdentityStorage.deleteCertificateInfoPromise is not implemented"))};$.prototype.deleteCertificateInfo=function(a){return b.getValue(this.deleteCertificateInfoPromise(a,!0))};$.prototype.deletePublicKeyInfoPromise=
function(a,x){return b.reject(Error("IdentityStorage.deletePublicKeyInfoPromise is not implemented"))};$.prototype.deletePublicKeyInfo=function(a){return b.getValue(this.deletePublicKeyInfoPromise(a,!0))};$.prototype.deleteIdentityInfoPromise=function(a,x){return b.reject(Error("IdentityStorage.deleteIdentityInfoPromise is not implemented"))};$.prototype.deleteIdentityInfo=function(a){return b.getValue(this.deleteIdentityInfoPromise(a,!0))};$.lastTimestamp=Math.floor((new Date).getTime()/1E3);new $;
var c=a.Name,p=a.Blob,v=a.SecurityException,Ma=a.IdentityCertificate,b=a.SyncPromise,$=a.IdentityStorage,yb=function(){$.call(this);this.identityStore={};this.defaultIdentity="";this.keyStore={};this.certificateStore={}};yb.prototype=new $;yb.prototype.name="MemoryIdentityStorage";q.MemoryIdentityStorage=yb;yb.prototype.doesIdentityExistPromise=function(a){return b.resolve(void 0!==this.identityStore[a.toUri()])};yb.prototype.addIdentityPromise=function(a){a=a.toUri();void 0===this.identityStore[a]&&
(this.identityStore[a]={defaultKey:null});return b.resolve()};yb.prototype.doesKeyExistPromise=function(a){return b.resolve(void 0!==this.keyStore[a.toUri()])};yb.prototype.addKeyPromise=function(a,x,y){if(0===a.size()||this.doesKeyExist(a))return b.resolve();var u=a.getSubName(0,a.size()-1);this.addIdentity(u);this.keyStore[a.toUri()]={keyType:x,keyDer:new p(y),defaultCertificate:null};return b.resolve()};yb.prototype.getKeyPromise=function(a){if(0===a.size())return b.reject(new v(Error("MemoryIdentityStorage.getKeyPromise: Empty keyName")));
a=a.toUri();a=this.keyStore[a];return void 0===a?b.reject(new v(Error("MemoryIdentityStorage.getKeyPromise: The key does not exist"))):b.resolve(a.keyDer)};yb.prototype.doesCertificateExistPromise=function(a){return b.resolve(void 0!==this.certificateStore[a.toUri()])};yb.prototype.addCertificatePromise=function(a){var x=a.getName(),y=a.getPublicKeyName();this.addKey(y,a.getPublicKeyInfo().getKeyType(),a.getPublicKeyInfo().getKeyDer());if(this.doesCertificateExist(x))return b.resolve();this.certificateStore[x.toUri()]=
a.wireEncode();return b.resolve()};yb.prototype.getCertificatePromise=function(a){a=a.toUri();if(void 0===this.certificateStore[a])return b.reject(new v(Error("MemoryIdentityStorage.getCertificatePromise: The certificate does not exist")));var x=new Ma;try{x.wireDecode(this.certificateStore[a])}catch(y){return b.reject(new v(Error("MemoryIdentityStorage.getCertificatePromise: The certificate cannot be decoded")))}return b.resolve(x)};$.prototype.getTpmLocatorPromise=function(a){return b.resolve("tpm-memory:")};
yb.prototype.getDefaultIdentityPromise=function(){return 0===this.defaultIdentity.length?b.reject(new v(Error("MemoryIdentityStorage.getDefaultIdentity: The default identity is not defined"))):b.resolve(new c(this.defaultIdentity))};yb.prototype.getDefaultKeyNameForIdentityPromise=function(a){a=a.toUri();return void 0!==this.identityStore[a]?null!=this.identityStore[a].defaultKey?b.resolve(this.identityStore[a].defaultKey):b.reject(new v(Error("No default key set."))):b.reject(new v(Error("Identity not found.")))};
yb.prototype.getDefaultCertificateNameForKeyPromise=function(a){a=a.toUri();return void 0!==this.keyStore[a]?null!=this.keyStore[a].defaultCertificate?b.resolve(this.keyStore[a].defaultCertificate):b.reject(new v(Error("No default certificate set."))):b.reject(new v(Error("Key not found.")))};yb.prototype.setDefaultIdentityPromise=function(a){a=a.toUri();this.defaultIdentity=void 0!==this.identityStore[a]?a:"";return b.resolve()};yb.prototype.setDefaultKeyNameForIdentityPromise=function(a,x){x=x instanceof
c?x:null;var y=a.getPrefix(-1);if(null!=x&&0<x.size()&&!x.equals(y))return b.reject(new v(Error("The specified identity name does not match the key name")));y=y.toUri();void 0!==this.identityStore[y]&&(this.identityStore[y].defaultKey=new c(a));return b.resolve()};yb.prototype.setDefaultCertificateNameForKeyPromise=function(a,x){var y=a.toUri();void 0!==this.keyStore[y]&&(this.keyStore[y].defaultCertificate=new c(x));return b.resolve()};yb.prototype.deleteCertificateInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteCertificateInfoPromise is not implemented"))};
yb.prototype.deletePublicKeyInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deletePublicKeyInfoPromise is not implemented"))};yb.prototype.deleteIdentityInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteIdentityInfoPromise is not implemented"))};var b=a.SyncPromise,l=a.DerNode,qa=function(){};q.PrivateKeyStorage=qa;qa.prototype.generateKeyPairPromise=function(a,x,y){return b.reject(Error("PrivateKeyStorage.generateKeyPairPromise is not implemented"))};
qa.prototype.generateKeyPair=function(a,x){b.getValue(this.generateKeyPairPromise(a,x,!0))};qa.prototype.deleteKeyPairPromise=function(a,x){return b.reject(Error("PrivateKeyStorage.deleteKeyPairPromise is not implemented"))};qa.prototype.deleteKeyPair=function(a){b.getValue(this.deleteKeyPairPromise(a,!0))};qa.prototype.getPublicKeyPromise=function(a,x){return b.reject(Error("PrivateKeyStorage.getPublicKeyPromise is not implemented"))};qa.prototype.getPublicKey=function(a){return b.getValue(this.getPublicKeyPromise(a,
!0))};qa.prototype.signPromise=function(a,x,y,u){return b.reject(Error("PrivateKeyStorage.sign is not implemented"))};qa.prototype.sign=function(a,x,y){return b.getValue(this.signPromise(a,x,y,!0))};qa.prototype.decrypt=function(a,x,b){throw Error("PrivateKeyStorage.decrypt is not implemented");};qa.prototype.encrypt=function(a,x,b){throw Error("PrivateKeyStorage.encrypt is not implemented");};qa.prototype.generateKey=function(a,x){throw Error("PrivateKeyStorage.generateKey is not implemented");};
qa.prototype.doesKeyExistPromise=function(a,x,y){return b.reject(Error("PrivateKeyStorage.doesKeyExist is not implemented"))};qa.prototype.doesKeyExist=function(a,x){return b.getValue(this.doesKeyExistPromise(a,x,!0))};qa.encodePkcs8PrivateKey=function(a,x,b){var u=new l.DerSequence;u.addChild(new l.DerOid(x));u.addChild(b);x=new l.DerSequence;x.addChild(new l.DerInteger(0));x.addChild(u);x.addChild(new l.DerOctetString(a));return x.encode()};qa.encodePkcs1PrivateKeyFromRSAKey=function(a){var x=new l.DerSequence;
x.addChild(new l.DerInteger(0));x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.n)));x.addChild(new l.DerInteger(a.e));x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.d)));x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.p)));x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.q)));x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.dmp1)));x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.dmq1)));x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.coeff)));return x.encode()};qa.encodePublicKeyFromRSAKey=
function(a){var x=new l.DerSequence;x.addChild(new l.DerInteger(qa.bigIntegerToBuffer(a.n)));x.addChild(new l.DerInteger(a.e));a=new l.DerSequence;a.addChild(new l.DerOid(new jb(qa.RSA_ENCRYPTION_OID)));a.addChild(new l.DerNull);var b=new l.DerSequence;b.addChild(a);b.addChild(new l.DerBitString(x.encode().buf(),0));return b.encode()};qa.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("PrivateKeyStorage.bigIntegerToBuffer: Negative integers are not currently supported");
1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new f(a,"hex")};qa.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";qa.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var W=a,p=a.Blob,v=a.SecurityException,za=a.PublicKey,fd=a.KeyClass,da=a.KeyType,Fa=a.DigestAlgorithm,L=a.DataUtils,qa=a.PrivateKeyStorage,l=a.DerNode,jb=a.OID,b=a.SyncPromise,Fb=a.UseSubtleCrypto,Cc=null;try{Cc=a}catch(hf){}var Dc=function(){qa.call(this);this.publicKeyStore={};this.privateKeyStore={}};Dc.prototype=new qa;Dc.prototype.name=
"MemoryPrivateKeyStorage";q.MemoryPrivateKeyStorage=Dc;Dc.prototype.setPublicKeyForKeyName=function(a,x,b){this.publicKeyStore[a.toUri()]=new za(new p(b,!0))};Dc.prototype.setPrivateKeyForKeyName=function(a,x,b){b=b.toString("base64");var u;if(x===da.RSA){u="-----BEGIN RSA PRIVATE KEY-----\n";for(var c=0;c<b.length;c+=64)u+=b.substr(c,64)+"\n";u+="-----END RSA PRIVATE KEY-----"}else if(x===da.EC){u="-----BEGIN EC PRIVATE KEY-----\n";for(c=0;c<b.length;c+=64)u+=b.substr(c,64)+"\n";u+="-----END EC PRIVATE KEY-----"}else throw new v(Error("MemoryPrivateKeyStorage: KeyType is not supported"));
this.privateKeyStore[a.toUri()]={keyType:x,privateKey:u}};Dc.prototype.setKeyPairForKeyName=function(a,x,b,u){this.setPublicKeyForKeyName(a,x,b);this.setPrivateKeyForKeyName(a,x,u)};Dc.prototype.generateKeyPairPromise=function(a,x,y){if(this.doesKeyExist(a,fd.PUBLIC))return b.reject(new v(Error("Public key already exists")));if(this.doesKeyExist(a,fd.PRIVATE))return b.reject(new v(Error("Private key already exists")));var u=this;if(Fb()&&!y){if(x.getKeyType()===da.RSA){var c=null,s=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",
modulusLength:x.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){c=a.privateKey;return crypto.subtle.exportKey("spki",a.publicKey)}).then(function(a){s=(new p(new Uint8Array(a),!1)).buf();return crypto.subtle.exportKey("pkcs8",c)}).then(function(b){b=l.parse((new p(new Uint8Array(b),!1)).buf()).getChildren()[2].toVal();u.setKeyPairForKeyName(a,x.getKeyType(),s,b.buf());u.privateKeyStore[a.toUri()].subtleKey=c;return Promise.resolve()})}return b.reject(new v(Error("Only RSA key generation currently supported")))}return b.resolve().then(function(){if("undefined"!==
typeof B)if(x.getKeyType()===da.RSA){var y=new B;y.generate(x.getKeySize(),"010001");u.setKeyPairForKeyName(a,x.getKeyType(),qa.encodePublicKeyFromRSAKey(y).buf(),qa.encodePkcs1PrivateKeyFromRSAKey(y).buf())}else return b.reject(new v(Error("Only RSA key generation currently supported")));else{var c;if(x.getKeyType()===da.RSA){if(!Cc)return b.reject(new v(Error("Need to install rsa-keypair: sudo npm install rsa-keypair")));c=Cc.generate(x.getKeySize());y=c.publicKey.toString().replace("-----BEGIN PUBLIC KEY-----",
"").replace("-----END PUBLIC KEY-----","");y=new f(y,"base64");c=c.privateKey.toString()}else return b.reject(new v(Error("Only RSA key generation currently supported")));u.setPublicKeyForKeyName(a,x.getKeyType(),y);u.privateKeyStore[a.toUri()]={keyType:x.getKeyType(),privateKey:c}}return b.resolve()})};Dc.prototype.deleteKeyPairPromise=function(a){a=a.toUri();delete this.publicKeyStore[a];delete this.privateKeyStore[a];return b.resolve()};Dc.prototype.getPublicKeyPromise=function(a){var x=a.toUri(),
x=this.publicKeyStore[x];return void 0===x?b.reject(new v(Error("MemoryPrivateKeyStorage: Cannot find public key "+a.toUri()))):b.resolve(x)};Dc.prototype.signPromise=function(a,x,y,u){u="boolean"===typeof y?y:u;y="boolean"!==typeof y&&y?y:Fa.SHA256;if(y!=Fa.SHA256)return b.reject(new v(Error("MemoryPrivateKeyStorage.sign: Unsupported digest algorithm")));x=x.toUri();var c=this.privateKeyStore[x];if(void 0===c)return b.reject(new v(Error("MemoryPrivateKeyStorage: Cannot find private key "+x)));if(Fb()&&
!u){var s={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};c.subtleKey?u=crypto.subtle.sign(s,c.subtleKey,a):(u=L.privateKeyPemToDer(c.privateKey),u=qa.encodePkcs8PrivateKey(u,new jb(qa.RSA_ENCRYPTION_OID),new l.DerNull).buf(),u=crypto.subtle.importKey("pkcs8",u.buffer,s,!0,["sign"]).then(function(x){c.subtleKey=x;return crypto.subtle.sign(s,x,a)}));return u.then(function(a){a=new p(new Uint8Array(a),!0);return Promise.resolve(a)})}if(c.keyType===da.RSA)u=W.createSign("RSA-SHA256");else if(c.keyType===
da.EC)u=W.createSign("sha256");else return b.reject(new v(Error("MemoryPrivateKeyStorage.sign: Unrecognized private key type")));u.update(a);u=new f(L.toNumbersIfString(u.sign(c.privateKey)));u=new p(u,!1);return b.resolve(u)};Dc.prototype.doesKeyExistPromise=function(a,x){var y=a.toUri(),u=!1;x==fd.PUBLIC?u=void 0!==this.publicKeyStore[y]:x==fd.PRIVATE&&(u=void 0!==this.privateKeyStore[y]);return b.resolve(u)};W=a;new qa;var W=a,c=a.Name,R=a.Data,p=a.Blob,vd=a.ConfigFile,wb=a.DigestSha256Signature,
Ia=a.Sha256WithRsaSignature,Va=a.Sha256WithEcdsaSignature,ta=a.KeyLocatorType,r=a.WireFormat,v=a.SecurityException,Fa=a.DigestAlgorithm,da=a.KeyType,ac=a.RsaKeyParams,Ma=a.IdentityCertificate,za=a.PublicKey,hd=a.CertificateSubjectDescription,b=a.SyncPromise,Ie=a.BasicIdentityStorage,Se=a.FilePrivateKeyStorage,ja=function x(a,b){if(b){if(!a)throw Error("IdentityManager: A custom privateKeyStorage is supplied with a null identityStorage");this.identityStorage=a;this.privateKeyStorage=b}else{if(!vd)throw new v(Error("IdentityManager: If not in Node.js then you must supply identityStorage and privateKeyStorage."));
var c=new vd,s=[null],g=this;this.identityStorage=a?a:x.getDefaultIdentityStorage_(c,function(){return g.checkTpmPromise_(s[0])});this.privateKeyStorage=x.getDefaultPrivateKeyStorage_(c,s)}};q.IdentityManager=ja;ja.prototype.createIdentityAndCertificatePromise=function(a,y,u){var c=this,s=!0,g=null;return this.identityStorage.addIdentityPromise(a,u).then(function(){return c.identityStorage.getDefaultKeyNameForIdentityPromise(a,u).then(function(a){g=a;return c.identityStorage.getKeyPromise(g,u).then(function(a){(new za(a)).getKeyType()==
y.getKeyType()&&(s=!1);return b.resolve()})},function(a){if(!(a instanceof v))throw a;return b.resolve()})}).then(function(){return s?c.generateKeyPairPromise(a,!0,y,u).then(function(a){g=a;return c.identityStorage.setDefaultKeyNameForIdentityPromise(g,u)}):b.resolve()}).then(function(){return c.identityStorage.getDefaultCertificateNameForKeyPromise(g,u).then(function(a){return b.resolve(a)},function(a){if(!(a instanceof v))throw a;var x;return c.selfSignPromise(g,u).then(function(a){x=a.getName();
return c.addCertificateAsIdentityDefaultPromise(a,u)}).then(function(){return b.resolve(x)})})})};ja.prototype.createIdentityAndCertificate=function(a,y,u,c){return b.complete(u,c,this.createIdentityAndCertificatePromise(a,y,!u))};ja.prototype.createIdentity=function(a,b){return Ma.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,b))};ja.prototype.deleteIdentity=function(a,y,c){var g=this,s=!0,z=this.identityStorage.getDefaultIdentityPromise(!y).then(function(y){y.equals(a)&&(s=
!1);return b.resolve()},function(a){return b.resolve()}).then(function(){if(!s)return b.resolve();var y=[];return g.identityStorage.getAllKeyNamesOfIdentityPromise(a,y,!0).then(function(){return g.identityStorage.getAllKeyNamesOfIdentityPromise(a,y,!1)}).then(function(){return g.identityStorage.deleteIdentityInfoPromise(a)}).then(function(){function a(x){return x>=y.length?b.resolve():g.privateKeyStorage.deleteKeyPairPromise(y[x]).then(function(){return a(x+1)})}return a(0)})});return b.complete(y,
c,z)};ja.prototype.setDefaultIdentityPromise=function(a,b){return this.identityStorage.setDefaultIdentityPromise(a,b)};ja.prototype.setDefaultIdentity=function(a,y,c){return b.complete(y,c,this.identityStorage.setDefaultIdentityPromise(a,!y))};ja.prototype.getDefaultIdentityPromise=function(a){return this.identityStorage.getDefaultIdentityPromise(a)};ja.prototype.getDefaultIdentity=function(a,y){return b.complete(a,y,this.identityStorage.getDefaultIdentityPromise(!a))};ja.prototype.getDefaultCertificatePromise=
function(a){return this.identityStorage.getDefaultCertificatePromise(a)};ja.prototype.generateRSAKeyPair=function(a,y,c){return b.getValue(this.generateKeyPairPromise(a,y,new ac(c),!0))};ja.prototype.setDefaultKeyForIdentity=function(a,y,u,g){g="function"===typeof y?u:g;u="function"===typeof y?y:u;y="function"!==typeof y&&y?y:new c;return b.complete(u,g,this.identityStorage.setDefaultKeyNameForIdentityPromise(a,y,!u))};ja.prototype.getDefaultKeyNameForIdentity=function(a,y,c){return b.complete(y,
c,this.identityStorage.getDefaultKeyNameForIdentityPromise(a,!y))};ja.prototype.generateRSAKeyPairAsDefaultPromise=function(a,y,c,g){var s,z=this;return this.generateKeyPairPromise(a,y,new ac(c)).then(function(a){s=a;return z.identityStorage.setDefaultKeyNameForIdentityPromise(s)}).then(function(){return b.resolve(s)})};ja.prototype.generateRSAKeyPairAsDefault=function(a,y,c){return b.getValue(this.generateRSAKeyPairAsDefaultPromise(a,y,c,!0))};ja.prototype.getPublicKey=function(a,y,c){return b.complete(y,
c,this.identityStorage.getKeyPromise(a,!y).then(function(a){return b.resolve(new za(a))}))};ja.prototype.prepareUnsignedIdentityCertificate=function(a,y,u,g,s,z,f,ga,l){y instanceof za||(l=ga,ga=f,f=z,z=s,s=g,g=u,u=y,y=null);var m=f,p=ga;f=m instanceof c?m:null;"function"===typeof m?(ga=m,l=p):"function"===typeof p?ga=p:l=ga=null;a=null==y?this.prepareUnsignedIdentityCertificatePromise(a,u,g,s,z,f,!ga):this.prepareUnsignedIdentityCertificatePromise(a,y,u,g,s,z,f,!ga);return b.complete(ga,l,a)};ja.prototype.prepareUnsignedIdentityCertificatePromise=
function(a,y,u,g,s,z,f,ga){y instanceof za||(ga=f,f=z,z=s,s=g,g=u,u=y,y=null);var l=f;f=l instanceof c?l:null;return(null==y?this.identityStorage.getKeyPromise(a,"boolean"===typeof l?l:"boolean"===typeof ga?ga:!1).then(function(a){y=new za(a);return b.resolve()}):b.resolve()).then(function(){return b.resolve(ja.prepareUnsignedIdentityCertificateHelper_(a,y,u,g,s,z,f))})};ja.prepareUnsignedIdentityCertificateHelper_=function(a,b,u,g,s,z,f){if(1>a.size())return null;var ga=a.get(-1).toEscapedString();
if(4>ga.length)return null;keyIdPrefix=ga.substr(0,4);if("ksk-"!=keyIdPrefix&&"dsk-"!=keyIdPrefix)return null;var ga=new Ma,l=new c;if(null==f)u.match(a)?l.append(u).append("KEY").append(a.getSubName(u.size())).append("ID-CERT").appendVersion((new Date).getTime()):l.append(a.getPrefix(-1)).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion((new Date).getTime());else if(f.match(a)&&!f.equals(a))l.append(f).append("KEY").append(a.getSubName(f.size())).append("ID-CERT").appendVersion((new Date).getTime());
else return null;ga.setName(l);ga.setNotBefore(g);ga.setNotAfter(s);ga.setPublicKeyInfo(b);if(null==z||0===z.length)ga.addSubjectDescription(new hd("2.5.4.41",a.getPrefix(-1).toUri()));else for(a=0;a<z.length;++a)ga.addSubjectDescription(z[a]);try{ga.encode()}catch(m){throw v(Error("DerEncodingException: "+m));}return ga};ja.prototype.addCertificate=function(a,y,c){return b.complete(y,c,this.identityStorage.addCertificatePromise(a,!y))};ja.prototype.setDefaultCertificateForKeyPromise=function(a,b){var c=
this,g=a.getPublicKeyName();return this.identityStorage.doesKeyExistPromise(g,b).then(function(s){if(!s)throw new v(Error("No corresponding Key record for certificate!"));return c.identityStorage.setDefaultCertificateNameForKeyPromise(g,a.getName(),b)})};ja.prototype.setDefaultCertificateForKey=function(a,y,c){return b.complete(y,c,this.setDefaultCertificateForKeyPromise(a,!y))};ja.prototype.addCertificateAsIdentityDefaultPromise=function(a,b){var c=this;return this.identityStorage.addCertificatePromise(a,
b).then(function(){var g=a.getPublicKeyName();return c.identityStorage.setDefaultKeyNameForIdentityPromise(g,b)}).then(function(){return c.setDefaultCertificateForKeyPromise(a,b)})};ja.prototype.addCertificateAsDefault=function(a,y,c){var g=!y,s=this;return b.complete(y,c,this.identityStorage.addCertificatePromise(a,g).then(function(){return s.setDefaultCertificateForKeyPromise(a,g)}))};ja.prototype.getCertificate=function(a,y,c){return b.complete(y,c,this.identityStorage.getCertificatePromise(a,
!1,!y))};ja.prototype.getDefaultCertificateNameForIdentityPromise=function(a,b){return this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,b)};ja.prototype.getDefaultCertificateNameForIdentity=function(a,y,c){return b.complete(y,c,this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,!y))};ja.prototype.getDefaultCertificateName=function(a,y){var c=!a,g=this;return b.complete(a,y,this.identityStorage.getDefaultIdentityPromise(c).then(function(a){return g.identityStorage.getDefaultCertificateNameForIdentityPromise(a,
c)}))};ja.prototype.getAllIdentities=function(a,y,c,g){return b.complete(c,g,this.identityStorage.getAllIdentitiesPromise(a,y,!c))};ja.prototype.getAllKeyNamesOfIdentity=function(a,y,c,g,s){return b.complete(g,s,this.identityStorage.getAllKeyNamesOfIdentityPromise(a,y,c,!g))};ja.prototype.getAllCertificateNamesOfKey=function(a,y,c,g,s){return b.complete(g,s,this.identityStorage.getAllCertificateNamesOfKeyPromise(a,y,c,!g))};ja.prototype.signByCertificatePromise=function(a,y,c,g){g="boolean"===typeof c?
c:g;c="boolean"!==typeof c&&c?c:r.getDefaultWireFormat();var s=ja.certificateNameToPublicKeyName(y),z=this;if(a instanceof R){var f=[0];return this.makeSignatureByCertificatePromise(y,f,g).then(function(b){a.setSignature(b);b=a.wireEncode(c);return z.privateKeyStorage.signPromise(b.signedBuf(),s,f[0],g)}).then(function(y){a.getSignature().setSignature(y);a.wireEncode(c);return b.resolve(a)})}f=[0];return this.makeSignatureByCertificatePromise(y,f,g).then(function(b){return z.privateKeyStorage.signPromise(a,
s,f[0],g)}).then(function(a){signature.setSignature(a);return b.resolve(signature)})};ja.prototype.signByCertificate=function(a,y,c,g,s){s="function"===typeof c?g:s;g="function"===typeof c?c:g;c="function"!==typeof c&&c?c:r.getDefaultWireFormat();return b.complete(g,s,this.signByCertificatePromise(a,y,c,!g))};ja.prototype.signInterestByCertificatePromise=function(a,y,u,g){g="boolean"===typeof u?u:g;u="boolean"!==typeof u&&u?u:r.getDefaultWireFormat();var s=this,z,f=[0];return this.makeSignatureByCertificatePromise(y,
f,g).then(function(b){z=b;a.getName().append(u.encodeSignatureInfo(z));a.getName().append(new c.Component);b=a.wireEncode(u);var l=ja.certificateNameToPublicKeyName(y);return s.privateKeyStorage.signPromise(b.signedBuf(),l,f[0],g)}).then(function(y){z.setSignature(y);a.setName(a.getName().getPrefix(-1).append(u.encodeSignatureValue(z)));return b.resolve(a)})};ja.prototype.signInterestByCertificate=function(a,y,c,g,s){s="function"===typeof c?g:s;g="function"===typeof c?c:g;c="function"!==typeof c&&
c?c:r.getDefaultWireFormat();return b.complete(g,s,this.signInterestByCertificatePromise(a,y,c,!g))};ja.prototype.signWithSha256=function(a,b){b=b||r.getDefaultWireFormat();a.setSignature(new wb);var c=a.wireEncode(b),g=W.createHash("sha256");g.update(c.signedBuf());a.getSignature().setSignature(new p(g.digest(),!1));a.wireEncode(b)};ja.prototype.signInterestWithSha256=function(a,b){b=b||r.getDefaultWireFormat();var u=new wb;a.getName().append(b.encodeSignatureInfo(u));a.getName().append(new c.Component);
var g=a.wireEncode(b),s=W.createHash("sha256");s.update(g.signedBuf());u.setSignature(new p(s.digest(),!1));a.setName(a.getName().getPrefix(-1).append(b.encodeSignatureValue(u)))};ja.prototype.selfSignPromise=function(a,b){var c=new Ma,g=this;return this.identityStorage.getKeyPromise(a,b).then(function(s){s=new za(s);var z=(new Date).getTime(),f=z+63072E6;c.setNotBefore(z);c.setNotAfter(f);z=a.getPrefix(-1).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion(c.getNotBefore());c.setName(z);
c.setPublicKeyInfo(s);c.addSubjectDescription(new hd("2.5.4.41",a.toUri()));c.encode();return g.signByCertificatePromise(c,c.getName(),b)})};ja.prototype.selfSign=function(a,y,c){return b.complete(y,c,this.selfSignPromise(a,!y))};ja.certificateNameToPublicKeyName=function(a){for(var b=a.size()-1;0<=b&&"ID-CERT"!=a.get(b).toEscapedString();)--b;a=a.getSubName(0,b);for(b=0;b<a.size()&&"KEY"!=a.get(b).toEscapedString();)++b;return a.getSubName(0,b).append(a.getSubName(b+1,a.size()-b-1))};ja.prototype.makeSignatureByCertificatePromise=
function(a,y,c){var g=ja.certificateNameToPublicKeyName(a);return this.privateKeyStorage.getPublicKeyPromise(g,c).then(function(c){c=c.getKeyType();var u=null;if(c==da.RSA)u=new Ia,y[0]=Fa.SHA256,u.getKeyLocator().setType(ta.KEYNAME),u.getKeyLocator().setKeyName(a.getPrefix(-1));else if(c==da.EC)u=new Va,y[0]=Fa.SHA256,u.getKeyLocator().setType(ta.KEYNAME),u.getKeyLocator().setKeyName(a.getPrefix(-1));else throw new v(Error("Key type is not recognized"));return b.resolve(u)})};ja.prototype.generateKeyPairPromise=
function(a,c,u,g){var s,z=this;return this.identityStorage.getNewKeyNamePromise(a,c,g).then(function(a){s=a;return z.privateKeyStorage.generateKeyPairPromise(s,u,g)}).then(function(){return z.privateKeyStorage.getPublicKeyPromise(s,g)}).then(function(a){return z.identityStorage.addKeyPromise(s,u.getKeyType(),a.getKeyDer())}).then(function(){return b.resolve(s)})};ja.getDefaultIdentityStorage_=function(a,b){var c=a.get("pib","");if(""!==c&&"pib-sqlite3"!==c)throw new v(Error("Invalid config file pib value: "+
c));return new Ie(b)};ja.getDefaultPrivateKeyStorage_=function(a,b){var c=a.get("tpm","");if(""===c){if("darwin"===process.platform)throw b[0]="tpm-osxkeychain:",new v(Error("IdentityManager: OS X key chain storage is not yet implemented. You must supply a privateKeyStorage."));b[0]="tpm-file:";return new Se}if("tpm-osxkeychain"===c)throw b[0]="tpm-osxkeychain:",new v(Error("IdentityManager: tpm-osxkeychain is not yet implemented."));if("tpm-file"===c)return b[0]="tpm-file:",new Se;throw new v(Error("Invalid config file tpm value: "+
c));};ja.prototype.checkTpmPromise_=function(a){return this.identityStorage.getTpmLocatorPromise().then(function(b){return""!==b&&b!==a?Promise.reject(new v(Error("The TPM locator supplied does not match the TPM locator in the PIB: "+b+" != "+a))):Promise.resolve()},function(a){return Promise.resolve()})};var c=a.Name,b=a.SyncPromise,M=a.CertificateV2,Qc=function(a,b,u){this.certificates_={};this.keyName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.certificateNameUris_=
[];for(var g in u)this.certificateNameUris_.push(u[g].toUri())};q.PibCertificateContainer=Qc;Qc.makePromise=function(a,c,u){return null==c?b.reject(Error("The pibImpl is null")):c.getCertificatesOfKeyPromise(a,u).then(function(u){return b.resolve(new Qc(a,c,u))})};Qc.prototype.size=function(){return this.certificateNameUris_.length};Qc.prototype.addPromise=function(a,c){if(!this.keyName_.equals(a.getKeyName()))return b.reject(Error("The certificate name `"+a.getKeyName().toUri()+"` does not match the key name"));
var u=a.getName().toUri();0>this.certificateNameUris_.indexOf(u)&&this.certificateNameUris_.push(u);this.certificates_[u]=new M(a);return this.pibImpl_.addCertificatePromise(a,c)};Qc.prototype.removePromise=function(a,c){if(!M.isValidName(a)||!M.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var u=a.toUri(),g=this.certificateNameUris_.indexOf(u);0<=g&&this.certificateNameUris_.splice(g,1);delete this.certificates_[u];
return this.pibImpl_.removeCertificatePromise(a,c)};Qc.prototype.getPromise=function(a,c){var u=a.toUri(),g=this.certificates_[u];if(void 0!=g)return b.resolve(new M(g));if(!M.isValidName(a)||!M.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var s=this;return this.pibImpl_.getCertificatePromise(a,c).then(function(a){s.certificates_[u]=a;return b.resolve(new M(a))})};var c=a.Name,Rb=a.PibIdentity,
pc=a.PibIdentityImpl,b=a.SyncPromise,Ec=function(a,b){this.identities_={};this.pibImpl_=a;if(null==a)throw Error("The pibImpl is null");this.identityNameUris_=[];for(var c in b)this.identityNameUris_.push(b[c].toUri())};q.PibIdentityContainer=Ec;Ec.makePromise=function(a,c){return null==a?b.reject(Error("The pibImpl is null")):a.getIdentitiesPromise(c).then(function(c){return b.resolve(new Ec(a,c))})};Ec.prototype.size=function(){return this.identityNameUris_.length};Ec.prototype.addPromise=function(a,
b){var c=a.toUri();if(0>this.identityNameUris_.indexOf(c)){var g=this;this.identityNameUris_.push(c);return pc.makePromise(a,this.pibImpl_,!0,b).then(function(s){g.identities_[c]=s;return g.getPromise(a,b)})}return this.getPromise(a,b)};Ec.prototype.removePromise=function(a,b){var c=a.toUri(),g=this.identityNameUris_.indexOf(c);0<=g&&this.identityNameUris_.splice(g,1);delete this.identities_[c];return this.pibImpl_.removeIdentityPromise(a,b)};Ec.prototype.getPromise=function(a,c){var u=a.toUri(),
g=this.identities_[u];if(void 0==g){var s=this;return pc.makePromise(a,this.pibImpl_,!1,c).then(function(a){s.identities_[u]=a;return b.resolve(new Rb(a))})}return b.resolve(new Rb(g))};Ec.prototype.resetPromise=function(a){var c=this;this.identities_={};return this.pibImpl_.getIdentitiesPromise(a).then(function(a){c.identityNameUris_=[];for(var x in a)c.identityNameUris_.push(a[x].toUri());return b.resolve()})};b=a.SyncPromise;Rb=function(a){this.impl_=a};q.PibIdentity=Rb;Rb.prototype.getName=function(){return this.lock_().getName()};
Rb.prototype.getKeyPromise=function(a,c){try{return this.lock_().getKeyPromise(a,c)}catch(u){return b.reject(u)}};Rb.prototype.getKey=function(a,c,u){return b.complete(c,u,this.getKeyPromise(a,!c))};Rb.prototype.getDefaultKeyPromise=function(a){try{return this.lock_().getDefaultKeyPromise(a)}catch(c){return b.reject(c)}};Rb.prototype.getDefaultKey=function(a,c){return b.complete(a,c,this.getDefaultKeyPromise(!a))};Rb.prototype.addKeyPromise_=function(a,c,u){try{return this.lock_().addKeyPromise(a,
c,u)}catch(g){return b.reject(g)}};Rb.prototype.removeKeyPromise_=function(a,c){try{return this.lock_().removeKeyPromise(a,c)}catch(u){return b.reject(u)}};Rb.prototype.setDefaultKeyPromise_=function(a,c,u){try{return this.lock_().setDefaultKeyPromise(a,c,u)}catch(g){return b.reject(g)}};Rb.prototype.getKeys_=function(){return this.lock_().keys_};Rb.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var b=a.SyncPromise,aa=function(){};q.PibImpl=aa;
aa.Error=function(a){if(a)return a.__proto__=aa.Error.prototype,a};aa.Error.prototype=Error();aa.Error.prototype.name="PibImplError";aa.prototype.setTpmLocatorPromise=function(a,c){return b.reject(Error("PibImpl.setTpmLocatorPromise is not implemented"))};aa.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("PibImpl.getTpmLocatorPromise is not implemented"))};aa.prototype.hasIdentityPromise=function(a,c){return b.reject(Error("PibImpl.hasIdentityPromise is not implemented"))};aa.prototype.addIdentityPromise=
function(a,c){return b.reject(Error("PibImpl.addIdentityPromise is not implemented"))};aa.prototype.removeIdentityPromise=function(a,c){return b.reject(Error("PibImpl.removeIdentityPromise is not implemented"))};aa.prototype.clearIdentitiesPromise=function(a){return b.reject(Error("PibImpl.clearIdentitiesPromise is not implemented"))};aa.prototype.getIdentitiesPromise=function(a){return b.reject(Error("PibImpl.getIdentitiesPromise is not implemented"))};aa.prototype.setDefaultIdentityPromise=function(a,
c){return b.reject(Error("PibImpl.setDefaultIdentityPromise is not implemented"))};aa.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("PibImpl.getDefaultIdentityPromise is not implemented"))};aa.prototype.hasKeyPromise=function(a,c){return b.reject(Error("PibImpl.hasKeyPromise is not implemented"))};aa.prototype.addKeyPromise=function(a,c,u,g){return b.reject(Error("PibImpl.addKeyPromise is not implemented"))};aa.prototype.removeKeyPromise=function(a,c){return b.reject(Error("PibImpl.removeKeyPromise is not implemented"))};
aa.prototype.getKeyBitsPromise=function(a,c){return b.reject(Error("PibImpl.getKeyBitsPromise is not implemented"))};aa.prototype.getKeysOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getKeysOfIdentityPromise is not implemented"))};aa.prototype.setDefaultKeyOfIdentityPromise=function(a,c,u){return b.reject(Error("PibImpl.setDefaultKeyOfIdentityPromise is not implemented"))};aa.prototype.getDefaultKeyOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultKeyOfIdentityPromise is not implemented"))};
aa.prototype.hasCertificatePromise=function(a,c){return b.reject(Error("PibImpl.hasCertificatePromise is not implemented"))};aa.prototype.addCertificatePromise=function(a,c){return b.reject(Error("PibImpl.addCertificatePromise is not implemented"))};aa.prototype.removeCertificatePromise=function(a,c){return b.reject(Error("PibImpl.removeCertificatePromise is not implemented"))};aa.prototype.getCertificatePromise=function(a,c){return b.reject(Error("PibImpl.getCertificatePromise is not implemented"))};
aa.prototype.getCertificatesOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getCertificatesOfKeyPromise is not implemented"))};aa.prototype.setDefaultCertificateOfKeyPromise=function(a,c,u){return b.reject(Error("PibImpl.setDefaultCertificateOfKeyPromise is not implemented"))};aa.prototype.getDefaultCertificateOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultCertificateOfKeyPromise is not implemented"))};var Za=function(){aa.call(this);this.database=new Dexie("pib");this.database.version(1).stores({globals:"key",
identities:"identityNameUri",keys:"keyNameUri",certificates:"certificateNameUri"});this.database.open()};Za.prototype=new aa;Za.prototype.name="PibIndexedDb";q.PibIndexedDb=Za;Za.getScheme=function(){return"pib-indexeddb"};Za.prototype.setTpmLocatorPromise=function(a,b){return b?Promise.reject(new aa.Error(Error("PibIndexedDb.setTpmLocatorPromise is only supported for async"))):this.database.globals.put({key:"tpmLocator",value:a})};Za.prototype.getTpmLocatorPromise=function(a){return a?Promise.reject(new aa.Error(Error("PibIndexedDb.getTpmLocatorPromise is only supported for async"))):
this.database.globals.get("tpmLocator").then(function(a){return a?Promise.resolve(a.value):Promise.resolve("")})};Za.prototype.hasIdentityPromise=function(a,b){return b?Promise.reject(new aa.Error(Error("PibIndexedDb.hasIdentityPromise is only supported for async"))):this.database.identities.where("identityNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Za.prototype.addIdentityPromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.addIdentityPromise is only supported for async")));
var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.get("defaultIdentityUri")}).then(function(b){return b?Promise.resolve():c.setDefaultIdentityPromise(a)})};Za.prototype.removeIdentityPromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.removeIdentityPromise is only supported for async")));var u=a.toUri(),g=this;return this.database.certificates.each(function(b){M.extractIdentityFromCertName(new c(b.certificateNameUri)).equals(a)&&
g.database.certificates.delete(b.certificateNameUri)}).then(function(){return g.database.keys.each(function(b){pa.extractIdentityFromKeyName(new c(b.keyNameUri)).equals(a)&&g.database.keys.delete(b.keyNameUri)})}).then(function(){return g.database.identities.delete(u)}).then(function(){return g.database.globals.get("defaultIdentityUri")}).then(function(a){return a&&a.value==u?g.database.globals.delete("defaultIdentityUri"):Promise.resolve()})};Za.prototype.clearIdentitiesPromise=function(a){if(a)return Promise.reject(new aa.Error(Error("PibIndexedDb.clearIdentitiesPromise is only supported for async")));
var b=this;return this.database.globals.delete("defaultIdentityUri").then(function(){return b.database.certificates.clear()}).then(function(){return b.database.keys.clear()}).then(function(){return b.database.identities.clear()})};Za.prototype.getIdentitiesPromise=function(a){if(a)return Promise.reject(new aa.Error(Error("PibIndexedDb.getIdentitiesPromise is only supported for async")));var b=[];return this.database.identities.each(function(a){b.push(new c(a.identityNameUri))}).then(function(){return Promise.resolve(b)})};
Za.prototype.setDefaultIdentityPromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.setDefaultIdentityPromise is only supported for async")));var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.put({key:"defaultIdentityUri",value:a.toUri()})})};Za.prototype.getDefaultIdentityPromise=function(a){return a?Promise.reject(new aa.Error(Error("PibIndexedDb.getDefaultIdentityPromise is only supported for async"))):
this.database.globals.get("defaultIdentityUri").then(function(a){return a?Promise.resolve(new c(a.value)):Promise.reject(new ka.Error(Error("No default identity")))})};Za.prototype.hasKeyPromise=function(a,b){return b?Promise.reject(new aa.Error(Error("PibIndexedDb.hasKeyPromise is only supported for async"))):this.database.keys.where("keyNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Za.prototype.addKeyPromise=function(a,b,u,g){if(g)return Promise.reject(new aa.Error(Error("PibIndexedDb.addKeyPromise is only supported for async")));
var s=this;return this.addIdentityPromise(a).then(function(){return s.hasKeyPromise(b)}).then(function(a){return a?s.database.keys.update(b.toUri(),{keyDer:u}):s.database.keys.put({keyNameUri:b.toUri(),keyDer:u,defaultCertificateUri:null})}).then(function(){return s.database.identities.get(a.toUri())}).then(function(a){return a&&null!=a.defaultKeyUri?s.hasKeyPromise(new c(a.defaultKeyUri)):Promise.resolve(!1)}).then(function(c){return c?Promise.resolve():s.setDefaultKeyOfIdentityPromise(a,b)})};Za.prototype.removeKeyPromise=
function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.removeKeyPromise is only supported for async")));var u=this;return this.database.certificates.each(function(b){M.extractKeyNameFromCertName(new c(b.certificateNameUri)).equals(a)&&u.database.certificates.delete(b.certificateNameUri)}).then(function(){return u.database.keys.delete(a.toUri())})};Za.prototype.getKeyBitsPromise=function(a,b){return b?Promise.reject(new aa.Error(Error("PibIndexedDb.getKeyBitsPromise is only supported for async"))):
this.database.keys.get(a.toUri()).then(function(b){return b?Promise.resolve(new p(b.keyDer)):Promise.reject(new ka.Error(Error("Key `"+a.toUri()+"` does not exist")))})};Za.prototype.getKeysOfIdentityPromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.getKeysOfIdentityPromise is only supported for async")));var u=[];return this.database.keys.each(function(b){b=new c(b.keyNameUri);pa.extractIdentityFromKeyName(b).equals(a)&&u.push(b)}).then(function(){return Promise.resolve(u)})};
Za.prototype.setDefaultKeyOfIdentityPromise=function(a,b,c){if(c)return Promise.reject(new aa.Error(Error("PibIndexedDb.setDefaultKeyOfIdentityPromise is only supported for async")));var g=this;return this.hasKeyPromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new ka.Error(Error("Key `"+b.toUri()+"` does not exist")))}).then(function(){return g.database.identities.update(a.toUri(),{defaultKeyUri:b.toUri()})})};Za.prototype.getDefaultKeyOfIdentityPromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.getDefaultKeyOfIdentityPromise is only supported for async")));
var u=this;return this.database.identities.get(a.toUri()).then(function(b){if(b){if(null!=b.defaultKeyUri){var y=new c(b.defaultKeyUri);return u.hasKeyPromise(y).then(function(b){return b?Promise.resolve(y):Promise.reject(new ka.Error(Error("No default key for identity `"+a.toUri()+"`")))})}return Promise.reject(new ka.Error(Error("No default key for identity `"+a.toUri()+"`")))}return Promise.reject(new ka.Error(Error("Identity `"+a.toUri()+"` does not exist")))})};Za.prototype.hasCertificatePromise=
function(a,b){return b?Promise.reject(new aa.Error(Error("PibIndexedDb.hasCertificatePromise is only supported for async"))):this.database.certificates.where("certificateNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Za.prototype.addCertificatePromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.addCertificatePromise is only supported for async")));var u=a.getKeyName(),g=u.toUri(),s=this,z=a.getContent();return this.addKeyPromise(a.getIdentity(),
u,z.buf()).then(function(){return s.database.certificates.put({certificateNameUri:a.getName().toUri(),encoding:a.wireEncode().buf()})}).then(function(){return s.database.keys.get(g)}).then(function(a){return a&&null!=a.defaultCertificateUri?s.hasCertificatePromise(new c(a.defaultCertificateUri)):Promise.resolve(!1)}).then(function(b){return b?Promise.resolve():s.setDefaultCertificateOfKeyPromise(u,a.getName())})};Za.prototype.removeCertificatePromise=function(a,b){return b?Promise.reject(new aa.Error(Error("PibIndexedDb.removeCertificatePromise is only supported for async"))):
this.database.certificates.delete(a.toUri())};Za.prototype.getCertificatePromise=function(a,b){return b?Promise.reject(new aa.Error(Error("PibIndexedDb.getCertificatePromise is only supported for async"))):this.database.certificates.get(a.toUri()).then(function(b){if(b){var c=new M;c.wireDecode(b.encoding);return Promise.resolve(c)}return Promise.reject(new ka.Error(Error("Certificate `"+a.toUri()+"` does not exit")))})};Za.prototype.getCertificatesOfKeyPromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.getCertificatesOfKeyPromise is only supported for async")));
var u=[];return this.database.certificates.each(function(b){b=new c(b.certificateNameUri);M.extractKeyNameFromCertName(b).equals(a)&&u.push(b)}).then(function(){return Promise.resolve(u)})};Za.prototype.setDefaultCertificateOfKeyPromise=function(a,b,c){if(c)return Promise.reject(new aa.Error(Error("PibIndexedDb.setDefaultCertificateOfKeyPromise is only supported for async")));var g=this;return this.hasCertificatePromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new ka.Error(Error("Certificate `"+
b.toUri()+"` does not exist")))}).then(function(){return g.database.keys.update(a.toUri(),{defaultCertificateUri:b.toUri()})})};Za.prototype.getDefaultCertificateOfKeyPromise=function(a,b){if(b)return Promise.reject(new aa.Error(Error("PibIndexedDb.getDefaultCertificateOfKeyPromise is only supported for async")));var u=this;return this.database.keys.get(a.toUri()).then(function(b){return b&&null!=b.defaultCertificateUri?u.getCertificatePromise(new c(b.defaultCertificateUri)):Promise.reject(new ka.Error(Error("No default certificate for key `"+
a.toUri()+"`")))})};var c=a.Name,pa=a.PibKey,Tb=a.PibKeyImpl,b=a.SyncPromise,Rc=function(a,b,u){this.keys_={};this.identityName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.keyNameUris_=[];for(var g in u)this.keyNameUris_.push(u[g].toUri())};q.PibKeyContainer=Rc;Rc.makePromise=function(a,c,u){return null==c?b.reject(Error("The pibImpl is null")):c.getKeysOfIdentityPromise(a,u).then(function(u){return b.resolve(new Rc(a,c,u))})};Rc.prototype.size=function(){return this.keyNameUris_.length};
Rc.prototype.addPromise=function(a,c,u){if(!this.identityName_.equals(pa.extractIdentityFromKeyName(c)))return b.reject(Error("The key name `"+c.toUri()+"` does not match the identity name `"+this.identityName_.toUri()+"`"));var g=c.toUri();0>this.keyNameUris_.indexOf(g)&&this.keyNameUris_.push(g);var s=this;return Tb.makePromise(c,a,this.pibImpl_,u).then(function(a){s.keys_[g]=a;return s.getPromise(c,u)})};Rc.prototype.removePromise=function(a,c){if(!this.identityName_.equals(pa.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+
a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var u=a.toUri(),g=this.keyNameUris_.indexOf(u);0<=g&&this.keyNameUris_.splice(g,1);delete this.keys_[u];return this.pibImpl_.removeKeyPromise(a,c)};Rc.prototype.getPromise=function(a,c){if(!this.identityName_.equals(pa.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var u=a.toUri(),g=this.keys_[u];if(void 0==g){var s=this;return Tb.makePromise(a,
this.pibImpl_,c).then(function(a){s.keys_[u]=a;return b.resolve(new pa(a))})}return b.resolve(new pa(g))};Rc.prototype.getKeyNames=function(){var a=[],b;for(b in this.keys_)a.push(new c(b));return a};c=a.Name;M=a.CertificateV2;b=a.SyncPromise;pa=function(a){this.impl_=a};q.PibKey=pa;pa.prototype.getName=function(){return this.lock_().getName()};pa.prototype.getIdentityName=function(){return this.lock_().getIdentityName()};pa.prototype.getKeyType=function(){return this.lock_().getKeyType()};pa.prototype.getPublicKey=
function(){return this.lock_().getPublicKey()};pa.prototype.getCertificatePromise=function(a,c){try{return this.lock_().getCertificatePromise(a,c)}catch(u){return b.reject(u)}};pa.prototype.getCertificate=function(a,c,u){return b.complete(c,u,this.getCertificatePromise(a,!c))};pa.prototype.getDefaultCertificatePromise=function(a){try{return this.lock_().getDefaultCertificatePromise(a)}catch(c){return b.reject(c)}};pa.prototype.getDefaultCertificate=function(a,c){return b.complete(a,c,this.getDefaultCertificatePromise(!a))};
pa.constructKeyName=function(a,b){var u=new c(a);u.append(M.KEY_COMPONENT).append(b);return u};pa.isValidKeyName=function(a){return a.size()>M.MIN_KEY_NAME_LENGTH&&a.get(-M.MIN_KEY_NAME_LENGTH).equals(M.KEY_COMPONENT)};pa.extractIdentityFromKeyName=function(a){if(!pa.isValidKeyName(a))throw Error("Key name `"+a.toUri()+"` does not follow the naming conventions");return a.getPrefix(-M.MIN_KEY_NAME_LENGTH)};pa.prototype.addCertificatePromise_=function(a,b){return this.lock_().addCertificatePromise(a,
b)};pa.prototype.removeCertificatePromise_=function(a,b){return this.lock_().removeCertificatePromise(a,b)};pa.prototype.setDefaultCertificatePromise_=function(a,b){return this.lock_().setDefaultCertificatePromise(a,b)};pa.prototype.getCertificates_=function(){return this.lock_().certificates_};pa.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var c=a.Name,p=a.Blob,M=a.CertificateV2,ka=a.Pib,pa=a.PibKey,b=a.SyncPromise,aa=a.PibImpl,wa=function(){aa.call(this);
this.tpmLocator_="";this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={}};wa.prototype=new aa;wa.prototype.name="PibMemory";q.PibMemory=wa;wa.getScheme=function(){return"pib-memory"};wa.prototype.setTpmLocatorPromise=function(a){this.tpmLocator_=a;return b.resolve()};wa.prototype.getTpmLocatorPromise=function(){return b.resolve(this.tpmLocator_)};wa.prototype.hasIdentityPromise=function(a){return b.resolve(this.hasIdentity_(a))};
wa.prototype.hasIdentity_=function(a){for(var b in this.identityNames_)if(this.identityNames_[b].equals(a))return!0;return!1};wa.prototype.addIdentityPromise=function(a){this.addIdentity_(a);return b.resolve()};wa.prototype.addIdentity_=function(a){a=new c(a);this.hasIdentity_(a)||this.identityNames_.push(a);null===this.defaultIdentityName_&&(this.defaultIdentityName_=a)};wa.prototype.removeIdentityPromise=function(a){for(var c=this.identityNames_.length-1;0<=c;--c)this.identityNames_[c].equals(a)&&
this.identityNames_.splice(c,1);null!==this.defaultIdentityName_&&a.equals(this.defaultIdentityName_)&&(this.defaultIdentityName_=null);a=this.getKeysOfIdentity_(a);for(c in a)this.removeKey_(a[c]);return b.resolve()};wa.prototype.clearIdentitiesPromise=function(){this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={};return b.resolve()};wa.prototype.getIdentitiesPromise=function(){var a=[],y;for(y in this.identityNames_)a.push(new c(this.identityNames_[y]));
return b.resolve(a)};wa.prototype.setDefaultIdentityPromise=function(a){this.addIdentity_(a);this.defaultIdentityName_=new c(a);return b.resolve()};wa.prototype.getDefaultIdentityPromise=function(){return null!==this.defaultIdentityName_?b.resolve(new c(this.defaultIdentityName_)):b.reject(new ka.Error(Error("No default identity")))};wa.prototype.hasKeyPromise=function(a){return b.resolve(this.hasKey_(a))};wa.prototype.hasKey_=function(a){return a.toUri()in this.keys_};wa.prototype.addKeyPromise=
function(a,c,u){this.addKey_(a,c,u);return b.resolve()};wa.prototype.addKey_=function(a,b,u){this.addIdentity_(a);b=new c(b);this.keys_[b.toUri()]=new p(u,!0);a=a.toUri();a in this.defaultKeyNames_||(this.defaultKeyNames_[a]=b)};wa.prototype.removeKeyPromise=function(a){this.removeKey_(a);return b.resolve()};wa.prototype.removeKey_=function(a){var b=pa.extractIdentityFromKeyName(a);delete this.keys_[a.toUri()];delete this.defaultKeyNames_[b.toUri()];a=this.getCertificatesOfKey_(a);for(var c in a)this.removeCertificate_(a[c])};
wa.prototype.getKeyBitsPromise=function(a){if(!this.hasKey_(a))return b.reject(new ka.Error(Error("Key `"+a.toUri()+"` not found")));a=this.keys_[a.toUri()];return b.resolve(a)};wa.prototype.getKeysOfIdentityPromise=function(a){return b.resolve(this.getKeysOfIdentity_(a))};wa.prototype.getKeysOfIdentity_=function(a){var b=[],u;for(u in this.keys_){var g=new c(u);a.equals(pa.extractIdentityFromKeyName(g))&&b.push(g)}return b};wa.prototype.setDefaultKeyOfIdentityPromise=function(a,y){if(!this.hasKey_(y))return b.reject(new ka.Error(Error("Key `"+
y.toUri()+"` not found")));this.defaultKeyNames_[a.toUri()]=new c(y);return b.resolve()};wa.prototype.getDefaultKeyOfIdentityPromise=function(a){var y=this.defaultKeyNames_[a.toUri()];return void 0==y?b.reject(new ka.Error(Error("No default key for identity `"+a.toUri()+"`"))):b.resolve(new c(y))};wa.prototype.hasCertificatePromise=function(a){return b.resolve(this.hasCertificate_(a))};wa.prototype.hasCertificate_=function(a){return a.toUri()in this.certificates_};wa.prototype.addCertificatePromise=
function(a){var y=new c(a.getName()),u=a.getKeyName(),g=a.getIdentity();this.addKey_(g,u,a.getContent().buf());this.certificates_[y.toUri()]=new M(a);a=u.toUri();a in this.defaultCertificateNames_||(this.defaultCertificateNames_[a]=y);return b.resolve()};wa.prototype.removeCertificatePromise=function(a){this.removeCertificate_(a);return b.resolve()};wa.prototype.removeCertificate_=function(a){delete this.certificates_[a.toUri()];var b=M.extractKeyNameFromCertName(a).toUri(),c=this.defaultCertificateNames_[b];
void 0!=c&&c.equals(a)&&delete this.defaultCertificateNames_[b]};wa.prototype.getCertificatePromise=function(a){return this.hasCertificate_(a)?b.resolve(new M(this.certificates_[a.toUri()])):b.reject(new ka.Error(Error("Certificate `"+a.toUri()+"` does not exist")))};wa.prototype.getCertificatesOfKeyPromise=function(a){return b.resolve(this.getCertificatesOfKey_(a))};wa.prototype.getCertificatesOfKey_=function(a){var b=[],u;for(u in this.certificates_)M.extractKeyNameFromCertName(this.certificates_[u].getName()).equals(a)&&
b.push(new c(u));return b};wa.prototype.setDefaultCertificateOfKeyPromise=function(a,y){if(!this.hasCertificate_(y))return b.reject(new ka.Error(Error("Certificate `"+y.toUri()+"` does not exist")));this.defaultCertificateNames_[a.toUri()]=new c(y);return b.resolve()};wa.prototype.getDefaultCertificateOfKeyPromise=function(a){var c=this.defaultCertificateNames_[a.toUri()];if(void 0==c)return b.reject(new ka.Error(Error("No default certificate for key `"+a.toUri()+"`")));a=this.certificates_[c.toUri()];
return b.resolve(new M(a))};vd=a.ConfigFile;b=a.SyncPromise;ka=function(a,b,c){this.defaultIdentity_=null;this.scheme_=a;this.location_=b;this.identities_=null;this.pibImpl_=c;this.initializeTpmLocator_=this.initializePibLocator_=this.initializeTpm_=null;this.isInitialized_=this.initializeAllowReset_=!1;if(null==c)throw Error("The pibImpl is null");};q.Pib=ka;ka.Error=function(a){if(a)return a.__proto__=ka.Error.prototype,a};ka.Error.prototype=Error();ka.Error.prototype.name="PibError";ka.prototype.getScheme=
function(){return this.scheme_};ka.prototype.getPibLocator=function(){return this.scheme_+":"+this.location_};ka.prototype.setTpmLocatorPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.doSetTpmLocatorPromise_(a,b)})};ka.prototype.doSetTpmLocatorPromise_=function(a,c){var u=this;return this.pibImpl_.getTpmLocatorPromise(c).then(function(g){return a==g?b.resolve():u.resetPromise_(c).then(function(){return u.pibImpl_.setTpmLocatorPromise(a,c)})})};ka.prototype.getTpmLocatorPromise=
function(a){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getTpmLocatorPromise(a)}).then(function(a){return""==a?b.reject(new ka.Error(Error("TPM info does not exist"))):b.resolve(a)})};ka.prototype.getIdentityPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.getPromise(a,b)})};ka.prototype.getIdentity=function(a,c,u){return b.complete(c,u,this.getIdentityPromise(a,!c))};ka.prototype.getDefaultIdentityPromise=function(a){if(null==
this.defaultIdentity_){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getDefaultIdentityPromise(a)}).then(function(b){return c.identities_.getPromise(b,a)}).then(function(a){c.defaultIdentity_=a;return b.resolve(c.defaultIdentity_)})}return b.resolve(this.defaultIdentity_)};ka.prototype.getDefaultIdentity=function(a,c){return b.complete(a,c,this.getDefaultIdentityPromise(!a))};ka.prototype.resetPromise_=function(a){var b=this;return this.pibImpl_.clearIdentitiesPromise(a).then(function(){return b.pibImpl_.setTpmLocatorPromise("",
a)}).then(function(){b.defaultIdentity_=null;return Ec.makePromise(b.pibImpl_,a)}).then(function(c){b.identities_=c;return b.identities_.resetPromise(a)})};ka.prototype.addIdentityPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.addPromise(a,b)})};ka.prototype.removeIdentityPromise_=function(a,b){null!=this.defaultIdentity_&&this.defaultIdentity_.getName().equals(a)&&(this.defaultIdentity_=null);var c=this;return this.initializePromise_(b).then(function(){return c.identities_.removePromise(a,
b)})};ka.prototype.setDefaultIdentityPromise_=function(a,c){var u=this;return this.initializePromise_(c).then(function(){return u.identities_.addPromise(a,c)}).then(function(b){u.defaultIdentity_=b;return u.pibImpl_.setDefaultIdentityPromise(a)}).then(function(){return b.resolve(u.defaultIdentity_)})};ka.prototype.initializePromise_=function(a){if(this.isInitialized_)return b.resolve();var c=this;return Ec.makePromise(this.pibImpl_,a).then(function(u){c.identities_=u;return null!=c.initializeTpm_?
c.initializeFromLocatorsPromise_(a):b.resolve()}).then(function(){c.isInitialized_=!0;return b.resolve()})};ka.prototype.initializeFromLocatorsPromise_=function(a){var c=[null],u=[null];C.parseAndCheckPibLocator_(this.initializePibLocator_,c,u);var g=c[0]+":"+u[0],s,z=this;return this.pibImpl_.getTpmLocatorPromise(a).then(function(c){var u=[null],y=[null];C.parseAndCheckTpmLocator_(z.initializeTpmLocator_,u,y);s=u[0]+":"+y[0];var u=!1,f;vd&&(f=new vd);if(vd&&g==C.getDefaultPibLocator_(f))""!=c&&c!=
C.getDefaultTpmLocator_(f)&&(u=!0,s=C.getDefaultTpmLocator_(f));else if(""!=c&&c!=s)if(z.initializeAllowReset_)u=!0;else return b.reject(new fe(Error("The supplied TPM locator does not match the TPM locator in the PIB: "+c+" != "+s)));return u?z.resetPromise_(a):b.resolve()}).then(function(){C.setUpTpm_(z.initializeTpm_,s);z.initializeTpm_.isInitialized_=!0;return z.doSetTpmLocatorPromise_(s,a)})};var C=a.KeyChain,fe=a.LocatorMismatchError,Ec=a.PibIdentityContainer,c=a.Name,ka=a.Pib,Rc=a.PibKeyContainer,
b=a.SyncPromise,pc=function(){};q.PibIdentityImpl=pc;pc.makePromise=function(a,g,u,f){var s=new pc;return Rc.makePromise(a,g,f).then(function(z){s.defaultKey_=null;s.identityName_=new c(a);s.keys_=z;s.pibImpl_=g;return null==g?b.reject(Error("The pibImpl is null")):u?g.addIdentityPromise(s.identityName_,f).then(function(){return b.resolve(s)}):g.hasIdentityPromise(s.identityName_,f).then(function(a){return a?b.resolve(s):b.reject(new ka.Error(Error("Identity "+s.identityName_.toUri()+" does not exist")))})})};
pc.prototype.getName=function(){return this.identityName_};pc.prototype.addKeyPromise=function(a,b,c){return this.keys_.addPromise(a,b,c)};pc.prototype.removeKeyPromise=function(a,b){null!==this.defaultKey_&&this.defaultKey_.getName().equals(a)&&(this.defaultKey_=null);return this.keys_.removePromise(a,b)};pc.prototype.getKeyPromise=function(a,b){return this.keys_.getPromise(a,b)};pc.prototype.setDefaultKeyPromise=function(a,g,u){var f=this;if(a instanceof c){var s=a,z=g;return this.keys_.getPromise(s,
z).then(function(a){f.defaultKey_=a;return f.pibImpl_.setDefaultKeyOfIdentityPromise(f.identityName_,s,z)}).then(function(){return b.resolve(f.defaultKey_)})}s=g;z=u;return this.addKeyPromise(a,s,z).then(function(){return f.setDefaultKeyPromise(s,z)})};pc.prototype.getDefaultKeyPromise=function(a){var c=this;return null===this.defaultKey_?this.pibImpl_.getDefaultKeyOfIdentityPromise(this.identityName_,a).then(function(b){return c.keys_.getPromise(b,a)}).then(function(a){c.defaultKey_=a;return b.resolve(c.defaultKey_)}):
b.resolve(this.defaultKey_)};c=a.Name;za=a.PublicKey;p=a.Blob;ka=a.Pib;pa=a.PibKey;aa=a.PibImpl;Qc=a.PibCertificateContainer;b=a.SyncPromise;Tb=function(){};q.PibKeyImpl=Tb;Tb.makePromise=function(a,g,u,f){var s=new Tb;s.defaultCertificate_=null;if(g instanceof aa){var z=g,l=u;return null==z?b.reject(Error("The pibImpl is null")):Qc.makePromise(a,z,l).then(function(b){s.identityName_=pa.extractIdentityFromKeyName(a);s.keyName_=new c(a);s.pibImpl_=z;s.certificates_=b;return s.pibImpl_.getKeyBitsPromise(s.keyName_,
l)}).then(function(a){s.keyEncoding_=a;try{publicKey=new za(s.keyEncoding_)}catch(c){return b.reject(new ka.Error(Error("Error decoding public key")))}s.keyType_=publicKey.getKeyType();return b.resolve(s)})}z=u;l=f;return null==z?b.reject(Error("The pibImpl is null")):Qc.makePromise(a,z,l).then(function(u){s.identityName_=pa.extractIdentityFromKeyName(a);s.keyName_=new c(a);s.keyEncoding_=new p(g,!0);s.pibImpl_=z;s.certificates_=u;try{publicKey=new za(s.keyEncoding_),s.keyType_=publicKey.getKeyType()}catch(f){return b.reject(Error("Invalid key encoding"))}return s.pibImpl_.addKeyPromise(s.identityName_,
s.keyName_,g,l)}).then(function(){return b.resolve(s)})};Tb.prototype.getName=function(){return this.keyName_};Tb.prototype.getIdentityName=function(){return this.identityName_};Tb.prototype.getKeyType=function(){return this.keyType_};Tb.prototype.getPublicKey=function(){return this.keyEncoding_};Tb.prototype.addCertificatePromise=function(a,b){return this.certificates_.addPromise(a,b)};Tb.prototype.removeCertificatePromise=function(a,b){null!==this.defaultCertificate_&&this.defaultCertificate_.getName().equals(a)&&
(this.defaultCertificate_=null);return this.certificates_.removePromise(a,b)};Tb.prototype.getCertificatePromise=function(a,b){return this.certificates_.getPromise(a,b)};Tb.prototype.setDefaultCertificatePromise=function(a,g){var u=this,f;return b.resolve().then(function(){return a instanceof c?b.resolve(a):u.addCertificatePromise(a).then(function(){return b.resolve(a.getName())})}).then(function(a){f=a;return u.certificates_.getPromise(f,g)}).then(function(a){u.defaultCertificate_=a;return u.pibImpl_.setDefaultCertificateOfKeyPromise(u.keyName_,
f,g)}).then(function(){return b.resolve(u.defaultCertificate_)})};Tb.prototype.getDefaultCertificatePromise=function(a){var c=this;return null===this.defaultCertificate_?this.pibImpl_.getDefaultCertificateOfKeyPromise(this.keyName_,a).then(function(a){c.defaultCertificate_=a;return b.resolve(c.defaultCertificate_)}):b.resolve(c.defaultCertificate_)};var Je=function(a,b,c,g,s){this.interest=a;this.onVerified=b;this.onValidationFailed=c;this.retry=g;this.stepCount=s};q.ValidationRequest=Je;var W=a,
p=a.Blob,L=a.DataUtils,v=a.SecurityException,wb=a.DigestSha256Signature,Ia=a.Sha256WithRsaSignature,Va=a.Sha256WithEcdsaSignature,Ra=a.VerificationHelpers,Fa=a.DigestAlgorithm,za=a.PublicKey,b=a.SyncPromise,mb=function(){};q.PolicyManager=mb;mb.prototype.skipVerifyAndTrust=function(a){throw Error("PolicyManager.skipVerifyAndTrust is not implemented");};mb.prototype.requireVerify=function(a){throw Error("PolicyManager.requireVerify is not implemented");};mb.prototype.checkVerificationPolicy=function(a,
b,c,g,s){throw Error("PolicyManager.checkVerificationPolicy is not implemented");};mb.prototype.checkSigningPolicy=function(a,b){throw Error("PolicyManager.checkSigningPolicy is not implemented");};mb.prototype.inferSigningIdentity=function(a){throw Error("PolicyManager.inferSigningIdentity is not implemented");};mb.verifyUsesString_=null;mb.setVerifyUsesString_=function(){var a=W.createHash("sha256").digest();mb.verifyUsesString_="string"===typeof a};mb.verifySignature=function(a,c,g,f){if(a instanceof
Ia||a instanceof Va)if(g.isNull())f(!1);else{var s;try{s=new za(g)}catch(z){throw new v(Error("PolicyManager.verify: Error decoding public key: "+z));}b.complete(f,Ra.verifySignaturePromise(c.signedBuf(),a.getSignature(),s,Fa.SHA256,!f))}else if(a instanceof wb)f(Ra.verifyDigest(c.signedBuf(),a.getSignature(),Fa.SHA256));else throw new v(Error("PolicyManager.verify: Signature type is unknown"));};var Ma=a.IdentityCertificate,id=function(){this.cache={}};q.CertificateCache=id;id.prototype.insertCertificate=
function(a){var b=a.getName().getPrefix(-1);this.cache[b.toUri()]=a.wireEncode()};id.prototype.deleteCertificate=function(a){delete this.cache[a.toUri()]};id.prototype.getCertificate=function(a){a=this.cache[a.toUri()];if(void 0===a)return null;var b=new Ma;b.wireDecode(a);return b};id.prototype.reset=function(){this.cache={}};var ge=Qb=a,c=a.Name,R=a.Data,E=a.Interest,V=a.KeyLocator,ta=a.KeyLocatorType,p=a.Blob,Ma=a.IdentityCertificate,M=a.CertificateV2,cc=a.CertificateCacheV2,kc=a.BoostInfoParser,
Xa=a.NdnRegexTopMatcher,id=a.CertificateCache,Je=a.ValidationRequest,v=a.SecurityException,r=a.WireFormat,mb=a.PolicyManager,P=a.NdnCommon,ya=function(a,b,c,g,s,z){mb.call(this);void 0==b&&(b=null);void 0==c&&(c=5);void 0==g&&(g=3E3);void 0==s&&(s=36E5);void 0==z&&(z=1E3);null==b&&(b=new id);b instanceof id?(this.isSecurityV1_=!0,this.certificateCache_=b,this.certificateCacheV2_=null):(this.isSecurityV1_=!1,this.certificateCache_=null,this.certificateCacheV2_=b);this.maxDepth=c;this.keyGraceInterval=
g;this.keyTimestampTtl=s;this.maxTrackedKeys=z;this.reset();null!=a&&""!=a&&this.load(a)};ya.prototype=new mb;ya.prototype.name="ConfigPolicyManager";q.ConfigPolicyManager=ya;ya.prototype.reset=function(){this.isSecurityV1_?this.certificateCache_.reset():this.certificateCacheV2_.clear();this.fixedCertificateCache={};this.keyTimestamps={};this.requiresVerification=!0;this.config=new kc;this.refreshManager=new ya.TrustAnchorRefreshManager(this.isSecurityV1_)};ya.prototype.load=function(a,b){this.reset();
this.config.read(a,b);this.loadTrustAnchorCertificates()};ya.prototype.requireVerify=function(a){return this.requiresVerification};ya.prototype.checkSigningPolicy=function(a,b){return!0};ya.prototype.skipVerifyAndTrust=function(a){return!this.requiresVerification};ya.prototype.checkVerificationPolicy=function(a,b,c,g,s){var z=a.getName(),f="data";a instanceof E&&(z=z.getPrefix(-4),f="interest");s=ya.extractSignature(a,s);if(null==s){try{g(a,"Cannot extract the signature from "+a.getName().toUri())}catch(l){console.log("Error in onValidationFailed: "+
P.getErrorWithStackTrace(l))}return null}var m=["unknown"],z=this.getCertificateInterest_(b,f,z,s,m);if(null==z){try{g(a,m[0])}catch(p){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(p))}return null}if(0<z.getName().size()){var r=this;return new Je(z,function(s){var z;if(r.isSecurityV1_){try{z=new Ma(s)}catch(f){try{g(a,"Cannot decode certificate "+s.getName().toUri())}catch(Cb){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(Cb))}return null}r.certificateCache_.insertCertificate(z)}else{try{z=
new M(s)}catch(l){try{g(a,"Cannot decode certificate "+s.getName().toUri())}catch(ga){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(ga))}return null}r.certificateCacheV2_.insert(z)}r.checkVerificationPolicy(a,b+1,c,g)},g,2,b+1)}if(a instanceof E){var z=V.getFromSignature(s).getKeyName(),q;q=this.isSecurityV1_?Ma.certificateNameToPublicKeyName(z):z;var v=a.getName().get(-4).toNumber();if(!this.interestTimestampIsFresh(q,v,m)){try{g(a,m[0])}catch(Cb){console.log("Error in onValidationFailed: "+
P.getErrorWithStackTrace(Cb))}return null}}r=this;this.verify(s,a.wireEncode(),function(b,s){if(b){try{c(a)}catch(y){console.log("Error in onVerified: "+P.getErrorWithStackTrace(y))}a instanceof E&&r.updateTimestampForKey(q,v)}else try{g(a,s)}catch(z){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(z))}})};ya.prototype.getCertificateInterest_=function(a,b,c,g,s){if(a>this.maxDepth)return s[0]="The verification stepCount "+a+" exceeded the maxDepth "+this.maxDepth,null;var z;try{z=
this.findMatchingRule(c,b)}catch(f){return null}if(null==z)return s[0]="No matching rule found for "+c.toUri(),null;if(!V.canGetFromSignature(g))return s[0]="The signature type does not support a KeyLocator",null;a=a=V.getFromSignature(g);a=a.getKeyName();if(0==a.size())return s[0]="The signature KeyLocator doesn't have a key name",null;if(!this.checkSignatureMatch(a,c,z,s))return null;this.refreshManager.refreshAnchors();this.isSecurityV1_?(c=this.refreshManager.getCertificate(a),null==c&&(c=this.certificateCache_.getCertificate(a))):
(c=this.refreshManager.getCertificateV2(a),null==c&&(c=this.certificateCacheV2_.find(a)));return null==c?new E(a):new E};ya.prototype.loadTrustAnchorCertificates=function(){for(var a=this.config.getRoot().get("validator/trust-anchor"),b=0;b<a.length;++b){var c=a[b],g=c.get("type")[0].getValue(),s=!1,z;if("file"==g)z=c.get("file-name")[0].getValue(),s=!0;else if("base64"==g)z=c.get("base64-string")[0].getValue(),s=!1;else if("dir"==g){g=c.get("dir")[0].getValue();s=0;c=c.get("refresh");1<=c.length&&
(c=c[0].getValue().match(/(\d+)([hms])/),null==c?s=0:(s=parseInt(c[1]),"s"!=c[2]&&(s*=60,"m"!=c[2]&&(s*=60))));this.refreshManager.addDirectory(g,1E3*s);continue}else if("any"==g){this.requiresVerification=!1;break}this.isSecurityV1_?this.lookupCertificate(z,s):this.lookupCertificateV2(z,s)}};ya.prototype.checkSignatureMatch=function(a,b,g,f){g=g.get("checker")[0];var s=g.get("type")[0].getValue();if("fixed-signer"==s){b=g.get("signer")[0];g=b.get("type")[0].getValue();if("file"==g){if(g=this.isSecurityV1_?
this.lookupCertificate(b.get("file-name")[0].getValue(),!0):this.lookupCertificateV2(b.get("file-name")[0].getValue(),!0),null==g)return f[0]="Can't find fixed-signer certificate file: "+b.get("file-name")[0].getValue(),!1}else if("base64"==g){if(g=this.isSecurityV1_?this.lookupCertificate(b.get("base64-string")[0].getValue(),!1):this.lookupCertificateV2(b.get("base64-string")[0].getValue(),!1),null==g)return f[0]="Can't find fixed-signer certificate base64: "+b.get("base64-string")[0].getValue(),
!1}else return f[0]="Unrecognized fixed-signer signerType: "+g,!1;if(g.getName().equals(a))return!0;f[0]='fixed-signer cert name "'+g.getName().toUri()+'" does not equal signatureName "'+a.toUri()+'"';return!1}if("hierarchical"==s){g=new Xa("^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>");if(g.match(a)){a=g.expand("\\1").append(g.expand("\\2"));if(ya.matchesRelation(b,a,"is-prefix-of"))return!0;f[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}if(!this.isSecurityV1_&&
(g=new Xa("^(<>*)<KEY><>$"),g.match(a))){a=g.expand("\\1");if(ya.matchesRelation(b,a,"is-prefix-of"))return!0;f[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}f[0]='The hierarchical identityRegex "^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>" does not match signatureName "'+a.toUri()+'"';return!1}if("customized"==s){var z=g.get("key-locator")[0];g=z.getFirstValue("relation");if(null!=g){b=new c(z.get("name")[0].getValue());if(ya.matchesRelation(a,b,g))return!0;
f[0]='The custom signatureName "'+a.toUri()+'" does not match matchName "'+b.toUri()+'" using relation '+g;return!1}var l=z.getFirstValue("regex");if(null!=l){if((new Xa(simpleKeyRegex)).match(a))return!0;f[0]='The custom signatureName "'+a.toUri()+'" does not regex match simpleKeyRegex "'+l+'"';return!1}g=z.get("hyper-relation");if(1<=g.length){g=g[0];var l=g.getFirstValue("k-regex"),ga=g.getFirstValue("k-expand"),z=g.getFirstValue("p-regex"),m=g.getFirstValue("p-expand");g=g.getFirstValue("h-relation");
if(null!=l&&null!=ga&&null!=z&&null!=m&&null!=g){s=new Xa(l);if(!s.match(a))return f[0]='The custom hyper-relation signatureName "'+a.toUri()+'" does not match the keyRegex "'+l+'"',!1;a=s.expand(ga);s=new Xa(z);if(!s.match(b))return f[0]='The custom hyper-relation objectName "'+b.toUri()+'" does not match the nameRegex "'+z+'"',!1;b=s.expand(m);if(ya.matchesRelation(b,a,g))return!0;f[0]='The custom hyper-relation nameMatch "'+b.toUri()+'" does not match the keyMatchPrefix "'+a.toUri()+'" using relation '+
g;return!1}}}f[0]="Unrecognized checkerType: "+s;return!1};ya.prototype.lookupCertificate=function(a,b){if(!this.isSecurityV1_)throw new v(Error("lookupCertificate: For security v2, use lookupCertificateV2()"));var g;g=this.fixedCertificateCache[a];if(void 0===g){if(b)g=ya.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(a);else{var l=new f(a,"base64");g=new Ma;g.wireDecode(l)}l=g.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=l;this.certificateCache_.insertCertificate(g)}else g=
this.certificateCache_.getCertificate(new c(g));return g};ya.prototype.lookupCertificateV2=function(a,b){if(this.isSecurityV1_)throw new v(Error("lookupCertificateV2: For security v1, use lookupCertificate()"));var g;g=this.fixedCertificateCache[a];if(void 0===g){if(b)g=ya.TrustAnchorRefreshManager.loadCertificateV2FromFile(a);else{var l=new f(a,"base64");g=new M;g.wireDecode(l)}l=g.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=l;this.certificateCacheV2_.insert(g)}else g=this.certificateCacheV2_.find(new c(g));
return g};ya.prototype.findMatchingRule=function(a,b){for(var g=this.config.getRoot().get("validator/rule"),f=0;f<g.length;++f){var s=g[f];if(s.get("for")[0].getValue()==b){var z=!0,l=s.get("filter");if(0==l.length)return s;for(var ga=0;ga<l.length;++ga){var m=l[ga],z=m.getFirstValue("regex");null===z?(z=m.get("relation")[0].getValue(),m=m.get("name")[0].getValue(),m=new c(m),z=ya.matchesRelation(a,m,z)):z=(new Xa(z)).match(a);if(!z)break}if(z)return s}}return null};ya.matchesRelation=function(a,
b,c){var g=!1;"is-strict-prefix-of"==c?b.size()==a.size()?g=!1:b.match(a)&&(g=!0):"is-prefix-of"==c?b.match(a)&&(g=!0):"equal"==c&&b.equals(a)&&(g=!0);return g};ya.extractSignature=function(a,b){if(a instanceof R)return a.getSignature();if(a instanceof E){b=b||r.getDefaultWireFormat();try{var c=b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(g){return null}return c}return null};ya.prototype.interestTimestampIsFresh=function(a,b,c){a=
this.keyTimestamps[a.toUri()];if(void 0==a){a=(new Date).getTime();var g=a+this.keyGraceInterval;if(b>a-this.keyGraceInterval&&b<g)return!0;c[0]="The command interest timestamp is not within the first use grace period of "+this.keyGraceInterval+" milliseconds.";return!1}return b<=a?(c[0]="The command interest timestamp is not newer than the previous timestamp",!1):!0};ya.prototype.updateTimestampForKey=function(a,b){this.keyTimestamps[a.toUri()]=b;var c=0,g=[],s=(new Date).getTime(),z=s,f=null,l;
for(l in this.keyTimestamps){++c;var m=this.keyTimestamps[l];s-m>this.keyTimestampTtl?g.push(l):m<z&&(z=m,f=l)}if(c>=this.maxTrackedKeys){for(s=0;s<g.length;++s)delete this.keyTimestamps[g[s]],--c;c>this.maxTrackedKeys&&delete this.keyTimestamps[f]}};ya.prototype.verify=function(a,b,c){var g=V.getFromSignature(a);if(g.getType()==ta.KEYNAME){var g=g.getKeyName(),s;if(this.isSecurityV1_){var z=this.refreshManager.getCertificate(g);null==z&&(z=this.certificateCache_.getCertificate(g));if(null==z){c(!1,
"Cannot find a certificate with name "+g.toUri());return}s=z.getPublicKeyInfo().getKeyDer();if(s.isNull()){c(!1,"There is no public key in the certificate with name "+z.getName().toUri());return}}else{z=this.refreshManager.getCertificateV2(g);null==z&&(z=this.certificateCacheV2_.find(g));if(null==z){c(!1,"Cannot find a certificate with name "+g.toUri());return}try{s=z.getPublicKey()}catch(f){c(!1,"There is no public key in the certificate with name "+z.getName().toUri());return}}mb.verifySignature(a,
b,s,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}else c(!1,"The KeyLocator does not have a key name")};ya.TrustAnchorRefreshManager=function(a){this.isSecurityV1_=a;this.certificateCache_=new id;this.certificateCacheV2_=new cc;this.refreshDirectories={}};ya.TrustAnchorRefreshManager.loadIdentityCertificateFromFile=function(a){a=Qb.readFileSync(a).toString();a=new f(a,"base64");var b=new Ma;b.wireDecode(new p(a,!1));return b};ya.TrustAnchorRefreshManager.loadCertificateV2FromFile=
function(a){a=Qb.readFileSync(a).toString();a=new f(a,"base64");var b=new M;b.wireDecode(new p(a,!1));return b};ya.TrustAnchorRefreshManager.prototype.getCertificate=function(a){if(!this.isSecurityV1_)throw new v(Error("getCertificate: For security v2, use getCertificateV2()"));return this.certificateCache_.getCertificate(a)};ya.TrustAnchorRefreshManager.prototype.getCertificateV2=function(a){if(this.isSecurityV1_)throw new v(Error("getCertificateV2: For security v1, use getCertificate()"));return this.certificateCacheV2_.find(a)};
ya.TrustAnchorRefreshManager.prototype.addDirectory=function(a,b){var c;try{c=Qb.readdirSync(a)}catch(g){throw new v(Error("Cannot list files in directory "+a));}for(var s=[],z=0;z<c.length;++z){if(this.isSecurityV1_){var f;try{var l=ge.join(a,c[z]);f=ya.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(l)}catch(m){continue}var p=f.getName().getPrefix(-1).toUri();this.certificateCache_.insertCertificate(f)}else{try{l=ge.join(a,c[z]),f=ya.TrustAnchorRefreshManager.loadCertificateV2FromFile(l)}catch(r){continue}p=
M.extractKeyNameFromCertName(f.getName()).toUri();this.certificateCacheV2_.insert(f)}s.push(p)}this.refreshDirectories[a]={certificates:s,nextRefresh:(new Date).getTime()+b,refreshPeriod:b}};ya.TrustAnchorRefreshManager.prototype.refreshAnchors=function(){var a=(new Date).getTime(),b;for(b in this.refreshDirectories){var g=this.refreshDirectories[b];if(g.nextRefresh<=a){for(var f=g.certificates.slice(0),s=0;s<f.length;++s)try{if(this.isSecurityV1_)this.certificateCache_.deleteCertificate(new c(f[s]));
else{var z=this.certificateCacheV2_.find(new c(f[s]));null!=z&&this.certificateCacheV2_.deleteCertificate(z.getName())}}catch(l){}this.addDirectory(b,g.refreshPeriod)}}};var c=a.Name,mb=a.PolicyManager,P=a.NdnCommon,fc=function(){mb.call(this)};fc.prototype=new mb;fc.prototype.name="NoVerifyPolicyManager";q.NoVerifyPolicyManager=fc;fc.prototype.skipVerifyAndTrust=function(a){return!0};fc.prototype.requireVerify=function(a){return!1};fc.prototype.checkVerificationPolicy=function(a,b,c,g,s){try{c(a)}catch(z){console.log("Error in onVerified: "+
P.getErrorWithStackTrace(z))}return null};fc.prototype.checkSigningPolicy=function(a,b){return!0};fc.prototype.inferSigningIdentity=function(a){return new c};var c=a.Name,E=a.Interest,R=a.Data,p=a.Blob,Ma=a.IdentityCertificate,V=a.KeyLocator,ta=a.KeyLocatorType,v=a.SecurityException,r=a.WireFormat,b=a.SyncPromise,mb=a.PolicyManager,$=a.IdentityStorage,P=a.NdnCommon,Sc=function(a){mb.call(this);a instanceof $?(this.identityStorage_=a,this.pibImpl_=null):(this.identityStorage_=null,this.pibImpl_=a)};
Sc.prototype=new mb;Sc.prototype.name="SelfVerifyPolicyManager";q.SelfVerifyPolicyManager=Sc;Sc.prototype.skipVerifyAndTrust=function(a){return!1};Sc.prototype.requireVerify=function(a){return!0};Sc.prototype.checkVerificationPolicy=function(a,b,c,g,s){s=s||r.getDefaultWireFormat();if(a instanceof R)this.verify(a.getSignature(),a.wireEncode(),function(b,s){if(b)try{c(a)}catch(y){console.log("Error in onVerified: "+P.getErrorWithStackTrace(y))}else try{g(a,s)}catch(z){console.log("Error in onValidationFailed: "+
P.getErrorWithStackTrace(z))}});else if(a instanceof E){if(2>a.getName().size()){try{g(a,"The signed interest has less than 2 components: "+a.getName().toUri())}catch(z){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(z))}return}var f;try{f=s.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(l){try{g(a,"Error decoding the signed interest signature: "+l)}catch(m){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(m))}return}this.verify(f,
a.wireEncode(),function(b,s){if(b)try{c(a)}catch(y){console.log("Error in onVerified: "+P.getErrorWithStackTrace(y))}else try{g(a,s)}catch(z){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(z))}})}else throw new v(Error("checkVerificationPolicy: unrecognized type for dataOrInterest"));return null};Sc.prototype.checkSigningPolicy=function(a,b){return!0};Sc.prototype.inferSigningIdentity=function(a){return new c};Sc.prototype.verify=function(a,b,c){if(V.canGetFromSignature(a))this.getPublicKeyDer(V.getFromSignature(a),
function(g,z){if(g.isNull())c(!1,z);else try{mb.verifySignature(a,b,g,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(f){c(!1,"Error in verifySignature: "+f)}});else try{mb.verifySignature(a,b,null,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(g){c(!1,"Error in verifySignature: "+g)}};Sc.prototype.getPublicKeyDer=function(a,c){if(a.getType()==ta.KEYNAME&&null!=this.identityStorage_){var g;try{g=Ma.certificateNameToPublicKeyName(a.getKeyName())}catch(f){c(new p,
"Cannot get a public key name from the certificate named: "+a.getKeyName().toUri());return}b.complete(c,function(a){c(new p,"The identityStorage doesn't have the key named "+g.toUri())},this.identityStorage_.getKeyPromise(g,!c))}else a.getType()==ta.KEYNAME&&null!=this.pibImpl_?b.complete(c,function(a){c(new p,"The identityStorage doesn't have the key named "+g.toUri())},this.pibImpl_.getKeyBitsPromise(a.getKeyName(),!c)):c(new p,"The signature KeyLocator doesn't have a key name")};var W=a,c=a.Name,
p=a.Blob,xb=a.KeyIdType,pa=a.PibKey,bb=a.Tpm,b=a.SyncPromise,Ga=function(){};q.TpmBackEnd=Ga;Ga.Error=function(a){if(a)return a.__proto__=Ga.Error.prototype,a};Ga.Error.prototype=Error();Ga.Error.prototype.name="TpmBackEndError";Ga.prototype.hasKeyPromise=function(a,b){return this.doHasKeyPromise_(a,b)};Ga.prototype.getKeyHandlePromise=function(a,b){return this.doGetKeyHandlePromise_(a,b)};Ga.prototype.createKeyPromise=function(a,g,u){var f=this;return b.resolve().then(function(){if(g.getKeyIdType()==
xb.USER_SPECIFIED){var s=pa.constructKeyName(a,g.getKeyId());return f.hasKeyPromise(s,u).then(function(a){return a?b.reject(new bb.Error(Error("Key `"+s.toUri()+"` already exists"))):b.resolve()})}if(g.getKeyIdType()==xb.SHA256)return b.resolve();if(g.getKeyIdType()==xb.RANDOM){var z,l=function(){var g=W.randomBytes(8);z=new c.Component(new p(g,!1));g=pa.constructKeyName(a,z);return f.hasKeyPromise(g,u).then(function(a){return a?l():b.resolve()})};return l().then(function(){g.setKeyId(z);return b.resolve()})}return b.reject(new bb.Error(Error("Unsupported key id type")))}).then(function(){return f.doCreateKeyPromise_(a,
g,u)})};Ga.prototype.deleteKeyPromise=function(a,b){return this.doDeleteKeyPromise_(a,b)};Ga.prototype.exportKeyPromise=function(a,c,g){var f=this;return this.hasKeyPromise(a,g).then(function(s){return s?f.doExportKeyPromise_(a,c,g):b.reject(new Ga.Error(Error("Key `"+a.toUri()+"` does not exist")))})};Ga.prototype.importKeyPromise=function(a,c,g,f){var s=this;return this.hasKeyPromise(a,f).then(function(z){return z?b.reject(new Ga.Error(Error("Key `"+a.toUri()+"` already exists"))):s.doImportKeyPromise_(a,
c,g,f)})};Ga.setKeyName=function(a,b,g){if(g.getKeyIdType()==xb.USER_SPECIFIED)g=g.getKeyId();else if(g.getKeyIdType()==xb.SHA256)g=W.createHash("sha256"),g.update(a.derivePublicKey().buf()),g=c.Component(new p(g.digest(),!1));else if(g.getKeyIdType()==xb.RANDOM){if(0==g.getKeyId().getValue().size())throw new Ga.Error(Error("setKeyName: The keyId is empty for type RANDOM"));g=g.getKeyId()}else throw new Ga.Error(Error("setKeyName: unrecognized params.getKeyIdType()"));a.setKeyName(pa.constructKeyName(b,
g))};Ga.prototype.doHasKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doHasKeyPromise_ is not implemented"))};Ga.prototype.doGetKeyHandlePromise_=function(a,c){return b.reject(Error("TpmBackEnd.doGetKeyHandlePromise_ is not implemented"))};Ga.prototype.doCreateKeyPromise_=function(a,c,g){return b.reject(Error("TpmBackEnd.doCreateKeyPromise_ is not implemented"))};Ga.prototype.doDeleteKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doDeleteKeyPromise_ is not implemented"))};
Ga.prototype.doExportKeyPromise_=function(a,c,g){return b.reject(Error("TpmBackEnd.doExportKeyPromise_ is not implemented"))};Ga.prototype.doImportKeyPromise_=function(a,c,g,f){return b.reject(Error("TpmBackEnd.doImportKeyPromise_ is not implemented"))};var b=a.SyncPromise,Q=a.TpmPrivateKey,wd=a.TpmKeyHandleMemory,Ga=a.TpmBackEnd,bc=function(){Ga.call(this);this.keys_={}};bc.prototype=new Ga;bc.prototype.name="TpmBackEndMemory";q.TpmBackEndMemory=bc;bc.getScheme=function(){return"tpm-memory"};bc.prototype.doHasKeyPromise_=
function(a,c){return b.resolve(a.toUri()in this.keys_)};bc.prototype.doGetKeyHandlePromise_=function(a,c){var g=this.keys_[a.toUri()];return void 0==g?b.resolve(null):b.resolve(new wd(g))};bc.prototype.doCreateKeyPromise_=function(a,c,g){var f=this;return Q.generatePrivateKeyPromise(c,g).then(function(g){var u=new wd(g);Ga.setKeyName(u,a,c);f.keys_[u.getKeyName().toUri()]=g;return b.resolve(u)},function(a){return b.reject(new Ga.Error(Error("Error in TpmPrivateKey.generatePrivateKey: "+a)))})};bc.prototype.doDeleteKeyPromise_=
function(a,c){delete this.keys_[a.toUri()];return b.resolve()};Ga.prototype.doExportKeyPromise_=function(a,c,g){a=a.toUri();if(!(a in this.keys_))return b.reject(new Ga.Error(Error("exportKey: The key does not exist")));try{return null!=c?b.resolve(this.keys_[a].toEncryptedPkcs8(c)):b.resolve(this.keys_[a].toPkcs8())}catch(f){return b.reject(new Ga.Error(Error("Error in toPkcs8: "+f)))}};bc.prototype.doImportKeyPromise_=function(a,c,g,f){try{var s=new Q;null!=g?s.loadEncryptedPkcs8(c,g):s.loadPkcs8(c);
this.keys_[a.toUri()]=s;return b.resolve()}catch(z){return b.reject(new Ga.Error(Error("Cannot import private key: "+z)))}};var c=a.Name,b=a.SyncPromise,gc=function(){this.keyName_=new c};q.TpmKeyHandle=gc;gc.prototype.signPromise=function(a,b,c){return this.doSignPromise_(a,b,c)};gc.prototype.decryptPromise=function(a,b){return this.doDecryptPromise_(a,b)};gc.prototype.derivePublicKey=function(a){return this.doDerivePublicKey_(a)};gc.prototype.setKeyName=function(a){this.keyName_=new c(a)};gc.prototype.getKeyName=
function(){return this.keyName_};gc.prototype.doSignPromise_=function(a,c,g){return b.reject(Error("TpmKeyHandle.doSignPromise_ is not implemented"))};gc.prototype.doDecryptPromise_=function(a,c){return b.reject(Error("TpmKeyHandle.doDecryptPromise_ is not implemented"))};gc.prototype.doDerivePublicKey_=function(a){return b.reject(Error("TpmKeyHandle.doDerivePublicKey_ is not implemented"))};p=a.Blob;b=a.SyncPromise;Fa=a.DigestAlgorithm;Q=a.TpmPrivateKey;Ga=a.TpmBackEnd;gc=a.TpmKeyHandle;wd=function(a){gc.call(this);
if(null==a)throw Error("The key is null");this.key_=a};wd.prototype=new gc;wd.prototype.name="TpmKeyHandleMemory";q.TpmKeyHandleMemory=wd;wd.prototype.doSignPromise_=function(a,c,g){return a==Fa.SHA256?this.key_.signPromise(c,a,g).catch(function(a){return b.reject(new Ga.Error(Error("Error in TpmPrivateKey.sign: "+a)))}):b.resolve(new p)};wd.prototype.doDecryptPromise_=function(a,c){return this.key_.decryptPromise(a,c).catch(function(a){return b.reject(new Ga.Error(Error("Error in TpmPrivateKey.decrypt: "+
a)))})};gc.prototype.doDerivePublicKey_=function(){try{return this.key_.derivePublicKey()}catch(a){throw new Ga.Error(Error("Error in TpmPrivateKey.derivePublicKey: "+a));}};var td=a.constants,W=a,da=a.KeyType,ea=a.EncryptAlgorithmType,Fa=a.DigestAlgorithm,L=a.DataUtils,b=a.SyncPromise,l=a.DerNode,Td=a.DerNode.DerSequence,jd=a.DerNode.DerInteger,jb=a.OID,p=a.Blob,Fb=a.UseSubtleCrypto,Cc=null;try{Cc=a}catch(jf){}Q=function(){this.decryptSubtleKey_=this.subtleKey_=this.privateKey_=this.keyType_=null};
q.TpmPrivateKey=Q;Q.Error=function(a){if(a)return a.__proto__=Q.Error.prototype,a};Q.Error.prototype=Error();Q.Error.prototype.name="TpmPrivateKeyError";Q.prototype.loadPkcs1=function(a,b){a instanceof p&&(a=a.buf());if(void 0==b)try{var c=l.parse(a).getChildren();b=9==c.length&&c[0]instanceof jd&&0==c[0].toVal()&&c[1]instanceof jd&&c[2]instanceof jd&&c[3]instanceof jd&&c[4]instanceof jd&&c[5]instanceof jd&&c[6]instanceof jd&&c[7]instanceof jd&&c[8]instanceof jd?da.RSA:da.EC}catch(g){b=da.EC}if(b==
da.EC){for(var c=a.toString("base64"),s="-----BEGIN EC PRIVATE KEY-----\n",f=0;f<c.length;f+=64)s+=c.substr(f,64)+"\n";this.privateKey_=s+"-----END EC PRIVATE KEY-----"}else if(b==da.RSA){c=a.toString("base64");s="-----BEGIN RSA PRIVATE KEY-----\n";for(f=0;f<c.length;f+=64)s+=c.substr(f,64)+"\n";this.privateKey_=s+="-----END RSA PRIVATE KEY-----"}else throw new Q.Error(Error("loadPkcs1: Unrecognized keyType: "+b));this.keyType_=b;this.decryptSubtleKey_=this.subtleKey_=null};Q.prototype.loadPkcs8=
function(a,b){a instanceof p&&(a=a.buf());var c;if(void 0==b){var g;try{var s=l.parse(a),f=s.getChildren();g=l.getSequence(f,1).getChildren()[0].toVal();c=f[2].toVal()}catch(m){try{this.loadPkcs1(a);return}catch(ga){throw new Q.Error(Error("loadPkcs8: Error decoding private key: "+ga));}}if(g==Q.EC_ENCRYPTION_OID)b=da.EC;else if(g==Q.RSA_ENCRYPTION_OID)b=da.RSA;else throw new Q.Error(Error("loadPkcs8: Unrecognized private key OID: "+g));}else s=l.parse(a),c=s.getChildren()[2].toVal();this.loadPkcs1(c,
b)};Q.prototype.loadEncryptedPkcs8=function(a,b){a instanceof p&&(a=a.buf());b instanceof p&&(b=b.buf());var c,g,s;try{var z=l.parse(a,0).getChildren(),m=l.getSequence(z,0).getChildren();c=m[0].toVal();g=m[1];s=z[1].toVal()}catch(ga){throw new Q.Error(Error("Cannot decode the PKCS #8 EncryptedPrivateKeyInfo: "+ga));}var r;if(c==Q.PBES2_OID){var q,v,F,O;try{var Cb=g.getChildren(),kb=l.getSequence(Cb,0).getChildren();q=kb[0].toVal();v=kb[1];var ve=l.getSequence(Cb,1).getChildren();F=ve[0].toVal();O=
ve[1]}catch(Ke){throw new Q.Error(Error("Cannot decode the PBES2 parameters: "+Ke));}c=null;if(q==Q.PBKDF2_OID){var we,xe;try{var ye=v.getChildren();we=ye[0].toVal();xe=ye[1].toVal()}catch(ze){throw new Q.Error(Error("Cannot decode the PBES2 parameters: "+ze));}if(F==Q.DES_EDE3_CBC_OID)q=Q.DES_EDE3_KEY_LENGTH;else throw new Q.Error(Error("Unrecognized PBES2 encryption scheme OID: "+F));try{c=W.pbkdf2Sync(b,we.buf(),xe,q,"sha1")}catch(xd){throw new Q.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+
xd));}}else throw new Q.Error(Error("Unrecognized PBES2 key derivation OID: "+q));if(F==Q.DES_EDE3_CBC_OID){var Hd;try{Hd=O.toVal()}catch(Lb){throw new Q.Error(Error("Cannot decode the DES-EDE3-CBC parameters: "+Lb));}try{var zb=W.createDecipheriv("des-ede3-cbc",c,Hd.buf());r=f.concat([zb.update(s.buf()),zb.final()])}catch(Le){throw new Q.Error(Error("Error decrypting PKCS #8 key with DES-EDE3-CBC: "+Le));}}else throw new Q.Error(Error("Unrecognized PBES2 encryption scheme OID: "+F));}else throw new Q.Error(Error("Unrecognized PKCS #8 EncryptedPrivateKeyInfo OID: "+
c));this.loadPkcs8(r)};Q.prototype.derivePublicKey=function(){if(this.keyType_!=da.RSA)throw new Q.Error(Error("derivePublicKey: The private key is not loaded"));try{var a=L.privateKeyPemToDer(this.privateKey_),b=l.parse(a,0).getChildren(),c=b[1],g=b[2],s=new l.DerSequence;s.addChild(c);s.addChild(g);var f=s.encode(),m=new l.DerSequence;m.addChild(new l.DerOid(new jb(Q.RSA_ENCRYPTION_OID)));m.addChild(new l.DerNull);var ga=new l.DerSequence;ga.addChild(m);ga.addChild(new l.DerBitString(f.buf(),0));
return ga.encode()}catch(p){throw new Q.Error(Error("derivePublicKey: Error decoding private key "+p));}};Q.prototype.decryptPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);void 0==c&&(c=ea.RsaOaep);if(null==this.keyType_)return b.reject(new Q.Error(Error("decrypt: The private key is not loaded")));if(Fb()&&!g&&c!=ea.RsaPkcs)return c==ea.RsaOaep?this.getDecryptSubtleKeyPromise_().then(function(b){return crypto.subtle.decrypt({name:"RSA-OAEP"},b,a)}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),
!1))}):Promise.reject(Error("Unsupported padding scheme"));if(c==ea.RsaPkcs)c=td.RSA_PKCS1_PADDING;else if(c==ea.RsaOaep)c=td.RSA_PKCS1_OAEP_PADDING;else return b.reject(new Q.Error(Error("Unsupported padding scheme")));try{return b.resolve(new p(W.privateDecrypt({key:this.privateKey_,padding:c},a),!1))}catch(f){return b.reject(new Q.Error(f))}};Q.prototype.signPromise=function(a,c,g){if(null==this.keyType_)return b.resolve(new p);if(c!=Fa.SHA256)return b.reject(new Q.Error(Error("TpmPrivateKey.sign: Unsupported digest algorithm")));
if(Fb()&&!g){var l;if(this.keyType_===da.RSA)l={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};else return b.reject(new Q.Error(Error("signPromise: Unrecognized key type "+this.keyType_)));return this.getSubtleKeyPromise_().then(function(b){return crypto.subtle.sign(l,b,a)}).then(function(a){a=new p(new Uint8Array(a),!0);return Promise.resolve(a)})}if(this.keyType_===da.RSA)c=W.createSign("RSA-SHA256");else if(this.keyType===da.EC)c=W.createSign("sha256");else return b.reject(new Q.Error(Error("signPromise: Unrecognized key type "+
this.keyType_)));c.update(a);c=new f(L.toNumbersIfString(c.sign(this.privateKey_)));c=new p(c,!1);return b.resolve(c)};Q.prototype.toPkcs1=function(){if(null==this.keyType_)throw new Q.Error(Error("toPkcs1: The private key is not loaded"));return new p(L.privateKeyPemToDer(this.privateKey_),!1)};Q.prototype.toPkcs8=function(){if(null==this.keyType_)throw new Q.Error(Error("toPkcs8: The private key is not loaded"));var a;if(this.keyType_===da.RSA)a=new jb(Q.RSA_ENCRYPTION_OID);else if(this.keyType===
da.EC)a=new jb(Q.EC_ENCRYPTION_OID);else throw new Q.Error(Error("toPkcs8: Unrecognized key type "+this.keyType_));return Q.encodePkcs8PrivateKey(this.toPkcs1().buf(),a,new l.DerNull)};Q.prototype.toEncryptedPkcs8=function(a){if(null==this.keyType_)throw new Q.Error(Error("toPkcs8: The private key is not loaded"));a instanceof p&&(a=a.buf());var b=W.randomBytes(8),c;try{c=W.pbkdf2Sync(a,b,2048,Q.DES_EDE3_KEY_LENGTH,"sha1")}catch(g){throw new Q.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+
g));}var s;a=W.randomBytes(8);try{var z=W.createCipheriv("des-ede3-cbc",c,a);s=f.concat([z.update(this.toPkcs8().buf()),z.final()])}catch(m){throw new Q.Error(Error("Error encrypting PKCS #8 key with DES-EDE3-CBC: "+m));}try{var ga=new Td;ga.addChild(new l.DerOctetString(b));ga.addChild(new l.DerInteger(2048));var r=new Td;r.addChild(new l.DerOid(Q.PBKDF2_OID));r.addChild(ga);var q=new Td;q.addChild(new l.DerOid(Q.DES_EDE3_CBC_OID));q.addChild(new l.DerOctetString(a));var v=new Td;v.addChild(r);v.addChild(q);
var F=new Td;F.addChild(new l.DerOid(Q.PBES2_OID));F.addChild(v);var O=new Td;O.addChild(F);O.addChild(new l.DerOctetString(s));return O.encode()}catch(Cb){throw new Q.Error(Error("Error encoding the encryped PKCS #8 private key: "+Cb));}};Q.generatePrivateKeyPromise=function(a,c){if(Fb()&&!c){if(a.getKeyType()===da.RSA){var g=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){g=
a.privateKey;return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){var c=new Q;c.loadPkcs8(new p(new Uint8Array(a),!1),da.RSA);c.subtleKey_=g;return b.resolve(c)})}return Promise.reject(Error("Cannot generate a key pair of type "+a.getKeyType()))}var f;if(a.getKeyType()===da.RSA){if(!Cc)return b.reject(new Q.Error(Error("Need to install rsa-keypair: sudo npm install rsa-keypair")));f=Cc.generate(a.getKeySize()).privateKey.toString()}else return b.reject(Error("Cannot generate a key pair of type "+
a.getKeyType()));var s=new Q;s.privateKey_=f;s.keyType_=a.getKeyType();return b.resolve(s)};Q.encodePkcs8PrivateKey=function(a,b,c){var g=new l.DerSequence;g.addChild(new l.DerOid(b));g.addChild(c);b=new l.DerSequence;b.addChild(new l.DerInteger(0));b.addChild(g);b.addChild(new l.DerOctetString(a));return b.encode()};Q.encodePkcs1PrivateKeyFromRSAKey=function(a){var b=new l.DerSequence;b.addChild(new l.DerInteger(0));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));
b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.d)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.p)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.q)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.dmp1)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.dmq1)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.coeff)));return b.encode()};Q.encodePublicKeyFromRSAKey=function(a){var b=new l.DerSequence;b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));
a=new l.DerSequence;a.addChild(new l.DerOid(new jb(Q.RSA_ENCRYPTION_OID)));a.addChild(new l.DerNull);var c=new l.DerSequence;c.addChild(a);c.addChild(new l.DerBitString(b.encode().buf(),0));return c.encode()};Q.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("TpmPrivateKey.bigIntegerToBuffer: Negative integers are not currently supported");1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new f(a,"hex")};Q.prototype.getSubtleKeyPromise_=function(){if(this.subtleKey_)return Promise.resolve(this.subtleKey_);
if(this.keyType_===da.RSA){var a=L.privateKeyPemToDer(this.privateKey_),a=Q.encodePkcs8PrivateKey(a,new jb(Q.RSA_ENCRYPTION_OID),new l.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){c.subtleKey_=a;return Promise.resolve(c.subtleKey_)})}return b.reject(new Q.Error(Error("Unrecognized key type "+this.keyType_)))};Q.prototype.getDecryptSubtleKeyPromise_=function(){if(this.decryptSubtleKey_)return Promise.resolve(this.decryptSubtleKey_);
if(this.keyType_===da.RSA){var a=L.privateKeyPemToDer(this.privateKey_),a=Q.encodePkcs8PrivateKey(a,new jb(Q.RSA_ENCRYPTION_OID),new l.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){c.decryptSubtleKey_=a;return Promise.resolve(c.decryptSubtleKey_)})}return b.reject(new Q.Error(Error("Unrecognized key type "+this.keyType_)))};Q.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";Q.EC_ENCRYPTION_OID="1.2.840.10045.2.1";Q.PBES2_OID=
"1.2.840.113549.1.5.13";Q.PBKDF2_OID="1.2.840.113549.1.5.12";Q.DES_EDE3_CBC_OID="1.2.840.113549.3.7";Q.DES_EDE3_KEY_LENGTH=24;da=a.KeyType;b=a.SyncPromise;bb=function(a,b,c){this.keys_={};this.scheme_=a;this.location_=b;this.backEnd_=c;this.initializePib_=null;this.isInitialized_=!1};q.Tpm=bb;bb.Error=function(a){if(a)return a.__proto__=bb.Error.prototype,a};bb.Error.prototype=Error();bb.Error.prototype.name="TpmError";bb.prototype.getTpmLocator=function(){if(!this.isInitialized_)throw new bb.Error(Error("getTpmLocator: The Tpm is not initialized"));
return this.scheme_+":"+this.location_};bb.prototype.hasKeyPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.backEnd_.hasKeyPromise(a,b)})};bb.prototype.getPublicKeyPromise=function(a,c){var g=this;return this.initializePromise_(c).then(function(){return g.findKeyPromise_(a,c)}).then(function(a){return null==a?b.resolve(new p):b.resolve(a.derivePublicKey())})};bb.prototype.signPromise=function(a,c,g,f){var s=this;return this.initializePromise_(f).then(function(){return s.findKeyPromise_(c,
f)}).then(function(c){return null==c?b.resolve(new p):c.signPromise(g,a,f)})};bb.prototype.decryptPromise=function(a,c,g){var f=this;return this.initializePromise_(g).then(function(){return f.findKeyPromise_(c,g)}).then(function(c){return null==c?b.resolve(new p):c.decryptPromise(a,g)})};bb.prototype.createKeyPromise_=function(a,c,g){var f=this;return this.initializePromise_(g).then(function(){return c.getKeyType()==da.RSA||c.getKeyType()==da.EC?f.backEnd_.createKeyPromise(a,c,g).then(function(a){var c=
a.getKeyName();f.keys_[c.toUri()]=a;return b.resolve(c)}):b.resolve(new bb.Error(Error("createKey: Unsupported key type")))})};bb.prototype.deleteKeyPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){delete c.keys_[a.toUri()];return c.backEnd_.deleteKeyPromise(a,b)})};bb.prototype.exportPrivateKeyPromise_=function(a,b,c){var g=this;return this.initializePromise_(c).then(function(){return g.backEnd_.exportKeyPromise(a,b,c)})};bb.prototype.importPrivateKeyPromise_=function(a,
b,c,g){var s=this;return this.initializePromise_(g).then(function(){return s.backEnd_.importKeyPromise(a,b,c,g)})};bb.prototype.findKeyPromise_=function(a,c){var g=this;return this.initializePromise_(c).then(function(){var f=a.toUri(),s=g.keys_[f];return void 0!=s?b.resolve(s):g.backEnd_.getKeyHandlePromise(a,c).then(function(a){return null!=a?(g.keys_[f]=a,b.resolve(a)):b.resolve(null)})})};bb.prototype.initializePromise_=function(a){return this.isInitialized_?b.resolve():null==this.initializePib_?
(this.isInitialized_=!0,b.resolve()):this.initializePib_.initializePromise_(a)};var c=a.Name,pa=a.PibKey,I=a.ValidationError,Wa=a.ConfigNameRelation,Xa=a.NdnRegexTopMatcher,ra=a.ValidatorConfigError,Ab=function(){};q.ConfigChecker=Ab;Ab.prototype.check=function(a,b,c,g){return a?2>b.size()?!1:this.checkNames(b.getPrefix(-2),c,g):this.checkNames(b,c,g)};Ab.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <checker.type>"));if("customized"==b.toLowerCase())return Ab.createCustomizedChecker_(a);
if("hierarchical"==b.toLowerCase())return Ab.createHierarchicalChecker_(a);throw new ra(Error("Unsupported checker type: "+b));};Ab.prototype.checkNames=function(a,b,c){throw Error("ConfigChecker.checkNames is not implemented");};Ab.createCustomizedChecker_=function(a){keyLocatorSection=a.get("key-locator");if(1!=keyLocatorSection.length)throw new ra(Error("Expected one <checker.key-locator>"));return Ab.createKeyLocatorChecker_(keyLocatorSection[0])};Ab.createHierarchicalChecker_=function(a){return new Ud("^(<>*)$",
"\\1","^(<>*)<KEY><>$","\\1",Wa.Relation.IS_PREFIX_OF)};Ab.createKeyLocatorChecker_=function(a){var b=a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <checker.key-locator.type>"));if("name"==b.toLowerCase())return Ab.createKeyLocatorNameChecker_(a);throw new ra(Error("Unsupported checker.key-locator.type: "+b));};Ab.createKeyLocatorNameChecker_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ra(Error("Expected <checker.key-locator.relation>"));
z=Wa.getNameRelationFromString(a);return new he(b,z)}b=a.getFirstValue("regex");if(null!=b)try{return new ie(b)}catch(g){throw new ra(Error("Invalid checker.key-locator.regex: "+b));}a=a.get("hyper-relation");if(1==a.length){var f=a[0];a=f.getFirstValue("k-regex");if(null==a)throw new ra(Error("Expected <checker.key-locator.hyper-relation.k-regex>"));b=f.getFirstValue("k-expand");if(null==b)throw new ra(Error("Expected <checker.key-locator.hyper-relation.k-expand"));z=f.getFirstValue("h-relation");
if(null==z)throw new ra(Error("Expected <checker.key-locator.hyper-relation.h-relation>"));var s=f.getFirstValue("p-regex");if(null==s)throw new ra(Error("Expected <checker.key-locator.hyper-relation.p-regex>"));f=f.getFirstValue("p-expand");if(null==f)throw new ra(Error("Expected <checker.key-locator.hyper-relation.p-expand>"));var z=Wa.getNameRelationFromString(z);try{return new Ud(s,f,a,b,z)}catch(l){throw new ra(Error("Invalid regex for key-locator.hyper-relation"));}}throw new ra(Error("Unsupported checker.key-locator"));
};var he=function(a,b){Ab.call(this);this.name_=a;this.relation_=b};he.prototype=new Ab;he.prototype.name="ConfigNameRelationChecker";q.ConfigNameRelationChecker=he;he.prototype.checkNames=function(a,b,c){var g=pa.extractIdentityFromKeyName(b),s=Wa.checkNameRelation(this.relation_,this.name_,g);s||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: name relation "+this.name_.toUri()+" "+Wa.toString(this.relation_)+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+", identity="+g.toUri()+
")"));return s};var ie=function(a){Ab.call(this);this.regex_=new Xa(a)};ie.prototype=new Ab;ie.prototype.name="ConfigRegexChecker";q.ConfigRegexChecker=ie;ie.prototype.checkNames=function(a,b,c){var g=this.regex_.match(b);g||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: regex "+this.regex_.getExpr()+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+")"));return g};var Ud=function(a,b,c,g,s){Ab.call(this);this.packetNameRegex_=new Xa(a);this.packetNameExpansion_=b;this.keyNameRegex_=
new Xa(c);this.keyNameExpansion_=g;this.hyperRelation_=s};Ud.prototype=new Ab;Ud.prototype.name="ConfigHyperRelationChecker";q.ConfigHyperRelationChecker=Ud;Ud.prototype.checkNames=function(a,b,c){if(!this.packetNameRegex_.match(a))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation packet name regex "+this.packetNameRegex_.getExpr())),!1;if(!this.keyNameRegex_.match(b))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+
" (KeyLocator="+b.toUri()+") does not match the hyper relation key name regex "+this.keyNameRegex_.getExpr())),!1;var g=this.keyNameRegex_.expand(this.keyNameExpansion_),s=this.packetNameRegex_.expand(this.packetNameExpansion_),f=Wa.checkNameRelation(this.hyperRelation_,g,s);f||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: hyper relation "+Wa.toString(this.hyperRelation_)+" packet name match="+s.toUri()+", key name match="+g.toUri()+" of packet "+a.toUri()+" (KeyLocator="+b.toUri()+") is invalid"));
return f};var c=a.Name,Wa=a.ConfigNameRelation,Xa=a.NdnRegexTopMatcher,ra=a.ValidatorConfigError,qc=function(){};q.ConfigFilter=qc;qc.prototype.match=function(a,b){return a?2>b.size()?!1:this.matchName(b.getPrefix(-2)):this.matchName(b)};qc.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <filter.type>"));if("name"==b.toLowerCase())return qc.createNameFilter_(a);throw new ra(Error("Unsupported filter.type: "+b));};qc.prototype.matchName=function(a){throw Error("ConfigFilter.matchName is not implemented");
};qc.createNameFilter_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ra(Error("Expected <filter.relation>"));a=Wa.getNameRelationFromString(a);return new je(b,a)}b=a.getFirstValue("regex");if(null!=b)try{return new ke(b)}catch(g){throw new ra(Error("Wrong filter.regex: "+b));}throw new ra(Error("Wrong filter(name) properties"));};var je=function(a,b){qc.call(this);this.name_=new c(a);this.relation_=b};je.prototype=new qc;je.prototype.name=
"ConfigRelationNameFilter";q.ConfigRelationNameFilter=je;je.prototype.matchName=function(a){return Wa.checkNameRelation(this.relation_,this.name_,a)};var ke=function(a){qc.call(this);this.regex_=new Xa(a)};ke.prototype=new qc;ke.prototype.name="ConfigRegexNameFilter";q.ConfigRegexNameFilter=ke;ke.prototype.matchName=function(a){return this.regex_.match(a)};ra=a.ValidatorConfigError;Wa=function(){};q.ConfigNameRelation=Wa;Wa.Relation=function(){};Wa.Relation.EQUAL=0;Wa.Relation.IS_PREFIX_OF=1;Wa.Relation.IS_STRICT_PREFIX_OF=
2;Wa.toString=function(a){return a==Wa.Relation.EQUAL?"equal":a==Wa.Relation.IS_PREFIX_OF?"is-prefix-of":a==Wa.Relation.IS_STRICT_PREFIX_OF?"is-strict-prefix-of":""};Wa.checkNameRelation=function(a,b,c){return a==Wa.Relation.EQUAL?b.equals(c):a==Wa.Relation.IS_PREFIX_OF?b.isPrefixOf(c):a==Wa.Relation.IS_STRICT_PREFIX_OF?b.isPrefixOf(c)&&b.size()<c.size():!1};Wa.getNameRelationFromString=function(a){if("equal"==a.toLowerCase())return Wa.Relation.EQUAL;if("is-prefix-of"==a.toLowerCase())return Wa.Relation.IS_PREFIX_OF;
if("is-strict-prefix-of"==a.toLowerCase())return Wa.Relation.IS_STRICT_PREFIX_OF;throw new ra(Error("Unsupported relation: "+a));};var Ab=a.ConfigChecker,qc=a.ConfigFilter,ra=a.ValidatorConfigError,g=a.Log.LOG,Fc=function(a,b){this.id_=a;this.isForInterest_=b;this.filters_=[];this.checkers_=[]};q.ConfigRule=Fc;Fc.prototype.getId=function(){return this.id_};Fc.prototype.getIsForInterest=function(){return this.isForInterest_};Fc.prototype.addFilter=function(a){this.filters_.push(a)};Fc.prototype.addChecker=
function(a){this.checkers_.push(a)};Fc.prototype.match=function(a,b){3<g&&console.log("Trying to match "+b.toUri());if(a!=this.isForInterest_)throw new ra(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));if(0==this.filters_.length)return!0;for(var c=!1,f=0;f<this.filters_.length&&!(c=c||this.filters_[f].match(a,b));++f);return c};Fc.prototype.check=function(a,b,c,f){3<g&&console.log("Trying to check "+b.toUri()+" with keyLocator "+
c.toUri());if(a!=this.isForInterest_)throw new ra(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));for(var s=!1,z=0;z<this.checkers_.length;++z){s=this.checkers_[z].check(a,b,c,f);if(!s)break;s=!0}return s};Fc.create=function(a){var b=a.getFirstValue("id");if(null==b)throw new ra(Error("Expecting <rule.id>"));var c=a.getFirstValue("for");if(null==c)throw new ra(Error("Expecting <rule.for> in rule: "+b));if("data"==c.toLowerCase())c=
!1;else if("interest"==c.toLowerCase())c=!0;else throw new ra(Error("Unrecognized <rule.for>: "+c+" in rule: "+b));for(var c=new Fc(b,c),g=a.get("filter"),s=0;s<g.length;++s)c.addFilter(qc.create(g[s]));a=a.get("checker");for(s=0;s<a.length;++s)c.addChecker(Ab.create(a[s]));if(0==a.length)throw new ra(Error("No <rule.checker> is specified in rule: "+b));return c};var Qb=a,p=a.Blob,M=a.CertificateV2,rc=function(a,b){this.certificates_=a;this.id_=b;this.anchorNameUris_={}};q.TrustAnchorGroup=rc;rc.prototype.getId=
function(){return this.id_};rc.prototype.size=function(){return Object.keys(this.anchorNameUris_).length};rc.prototype.refresh=function(){};rc.readCertificate=function(a){try{var b=Qb.readFileSync(a).toString(),c=new f(b,"base64"),g=new M;g.wireDecode(new p(c,!1));return g}catch(s){return null}};var b=a.SyncPromise,I=a.ValidationError,g=a.Log.LOG,Ra=a.VerificationHelpers,M=a.CertificateV2,Gb=function(){this.certificateChain_=[];this.seenCertificateNameUris_={};this.outcome_=this.hasOutcome_=!1};q.ValidationState=
Gb;Gb.prototype.hasOutcome=function(){return this.hasOutcome_};Gb.prototype.isOutcomeFailed=function(){return this.hasOutcome_&&!1==this.outcome_};Gb.prototype.isOutcomeSuccess=function(){return this.hasOutcome_&&!0==this.outcome_};Gb.prototype.fail=function(a){throw Error("ValidationState.fail is not implemented");};Gb.prototype.getDepth=function(){return this.certificateChain_.length};Gb.prototype.hasSeenCertificateName=function(a){a=a.toUri();if(void 0!==this.seenCertificateNameUris_[a])return!0;
this.seenCertificateNameUris_[a]=!0;return!1};Gb.prototype.addCertificate=function(a){this.certificateChain_.unshift(new M(a))};Gb.prototype.setOutcome=function(a){if(this.hasOutcome_)throw Error("The ValidationState already has an outcome");this.hasOutcome_=!0;this.outcome_=a};Gb.prototype.verifyOriginalPacketPromise_=function(a){return b.reject(Error("ValidationState.verifyOriginalPacketPromise_ is not implemented"))};Gb.prototype.bypassValidation_=function(){throw Error("ValidationState.bypassValidation_ is not implemented");
};Gb.prototype.verifyCertificateChainPromise_=function(a){var c=a,f=this,l=function(a){if(a>=f.certificateChain_.length)return b.resolve(c);var z=f.certificateChain_[a];return Ra.verifyDataSignaturePromise(z,c).then(function(m){if(m)3<g&&console.log("OK signature for certificate `"+z.getName().toUri()+"`"),c=z;else{for(f.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of certificate `"+z.getName().toUri()+"`"));f.certificateChain_.length>a;)f.certificateChain_.splice(a,1);return b.resolve(null)}++a;
return l(a)})};return l(0)};var c=a.Name,ha=a.Schedule,M=a.CertificateV2,g=a.Log.LOG,cc=function y(a){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE;this.maxLifetimeMilliseconds_=void 0==a?y.getDefaultLifetime():a;this.nowOffsetMilliseconds_=0};q.CertificateCacheV2=cc;cc.prototype.insert=function(a){var b=a.getValidityPeriod().getNotAfter(),c=(new Date).getTime()+this.nowOffsetMilliseconds_;if(b<c)3<g&&console.log("Not adding "+a.getName().toUri()+": already expired at "+ha.toIsoString(b));
else{b=Math.min(b,c+this.maxLifetimeMilliseconds_);b<this.nextRefreshTime_&&(this.nextRefreshTime_=b);3<g&&console.log("Adding "+a.getName().toUri()+", will remove in "+(b-c)/36E5+" hours");a=new M(a);var c=a.getName(),s=this.findFirstByName_(c);if(0>s)s=this.certificatesByName_.length;else if(this.certificatesByName_[s].name.equals(c)){this.certificatesByName_[s].certificate=a;this.certificatesByName_[s].removalTime=b;return}this.certificatesByName_.splice(s,0,{name:c,certificate:a,removalTime:b})}};
cc.prototype.find=function(a){if(a instanceof c){0<a.size()&&a.get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();var b=this.findFirstByName_(a);if(0>b)return null;b=this.certificatesByName_[b];return a.isPrefixOf(b.certificate.getName())?b.certificate:null}null!=a.getChildSelector()&&console.log("Certificate search using a ChildSelector is not supported. Searching as if this selector not specified");0<a.getName().size()&&
a.getName().get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();b=this.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.certificatesByName_.length;++b){var g=this.certificatesByName_[b].certificate;if(!a.getName().isPrefixOf(g.getName()))break;if(a.matchesData(g))return g}return null};cc.prototype.deleteCertificate=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(this.certificatesByName_[b].name.equals(a)){this.certificatesByName_.splice(b,
1);break}};cc.prototype.clear=function(){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE};cc.getDefaultLifetime=function(){return 36E5};cc.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};cc.prototype.findFirstByName_=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(0<=this.certificatesByName_[b].name.compare(a))return b;return-1};cc.prototype.refresh_=function(){var a=(new Date).getTime()+this.nowOffsetMilliseconds_;if(!(a<this.nextRefreshTime_)){for(var b=
Number.MAX_VALUE,c=this.certificatesByName_.length-1;0<=c;--c){var g=this.certificatesByName_[c];g.removalTime<=a?this.certificatesByName_.splice(c,1):b=Math.min(b,g.removalTime)}this.nextRefreshTime_=b}};var le=function(){};q.CertificateContainerInterface=le;le.prototype.add=function(a){throw Error("CertificateContainerInterface.add is unimplemented");};le.prototype.remove=function(a){throw Error("CertificateContainerInterface.remove is unimplemented");};var g=a.Log.LOG,sc=function(){this.certificateStorage_=
null};q.CertificateFetcher=sc;sc.prototype.setCertificateStorage=function(a){this.certificateStorage_=a};sc.prototype.fetch=function(a,b,c){if(null==this.certificateStorage_)throw Error("CertificateFetcher.fetch: You must first call setCertificateStorage");var s=this.certificateStorage_.getUnverifiedCertificateCache().find(a.interest_);if(null!=s)3<g&&console.log("Found certificate in **un**verified key cache "+s.getName().toUri()),c(s,b);else{var f=this;this.doFetch_(a,b,function(a,b){f.certificateStorage_.cacheUnverifiedCertificate(a);
c(a,b)})}};sc.prototype.doFetch_=function(a,b,c){throw Error("CertificateFetcher.doFetch_ is not implemented");};var g=a.Log.LOG,M=a.CertificateV2,I=a.ValidationError,sc=a.CertificateFetcher,Id=function(a){sc.call(this);this.face_=a};Id.prototype=new sc;Id.prototype.name="CertificateFetcherFromNetwork";q.CertificateFetcherFromNetwork=Id;Id.prototype.doFetch_=function(a,b,c){var s=this;try{s.face_.expressInterest(a.interest_,function(a,s){3<g&&console.log("Fetched certificate from network "+s.getName().toUri());
var f;try{f=new M(s)}catch(z){b.fail(new I(I.MALFORMED_CERTIFICATE,"Fetched a malformed certificate `"+s.getName().toUri()+"` ("+z+")"));return}try{c(f,b)}catch(l){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in continueValidation: "+l))}},function(f){3<g&&console.log("Timeout while fetching certificate "+a.interest_.getName().toUri()+", retrying");--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{s.fetch(a,b,c)}catch(z){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+z))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))},function(f,z){3<g&&console.log("NACK ("+z.getReason()+") while fetching certificate "+a.interest_.getName().toUri());--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{s.fetch(a,b,c)}catch(l){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+l))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))})}catch(f){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Error in expressInterest: "+f))}};var I=a.ValidationError,sc=a.CertificateFetcher,yd=function(){sc.call(this)};yd.prototype=new sc;yd.prototype.name="CertificateFetcherOffline";q.CertificateFetcherOffline=yd;yd.prototype.doFetch_=function(a,b,c){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate "+a.interest_.getName().toUri()+" in offline mode"))};var E=a.Interest,zd=function(a){void 0!=a?(this.interest_=new E(a),this.nRetriesLeft_=3):(this.interest_=new E,this.nRetriesLeft_=0)};
q.CertificateRequest=zd;var c=a.Name,hb=a.TrustAnchorContainer,M=a.CertificateV2,cc=a.CertificateCacheV2,Ub=function(){this.trustAnchors_=new hb;this.verifiedCertificateCache_=new cc(36E5);this.unverifiedCertificateCache_=new cc(3E5)};q.CertificateStorage=Ub;Ub.prototype.findTrustedCertificate=function(a){var b=this.trustAnchors_.find(a);return null!=b?b:b=this.verifiedCertificateCache_.find(a)};Ub.prototype.isCertificateKnown=function(a){return null!=this.trustAnchors_.find(a)||null!=this.verifiedCertificateCache_.find(a)||
null!=this.unverifiedCertificateCache_.find(a)};Ub.prototype.cacheUnverifiedCertificate=function(a){this.unverifiedCertificateCache_.insert(a)};Ub.prototype.getTrustAnchors=function(){return this.trustAnchors_};Ub.prototype.getVerifiedCertificateCache=function(){return this.verifiedCertificateCache_};Ub.prototype.getUnverifiedCertificateCache=function(){return this.unverifiedCertificateCache_};Ub.prototype.loadAnchor=function(a,b,c,g){this.trustAnchors_.insert(a,b,c,g)};Ub.prototype.resetAnchors=
function(){this.trustAnchors_.clear()};Ub.prototype.cacheVerifiedCertificate=function(a){this.verifiedCertificateCache_.insert(a)};Ub.prototype.resetVerifiedCertificates=function(){this.verifiedCertificateCache_.clear()};Ub.prototype.setCacheNowOffsetMilliseconds_=function(a){this.verifiedCertificateCache_.setNowOffsetMilliseconds_(a);this.unverifiedCertificateCache_.setNowOffsetMilliseconds_(a)};c=a.Name;R=a.Data;V=a.KeyLocator;ta=a.KeyLocatorType;Ia=a.Sha256WithRsaSignature;Va=a.Sha256WithEcdsaSignature;
Ca=a.ContentType;r=a.WireFormat;ha=a.Schedule;Da=a.ValidityPeriod;dc=a.InvalidArgumentException;M=function(a){void 0!=a?(R.call(this,a),this.checkFormat_()):(R.call(this),this.getMetaInfo().setType(Ca.KEY))};M.prototype=new R;M.prototype.name="CertificateV2";q.CertificateV2=M;M.Error=function(a){if(a)return a.__proto__=M.Error.prototype,a};M.Error.prototype=Error();M.Error.prototype.name="CertificateV2Error";M.prototype.checkFormat_=function(){if(!M.isValidName(this.getName()))throw new M.Error(Error("The Data Name does not follow the certificate naming convention"));
if(this.getMetaInfo().getType()!=Ca.KEY)throw new M.Error(Error("The Data ContentType is not KEY"));if(0>this.getMetaInfo().getFreshnessPeriod())throw new M.Error(Error("The Data FreshnessPeriod is not set"));if(0==this.getContent().size())throw new M.Error(Error("The Data Content is empty"));};M.prototype.getKeyName=function(){return this.getName().getPrefix(M.KEY_ID_OFFSET+1)};M.prototype.getIdentity=function(){return this.getName().getPrefix(M.KEY_COMPONENT_OFFSET)};M.prototype.getKeyId=function(){return this.getName().get(M.KEY_ID_OFFSET)};
M.prototype.getIssuerId=function(){return this.getName().get(M.ISSUER_ID_OFFSET)};M.prototype.getPublicKey=function(){if(0==this.getContent().size())throw new M.Error(Error("The public key is not set (the Data content is empty)"));return this.getContent()};M.prototype.getValidityPeriod=function(){if(!Da.canGetFromSignature(this.getSignature()))throw new dc(Error("The SignatureInfo does not have a ValidityPeriod"));return Da.getFromSignature(this.getSignature())};M.prototype.isValid=function(a){return this.getValidityPeriod().isValid(a)};
M.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();R.prototype.wireDecode.call(this,a,b);this.checkFormat_()};M.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";a+="  NotBefore: "+ha.toIsoString(this.getValidityPeriod().getNotBefore())+"\n";a+="  NotAfter: "+ha.toIsoString(this.getValidityPeriod().getNotAfter())+"\n";a+="Public key bits:\n";try{for(var b=this.getPublicKey().buf().toString("base64"),c=0;c<b.length;c+=64)a+=
b.substr(c,64)+"\n"}catch(g){}a+="Signature Information:\n";a+="  Signature Type: ";a=this.getSignature()instanceof Va?a+"SignatureSha256WithEcdsa\n":this.getSignature()instanceof Ia?a+"SignatureSha256WithRsa\n":a+"<unknown>\n";V.canGetFromSignature(this.getSignature())&&(a+="  Key Locator: ",b=V.getFromSignature(this.getSignature()),b.getType()==ta.KEYNAME?(b.getKeyName().equals(this.getKeyName())&&(a+="Self-Signed "),a+="Name="+b.getKeyName().toUri()+"\n"):a+="<no KeyLocator key name>\n");return a};
M.isValidName=function(a){return a.size()>=M.MIN_CERT_NAME_LENGTH&&a.get(M.KEY_COMPONENT_OFFSET).equals(M.KEY_COMPONENT)};M.extractIdentityFromCertName=function(a){if(!M.isValidName(a))throw new dc(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(M.KEY_COMPONENT_OFFSET)};M.extractKeyNameFromCertName=function(a){if(!M.isValidName(a))throw new dc(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(M.KEY_ID_OFFSET+
1)};M.VERSION_OFFSET=-1;M.ISSUER_ID_OFFSET=-2;M.KEY_ID_OFFSET=-3;M.KEY_COMPONENT_OFFSET=-4;M.MIN_CERT_NAME_LENGTH=4;M.MIN_KEY_NAME_LENGTH=2;M.KEY_COMPONENT=new c.Component("KEY");var b=a.SyncPromise,R=a.Data,g=a.Log.LOG,I=a.ValidationError,Gb=a.ValidationState,Ra=a.VerificationHelpers,P=a.NdnCommon,kd=function(a,b,c){Gb.call(this);this.data_=new R(a);this.successCallback_=b;this.failureCallback_=c;if(null==this.successCallback_)throw Error("The successCallback is null");if(null==this.failureCallback_)throw Error("The failureCallback is null");
};kd.prototype=new Gb;kd.prototype.name="DataValidationState";q.DataValidationState=kd;kd.prototype.fail=function(a){3<g&&console.log(""+a);try{this.failureCallback_(this.data_,a)}catch(b){console.log("Error in failureCallback: "+P.getErrorWithStackTrace(b))}this.setOutcome(!1)};kd.prototype.getOriginalData=function(){return this.data_};kd.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Ra.verifyDataSignaturePromise(this.data_,a).then(function(a){if(a){3<g&&console.log("OK signature for data `"+
c.data_.getName().toUri()+"`");try{c.successCallback_(c.data_)}catch(s){console.log("Error in successCallback: "+P.getErrorWithStackTrace(s))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of data `"+c.data_.getName().toUri()+"`"));return b.resolve()})};kd.prototype.bypassValidation_=function(){3<g&&console.log("Signature verification bypassed for data `"+this.data_.getName().toUri()+"`");try{this.successCallback_(this.data_)}catch(a){console.log("Error in successCallback: "+
P.getErrorWithStackTrace(a))}this.setOutcome(!0)};var ge=Qb=a,rc=a.TrustAnchorGroup,c=a.Name,g=a.Log.LOG,Jd=function(a,b,c,s,f){rc.call(this,a,b);this.isDirectory_=f;this.path_=c;this.refreshPeriod_=s;this.expireTime_=0;if(0>=s)throw Error("Refresh period for the dynamic group must be positive");0<g&&console.log("Create a dynamic trust anchor group "+b+" for file/dir "+c+" with refresh time "+s);this.refresh()};Jd.prototype=new rc;Jd.prototype.name="DynamicTrustAnchorGroup";q.DynamicTrustAnchorGroup=
Jd;Jd.prototype.refresh=function(){var a=(new Date).getTime();if(!(this.expireTime_>a)){this.expireTime_=a+this.refreshPeriod_;0<g&&console.log("Reloading the dynamic trust anchor group");var a={},b;for(b in this.anchorNameUris_)a[b]=!0;if(this.isDirectory_){var f;try{f=Qb.readdirSync(this.path_)}catch(s){throw Error("Cannot list files in directory "+this.path_);}for(var z=0;z<f.length;++z)this.loadCertificate_(ge.join(this.path_,f[z]),a)}else this.loadCertificate_(this.path_,a);for(b in a)delete this.anchorNameUris_[b],
this.certificates_.remove(new c(b))}};Jd.prototype.loadCertificate_=function(a,b){var c=rc.readCertificate(a);if(null!=c){var g=c.getName().toUri();this.anchorNameUris_[g]?delete b[g]:(this.anchorNameUris_[g]=!0,this.certificates_.add(c))}};var b=a.SyncPromise,E=a.Interest,g=a.Log.LOG,I=a.ValidationError,Gb=a.ValidationState,Ra=a.VerificationHelpers,P=a.NdnCommon,Tc=function(a,b,c){Gb.call(this);this.interest_=new E(a);this.successCallbacks_=[b];this.failureCallback_=c;if(null==b)throw Error("The successCallback is null");
if(null==this.failureCallback_)throw Error("The failureCallback is null");};Tc.prototype=new Gb;Tc.prototype.name="InterestValidationState";q.InterestValidationState=Tc;Tc.prototype.fail=function(a){3<g&&console.log(""+a);try{this.failureCallback_(this.interest_,a)}catch(b){console.log("Error in failureCallback: "+P.getErrorWithStackTrace(b))}this.setOutcome(!1)};Tc.prototype.getOriginalInterest=function(){return this.interest_};Tc.prototype.addSuccessCallback=function(a){this.successCallbacks_.push(a)};
Tc.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Ra.verifyInterestSignaturePromise(this.interest_,a).then(function(a){if(a){3<g&&console.log("OK signature for interest `"+c.interest_.getName().toUri()+"`");for(a=0;a<c.successCallbacks_.length;++a)try{c.successCallbacks_[a](c.interest_)}catch(s){console.log("Error in successCallback: "+P.getErrorWithStackTrace(s))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of interest `"+c.interest_.getName().toUri()+
"`"));return b.resolve()})};Tc.prototype.bypassValidation_=function(){3<g&&console.log("Signature verification bypassed for interest `"+this.interest_.getName().toUri()+"`");for(var a=0;a<this.successCallbacks_.length;++a)try{this.successCallbacks_[a](this.interest_)}catch(b){console.log("Error in successCallback: "+P.getErrorWithStackTrace(b))}this.setOutcome(!0)};var rc=a.TrustAnchorGroup,Ad=function(a,b){rc.call(this,a,b)};Ad.prototype=new rc;Ad.prototype.name="StaticTrustAnchorGroup";q.StaticTrustAnchorGroup=
Ad;Ad.prototype.add=function(a){var b=a.getName().toUri();this.anchorNameUris_[b]||(this.anchorNameUris_[b]=!0,this.certificates_.add(a))};Ad.prototype.remove=function(a){delete this.anchorNameUris_[a.toUri()];this.certificates_.remove(a)};c=a.Name;Ad=a.StaticTrustAnchorGroup;Jd=a.DynamicTrustAnchorGroup;M=a.CertificateV2;le=a.CertificateContainerInterface;hb=function u(){this.groups_={};this.anchors_=new u.AnchorContainer_};q.TrustAnchorContainer=hb;hb.Error=function(a){if(a)return a.__proto__=hb.Error.prototype,
a};hb.Error.prototype=Error();hb.Error.prototype.name="TrustAnchorContainerError";hb.prototype.insert=function(a,b,c,g){if(b instanceof M){c=this.groups_[a];void 0===c&&(c=new Ad(this.anchors_,a),this.groups_[a]=c);if(!(c instanceof Ad))throw new hb.Error(Error("Cannot add a static anchor to the non-static anchor group "+a));c.add(b)}else{null==g&&(g=!1);if(void 0!==this.groups_[a])throw new hb.Error(Error("Cannot create the dynamic group, because group "+a+" already exists"));this.groups_[a]=new Jd(this.anchors_,
a,b,c,g)}};hb.prototype.clear=function(){this.groups_={};this.anchors_.clear()};hb.prototype.find=function(a){if(a instanceof c){this.refresh_();var b=this.anchors_.findFirstByName_(a);if(0>b)return null;var g=this.anchors_.anchorsByName_[b].certificate;return a.isPrefixOf(g.getName())?g:null}this.refresh_();b=this.anchors_.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.anchors_.anchorsByName_.length;++b){g=this.anchors_.anchorsByName_[b].certificate;if(!a.getName().isPrefixOf(g.getName()))break;
if(a.matchesData(g))return g}return null};hb.prototype.getGroup=function(a){var b=this.groups_[a];if(void 0===b)throw new hb.Error(Error("Trust anchor group "+a+" does not exist"));return b};hb.prototype.size=function(){return this.anchors_.size()};hb.AnchorContainer_=function(){this.anchorsByName_=[]};hb.AnchorContainer_.prototype=new le;hb.AnchorContainer_.prototype.name="TrustAnchorContainerAnchorContainer";hb.AnchorContainer_.prototype.add=function(a){a=new M(a);var b=a.getName(),c=this.findFirstByName_(b);
if(0>c)c=this.anchorsByName_.length;else if(this.anchorsByName_[c].name.equals(b)){this.anchorsByName_[c].certificate=a;return}this.anchorsByName_.splice(c,0,{name:b,certificate:a})};hb.AnchorContainer_.prototype.remove=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(this.anchorsByName_[b].name.equals(a)){this.anchorsByName_.splice(b,1);break}};hb.AnchorContainer_.prototype.clear=function(){this.anchorsByName_=[]};hb.AnchorContainer_.prototype.size=function(){return this.anchorsByName_.length};
hb.AnchorContainer_.prototype.findFirstByName_=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(0<=this.anchorsByName_[b].name.compare(a))return b;return-1};hb.prototype.refresh_=function(){for(var a in this.groups_)this.groups_[a].refresh()};I=function(a,b){this.code_=a;this.info_=void 0!=b?b:""};q.ValidationError=I;I.NO_ERROR=0;I.INVALID_SIGNATURE=1;I.NO_SIGNATURE=2;I.CANNOT_RETRIEVE_CERTIFICATE=3;I.EXPIRED_CERTIFICATE=4;I.LOOP_DETECTED=5;I.MALFORMED_CERTIFICATE=6;I.EXCEEDED_DEPTH_LIMIT=
7;I.INVALID_KEY_LOCATOR=8;I.POLICY_ERROR=9;I.IMPLEMENTATION_ERROR=255;I.USER_MIN=256;I.prototype.getCode=function(){return this.code_};I.prototype.getInfo=function(){return this.info_};I.prototype.toString=function(){var a;a=this.code_===I.NO_ERROR?"No error":this.code_===I.INVALID_SIGNATURE?"Invalid signature":this.code_===I.NO_SIGNATURE?"Missing signature":this.code_===I.CANNOT_RETRIEVE_CERTIFICATE?"Cannot retrieve certificate":this.code_===I.EXPIRED_CERTIFICATE?"Certificate expired":this.code_===
I.LOOP_DETECTED?"Loop detected in certification chain":this.code_===I.MALFORMED_CERTIFICATE?"Malformed certificate":this.code_===I.EXCEEDED_DEPTH_LIMIT?"Exceeded validation depth limit":this.code_===I.INVALID_KEY_LOCATOR?"Key locator violates validation policy":this.code_===I.POLICY_ERROR?"Validation policy error":this.code_===I.IMPLEMENTATION_ERROR?"Internal implementation error":this.code_>=I.USER_MIN?"Custom error code "+this.code_:"Unrecognized error code "+this.code_;0<this.info_.length&&(a+=
" ("+this.info_+")");return a};var c=a.Name,R=a.Data,V=a.KeyLocator,ta=a.KeyLocatorType,r=a.WireFormat,I=a.ValidationError,M=a.CertificateV2,Sa=function(){this.innerPolicy_=this.validator_=null};q.ValidationPolicy=Sa;Sa.prototype.setInnerPolicy=function(a){if(null==a)throw Error("The innerPolicy argument cannot be null");null!=this.validator_&&a.setValidator(this.validator_);null==this.innerPolicy_?this.innerPolicy_=a:this.innerPolicy_.setInnerPolicy(a)};Sa.prototype.hasInnerPolicy=function(){return null!=
this.innerPolicy_};Sa.prototype.getInnerPolicy=function(){return this.innerPolicy_};Sa.prototype.setValidator=function(a){this.validator_=a;null!=this.innerPolicy_&&this.innerPolicy_.setValidator(a)};Sa.prototype.checkPolicy=function(a,b,c){throw Error("ValidationPolicy.checkPolicy is not implemented");};Sa.prototype.checkCertificatePolicy=function(a,b,c){this.checkPolicy(a,b,c)};Sa.getKeyLocatorName=function(a,b){if(a instanceof R)return Sa.getKeyLocatorNameFromSignature_(a.getSignature(),b);if(2>
a.getName().size())return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: name too short")),new c;var g;try{g=r.getDefaultWireFormat().decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf())}catch(f){return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: "+f)),new c}return Sa.getKeyLocatorNameFromSignature_(g,b)};Sa.getKeyLocatorNameFromSignature_=function(a,b){if(!V.canGetFromSignature(a))return b.fail(new I(I.INVALID_KEY_LOCATOR,
"KeyLocator is missing")),new c;var g=V.getFromSignature(a);return g.getType()!=ta.KEYNAME?(b.fail(new I(I.INVALID_KEY_LOCATOR,"KeyLocator type is not Name")),new c):g.getKeyName()};var Sa=a.ValidationPolicy,Kd=function(){Sa.call(this)};Kd.prototype=new Sa;Kd.prototype.name="ValidationPolicyAcceptAll";q.ValidationPolicyAcceptAll=Kd;Kd.prototype.checkPolicy=function(a,b,c){c(null,b)};var c=a.Name,R=a.Data,oc=a.CommandInterestSigner,I=a.ValidationError,Sa=a.ValidationPolicy,Vb=function Ya(a,b){Sa.call(this);
this.options_=void 0==b?new Ya.Options:new Ya.Options(b);this.container_=[];this.nowOffsetMilliseconds_=0;if(null==a)throw Error("inner policy is missing");this.setInnerPolicy(a);0>this.options_.gracePeriod_&&(this.options_.gracePeriod_=0)};Vb.prototype=new Sa;Vb.prototype.name="ValidationPolicyCommandInterest";q.ValidationPolicyCommandInterest=Vb;Vb.Options=function(a,b,c){a instanceof Vb.Options?(this.gracePeriod_=a.gracePeriod_,this.maxRecords_=a.maxRecords_,this.recordLifetime_=a.recordLifetime_):
(void 0==a&&(a=12E4),void 0==b&&(b=1E3),void 0==c&&(c=36E5),this.gracePeriod_=a,this.maxRecords_=b,this.recordLifetime_=c)};Vb.prototype.checkPolicy=function(a,b,c){if(a instanceof R)this.getInnerPolicy().checkPolicy(a,b,c);else{var g=[null],f=[0];Vb.parseCommandInterest_(a,b,g,f)&&this.checkTimestamp_(b,g[0],f[0])&&this.getInnerPolicy().checkPolicy(a,b,c)}};Vb.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Vb.LastTimestampRecord=function(a,b,g){this.keyName_=new c(a);
this.timestamp_=b;this.lastRefreshed_=g};Vb.prototype.cleanUp_=function(){for(var a=(new Date).getTime()+this.nowOffsetMilliseconds_-this.options_.recordLifetime_;0<this.container_.length&&this.container_[0].lastRefreshed_<=a||0<=this.options_.maxRecords_&&this.container_.length>this.options_.maxRecords_;)this.container_.shift()};Vb.parseCommandInterest_=function(a,b,g,f){g[0]=new c;f[0]=0;var l=a.getName();if(l.size()<oc.MINIMUM_SIZE)return b.fail(new I(I.POLICY_ERROR,"Command interest name `"+a.getName().toUri()+
"` is too short")),!1;f[0]=l.get(oc.POS_TIMESTAMP).toNumber();g[0]=Sa.getKeyLocatorName(a,b);return b.isOutcomeFailed()?!1:!0};Vb.prototype.checkTimestamp_=function(a,b,c){this.cleanUp_();var g=(new Date).getTime()+this.nowOffsetMilliseconds_;if(c<g-this.options_.gracePeriod_||c>g+this.options_.gracePeriod_)return a.fail(new I(I.POLICY_ERROR,"Timestamp is outside the grace period for key "+b.toUri())),!1;g=this.findByKeyName_(b);if(0<=g&&c<=this.container_[g].timestamp_)return a.fail(new I(I.POLICY_ERROR,
"Timestamp is reordered for key "+b.toUri())),!1;var f=this;a.addSuccessCallback(function(a){f.insertNewRecord_(a,b,c)});return!0};Vb.prototype.insertNewRecord_=function(a,b,c){a=(new Date).getTime()+this.nowOffsetMilliseconds_;c=new Vb.LastTimestampRecord(b,c,a);b=this.findByKeyName_(b);0<=b&&this.container_.splice(b,1);this.container_.push(c)};Vb.prototype.findByKeyName_=function(a){for(var b=0;b<this.container_.length;++b)if(this.container_[b].keyName_.equals(a))return b;return-1};var kc=a.BoostInfoParser,
zd=a.CertificateRequest,ra=a.ValidatorConfigError,I=a.ValidationError,M=a.CertificateV2,Fc=a.ConfigRule,R=a.Data,E=a.Interest,Sa=a.ValidationPolicy,hc=function(){Sa.call(this);this.isConfigured_=this.shouldBypass_=!1;this.dataRules_=[];this.interestRules_=[]};hc.prototype=new Sa;hc.prototype.name="ValidationPolicyConfig";q.ValidationPolicyConfig=hc;hc.prototype.load=function(a,b){if("string"===typeof a&&void 0==b){var c=new kc;c.read(a);this.load(c.getRoot(),a)}else if("string"===typeof a&&"string"===
typeof b)c=new kc,c.read(a,b),this.load(c.getRoot(),b);else{this.isConfigured_&&(this.shouldBypass_=!1,this.dataRules_=[],this.interestRules_=[],this.validator_.resetAnchors(),this.validator_.resetVerifiedCertificates());this.isConfigured_=!0;c=a.get("validator");if(1!=c.length)throw new ra(Error("ValidationPolicyConfig: Expected one validator section"));for(var g=c[0],f=g.get("rule"),c=0;c<f.length;++c){var l=Fc.create(f[c]);l.getIsForInterest()?this.interestRules_.push(l):this.dataRules_.push(l)}g=
g.get("trust-anchor");for(c=0;c<g.length;++c)this.processConfigTrustAnchor_(g[c],b)}};hc.prototype.checkPolicy=function(a,b,c){if(this.hasInnerPolicy())throw new ra(Error("ValidationPolicyConfig must be a terminal inner policy"));if(this.shouldBypass_)c(null,b);else{var g=Sa.getKeyLocatorName(a,b);if(!b.isOutcomeFailed())if(a instanceof R){for(var f=0;f<this.dataRules_.length;++f){var l=this.dataRules_[f];if(l.match(!1,a.getName())){l.check(!1,a.getName(),g,b)&&c(new zd(new E(g)),b);return}}b.fail(new I(I.POLICY_ERROR,
"No rule matched for data `"+a.getName().toUri()+"`"))}else{for(f=0;f<this.interestRules_.length;++f)if(l=this.interestRules_[f],l.match(!0,a.getName())){l.check(!0,a.getName(),g,b)&&c(new zd(new E(g)),b);return}b.fail(new I(I.POLICY_ERROR,"No rule matched for interest `"+a.getName().toUri()+"`"))}}};hc.prototype.processConfigTrustAnchor_=function(a,b){var c=a.getFirstValue("type");if(null==c)throw new ra(Error("Expected <trust-anchor.type>"));if("file"==c.toLowerCase()){var g=a.getFirstValue("file-name");
if(null==g)throw new ra(Error("Expected <trust-anchor.file-name>"));c=hc.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,c,!1)}else if("base64"==c.toLowerCase()){c=a.getFirstValue("base64-string");if(null==c)throw new ra(Error("Expected <trust-anchor.base64-string>"));c=new f(c,"base64");g=new M;try{g.wireDecode(c)}catch(l){throw new ra(Error("Cannot decode certificate from base64-string: "+l));}this.validator_.loadAnchor("",g)}else if("dir"==c.toLowerCase()){g=a.getFirstValue("dir");if(null==
g)throw new ra(Error("Expected <trust-anchor.dir>"));c=hc.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,c,!0)}else if("any"==c.toLowerCase())this.shouldBypass_=!0;else throw new ra(Error("Unsupported trust-anchor.type"));};hc.getRefreshPeriod_=function(a){var b=a.getFirstValue("refresh");if(null==b)return 1E14;a=0;b=b.match(/(\d+)([hms])/);null!=b&&(a=parseInt(b[1]),"s"!=b[2]&&(a*=60,"m"!=b[2]&&(a*=60)));return 0==a?36E5:1E3*a};var E=a.Interest,zd=a.CertificateRequest,pa=a.PibKey,I=a.ValidationError,
Sa=a.ValidationPolicy,me=function(a){Sa.call(this);this.pib_=a};me.prototype=new Sa;me.prototype.name="ValidationPolicyFromPib";q.ValidationPolicyFromPib=me;me.prototype.checkPolicy=function(a,b,c){a=Sa.getKeyLocatorName(a,b);b.isOutcomeFailed()||this.checkPolicyHelper_(a,b,c)};me.prototype.checkPolicyHelper_=function(a,b,c){var g;try{g=this.pib_.getIdentity(pa.extractIdentityFromKeyName(a))}catch(f){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB identity for key "+a.toUri()+": "+
f));return}var l;try{l=g.getKey(a)}catch(m){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB key "+a.toUri()+": "+m));return}var p;try{p=l.getDefaultCertificate()}catch(r){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the default certificate for key "+a.toUri()+": "+r));return}this.validator_.resetAnchors();this.validator_.loadAnchor("",p);c(new zd(new E(a)),b);this.validator_.resetAnchors()};var zd=a.CertificateRequest,I=a.ValidationError,E=a.Interest,Sa=a.ValidationPolicy,
Ae=function(){Sa.call(this)};Ae.prototype=new Sa;Ae.prototype.name="ValidationPolicySimpleHierarchy";q.ValidationPolicySimpleHierarchy=Ae;Ae.prototype.checkPolicy=function(a,b,c){keyLocatorName=Sa.getKeyLocatorName(a,b);b.isOutcomeFailed()||(keyLocatorName.getPrefix(-2).isPrefixOf(a.getName())?c(new zd(new E(keyLocatorName)),b):b.fail(new I(I.INVALID_KEY_LOCATOR,"Signing policy violation for "+a.getName().toUri()+" by "+keyLocatorName.toUri())))};var b=a.SyncPromise,I=a.ValidationError,yd=a.CertificateFetcherOffline,
Ub=a.CertificateStorage,kd=a.DataValidationState,Tc=a.InterestValidationState,R=a.Data,g=a.Log.LOG,Mb=function(a,b){Ub.call(this);void 0==b&&(b=new yd);this.policy_=a;this.certificateFetcher_=b;this.maxDepth_=25;if(null==this.policy_)throw Error("The policy is null");if(null==this.certificateFetcher_)throw Error("The certificateFetcher is null");this.policy_.setValidator(this);this.certificateFetcher_.setCertificateStorage(this)};Mb.prototype=new Ub;Mb.prototype.name="Validator";q.Validator=Mb;Mb.prototype.getPolicy=
function(){return this.policy_};Mb.prototype.getFetcher=function(){return this.certificateFetcher_};Mb.prototype.setMaxDepth=function(a){this.maxDepth_=a};Mb.prototype.getMaxDepth=function(){return this.maxDepth_};Mb.prototype.validate=function(a,b,c){a instanceof R?(b=new kd(a,b,c),3<g&&console.log("Start validating data "+a.getName().toUri())):(b=new Tc(a,b,c),3<g&&console.log("Start validating interest "+a.getName().toUri()));var f=this;this.policy_.checkPolicy(a,b,function(a,b){null==a?b.bypassValidation_():
f.requestCertificate_(a,b)})};Mb.prototype.validateCertificate_=function(a,b){3<g&&console.log("Start validating certificate "+a.getName().toUri());if(a.isValid()){var c=this;this.policy_.checkCertificatePolicy(a,b,function(b,g){null==b?g.fail(new I(I.POLICY_ERROR,"Validation policy is not allowed to designate `"+a.getName().toUri()+"` as a trust anchor")):(g.addCertificate(a),c.requestCertificate_(b,g))})}else b.fail(new I(I.EXPIRED_CERTIFICATE,"Retrieved certificate is not yet valid or expired `"+
a.getName().toUri()+"`"))};Mb.prototype.requestCertificate_=function(a,c){if(c.getDepth()>=this.maxDepth_)c.fail(new I(I.EXCEEDED_DEPTH_LIMIT,"Exceeded validation depth limit"));else if(c.hasSeenCertificateName(a.interest_.getName()))c.fail(new I(I.LOOP_DETECTED,"Validation loop detected for certificate `"+a.interest_.getName().toUri()+"`"));else{3<g&&console.log("Retrieving "+a.interest_.getName().toUri());var f=this,l=this.findTrustedCertificate(a.interest_);null!=l?(3<g&&console.log("Found trusted certificate "+
l.getName().toUri()),c.verifyCertificateChainPromise_(l).then(function(a){return null!=a?c.verifyOriginalPacketPromise_(a):b.resolve()}).then(function(){for(var a=0;a<c.certificateChain_.length;++a)f.cacheVerifiedCertificate(c.certificateChain_[a])})):this.certificateFetcher_.fetch(a,c,function(a,b){f.validateCertificate_(a,b)})}};var W=Qb=ge=a,g=a.Log.LOG,c=a.Name,E=a.Interest,R=a.Data,Ca=a.ContentType,p=a.Blob,vd=a.ConfigFile,r=a.WireFormat,v=a.SecurityException,ac=a.RsaKeyParams,Ie=a.BasicIdentityStorage,
Ma=a.IdentityCertificate,bb=a.Tpm,Be=a.TpmBackEndFile,bc=a.TpmBackEndMemory,b=a.SyncPromise,P=a.NdnCommon,ja=a.IdentityManager,M=a.CertificateV2,Y=a.SigningInfo,Ia=a.Sha256WithRsaSignature,Va=a.Sha256WithEcdsaSignature,wb=a.DigestSha256Signature,ob=a.HmacWithSha256Signature,V=a.KeyLocator,ta=a.KeyLocatorType,Fa=a.DigestAlgorithm,da=a.KeyType,Da=a.ValidityPeriod,Pc=a.SafeBag,Ra=a.VerificationHelpers,za=a.PublicKey,fc=a.NoVerifyPolicyManager,C=function s(a,b,c){this.identityManager_=null;this.policyManager_=
new fc;this.tpm_=this.pib_=this.face_=null;if(void 0==a){if(!vd)throw new v(Error("KeyChain: The default KeyChain constructor is not supported in the browser"));Qb.existsSync(Ie.getDefaultDatabaseFilePath())&&!Qb.existsSync(ne.getDefaultDatabaseFilePath())?(a=new ja,b=new fc):b=a=""}if("string"===typeof a){void 0==c&&(c=!1);this.isSecurityV1_=!1;var g=[null],f=[null];s.parseAndCheckPibLocator_(a,g,f);this.pib_=s.createPib_(g[0]+":"+f[0]);this.tpm_=new bb("","",null);this.pib_.initializeTpm_=this.tpm_;
this.pib_.initializePibLocator_=a;this.pib_.initializeTpmLocator_=b;this.pib_.initializeAllowReset_=c;this.tpm_.initializePib_=this.pib_}else a instanceof aa?(void 0==c&&(c=new fc),this.isSecurityV1_=!1,this.policyManager_=c,this.pib_=new ka("","",a),this.tpm_=new bb("","",b)):(c=b,this.isSecurityV1_=!0,void 0==a&&(a=new ja),void 0==c&&(c=new fc),this.identityManager_=a,this.policyManager_=c)};q.KeyChain=C;C.Error=function(a){if(a)return a.__proto__=C.Error.prototype,a};C.Error.prototype=Error();
C.Error.prototype.name="KeyChainError";C.prototype.getPib=function(){if(this.isSecurityV1_)throw new v(Error("getPib is not supported for security v1"));return this.pib_};C.prototype.getTpm=function(){if(this.isSecurityV1_)throw new v(Error("getTpm is not supported for security v1"));return this.tpm_};C.prototype.getIsSecurityV1=function(){return this.isSecurityV1_};C.prototype.createIdentityV2Promise=function(a,c,f){f="boolean"===typeof c?c:f;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());
var l=this,m;return this.pib_.addIdentityPromise_(a,f).then(function(a){m=a;return m.getDefaultKeyPromise(f).catch(function(a){return a instanceof ka.Error?l.createKeyPromise(m,c,f):b.reject(a)})}).then(function(a){return a.getDefaultCertificatePromise(f).catch(function(c){return c instanceof ka.Error?(2<g&&console.log("No default cert for "+a.getName()+", requesting self-signing"),l.selfSignPromise(a,f)):b.reject(c)})}).then(function(){return b.resolve(m)})};C.prototype.createIdentityV2=function(a,
c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.createIdentityV2Promise(a,"function"!==typeof c&&c?c:void 0,!g))};C.prototype.deleteIdentityPromise=function(a,g){function f(a){return a>=p.length?b.resolve():l.tpm_.deleteKeyPromise_(p[a],g).then(function(){return f(a+1)})}var l=this;if(a instanceof c)return this.isSecurityV1_?b.reject(new C.Error(Error("deleteIdentityPromise is not supported for security v1. Use deleteIdentity."))):this.pib_.getIdentityPromise(a,
g).then(function(a){return l.deleteIdentityPromise(a,g)}).catch(function(a){return b.resolve()});var m=a.getName(),p=a.getKeys_().getKeyNames();return f(0).then(function(){return l.pib_.removeIdentityPromise_(m,g)})};C.prototype.deleteIdentity=function(a,g,f){if(a instanceof c&&this.isSecurityV1_)this.identityManager_.deleteIdentity(a,g,f);else return b.complete(g,f,this.deleteIdentityPromise(a,!g))};C.prototype.setDefaultIdentityPromise=function(a,b){return this.pib_.setDefaultIdentityPromise_(a.getName(),
b)};C.prototype.setDefaultIdentity=function(a,c,g){return b.complete(c,g,this.setDefaultIdentityPromise(a,!c))};C.prototype.createKeyPromise=function(a,c,f){f="boolean"===typeof c?c:f;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());var l=this,m,p;return this.tpm_.createKeyPromise_(a.getName(),c,f).then(function(a){p=a;return l.tpm_.getPublicKeyPromise(p,f)}).then(function(b){return a.addKeyPromise_(b.buf(),p,f)}).then(function(a){m=a;2<g&&console.log("Requesting self-signing for newly created key "+
m.getName().toUri());return l.selfSignPromise(m,f)}).then(function(){return b.resolve(m)})};C.prototype.createKey=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.createKeyPromise(a,"function"!==typeof c&&c?c:void 0,!g))};C.prototype.deleteKeyPromise=function(a,c,g){var f=c.getName();if(!a.getName().equals(c.getIdentityName()))return b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+f.toUri()+"`"));var l=this;return a.removeKeyPromise_(f,
g).then(function(){return l.tpm_.deleteKeyPromise_(f,g)})};C.prototype.deleteKey=function(a,c,g,f){return b.complete(g,f,this.deleteKeyPromise(a,c,!g))};C.prototype.setDefaultKeyPromise=function(a,c,g){return a.getName().equals(c.getIdentityName())?a.setDefaultKeyPromise_(c.getName(),g):b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+c.getName().toUri()+"`"))};C.prototype.setDefaultKey=function(a,c,g,f){return b.complete(g,f,this.setDefaultKeyPromise(a,c,!g))};C.prototype.addCertificatePromise=
function(a,c,g){return a.getName().equals(c.getKeyName())&&c.getContent().equals(a.getPublicKey())?a.addCertificatePromise_(c,g):b.reject(Error("Key `"+a.getName().toUri()+"` does not match certificate `"+c.getKeyName().toUri()+"`"))};C.prototype.addCertificate=function(a,c,g,f){return b.complete(g,f,this.addCertificatePromise(a,c,!g))};C.prototype.deleteCertificatePromise=function(a,c,g){return M.isValidName(c)?a.removeCertificatePromise_(c,g):b.reject(Error("Wrong certificate name `"+c.toUri()+
"`"))};C.prototype.deleteCertificate=function(a,c,g,f){return b.complete(g,f,this.deleteCertificatePromise(a,c,!g))};C.prototype.setDefaultCertificatePromise=function(a,b,c){return this.addCertificatePromise(a,b,c).then(function(){return a.setDefaultCertificatePromise_(b.getName(),c)})};C.prototype.setDefaultCertificate=function(a,c,g,f){return b.complete(g,f,this.setDefaultCertificatePromise(a,c,!g))};C.prototype.signPromise=function(a,g,f,l){var m=g,p=f,q=l;g=m instanceof Y||m instanceof c?m:void 0;
f=m instanceof r?m:p instanceof r?p:void 0;l="boolean"===typeof m?m:"boolean"===typeof p?p:"boolean"===typeof q?q:!1;void 0==f&&(f=r.getDefaultWireFormat());var F=this;return b.resolve().then(function(){if(void 0==g){if(F.isSecurityV1_)return F.prepareDefaultCertificateNamePromise_(l).then(function(a){g=a;return b.resolve()});g=C.defaultSigningInfo_}return b.resolve()}).then(function(){if(g instanceof c){var m=g;if(F.isSecurityV1_)return a instanceof E?F.identityManager_.signInterestByCertificatePromise(a,
m,f,l):a instanceof R?F.identityManager_.signByCertificatePromise(a,m,f,l):F.identityManager_.signByCertificatePromise(a,m,l);if(!(a instanceof E||a instanceof R))return b.reject(new v(Error("sign(buffer, certificateName) is not supported for security v2. Use sign with SigningInfo.")));var Cb=new Y;Cb.setSigningCertificateName(m);return F.signPromise(a,Cb,f,l).catch(function(a){return b.reject(new v(Error("Error in sign: "+a)))})}var kb=g;if(a instanceof R){var p=[null];return F.prepareSignatureInfoPromise_(kb,
p,l).then(function(b){a.setSignature(b);b=a.wireEncode(f);return F.signBufferPromise_(b.signedBuf(),p[0],kb.getDigestAlgorithm(),l)}).then(function(c){a.getSignature().setSignature(c);a.wireEncode(f);return b.resolve(a)})}if(a instanceof E){var r,p=[null];return F.prepareSignatureInfoPromise_(kb,p,l).then(function(b){r=b;a.getName().append(f.encodeSignatureInfo(r));a.getName().append(new c.Component);b=a.wireEncode(f);return F.signBufferPromise_(b.signedBuf(),p[0],kb.getDigestAlgorithm(),l)}).then(function(c){r.setSignature(c);
a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(r)));return b.resolve(a)})}p=[null];return F.prepareSignatureInfoPromise_(kb,p,l).then(function(b){return F.signBufferPromise_(a,p[0],kb.getDigestAlgorithm(),l)})})};C.prototype.sign=function(a,g,f,l,m){var p=g,q=f,F=l;g=p instanceof Y||p instanceof c?p:null;f=p instanceof r?p:q instanceof r?q:null;"function"===typeof p?(l=p,m=q):"function"===typeof q?(l=q,m=F):"function"===typeof F?l=F:m=l=null;return b.complete(l,m,this.signPromise(a,
g,f,!l))};C.prototype.selfSignPromise=function(a,g,f){var l=g,m=f;g=l instanceof r?l:void 0;f="boolean"===typeof l?l:"boolean"===typeof m?m:!1;void 0==g&&(g=r.getDefaultWireFormat());var p=new M,l=(new Date).getTime(),m=new c(a.getName());m.append("self").appendVersion(l);p.setName(m);p.getMetaInfo().setType(Ca.KEY);p.getMetaInfo().setFreshnessPeriod(36E5);p.setContent(a.getPublicKey());signingInfo=new Y(a);signingInfo.setValidityPeriod(new Da(l,l+63072E7));return this.signPromise(p,signingInfo,g,
f).then(function(){return a.addCertificatePromise_(p,f).catch(function(a){return b.reject(new C.Error(Error("Error encoding certificate: "+a)))})}).then(function(){return b.resolve(p)})};C.prototype.selfSign=function(a,c,g,f){"function"===typeof c&&(f=g,g=c,c=void 0);void 0==c&&(c=r.getDefaultWireFormat());return b.complete(g,f,this.selfSignPromise(a,c,!g))};C.prototype.exportSafeBagPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);var f=a.getKeyName(),l=this;return b.resolve().then(function(){return l.tpm_.exportPrivateKeyPromise_(f,
c,g)},function(a){return b.reject(new C.Error(Error("Failed to export private key `"+f.toUri()+"`: "+a)))}).then(function(c){return b.resolve(new Pc(a,c))})};C.prototype.exportSafeBag=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.exportSafeBagPromise(a,"function"===typeof c?null:c,!g))};C.prototype.importSafeBagPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);var f;try{f=new M(a.getCertificate())}catch(l){return b.reject(Error("Error reading CertificateV2: "+
l))}var m=f.getIdentity(),r=f.getKeyName(),q=f.getPublicKey(),F=new p([1,2,3,4]),Cb,kb=this;return b.resolve().then(function(){return kb.tpm_.hasKeyPromise(r,g)}).then(function(a){return a?b.reject(new C.Error(Error("Private key `"+r.toUri()+"` already exists"))):kb.pib_.getIdentityPromise(m,g).then(function(a){return a.getKeyPromise(r,g)}).then(function(){return b.reject(new C.Error(Error("Public key `"+r.toUri()+"` already exists")))},function(a){return b.resolve()})}).then(function(){return kb.tpm_.importPrivateKeyPromise_(r,
a.getPrivateKeyBag().buf(),c,g).catch(function(a){return b.reject(new C.Error(Error("Failed to import private key `"+r.toUri()+"`: "+a)))})}).then(function(){return kb.tpm_.signPromise(F.buf(),r,Fa.SHA256,g).then(function(a){Cb=a;return b.resolve()},function(a){return kb.tpm_.deleteKeyPromise_(r,g).then(function(){return b.reject(new C.Error(Error("Invalid private key `"+r.toUri()+"`")))})})}).then(function(){var a;try{a=new za(q)}catch(c){return kb.tpm_.deleteKeyPromise_(r,g).then(function(){return b.reject(new C.Error(Error("Error decoding public key "+
c)))})}return Ra.verifySignaturePromise(F,Cb,a,g)}).then(function(a){return a?kb.pib_.addIdentityPromise_(m,g):kb.tpm_.deleteKeyPromise_(r,g).then(function(){return b.reject(new C.Error(Error("Certificate `"+f.getName().toUri()+"` and private key `"+r.toUri()+"` do not match")))})}).then(function(a){return a.addKeyPromise_(f.getPublicKey().buf(),r,g)}).then(function(a){return a.addCertificatePromise_(f,g)})};C.prototype.importSafeBag=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?
c:g;return b.complete(g,f,this.importSafeBagPromise(a,"function"===typeof c?null:c,!g))};C.registerPibBackend=function(a,b){C.getPibFactories_()[a]=b};C.registerTpmBackend=function(a,b){C.getTpmFactories_()[a]=b};C.prototype.createIdentityAndCertificate=function(a,b,c,g){g="function"===typeof b?c:g;c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:C.getDefaultKeyParams();return this.identityManager_.createIdentityAndCertificate(a,b,c,g)};C.prototype.createIdentity=function(a,b){return Ma.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,
b))};C.prototype.getDefaultIdentity=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultIdentity(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(a){return b.resolve(a.getName())}))};C.prototype.getDefaultCertificateName=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultCertificateName(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(b){return b.getDefaultKeyPromise(!a)}).then(function(b){return b.getDefaultCertificatePromise(!a)}).then(function(a){return b.resolve(a.getName())}))};
C.prototype.generateRSAKeyPair=function(a,b,c){if(!this.isSecurityV1_)throw new v(Error("generateRSAKeyPair is not supported for security v2. Use createIdentityV2."));(c="boolean"===typeof b?b:c)||(c=2048);return this.identityManager_.generateRSAKeyPair(a,"boolean"===typeof b?b:!1,c)};C.prototype.setDefaultKeyForIdentity=function(a,c,g,f){return this.isSecurityV1_?this.identityManager_.setDefaultKeyForIdentity(a,c,g,f):b.complete(g,f,b.reject(new v(Error("setDefaultKeyForIdentity is not supported for security v2. Use getPib() methods."))))};
C.prototype.generateRSAKeyPairAsDefault=function(a,b,c){if(!this.isSecurityV1_)throw new v(Error("generateRSAKeyPairAsDefault is not supported for security v2. Use createIdentityV2."));return this.identityManager_.generateRSAKeyPairAsDefault(a,b,c)};C.prototype.createSigningRequest=function(a){return this.isSecurityV1_?this.identityManager_.getPublicKey(a).getKeyDer():b.complete(null,null,this.pib_.getIdentityPromise(pa.extractIdentityFromKeyName(a,!0)).then(function(b){return b.getKeyPromise(a,!0)}).then(function(a){return b.resolve(a.getPublicKey())}))};
C.prototype.installIdentityCertificate=function(a,c,g){if(!this.isSecurityV1_)return b.complete(c,g,b.reject(new v(Error("installIdentityCertificate is not supported for security v2. Use getPib() methods."))));this.identityManager_.addCertificate(a,c,g)};C.prototype.setDefaultCertificateForKey=function(a,c,g){if(!this.isSecurityV1_)return b.complete(c,g,b.reject(new v(Error("setDefaultCertificateForKey is not supported for security v2. Use getPib() methods."))));this.identityManager_.setDefaultCertificateForKey(a,
c,g)};C.prototype.getCertificate=function(a,c,g){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,g):b.complete(c,g,b.reject(new v(Error("getCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.getIdentityCertificate=function(a,c,g){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,g):b.complete(c,g,b.reject(new v(Error("getIdentityCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.revokeKey=function(a){};
C.prototype.revokeCertificate=function(a){};C.prototype.getIdentityManager=function(){if(!this.isSecurityV1_)throw new v(Error("getIdentityManager is not supported for security v2"));return this.identityManager_};C.prototype.getPolicyManager=function(){return this.policyManager_};C.prototype.signByIdentity=function(a,g,f,l,m){m="function"===typeof f?l:m;l="function"===typeof f?f:l;f="function"!==typeof f&&f?f:r.getDefaultWireFormat();if(!this.isSecurityV1_)return b.complete(l,m,b.reject(new v(Error("signByIdentity(buffer, identityName) is not supported for security v2. Use sign with SigningInfo."))));
var p=!l,q=this;null==g&&(g=new c);if(a instanceof R){var F=b.resolve().then(function(){if(0==g.size()){var b=q.policyManager_.inferSigningIdentity(a.getName());return 0==b.size()?q.identityManager_.getDefaultCertificateNamePromise(p):q.identityManager_.getDefaultCertificateNameForIdentityPromise(b,p)}return q.identityManager_.getDefaultCertificateNameForIdentityPromise(g,p)}).then(function(b){if(0==b.size())throw new v(Error("No qualified certificate name found!"));if(!q.policyManager_.checkSigningPolicy(a.getName(),
b))throw new v(Error("Signing Cert name does not comply with signing policy"));return q.identityManager_.signByCertificatePromise(a,b,f,p)});return b.complete(l,m,F)}return b.complete(l,m,this.identityManager_.getDefaultCertificateNameForIdentityPromise(g,p).then(function(b){if(0==b.size())throw new v(Error("No qualified certificate name found!"));return q.identityManager_.signByCertificatePromise(a,b,f,p)}))};C.prototype.signWithSha256=function(a,b){if(this.isSecurityV1_)a instanceof E?this.identityManager_.signInterestWithSha256(a,
b):this.identityManager_.signWithSha256(a,b);else{var c=Y();c.setSha256Signing();this.sign(a,c,b)}};C.prototype.verifyData=function(a,b,c,g){null==g&&(g=0);if(this.policyManager_.requireVerify(a)){var f=this.policyManager_.checkVerificationPolicy(a,g,b,c);if(null!=f){var l=this;this.face_.expressInterest(f.interest,function(a,b){l.onCertificateData(a,b,f)},function(b){l.onCertificateInterestTimeout(b,f.retry,c,a,f)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(m){console.log("Error in onVerified: "+
P.getErrorWithStackTrace(m))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(p){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(p))}};C.prototype.verifyInterest=function(a,b,c,g,f){null==g&&(g=0);f=f||r.getDefaultWireFormat();if(this.policyManager_.requireVerify(a)){var l=this.policyManager_.checkVerificationPolicy(a,g,b,c,f);if(null!=l){var m=this;this.face_.expressInterest(l.interest,function(a,b){m.onCertificateData(a,b,l)},function(b){m.onCertificateInterestTimeout(b,
l.retry,c,a,l)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(p){console.log("Error in onVerified: "+P.getErrorWithStackTrace(p))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(q){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(q))}};C.prototype.setFace=function(a){this.face_=a};C.signWithHmacWithSha256=function(a,b,g,f){g instanceof r&&(f=g,g=void 0);f=f||r.getDefaultWireFormat();if(a instanceof R)g=a.wireEncode(f),b=
W.createHmac("sha256",b.buf()),b.update(g.signedBuf()),a.getSignature().setSignature(new p(b.digest(),!1));else if(a instanceof E){if(null==g)throw new v(Error("signWithHmacWithSha256: keyName is required to sign an Interest"));var l=new ob;l.getKeyLocator().setType(ta.KEYNAME);l.getKeyLocator().setKeyName(g);a.getName().append(f.encodeSignatureInfo(l));a.getName().append(new c.Component);g=a.wireEncode(f);b=W.createHmac("sha256",b.buf());b.update(g.signedBuf());l.setSignature(new p(b.digest(),!1));
a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(l)))}else throw new v(Error("signWithHmacWithSha256: Unrecognized target type"));};C.verifyDataWithHmacWithSha256=function(a,b,c){c=c||r.getDefaultWireFormat();c=a.wireEncode(c);b=W.createHmac("sha256",b.buf());b.update(c.signedBuf());return(new p(b.digest(),!1)).equals(a.getSignature().getSignature())};C.verifyInterestWithHmacWithSha256=function(a,b,c){c=c||r.getDefaultWireFormat();var g=c.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf());a=a.wireEncode(c);b=W.createHmac("sha256",b.buf());b.update(a.signedBuf());return(new p(b.digest(),!1)).equals(g.getSignature())};C.getDefaultKeyParams=function(){return C.defaultKeyParams_};C.DEFAULT_KEY_PARAMS=new ac;C.getPibFactories_=function(){null==C.pibFactories_&&(C.pibFactories_={},ne&&(C.pibFactories_[ne.getScheme()]=function(a){return new ne(a)}),C.pibFactories_[wa.getScheme()]=function(a){return new wa});return C.pibFactories_};C.getTpmFactories_=
function(){null==C.tpmFactories_&&(C.tpmFactories_={},Be&&(C.tpmFactories_[Be.getScheme()]=function(a){return new Be(a)}),C.tpmFactories_[bc.getScheme()]=function(a){return new bc});return C.tpmFactories_};C.parseLocatorUri_=function(a,b,c){iColon=a.indexOf(":");0<=iColon?(b[0]=a.substring(0,iColon),c[0]=a.substring(iColon+1)):(b[0]=a,c[0]="")};C.parseAndCheckPibLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultPibScheme_());if(void 0==C.getPibFactories_()[b[0]])throw new C.Error(Error("PIB scheme `"+
b[0]+"` is not supported"));};C.parseAndCheckTpmLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultTpmScheme_());if(void 0==C.getTpmFactories_()[b[0]])throw new C.Error(Error("TPM scheme `"+b[0]+"` is not supported"));};C.getDefaultPibScheme_=function(){return ne.getScheme()};C.getDefaultTpmScheme_=function(){if("darwin"===process.platform)throw new C.Error(Error("TpmBackEndOsx is not implemented. You must use tpm-file."));return Be.getScheme()};C.createPib_=function(a){var b=
[null],c=[null];C.parseAndCheckPibLocator_(a,b,c);a=C.getPibFactories_()[b[0]];return new ka(b[0],c[0],a(c[0]))};C.setUpTpm_=function(a,b){var c=[null],g=[null];C.parseAndCheckTpmLocator_(b,c,g);var f=C.getTpmFactories_()[c[0]];a.scheme_=c[0];a.location_=g[0];a.backEnd_=f(g[0])};C.getDefaultPibLocator_=function(a){if(null!=C.defaultPibLocator_)return C.defaultPibLocator_;var b=process.env.NDN_CLIENT_PIB;C.defaultPibLocator_=void 0!=b&&""!=b?b:a.get("pib",C.getDefaultPibScheme_()+":");return C.defaultPibLocator_};
C.getDefaultTpmLocator_=function(a){if(null!=C.defaultTpmLocator_)return C.defaultTpmLocator_;var b=process.env.NDN_CLIENT_TPM;C.defaultTpmLocator_=void 0!=b&&""!=b?b:a.get("tpm",C.getDefaultTpmScheme_()+":");return C.defaultTpmLocator_};C.prototype.prepareSignatureInfoPromise_=function(a,c,g){var f=null,l=null,m=this;return b.resolve().then(function(){if(a.getSignerType()==Y.SignerType.NULL)return m.pib_.getDefaultIdentityPromise(g).then(function(a){f=a;return b.resolve(null)},function(a){c[0]=Y.getDigestSha256Identity();
return b.resolve(new wb)});if(a.getSignerType()==Y.SignerType.ID)return f=a.getPibIdentity(),null==f?m.pib_.getIdentityPromise(a.getSignerName(),g).then(function(a){f=a;return b.resolve(null)},function(c){return b.reject(new Uc(Error("Signing identity `"+a.getSignerName().toUri()+"` does not exist")))}):b.resolve(null);if(a.getSignerType()==Y.SignerType.KEY)return l=a.getPibKey(),null==l?(p=pa.extractIdentityFromKeyName(a.getSignerName()),m.pib_.getIdentityPromise(p,g).then(function(c){return c.getKeyPromise(a.getSignerName(),
g).then(function(a){l=a;f=null;return b.resolve(null)})},function(c){return b.reject(new Uc(Error("Signing key `"+a.getSignerName().toUri()+"` does not exist")))})):b.resolve(null);if(a.getSignerType()==Y.SignerType.CERT){var p=M.extractIdentityFromCertName(a.getSignerName());return m.pib_.getIdentityPromise(p,g).then(function(c){f=c;return f.getKeyPromise(M.extractKeyNameFromCertName(a.getSignerName()),g).then(function(a){l=a;return b.resolve(null)})},function(c){return b.reject(new Uc(Error("Signing certificate `"+
a.getSignerName().toUri()+"` does not exist")))})}return a.getSignerType()==Y.SignerType.SHA256?(c[0]=Y.getDigestSha256Identity(),b.resolve(new wb)):b.reject(new Uc(Error("Unrecognized signer type")))}).then(function(m){return null!=m?b.resolve(m):null==f&&null==l?b.reject(new Uc(Error("Cannot determine signing parameters"))):b.resolve().then(function(){return null!=f&&null==l?f.getDefaultKeyPromise(g).then(function(a){l=a;return b.resolve(null)},function(a){return b.reject(new Uc(Error("Signing identity `"+
f.getName().toUri()+"` does not have default certificate")))}):b.resolve()}).then(function(){if(l.getKeyType()==da.RSA&&a.getDigestAlgorithm()==Fa.SHA256)signatureInfo=new Ia;else if(l.getKeyType()==da.EC&&a.getDigestAlgorithm()==Fa.SHA256)signatureInfo=new Va;else return b.reject(new C.Error(Error("Unsupported key type")));a.getValidityPeriod().hasPeriod()&&Da.canGetFromSignature(signatureInfo)&&Da.getFromSignature(signatureInfo).setPeriod(a.getValidityPeriod().getNotBefore(),a.getValidityPeriod().getNotAfter());
var g=V.getFromSignature(signatureInfo);g.setType(ta.KEYNAME);g.setKeyName(l.getName());c[0]=l.getName();return b.resolve(signatureInfo)})})};C.prototype.signBufferPromise_=function(a,c,g,f){return c.equals(Y.getDigestSha256Identity())?(c=W.createHash("sha256"),c.update(a),b.resolve(new p(c.digest(),!1))):this.tpm_.signPromise(a,c,g,f)};C.prototype.onCertificateData=function(a,b,c){this.verifyData(b,c.onVerified,c.onValidationFailed,c.stepCount)};C.prototype.onCertificateInterestTimeout=function(a,
b,c,g,f){if(0<b){var l=this;this.face_.expressInterest(a,function(a,b){l.onCertificateData(a,b,f)},function(a){l.onCertificateInterestTimeout(a,b-1,c,g,f)})}else try{c(g,"The retry count is zero after timeout for fetching "+a.getName().toUri())}catch(m){console.log("Error in onValidationFailed: "+P.getErrorWithStackTrace(m))}};C.prototype.prepareDefaultCertificateNamePromise_=function(a){var c,g=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(f){c=f;return null!=c?
b.resolve():g.setDefaultCertificatePromise_(a).then(function(){return g.identityManager_.getDefaultCertificatePromise(a)}).then(function(a){c=a;return b.resolve()})}).then(function(){return b.resolve(c.getName())})};C.prototype.setDefaultCertificatePromise_=function(a){var g=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(f){if(null!=f)return b.resolve();var l;return g.identityManager_.getDefaultIdentityPromise(a).then(function(a){l=a;return b.resolve()},function(a){randomComponent=
W.randomBytes(4);l=(new c).append("tmp-identity").append(new p(randomComponent,!1));return b.resolve()}).then(function(){return g.identityManager_.createIdentityAndCertificatePromise(l,C.getDefaultKeyParams(),a)}).then(function(){return g.identityManager_.setDefaultIdentityPromise(l,a)})})};C.defaultPibLocator_=null;C.defaultTpmLocator_=null;C.pibFactories_=null;C.tpmFactories_=null;C.defaultSigningInfo_=new Y;C.defaultKeyParams_=new ac;var Uc=function(a){C.Error.call(this,a)};Uc.prototype=new C.Error;
Uc.prototype.name="InvalidSigningInfoError";q.InvalidSigningInfoError=Uc;q.InvalidSigningInfoError=Uc;fe=function(a){C.Error.call(this,a)};fe.prototype=new C.Error;fe.prototype.name="LocatorMismatchError";q.LocatorMismatchError=fe;var ka=a.Pib,aa=a.PibImpl,pa=a.PibKey,ne=a.PibSqlite3,wa=a.PibMemory,ra=function z(a){if(a)return a.__proto__=z.prototype,a};ra.prototype=Error();ra.prototype.name="ValidatorConfigError";q.ValidatorConfigError=ra;var sc=a.CertificateFetcher,hc=a.ValidationPolicyConfig,Id=
a.CertificateFetcherFromNetwork,Mb=a.Validator,Ce=function(a){a instanceof sc?Mb.call(this,new hc,a):Mb.call(this,new hc,new Id(a));this.policyConfig_=this.getPolicy()};Ce.prototype=new Mb(new hc,new Id(null));Ce.prototype.name="ValidatorConfig";q.ValidatorConfig=Ce;Ce.prototype.load=function(a,b){this.policyConfig_.load(a,b)};var Kd=a.ValidationPolicyAcceptAll,yd=a.CertificateFetcherOffline,Mb=a.Validator,Me=function(){Mb.call(this,new Kd,new yd)};Me.prototype=new Mb(new Kd);Me.prototype.name="ValidatorNull";
q.ValidatorNull=Me;var c=a.Name,L=a.DataUtils,p=a.Blob,Ua=function Re(a){this.values=[];if("object"===typeof a&&a instanceof Re)this.values=a.values.slice(0);else if(a)for(var b=this.changeCount=0;b<a.length;++b)a[b]==Re.ANY?this.appendAny():this.appendComponent(a[b]);this.changeCount=0};q.Exclude=Ua;Ua.ANY="*";Ua.prototype.size=function(){return this.values.length};Ua.prototype.get=function(a){return this.values[a]};Ua.prototype.appendAny=function(){this.values.push(Ua.ANY);++this.changeCount;return this};
Ua.prototype.appendComponent=function(a){this.values.push(new c.Component(a));++this.changeCount;return this};Ua.prototype.clear=function(){++this.changeCount;this.values=[]};Ua.prototype.toUri=function(){if(null==this.values||0==this.values.length)return"";for(var a="",b=0;b<this.values.length;++b)0<b&&(a+=","),a=this.values[b]==Ua.ANY?a+"*":a+this.values[b].toEscapedString();return a};Ua.prototype.matches=function(a){"object"==typeof a&&a instanceof c.Component||(a=new c.Component(a));for(var b=
0;b<this.values.length;++b)if(this.values[b]==Ua.ANY){var g=null;0<b&&(g=this.values[b-1]);var f,l=null;for(f=b+1;f<this.values.length;++f)if(this.values[f]!=Ua.ANY){l=this.values[f];break}if(null!=l){if(null!=g){if(0<a.compare(g)&&0>a.compare(l))return!0}else if(0>a.compare(l))return!0;b=f-1}else if(null!=g){if(0<a.compare(g))return!0}else return!0}else if(a.equals(this.values[b]))return!0;return!1};Ua.compareComponents=function(a,b){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());
"object"==typeof b&&b instanceof c.Component&&(b=b.getValue().buf());return c.Component.compareBuffers(a,b)};Ua.prototype.getChangeCount=function(){return this.changeCount};var W=a,p=a.Blob,$a=a.SignedBlob,oa=a.ChangeCounter,c=a.Name,Ua=a.Exclude,Db=a.Link,V=a.KeyLocator,db=a.DelegationSet,Bc=a.IncomingFaceId,r=a.WireFormat,E=function ga(a,b,g,f,l,Cb,kb,m,r,q){if(null!=f)throw Error("Interest constructor: PublisherPublicKeyDigest support has been removed.");if(null!=kb)throw Error("Interest constructor: answerOriginKind support has been removed. Use setMustBeFresh().");
if(null!=m)throw Error("Interest constructor: scope support has been removed.");if(null!=q)throw Error("Interest constructor: nonce support in the constructor has been removed.");null!=b&&console.log("Interest constructor: The minSuffixComponents param is deprecated. Use setMinSuffixComponents().");null!=g&&console.log("Interest constructor: The maxSuffixComponents param is deprecated. Use setMaxSuffixComponents().");null!=l&&console.log("Interest constructor: The exclude param is deprecated. Use setExclude().");
null!=Cb&&console.log("Interest constructor: The childSelector param is deprecated. Use setChildSelector().");null!=r&&console.log("Interest constructor: The interestLifetimeMilliseconds param is deprecated. Use setInterestLifetimeMilliseconds().");"object"===typeof a&&a instanceof ga?(this.name_=new oa(new c(a.getName())),this.maxSuffixComponents_=a.maxSuffixComponents_,this.didSetCanBePrefix_=a.didSetCanBePrefix_,this.minSuffixComponents_=a.minSuffixComponents_,this.keyLocator_=new oa(new V(a.getKeyLocator())),
this.exclude_=new oa(new Ua(a.getExclude())),this.childSelector_=a.childSelector_,this.mustBeFresh_=a.mustBeFresh_,this.interestLifetimeMilliseconds_=a.interestLifetimeMilliseconds_,this.forwardingHint_=new oa(new db(a.getForwardingHint())),this.applicationParameters_=a.applicationParameters_,this.nonce_=a.nonce_,this.linkWireEncoding_=a.linkWireEncoding_,this.linkWireEncodingFormat_=a.linkWireEncodingFormat_,this.link_=new oa(null),null!=a.link_.get()&&this.link_.set(new Db(a.link_.get())),this.selectedDelegationIndex_=
a.selectedDelegationIndex_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_=new oa(new c(a)),this.maxSuffixComponents_=null!=g?g:ga.defaultCanBePrefix_?null:1,this.didSetCanBePrefix_=ga.didSetDefaultCanBePrefix_,this.minSuffixComponents_=b,this.keyLocator_=new oa(new V),this.exclude_=new oa("object"===typeof l&&l instanceof Ua?new Ua(l):new Ua),this.childSelector_=Cb,this.mustBeFresh_=!0,this.interestLifetimeMilliseconds_=
r,this.forwardingHint_=new oa(new db),this.applicationParameters_=new p,this.nonce_=new p,this.linkWireEncoding_=new p,this.linkWireEncodingFormat_=null,this.link_=new oa(null),this.selectedDelegationIndex_=null,this.defaultWireEncoding_=new $a,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=this.getNonceChangeCount_=0;this.lpPacket_=null};q.Interest=E;E.RECURSIVE_POSTFIX="*";E.CHILD_SELECTOR_LEFT=0;E.CHILD_SELECTOR_RIGHT=1;E.defaultCanBePrefix_=!0;
E.didSetDefaultCanBePrefix_=!1;E.getDefaultCanBePrefix=function(){return E.defaultCanBePrefix_};E.setDefaultCanBePrefix=function(a){E.defaultCanBePrefix_=a;E.didSetDefaultCanBePrefix_=!0};E.prototype.matchesName=function(a){return!this.getName().match(a)||null!=this.minSuffixComponents_&&!(a.size()+1-this.getName().size()>=this.minSuffixComponents_)||null!=this.maxSuffixComponents_&&!(a.size()+1-this.getName().size()<=this.maxSuffixComponents_)||null!=this.getExclude()&&a.size()>this.getName().size()&&
this.getExclude().matches(a.get(this.getName().size()))?!1:!0};E.prototype.matches_name=function(a){return this.matchesName(a)};E.prototype.matchesData=function(a,b){b=b||r.getDefaultWireFormat();var c=this.getName().size(),g=a.getName(),f=g.size()+1,l=null!=this.getMinSuffixComponents()?this.getMinSuffixComponents():0;if(!(c+l<=f&&(null==this.getMaxSuffixComponents()||c+this.getMaxSuffixComponents()>=f)))return!1;if(c===f)if(this.getName().get(-1).isImplicitSha256Digest()){if(!this.getName().equals(a.getFullName(b)))return!1}else return!1;
else if(!this.getName().isPrefixOf(g))return!1;if(0<this.getExclude().size()&&f>c)if(c==f-1){if(this.getExclude().matches(a.getFullName(b).get(c)))return!1}else if(this.getExclude().matches(g.get(c)))return!1;c=this.getKeyLocator();return!c.getType()||(g=a.getSignature(),V.canGetFromSignature(g)&&c.equals(V.getFromSignature(g)))?!0:!1};E.prototype.clone=function(){return new E(this)};E.prototype.getName=function(){return this.name_.get()};E.prototype.getMinSuffixComponents=function(){return this.minSuffixComponents_};
E.prototype.getMaxSuffixComponents=function(){return this.maxSuffixComponents_};E.prototype.getCanBePrefix=function(){return 1!=this.maxSuffixComponents_};E.prototype.getKeyLocator=function(){return this.keyLocator_.get()};E.prototype.getExclude=function(){return this.exclude_.get()};E.prototype.getChildSelector=function(){return this.childSelector_};E.prototype.getMustBeFresh=function(){return this.mustBeFresh_};E.prototype.getNonce=function(){this.getNonceChangeCount_!=this.getChangeCount()&&(this.nonce_=
new p,this.getNonceChangeCount_=this.getChangeCount());return this.nonce_};E.prototype.getForwardingHint=function(){return this.forwardingHint_.get()};E.prototype.hasApplicationParameters=function(){return 0<this.applicationParameters_.size()};E.prototype.hasParameters=function(){return this.hasApplicationParameters()};E.prototype.getApplicationParameters=function(){return this.applicationParameters_};E.prototype.getParameters=function(){return this.getApplicationParameters()};E.prototype.getNonceAsBuffer=
function(){return this.getNonce().buf()};E.prototype.hasLink=function(){return null!=this.link_.get()||!this.linkWireEncoding_.isNull()};E.prototype.getLink=function(){if(null!=this.link_.get())return this.link_.get();if(this.linkWireEncoding_.isNull())return null;var a=new Db;a.wireDecode(this.linkWireEncoding_,this.linkWireEncodingFormat_);this.link_.set(a);this.linkWireEncoding_=new p;this.linkWireEncodingFormat_=null;return a};E.prototype.getLinkWireEncoding=function(a){a=a||r.getDefaultWireFormat();
if(!this.linkWireEncoding_.isNull()&&this.linkWireEncodingFormat_==a)return this.linkWireEncoding_;var b=this.getLink();return null!=b?b.wireEncode(a):new p};E.prototype.getSelectedDelegationIndex=function(){return this.selectedDelegationIndex_};E.prototype.getInterestLifetimeMilliseconds=function(){return this.interestLifetimeMilliseconds_};E.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new $a,this.defaultWireEncodingFormat_=
null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};E.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};E.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:Bc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};E.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;return this};E.prototype.setMinSuffixComponents=
function(a){this.minSuffixComponents_=a;++this.changeCount_;return this};E.prototype.setMaxSuffixComponents=function(a){this.maxSuffixComponents_=a;++this.changeCount_;return this};E.prototype.setCanBePrefix=function(a){this.maxSuffixComponents_=a?null:1;this.didSetCanBePrefix_=!0;++this.changeCount_;return this};E.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof V?new V(a):new V);++this.changeCount_;return this};E.prototype.setExclude=function(a){this.exclude_.set("object"===
typeof a&&a instanceof Ua?new Ua(a):new Ua);++this.changeCount_;return this};E.prototype.setForwardingHint=function(a){this.forwardingHint_.set("object"===typeof a&&a instanceof db?new db(a):new db);++this.changeCount_;return this};E.prototype.setApplicationParameters=function(a){this.applicationParameters_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;return this};E.prototype.setParameters=function(a){return this.setApplicationParameters(a)};E.prototype.appendParametersDigestToName=
function(){if(!this.hasParameters())return this;var a=W.createHash("sha256");a.update(this.applicationParameters_.buf());this.getName().appendParametersSha256Digest(new p(a.digest(),!1));return this};E.prototype.setLinkWireEncoding=function(a,b){b=b||r.getDefaultWireFormat();this.linkWireEncoding_=a;this.linkWireEncodingFormat_=b;this.link_.set(null);++this.changeCount_;return this};E.prototype.unsetLink=function(){return this.setLinkWireEncoding(new p,null)};E.prototype.setSelectedDelegationIndex=
function(a){this.selectedDelegationIndex_=a;++this.changeCount_;return this};E.prototype.setChildSelector=function(a){this.childSelector_=a;++this.changeCount_;return this};E.prototype.setMustBeFresh=function(a){this.mustBeFresh_=a?!0:!1;++this.changeCount_;return this};E.prototype.setInterestLifetimeMilliseconds=function(a){this.interestLifetimeMilliseconds_=a;++this.changeCount_;return this};E.prototype.setNonce=function(a){this.nonce_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;
this.getNonceChangeCount_=this.getChangeCount();return this};E.prototype.toUri=function(){var a="";null!=this.minSuffixComponents_&&(a+="&ndn.MinSuffixComponents="+this.minSuffixComponents_);null!=this.maxSuffixComponents_&&(a+="&ndn.MaxSuffixComponents="+this.maxSuffixComponents_);null!=this.childSelector_&&(a+="&ndn.ChildSelector="+this.childSelector_);a+="&ndn.MustBeFresh="+(this.mustBeFresh_?1:0);null!=this.interestLifetimeMilliseconds_&&(a+="&ndn.InterestLifetime="+this.interestLifetimeMilliseconds_);
0<this.getNonce().size()&&(a+="&ndn.Nonce="+c.toEscapedString(this.getNonce().buf()));null!=this.getExclude()&&0<this.getExclude().size()&&(a+="&ndn.Exclude="+this.getExclude().toUri());var b=this.getName().toUri();""!=a&&(b+="?"+a.substr(1));return b};E.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeInterest(this),b=new $a(b.encoding,b.signedPortionBeginOffset,
b.signedPortionEndOffset);a==r.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,r.getDefaultWireFormat());return b};E.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof p?b.decodeInterest(this,a.buf(),!1):b.decodeInterest(this,a,!0);b==r.getDefaultWireFormat()?this.setDefaultWireEncoding(new $a(new p(a,!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),r.getDefaultWireFormat()):this.setDefaultWireEncoding(new $a,null)};E.prototype.refreshNonce=
function(){var a=this.getNonce();if(0!==a.size()){for(var b;b=new p(W.randomBytes(a.size()),!1),b.equals(a););this.nonce_=b;++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount()}};E.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};E.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.keyLocator_.checkChanged()||a,a=this.exclude_.checkChanged()||a;(a=this.forwardingHint_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};E.prototype.setDefaultWireEncoding=
function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(E.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(E.prototype,"minSuffixComponents",{get:function(){return this.getMinSuffixComponents()},set:function(a){this.setMinSuffixComponents(a)}});Object.defineProperty(E.prototype,"maxSuffixComponents",{get:function(){return this.getMaxSuffixComponents()},
set:function(a){this.setMaxSuffixComponents(a)}});Object.defineProperty(E.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(E.prototype,"exclude",{get:function(){return this.getExclude()},set:function(a){this.setExclude(a)}});Object.defineProperty(E.prototype,"childSelector",{get:function(){return this.getChildSelector()},set:function(a){this.setChildSelector(a)}});Object.defineProperty(E.prototype,"interestLifetime",
{get:function(){return this.getInterestLifetimeMilliseconds()},set:function(a){this.setInterestLifetimeMilliseconds(a)}});Object.defineProperty(E.prototype,"nonce",{get:function(){return this.getNonceAsBuffer()},set:function(a){this.setNonce(a)}});va=function df(a){"object"===typeof a&&a instanceof df?(this.childInherit=a.childInherit,this.capture=a.capture,this.origin=a.origin):(this.childInherit=!0,this.capture=!1,this.origin=null)};q.RegistrationOptions=va;va.NfdForwardingFlags_CHILD_INHERIT=1;
va.NfdForwardingFlags_CAPTURE=2;va.prototype.getNfdForwardingFlags=function(){var a=0;this.childInherit&&(a|=va.NfdForwardingFlags_CHILD_INHERIT);this.capture&&(a|=va.NfdForwardingFlags_CAPTURE);return a};va.prototype.setNfdForwardingFlags=function(a){this.childInherit=0!=(a&va.NfdForwardingFlags_CHILD_INHERIT);this.capture=0!=(a&va.NfdForwardingFlags_CAPTURE);return this};va.prototype.getChildInherit=function(){return this.childInherit};va.prototype.getCapture=function(){return this.capture};va.prototype.getOrigin=
function(){return this.origin};va.prototype.setChildInherit=function(a){this.childInherit=a;return this};va.prototype.setCapture=function(a){this.capture=a;return this};va.prototype.setOrigin=function(a){this.origin=a;return this};var va=a.RegistrationOptions,De=function(a){va.call(this,a)};De.prototype=new va;q.ForwardingFlags=De;De.NfdForwardingFlags_CHILD_INHERIT=va.NfdForwardingFlags_CHILD_INHERIT;De.NfdForwardingFlags_CAPTURE=va.NfdForwardingFlags_CAPTURE;var va=a.RegistrationOptions,c=a.Name,
r=a.WireFormat,p=a.Blob,Ta=function ef(a){"object"===typeof a&&a instanceof ef?(this.name=null==a.name?null:new c(a.name),this.faceId=a.faceId,this.uri=a.uri,this.localControlFeature=a.localControlFeature,this.origin=a.origin,this.cost=a.cost,this.flags=new va(a.flags),this.strategy=new c(a.strategy),this.expirationPeriod=a.expirationPeriod):(this.faceId=this.name=null,this.uri="",this.cost=this.origin=this.localControlFeature=null,this.flags=new va,this.strategy=new c,this.expirationPeriod=null)};
q.ControlParameters=Ta;Ta.prototype.clear=function(){this.faceId=this.name=null;this.uri="";this.cost=this.origin=this.localControlFeature=null;this.flags=new va;this.strategy=new c;this.expirationPeriod=null};Ta.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeControlParameters(this)};Ta.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlParameters(this,a.buf(),!1):b.decodeControlParameters(this,a,!0)};
Ta.prototype.getName=function(){return this.name};Ta.prototype.getFaceId=function(){return this.faceId};Ta.prototype.getUri=function(){return this.uri};Ta.prototype.getLocalControlFeature=function(){return this.localControlFeature};Ta.prototype.getOrigin=function(){return this.origin};Ta.prototype.getCost=function(){return this.cost};Ta.prototype.getForwardingFlags=function(){return this.flags};Ta.prototype.getStrategy=function(){return this.strategy};Ta.prototype.getExpirationPeriod=function(){return this.expirationPeriod};
Ta.prototype.setName=function(a){this.name="object"===typeof a&&a instanceof c?new c(a):null};Ta.prototype.setFaceId=function(a){this.faceId=a};Ta.prototype.setUri=function(a){this.uri=a||""};Ta.prototype.setLocalControlFeature=function(a){this.localControlFeature=a};Ta.prototype.setOrigin=function(a){this.origin=a};Ta.prototype.setCost=function(a){this.cost=a};Ta.prototype.setForwardingFlags=function(a){this.flags="object"===typeof a&&a instanceof va?new va(a):new va};Ta.prototype.setStrategy=function(a){this.strategy=
"object"===typeof a&&a instanceof c?new c(a):new c};Ta.prototype.setExpirationPeriod=function(a){this.expirationPeriod=a};var Ta=a.ControlParameters,r=a.WireFormat,p=a.Blob,tc=function ff(a){"object"===typeof a&&a instanceof ff?(this.statusCode_=a.statusCode_,this.statusText_=a.statusText_,this.bodyAsControlParameters_=null==a.bodyAsControlParameters_?null:new Ta(a.bodyAsControlParameters_)):(this.statusCode_=null,this.statusText_="",this.bodyAsControlParameters_=null)};q.ControlResponse=tc;tc.prototype.clear=
function(){this.statusCode_=null;this.statusText_="";this.bodyAsControlParameters_=null};tc.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeControlResponse(this)};tc.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlResponse(this,a.buf(),!1):b.decodeControlResponse(this,a,!0)};tc.prototype.getStatusCode=function(){return this.statusCode_};tc.prototype.getStatusText=function(){return this.statusText_};tc.prototype.getBodyAsControlParameters=
function(){return this.bodyAsControlParameters_};tc.prototype.setStatusCode=function(a){this.statusCode_=a;return this};tc.prototype.setStatusText=function(a){this.statusText_=a||"";return this};tc.prototype.setBodyAsControlParameters=function(a){this.bodyAsControlParameters_="object"===typeof a&&a instanceof Ta?new Ta(a):null;return this};c=a.Name;Xa=a.NdnRegexTopMatcher;zc=function Qe(a,b){"object"===typeof a&&a instanceof Qe?(this.prefix=new c(a.prefix),this.regexFilter=a.regexFilter,this.regexFilterPattern=
a.regexFilterPattern):(this.prefix=new c(a),b?(this.regexFilter=b,this.regexFilterPattern=Qe.makePattern(b)):this.regexFilterPattern=this.regexFilter=null)};q.InterestFilter=zc;zc.prototype.doesMatch=function(a){return a.size()<this.prefix.size()?!1:this.hasRegexFilter()?this.prefix.match(a)?(new Xa(this.regexFilterPattern)).match(a.getSubName(this.prefix.size())):!1:this.prefix.match(a)};zc.prototype.getPrefix=function(){return this.prefix};zc.prototype.hasRegexFilter=function(){return null!=this.regexFilter};
zc.prototype.getRegexFilter=function(){return this.regexFilter};zc.makePattern=function(a){1<=a.length&&"^"==a[0]||(a="^"+a);1<=a.length&&"$"==a[-1]||(a+="$");return a};c=a.Name;p=a.Blob;r=a.WireFormat;db=function gf(a){this.delegations_="object"===typeof a&&a instanceof gf?a.delegations_.slice(0):[];this.changeCount_=0};q.DelegationSet=db;db.Delegation=function(a,b){this.preference_=a;this.name_=new c(b)};db.Delegation.prototype.getPreference=function(){return this.preference_};db.Delegation.prototype.getName=
function(){return this.name_};db.Delegation.prototype.compare=function(a){return this.preference_<a.preference_?-1:this.preference_>a.preference_?1:this.name_.compare(a.name_)};db.prototype.add=function(a,b){this.remove(b);for(var c=new db.Delegation(a,b),g=0;g<this.delegations_.length&&!(0<=this.delegations_[g].compare(c));)++g;this.delegations_.splice(g,0,c);++this.changeCount_};db.prototype.addUnsorted=function(a,b){this.delegations_.push(new db.Delegation(a,b));++this.changeCount_};db.prototype.remove=
function(a){for(var b=!1,c=this.delegations_.length-1;0<=c;--c)this.delegations_[c].getName().equals(a)&&(b=!0,this.delegations_.splice(c,1));b&&++this.changeCount_;return b};db.prototype.clear=function(){this.delegations_=[];++this.changeCount_};db.prototype.size=function(){return this.delegations_.length};db.prototype.get=function(a){return this.delegations_[a]};db.prototype.find=function(a){for(var b=0;b<this.delegations_.length;++b)if(this.delegations_[b].getName().equals(a))return b;return-1};
db.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeDelegationSet(this)};db.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeDelegationSet(this,a.buf(),!1):b.decodeDelegationSet(this,a,!0)};db.prototype.getChangeCount=function(){return this.changeCount_};db=a.DelegationSet;Ca=a.ContentType;r=a.WireFormat;R=a.Data;Db=function(a){this.delegations_=new db;if(a instanceof R){if(R.call(this,a),!this.getContent().isNull())try{this.delegations_.wireDecode(this.getContent()),
this.getMetaInfo().setType(Ca.LINK)}catch(b){this.delegations_.clear()}}else void 0!=a?R.call(this,a):R.call(this),this.getMetaInfo().setType(Ca.LINK)};Db.prototype=new R;Db.prototype.name="Link";q.Link=Db;Db.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();R.prototype.wireDecode.call(this,a,b);if(this.getMetaInfo().getType()!=Ca.LINK)throw Error("Link.wireDecode: MetaInfo ContentType is not LINK.");this.delegations_.wireDecode(this.getContent())};Db.prototype.addDelegation=function(a,
b,c){c=c||r.getDefaultWireFormat();this.delegations_.add(a,b);this.encodeContent(c);return this};Db.prototype.removeDelegation=function(a,b){b=b||r.getDefaultWireFormat();var c=this.delegations_.remove(a);c&&this.encodeContent(b);return c};Db.prototype.getDelegations=function(){return this.delegations_};Db.prototype.encodeContent=function(a){this.setContent(this.delegations_.wireEncode(a));this.getMetaInfo().setType(Ca.LINK)};var nb=function Cb(){this.reason_=Cb.Reason.NONE;this.otherReasonCode_=
-1};q.NetworkNack=nb;nb.Reason={NONE:0,CONGESTION:50,DUPLICATE:100,NO_ROUTE:150,OTHER_CODE:32767};nb.prototype.getReason=function(){return this.reason_};nb.prototype.getOtherReasonCode=function(){return this.otherReasonCode_};nb.prototype.setReason=function(a){this.reason_=a;return this};nb.prototype.setOtherReasonCode=function(a){if(0>a)throw Error("NetworkNack other reason code must be non-negative");this.otherReasonCode_=a;return this};nb.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=
a.getHeaderField(b);if(c instanceof nb)return c}return null};var W=a,p=a.Blob,c=a.Name,gb=a.ComponentType,va=a.RegistrationOptions,m=a.Tlv,sa=a.TlvEncoder,na=a.TlvDecoder,r=a.WireFormat,Ua=a.Exclude,Ca=a.ContentType,ta=a.KeyLocatorType,Ia=a.Sha256WithRsaSignature,Va=a.Sha256WithEcdsaSignature,$b=a.GenericSignature,ob=a.HmacWithSha256Signature,wb=a.DigestSha256Signature,Ta=a.ControlParameters,nb=a.NetworkNack,ha=a.Schedule,Bc=a.IncomingFaceId,ed=a.CongestionMark,S=a.DecodingException,G=function(){r.call(this)};
G.prototype=new r;G.prototype.name="Tlv0_2WireFormat";q.Tlv0_2WireFormat=G;G.instance=null;G.didCanBePrefixWarning_=!1;G.prototype.encodeName=function(a){var b=new sa;G.encodeName(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeName=function(a,b,c){null==c&&(c=!0);b=new na(b);G.decodeName(a,b,c)};G.prototype.encodeInterest=function(a){a.didSetCanBePrefix_||G.didCanBePrefixWarning_||(console.log("WARNING: The default CanBePrefix will change. See Interest.setDefaultCanBePrefix() for details."),
G.didCanBePrefixWarning_=!0);if(a.hasApplicationParameters())return G.encodeInterestV03_(a,c,l);var b=new sa(256),c=b.getLength();if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");l=b.getLength();G.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(m.ForwardingHint,
b.getLength()-l)}b.writeOptionalNonNegativeIntegerTlv(m.SelectedDelegation,a.getSelectedDelegationIndex());l=a.getLinkWireEncoding(this);l.isNull()||b.writeBuffer(l.buf());b.writeOptionalNonNegativeIntegerTlv(m.InterestLifetime,a.getInterestLifetimeMilliseconds());if(a.getNonce().isNull()||0==a.getNonce().size())b.writeBlobTlv(m.Nonce,W.randomBytes(4));else if(4>a.getNonce().size()){l=f(4);a.getNonce().buf().copy(l);for(var g=a.getNonce().size();4>g;++g)l[g]=W.randomBytes(1)[0];b.writeBlobTlv(m.Nonce,
l)}else 4==a.getNonce().size()?b.writeBlobTlv(m.Nonce,a.getNonce().buf()):b.writeBlobTlv(m.Nonce,a.getNonce().buf().slice(0,4));G.encodeSelectors(a,b);l=G.encodeName(a.getName(),b);a=b.getLength()-l.signedPortionBeginOffset;l=b.getLength()-l.signedPortionEndOffset;b.writeTypeAndLength(m.Interest,b.getLength()-c);var c=b.getLength()-a,l=b.getLength()-l;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:l}};G.prototype.decodeInterest=function(a,b,c){try{return this.decodeInterestV02_(a,
b,c)}catch(g){try{return G.decodeInterestV03_(a,b,c)}catch(f){throw g;}}};G.prototype.decodeInterestV02_=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(m.Interest),f=G.decodeName(a.getName(),b,c);b.peekType(m.Selectors,g)?G.decodeSelectors(a,b,c):(a.setMinSuffixComponents(null),a.setMaxSuffixComponents(null),a.getKeyLocator().clear(),a.getExclude().clear(),a.setChildSelector(null),a.setMustBeFresh(!1));var l=b.readBlobTlv(m.Nonce);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(m.InterestLifetime,
g));if(b.peekType(m.ForwardingHint,g)){var r=b.readNestedTlvsStart(m.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),r,b,c);b.finishNestedTlvs(r)}if(b.peekType(m.Data,g)){var r=b.getOffset(),q=b.readNestedTlvsStart(m.Data);b.seek(q);a.setLinkWireEncoding(new p(b.getSlice(r,q),c),this)}else a.unsetLink();a.setSelectedDelegationIndex(b.readOptionalNonNegativeIntegerTlv(m.SelectedDelegation,g));if(null!=a.getSelectedDelegationIndex()&&0<=a.getSelectedDelegationIndex()&&!a.hasLink())throw Error("Interest has a selected delegation, but no link object");
a.setApplicationParameters(new p);a.setNonce(new p(l,c));b.finishNestedTlvs(g);return f};G.prototype.encodeData=function(a){var b=new sa(1500),c=b.getLength();b.writeBlobTlv(m.SignatureValue,a.getSignature().getSignature().buf());var g=b.getLength();G.encodeSignatureInfo_(a.getSignature(),b);b.writeBlobTlv(m.Content,a.getContent().buf());G.encodeMetaInfo(a.getMetaInfo(),b);G.encodeName(a.getName(),b);a=b.getLength();b.writeTypeAndLength(m.Data,b.getLength()-c);c=b.getLength()-a;g=b.getLength()-g;
return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:g}};G.prototype.decodeData=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(m.Data),f=b.getOffset();G.decodeName(a.getName(),b,c);b.peekType(m.MetaInfo,g)?G.decodeMetaInfo(a.getMetaInfo(),b,c):a.getMetaInfo().clear();a.setContent(new p(b.readOptionalBlobTlv(m.Content,g),c));G.decodeSignatureInfo(a,b,c);var l=b.getOffset();a.getSignature().setSignature(new p(b.readBlobTlv(m.SignatureValue),
c));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:l}};G.prototype.encodeControlParameters=function(a){var b=new sa(256);G.encodeControlParameters(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeControlParameters=function(a,b,c){null==c&&(c=!0);b=new na(b);G.decodeControlParameters(a,b,c)};G.prototype.encodeControlResponse=function(a){var b=new sa(256),c=b.getLength();null!=a.getBodyAsControlParameters()&&G.encodeControlParameters(a.getBodyAsControlParameters(),
b);b.writeBlobTlv(m.NfdCommand_StatusText,(new p(a.getStatusText())).buf());b.writeNonNegativeIntegerTlv(m.NfdCommand_StatusCode,a.getStatusCode());b.writeTypeAndLength(m.NfdCommand_ControlResponse,b.getLength()-c);return new p(b.getOutput(),!1)};G.prototype.decodeControlResponse=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(m.NfdCommand_ControlResponse);a.setStatusCode(b.readNonNegativeIntegerTlv(m.NfdCommand_StatusCode));var f=new p(b.readBlobTlv(m.NfdCommand_StatusText),
!1);a.setStatusText(f.toString());b.peekType(m.ControlParameters_ControlParameters,g)?(a.setBodyAsControlParameters(new Ta),G.decodeControlParameters(a.getBodyAsControlParameters(),b,c)):a.setBodyAsControlParameters(null);b.finishNestedTlvs(g)};G.prototype.encodeSignatureInfo=function(a){var b=new sa(256);G.encodeSignatureInfo_(a,b);return new p(b.getOutput(),!1)};G.SignatureHolder=function(){};G.SignatureHolder.prototype.setSignature=function(a){this.signature=a};G.SignatureHolder.prototype.getSignature=
function(){return this.signature};G.prototype.decodeSignatureInfoAndValue=function(a,b,c){null==c&&(c=!0);var g=new G.SignatureHolder;a=new na(a);G.decodeSignatureInfo(g,a,c);a=new na(b);g.getSignature().setSignature(new p(a.readBlobTlv(m.SignatureValue),c));return g.getSignature()};G.prototype.encodeSignatureValue=function(a){var b=new sa(256);b.writeBlobTlv(m.SignatureValue,a.getSignature().buf());return new p(b.getOutput(),!1)};G.prototype.decodeLpPacket=function(a,b,c){null==c&&(c=!0);a.clear();
for(var g=new na(b),f=g.readNestedTlvsStart(m.LpPacket_LpPacket);g.getOffset()<f;){var l=g.readVarNumber(),r=g.readVarNumber(),q=g.getOffset()+r;if(q>b.length)throw new S(Error("TLV length exceeds the buffer length"));if(l==m.LpPacket_Fragment){a.setFragmentWireEncoding(new p(g.getSlice(g.getOffset(),q),c));g.seek(q);break}else if(l==m.LpPacket_Nack)r=new nb,l=g.readOptionalNonNegativeIntegerTlv(m.LpPacket_NackReason,q),0>l||l==nb.Reason.NONE?r.setReason(nb.Reason.NONE):l==nb.Reason.CONGESTION||l==
nb.Reason.DUPLICATE||l==nb.Reason.NO_ROUTE?r.setReason(l):(r.setReason(nb.Reason.OTHER_CODE),r.setOtherReasonCode(l)),a.addHeaderField(r);else if(l==m.LpPacket_IncomingFaceId)l=new Bc,l.setFaceId(g.readNonNegativeInteger(r)),a.addHeaderField(l);else if(l==m.LpPacket_CongestionMark)l=new ed,l.setCongestionMark(g.readNonNegativeInteger(r)),a.addHeaderField(l);else{if(!(l>=m.LpPacket_IGNORE_MIN&&l<=m.LpPacket_IGNORE_MAX&&0==(l&3)))throw new S(Error("Did not get the expected TLV type"));g.seek(q)}g.finishNestedTlvs(q)}g.finishNestedTlvs(f)};
G.prototype.encodeDelegationSet=function(a){var b=new sa(256);G.encodeDelegationSet_(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeDelegationSet=function(a,b,c){null==c&&(c=!0);var g=new na(b);G.decodeDelegationSet_(a,b.length,g,c)};G.prototype.encodeEncryptedContent=function(a){var b=new sa(256),c=b.getLength();b.writeBlobTlv(m.Encrypt_EncryptedPayload,a.getPayload().buf());b.writeOptionalBlobTlv(m.Encrypt_InitialVector,a.getInitialVector().buf());b.writeNonNegativeIntegerTlv(m.Encrypt_EncryptionAlgorithm,
a.getAlgorithmType());G.encodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b);b.writeTypeAndLength(m.Encrypt_EncryptedContent,b.getLength()-c);return new p(b.getOutput(),!1)};G.prototype.decodeEncryptedContent=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(m.Encrypt_EncryptedContent);a.clear();G.decodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b,c);a.setAlgorithmType(b.readNonNegativeIntegerTlv(m.Encrypt_EncryptionAlgorithm));a.setInitialVector(new p(b.readOptionalBlobTlv(m.Encrypt_InitialVector,
g),c));a.setPayload(new p(b.readBlobTlv(m.Encrypt_EncryptedPayload),c));b.finishNestedTlvs(g)};G.prototype.encodeEncryptedContentV2=function(a){var b=new sa(256),c=b.getLength();a.getKeyLocator().getType()==ta.KEYNAME&&G.encodeName(a.getKeyLocator().getKeyName(),b);b.writeOptionalBlobTlv(m.Encrypt_EncryptedPayloadKey,a.getPayloadKey().buf());b.writeOptionalBlobTlv(m.Encrypt_InitialVector,a.getInitialVector().buf());b.writeBlobTlv(m.Encrypt_EncryptedPayload,a.getPayload().buf());b.writeTypeAndLength(m.Encrypt_EncryptedContent,
b.getLength()-c);return new p(b.getOutput(),!1)};G.prototype.decodeEncryptedContentV2=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(m.Encrypt_EncryptedContent);a.clear();a.setPayload(new p(b.readBlobTlv(m.Encrypt_EncryptedPayload),c));a.setInitialVector(new p(b.readOptionalBlobTlv(m.Encrypt_InitialVector,g),c));a.setPayloadKey(new p(b.readOptionalBlobTlv(m.Encrypt_EncryptedPayloadKey,g),c));b.peekType(m.Name,g)&&(G.decodeName(a.getKeyLocator().getKeyName(),b,c),a.getKeyLocator().setType(ta.KEYNAME));
b.finishNestedTlvs(g)};G.get=function(){null===G.instance&&(G.instance=new G);return G.instance};G.encodeNameComponent=function(a,b){var c;c=a.getType()===gb.OTHER_CODE?a.getOtherTypeCode():a.getType();b.writeBlobTlv(c,a.getValue().buf())};G.decodeNameComponent=function(a,b){null==b&&(b=!0);var g=a.getOffset(),f=a.readVarNumber();a.seek(g);g=new p(a.readBlobTlv(f),b);return f===m.ImplicitSha256DigestComponent?c.Component.fromImplicitSha256Digest(g):f===m.ParametersSha256DigestComponent?c.Component.fromParametersSha256Digest(g):
f===m.NameComponent?new c.Component(g):new c.Component(g,gb.OTHER_CODE,f)};G.encodeName=function(a,b){for(var c=b.getLength(),g,f=a.size()-1;0<=f;--f)G.encodeNameComponent(a.get(f),b),f==a.size()-1&&(g=b.getLength());f=b.getLength();b.writeTypeAndLength(m.Name,b.getLength()-c);c=b.getLength()-f;g=0==a.size()?c:b.getLength()-g;return{signedPortionBeginOffset:c,signedPortionEndOffset:g}};G.decodeName=function(a,b,c){a.clear();for(var g=b.readNestedTlvsStart(m.Name),f=b.getOffset(),l=f;b.getOffset()<
g;)l=b.getOffset(),a.append(G.decodeNameComponent(b,c));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:l}};G.encodeSelectors=function(a,b){var c=b.getLength();a.getMustBeFresh()&&b.writeTypeAndLength(m.MustBeFresh,0);b.writeOptionalNonNegativeIntegerTlv(m.ChildSelector,a.getChildSelector());0<a.getExclude().size()&&G.encodeExclude(a.getExclude(),b);null!=a.getKeyLocator().getType()&&G.encodeKeyLocator(m.PublisherPublicKeyLocator,a.getKeyLocator(),b);b.writeOptionalNonNegativeIntegerTlv(m.MaxSuffixComponents,
a.getMaxSuffixComponents());b.writeOptionalNonNegativeIntegerTlv(m.MinSuffixComponents,a.getMinSuffixComponents());b.getLength()!=c&&b.writeTypeAndLength(m.Selectors,b.getLength()-c)};G.decodeSelectors=function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(m.Selectors);a.setMinSuffixComponents(b.readOptionalNonNegativeIntegerTlv(m.MinSuffixComponents,g));a.setMaxSuffixComponents(b.readOptionalNonNegativeIntegerTlv(m.MaxSuffixComponents,g));b.peekType(m.PublisherPublicKeyLocator,g)?G.decodeKeyLocator(m.PublisherPublicKeyLocator,
a.getKeyLocator(),b,c):a.getKeyLocator().clear();b.peekType(m.Exclude,g)?G.decodeExclude(a.getExclude(),b,c):a.getExclude().clear();a.setChildSelector(b.readOptionalNonNegativeIntegerTlv(m.ChildSelector,g));a.setMustBeFresh(b.readBooleanTlv(m.MustBeFresh,g));b.finishNestedTlvs(g)};G.encodeExclude=function(a,b){for(var c=b.getLength(),g=a.size()-1;0<=g;--g){var f=a.get(g);f==Ua.ANY?b.writeTypeAndLength(m.Any,0):G.encodeNameComponent(f,b)}b.writeTypeAndLength(m.Exclude,b.getLength()-c)};G.decodeExclude=
function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(m.Exclude);for(a.clear();b.getOffset()<g;)b.peekType(m.Any,g)?(b.readBooleanTlv(m.Any,g),a.appendAny()):a.appendComponent(G.decodeNameComponent(b,c));b.finishNestedTlvs(g)};G.encodeKeyLocator=function(a,b,c){var g=c.getLength();if(null!=b.getType())if(b.getType()==ta.KEYNAME)G.encodeName(b.getKeyName(),c);else if(b.getType()==ta.KEY_LOCATOR_DIGEST&&0<b.getKeyData().size())c.writeBlobTlv(m.KeyLocatorDigest,b.getKeyData().buf());else throw Error("Unrecognized KeyLocatorType "+
b.getType());c.writeTypeAndLength(a,c.getLength()-g)};G.decodeKeyLocator=function(a,b,c,g){null==g&&(g=!0);a=c.readNestedTlvsStart(a);b.clear();if(c.getOffset()!=a){if(c.peekType(m.Name,a))b.setType(ta.KEYNAME),G.decodeName(b.getKeyName(),c,g);else if(c.peekType(m.KeyLocatorDigest,a))b.setType(ta.KEY_LOCATOR_DIGEST),b.setKeyData(new p(c.readBlobTlv(m.KeyLocatorDigest),g));else throw new S(Error("decodeKeyLocator: Unrecognized key locator type"));c.finishNestedTlvs(a)}};G.encodeValidityPeriod_=function(a,
b){var c=b.getLength();b.writeBlobTlv(m.ValidityPeriod_NotAfter,(new p(ha.toIsoString(a.getNotAfter()))).buf());b.writeBlobTlv(m.ValidityPeriod_NotBefore,(new p(ha.toIsoString(a.getNotBefore()))).buf());b.writeTypeAndLength(m.ValidityPeriod_ValidityPeriod,b.getLength()-c)};G.decodeValidityPeriod_=function(a,b){var c=b.readNestedTlvsStart(m.ValidityPeriod_ValidityPeriod);a.clear();var g=new p(b.readBlobTlv(m.ValidityPeriod_NotBefore),!1),f=ha.fromIsoString(g.toString()),g=new p(b.readBlobTlv(m.ValidityPeriod_NotAfter),
!1),g=ha.fromIsoString(g.toString());a.setPeriod(f,g);b.finishNestedTlvs(c)};G.encodeSignatureInfo_=function(a,b){if(a instanceof $b){var c=a.getSignatureInfoEncoding();try{var g=new na(c.buf()),f=g.readNestedTlvsStart(m.SignatureInfo);g.readNonNegativeIntegerTlv(m.SignatureType);g.finishNestedTlvs(f,!0)}catch(l){throw Error("The GenericSignature encoding is not a valid NDN-TLV SignatureInfo: "+l.message);}b.writeBuffer(c.buf())}else{c=b.getLength();if(a instanceof Ia)a.getValidityPeriod().hasPeriod()&&
G.encodeValidityPeriod_(a.getValidityPeriod(),b),G.encodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_SignatureSha256WithRsa);else if(a instanceof Va)a.getValidityPeriod().hasPeriod()&&G.encodeValidityPeriod_(a.getValidityPeriod(),b),G.encodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_SignatureSha256WithEcdsa);else if(a instanceof ob)G.encodeKeyLocator(m.KeyLocator,a.getKeyLocator(),
b),b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_SignatureHmacWithSha256);else if(a instanceof wb)b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_DigestSha256);else throw Error("encodeSignatureInfo: Unrecognized Signature object type");b.writeTypeAndLength(m.SignatureInfo,b.getLength()-c)}};G.decodeSignatureInfo=function(a,b,c){null==c&&(c=!0);var g=b.getOffset(),f=b.readNestedTlvsStart(m.SignatureInfo),l=b.readNonNegativeIntegerTlv(m.SignatureType);l==m.SignatureType_SignatureSha256WithRsa?
(a.setSignature(new Ia),a=a.getSignature(),G.decodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b,c),b.peekType(m.ValidityPeriod_ValidityPeriod,f)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):l==m.SignatureType_SignatureSha256WithEcdsa?(a.setSignature(new Va),a=a.getSignature(),G.decodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b,c),b.peekType(m.ValidityPeriod_ValidityPeriod,f)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):l==m.SignatureType_SignatureHmacWithSha256?(a.setSignature(new ob),
a=a.getSignature(),G.decodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b,c)):l==m.SignatureType_DigestSha256?a.setSignature(new wb):(a.setSignature(new $b),a=a.getSignature(),a.setSignatureInfoEncoding(new p(b.getSlice(g,f),c),l),b.finishNestedTlvs(f,!0));b.finishNestedTlvs(f)};G.encodeMetaInfo=function(a,b){var c=b.getLength(),g=a.getFinalBlockId().getValue().buf();null!=g&&0<g.length&&(g=b.getLength(),G.encodeNameComponent(a.getFinalBlockId(),b),b.writeTypeAndLength(m.FinalBlockId,b.getLength()-g));
b.writeOptionalNonNegativeIntegerTlv(m.FreshnessPeriod,a.getFreshnessPeriod());if(a.getType()!=Ca.BLOB)if(a.getType()==Ca.LINK||a.getType()==Ca.KEY||a.getType()==Ca.NACK)b.writeNonNegativeIntegerTlv(m.ContentType,a.getType());else if(a.getType()==Ca.OTHER_CODE)b.writeNonNegativeIntegerTlv(m.ContentType,a.getOtherTypeCode());else throw Error("unrecognized TLV ContentType");b.writeTypeAndLength(m.MetaInfo,b.getLength()-c)};G.decodeMetaInfo=function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(m.MetaInfo),
f=b.readOptionalNonNegativeIntegerTlv(m.ContentType,g);null==f||0>f||f===Ca.BLOB?a.setType(Ca.BLOB):f===Ca.LINK||f===Ca.KEY||f===Ca.NACK?a.setType(f):(a.setType(Ca.OTHER_CODE),a.setOtherTypeCode(f));a.setFreshnessPeriod(b.readOptionalNonNegativeIntegerTlv(m.FreshnessPeriod,g));b.peekType(m.FinalBlockId,g)?(f=b.readNestedTlvsStart(m.FinalBlockId),a.setFinalBlockId(G.decodeNameComponent(b,c)),b.finishNestedTlvs(f)):a.setFinalBlockId(null);b.finishNestedTlvs(g)};G.encodeControlParameters=function(a,
b){var c=b.getLength();b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_ExpirationPeriod,a.getExpirationPeriod());if(0<a.getStrategy().size()){var g=b.getLength();G.encodeName(a.getStrategy(),b);b.writeTypeAndLength(m.ControlParameters_Strategy,b.getLength()-g)}g=a.getForwardingFlags().getNfdForwardingFlags();g!=(new va).getNfdForwardingFlags()&&b.writeNonNegativeIntegerTlv(m.ControlParameters_Flags,g);b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_Cost,a.getCost());b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_Origin,
a.getOrigin());b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_LocalControlFeature,a.getLocalControlFeature());0!=a.getUri().length&&b.writeBlobTlv(m.ControlParameters_Uri,(new p(a.getUri())).buf());b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_FaceId,a.getFaceId());null!=a.getName()&&G.encodeName(a.getName(),b);b.writeTypeAndLength(m.ControlParameters_ControlParameters,b.getLength()-c)};G.decodeControlParameters=function(a,b,g){null==g&&(g=!0);a.clear();var f=b.readNestedTlvsStart(m.ControlParameters_ControlParameters);
if(b.peekType(m.Name,f)){var l=new c;G.decodeName(l,b,g);a.setName(l)}a.setFaceId(b.readOptionalNonNegativeIntegerTlv(m.ControlParameters_FaceId,f));b.peekType(m.ControlParameters_Uri,f)&&(l=new p(b.readOptionalBlobTlv(m.ControlParameters_Uri,f),!1),a.setUri(l.toString()));b.skipOptionalTlv(m.ControlParameters_LocalUri,f);a.setLocalControlFeature(b.readOptionalNonNegativeIntegerTlv(m.ControlParameters_LocalControlFeature,f));a.setOrigin(b.readOptionalNonNegativeIntegerTlv(m.ControlParameters_Origin,
f));a.setCost(b.readOptionalNonNegativeIntegerTlv(m.ControlParameters_Cost,f));b.skipOptionalTlv(m.ControlParameters_Capacity,f);b.skipOptionalTlv(m.ControlParameters_Count,f);b.skipOptionalTlv(m.ControlParameters_BaseCongestionMarkingInterval,f);b.skipOptionalTlv(m.ControlParameters_DefaultCongestionThreshold,f);b.skipOptionalTlv(m.ControlParameters_Mtu,f);b.peekType(m.ControlParameters_Flags,f)&&(l=new va,l.setNfdForwardingFlags(b.readNonNegativeIntegerTlv(m.ControlParameters_Flags,f)),a.setForwardingFlags(l));
b.skipOptionalTlv(m.ControlParameters_Mask,f);b.peekType(m.ControlParameters_Strategy,f)&&(l=b.readNestedTlvsStart(m.ControlParameters_Strategy),G.decodeName(a.getStrategy(),b,g),b.finishNestedTlvs(l));a.setExpirationPeriod(b.readOptionalNonNegativeIntegerTlv(m.ControlParameters_ExpirationPeriod,f));b.finishNestedTlvs(f)};G.encodeDelegationSet_=function(a,b){for(var c=a.size()-1;0<=c;--c){var g=b.getLength();G.encodeName(a.get(c).getName(),b);b.writeNonNegativeIntegerTlv(m.Link_Preference,a.get(c).getPreference());
b.writeTypeAndLength(m.Link_Delegation,b.getLength()-g)}};G.decodeDelegationSet_=function(a,b,g,f){for(a.clear();g.getOffset()<b;){g.readTypeAndLength(m.Link_Delegation);var l=g.readNonNegativeIntegerTlv(m.Link_Preference),p=new c;G.decodeName(p,g,f);a.addUnsorted(l,p)}};G.encodeInterestV03_=function(a){var b=new sa(256),c=b.getLength();b.writeOptionalBlobTlv(m.ApplicationParameters,a.getApplicationParameters().buf());b.writeOptionalNonNegativeIntegerTlv(m.InterestLifetime,a.getInterestLifetimeMilliseconds());
if(a.getNonce().isNull()||0==a.getNonce().size())b.writeBlobTlv(m.Nonce,W.randomBytes(4));else if(4>a.getNonce().size()){var g=f(4);a.getNonce().buf().copy(g);for(var l=a.getNonce().size();4>l;++l)g[l]=W.randomBytes(1)[0];b.writeBlobTlv(m.Nonce,g)}else 4==a.getNonce().size()?b.writeBlobTlv(m.Nonce,a.getNonce().buf()):b.writeBlobTlv(m.Nonce,a.getNonce().buf().slice(0,4));if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");
if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");g=b.getLength();G.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(m.ForwardingHint,b.getLength()-g)}a.getMustBeFresh()&&b.writeTypeAndLength(m.MustBeFresh,0);a.getCanBePrefix()&&b.writeTypeAndLength(m.CanBePrefix,0);g=G.encodeName(a.getName(),b);a=b.getLength()-g.signedPortionBeginOffset;g=b.getLength()-g.signedPortionEndOffset;b.writeTypeAndLength(m.Interest,b.getLength()-c);c=
b.getLength()-a;a=b.getLength()-g;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:a}};G.decodeInterestV03_=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(m.Interest),f=G.decodeName(a.getName(),b,c);a.setCanBePrefix(b.readBooleanTlv(m.CanBePrefix,g));a.setMustBeFresh(b.readBooleanTlv(m.MustBeFresh,g));if(b.peekType(m.ForwardingHint,g)){var l=b.readNestedTlvsStart(m.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),l,b,c);
b.finishNestedTlvs(l)}else a.getForwardingHint().clear();l=b.readOptionalBlobTlv(m.Nonce,g);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(m.InterestLifetime,g));a.setMinSuffixComponents(null);a.getKeyLocator().clear();a.getExclude().clear();a.setChildSelector(null);a.unsetLink();a.setSelectedDelegationIndex(null);b.readOptionalBlobTlv(m.HopLimit,g);a.setApplicationParameters(new p(b.readOptionalBlobTlv(m.ApplicationParameters,g),c));a.setNonce(null==l?new p:new p(l,c));b.finishNestedTlvs(g);
return f};var G=a.Tlv0_2WireFormat,uc=function(){G.call(this)};uc.prototype=new G;uc.prototype.name="Tlv0_1_1WireFormat";q.Tlv0_1_1WireFormat=uc;uc.instance=null;uc.get=function(){null===uc.instance&&(uc.instance=new uc);return uc.instance};var r=a.WireFormat,uc=a.Tlv0_1_1WireFormat,ld=function(){uc.call(this)};ld.prototype=new uc;ld.prototype.name="Tlv0_1WireFormat";q.Tlv0_1WireFormat=ld;ld.instance=null;ld.get=function(){null===ld.instance&&(ld.instance=new ld);return ld.instance};r=a.WireFormat;
G=a.Tlv0_2WireFormat;fb=function(){G.call(this)};fb.prototype=new G;fb.prototype.name="TlvWireFormat";q.TlvWireFormat=fb;fb.instance=null;fb.get=function(){null===fb.instance&&(fb.instance=new fb);return fb.instance};r.setDefaultWireFormat(fb.get());var L=a.DataUtils,ta=a.KeyLocatorType,E=a.Interest,R=a.Data,Ia=a.Sha256WithRsaSignature,Va=a.Sha256WithEcdsaSignature,ob=a.HmacWithSha256Signature,wb=a.DigestSha256Signature,Ca=a.ContentType,r=a.WireFormat,Ld=function(){};q.EncodingUtils=Ld;Ld.encodeToHexInterest=
function(a,b){b=b||r.getDefaultWireFormat();return L.toHex(a.wireEncode(b).buf())};Ld.encodeToHexData=function(a,b){b=b||r.getDefaultWireFormat();return L.toHex(a.wireEncode(b).buf())};Ld.decodeHexInterest=function(a,b){b=b||r.getDefaultWireFormat();var c=new E;c.wireDecode(L.toNumbers(a),b);return c};Ld.decodeHexData=function(a,b){b=b||r.getDefaultWireFormat();var c=new R;c.wireDecode(L.toNumbers(a),b);return c};Ld.decodeSubjectPublicKeyInfo=function(a){a=L.toHex(a).toLowerCase();a=_x509_getPublicKeyHexArrayFromCertHex(a,
_x509_getSubjectPublicKeyPosFromCertHex(a,0));var b=new B;b.setPublic(a[0],a[1]);return b};Ld.dataToHtml=function(a){function b(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");c+=a;c+="<br/>"}if(-1==a)return"NO CONTENT FOUND";if(-2==a)return"CONTENT NAME IS EMPTY";var c="";b("name: "+a.getName().toUri());0<a.getContent().size()?(b("content (raw): "+a.getContent().buf().toString("binary")),b("content (hex): "+a.getContent().toHex())):b("content: <empty>");a.getMetaInfo().getType()!=Ca.BLOB&&
(a.getMetaInfo().getType()==Ca.KEY?b("metaInfo.type: KEY"):a.getMetaInfo().getType()==Ca.LINK?b("metaInfo.type: LINK"):a.getMetaInfo().getType()==Ca.NACK?b("metaInfo.type: NACK"):a.getMetaInfo().getType()==Ca.OTHER_CODE&&b("metaInfo.type: other code "+a.getMetaInfo().getOtherTypeCode()));b("metaInfo.freshnessPeriod (milliseconds): "+(0<=a.getMetaInfo().getFreshnessPeriod()?""+a.getMetaInfo().getFreshnessPeriod():"<none>"));b("metaInfo.finalBlockId: "+(0<a.getMetaInfo().getFinalBlockId().getValue().size()?
a.getMetaInfo().getFinalBlockId().getValue().toHex():"<none>"));var g=null,f=a.getSignature();f instanceof Ia?(f=a.getSignature(),b("Sha256WithRsa signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof Va?(f=a.getSignature(),b("Sha256WithEcdsa signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof ob?(f=a.getSignature(),b("HmacWithSha256 signature.signature: "+(0<f.getSignature().size()?
f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof wb&&(f=a.getSignature(),b("DigestSha256 signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")));null!==g&&(null==g.getType()?b("signature.keyLocator: <none>"):g.getType()==ta.KEY_LOCATOR_DIGEST?b("signature.keyLocator: KeyLocatorDigest: "+g.getKeyData().toHex()):g.getType()==ta.KEYNAME?b("signature.keyLocator: KeyName: "+g.getKeyName().toUri()):b("signature.keyLocator: <unrecognized ndn_KeyLocatorType>"));
return c};var c=a.Name,R=a.Data,Vd=function(){this.cache_=[]};q.InMemoryStorageRetaining=Vd;Vd.prototype.insert=function(a){this.cache_[a.getFullName().toUri()]=new R(a)};Vd.prototype.find=function(a){for(var b in this.cache_)if(a.getName().isPrefixOf(new c(b)))return this.cache_[b]};Vd.prototype.size=function(){return Object.keys(this.cache_).length};var W=a,p=a.Blob,Md=a.DecryptKey,Wd=a.EncryptKey,ea=a.EncryptAlgorithmType,Fb=a.UseSubtleCrypto,b=a.SyncPromise,pb=function(){};q.AesAlgorithm=pb;pb.generateKey=
function(a){a=W.randomBytes(a.getKeySize()/8);return new Md(new p(a,!1))};pb.deriveEncryptKey=function(a){return new Wd(a)};pb.decryptPromise=function(a,c,g,l){if(Fb()&&!l&&g.getAlgorithmType()!=ea.AesEcb)return g.getAlgorithmType()==ea.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"AES-CBC",iv:g.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):
Promise.reject(Error("unsupported encryption mode"));if(g.getAlgorithmType()==ea.AesEcb)try{var m=W.createDecipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),"");return b.resolve(new p(f.concat([m.update(c.buf()),m.final()]),!1))}catch(r){return b.reject(r)}else if(g.getAlgorithmType()==ea.AesCbc)try{return m=W.createDecipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),g.getInitialVector().buf()),b.resolve(new p(f.concat([m.update(c.buf()),m.final()]),!1))}catch(q){return b.reject(q)}else return b.reject(Error("unsupported encryption mode"))};
pb.decrypt=function(a,c,g){return b.getValue(this.decryptPromise(a,c,g,!0))};pb.encryptPromise=function(a,c,g,l){return g.getAlgorithmType()==ea.AesCbc&&g.getInitialVector().size()!=pb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):Fb()&&!l&&g.getAlgorithmType()!=ea.AesEcb?g.getAlgorithmType()==ea.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.encrypt({name:"AES-CBC",iv:g.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),
!1))}):Promise.reject(Error("unsupported encryption mode")):g.getAlgorithmType()==ea.AesEcb?(a=W.createCipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),""),b.resolve(new p(f.concat([a.update(c.buf()),a.final()]),!1))):g.getAlgorithmType()==ea.AesCbc?(a=W.createCipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),g.getInitialVector().buf()),b.resolve(new p(f.concat([a.update(c.buf()),a.final()]),!1))):b.reject(Error("unsupported encryption mode"))};pb.encrypt=function(a,c,g){return b.getValue(this.encryptPromise(a,
c,g,!0))};pb.BLOCK_SIZE=16;W=a;p=a.Blob;ea=function(){};q.EncryptAlgorithmType=ea;ea.AesEcb=0;ea.AesCbc=1;ea.RsaPkcs=2;ea.RsaOaep=3;var Eb=function(a,b){this.algorithmType_=a;if(null!=b&&0<b){var c=W.randomBytes(b);this.initialVector_=new p(c,!1)}else this.initialVector_=new p};q.EncryptParams=Eb;Eb.prototype.getAlgorithmType=function(){return this.algorithmType_};Eb.prototype.getInitialVector=function(){return this.initialVector_};Eb.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};
Eb.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof p?a:new p(a);return this};var W=a,c=a.Name,V=a.KeyLocator,ta=a.KeyLocatorType,fb=a.TlvWireFormat,p=a.Blob,pb=a.AesAlgorithm,qb=a.RsaAlgorithm,Eb=a.EncryptParams,ea=a.EncryptAlgorithmType,Ka=a.EncryptedContent,b=a.SyncPromise,Ea=function(a){};q.Encryptor=Ea;Ea.NAME_COMPONENT_FOR=new c.Component("FOR");Ea.NAME_COMPONENT_READ=new c.Component("READ");Ea.NAME_COMPONENT_SAMPLE=new c.Component("SAMPLE");Ea.NAME_COMPONENT_ACCESS=
new c.Component("ACCESS");Ea.NAME_COMPONENT_E_KEY=new c.Component("E-KEY");Ea.NAME_COMPONENT_D_KEY=new c.Component("D-KEY");Ea.NAME_COMPONENT_C_KEY=new c.Component("C-KEY");Ea.encryptDataPromise=function(a,g,l,m,r,q){a.getName().append(Ea.NAME_COMPONENT_FOR).append(l);var F=r.getAlgorithmType();return F==ea.AesCbc||F==ea.AesEcb?Ea.encryptSymmetricPromise_(g,m,l,r,q).then(function(c){a.setContent(c.wireEncode(fb.get()));return b.resolve()}):F==ea.RsaPkcs||F==ea.RsaOaep?Ea.encryptAsymmetricPromise_(g,
m,l,r,q).then(function(c){a.setContent(c.wireEncode(fb.get()));return b.resolve()},function(F){F=W.randomBytes(16);var v=new p(F,!1),Hd=new c(l);Hd.append("nonce");var Lb=new Eb(ea.AesCbc,pb.BLOCK_SIZE),zb;return Ea.encryptAsymmetricPromise_(v,m,l,r,q).then(function(a){zb=a;return Ea.encryptSymmetricPromise_(g,v,Hd,Lb,q)}).then(function(c){c=c.wireEncode();var g=zb.wireEncode(),l=new f(c.size()+g.size());g.buf().copy(l,0);c.buf().copy(l,g.size());a.setContent(new p(l,!1));return b.resolve()})}):b.reject(Error("Unsupported encryption method"))};
Ea.encryptData=function(a,c,g,f,l){return b.getValue(Ea.encryptDataPromise(a,c,g,f,l,!0))};Ea.encryptSymmetricPromise_=function(a,c,g,f,l){var m=f.getAlgorithmType(),p=f.getInitialVector(),r=new V;r.setType(ta.KEYNAME);r.setKeyName(g);return m==ea.AesCbc||m==ea.AesEcb?m==ea.AesCbc&&p.size()!=pb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):pb.encryptPromise(c,a,f,l).then(function(a){var c=new Ka;c.setAlgorithmType(m);c.setKeyLocator(r);c.setPayload(a);c.setInitialVector(p);return b.resolve(c)}):
b.reject(Error("Unsupported encryption method"))};Ea.encryptAsymmetricPromise_=function(a,c,g,f,l){var m=f.getAlgorithmType(),p=new V;p.setType(ta.KEYNAME);p.setKeyName(g);return m==ea.RsaPkcs||m==ea.RsaOaep?qb.encryptPromise(c,a,f,l).then(function(a){var c=new Ka;c.setAlgorithmType(m);c.setKeyLocator(p);c.setPayload(a);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};td=a.constants;W=a;p=a.Blob;Md=a.DecryptKey;Wd=a.EncryptKey;ea=a.EncryptAlgorithmType;l=a.DerNode;jb=a.OID;
qa=a.PrivateKeyStorage;Fb=a.UseSubtleCrypto;b=a.SyncPromise;za=a.PublicKey;Cc=null;try{Cc=a}catch(kf){}qb=function(){};q.RsaAlgorithm=qb;qb.generateKeyPromise=function(a,c){if(Fb()&&!c)return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){return Promise.resolve(new Md(new p(new Uint8Array(a),!1)))});
if(!Cc)return b.reject(Error("Need to install rsa-keypair: sudo npm install rsa-keypair"));try{var g=Cc.generate(a.getKeySize()).privateKey.toString().replace("-----BEGIN RSA PRIVATE KEY-----","").replace("-----END RSA PRIVATE KEY-----",""),m=new f(g,"base64"),r=qa.encodePkcs8PrivateKey(m,new jb(qa.RSA_ENCRYPTION_OID),new l.DerNull).buf();return b.resolve(new Md(r))}catch(q){return b.reject(q)}};qb.generateKey=function(a){return b.getValue(qb.generateKeyPromise(a,!0))};qb.deriveEncryptKey=function(a){a=
qb.getRsaPrivateKeyDer(a);var b=l.parse(a.buf(),0).getChildren();a=b[1];var b=b[2],c=new l.DerSequence;c.addChild(a);c.addChild(b);a=c.encode();b=new l.DerSequence;b.addChild(new l.DerOid(new jb(qa.RSA_ENCRYPTION_OID)));b.addChild(new l.DerNull);c=new l.DerSequence;c.addChild(b);c.addChild(new l.DerBitString(a.buf(),0));return new Wd(c.encode())};qb.decryptPromise=function(a,c,g,f){if(Fb()&&!f&&g.getAlgorithmType()!=ea.RsaPkcs)return g.getAlgorithmType()==ea.RsaOaep?crypto.subtle.importKey("pkcs8",
a.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"RSA-OAEP"},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));f=qb.getRsaPrivateKeyDer(a).buf().toString("base64");a="-----BEGIN RSA PRIVATE KEY-----\n";for(var l=0;l<f.length;l+=64)a+=f.substr(l,64)+"\n";a+="-----END RSA PRIVATE KEY-----";if(g.getAlgorithmType()==ea.RsaPkcs)g=td.RSA_PKCS1_PADDING;else if(g.getAlgorithmType()==
ea.RsaOaep)g=td.RSA_PKCS1_OAEP_PADDING;else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new p(W.privateDecrypt({key:a,padding:g},c.buf()),!1))}catch(m){return b.reject(m)}};qb.decrypt=function(a,c,g){return b.getValue(qb.decryptPromise(a,c,g,!0))};qb.encryptPromise=function(a,c,g,f){var l;try{l=new za(a)}catch(m){return b.reject(m)}return l.encryptPromise(c,g.getAlgorithmType(),f)};qb.encrypt=function(a,c,g){return b.getValue(qb.encryptPromise(a,c,g,!0))};qb.getRsaPrivateKeyDer=
function(a){a=l.parse(a.buf(),0).getChildren();if(l.getSequence(a,1).getChildren()[0].toVal()!=qa.RSA_ENCRYPTION_OID)throw Error("The PKCS #8 private key is not RSA_ENCRYPTION");return a[2].getPayload()};var b=a.SyncPromise,md=function(){};q.ConsumerDb=md;md.Error=function(a){if(a)return a.__proto__=md.Error.prototype,a};md.Error.prototype=Error();md.Error.prototype.name="ConsumerDbError";md.prototype.getKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.getKeyPromise is not implemented"))};
md.prototype.addKeyPromise=function(a,c,g){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};md.prototype.deleteKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};var p=a.Blob,c=a.Name,E=a.Interest,nb=a.NetworkNack,Db=a.Link,Ka=a.EncryptedContent,xa=a.EncryptError,Eb=a.EncryptParams,ea=a.EncryptAlgorithmType,qb=a.RsaAlgorithm,pb=a.AesAlgorithm,Ea=a.Encryptor,b=a.SyncPromise,P=a.NdnCommon,Na=function kb(a,b,g,f,l,m,p){this.database_=
l;this.keyChain_=b;this.face_=a;this.groupName_=new c(g);this.consumerName_=new c(f);this.cKeyLink_=void 0==m?kb.NO_LINK:new Db(m);this.dKeyLink_=void 0==p?kb.NO_LINK:new Db(p);this.cKeyMap_={};this.dKeyMap_={}};q.Consumer=Na;Na.prototype.consume=function(a,b,c,g){void 0==g&&(g=Na.NO_LINK);a=new E(a);var f=this;this.sendInterest_(a,1,new Db(g),function(a){f.decryptContent_(a,function(c){try{b(a,c)}catch(g){console.log("Error in onConsumeComplete: "+P.getErrorWithStackTrace(g))}},c)},c)};Na.prototype.setGroup=
function(a){this.groupName_=new c(a)};Na.prototype.addDecryptionKeyPromise=function(a,c,g){return this.consumerName_.match(a)?this.database_.addKeyPromise(a,c,g):b.reject(Error("addDecryptionKey: The consumer name must be a prefix of the key name"))};Na.prototype.addDecryptionKey=function(a,c,g,f){return b.complete(g,f,this.addDecryptionKeyPromise(a,c,!g))};Na.Error=function(a,b){this.errorCode=a;this.message=b};Na.Error.callOnError=function(a,b,c){c||(c="");if(b instanceof Na.Error)try{a(b.errorCode,
b.message)}catch(g){console.log("Error in onError: "+P.getErrorWithStackTrace(g))}else try{a(xa.ErrorCode.General,c+b)}catch(f){console.log("Error in onError: "+P.getErrorWithStackTrace(f))}};Na.decryptPromise_=function(a,c){return b.resolve().then(function(){if("object"==typeof a&&a instanceof p){var g=a;a=new Ka;a.wireDecode(g)}g=a.getPayload();if(a.getAlgorithmType()==ea.AesCbc){var f=new Eb(ea.AesCbc);f.setInitialVector(a.getInitialVector());return pb.decryptPromise(c,g,f)}return a.getAlgorithmType()==
ea.RsaOaep?(f=new Eb(ea.RsaOaep),qb.decryptPromise(c,g,f)):b.reject(new Na.Error(xa.ErrorCode.UnsupportedEncryptionScheme,""+a.getAlgorithmType()))})};Na.decrypt_=function(a,b,c,g){Na.decryptPromise_(a,b).then(function(a){c(a)},function(a){Na.Error.callOnError(g,a)})};Na.prototype.decryptContent_=function(a,b,g){var f=new Ka;try{f.wireDecode(a.getContent())}catch(l){Na.Error.callOnError(g,l,"Error decoding EncryptedContent: ");return}var m=f.getKeyLocator().getKeyName();if(a=this.cKeyMap_[m.toUri()])this.decrypt_(f,
a,b,g);else{a=new c(m);a.append(Ea.NAME_COMPONENT_FOR).append(this.groupName_);a=new E(a);var p=this;this.sendInterest_(a,1,this.cKeyLink_,function(a){p.decryptCKey_(a,function(a){p.cKeyMap_[m.toUri()]=a;Na.decrypt_(f,a,b,g)},g)},g)}};Na.prototype.decryptCKey_=function(a,b,g){a=a.getContent();var f=new Ka;try{f.wireDecode(a)}catch(l){Na.Error.callOnError(g,l,"Error decoding EncryptedContent: ");return}a=f.getKeyLocator().getKeyName();var m=a.getPrefix(-3);m.append(Ea.NAME_COMPONENT_D_KEY).append(a.getSubName(-2));
if(a=this.dKeyMap_[m.toUri()])this.decrypt_(f,a,b,g);else{a=new c(m);a.append(Ea.NAME_COMPONENT_FOR).append(this.consumerName_);a=new E(a);var p=this;this.sendInterest_(a,1,this.dKeyLink_,function(a){p.decryptDKeyPromise_(a).then(function(a){p.dKeyMap_[m.toUri()]=a;Na.decrypt_(f,a,b,g)},function(a){Na.Error.callOnError(g,a,"decryptDKey error: ")})},g)}};Na.prototype.decryptDKeyPromise_=function(a){var c,g,f,l=this;return b.resolve().then(function(){c=a.getContent();g=new Ka;g.wireDecode(c);var b=
g.getKeyLocator().getKeyName();return l.getDecryptionKeyPromise_(b)}).then(function(a){if(0==a.size())return b.reject(new Na.Error(xa.ErrorCode.NoDecryptKey,"The desired consumer decryption key in not in the database"));var l=c.buf().slice(g.wireEncode().size());f=new p(l,!1);return 0==f.size()?b.reject(new Na.Error(xa.ErrorCode.InvalidEncryptedFormat,"The data packet does not satisfy the D-KEY packet format")):Na.decryptPromise_(g,a)}).then(function(a){return Na.decryptPromise_(f,a)})};Na.prototype.sendInterest_=
function(a,b,c,g,f){function l(a,b){try{f(xa.ErrorCode.DataRetrievalFailure,a.getName().toUri())}catch(c){console.log("Error in onError: "+P.getErrorWithStackTrace(c))}}var m=this,p=function(a,b){try{m.keyChain_.verifyData(b,g,function(a,b){try{f(xa.ErrorCode.Validation,"verifyData failed. Reason: "+b)}catch(c){console.log("Error in onError: "+P.getErrorWithStackTrace(c))}})}catch(c){Na.Error.callOnError(f,c,"verifyData error: ")}},r=function(a){0<b?m.sendInterest_(a,b-1,c,g,f):l(a,new nb)};0!==c.getDelegations().size()&&
(a=new E(a),a.setLinkWireEncoding(c.wireEncode()));try{this.face_.expressInterest(a,p,r,l)}catch(Lb){Na.Error.callOnError(f,Lb,"expressInterest error: ")}};Na.prototype.getDecryptionKeyPromise_=function(a){return this.database_.getKeyPromise(a)};Na.NO_LINK=new Db;p=a.Blob;Md=function ve(a){this.keyBits_="object"===typeof a&&a instanceof ve?a.keyBits_:"object"===typeof a&&a instanceof p?a:new p(a)};q.DecryptKey=Md;Md.prototype.getKeyBits=function(){return this.keyBits_};var c=a.Name,E=a.Interest,xa=
a.EncryptError,C=a.KeyChain,Pc=a.SafeBag,Ba=a.EncryptorV2,xa=a.EncryptError,Ka=a.EncryptedContent,Eb=a.EncryptParams,ea=a.EncryptAlgorithmType,pb=a.AesAlgorithm,P=a.NdnCommon,ka=a.Pib,b=a.SyncPromise,ta=a.KeyLocatorType,g=a.Log.LOG,Hb=function(a,b,c,g){this.contentKeys_={};this.credentialsKey_=a;this.face_=g;this.keyChain_=c;this.internalKeyChain_=new C("pib-memory:","tpm-memory:")};q.DecryptorV2=Hb;Hb.prototype.shutdown=function(){for(var a in this.contentKeys_){var b=this.contentKeys_[a];if(0<b.pendingInterest){this.face_.removePendingInterest(b.pendingInterest);
b.pendingInterest=0;for(var c in b.pendingDecrypts)b.pendingDecrypts[c].onError(xa.ErrorCode.CkRetrievalFailure,"Canceling pending decrypt as ContentKey is being destroyed");b.pendingDecrypts=[]}}};Hb.prototype.decrypt=function(a,b,c){if(a.getKeyLocator().getType()!=ta.KEYNAME)3<g&&console.log("Missing required KeyLocator in the supplied EncryptedContent block"),c(xa.ErrorCode.MissingRequiredKeyLocator,"Missing required KeyLocator in the supplied EncryptedContent block");else if(a.hasInitialVector()){var f=
a.getKeyLocatorName(),l=f.toUri(),m=this.contentKeys_[l],p=void 0===m;p&&(m=new Hb.ContentKey,this.contentKeys_[l]=m);m.isRetrieved?Hb.doDecrypt_(a,m.bits,b,c):(3<g&&console.log("CK "+f.toUri()+" not yet available, so adding to the pending decrypt queue"),m.pendingDecrypts.push(new Hb.ContentKey.PendingDecrypt(a,b,c)));p&&this.fetchCk_(f,m,c,Ba.N_RETRIES)}else 3<g&&console.log("Missing required initial vector in the supplied EncryptedContent block"),c(xa.ErrorCode.MissingRequiredInitialVector,"Missing required initial vector in the supplied EncryptedContent block")};
Hb.ContentKey=function(){this.isRetrieved=!1;this.bits=null;this.pendingInterest=0;this.pendingDecrypts=[]};Hb.ContentKey.PendingDecrypt=function(a,b,c){this.encryptedContent=a;this.onSuccess=b;this.onError=c};Hb.prototype.fetchCk_=function(a,b,c,f){3<g&&console.log("Fetching CK "+a.toUri());var l=this,m=function(a,f){try{b.pendingInterest=0;var m=[null],p=[null],r=[null];if(Hb.extractKdkInfoFromCkName_(f.getName(),a.getName(),c,m,p,r)){var Lb=null;try{Lb=l.internalKeyChain_.getPib().getIdentity(p[0])}catch(q){if(!(q instanceof
ka.Error))throw q;}if(null!=Lb){p=null;try{p=Lb.getKey(r[0])}catch(F){if(!(F instanceof ka.Error))throw F;}if(null!=p){3<g&&console.log("KDK "+r.toUri()+" already exists, so directly using it to decrypt the CK");l.decryptCkAndProcessPendingDecrypts_(b,f,r[0],c);return}}l.fetchKdk_(b,m[0],f,c,Ba.N_RETRIES)}}catch(v){c(xa.ErrorCode.General,"Error in fetchCk onData: "+v)}},p=function(g){b.pendingInterest=0;1<f?l.fetchCk_(a,b,c,f-1):c(xa.ErrorCode.CkRetrievalTimeout,"Retrieval of CK ["+g.getName().toUri()+
"] timed out")},r=function(a,g){b.pendingInterest=0;c(xa.ErrorCode.CkRetrievalFailure,"Retrieval of CK ["+a.getName().toUri()+"] failed. Got NACK ("+g.getReason()+")")};try{b.pendingInterest=this.face_.expressInterest((new E(a)).setMustBeFresh(!1).setCanBePrefix(!0),m,p,r)}catch(Lb){c(xa.ErrorCode.General,"expressInterest error: "+Lb)}};Hb.prototype.fetchKdk_=function(a,b,f,l,m){var p=new c(b);p.append(Ba.NAME_COMPONENT_ENCRYPTED_BY).append(this.credentialsKey_.getName());3<g&&console.log("Fetching KDK "+
p.toUri());var r=this,q=function(c,g){a.pendingInterest=0;if(r.decryptAndImportKdk_(g,l)){var m=b.getPrefix(-2).append("KEY").append(b.get(-1));r.decryptCkAndProcessPendingDecrypts_(a,f,m,l)}},Lb=function(c){a.pendingInterest=0;1<m?r.fetchKdk_(a,b,f,l,m-1):l(xa.ErrorCode.KdkRetrievalTimeout,"Retrieval of KDK ["+c.getName().toUri()+"] timed out")},zb=function(b,c){a.pendingInterest=0;l(xa.ErrorCode.KdkRetrievalFailure,"Retrieval of KDK ["+b.getName().toUri()+"] failed. Got NACK ("+c.getReason()+")")};
try{a.pendingInterest=this.face_.expressInterest((new E(p)).setMustBeFresh(!0).setCanBePrefix(!1),q,Lb,zb)}catch(Le){l(xa.ErrorCode.General,"expressInterest error: "+Le)}};Hb.prototype.decryptAndImportKdk_=function(a,c){try{3<g&&console.log("Decrypting and importing KDK "+a.getName().toUri());var f=new Ka;f.wireDecodeV2(a.getContent());var l=new Pc(f.getPayload()),m=b.getValue(this.keyChain_.getTpm().decryptPromise(f.getPayloadKey().buf(),this.credentialsKey_.getName(),!0));if(m.isNull())return c(xa.ErrorCode.TpmKeyNotFound,
"Could not decrypt secret, "+this.credentialsKey_.getName().toUri()+" not found in TPM"),!1;this.internalKeyChain_.importSafeBag(l,m.buf());return!0}catch(p){return c(xa.ErrorCode.DecryptionFailure,"Failed to decrypt KDK ["+a.getName().toUri()+"]: "+p),!1}};Hb.prototype.decryptCkAndProcessPendingDecrypts_=function(a,c,f,l){3<g&&console.log("Decrypting CK data "+c.getName().toUri());var m=new Ka;try{m.wireDecodeV2(c.getContent())}catch(p){l(xa.ErrorCode.InvalidEncryptedFormat,"Error decrypting EncryptedContent: "+
p);return}var r;try{r=b.getValue(this.internalKeyChain_.getTpm().decryptPromise(m.getPayload().buf(),f,!0))}catch(q){l(xa.ErrorCode.DecryptionFailure,"Error decrypting the CK EncryptedContent "+q);return}if(r.isNull())l(xa.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+f.toUri()+" not found in TPM");else{a.bits=r;a.isRetrieved=!0;for(var Lb in a.pendingDecrypts)c=a.pendingDecrypts[Lb],Hb.doDecrypt_(c.encryptedContent,a.bits,c.onSuccess,c.onError);a.pendingDecrypts=[]}};Hb.doDecrypt_=function(a,
b,c,g){if(a.hasInitialVector()){var f;try{var l=new Eb(ea.AesCbc);l.setInitialVector(a.getInitialVector());f=pb.decrypt(b,a.getPayload(),l)}catch(m){g(xa.ErrorCode.DecryptionFailure,"Decryption error in doDecrypt: "+m);return}try{c(f)}catch(p){console.log("Error in onSuccess: "+P.getErrorWithStackTrace(p))}}else g(xa.ErrorCode.MissingRequiredInitialVector,"Expecting Initial Vector in the encrypted content, but it is not present")};Hb.convertKekNameToKdkPrefix_=function(a,b){return 2>a.size()||!a.get(-2).equals(Ba.NAME_COMPONENT_KEK)?
(b(xa.ErrorCode.KekInvalidName,"Invalid KEK name ["+a.toUri()+"]"),null):a.getPrefix(-2).append(Ba.NAME_COMPONENT_KDK).append(a.get(-1))};Hb.extractKdkInfoFromCkName_=function(a,b,c,g,f,l){if(a.size()<b.size()+1||!a.getPrefix(b.size()).equals(b)||!a.get(b.size()).equals(Ba.NAME_COMPONENT_ENCRYPTED_BY))return c(xa.ErrorCode.CkInvalidName,"Invalid CK name ["+a.toUri()+"]"),!1;a=a.getSubName(b.size()+1);g[0]=Hb.convertKekNameToKdkPrefix_(a,c);if(null==g[0])return!1;f[0]=a.getPrefix(-2);l[0]=a.getPrefix(-2).append("KEY").append(a.get(-1));
return!0};xa=function(){};q.EncryptError=xa;xa.ErrorCode={KekRetrievalFailure:1,KekRetrievalTimeout:2,KekInvalidName:3,KdkRetrievalFailure:11,KdkRetrievalTimeout:12,KdkInvalidName:13,KdkDecryptionFailure:14,CkRetrievalFailure:21,CkRetrievalTimeout:22,CkInvalidName:23,MissingRequiredKeyLocator:101,TpmKeyNotFound:102,EncryptionFailure:103,DecryptionFailure:104,MissingRequiredInitialVector:110,General:200,Timeout:1001,Validation:1002,UnsupportedEncryptionScheme:1032,InvalidEncryptedFormat:1033,NoDecryptKey:1034,
DataRetrievalFailure:1036};p=a.Blob;Wd=function Ke(a){this.keyBits_="object"===typeof a&&a instanceof Ke?a.keyBits_:"object"===typeof a&&a instanceof p?a:new p(a)};q.EncryptKey=Wd;Wd.prototype.getKeyBits=function(){return this.keyBits_};V=a.KeyLocator;ta=a.KeyLocatorType;r=a.WireFormat;p=a.Blob;Ka=function we(a){"object"===typeof a&&a instanceof we?(this.algorithmType_=a.algorithmType_,this.keyLocator_=new V(a.keyLocator_),this.initialVector_=a.initialVector_,this.payload_=a.payload_,this.payloadKey_=
a.payloadKey_):this.clear()};q.EncryptedContent=Ka;Ka.prototype.getAlgorithmType=function(){return this.algorithmType_};Ka.prototype.getKeyLocator=function(){return this.keyLocator_};Ka.prototype.getKeyLocatorName=function(){if(this.keyLocator_.getType()!=ta.KEYNAME)throw Error("getKeyLocatorName: The KeyLocator type must be KEYNAME");return this.keyLocator_.getKeyName()};Ka.prototype.hasInitialVector=function(){return!this.initialVector_.isNull()};Ka.prototype.getInitialVector=function(){return this.initialVector_};
Ka.prototype.getPayload=function(){return this.payload_};Ka.prototype.getPayloadKey=function(){return this.payloadKey_};Ka.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};Ka.prototype.setKeyLocator=function(a){this.keyLocator_="object"===typeof a&&a instanceof V?new V(a):new V;return this};Ka.prototype.setKeyLocatorName=function(a){this.keyLocator_.setType(ta.KEYNAME);this.keyLocator_.setKeyName(a);return this};Ka.prototype.setInitialVector=function(a){this.initialVector_=
"object"===typeof a&&a instanceof p?a:new p(a);return this};Ka.prototype.setPayload=function(a){this.payload_="object"===typeof a&&a instanceof p?a:new p(a);return this};Ka.prototype.setPayloadKey=function(a){this.payloadKey_="object"===typeof a&&a instanceof p?a:new p(a);return this};Ka.prototype.clear=function(){this.algorithmType_=null;this.keyLocator_=new V;this.initialVector_=new p;this.payload_=new p;this.payloadKey_=new p};Ka.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeEncryptedContent(this)};
Ka.prototype.wireEncodeV2=function(a){a=a||r.getDefaultWireFormat();return a.encodeEncryptedContentV2(this)};Ka.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeEncryptedContent(this,a.buf(),!1):b.decodeEncryptedContent(this,a,!0)};Ka.prototype.wireDecodeV2=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeEncryptedContentV2(this,a.buf(),!1):b.decodeEncryptedContentV2(this,a,!0)};W=a;p=a.Blob;c=a.Name;
R=a.Data;E=a.Interest;Y=a.SigningInfo;Vd=a.InMemoryStorageRetaining;za=a.PublicKey;Ka=a.EncryptedContent;Eb=a.EncryptParams;ea=a.EncryptAlgorithmType;pb=a.AesAlgorithm;P=a.NdnCommon;xa=a.EncryptError;g=a.Log.LOG;Ba=function xe(a,b,f,l,m,p,r){this.accessPrefix_=new c(a);this.ckPrefix_=new c(b);this.ckBits_=null;this.ckDataSigningInfo_=new Y(f);this.isKekRetrievalInProgress_=!1;this.onError_=l;this.keyChain_=p;this.face_=r;this.kekData_=null;this.storage_=new Vd;this.kekPendingInterestId_=0;this.regenerateCk();
var q=this;this.ckRegisteredPrefixId_=this.face_.registerPrefix((new c(b)).append(xe.NAME_COMPONENT_CK),function(a,b,c,f,l){a=q.storage_.find(b);if(null!=a){3<g&&console.log("Serving "+a.getName().toUri()+" from InMemoryStorage");try{c.putData(a)}catch(m){console.log("Error in Face.putData: "+P.getErrorWithStackTrace(m))}}else 3<g&&console.log("Didn't find CK data for "+b.getName().toUri())},function(a){0<g&&console.log("Failed to register prefix "+a.toUri())})};q.EncryptorV2=Ba;Ba.prototype.shutdown=
function(){this.face_.unsetInterestFilter(this.ckRegisteredPrefixId_);0<this.kekPendingInterestId_&&this.face_.removePendingInterest(this.kekPendingInterestId_)};Ba.prototype.encrypt=function(a){var b=W.randomBytes(Ba.AES_IV_SIZE),c=new Eb(ea.AesCbc);c.setInitialVector(new p(b,!1));a instanceof p||(a=new p(a));a=pb.encrypt(new p(this.ckBits_,!1),a,c);c=new Ka;c.setInitialVector(new p(b,!1));c.setPayload(a);c.setKeyLocatorName(this.ckName_);return c};Ba.prototype.regenerateCk=function(){this.ckName_=
new c(this.ckPrefix_);this.ckName_.append(Ba.NAME_COMPONENT_CK);this.ckName_.appendVersion((new Date).getTime());3<g&&console.log("Generating new CK: "+this.ckName_.toUri());this.ckBits_=W.randomBytes(Ba.AES_KEY_SIZE);null==this.kekData_?this.retryFetchingKek_():this.makeAndPublishCkData_(this.onError_)};Ba.prototype.size=function(){return this.storage_.size()};Ba.prototype.retryFetchingKek_=function(){if(!this.isKekRetrievalInProgress_){3<g&&console.log("Retrying fetching of the KEK");this.isKekRetrievalInProgress_=
!0;var a=this;this.fetchKekAndPublishCkData_(function(){3<g&&console.log("The KEK was retrieved and published");a.isKekRetrievalInProgress_=!1},function(b,c){3<g&&console.log("Failed to retrieve KEK: "+c);a.isKekRetrievalInProgress_=!1;a.onError_(b,c)},Ba.N_RETRIES)}};Ba.prototype.fetchKekAndPublishCkData_=function(a,b,f){3<g&&console.log("Fetching KEK: "+(new c(this.accessPrefix_)).append(Ba.NAME_COMPONENT_KEK).toUri());if(0<this.kekPendingInterestId_)b(xa.ErrorCode.General,"fetchKekAndPublishCkData: There is already a kekPendingInterestId_");
else{var l=this,m=function(c,g){l.kekPendingInterestId_=0;l.kekData_=g;l.makeAndPublishCkData_(b)&&a()},p=function(c){l.kekPendingInterestId_=0;1<f?l.fetchKekAndPublishCkData_(a,b,f-1):(b(xa.ErrorCode.KekRetrievalTimeout,"Retrieval of KEK ["+c.getName().toUri()+"] timed out"),3<g&&console.log("Scheduling retry after all timeouts"),setTimeout(function(){l.retryFetchingKek_()},Ba.RETRY_DELAY_KEK_RETRIEVAL_MS))},r=function(c,m){l.kekPendingInterestId_=0;1<f?setTimeout(function(){l.fetchKekAndPublishCkData_(a,
b,f-1)},Ba.RETRY_DELAY_AFTER_NACK_MS):(b(xa.ErrorCode.KekRetrievalFailure,"Retrieval of KEK ["+c.getName().toUri()+"] failed. Got NACK ("+m.getReason()+")"),3<g&&console.log("Scheduling retry from NACK"),setTimeout(function(){l.retryFetchingKek_()},Ba.RETRY_DELAY_KEK_RETRIEVAL_MS))};try{this.kekPendingInterestId_=this.face_.expressInterest((new E((new c(this.accessPrefix_)).append(Ba.NAME_COMPONENT_KEK))).setMustBeFresh(!0).setCanBePrefix(!0),m,p,r)}catch(q){b(xa.ErrorCode.General,"expressInterest error: "+
q)}}};Ba.prototype.makeAndPublishCkData_=function(a){try{var b=new za(this.kekData_.getContent()),f=new Ka,l=b.encrypt(this.ckBits_,ea.RsaOaep);f.setPayload(l);var m=new R((new c(this.ckName_)).append(Ba.NAME_COMPONENT_ENCRYPTED_BY).append(this.kekData_.getName()));m.setContent(f.wireEncodeV2());m.getMetaInfo().setFreshnessPeriod(Ba.DEFAULT_CK_FRESHNESS_PERIOD_MS);this.keyChain_.sign(m,this.ckDataSigningInfo_);this.storage_.insert(m);3<g&&console.log("Publishing CK data: "+m.getName().toUri());return!0}catch(p){return a(xa.ErrorCode.EncryptionFailure,
"Failed to encrypt generated CK with KEK "+this.kekData_.getName().toUri()),!1}};Ba.NAME_COMPONENT_ENCRYPTED_BY=new c.Component("ENCRYPTED-BY");Ba.NAME_COMPONENT_NAC=new c.Component("NAC");Ba.NAME_COMPONENT_KEK=new c.Component("KEK");Ba.NAME_COMPONENT_KDK=new c.Component("KDK");Ba.NAME_COMPONENT_CK=new c.Component("CK");Ba.RETRY_DELAY_AFTER_NACK_MS=1E3;Ba.RETRY_DELAY_KEK_RETRIEVAL_MS=6E4;Ba.AES_KEY_SIZE=32;Ba.AES_IV_SIZE=16;Ba.N_RETRIES=3;Ba.DEFAULT_CK_FRESHNESS_PERIOD_MS=36E5;var b=a.SyncPromise,
eb=function(){};q.GroupManagerDb=eb;eb.Error=function(a){if(a)return a.__proto__=eb.Error.prototype,a};eb.Error.prototype=Error();eb.Error.prototype.name="GroupManagerDbError";eb.prototype.hasSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.hasSchedulePromise is not implemented"))};eb.prototype.listAllScheduleNamesPromise=function(a){return b.reject(Error("GroupManagerDb.listAllScheduleNamesPromise is not implemented"))};eb.prototype.getSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getSchedulePromise is not implemented"))};
eb.prototype.getScheduleMembersPromise=function(a,c){return b.reject(Error("GroupManagerDb.getScheduleMembersPromise is not implemented"))};eb.prototype.addSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.addSchedulePromise is not implemented"))};eb.prototype.deleteSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteSchedulePromise is not implemented"))};eb.prototype.renameSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.renameSchedulePromise is not implemented"))};
eb.prototype.updateSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.updateSchedulePromise is not implemented"))};eb.prototype.hasMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasMemberPromise is not implemented"))};eb.prototype.listAllMembersPromise=function(a){return b.reject(Error("GroupManagerDb.listAllMembersPromise is not implemented"))};eb.prototype.getMemberSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getMemberSchedulePromise is not implemented"))};
eb.prototype.addMemberPromise=function(a,c,g,f){return b.reject(Error("GroupManagerDb.addMemberPromise is not implemented"))};eb.prototype.updateMemberSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.updateMemberSchedulePromise is not implemented"))};eb.prototype.deleteMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteMemberPromise is not implemented"))};eb.prototype.hasEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasEKeyPromise is not implemented"))};
eb.prototype.addEKeyPromise=function(a,c,g,f){return b.reject(Error("GroupManagerDb.addEKeyPromise is not implemented"))};eb.prototype.getEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.getEKeyPromise is not implemented"))};eb.prototype.cleanEKeysPromise=function(a){return b.reject(Error("GroupManagerDb.cleanEKeysPromise is not implemented"))};eb.prototype.deleteEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteEKeyPromise is not implemented"))};var c=a.Name,R=
a.Data,b=a.SyncPromise,Ma=a.IdentityCertificate,v=a.SecurityException,ac=a.RsaKeyParams,Eb=a.EncryptParams,ea=a.EncryptAlgorithmType,Ea=a.Encryptor,qb=a.RsaAlgorithm,rb=a.Interval,ha=a.Schedule,sb=function(a,b,g,f,l,m){this.namespace_=(new c(a)).append(Ea.NAME_COMPONENT_READ).append(b);this.database_=g;this.keySize_=f;this.freshnessHours_=l;this.keyChain_=m};q.GroupManager=sb;sb.prototype.getGroupKeyPromise=function(a,g,f){void 0==g&&(g=!0);var l=[],m=[],p=this,r,q,F,v;return this.calculateIntervalPromise_(a,
l,f).then(function(a){if(!1==a.isValid())return b.resolve(m);F=ha.toIsoString(a.getStartTime());v=ha.toIsoString(a.getEndTime());var O=new c(p.namespace_);O.append(Ea.NAME_COMPONENT_E_KEY).append(F).append(v);return b.resolve().then(function(){return g?b.resolve(!1):p.database_.hasEKeyPromise(O,f)}).then(function(a){return!g&&a?p.getEKeyPromise_(O,f).then(function(a){r=a.privateKey;q=a.publicKey;return b.resolve()}):p.generateKeyPairPromise_(f).then(function(a){r=a.privateKeyBlob;q=a.publicKeyBlob;
return p.deleteEKeyPromise_(O,f)}).then(function(){return p.addEKeyPromise_(O,q,r,f)})}).then(function(){return p.createEKeyDataPromise_(F,v,q,f)}).then(function(a){function c(a){return a>=l.length?b.resolve():p.createDKeyDataPromise_(F,v,l[a].keyName,r,l[a].publicKey,f).then(function(b){m.push(b);return c(a+1)})}m.push(a);return c(0)}).then(function(){return b.resolve(m)})})};sb.prototype.addSchedulePromise=function(a,b,c){return this.database_.addSchedulePromise(a,b,c)};sb.prototype.deleteSchedulePromise=
function(a,b){return this.database_.deleteSchedulePromise(a,b)};sb.prototype.updateSchedulePromise=function(a,b,c){return this.database_.updateSchedulePromise(a,b,c)};sb.prototype.addMemberPromise=function(a,b,c){b=new Ma(b);return this.database_.addMemberPromise(a,b.getPublicKeyName(),b.getPublicKeyInfo().getKeyDer(),c)};sb.prototype.removeMemberPromise=function(a,b){return this.database_.deleteMemberPromise(a,b)};sb.prototype.updateMemberSchedulePromise=function(a,b,c){return this.database_.updateMemberSchedulePromise(a,
b,c)};sb.prototype.cleanEKeysPromise=function(a){return this.database_.cleanEKeysPromise(a)};sb.prototype.calculateIntervalPromise_=function(a,c,g){var f=new rb,l=new rb;c.splice(0,c.length);var m=this;return this.database_.listAllScheduleNamesPromise(g).then(function(p){function r(q){if(q>=p.length)return b.resolve();var F=p[q];return m.database_.getSchedulePromise(F,g).then(function(b){b=b.getCoveringInterval(a);var p=b.interval;if(b.isPositive)return f.isValid()||(f=p),f.intersectWith(p),m.database_.getScheduleMembersPromise(F,
g).then(function(a){for(var b=0;b<a.length;++b)sb.memberKeysAdd_(c,a[b]);return r(q+1)});l.isValid()||(l=p);l.intersectWith(p);return r(q+1)})}return r(0)}).then(function(){if(!f.isValid())return b.resolve(new rb(!1));var a;a=l.isValid()?f.intersectWith(l):f;return b.resolve(a)})};sb.memberKeysAdd_=function(a,b){for(var c=0;c<a.length;){var g=a[c].keyName.compare(b.keyName);if(0==g)return;if(0<g)break;c+=1}a.splice(c,0,b)};sb.prototype.generateKeyPairPromise_=function(a){a=new ac(this.keySize_);return qb.generateKeyPromise(a).then(function(a){a=
a.getKeyBits();var c=qb.deriveEncryptKey(a).getKeyBits();return b.resolve({privateKeyBlob:a,publicKeyBlob:c})})};sb.prototype.createEKeyDataPromise_=function(a,b,g,f){f=new c(this.namespace_);f.append(Ea.NAME_COMPONENT_E_KEY).append(a).append(b);a=new R(f);a.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*sb.MILLISECONDS_IN_HOUR);a.setContent(g);return this.keyChain_.signPromise(a)};sb.prototype.createDKeyDataPromise_=function(a,g,f,l,m,p){var r=new c(this.namespace_);r.append(Ea.NAME_COMPONENT_D_KEY);
r.append(a).append(g);var q=new R(r);q.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*sb.MILLISECONDS_IN_HOUR);a=new Eb(ea.RsaOaep);var F=this;return Ea.encryptDataPromise(q,l,f,m,a,p).catch(function(a){return b.reject(v(Error("createDKeyData: Error in encryptData: "+a)))}).then(function(){return F.keyChain_.signPromise(q)})};sb.prototype.addEKeyPromise_=function(a,b,c,g){return this.database_.addEKeyPromise(a,b,c,g)};sb.prototype.getEKeyPromise_=function(a,b){return this.database_.getEKeyPromise(a,
b)};sb.prototype.deleteEKeyPromise_=function(a,b){return this.database_.deleteEKeyPromise(a,b)};sb.MILLISECONDS_IN_HOUR=36E5;rb=function ye(a,b){if("object"===typeof a&&a instanceof ye)this.startTime_=a.startTime_,this.endTime_=a.endTime_,this.isValid_=a.isValid_;else if("number"===typeof a){if(!(a<b))throw Error("Interval start time must be less than the end time");this.startTime_=a;this.endTime_=b;this.isValid_=!0}else this.startTime_=-Number.MAX_VALUE,this.endTime_=-Number.MAX_VALUE,this.isValid_=
a?!0:!1};q.Interval=rb;rb.prototype.set=function(a){this.startTime_=a.startTime_;this.endTime_=a.endTime_;this.isValid_=a.isValid_};rb.prototype.covers=function(a){if(!this.isValid_)throw Error("Interval.covers: This Interval is invalid");return this.isEmpty()?!1:this.startTime_<=a&&a<this.endTime_};rb.prototype.intersectWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");
if(this.isEmpty()||a.isEmpty()||this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)return this.startTime_=this.endTime_,this;this.startTime_<=a.startTime_&&(this.startTime_=a.startTime_);this.endTime_>a.endTime_&&(this.endTime_=a.endTime_);return this};rb.prototype.unionWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");if(this.isEmpty())return this.startTime_=
a.startTime_,this.endTime_=a.endTime_,this;if(a.isEmpty())return this;if(this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)throw Error("Interval.unionWith: The two intervals do not have an intersection");this.startTime_>a.startTime_&&(this.startTime_=a.startTime_);this.endTime_<a.endTime_&&(this.endTime_=a.endTime_);return this};rb.prototype.getStartTime=function(){if(!this.isValid_)throw Error("Interval.getStartTime: This Interval is invalid");return this.startTime_};rb.prototype.getEndTime=
function(){if(!this.isValid_)throw Error("Interval.getEndTime: This Interval is invalid");return this.endTime_};rb.prototype.isValid=function(){return this.isValid_};rb.prototype.isEmpty=function(){if(!this.isValid_)throw Error("Interval.isEmpty: This Interval is invalid");return this.startTime_==this.endTime_};var b=a.SyncPromise,Gc=function(){};q.ProducerDb=Gc;Gc.Error=function(a){if(a)return a.__proto__=Gc.Error.prototype,a};Gc.Error.prototype=Error();Gc.Error.prototype.name="ProducerDbError";
Gc.prototype.hasContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.hasContentKeyPromise is not implemented"))};Gc.prototype.getContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.getContentKeyPromise is not implemented"))};Gc.prototype.addContentKeyPromise=function(a,c,g){return b.reject(Error("ProducerDb.addContentKeyPromise is not implemented"))};Gc.prototype.deleteContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.deleteContentKeyPromise is not implemented"))};
Gc.getFixedTimeSlot=function(a){return Math.floor(Math.round(a)/36E5)};var c=a.Name,E=a.Interest,R=a.Data,Db=a.Link,nb=a.NetworkNack,Ua=a.Exclude,Ea=a.Encryptor,Eb=a.EncryptParams,ea=a.EncryptAlgorithmType,sd=a.AesKeyParams,pb=a.AesAlgorithm,ha=a.Schedule,xa=a.EncryptError,P=a.NdnCommon,b=a.SyncPromise,la=function ze(a,b,g,f,l,m,p){this.face_=g;this.keyChain_=f;this.database_=l;this.maxRepeatAttempts_=void 0==m?3:m;this.keyRetrievalLink_=void 0==p?ze.NO_LINK:new Db(p);this.eKeyInfo_={};this.keyRequests_=
{};g=new c(a);f=new c(b);for(g.append(Ea.NAME_COMPONENT_READ);0<f.size();)l=new c(g),l.append(f),l.append(Ea.NAME_COMPONENT_E_KEY),this.eKeyInfo_[l.toUri()]={keyName:l,keyInfo:new ze.KeyInfo_},f=f.getPrefix(-1);g.append(b);this.namespace_=new c(a);this.namespace_.append(Ea.NAME_COMPONENT_SAMPLE);this.namespace_.append(b)};q.Producer=la;la.prototype.createContentKey=function(a,b,g,f){f||(f=la.defaultOnError);var l=la.getRoundedTimeSlot_(a),m=new c(this.namespace_);m.append(Ea.NAME_COMPONENT_C_KEY);
m.append(ha.toIsoString(l));var p,r=this;this.database_.hasContentKeyPromise(a).then(function(l){l?null!=g&&g(m):(l=new sd(128),p=pb.generateKey(l).getKeyBits(),r.database_.addContentKeyPromise(a,p).then(function(){var l=Math.round(a);r.keyRequests_[l]=new la.KeyRequest_(r.getEKeyInfoSize_());var l=r.keyRequests_[l],p=new Ua;la.excludeAfter(p,new c.Component(ha.toIsoString(a)));for(var q in r.eKeyInfo_){var zb=r.eKeyInfo_[q],F=zb.keyInfo;a<F.beginTimeSlot||a>=F.endTimeSlot?(l.repeatAttempts[q]=0,
r.sendKeyInterest_((new E(zb.keyName)).setExclude(p).setChildSelector(1),a,b,f)):(zb=new c(zb.keyName),zb.append(ha.toIsoString(F.beginTimeSlot)),zb.append(ha.toIsoString(F.endTimeSlot)),r.encryptContentKeyPromise_(F.keyBits,zb,a,b,f))}null!=g&&g(m)}))})};la.prototype.produce=function(a,b,g,f,l){l||(l=la.defaultOnError);var m=this;this.createContentKey(b,null,function(p){m.database_.getContentKeyPromise(b).then(function(f){var l=new c(m.namespace_);l.append(ha.toIsoString(b));a.setName(l);l=new Eb(ea.AesCbc,
16);return Ea.encryptData(a,g,p,f,l)}).then(function(){return m.keyChain_.signPromise(a)}).then(function(){try{f()}catch(a){console.log("Error in onComplete: "+P.getErrorWithStackTrace(a))}},function(a){try{l(xa.ErrorCode.General,""+a)}catch(b){console.log("Error in onError: "+P.getErrorWithStackTrace(b))}})},l)};la.defaultOnError=function(a,b){};la.KeyInfo_=function(){this.endTimeSlot=this.beginTimeSlot=0;this.keyBits=null};la.KeyRequest_=function(a){this.interestCount=a;this.repeatAttempts={};this.encryptedKeys=
[]};la.getRoundedTimeSlot_=function(a){return Math.round(36E5*Math.floor(Math.round(a)/36E5))};la.prototype.sendKeyInterest_=function(a,b,c,g){var f=this;0!==this.keyRetrievalLink_.getDelegations().size()&&(a=new E(a),a.setLinkWireEncoding(this.keyRetrievalLink_.wireEncode()));this.face_.expressInterest(a,function(a,l){f.handleCoveringKey_(a,l,b,c,g)},function(a){f.handleTimeout_(a,b,c,g)},function(a,l){f.handleNetworkNack_(a,l,b,c,g)})};la.prototype.handleTimeout_=function(a,b,c,g){var f=Math.round(b),
f=this.keyRequests_[f],l=a.getName().toUri();f.repeatAttempts[l]<this.maxRepeatAttempts_?(++f.repeatAttempts[l],this.sendKeyInterest_(a,b,c,g)):this.handleNetworkNack_(a,new nb,b,c,g)};la.prototype.handleNetworkNack_=function(a,b,c,g,f){a=Math.round(c);this.updateKeyRequest_(this.keyRequests_[a],a,g)};la.prototype.updateKeyRequest_=function(a,b,c){--a.interestCount;if(0==a.interestCount&&null!=c){try{c(a.encryptedKeys)}catch(g){console.log("Error in onEncryptedKeys: "+P.getErrorWithStackTrace(g))}delete this.keyRequests_[b]}};
la.prototype.handleCoveringKey_=function(a,b,c,g,f){var l=Math.round(c),l=this.keyRequests_[l],m=a.getName(),p=m.toUri(),r=b.getName(),q=ha.fromIsoString(r.get(la.START_TIME_STAMP_INDEX).getValue().toString()),F=ha.fromIsoString(r.get(la.END_TIME_STAMP_INDEX).getValue().toString());if(c>=F)a=new Ua(a.getExclude()),la.excludeBefore(a,r.get(la.START_TIME_STAMP_INDEX)),l.repeatAttempts[p]=0,this.sendKeyInterest_((new E(m)).setExclude(a).setChildSelector(1),c,g,f);else{var v=b.getContent(),O=this;this.encryptContentKeyPromise_(v,
r,c,g,f).then(function(a){a&&(a=O.eKeyInfo_[p].keyInfo,a.beginTimeSlot=q,a.endTimeSlot=F,a.keyBits=v)})}};la.prototype.encryptContentKeyPromise_=function(a,g,f,l,m){var p=Math.round(f),r=this.keyRequests_[p],q=new c(this.namespace_);q.append(Ea.NAME_COMPONENT_C_KEY);q.append(ha.toIsoString(la.getRoundedTimeSlot_(f)));var F,v=this;return this.database_.getContentKeyPromise(f).then(function(b){F=new R;F.setName(q);var c=new Eb(ea.RsaOaep);return Ea.encryptDataPromise(F,b,g,a,c)}).then(function(){return b.resolve(!0)},
function(a){try{m(xa.ErrorCode.EncryptionFailure,"encryptData failed: "+a)}catch(c){console.log("Error in onError: "+P.getErrorWithStackTrace(c))}return b.resolve(!1)}).then(function(a){return a?v.keyChain_.signPromise(F).then(function(){r.encryptedKeys.push(F);v.updateKeyRequest_(r,p,l);return b.resolve(!0)}):b.resolve(!1)})};la.prototype.getEKeyInfoSize_=function(){var a=0;for(key in this.eKeyInfo_)this.eKeyInfo_.hasOwnProperty(key)&&++a;return a};la.ExcludeEntry=function(a,b){this.component_=a;
this.anyFollowsComponent_=b};la.getExcludeEntries=function(a){for(var b=[],g=0;g<a.size();++g)a.get(g)==Ua.ANY?0==b.length?b.push(new la.ExcludeEntry(new c.Component,!0)):b[b.length-1].anyFollowsComponent_=!0:b.push(new la.ExcludeEntry(a.get(g),!1));return b};la.setExcludeEntries=function(a,b){a.clear();for(var c=0;c<b.length;++c){var g=b[c];0==c&&0==g.component_.getValue().size()&&g.anyFollowsComponent_?a.appendAny():(a.appendComponent(g.component_),g.anyFollowsComponent_&&a.appendAny())}};la.findEntryBeforeOrAt=
function(a,b){for(var c=a.length-1;0<=c&&!(0>=a[c].component_.compare(b));)--c;return c};la.excludeAfter=function(a,b){var c=la.getExcludeEntries(a),g;g=la.findEntryBeforeOrAt(c,b);if(0>g)c.splice(0,0,new la.ExcludeEntry(b,!0)),g=0;else{var f=c[g];f.anyFollowsComponent_||(f.component_.equals(b)?f.anyFollowsComponent_=!0:(c.splice(g+1,0,new la.ExcludeEntry(b,!0)),g+=1))}g+=1;c.splice(g,c.length-g);la.setExcludeEntries(a,c)};la.excludeBefore=function(a,b){la.excludeRange(a,new c.Component,b)};la.excludeRange=
function(a,b,c){if(0<=b.compare(c)){if(0==b.compare(c))throw Error("excludeRange: from == to. To exclude a single component, sue excludeOne.");throw Error("excludeRange: from must be less than to. Invalid range: ["+b.toEscapedString()+", "+c.toEscapedString()+"]");}var g=la.getExcludeEntries(a),f=la.findEntryBeforeOrAt(g,b);if(0>f)g.splice(0,0,new la.ExcludeEntry(b,!0)),b=0;else{var l=g[f];l.anyFollowsComponent_?b=f:l.component_.equals(b)?(l.anyFollowsComponent_=!0,b=f):(g.splice(f+1,0,new la.ExcludeEntry(b,
!0)),b=f+1)}f=la.findEntryBeforeOrAt(g,c);l=g[f];f==b?g.splice(b+1,0,new la.ExcludeEntry(c,!1)):(l.anyFollowsComponent_?c=f+1:l.component_.equals(c)?c=f:(g.splice(f+1,0,new la.ExcludeEntry(c,!1)),c=f+1),b+=1,g.splice(b,c-b));la.setExcludeEntries(a,g)};la.START_TIME_STAMP_INDEX=-2;la.END_TIME_STAMP_INDEX=-1;la.NO_LINK=new Db;var rb=a.Interval,Ha=function xd(a,b,c,g,f,l){if("object"===typeof a&&a instanceof xd)repetitiveInterval=a,this.startDate_=repetitiveInterval.startDate_,this.endDate_=repetitiveInterval.endDate_,
this.intervalStartHour_=repetitiveInterval.intervalStartHour_,this.intervalEndHour_=repetitiveInterval.intervalEndHour_,this.nRepeats_=repetitiveInterval.nRepeats_,this.repeatUnit_=repetitiveInterval.repeatUnit_;else if("number"===typeof a){void 0==f&&(f=0);void 0==l&&(l=xd.RepeatUnit.NONE);this.startDate_=xd.toDateOnlyMilliseconds_(a);this.endDate_=xd.toDateOnlyMilliseconds_(b);this.intervalStartHour_=Math.round(c);this.intervalEndHour_=Math.round(g);this.nRepeats_=Math.round(f);this.repeatUnit_=
l;if(!(this.intervalStartHour_<this.intervalEndHour_))throw Error("ReptitiveInterval: startHour must be less than endHour");if(!(this.startDate_<=this.endDate_))throw Error("ReptitiveInterval: startDate must be earlier than or same as endDate");if(!(0<=this.intervalStartHour_))throw Error("ReptitiveInterval: intervalStartHour must be non-negative");if(!(1<=this.intervalEndHour_&&24>=this.intervalEndHour_))throw Error("ReptitiveInterval: intervalEndHour must be from 1 to 24");if(this.repeatUnit_==
xd.RepeatUnit.NONE&&this.startDate_!=this.endDate_)throw Error("ReptitiveInterval: With RepeatUnit.NONE, startDate must equal endDate");}else this.startDate_=-Number.MAX_VALUE,this.endDate_=-Number.MAX_VALUE,this.intervalStartHour_=0,this.intervalEndHour_=24,this.nRepeats_=0,this.repeatUnit_=xd.RepeatUnit.NONE};q.RepetitiveInterval=Ha;Ha.RepeatUnit={NONE:0,DAY:1,MONTH:2,YEAR:3};Ha.prototype.getInterval=function(a){var b,c;this.hasIntervalOnDate_(a)?(b=Ha.toDateOnlyMilliseconds_(a)+this.intervalStartHour_*
Ha.MILLISECONDS_IN_HOUR,c=Ha.toDateOnlyMilliseconds_(a)+this.intervalEndHour_*Ha.MILLISECONDS_IN_HOUR,a<b?(c=b,b=Ha.toDateOnlyMilliseconds_(a),a=!1):a>c?(b=c,c=Ha.toDateOnlyMilliseconds_(a)+Ha.MILLISECONDS_IN_DAY,a=!1):a=!0):(b=Ha.toDateOnlyMilliseconds_(a),c=Ha.toDateOnlyMilliseconds_(a)+24*Ha.MILLISECONDS_IN_HOUR,a=!1);return{isPositive:a,interval:new rb(b,c)}};Ha.prototype.compare=function(a){return this.startDate_<a.startDate_?-1:this.startDate_>a.startDate_?1:this.endDate_<a.endDate_?-1:this.endDate_>
a.endDate_?1:this.intervalStartHour_<a.intervalStartHour_?-1:this.intervalStartHour_>a.intervalStartHour_?1:this.intervalEndHour_<a.intervalEndHour_?-1:this.intervalEndHour_>a.intervalEndHour_?1:this.nRepeats_<a.nRepeats_?-1:this.nRepeats_>a.nRepeats_?1:this.repeatUnit_<a.repeatUnit_?-1:this.repeatUnit_>a.repeatUnit_?1:0};Ha.prototype.getStartDate=function(){return this.startDate_};Ha.prototype.getEndDate=function(){return this.endDate_};Ha.prototype.getIntervalStartHour=function(){return this.intervalStartHour_};
Ha.prototype.getIntervalEndHour=function(){return this.intervalEndHour_};Ha.prototype.getNRepeats=function(){return this.nRepeats_};Ha.prototype.getRepeatUnit=function(){return this.repeatUnit_};Ha.prototype.hasIntervalOnDate_=function(a){a=Ha.toDateOnlyMilliseconds_(a);if(a<this.startDate_||a>this.endDate_)return!1;if(this.repeatUnit_==Ha.RepeatUnit.NONE)return!0;if(this.repeatUnit_==Ha.RepeatUnit.DAY){if(0==(a-this.startDate_)/Ha.MILLISECONDS_IN_DAY%this.nRepeats_)return!0}else{a=new Date(a);var b=
new Date(this.startDate_);if(this.repeatUnit_==Ha.RepeatUnit.MONTH&&a.getUTCDate()==b.getUTCDate()){if(0==(12*(a.getUTCFullYear()-b.getUTCFullYear())+a.getUTCMonth()-b.getUTCMonth())%this.nRepeats_)return!0}else if(this.repeatUnit_==Ha.RepeatUnit.YEAR&&a.getUTCDate()==b.getUTCDate()&&a.getUTCMonth()==b.getUTCMonth()&&0==(a.getUTCFullYear()-b.getUTCFullYear())%this.nRepeats_)return!0}return!1};Ha.toDateOnlyMilliseconds_=function(a){a=Math.round(a);return a-=a%Ha.MILLISECONDS_IN_DAY};Ha.MILLISECONDS_IN_HOUR=
36E5;Ha.MILLISECONDS_IN_DAY=864E5;rb=a.Interval;Ha=a.RepetitiveInterval;m=a.Tlv;sa=a.TlvEncoder;na=a.TlvDecoder;p=a.Blob;ha=function Hd(a){"object"===typeof a&&a instanceof Hd?(this.whiteIntervalList_=a.whiteIntervalList_.slice(0),this.blackIntervalList_=a.blackIntervalList_.slice(0)):(this.whiteIntervalList_=[],this.blackIntervalList_=[])};q.Schedule=ha;ha.prototype.addWhiteInterval=function(a){ha.sortedSetAdd_(this.whiteIntervalList_,a);return this};ha.prototype.addBlackInterval=function(a){ha.sortedSetAdd_(this.blackIntervalList_,
a);return this};ha.prototype.getCoveringInterval=function(a){var b=new rb(!0),c=new rb(!0),g=new rb,f=new rb;ha.calculateIntervalResult_(this.blackIntervalList_,a,b,g);if(!b.isEmpty())return{isPositive:!1,interval:b};ha.calculateIntervalResult_(this.whiteIntervalList_,a,c,f);return c.isEmpty()&&!f.isValid()?(a=Ha.toDateOnlyMilliseconds_(a),{isPositive:!1,interval:new rb(a,a+Ha.MILLISECONDS_IN_DAY)}):c.isEmpty()?{isPositive:!1,interval:f}:g.isValid()?{isPositive:!0,interval:c.intersectWith(g)}:{isPositive:!0,
interval:c}};ha.prototype.wireEncode=function(){for(var a=new sa(256),b=a.getLength(),c=a.getLength(),g=this.blackIntervalList_.length-1;0<=g;g--)ha.encodeRepetitiveInterval_(this.blackIntervalList_[g],a);a.writeTypeAndLength(m.Encrypt_BlackIntervalList,a.getLength()-c);c=a.getLength();for(g=this.whiteIntervalList_.length-1;0<=g;g--)ha.encodeRepetitiveInterval_(this.whiteIntervalList_[g],a);a.writeTypeAndLength(m.Encrypt_WhiteIntervalList,a.getLength()-c);a.writeTypeAndLength(m.Encrypt_Schedule,a.getLength()-
b);return new p(a.getOutput(),!1)};ha.prototype.wireDecode=function(a){a="object"===typeof a&&a instanceof p?a.buf():a;a=new na(a);var b=a.readNestedTlvsStart(m.Encrypt_Schedule);this.whiteIntervalList_=[];for(var c=a.readNestedTlvsStart(m.Encrypt_WhiteIntervalList);a.getOffset()<c;)ha.sortedSetAdd_(this.whiteIntervalList_,ha.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);this.blackIntervalList_=[];for(c=a.readNestedTlvsStart(m.Encrypt_BlackIntervalList);a.getOffset()<c;)ha.sortedSetAdd_(this.blackIntervalList_,
ha.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);a.finishNestedTlvs(b)};ha.sortedSetAdd_=function(a,b){for(var c=0;c<a.length;){var g=a[c].compare(b);if(0==g)return;if(!(0>g))break;++c}a.splice(c,0,b)};ha.encodeRepetitiveInterval_=function(a,b){var c=b.getLength();b.writeNonNegativeIntegerTlv(m.Encrypt_RepeatUnit,a.getRepeatUnit());b.writeNonNegativeIntegerTlv(m.Encrypt_NRepeats,a.getNRepeats());b.writeNonNegativeIntegerTlv(m.Encrypt_IntervalEndHour,a.getIntervalEndHour());b.writeNonNegativeIntegerTlv(m.Encrypt_IntervalStartHour,
a.getIntervalStartHour());b.writeBlobTlv(m.Encrypt_EndDate,(new p(ha.toIsoString(a.getEndDate()))).buf());b.writeBlobTlv(m.Encrypt_StartDate,(new p(ha.toIsoString(a.getStartDate()))).buf());b.writeTypeAndLength(m.Encrypt_RepetitiveInterval,b.getLength()-c)};ha.decodeRepetitiveInterval_=function(a){var b=a.readNestedTlvsStart(m.Encrypt_RepetitiveInterval),c=ha.fromIsoString((new p(a.readBlobTlv(m.Encrypt_StartDate),!0)).toString()),g=ha.fromIsoString((new p(a.readBlobTlv(m.Encrypt_EndDate),!0)).toString()),
f=a.readNonNegativeIntegerTlv(m.Encrypt_IntervalStartHour),l=a.readNonNegativeIntegerTlv(m.Encrypt_IntervalEndHour),r=a.readNonNegativeIntegerTlv(m.Encrypt_NRepeats),q=a.readNonNegativeIntegerTlv(m.Encrypt_RepeatUnit);a.finishNestedTlvs(b);return new Ha(c,g,f,l,r,q)};ha.calculateIntervalResult_=function(a,b,c,g){for(var f=0;f<a.length;++f){var l=a[f].getInterval(b),m=l.interval;!0==l.isPositive?c.unionWith(m):g.isValid()?g.intersectWith(m):g.set(m)}};ha.toIsoString=function(a){a=new Date(Math.round(a));
return a.getUTCFullYear()+ha.to2DigitString(a.getUTCMonth()+1)+ha.to2DigitString(a.getUTCDate())+"T"+ha.to2DigitString(a.getUTCHours())+ha.to2DigitString(a.getUTCMinutes())+ha.to2DigitString(a.getUTCSeconds())};ha.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};ha.fromIsoString=function(a){if(15!=a.length||"T"!=a.substr(8,1))throw Error("fromIsoString: Format is not the expected yyyymmddThhmmss");return Date.UTC(parseInt(a.substr(0,4)),parseInt(a.substr(4,2)-1),parseInt(a.substr(6,
2)),parseInt(a.substr(9,2)),parseInt(a.substr(11,2)),parseInt(a.substr(13,2)))};new md;new eb;new Gc;var tb=a.DigestTree,E=a.Interest,R=a.Data,c=a.Name,p=a.Blob,Qa=a.MemoryContentCache,Ee=a.SyncStateProto,P=a.NdnCommon,Ja=function Lb(b,c,g,f,l,m,p,r,q,F){this.onReceivedSyncState=b;this.onInitialized=c;this.applicationDataPrefixUri=g.toUri();this.applicationBroadcastPrefix=f;this.session=l;this.face=m;this.keyChain=p;this.certificateName=r;this.sync_lifetime=q;this.usrseq=-1;this.digest_tree=new tb;
this.contentCache=new Qa(m);this.digest_log=[];this.digest_log.push(new Lb.DigestLogEntry("00",[]));this.contentCache.registerPrefix(this.applicationBroadcastPrefix,F,this.onInterest.bind(this));this.enabled=!0;b=new E(this.applicationBroadcastPrefix);b.getName().append("00");b.setInterestLifetimeMilliseconds(1E3);var v;try{v=dcodeIO.ProtoBuf.newBuilder().import(Ee).build("Sync")}catch(O){v=a.newBuilder().import(Ee).build("Sync")}this.SyncStateMsg=v.SyncStateMsg;this.SyncState=v.SyncState;this.face.expressInterest(b,
this.onData.bind(this),this.initialTimeOut.bind(this))};q.ChronoSync2013=Ja;Ja.prototype.getProducerPrefixes=function(){for(var a=[],b=0;b<this.digest_tree.digestnode.length;++b){var c=this.digest_tree.get(b);a.push(new Ja.PrefixAndSessionNo(c.getDataPrefix(),c.getSessionNo()))}return a};Ja.prototype.getProducerSequenceNo=function(a,b){var c=this.digest_tree.find(a,b);return 0>c?-1:this.digest_tree.get(c).getSequenceNo()};Ja.prototype.publishNextSequenceNo=function(a){a=a instanceof p?a:new p(a,!0);
this.usrseq++;var b={name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}};!a.isNull()&&0<a.size()&&(b.application_info=a.buf());a=[new this.SyncState(b)];b=new this.SyncStateMsg({ss:a});this.broadcastSyncState(this.digest_tree.getRoot(),b);this.update(a)||console.log("Warning: ChronoSync: update did not create a new digest log entry");a=new E(this.applicationBroadcastPrefix);a.getName().append(this.digest_tree.getRoot());a.setInterestLifetimeMilliseconds(this.sync_lifetime);
this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ja.prototype.getSequenceNo=function(){return this.usrseq};Ja.DigestLogEntry=function(a,b){this.digest=a;this.data=b};Ja.DigestLogEntry.prototype.getDigest=function(){return this.digest};Ja.DigestLogEntry.prototype.getData=function(){return this.data};Ja.prototype.shutdown=function(){this.enabled=!1;this.contentCache.unregisterAll()};Ja.SyncState=function(a,b,c,g){this.dataPrefixUri_=a;this.sessionNo_=b;this.sequenceNo_=
c;this.applicationInfo_=g};Ja.SyncState.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ja.SyncState.prototype.getSessionNo=function(){return this.sessionNo_};Ja.SyncState.prototype.getSequenceNo=function(){return this.sequenceNo_};Ja.SyncState.prototype.getApplicationInfo=function(){return this.applicationInfo_};Ja.PrefixAndSessionNo=function(a,b){this.dataPrefixUri_=a;this.sessionNo_=b};Ja.PrefixAndSessionNo.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ja.PrefixAndSessionNo.prototype.getSessionNo=
function(){return this.sessionNo_};Ja.prototype.broadcastSyncState=function(a,b){var c=new Uint8Array(b.toArrayBuffer()),g=new R(this.applicationBroadcastPrefix);g.getName().append(a);g.setContent(new p(c,!1));var f=this;this.keyChain.sign(g,this.certificateName,function(){f.contentCache.add(g)})};Ja.prototype.update=function(a){for(var b=0;b<a.length;b++)0==a[b].type&&this.digest_tree.update(a[b].name,a[b].seqno.session,a[b].seqno.seq)&&this.applicationDataPrefixUri==a[b].name&&(this.usrseq=a[b].seqno.seq);
return-1==this.logfind(this.digest_tree.getRoot())?(a=new Ja.DigestLogEntry(this.digest_tree.getRoot(),a),this.digest_log.push(a),!0):!1};Ja.prototype.logfind=function(a){for(var b=0;b<this.digest_log.length;b++)if(a==this.digest_log[b].digest)return b;return-1};Ja.prototype.onInterest=function(a,b,g,f,l){this.enabled&&(a=b.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString(),b.getName().size()==this.applicationBroadcastPrefix.size()+2&&(a=b.getName().get(this.applicationBroadcastPrefix.size()+
1).toEscapedString()),b.getName().size()==this.applicationBroadcastPrefix.size()+2||"00"==a?this.processRecoveryInst(b,a,g):(this.contentCache.storePendingInterest(b,g),a!=this.digest_tree.getRoot()&&(b=this.logfind(a),-1==b?(b=new E(new c("/local/timeout")),b.setInterestLifetimeMilliseconds(2E3),this.face.expressInterest(b,this.dummyOnData,this.judgeRecovery.bind(this,b,a,g))):this.processSyncInst(b,a,g))))};Ja.prototype.onData=function(a,b){if(this.enabled){var g=new Uint8Array(b.getContent().size());
g.set(b.getContent().buf());var g=this.SyncStateMsg.decode(g.buffer).ss,l=!1;"00"==this.digest_tree.getRoot()?(l=!0,this.initialOndata(g)):(this.update(g),l=a.getName().size()==this.applicationBroadcastPrefix.size()+2?!0:!1);for(var m=[],r=0;r<g.length;r++)if(0==g[r].type){var q;g[r].application_info?(q=g[r].application_info.toBinary(),q=0<q.length?new p(new f(q,"binary"),!1):new p):q=new p;m.push(new Ja.SyncState(g[r].name,g[r].seqno.session,g[r].seqno.seq,q))}try{this.onReceivedSyncState(m,l)}catch(F){console.log("Error in onReceivedSyncState: "+
P.getErrorWithStackTrace(F))}g=new c(this.applicationBroadcastPrefix);g.append(this.digest_tree.getRoot());a=new E(g);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ja.prototype.initialTimeOut=function(a){if(this.enabled){console.log("no other people");this.usrseq++;try{this.onInitialized()}catch(b){console.log("Error in onInitialized: "+P.getErrorWithStackTrace(b))}a=[new this.SyncState({name:this.applicationDataPrefixUri,
type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})];this.update(a);a=new c(this.applicationBroadcastPrefix);a.append(this.digest_tree.getRoot());a=new E(a);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ja.prototype.processRecoveryInst=function(a,b,c){if(-1!=this.logfind(b)){b=[];for(var g=0;g<this.digest_tree.digestnode.length;g++)b[g]=new this.SyncState({name:this.digest_tree.digestnode[g].getDataPrefix(),
type:"UPDATE",seqno:{seq:this.digest_tree.digestnode[g].getSequenceNo(),session:this.digest_tree.digestnode[g].getSessionNo()}});if(0!=b.length){b=new this.SyncStateMsg({ss:b});b=new Uint8Array(b.toArrayBuffer());var f=new R(a.getName());f.setContent(new p(b,!1));"00"==a.getName().get(-1).toEscapedString()&&f.getMetaInfo().setFreshnessPeriod(1E3);this.keyChain.sign(f,this.certificateName,function(){try{c.putData(f)}catch(a){console.log(a.toString())}})}}};Ja.prototype.processSyncInst=function(a,b,
g){for(var f=[],l=[],m=[],r=[],q=a+1;q<this.digest_log.length;q++)for(var F=this.digest_log[q].getData(),v=0;v<F.length;v++)0==F[v].type&&-1!=this.digest_tree.find(F[v].name,F[v].seqno.session)&&(a=l.indexOf(F[v].name),-1==a?(l.push(F[v].name),m.push(F[v].seqno.seq),r.push(F[v].seqno.session)):(m[a]=F[v].seqno.seq,r[a]=F[v].seqno.session));for(v=0;v<l.length;v++)f[v]=new this.SyncState({name:l[v],type:"UPDATE",seqno:{seq:m[v],session:r[v]}});if(0!=f.length){f=new this.SyncStateMsg({ss:f});f=new Uint8Array(f.toArrayBuffer());
a=new c(this.prefix);a.append(this.chatroom).append(b);var O=new R(a);O.setContent(new p(f,!1));this.keyChain.sign(O,this.certificateName,function(){try{g.putData(O)}catch(a){console.log(a.toString())}})}};Ja.prototype.sendRecovery=function(a){var b=new c(this.applicationBroadcastPrefix);b.append("recovery").append(a);a=new E(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ja.prototype.judgeRecovery=function(a,
b,c){a=this.logfind(b);-1!=a?b!=this.digest_tree.root&&this.processSyncInst(a,b,c):this.sendRecovery(b)};Ja.prototype.syncTimeout=function(a){if(this.enabled&&a.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString()==this.digest_tree.root){var b=new c(a.getName()),b=new E(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(b,this.onData.bind(this),this.syncTimeout.bind(this))}};Ja.prototype.initialOndata=function(a){this.update(a);for(var b=this.digest_tree.getRoot(),
c=0;c<a.length;c++)if(a[c].name==this.applicationDataPrefixUri&&a[c].seqno.session==this.session){var g=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:a[c].seqno.seq+1,session:this.session}})];if(this.update(g)){g=new Ja.DigestLogEntry(this.digest_tree.getRoot(),g);this.digest_log.push(g);try{this.onInitialized()}catch(f){console.log("Error in onInitialized: "+P.getErrorWithStackTrace(f))}}}g=0<=this.usrseq?new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",
seqno:{seq:this.usrseq,session:this.session}}):new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:0,session:this.session}});a=new this.SyncStateMsg({ss:g});this.broadcastSyncState(b,a);if(-1==this.digest_tree.find(this.applicationDataPrefixUri,this.session)&&(this.usrseq++,a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})],this.update(a)))try{this.onInitialized()}catch(l){console.log("Error in onInitialized: "+
P.getErrorWithStackTrace(l))}};Ja.prototype.dummyOnData=function(a,b){console.log("*** dummyOnData called. ***")};W=a;tb=function(){this.root="00";this.digestnode=[]};q.DigestTree=tb;tb.Node=function(a,b,c){this.dataPrefix=a;this.seqno_session=b;this.seqno_seq=c;this.recomputeDigest()};tb.Node.prototype.getDataPrefix=function(){return this.dataPrefix};tb.Node.prototype.getSessionNo=function(){return this.seqno_session};tb.Node.prototype.getSequenceNo=function(){return this.seqno_seq};tb.Node.prototype.getDigest=
function(){return this.digest};tb.Node.prototype.setSequenceNo=function(a){this.seqno_seq=a;this.recomputeDigest()};tb.Node.prototype.Int32ToBuffer=function(a){for(var b=new f(4),c=0;4>c;c++)b[c]=a%256,a=Math.floor(a/256);return b};tb.Node.prototype.recomputeDigest=function(){var a=W.createHash("sha256");a.update(this.Int32ToBuffer(this.seqno_session));a.update(this.Int32ToBuffer(this.seqno_seq));var a=a.digest(),b=W.createHash("sha256");b.update(this.dataPrefix);var b=b.digest(),c=W.createHash("sha256");
c.update(b);c.update(a);this.digest=c.digest("hex")};tb.Node.Compare=function(a,b){return a.dataPrefix!=b.dataPrefix?a.dataPrefix<b.dataPrefix:a.seqno_session<b.seqno_session};tb.prototype.update=function(a,b,c){var g=this.find(a,b);if(0<=g)if(this.digestnode[g].getSequenceNo()<c)this.digestnode[g].setSequenceNo(c);else return!1;else a=new tb.Node(a,b,c),this.digestnode.push(a),this.digestnode.sort(this.sortNodes);this.recomputeRoot();return!0};tb.prototype.sortNodes=function(){for(var a,b=this.digestnode.length;0<
b;b--)for(var c=0;c<b-1;c++)this.digestnode[c].getDataPrefix()>this.digestnode[c+1].getDataPrefix()&&(a=this.digestnode[c],this.digestnode[c]=this.digestnode[c+1],this.digestnode[c+1]=a)};tb.prototype.sortNodes=function(a,b){return a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()==b.getSessionNo()?0:a.getDataPrefix()>b.getDataPrefix()||a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()>b.getSessionNo()?1:-1};tb.prototype.find=function(a,b){for(var c=0;c<this.digestnode.length;++c)if(this.digestnode[c].getDataPrefix()==
a&&this.digestnode[c].getSessionNo()==b)return c;return-1};tb.prototype.size=function(){return this.digestnode.size()};tb.prototype.get=function(a){return this.digestnode[a]};tb.prototype.getRoot=function(){return this.root};tb.prototype.recomputeRoot=function(){for(var a=W.createHash("sha256"),b=0;b<this.digestnode.length;b++)a.update(new f(this.digestnode[b].digest,"hex"));this.root=a.digest("hex")};Ee={"package":"Sync",messages:[{name:"SyncState",fields:[{rule:"required",type:"string",name:"name",
id:1,options:{}},{rule:"required",type:"ActionType",name:"type",id:2,options:{}},{rule:"optional",type:"SeqNo",name:"seqno",id:3,options:{}},{rule:"optional",type:"bytes",name:"application_info",id:4,options:{}}],enums:[{name:"ActionType",values:[{name:"UPDATE",id:0},{name:"DELETE",id:1},{name:"OTHER",id:2}],options:{}}],messages:[{name:"SeqNo",fields:[{rule:"required",type:"uint32",name:"seq",id:1,options:{}},{rule:"required",type:"uint32",name:"session",id:2,options:{}}],enums:[],messages:[],options:{}}],
options:{}},{name:"SyncStateMsg",fields:[{rule:"repeated",type:"SyncState",name:"ss",id:1,options:{}}],enums:[],messages:[],options:{}}],enums:[],imports:[],options:{}};q.SyncStateProto=Ee;var r=a.WireFormat,gd=a.CommandInterestPreparer,Xd=function(){gd.call(this)};Xd.prototype=new gd;Xd.prototype.name="CommandInterestGenerator";q.CommandInterestGenerator=Xd;Xd.prototype.generate=function(a,b,c,g,f){f="function"===typeof g?g:f;g="function"!==typeof g&&g?g:r.getDefaultWireFormat();this.prepareCommandInterestName(a,
g);b.sign(a,c,g,function(){(null==a.getInterestLifetimeMilliseconds()||0>a.getInterestLifetimeMilliseconds())&&a.setInterestLifetimeMilliseconds(1E3);f&&f()})};var g=a.Log.LOG,vc=function(){this.table_=[]};q.InterestFilterTable=vc;vc.Entry=function(a,b,c,g){this.interestFilterId_=a;this.filter_=b;this.onInterest_=c;this.face_=g};vc.Entry.prototype.getInterestFilterId=function(){return this.interestFilterId_};vc.Entry.prototype.getFilter=function(){return this.filter_};vc.Entry.prototype.getOnInterest=
function(){return this.onInterest_};vc.Entry.prototype.getFace=function(){return this.face_};vc.prototype.setInterestFilter=function(a,b,c,g){this.table_.push(new vc.Entry(a,b,c,g))};vc.prototype.getMatchedFilters=function(a,b){for(var c=0;c<this.table_.length;++c){var g=this.table_[c];g.getFilter().doesMatch(a.getName())&&b.push(g)}};vc.prototype.unsetInterestFilter=function(a){for(var b=0,c=this.table_.length-1;0<=c;--c)this.table_[c].getInterestFilterId()==a&&(++b,this.table_.splice(c,1));0===
b&&0<g&&console.log("unsetInterestFilter: Didn't find interestFilterId "+a)};var P=a.NdnCommon,g=a.Log.LOG,Sb=function(){this.table_=[];this.removeRequests_=[]};q.PendingInterestTable=Sb;Sb.Entry=function(a,b,c,g,f){this.pendingInterestId_=a;this.interest_=b;this.onData_=c;this.onTimeout_=g;this.onNetworkNack_=f;this.timerId_=-1};Sb.Entry.prototype.getPendingInterestId=function(){return this.pendingInterestId_};Sb.Entry.prototype.getInterest=function(){return this.interest_};Sb.Entry.prototype.getOnData=
function(){return this.onData_};Sb.Entry.prototype.getOnNetworkNack=function(){return this.onNetworkNack_};Sb.Entry.prototype.callTimeout=function(){if(this.onTimeout_)try{this.onTimeout_(this.interest_)}catch(a){console.log("Error in onTimeout: "+P.getErrorWithStackTrace(a))}};Sb.Entry.prototype.setTimeout=function(a,b){-1===this.timerId_&&(this.timerId_=setTimeout(a,b))};Sb.Entry.prototype.clearTimeout=function(){-1!==this.timerId_&&(clearTimeout(this.timerId_),this.timerId_=-1)};Sb.prototype.add=
function(a,b,c,f,l){var m=this.removeRequests_.indexOf(a);if(0<=m)return this.removeRequests_.splice(m,1),null;var p=new Sb.Entry(a,b,c,f,l);this.table_.push(p);a=b.getInterestLifetimeMilliseconds()||4E3;var r=this;p.setTimeout(function(){1<g&&console.log("Interest time out: "+b.getName().toUri());var a=r.table_.indexOf(p);0<=a&&r.table_.splice(a,1);p.callTimeout()},a);return p};Sb.prototype.extractEntriesForExpressedInterest=function(a,b){for(var c=this.table_.length-1;0<=c;--c){var g=this.table_[c];
g.getInterest().matchesData(a)&&(g.clearTimeout(),b.push(g),this.table_.splice(c,1))}};Sb.prototype.extractEntriesForNackInterest=function(a,b){for(var c=a.wireEncode(),g=this.table_.length-1;0<=g;--g){var f=this.table_[g];null!=f.getOnNetworkNack()&&f.getInterest().wireEncode().equals(c)&&(f.clearTimeout(),b.push(f),this.table_.splice(g,1))}};Sb.prototype.removePendingInterest=function(a){if(null!=a){for(var b=0,c=this.table_.length-1;0<=c;--c){var f=this.table_[c];f.getPendingInterestId()==a&&(f.clearTimeout(),
this.table_.splice(c,1),++b)}0===b&&0<g&&console.log("removePendingInterest: Didn't find pendingInterestId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)}};var g=a.Log.LOG,Vc=function(a){this.interestFilterTable_=a;this.table_=[];this.removeRequests_=[]};q.RegisteredPrefixTable=Vc;Vc.prototype.add=function(a,b,c){var g=this.removeRequests_.indexOf(a);if(0<=g)return this.removeRequests_.splice(g,1),!1;this.table_.push(new Vc._Entry(a,b,c));return!0};Vc.prototype.removeRegisteredPrefix=
function(a){for(var b=0,c=this.table_.length-1;0<=c;--c){var f=this.table_[c];f.getRegisteredPrefixId()==a&&(++b,0<f.getRelatedInterestFilterId()&&this.interestFilterTable_.unsetInterestFilter(f.getRelatedInterestFilterId()),this.table_.splice(c,1))}0===b&&0<g&&console.log("removeRegisteredPrefix: Didn't find registeredPrefixId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)};Vc._Entry=function(a,b,c){this.registeredPrefixId_=a;this.prefix_=b;this.relatedInterestFilterId_=
c};Vc._Entry.prototype.getRegisteredPrefixId=function(){return this.registeredPrefixId_};Vc._Entry.prototype.getPrefix=function(){return this.prefix_};Vc._Entry.prototype.getRelatedInterestFilterId=function(){return this.relatedInterestFilterId_};ed=function(){this.congestionMark_=0};q.CongestionMark=ed;ed.prototype.getCongestionMark=function(){return this.congestionMark_};ed.prototype.setCongestionMark=function(a){this.congestionMark_=a};ed.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=
a.getHeaderField(b);if(c instanceof ed)return c}return null};Bc=function(){this.faceId_=null};q.IncomingFaceId=Bc;Bc.prototype.getFaceId=function(){return this.faceId_};Bc.prototype.setFaceId=function(a){this.faceId_=a};Bc.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);if(c instanceof Bc)return c}return null};var p=a.Blob,nd=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};q.LpPacket=nd;nd.prototype.getFragmentWireEncoding=function(){return this.fragmentWireEncoding_};
nd.prototype.countHeaderFields=function(){return this.headerFields_.length};nd.prototype.getHeaderField=function(a){return this.headerFields_[a]};nd.prototype.clear=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};nd.prototype.setFragmentWireEncoding=function(a){this.fragmentWireEncoding_="object"===typeof a&&a instanceof p?a:new p(a)};nd.prototype.addHeaderField=function(a){this.headerFields_.push(a)};var L=a.DataUtils,c=a.Name,E=a.Interest,R=a.Data,Ta=a.ControlParameters,tc=a.ControlResponse,
zc=a.InterestFilter,r=a.WireFormat,fb=a.TlvWireFormat,m=a.Tlv,na=a.TlvDecoder,va=a.RegistrationOptions,vb=a.Transport,Fe=a.TcpTransport,Ne=a.UnixTransport,Xd=a.CommandInterestGenerator,p=a.Blob,P=a.NdnCommon,nb=a.NetworkNack,nd=a.LpPacket,vc=a.InterestFilterTable,Sb=a.PendingInterestTable,Vc=a.RegisteredPrefixTable,Qb=a,g=a.Log.LOG;ca=function zb(a,b){if(!zb.supported)throw Error("The necessary JavaScript support is not available on this platform.");var f;if("object"==typeof a&&a instanceof vb){if(this.getConnectionInfo=
null,this.transport=a,this.connectionInfo=b||null,f={},null==this.connectionInfo&&this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name){var l=zb.getUnixSocketFilePathForLocalhost();null!=l?this.connectionInfo=new Ne.ConnectionInfo(l):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport");0<g&&console.log("Using "+this.connectionInfo.toString())}}else f=a||{},this.transport=(f.getTransport||function(){return new Fe})(),
this.getConnectionInfo=f.getConnectionInfo||this.transport.defaultGetConnectionInfo,this.connectionInfo=f.connectionInfo||null,null==this.connectionInfo&&(l=void 0!==f.host?f.host:null,this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name?null!=l?this.connectionInfo=new Ne.ConnectionInfo(l):null==this.getConnectionInfo&&(l=zb.getUnixSocketFilePathForLocalhost(),null!=l?this.connectionInfo=new Ne.ConnectionInfo(l):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport")):
null!=l&&(this.connectionInfo="undefined"!=typeof Jb?new Jb.ConnectionInfo(l,f.port||9696):new Fe.ConnectionInfo(l,f.port||6363)));null==this.connectionInfo?this.host=this.host=null:(this.host=this.connectionInfo.host,this.host=this.connectionInfo.port);this.readyStatus=zb.UNOPEN;this.onopen=f.onopen||function(){3<g&&console.log("Face connection established.")};this.onclose=f.onclose||function(){3<g&&console.log("Face connection closed.")};this.onConnectedCallbacks=[];this.commandKeyChain=null;this.commandCertificateName=
new c;this.commandInterestGenerator=new Xd;this.timeoutPrefix=new c("/local/timeout");this.pendingInterestTable_=new Sb;this.interestFilterTable_=new vc;this.registeredPrefixTable_=new Vc(this.interestFilterTable_);this.lastEntryId=0;this.interestLoopbackEnabled_=!1};q.Face=ca;ca.UNOPEN=0;ca.OPEN_REQUESTED=1;ca.OPENED=2;ca.CLOSED=3;Fe.importFace(ca);ca.getUnixSocketFilePathForLocalhost=function(){var a="/var/run/nfd.sock";if(Qb.existsSync(a))return a;a="/tmp/.ndnd.sock";return Qb.existsSync(a)?a:
""};ca.getSupported=function(){try{(new f(1)).slice(0,1)}catch(a){return console.log("NDN not available: Buffer not supported. "+a),!1}return!0};ca.supported=ca.getSupported();ca.prototype.createRoute=function(a,b){this.connectionInfo=a instanceof vb.ConnectionInfo?a:new Fe.ConnectionInfo(a,b);this.host=this.connectionInfo.host;this.host=this.connectionInfo.port};ca.prototype.close=function(){this.readyStatus==ca.OPENED&&(this.readyStatus=ca.CLOSED,this.transport.close())};ca.prototype.getNextEntryId=
function(){return++this.lastEntryId};ca.makeShuffledHostGetConnectionInfo=function(a,b,c){a=a.slice(0,a.length);L.shuffle(a);return function(){return 0==a.length?null:c(a.splice(0,1)[0],b)}};ca.prototype.setInterestLoopbackEnabled=function(a){this.interestLoopbackEnabled_=a};ca.prototype.expressInterest=function(a,b,c,g,f,l){var m;"object"===typeof a&&a instanceof E?m=new E(a):b&&"object"===typeof b&&b instanceof E?(m=new E(b),m.setName(a),b=c,c=g,g=f,f=l):(m=new E(a),m.setInterestLifetimeMilliseconds(4E3));
var p=b,q,F,v;q="function"===typeof c?c:function(){};F="function"===typeof g?g:null;v=c instanceof r?c:g instanceof r?g:f instanceof r?f:r.getDefaultWireFormat();var O=this.getNextEntryId();m.setNonce(ca.nonceTemplate_);m.refreshNonce();if(null==this.connectionInfo)if(null==this.getConnectionInfo)console.log("ERROR: connectionInfo is NOT SET");else{var A=this;this.connectAndExecute(function(){A.reconnectAndExpressInterest(O,m,p,q,F,v)})}else this.reconnectAndExpressInterest(O,m,p,q,F,v);return O};
ca.prototype.reconnectAndExpressInterest=function(a,b,c,g,f,l){var m=this;if(this.connectionInfo.equals(this.transport.connectionInfo)&&this.readyStatus!==ca.UNOPEN)if(this.readyStatus===ca.OPEN_REQUESTED)this.onConnectedCallbacks.push(function(){m.expressInterestHelper(a,b,c,g,f,l)});else if(this.readyStatus===ca.OPENED)this.expressInterestHelper(a,b,c,g,f,l);else throw Error("reconnectAndExpressInterest: unexpected connection is not opened");else this.readyStatus=ca.OPEN_REQUESTED,this.onConnectedCallbacks.push(function(){m.expressInterestHelper(a,
b,c,g,f,l)}),this.transport.connect(this.connectionInfo,this,function(){for(m.readyStatus=ca.OPENED;0<m.onConnectedCallbacks.length;)try{m.onConnectedCallbacks.shift()()}catch(a){console.log("Face.reconnectAndExpressInterest: ignoring exception from onConnectedCallbacks: "+a)}if(m.onopen)m.onopen()},function(){m.closeByTransport()})};ca.prototype.expressInterestHelper=function(a,b,c,g,f,l){if(null!=this.pendingInterestTable_.add(a,b,c,g,f)&&!this.timeoutPrefix.match(b.getName())){a=b.wireEncode(l);
if(a.size()>ca.getMaxNdnPacketSize())throw Error("The encoded interest size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a.buf());this.interestLoopbackEnabled_&&dispatchInterest(b)}};ca.prototype.removePendingInterest=function(a){this.pendingInterestTable_.removePendingInterest(a)};ca.prototype.setCommandSigningInfo=function(a,b){this.commandKeyChain=a;this.commandCertificateName=new c(b)};ca.prototype.setCommandCertificateName=function(a){this.commandCertificateName=new c(a)};
ca.prototype.makeCommandInterest=function(a,b,c){c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:r.getDefaultWireFormat();this.nodeMakeCommandInterest(a,this.commandKeyChain,this.commandCertificateName,b,c)};ca.prototype.nodeMakeCommandInterest=function(a,b,c,g,f){this.commandInterestGenerator.generate(a,b,c,g,f)};ca.prototype.registerPrefix=function(a,b,c,g,f,l){var m=g,p=f,q=l;g="function"===typeof m?m:null;f=m instanceof va?m:p instanceof va?p:new va;l=m instanceof r?m:p instanceof r?
p:q instanceof r?q:r.getDefaultWireFormat();c||(c=function(){});var F=this.getNextEntryId(),v=this,m=function(){v.nfdRegisterPrefix(F,a,b,f,c,g,v.commandKeyChain,v.commandCertificateName,l)};null==this.connectionInfo?null==this.getConnectionInfo?console.log("ERROR: connectionInfo is NOT SET"):this.connectAndExecute(m):m();return F};ca.getMaxNdnPacketSize=function(){return P.MAX_NDN_PACKET_SIZE};ca.RegisterResponse=function(a,b,c,g,f,l){this.prefix=a;this.onRegisterFailed=b;this.onRegisterSuccess=
c;this.registeredPrefixId=g;this.parent=f;this.onInterest=l};ca.RegisterResponse.prototype.onData=function(a,b){var c=new tc;try{c.wireDecode(b.getContent(),fb.get())}catch(f){0<g&&console.log("Register prefix failed: Error decoding the NFD response: "+f);if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(l){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(l))}return}if(200!=c.getStatusCode()){if(0<g&&console.log("Register prefix failed: Expected NFD status code 200, got: "+
c.getStatusCode()),this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(m){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(m))}}else{if(0!=this.registeredPrefixId&&(c=0,null!=this.onInterest&&(c=this.parent.setInterestFilter(new zc(this.prefix),this.onInterest)),!this.parent.registeredPrefixTable_.add(this.registeredPrefixId,this.prefix,c))){0<c&&this.parent.unsetInterestFilter(c);return}2<g&&console.log("Register prefix succeeded with the NFD forwarder for prefix "+
this.prefix.toUri());if(null!=this.onRegisterSuccess)try{this.onRegisterSuccess(this.prefix,this.registeredPrefixId)}catch(p){console.log("Error in onRegisterSuccess: "+P.getErrorWithStackTrace(p))}}};ca.RegisterResponse.prototype.onTimeout=function(a){2<g&&console.log("Timeout for NFD register prefix command.");if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(b){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(b))}};ca.prototype.nfdRegisterPrefix=function(a,
b,f,l,m,p,r,q,F){if(null==r)throw Error("registerPrefix: The command KeyChain has not been set. You must call setCommandSigningInfo.");if(0==q.size())throw Error("registerPrefix: The command certificate name has not been set. You must call setCommandSigningInfo.");var v=new Ta;v.setName(b);v.setForwardingFlags(l);null!=l.getOrigin()&&0<=l.getOrigin()&&(v.setOrigin(l.getOrigin()),v.getForwardingFlags().setOrigin(null));var O=this;this.isLocal(function(g){var l=new E;l.setCanBePrefix(!0);g?(l.setName(new c("/localhost/nfd/rib/register")),
l.setInterestLifetimeMilliseconds(2E3)):(l.setName(new c("/localhop/nfd/rib/register")),l.setInterestLifetimeMilliseconds(4E3));l.getName().append(v.wireEncode(fb.get()));O.nodeMakeCommandInterest(l,r,q,fb.get(),function(){var c=new ca.RegisterResponse(b,m,p,a,O,f);O.reconnectAndExpressInterest(null,l,c.onData.bind(c),c.onTimeout.bind(c),null,F)})},function(a){0<g&&console.log("Error in Transport.isLocal: "+a);if(m)try{m(b)}catch(c){console.log("Error in onRegisterFailed: "+P.getErrorWithStackTrace(c))}})};
ca.prototype.removeRegisteredPrefix=function(a){this.registeredPrefixTable_.removeRegisteredPrefix(a)};ca.prototype.setInterestFilter=function(a,b){var c=this.getNextEntryId();this.interestFilterTable_.setInterestFilter(c,new zc(a),b,this);return c};ca.prototype.unsetInterestFilter=function(a){this.interestFilterTable_.unsetInterestFilter(a)};ca.prototype.putData=function(a,b){b=b||r.getDefaultWireFormat();if(!this.interestLoopbackEnabled_||!this.satisfyPendingInterests(a)){var c=a.wireEncode(b);
if(c.size()>ca.getMaxNdnPacketSize())throw Error("The encoded Data packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(c.buf())}};ca.prototype.send=function(a){if(a.length>ca.getMaxNdnPacketSize())throw Error("The encoded packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a)};ca.prototype.isLocal=function(a,b){null==this.connectionInfo?a(!1):this.transport.isLocal(this.connectionInfo,a,b)};ca.prototype.onReceivedElement=function(a){3<g&&
console.log("Complete element received. Length "+a.length+". Start decoding.");var b=null;a[0]==m.LpPacket_LpPacket&&(b=new nd,fb.get().decodeLpPacket(b,a,!1),a=b.getFragmentWireEncoding().buf());var c=null,f=null;if(a[0]==m.Interest||a[0]==m.Data){var l=new na(a);l.peekType(m.Interest,a.length)?(c=new E,c.wireDecode(a,fb.get()),null!=b&&c.setLpPacket(b)):l.peekType(m.Data,a.length)&&(f=new R,f.wireDecode(a,fb.get()),null!=b&&f.setLpPacket(b))}if(null!==b&&(b.setFragmentWireEncoding(new p),a=nb.getFirstHeader(b),
null!=a)){if(null==c)return;f=[];this.pendingInterestTable_.extractEntriesForNackInterest(c,f);for(c=0;c<f.length;++c){b=f[c];try{b.getOnNetworkNack()(b.getInterest(),a)}catch(r){console.log("Error in onNetworkNack: "+P.getErrorWithStackTrace(r))}}return}null!==c?(3<g&&console.log("Interest packet received."),this.dispatchInterest_(c)):null!==f&&(3<g&&console.log("Data packet received."),this.satisfyPendingInterests_(f))};ca.prototype.dispatchInterest_=function(a){var b=[];this.interestFilterTable_.getMatchedFilters(a,
b);for(var c=0;c<b.length;++c){var f=b[c];3<g&&console.log("Found interest filter for "+a.getName().toUri());try{f.getOnInterest()(f.getFilter().getPrefix(),a,this,f.getInterestFilterId(),f.getFilter())}catch(l){console.log("Error in onInterest: "+P.getErrorWithStackTrace(l))}}};ca.prototype.satisfyPendingInterests_=function(a){var b=!1,c=[];this.pendingInterestTable_.extractEntriesForExpressedInterest(a,c);for(var g=0;g<c.length;++g){var f=c[g],b=!0;try{f.getOnData()(f.getInterest(),a)}catch(l){console.log("Error in onData: "+
P.getErrorWithStackTrace(l))}}return b};ca.prototype.connectAndExecute=function(a){var b=this.getConnectionInfo();if(null==b)console.log("ERROR: No more connectionInfo from getConnectionInfo"),this.host=this.host=this.connectionInfo=null;else if(b.equals(this.connectionInfo))console.log("ERROR: The host returned by getConnectionInfo is not alive: "+this.connectionInfo.toString());else{this.connectionInfo=b;0<g&&console.log("connectAndExecute: trying host from getConnectionInfo: "+this.connectionInfo.toString());
this.host=this.connectionInfo.host;this.host=this.connectionInfo.port;b=new E(new c("/"));b.setInterestLifetimeMilliseconds(4E3);var f=this,l=setTimeout(function(){0<g&&console.log("connectAndExecute: timeout waiting for host "+f.host);f.connectAndExecute(a)},3E3);this.reconnectAndExpressInterest(null,b,function(b,c){clearTimeout(l);0<g&&console.log("connectAndExecute: connected to host "+f.host);a()},function(a){},null,r.getDefaultWireFormat())}};ca.prototype.closeByTransport=function(){this.readyStatus=
ca.CLOSED;this.onclose()};ca.nonceTemplate_=new p(new f(4),!1);new ca(new vb,{equals:function(){return!0}});var Ge={};Object.keys(a).forEach(function(b){Ge[b]=ma[b];ma[b]=a[b]});a.noConflict=function(){Object.keys(Ge).forEach(function(b){ma[b]===a[b]&&("undefined"==typeof Ge[b]?delete ma[b]:ma[b]=Ge[b])});return a};ma.ndn=a})(this);
(function(ma,t,J){function T(f,t){"object"!==typeof t&&(t=t());Object.keys(t).forEach(function(D){f[D]=t[D]});return f}function U(f){return{from:function(t){f.prototype=Object.create(t.prototype);f.prototype.constructor=f;return{extend:function(D){T(f.prototype,"object"!==typeof D?D(t.prototype):D)}}}}}function X(f,t){return t(f)}function K(v,t){function D(a){this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null};this.stores({})}function dc(f,c,m,p){if(0===f){Object.keys(ba).forEach(function(a){q(c,
a,ba[a].primKey,ba[a].indexes)});var r=L._createTransaction(b,ad,ba);r.idbtrans=c;r.idbtrans.onerror=Pa(m,["populating database"]);r.on("error").subscribe(m);S.newPSD(function(){S.PSD.trans=r;try{L.on("populate").fire(r)}catch(a){p.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();m(a)}})}else{var v=[],g=Lc.filter(function(a){return a._cfg.version===f})[0];if(!g)throw new La("Dexie specification of currently installed DB version is missing");ba=L._dbSchema=g._cfg.dbschema;
var A=!1;Lc.filter(function(a){return a._cfg.version>f}).forEach(function(g){var f=ba,p=g._cfg.dbschema;Kc(f,c);Kc(p,c);ba=L._dbSchema=p;f=a(f,p);f.add.forEach(function(a){v.push(function(b,c){q(b,a[0],a[1].primKey,a[1].indexes);c()})});f.change.forEach(function(a){if(a.recreate)throw new La("Not yet support for changing primary key");v.push(function(b,c){var g=b.objectStore(a.name);a.add.forEach(function(a){Yb(g,a)});a.change.forEach(function(a){g.deleteIndex(a.name);Yb(g,a)});a.del.forEach(function(a){g.deleteIndex(a)});
c()})});g._cfg.contentUpgrade&&v.push(function(a,c){A=!0;var f=L._createTransaction(b,[].slice.call(a.db.objectStoreNames,0),p);f.idbtrans=a;var r=0;f._promise=X(f._promise,function(a){return function(b,g,f){function l(a){return function(){a.apply(this,arguments);0===--r&&c()}}++r;return a.call(this,b,function(a,b,c){arguments[0]=l(a);arguments[1]=l(b);g.apply(this,arguments)},f)}});a.onerror=Pa(m,["running upgrader function for version",g._cfg.version]);f.on("error").subscribe(m);g._cfg.contentUpgrade(f);
0===r&&c()});A&&(0<=navigator.userAgent.indexOf("Trident")||0<=navigator.userAgent.indexOf("MSIE"))||v.push(function(a,b){for(var c=0;c<a.db.objectStoreNames.length;++c){var g=a.db.objectStoreNames[c];null!==p[g]&&p[g]!==J||a.db.deleteObjectStore(g)}b()})});var O=function(){try{v.length?v.shift()(c,O):ma(ba,c)}catch(a){p.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();m(a)}};O()}}function a(a,b){var f={del:[],add:[],change:[]},m;for(m in a)b[m]||f.del.push(m);
for(m in b){var p=a[m],q=b[m];if(p){var g={name:m,def:b[m],recreate:!1,del:[],add:[],change:[]};if(p.primKey.src!==q.primKey.src)g.recreate=!0,f.change.push(g);else{var p=p.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),q=q.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),v;for(v in p)q[v]||g.del.push(v);for(v in q){var O=p[v],l=q[v];O?O.src!==l.src&&g.change.push(l):g.add.push(l)}(g.recreate||0<g.del.length||0<g.add.length||0<g.change.length)&&f.change.push(g)}}else f.add.push([m,q])}return f}
function q(a,b,f,m){var p=a.db.createObjectStore(b,f.keyPath?{keyPath:f.keyPath,autoIncrement:f.auto}:{autoIncrement:f.auto});m.forEach(function(a){Yb(p,a)});return p}function ma(a,b){Object.keys(a).forEach(function(f){b.db.objectStoreNames.contains(f)||q(b,f,a[f].primKey,a[f].indexes)})}function Yb(a,b){a.createIndex(b.name,b.keyPath,{unique:b.unique,multiEntry:b.multi})}function Gd(a,b){throw new La("Table "+b[0]+" not part of transaction. Original Scope Function Source: "+K.Promise.PSD.trans.scopeFunc.toString());
}function Wb(a,b,f,m){this.name=a;this.schema=f;this.hook=P[a]?P[a].hook:pd(null,{creating:[Od,B],reading:[od,Nd],updating:[oe,B],deleting:[re,B]});this._tpf=b;this._collClass=m||Bb}function Bd(a,b,f,m){Wb.call(this,a,b,f,m||Oa)}function Cd(a,b,f,m){function p(a,b,c,g){return q._promise(a,c,g)}var q=this;this.db=L;this.mode=a;this.storeNames=b;this.idbtrans=null;this.on=pd(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._psd=null;this.active=!0;this._dbschema=f;m&&(this.parent=
m);this._tpf=p;this.tables=Object.create(qd);for(m=b.length-1;-1!==m;--m){var g=b[m],v=L._tableFactory(a,f[g],p);this.tables[g]=v;this[g]||(this[g]=v)}}function xc(a,b,f){this._ctx={table:a,index:":id"===b?null:b,collClass:a._collClass,or:f}}function Bb(a,b){var f=null,m=null;if(b)try{f=b()}catch(p){m=p}var q=a._ctx;this._ctx={table:q.table,index:q.index,isPrimKey:!q.index||q.table.schema.primKey.keyPath&&q.index===q.table.schema.primKey.name,range:f,op:"openCursor",dir:"next",unique:"",algorithm:null,
filter:null,isMatch:null,offset:0,limit:Infinity,error:m,or:q.or}}function Oa(){Bb.apply(this,arguments)}function Zc(a,b){return a._cfg.version-b._cfg.version}function ic(a,b,f,m,p,q){f.forEach(function(g){var f=L._tableFactory(m,p[g],b);a.forEach(function(a){a[g]||(q?Object.defineProperty(a,g,{configurable:!0,enumerable:!0,get:function(){var a=S.PSD&&S.PSD.trans;return a&&a.db===L?a.tables[g]:f}}):a[g]=f)})})}function jc(a){a.forEach(function(a){for(var b in a)a[b]instanceof Wb&&delete a[b]})}function Pb(a,
b,f,m,p,q){var g=S.PSD;q=q||Nd;a.onerror||(a.onerror=Pa(p));a.onsuccess=b?fa(function(g){var v=a.result;if(v){var l=function(){v.continue()};b(v,function(a){l=a},m,p)&&f(q(v.value),v,function(a){l=a});l()}else m()},p,g):fa(function(b){var c=a.result;if(c){var g=function(){c.continue()};f(q(c.value),c,function(a){g=a});g()}else m()},p,g)}function A(a){var b=[];a.split(",").forEach(function(a){a=a.trim();var f=a.replace("&","").replace("++","").replace("*",""),m=0!==f.indexOf("[")?f:a.substring(a.indexOf("[")+
1,a.indexOf("]")).split("+");b.push(new Xc(f,m||null,-1!==a.indexOf("&"),-1!==a.indexOf("*"),-1!==a.indexOf("++"),Array.isArray(m),-1!==m.indexOf(".")))});return b}function H(a,b){return a<b?-1:a>b?1:0}function Pd(a,b){return a<b?1:a>b?-1:0}function yc(a){return function(b,f){for(var m=0;;){var p=a(b[m],f[m]);if(0!==p)return p;++m;if(m===b.length||m===f.length)return a(b.length,f.length)}}}function Xb(a,b){return a?b?function(){return a.apply(this,arguments)&&b.apply(this,arguments)}:a:b}function Ob(){L.verno=
p.version/10;L._dbSchema=ba={};ad=[].slice.call(p.objectStoreNames,0);if(0!==ad.length){var a=p.transaction(Ic(ad),"readonly");ad.forEach(function(b){for(var f=a.objectStore(b),m=f.keyPath,p=m&&"string"===typeof m&&-1!==m.indexOf("."),q=new Xc(m,m||"",!1,!1,!!f.autoIncrement,m&&"string"!==typeof m,p),g=[],v=0;v<f.indexNames.length;++v){var O=f.index(f.indexNames[v]),p=(m=O.keyPath)&&"string"===typeof m&&-1!==m.indexOf("."),m=new Xc(O.name,m,!!O.unique,!!O.multiEntry,!1,m&&"string"!==typeof m,p);g.push(m)}ba[b]=
new Yc(b,q,g,{})});ic([P],L._transPromiseFactory,Object.keys(ba),b,ba)}}function Kc(a,b){for(var f=b.db.objectStoreNames,m=0;m<f.length;++m)for(var p=f[m],q=b.objectStore(p),g=0;g<q.indexNames.length;++g){var v=q.indexNames[g],O=q.index(v).keyPath,O="string"===typeof O?O:"["+[].slice.call(O).join("+")+"]";a[p]&&(O=a[p].idxByName[O])&&(O.name=v)}}var Zb=t&&t.addons||K.addons,ub=K.dependencies,Ib=ub.indexedDB,N=ub.IDBKeyRange,$c=ub.TypeError,La=ub.Error,ba=this._dbSchema={},Lc=[],ad=[],P={},qd={},p=
null,$a=!0,cb=null,oa=!1,b="readwrite",L=this,m=[],sa=!1,na=!!f();this.version=function(a){if(p)throw new La("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var b=Lc.filter(function(b){return b._cfg.version===a})[0];if(b)return b;b=new D(a);Lc.push(b);Lc.sort(Zc);return b};T(D.prototype,{stores:function(a){this._cfg.storesSource=this._cfg.storesSource?T(this._cfg.storesSource,a):a;var c={};Lc.forEach(function(a){T(c,a._cfg.storesSource)});a=this._cfg.dbschema={};this._parseStoresSpec(c,
a);ba=L._dbSchema=a;jc([P,L,qd]);ic([qd],Gd,Object.keys(a),b,a);ic([P,L,this._cfg.tables],L._transPromiseFactory,Object.keys(a),b,a,!0);ad=Object.keys(a);return this},upgrade:function(a){var c=this;ua(function(){a(L._createTransaction(b,Object.keys(c._cfg.dbschema),c._cfg.dbschema))});this._cfg.contentUpgrade=a;return this},_parseStoresSpec:function(a,b){Object.keys(a).forEach(function(f){if(null!==a[f]){var m={},p=A(a[f]),q=p.shift();if(q.multi)throw new La("Primary key cannot be multi-valued");
q.keyPath&&q.auto&&Nb(m,q.keyPath,0);p.forEach(function(a){if(a.auto)throw new La("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new La("Index must have a name and cannot be an empty string");Nb(m,a.keyPath,a.compound?a.keyPath.map(function(){return""}):"")});b[f]=new Yc(f,q,p,m)}})}});this._allTables=P;this._tableFactory=function(a,b,f){return"readonly"===a?new Wb(b.name,f,b,Bb):new Bd(b.name,f,b)};this._createTransaction=function(a,b,f,m){return new Cd(a,b,f,m)};this._transPromiseFactory=
function(a,b,f){if(!$a||S.PSD&&S.PSD.letThrough){var p=L._createTransaction(a,b,ba);return p._promise(a,function(a,b){p.error(function(a){L.on("error").fire(a)});f(function(b){p.complete(function(){a(b)})},b,p)})}var r=new S(function(p,g){m.push({resume:function(){var m=L._transPromiseFactory(a,b,f);r.onuncatched=m.onuncatched;m.then(p,g)}})});return r};this._whenReady=function(a){return!$a||S.PSD&&S.PSD.letThrough?new S(a):new S(function(b,f){ua(function(){new S(function(){a(b,f)})});m.push({resume:function(){a(b,
f)}})})};this.verno=0;this.open=function(){return new S(function(a,b){function f(a){try{q.transaction.abort()}catch(g){}oa=!1;cb=a;$a=!1;b(cb);m.forEach(function(a){a.resume()});m=[]}if(p||oa)throw new La("Database already opened or being opened");var q;try{cb=null;oa=!0;0===Lc.length&&(sa=!0);if(!Ib)throw new La("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");q=sa?Ib.open(v):Ib.open(v,
Math.round(10*L.verno));q.onerror=Pa(f,["opening database",v]);q.onblocked=function(a){L.on("blocked").fire(a)};q.onupgradeneeded=fa(function(a){sa&&!L._allowEmptyDB?(q.onerror=function(a){a.preventDefault()},q.transaction.abort(),q.result.close(),a=Ib.deleteDatabase(v),a.onsuccess=a.onerror=function(){f(new La("Database '"+v+"' doesnt exist"))}):(q.transaction.onerror=Pa(f),a=a.oldVersion>Math.pow(2,62)?0:a.oldVersion,dc(a/10,q.transaction,f,q))},f);q.onsuccess=fa(function(b){oa=!1;p=q.result;sa?
Ob():0<p.objectStoreNames.length&&Kc(ba,p.transaction(Ic(p.objectStoreNames),"readonly"));p.onversionchange=L.on("versionchange").fire;na||Rd(function(a){if(-1===a.indexOf(v))return a.push(v)});S.newPSD(function(){function b(){$a=!1;m.forEach(function(a){a.resume()});m=[];a()}S.PSD.letThrough=!0;try{var c=L.on.ready.fire();c&&"function"===typeof c.then?c.then(b,function(a){p.close();p=null;f(a)}):Dd(b)}catch(q){f(q)}})},f)}catch(r){f(r)}})};this.close=function(){p&&(p.close(),p=null,$a=!0,cb=null)};
this.delete=function(){var a=arguments;return new S(function(b,f){function p(){L.close();var a=Ib.deleteDatabase(v);a.onsuccess=function(){na||Rd(function(a){var b=a.indexOf(v);if(0<=b)return a.splice(b,1)});b()};a.onerror=Pa(f,["deleting",v]);a.onblocked=function(){L.on("blocked").fire()}}if(0<a.length)throw new La("Arguments not allowed in db.delete()");oa?m.push({resume:p}):p()})};this.backendDB=function(){return p};this.isOpen=function(){return null!==p};this.hasFailed=function(){return null!==
cb};this.dynamicallyOpened=function(){return sa};this.name=v;Object.defineProperty(this,"tables",{get:function(){return Object.keys(P).map(function(a){return P[a]})}});this.on=pd(this,"error","populate","blocked",{ready:[Yd,B],versionchange:[qe,B]});this.on.ready.subscribe=X(this.on.ready.subscribe,function(a){return function(b,f){function p(){f||L.on.ready.unsubscribe(p);return b.apply(this,arguments)}a.call(this,p);L.isOpen()&&($a?m.push({resume:p}):p())}});ua(function(){L.on("populate").fire(L._createTransaction(b,
ad,ba));L.on("error").fire(new La)});this.transaction=function(a,c,f){function m(b,c){var q=null;try{if(g)throw g;var q=L._createTransaction(a,v,ba,p),A=v.map(function(a){return q.tables[a]});A.push(q);var t,D=0;S.newPSD(function(){S.PSD.trans=q;q.scopeFunc=f;p&&(q.idbtrans=p.idbtrans,q._promise=X(q._promise,function(a){return function(b,c,g){function f(a){return function(b){var c;S._rootExec(function(){c=a(b);S._tickFinalize(function(){0===--D&&q.active&&(q.active=!1,q.on.complete.fire())})});return c}}
++D;return a.call(this,b,function(a,b,g){return c(f(a),f(b),g)},g)}}));q.complete(function(){b(t)});q.error(function(a){q.idbtrans&&(q.idbtrans.onerror=Qd);try{q.abort()}catch(b){}p&&(p.active=!1,p.on.error.fire(a));var g=c(a);p||g||L.on.error.fire(a)});S._rootExec(function(){t=f.apply(q,A)})});(!q.idbtrans||p&&0===D)&&q._nop()}catch(H){q&&q.idbtrans&&(q.idbtrans.onerror=Qd),q&&q.abort(),p&&p.on.error.fire(H),Dd(function(){c(H)||L.on("error").fire(H)})}}c=[].slice.call(arguments,1,arguments.length-
1);f=arguments[arguments.length-1];var p=S.PSD&&S.PSD.trans;p&&p.db===L&&-1===a.indexOf("!")||(p=null);var q=-1!==a.indexOf("?");a=a.replace("!","").replace("?","");var g=null,v=(Array.isArray(c[0])?c.reduce(function(a,b){return a.concat(b)}):c).map(function(a){if("string"===typeof a)return a;a instanceof Wb||(g=g||new $c("Invalid type. Arguments following mode must be instances of Table or String"));return a.name});"r"==a||"readonly"==a?a="readonly":"rw"==a||a==b?a=b:g=new La("Invalid transaction mode: "+
a);p&&!g&&(p&&"readonly"===p.mode&&a===b&&(q?p=null:g=g||new La("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY")),p&&v.forEach(function(a){p.tables.hasOwnProperty(a)||(q?p=null:g=g||new La("Table "+a+" not included in parent transaction. Parent Transaction function: "+p.scopeFunc.toString()))}));return p?p._promise(a,m,"lock"):L._whenReady(m)};this.table=function(a){if(!sa&&!P.hasOwnProperty(a))throw new La("Table does not exist");return P[a]};T(Wb.prototype,
function(){function a(){throw new La("Current Transaction is READONLY");}return{_trans:function(a,b,f){return this._tpf(a,[this.name],b,f)},_idbstore:function(a,b,f){var m=this;return this._tpf(a,[this.name],function(a,c,f){b(a,c,f.idbtrans.objectStore(m.name),f)},f)},get:function(a,b){var f=this;ua(function(){b(f.schema.instanceTemplate)});return this._idbstore("readonly",function(b,m,g){var p=g.get(a);p.onerror=Pa(m,["getting",a,"from",f.name]);p.onsuccess=function(){b(f.hook.reading.fire(p.result))}}).then(b)},
where:function(a){return new xc(this,a)},count:function(a){return this.toCollection().count(a)},offset:function(a){return this.toCollection().offset(a)},limit:function(a){return this.toCollection().limit(a)},reverse:function(){return this.toCollection().reverse()},filter:function(a){return this.toCollection().and(a)},each:function(a){var b=this;ua(function(){a(b.schema.instanceTemplate)});return this._idbstore("readonly",function(f,m,p){p=p.openCursor();p.onerror=Pa(m,["calling","Table.each()","on",
b.name]);Pb(p,null,a,f,m,b.hook.reading.fire)})},toArray:function(a){var b=this;ua(function(){a([b.schema.instanceTemplate])});return this._idbstore("readonly",function(a,c,f){var g=[];f=f.openCursor();f.onerror=Pa(c,["calling","Table.toArray()","on",b.name]);Pb(f,null,function(a){g.push(a)},function(){a(g)},c,b.hook.reading.fire)}).then(a)},orderBy:function(a){return new this._collClass(new xc(this,a))},toCollection:function(){return new this._collClass(new xc(this))},mapToClass:function(a,b){this.schema.mappedClass=
a;var f=Object.create(a.prototype);this.schema.primKey.keyPath&&(Nb(f,this.schema.primKey.keyPath,this.schema.primKey.auto?0:""),se(a.prototype,this.schema.primKey.keyPath));b&&wc(f,b);this.schema.instanceTemplate=f;f=Object.setPrototypeOf?function(b){if(!b)return b;Object.setPrototypeOf(b,a.prototype);return b}:function(b){if(!b)return b;var f=Object.create(a.prototype),g;for(g in b)b.hasOwnProperty(g)&&(f[g]=b[g]);return f};this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook);
this.schema.readHook=f;this.hook("reading",f);return a},defineClass:function(a){return this.mapToClass(K.defineClass(a),a)},add:a,put:a,"delete":a,clear:a,update:a}});U(Bd).from(Wb).extend(function(){return{add:function(a,c){var f=this,m=this.hook.creating.fire;return this._idbstore(b,function(b,p,g,q){var v={};if(m!==B){var l=c||(g.keyPath?ia(a,g.keyPath):J);q=m.call(v,l,a,q);l===J&&q!==J&&(g.keyPath?Nb(a,g.keyPath,q):c=q)}var A=c?g.add(a,c):g.add(a);A.onerror=Pa(function(a){if(v.onerror)v.onerror(a);
return p(a)},["adding",a,"into",f.name]);A.onsuccess=function(c){var f=g.keyPath;f&&Nb(a,f,c.target.result);if(v.onsuccess)v.onsuccess(c.target.result);b(A.result)}})},put:function(a,c){var f=this,m=this.hook.updating.fire;return this.hook.creating.fire!==B||m!==B?this._trans(b,function(b,m,g){var p=c||f.schema.primKey.keyPath&&ia(a,f.schema.primKey.keyPath);p===J?g.tables[f.name].add(a).then(b,m):(g._lock(),a=Wc(a),g.tables[f.name].where(":id").equals(p).modify(function(b){this.value=a}).then(function(b){return 0===
b?g.tables[f.name].add(a,c):p}).finally(function(){g._unlock()}).then(b,m))}):this._idbstore(b,function(b,m,g){var p=c?g.put(a,c):g.put(a);p.onerror=Pa(m,["putting",a,"into",f.name]);p.onsuccess=function(c){var f=g.keyPath;f&&Nb(a,f,c.target.result);b(p.result)}})},"delete":function(a){return this.hook.deleting.subscribers.length?this.where(":id").equals(a).delete():this._idbstore(b,function(b,f,m){var p=m.delete(a);p.onerror=Pa(f,["deleting",a,"from",m.name]);p.onsuccess=function(a){b(p.result)}})},
clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore(b,function(a,b,f){var m=f.clear();m.onerror=Pa(b,["clearing",f.name]);m.onsuccess=function(b){a(m.result)}})},update:function(a,b){if("object"!==typeof b||Array.isArray(b))throw new La("db.update(keyOrObject, modifications). modifications must be an object.");if("object"!==typeof a||Array.isArray(a))return this.where(":id").equals(a).modify(b);Object.keys(b).forEach(function(f){Nb(a,f,b[f])});
var f=ia(a,this.schema.primKey.keyPath);f===J&&S.reject(new La("Object does not contain its primary key"));return this.where(":id").equals(f).modify(b)}}});T(Cd.prototype,{_lock:function(){++this._reculock;1===this._reculock&&S.PSD&&(S.PSD.lockOwnerFor=this);return this},_unlock:function(){if(0===--this._reculock)for(S.PSD&&(S.PSD.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{a()}catch(b){}}return this},_locked:function(){return this._reculock&&
(!S.PSD||S.PSD.lockOwnerFor!==this)},_nop:function(a){this.tables[this.storeNames[0]].get(0).then(a)},_promise:function(a,b,f){var m=this;return S.newPSD(function(){var q;m._locked()?q=new S(function(p,g){m._blockedFuncs.push(function(){m._promise(a,b,f).then(p,g)})}):(q=m.active?new S(function(q,g){if(!m.idbtrans&&a){if(!p)throw cb?new La("Database not open. Following error in populate, ready or upgrade function made Dexie.open() fail: "+cb):new La("Database not open");var r=m.idbtrans=p.transaction(Ic(m.storeNames),
m.mode);r.onerror=function(a){m.on("error").fire(a&&a.target.error);a.preventDefault();m.abort()};r.onabort=function(a){m.active=!1;m.on("abort").fire(a)};r.oncomplete=function(a){m.active=!1;m.on("complete").fire(a)}}f&&m._lock();try{b(q,g,m)}catch(v){K.ignoreTransaction(function(){m.on("error").fire(v)}),m.abort(),g(v)}}):S.reject(He(new La("Transaction is inactive. Original Scope Function Source: "+m.scopeFunc.toString()))),m.active&&f&&q.finally(function(){m._unlock()}));q.onuncatched=function(a){K.ignoreTransaction(function(){m.on("error").fire(a)});
m.abort()};return q})},complete:function(a){return this.on("complete",a)},error:function(a){return this.on("error",a)},abort:function(){if(this.idbtrans&&this.active)try{this.active=!1,this.idbtrans.abort(),this.on.error.fire(new La("Transaction Aborted"))}catch(a){}},table:function(a){if(!this.tables.hasOwnProperty(a))throw new La("Table "+a+" not in transaction");return this.tables[a]}});T(xc.prototype,function(){function a(b,c){try{throw c;}catch(f){b._ctx.error=f}return b}function b(a){return Array.prototype.slice.call(1===
a.length&&Array.isArray(a[0])?a[0]:a)}function f(a){return"next"===a?function(a){return a.toUpperCase()}:function(a){return a.toLowerCase()}}function m(a){return"next"===a?function(a){return a.toLowerCase()}:function(a){return a.toUpperCase()}}function p(a,b,c,f,m,q){for(var r=Math.min(a.length,f.length),v=-1,A=0;A<r;++A){var t=b[A];if(t!==f[A])return 0>m(a[A],c[A])?a.substr(0,A)+c[A]+c.substr(A+1):0>m(a[A],f[A])?a.substr(0,A)+f[A]+c.substr(A+1):0<=v?a.substr(0,v)+b[v]+c.substr(v+1):null;0>m(a[A],
t)&&(v=A)}return r<f.length&&"next"===q?a+c.substr(a.length):r<a.length&&"prev"===q?a.substr(0,c.length):0>v?null:a.substr(0,v)+f[v]+c.substr(v+1)}function q(a,b,c){function l(a){v=f(a);A=m(a);t="next"===a?H:Pd;F=v(c);D=A(c);Jc=a}var v,A,t,F,D,Jc;l("next");a._ondirectionchange=function(a){l(a)};a._addAlgorithm(function(a,c,g){var f=a.key;if("string"!==typeof f)return!1;var l=A(f);if(b(l,D))return c(function(){a.continue()}),!0;var m=p(f,l,F,D,t,Jc);m?c(function(){a.continue(m)}):c(g);return!1})}return{between:function(a,
b,c,f){c=!1!==c;f=!0===f;return a>b||a===b&&!(!c&&!f||c&&f)?(new this._ctx.collClass(this,function(){return N.only(a)})).limit(0):new this._ctx.collClass(this,function(){return N.bound(a,b,!c,!f)})},equals:function(a){return new this._ctx.collClass(this,function(){return N.only(a)})},above:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a,!0)})},aboveOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a)})},below:function(a){return new this._ctx.collClass(this,
function(){return N.upperBound(a,!0)})},belowOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.upperBound(a)})},startsWith:function(b){return"string"!==typeof b?a(new this._ctx.collClass(this),new $c("String expected")):this.between(b,b+String.fromCharCode(65535),!0,!0)},startsWithIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new $c("String expected"));if(""===b)return this.startsWith(b);var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),
b.toLowerCase()+String.fromCharCode(65535))});q(c,function(a,b){return 0===a.indexOf(b)},b);c._ondirectionchange=function(){a(c,new La("reverse() not supported with WhereClause.startsWithIgnoreCase()"))};return c},equalsIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new $c("String expected"));var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),b.toLowerCase())});q(c,function(a,b){return a===b},b);return c},anyOf:function(a){var f=this._ctx,
m=f.table.schema,l=(f=f.index?m.idxByName[f.index]:m.primKey)&&f.compound,p=b(arguments),q=l?yc(H):H;p.sort(q);if(0===p.length)return(new this._ctx.collClass(this,function(){return N.only("")})).limit(0);f=new this._ctx.collClass(this,function(){return N.bound(p[0],p[p.length-1])});f._ondirectionchange=function(a){q="next"===a?H:Pd;l&&(q=yc(q));p.sort(q)};var r=0;f._addAlgorithm(function(a,b,c){for(var g=a.key;0<q(g,p[r]);)if(++r,r===p.length)return b(c),!1;if(0===q(g,p[r]))return b(function(){a.continue()}),
!0;b(function(){a.continue(p[r])});return!1});return f}}});T(Bb.prototype,function(){function a(b,c){b.filter=Xb(b.filter,c)}function c(a,b){a.isMatch=Xb(a.isMatch,b)}function f(a,b){if(a.isPrimKey)return b;var c=a.table.schema.idxByName[a.index];if(!c)throw new La("KeyPath "+a.index+" on object store "+b.name+" is not indexed");return a.isPrimKey?b:b.index(c.name)}function m(a,b){return f(a,b)[a.op](a.range||null,a.dir+a.unique)}function p(a,b,c,f,q){a.or?function(){function p(){2===++t&&c()}function r(a,
c,g){if(!v||v(c,g,p,f)){var m=c.primaryKey.toString();A.hasOwnProperty(m)||(A[m]=!0,b(a,c,g))}}var v=a.filter,A={},t=0;a.or._iterate(r,p,f,q);Pb(m(a,q),a.algorithm,r,p,f,a.table.hook.reading.fire)}():Pb(m(a,q),Xb(a.algorithm,a.filter),b,c,f,a.table.hook.reading.fire)}function q(a){return a.table.schema.instanceTemplate}return{_read:function(a,b){var c=this._ctx;return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore("readonly",a).then(b)},_write:function(a){var c=this._ctx;
return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore(b,a,"locked")},_addAlgorithm:function(a){var b=this._ctx;b.algorithm=Xb(b.algorithm,a)},_iterate:function(a,b,c,f){return p(this._ctx,a,b,c,f)},each:function(a){var b=this._ctx;ua(function(){a(q(b))});return this._read(function(c,f,m){p(b,a,c,f,m)})},count:function(a){ua(function(){a(0)});var b=this,c=this._ctx;if(c.filter||c.algorithm||c.or){var l=0;return this._read(function(a,b,g){p(c,function(){++l;return!1},function(){a(l)},
b,g)},a)}return this._read(function(a,g,l){l=f(c,l);l=c.range?l.count(c.range):l.count();l.onerror=Pa(g,["calling","count()","on",b.name]);l.onsuccess=function(b){a(Math.min(b.target.result,Math.max(0,c.limit-c.offset)))}},a)},sortBy:function(a,b){function c(a,b){return b?c(a[p[b]],b-1):a[r]}function f(a,b){var g=c(a,v),l=c(b,v);return g<l?-A:g>l?A:0}var m=this._ctx;ua(function(){b([q(m)])});var p=a.split(".").reverse(),r=p[0],v=p.length-1,A="next"===this._ctx.dir?1:-1;return this.toArray(function(a){return a.sort(f)}).then(b)},
toArray:function(a){var b=this._ctx;ua(function(){a([q(b)])});return this._read(function(a,c,g){var f=[];p(b,function(a){f.push(a)},function(){a(f)},c,g)},a)},offset:function(b){var c=this._ctx;if(0>=b)return this;c.offset+=b;c.or||c.algorithm||c.filter?a(c,function(a,c,f){return 0>--b}):a(c,function(a,c,f){if(0===b)return!0;if(1===b)return--b,!1;c(function(){a.advance(b);b=0});return!1});return this},limit:function(b){this._ctx.limit=Math.min(this._ctx.limit,b);a(this._ctx,function(a,c,f){0>=--b&&
c(f);return 0<=b});return this},until:function(b,c){var f=this._ctx;ua(function(){b(q(f))});a(this._ctx,function(a,f,m){return b(a.value)?(f(m),c):!0});return this},first:function(a){var b=this;ua(function(){a(q(b._ctx))});return this.limit(1).toArray(function(a){return a[0]}).then(a)},last:function(a){return this.reverse().first(a)},and:function(b){var f=this;ua(function(){b(q(f._ctx))});a(this._ctx,function(a){return b(a.value)});c(this._ctx,b);return this},or:function(a){return new xc(this._ctx.table,
a,this)},reverse:function(){this._ctx.dir="prev"===this._ctx.dir?"next":"prev";this._ondirectionchange&&this._ondirectionchange(this._ctx.dir);return this},desc:function(){return this.reverse()},eachKey:function(a){var b=this,c=this._ctx;ua(function(){a(q(b._ctx)[b._ctx.index])});c.isPrimKey||(c.op="openKeyCursor");return this.each(function(b,c){a(c.key,c)})},eachUniqueKey:function(a){this._ctx.unique="unique";return this.eachKey(a)},keys:function(a){ua(function(){a([q(c)[b._ctx.index]])});var b=
this,c=this._ctx;c.isPrimKey||(c.op="openKeyCursor");var f=[];return this.each(function(a,b){f.push(b.key)}).then(function(){return f}).then(a)},uniqueKeys:function(a){this._ctx.unique="unique";return this.keys(a)},firstKey:function(a){return this.limit(1).keys(function(a){return a[0]}).then(a)},lastKey:function(a){return this.reverse().firstKey(a)},distinct:function(){var b={};a(this._ctx,function(a){a=a.primaryKey.toString();var c=b.hasOwnProperty(a);b[a]=!0;return!c});return this}}});U(Oa).from(Bb).extend({modify:function(a){var b=
this,f=this._ctx,m=f.table.hook,p=m.updating.fire,q=m.deleting.fire;ua(function(){"function"===typeof a&&a.call({value:f.table.schema.instanceTemplate},f.table.schema.instanceTemplate)});return this._write(function(g,m,v,l){function A(a){a&&(ic.push(a),P.push(dc));return m(new Fd("Error modifying one or more objects",ic,C,P))}function t(){N&&C+ic.length===E&&(0<ic.length?A():g(C))}var D;if("function"===typeof a)D=p===B&&q===B?a:function(b){var c=Wc(b);if(!1===a.call(this,b))return!1;if(this.hasOwnProperty("value")){var g=
Hc(c,this.value),f=p.call(this,g,this.primKey,c,l);f&&(b=this.value,Object.keys(f).forEach(function(a){Nb(b,a,f[a])}))}else q.call(this,this.primKey,b,l)};else if(p===B){var H=Object.keys(a),Jc=H.length;D=function(b){for(var c=!1,g=0;g<Jc;++g){var f=H[g],l=a[f];ia(b,f)!==l&&(Nb(b,f,l),c=!0)}return c}}else{var L=a;a=$d(L);D=function(b){var c=!1,g=p.call(this,a,this.primKey,Wc(b),l);g&&T(a,g);Object.keys(a).forEach(function(g){var f=a[g];ia(b,g)!==f&&(Nb(b,g,f),c=!0)});g&&(a=$d(L));return c}}var E=
0,C=0,N=!1,ic=[],P=[],dc=null;b._iterate(function(a,b,c){dc=b.primaryKey;var g={primKey:b.primaryKey,value:a};if(!1!==D.call(g,a))b=(c=!g.hasOwnProperty("value"))?b.delete():b.update(g.value),++E,b.onerror=Pa(function(a){ic.push(a);P.push(g.primKey);if(g.onerror)g.onerror(a);t();return!0},c?["deleting",a,"from",f.table.name]:["modifying",a,"on",f.table.name]),b.onsuccess=function(a){if(g.onsuccess)g.onsuccess(g.value);++C;t()};else if(g.onsuccess)g.onsuccess(g.value)},function(){N=!0;t()},A,v)})},
"delete":function(){return this.modify(function(){delete this.value})}});T(this,{Collection:Bb,Table:Wb,Transaction:Cd,Version:D,WhereClause:xc,WriteableCollection:Oa,WriteableTable:Bd});(function(){L.on("versionchange",function(a){L.close();L.on("error").fire(new La("Database version changed by other database connection."))})})();Zb.forEach(function(a){a(L)})}function B(){}function Nd(f){return f}function od(f,t){return f===Nd?t:function(D){return t(f(D))}}function Ib(f,t){return function(){f.apply(this,
arguments);t.apply(this,arguments)}}function Od(f,t){return f===B?t:function(){var D=f.apply(this,arguments);D!==J&&(arguments[0]=D);var B=this.onsuccess,a=this.onerror;delete this.onsuccess;delete this.onerror;var q=t.apply(this,arguments);B&&(this.onsuccess=this.onsuccess?Ib(B,this.onsuccess):B);a&&(this.onerror=this.onerror?Ib(a,this.onerror):a);return q!==J?q:D}}function oe(f,t){return f===B?t:function(){var D=f.apply(this,arguments);D!==J&&T(arguments[0],D);var B=this.onsuccess,a=this.onerror;
delete this.onsuccess;delete this.onerror;var q=t.apply(this,arguments);B&&(this.onsuccess=this.onsuccess?Ib(B,this.onsuccess):B);a&&(this.onerror=this.onerror?Ib(a,this.onerror):a);return D===J?q===J?J:q:q===J?D:T(D,q)}}function pe(f,t){return f===B?t:function(){return!1===f.apply(this,arguments)?!1:t.apply(this,arguments)}}function qe(f,t){return f===B?t:function(){return!1===t.apply(this,arguments)?!1:f.apply(this,arguments)}}function re(f,t){return f===B?t:function(){f.apply(this,arguments);t.apply(this,
arguments)}}function Yd(f,t){return f===B?t:function(){var D=f.apply(this,arguments);if(D&&"function"===typeof D.then){var B=this,a=arguments;return D.then(function(){return t.apply(B,a)})}return t.apply(this,arguments)}}function pd(f,t){function D(f,q,v){if(Array.isArray(f))return a(f);if("object"===typeof f)return K(f);q||(q=pe);v||(v=B);var t={subscribers:[],fire:v,subscribe:function(a){t.subscribers.push(a);t.fire=q(t.fire,a)},unsubscribe:function(a){t.subscribers=t.subscribers.filter(function(f){return f!==
a});t.fire=t.subscribers.reduce(q,v)}};return J[f]=S[f]=t}function K(a){Object.keys(a).forEach(function(f){var q=a[f];if(Array.isArray(q))D(f,a[f][0],a[f][1]);else if("asap"===q){var v=D(f,null,function(){var a=arguments;v.subscribers.forEach(function(f){Dd(function(){f.apply(ma,a)})})});v.subscribe=function(a){-1===v.subscribers.indexOf(a)&&v.subscribers.push(a)};v.unsubscribe=function(a){a=v.subscribers.indexOf(a);-1!==a&&v.subscribers.splice(a,1)}}else throw Error("Invalid event config");})}function a(a){function f(){if(q)return!1;
q=!0}var q=!1;a.forEach(function(a){D(a).subscribe(f)})}var q=arguments,J={},S=function(a,q){if(q){var t=[].slice.call(arguments,1),D=J[a];D.subscribe.apply(D,t);return f}if("string"===typeof a)return J[a]};S.addEventType=D;for(var T=1,U=q.length;T<U;++T)D(q[T]);return S}function Dd(f){ma.setImmediate?setImmediate(f):setTimeout(f,0)}function Zd(f){f=setTimeout(f,1E3);clearTimeout(f)}function fa(f,t,D){return function(){var B=S.PSD;S.PSD=D;try{f.apply(this,arguments)}catch(a){t(a)}finally{S.PSD=B}}}
function ia(f,t){if(f.hasOwnProperty(t))return f[t];if(!t)return f;if("string"!==typeof t){for(var D=[],B=0,a=t.length;B<a;++B){var q=ia(f,t[B]);D.push(q)}return D}D=t.indexOf(".");return-1!==D?(B=f[t.substr(0,D)],B===J?J:ia(B,t.substr(D+1))):J}function Nb(f,t,D){if(f&&t!==J)if("string"!==typeof t&&"length"in t){if(!("string"!==typeof D&&"length"in D))throw Error("Assertion failed");for(var B=0,a=t.length;B<a;++B)Nb(f,t[B],D[B])}else a=t.indexOf("."),-1!==a?(B=t.substr(0,a),t=t.substr(a+1),""===t?
D===J?delete f[B]:f[B]=D:((a=f[B])||(a=f[B]={}),Nb(a,t,D))):D===J?delete f[t]:f[t]=D}function se(f,t){Nb(f,t,J)}function $d(f){var t={},D;for(D in f)f.hasOwnProperty(D)&&(t[D]=f[D]);return t}function Wc(f){if(!f||"object"!==typeof f)return f;var t;if(Array.isArray(f)){t=[];for(var D=0,B=f.length;D<B;++D)t.push(Wc(f[D]))}else if(f instanceof Date)t=new Date,t.setTime(f.getTime());else for(D in t=f.constructor?Object.create(f.constructor.prototype):{},f)f.hasOwnProperty(D)&&(t[D]=Wc(f[D]));return t}
function Hc(f,t){var D={},B;for(B in f)f.hasOwnProperty(B)&&(t.hasOwnProperty(B)?f[B]!==t[B]&&JSON.stringify(f[B])!=JSON.stringify(t[B])&&(D[B]=t[B]):D[B]=J);for(B in t)t.hasOwnProperty(B)&&!f.hasOwnProperty(B)&&(D[B]=t[B]);return D}function Ed(f){if("function"===typeof f)return new f;if(Array.isArray(f))return[Ed(f[0])];if(f&&"object"===typeof f){var t={};wc(t,f);return t}return f}function wc(f,t){Object.keys(t).forEach(function(D){var B=Ed(t[D]);f[D]=B})}function Pa(f,t){return function(D){var B=
D&&D.target.error||Error();if(t){var a=" occurred when "+t.map(function(a){switch(typeof a){case "function":return a();case "string":return a;default:return JSON.stringify(a)}}).join(" ");B.name?B.toString=function(){return B.name+a+(B.message?". "+B.message:"")}:B+=a}f(B);D&&(D.stopPropagation&&D.stopPropagation(),D.preventDefault&&D.preventDefault());return!1}}function He(f){try{throw f;}catch(t){return t}}function Qd(f){f.preventDefault()}function Rd(f){var t,B=K.dependencies.localStorage;if(!B)return f([]);
try{t=JSON.parse(B.getItem("Dexie.DatabaseNames")||"[]")}catch(J){t=[]}f(t)&&B.setItem("Dexie.DatabaseNames",JSON.stringify(t))}function Xc(f,t,B,J,a,q,K){this.name=f;this.keyPath=t;this.unique=B;this.multi=J;this.auto=a;this.compound=q;this.dotted=K;f="string"===typeof t?t:t&&"["+[].join.call(t,"+")+"]";this.src=(B?"&":"")+(J?"*":"")+(a?"++":"")+f}function Yc(f,t,B,J){this.name=f;this.primKey=t||new Xc;this.indexes=B||[new Xc];this.instanceTemplate=J;this.mappedClass=null;this.idxByName=B.reduce(function(a,
f){a[f.name]=f;return a},{})}function Fd(f,t,B,J){this.name="ModifyError";this.failures=t;this.failedKeys=J;this.successCount=B;this.message=t.join("\n")}function Ic(f){return 1===f.length?f[0]:f}function f(){var f=K.dependencies.indexedDB,t=f&&(f.getDatabaseNames||f.webkitGetDatabaseNames);return t&&t.bind(f)}var S=function(){function f(a,q){Oa.push([a,X.call(arguments,1)])}function t(){var a=Oa;Oa=[];for(var f=0,q=a.length;f<q;++f){var v=a[f];v[0].apply(ma,v[1])}}function D(a){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");
if("function"!==typeof a)throw new TypeError("not a function");this._value=this._state=null;this._deferreds=[];this._catched=!1;var f=this,t=!0;this._PSD=D.PSD;try{U(this,a,function(a){t?ia(q,f,a):q(f,a)},function(a){return t?(ia(K,f,a),!1):K(f,a)})}finally{t=!1}}function J(q,B){if(null===q._state)q._deferreds.push(B);else{var K=q._state?B.onFulfilled:B.onRejected;if(null===K)return(q._state?B.resolve:B.reject)(q._value);var A,H=ua;ua=!1;ia=f;try{var S=D.PSD;D.PSD=q._PSD;A=K(q._value);q._state||A&&
"function"===typeof A.then&&!1===A._state||a(q);B.resolve(A)}catch(T){if(!B.reject(T)&&q.onuncatched)try{q.onuncatched(T)}catch(U){}}finally{if(D.PSD=S,H){do{for(;0<Oa.length;)t();if(K=Pa.pop())try{K()}catch(X){}}while(0<Pa.length||0<Oa.length);ia=fa;ua=!0}}}}function a(f){f._catched=!0;f._parent&&a(f._parent)}function q(a,f){var t=D.PSD;D.PSD=a._PSD;try{if(f===a)throw new TypeError("A promise cannot be resolved with itself.");!f||"object"!==typeof f&&"function"!==typeof f||"function"!==typeof f.then?
(a._state=!0,a._value=f,S.call(a)):U(a,function(a,q){f.then(a,q)},function(f){q(a,f)},function(f){K(a,f)})}catch(v){K(v)}finally{D.PSD=t}}function K(a,f){var q=D.PSD;D.PSD=a._PSD;a._state=!1;a._value=f;S.call(a);if(!a._catched)try{if(a.onuncatched)a.onuncatched(a._value);D.on.error.fire(a._value)}catch(t){}D.PSD=q;return a._catched}function S(){for(var a=0,f=this._deferreds.length;a<f;a++)J(this,this._deferreds[a]);this._deferreds=[]}function T(a,f,q,t){this.onFulfilled="function"===typeof a?a:null;
this.onRejected="function"===typeof f?f:null;this.resolve=q;this.reject=t}function U(a,f,q,t){var v=!1;try{f(function(a){v||(v=!0,q(a))},function(f){if(v)return a._catched;v=!0;return t(f)})}catch(B){if(!v)return t(B)}}var X=[].slice,fa="undefined"===typeof setImmediate?function(a,f,q,t){var v=arguments;setTimeout(function(){a.apply(ma,X.call(v,1))},0)}:setImmediate,ia=fa,ua=!0,Oa=[],Pa=[];D.on=pd(null,"error");D.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&Array.isArray(arguments[0])?
arguments[0]:arguments);return new D(function(f,q){function t(B,D){try{if(D&&("object"===typeof D||"function"===typeof D)){var J=D.then;if("function"===typeof J){J.call(D,function(a){t(B,a)},q);return}}a[B]=D;0===--v&&f(a)}catch(K){q(K)}}if(0===a.length)return f([]);for(var v=a.length,B=0;B<a.length;B++)t(B,a[B])})};D.prototype.then=function(a,f){var q=this,t=new D(function(t,v){null===q._state?J(q,new T(a,f,t,v)):ia(J,q,new T(a,f,t,v))});t._PSD=this._PSD;t.onuncatched=this.onuncatched;t._parent=
this;return t};D.prototype._then=function(a,f){J(this,new T(a,f,B,B))};D.prototype["catch"]=function(a){if(1===arguments.length)return this.then(null,a);var f=arguments[0],q=arguments[1];return"function"===typeof f?this.then(null,function(a){return a instanceof f?q(a):D.reject(a)}):this.then(null,function(a){return a&&a.name===f?q(a):D.reject(a)})};D.prototype["finally"]=function(a){return this.then(function(f){a();return f},function(f){a();return D.reject(f)})};D.prototype.onuncatched=null;D.resolve=
function(a){var f=new D(function(){});f._state=!0;f._value=a;return f};D.reject=function(a){var f=new D(function(){});f._state=!1;f._value=a;return f};D.race=function(a){return new D(function(f,q){a.map(function(a){a.then(f,q)})})};D.PSD=null;D.newPSD=function(a){var f=D.PSD;D.PSD=f?Object.create(f):{};try{return a()}finally{D.PSD=f}};D._rootExec=function(a){var q=ua;ua=!1;ia=f;try{a()}finally{if(q){do{for(;0<Oa.length;)t();if(a=Pa.pop())try{a()}catch(B){}}while(0<Pa.length||0<Oa.length);ia=fa;ua=
!0}}};D._tickFinalize=function(a){if(ua)throw Error("Not in a virtual tick");Pa.push(a)};return D}(),ua=function(){};U(Fd).from(Error);K.delete=function(f){var t=new K(f);f=t.delete();f.onblocked=function(f){t.on("blocked",f);return this};return f};K.getDatabaseNames=function(t){return(new S(function(t,v){var B=f();B?(B=B(),B.onsuccess=function(a){t([].slice.call(a.target.result,0))},B.onerror=Pa(v)):Rd(function(a){t(a);return!1})})).then(t)};K.defineClass=function(f){function t(f){f&&T(this,f)}wc(t.prototype,
f);return t};K.ignoreTransaction=function(f){return S.newPSD(function(){S.PSD.trans=null;return f()})};K.spawn=function(){ma.console&&console.warn("Dexie.spawn() is deprecated. Use Dexie.ignoreTransaction() instead.");return K.ignoreTransaction.apply(this,arguments)};K.vip=function(f){return S.newPSD(function(){S.PSD.letThrough=!0;return f()})};Object.defineProperty(K,"currentTransaction",{get:function(){return S.PSD&&S.PSD.trans||null}});K.Promise=S;K.derive=U;K.extend=T;K.override=X;K.events=pd;
K.getByKeyPath=ia;K.setByKeyPath=Nb;K.delByKeyPath=se;K.shallowClone=$d;K.deepClone=Wc;K.addons=[];K.fakeAutoComplete=ua;K.asap=Dd;K.ModifyError=Fd;K.MultiModifyError=Fd;K.IndexSpec=Xc;K.TableSchema=Yc;var Ob=ma.idbModules&&ma.idbModules.shimIndexedDB?ma.idbModules:{};K.dependencies={indexedDB:Ob.shimIndexedDB||ma.indexedDB||ma.mozIndexedDB||ma.webkitIndexedDB||ma.msIndexedDB,IDBKeyRange:Ob.IDBKeyRange||ma.IDBKeyRange||ma.webkitIDBKeyRange,IDBTransaction:Ob.IDBTransaction||ma.IDBTransaction||ma.webkitIDBTransaction,
Error:ma.Error||String,SyntaxError:ma.SyntaxError||String,TypeError:ma.TypeError||String,DOMError:ma.DOMError||String,localStorage:null!=("undefined"!==typeof chrome&&null!==chrome?chrome.storage:void 0)?null:ma.localStorage};K.version=1.1;t("Dexie",K);Zd(function(){ua=Zd})}).apply(null,"function"===typeof define&&define.amd?[self||window,function(ma,t){define(ma,function(){return t})}]:"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?[global,function(ma,t){module.exports=
t}]:[self||window,function(ma,t){(self||window)[ma]=t}]);
